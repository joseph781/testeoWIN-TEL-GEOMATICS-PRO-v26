<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WIN-TEL GEOMATICS PRO v30 | Dimensiones + Exacta</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css"/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
    <script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/suncalc/1.9.0/suncalc.min.js"></script>
    <script src="https://unpkg.com/@mapbox/togeojson@0.16.0/togeojson.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.9.0/proj4.js"></script>
    <style>
        :root {
            --sidebar-w: 56px;
            --panel-w: 380px;
            --bg-dark: #0a0f1c;
            --bg-sidebar: #151921;
            --bg-panel: rgba(20, 30, 50, 0.97);
            --bg-glass: rgba(35, 48, 68, 0.9);
            --bg-input: rgba(51, 65, 85, 0.7);
            --bg-hover: rgba(71, 85, 105, 0.6);
            --primary: #10d393;
            --primary-lt: #34eab0;
            --accent: #60a5fa;
            --success: #34d399;
            --warning: #fbbf24;
            --danger: #f87171;
            --cyan: #22d3ee;
            --purple: #a78bfa;
            --text-1: #ffffff;
            --text-2: #cbd5e1;
            --text-3: #94a3b8;
            --border: rgba(148, 163, 184, 0.3);
            --shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.6);
            --backdrop: blur(16px) saturate(180%);
        }
        [data-theme="pastel"] {
            --bg-dark: #f0ebe3; --bg-sidebar: #e8e3db; --bg-panel: rgba(255, 255, 255, 0.95);
            --bg-glass: rgba(255, 255, 255, 0.85); --bg-input: rgba(240, 235, 227, 0.8);
            --bg-hover: rgba(225, 220, 210, 0.7); --primary: #7c9eb2; --primary-lt: #8fb4c8;
            --accent: #6b8fa3; --success: #8fb996; --warning: #ddb892; --danger: #d4a5a5;
            --text-1: #4a5568; --text-2: #718096; --text-3: #a0aec0;
            --border: rgba(160, 174, 192, 0.3); --shadow: 0 20px 40px -10px rgba(0, 0, 0, 0.1);
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body, html { height: 100%; font-family: 'Inter', -apple-system, sans-serif; background: var(--bg-dark); overflow: hidden; color: var(--text-1); transition: all 0.3s; }
        .app { display: flex; height: 100vh; }
        .sidebar { width: var(--sidebar-w); background: var(--bg-sidebar); display: flex; flex-direction: column; border-right: 1px solid var(--border); z-index: 3000; }
        .logo { height: 56px; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, var(--primary), var(--primary-lt)); cursor: pointer; }
        .logo i { font-size: 24px; color: white; }
        .nav { flex: 1; display: flex; flex-direction: column; padding: 8px 0; }
        .nav-group { padding: 8px 0; border-bottom: 1px solid var(--border); }
        .nav-item { width: 100%; height: 46px; display: flex; align-items: center; justify-content: center; background: transparent; border: none; color: #94a3b8; cursor: pointer; transition: all 0.2s; position: relative; }
        .nav-item i { font-size: 19px; }
        .nav-item:hover { color: #ffffff; background: var(--bg-hover); }
        .nav-item.active { color: var(--primary); background: rgba(16, 211, 147, 0.18); }
        .nav-item.active::before { content: ''; position: absolute; left: 0; top: 50%; transform: translateY(-50%); width: 3px; height: 26px; background: var(--primary); border-radius: 0 2px 2px 0; box-shadow: 0 0 8px var(--primary); }
        .nav-item[data-tip]:hover::after { content: attr(data-tip); position: absolute; left: 100%; top: 50%; transform: translateY(-50%); background: var(--bg-panel); padding: 8px 14px; border-radius: 4px; font-size: 12px; white-space: nowrap; margin-left: 10px; box-shadow: var(--shadow); z-index: 9999; border: 1px solid var(--border); color: #ffffff; font-weight: 500; }
        .map-wrap { flex: 1; position: relative; }
        #map { height: 100%; width: 100%; }
        [data-theme="pastel"] #map { filter: saturate(0.9) brightness(1.02); }
        .panel { position: fixed; top: 16px; left: calc(var(--sidebar-w) + 16px); width: var(--panel-w); max-height: calc(100vh - 32px); background: var(--bg-panel); backdrop-filter: var(--backdrop); border: 1px solid var(--border); border-radius: 12px; box-shadow: var(--shadow); display: none; flex-direction: column; overflow: hidden; z-index: 2000; }
        .panel.active { display: flex; }
        .panel-hdr { padding: 14px 16px; background: linear-gradient(135deg, rgba(16, 211, 147, 0.25), rgba(139, 92, 246, 0.15)); border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; }
        .panel-title { display: flex; align-items: center; gap: 8px; font-weight: 800; font-size: 13px; letter-spacing: 1px; text-transform: uppercase; color: #ffffff; }
        .panel-title i { color: var(--primary); font-size: 15px; text-shadow: 0 0 10px rgba(16,211,147,0.5); }
        .panel-close { background: none; border: none; color: var(--text-2); cursor: pointer; padding: 6px 8px; border-radius: 4px; font-size: 13px; }
        .panel-close:hover { background: var(--danger); color: white; }
        .panel-body { padding: 16px; overflow-y: auto; flex: 1; max-height: 75vh; }
        .panel-body::-webkit-scrollbar { width: 5px; }
        .panel-body::-webkit-scrollbar-thumb { background: var(--text-3); border-radius: 3px; }
        .form-group { margin-bottom: 12px; }
        .form-label { font-size: 11px; font-weight: 700; color: var(--text-2); margin-bottom: 6px; display: block; text-transform: uppercase; letter-spacing: 0.5px; }
        .form-input { width: 100%; padding: 11px 12px; background: var(--bg-input); border: 1px solid var(--border); border-radius: 6px; font-family: monospace; font-size: 13px; color: #ffffff; font-weight: 500; }
        .form-input:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(16,211,147,0.25); }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .btn { display: flex; align-items: center; justify-content: center; gap: 8px; padding: 12px 16px; background: linear-gradient(135deg, var(--primary), #059669); border: none; border-radius: 6px; font-weight: 800; font-size: 12px; text-transform: uppercase; color: #ffffff; cursor: pointer; width: 100%; transition: all 0.2s; letter-spacing: 0.5px; text-shadow: 0 1px 2px rgba(0,0,0,0.3); }
        .btn:hover { filter: brightness(1.1); transform: translateY(-1px); }
        .btn-2 { background: var(--bg-glass); border: 1px solid var(--border); color: #ffffff; text-shadow: none; }
        .btn-danger { background: linear-gradient(135deg, #ef4444, #dc2626); }
        .btn-warning { background: linear-gradient(135deg, #f59e0b, #d97706); color: #ffffff; }
        .btn-purple { background: linear-gradient(135deg, #8b5cf6, #7c3aed); }
        .btn-cyan { background: linear-gradient(135deg, #06b6d4, #0891b2); }
        .btn-accent { background: linear-gradient(135deg, #3b82f6, #2563eb); }
        .toolbar { display: grid; grid-template-columns: repeat(5, 1fr); gap: 6px; margin-bottom: 12px; }
        .tool-btn { aspect-ratio: 1; display: flex; align-items: center; justify-content: center; background: var(--bg-glass); border: 1px solid var(--border); border-radius: 6px; color: #e2e8f0; cursor: pointer; font-size: 17px; transition: all 0.2s; }
        .tool-btn:hover { background: var(--bg-hover); color: var(--primary); border-color: var(--primary); box-shadow: 0 0 10px rgba(16,211,147,0.3); }
        .stats { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; margin-bottom: 12px; }
        .stat { background: var(--bg-glass); border: 1px solid var(--border); border-radius: 6px; padding: 12px; text-align: center; }
        .stat-val { font-size: 20px; font-weight: 800; color: var(--primary); font-family: monospace; text-shadow: 0 0 10px rgba(16,211,147,0.3); }
        .stat-lbl { font-size: 10px; color: var(--text-2); text-transform: uppercase; margin-top: 4px; font-weight: 600; }
        .toggle-row { display: flex; align-items: center; justify-content: space-between; padding: 10px 12px; background: var(--bg-glass); border: 1px solid var(--border); border-radius: 6px; margin-bottom: 8px; }
        .toggle-lbl { display: flex; align-items: center; gap: 8px; font-size: 12px; font-weight: 600; color: #ffffff; }
        .toggle-lbl i { color: var(--primary); }
        .switch { position: relative; width: 40px; height: 22px; }
        .switch input { display: none; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background: #475569; border-radius: 22px; transition: 0.3s; border: 1px solid var(--border); }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 2px; bottom: 2px; background: #ffffff; border-radius: 50%; transition: 0.3s; box-shadow: 0 1px 3px rgba(0,0,0,0.3); }
        input:checked + .slider { background: var(--primary); border-color: var(--primary); }
        input:checked + .slider:before { transform: translateX(18px); }
        .range-grp { display: flex; align-items: center; gap: 10px; }
        .range { flex: 1; -webkit-appearance: none; height: 5px; background: var(--bg-input); border-radius: 3px; }
        .range::-webkit-slider-thumb { -webkit-appearance: none; width: 16px; height: 16px; background: var(--primary); border-radius: 50%; cursor: pointer; }
        .range-val { width: 60px; text-align: center; padding: 5px; background: var(--bg-input); border: 1px solid var(--border); border-radius: 4px; font-family: monospace; font-size: 12px; color: var(--text-1); }
        .section-lbl { display: flex; align-items: center; gap: 8px; font-size: 11px; font-weight: 700; color: var(--warning); text-transform: uppercase; margin: 16px 0 10px; padding-bottom: 6px; border-bottom: 1px solid var(--border); letter-spacing: 0.5px; }
        .tabs { display: flex; gap: 3px; margin-bottom: 12px; background: rgba(0,0,0,0.4); padding: 4px; border-radius: 6px; }
        .tab { flex: 1; padding: 10px; background: transparent; border: none; border-radius: 4px; font-weight: 700; font-size: 11px; text-transform: uppercase; color: #e2e8f0; cursor: pointer; letter-spacing: 0.5px; }
        .tab:hover { color: #ffffff; }
        .tab.active { background: linear-gradient(135deg, var(--primary), #059669); color: #ffffff; text-shadow: 0 1px 2px rgba(0,0,0,0.3); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .data-table { width: 100%; border-collapse: collapse; font-size: 11px; font-family: monospace; }
        .data-table th { background: var(--bg-glass); padding: 10px 8px; text-align: left; font-weight: 700; color: #ffffff; text-transform: uppercase; font-size: 10px; position: sticky; top: 0; }
        .data-table td { padding: 8px 6px; border-bottom: 1px solid var(--border); font-size: 10px; color: #e2e8f0; }
        .data-table tr:hover td { background: var(--bg-hover); }
        .data-table tr.selected td { background: rgba(34, 211, 238, 0.2); }
        .quick-tools { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: var(--bg-panel); border: 1px solid var(--border); border-radius: 30px; padding: 10px 18px; z-index: 1500; display: flex; gap: 10px; box-shadow: var(--shadow); backdrop-filter: var(--backdrop); }
        .quick-btn { width: 42px; height: 42px; border-radius: 50%; background: var(--bg-glass); border: 1px solid var(--border); color: #e2e8f0; cursor: pointer; font-size: 17px; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
        .quick-btn:hover { background: var(--primary); color: #ffffff; border-color: var(--primary); box-shadow: 0 0 15px rgba(16,211,147,0.4); }
        .coords-disp { position: fixed; bottom: 80px; left: 20px; background: var(--bg-panel); border: 1px solid var(--border); border-radius: 8px; padding: 10px 14px; z-index: 1500; font-family: monospace; font-size: 12px; backdrop-filter: var(--backdrop); color: #ffffff; }
        .coords-disp span { color: var(--primary); font-weight: 600; }
        .undo-redo { position: fixed; bottom: 80px; right: 20px; background: var(--bg-panel); border: 1px solid var(--border); border-radius: 8px; padding: 8px; z-index: 1500; display: flex; gap: 6px; box-shadow: var(--shadow); }
        .undo-btn { width: 38px; height: 38px; border-radius: 6px; background: var(--bg-glass); border: 1px solid var(--border); color: #e2e8f0; cursor: pointer; font-size: 15px; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
        .undo-btn:hover:not(:disabled) { background: var(--primary); color: #ffffff; }
        .undo-btn:disabled { opacity: 0.3; cursor: not-allowed; }
        .toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(100px); background: var(--bg-panel); border: 1px solid var(--border); border-radius: 10px; padding: 16px 22px; display: flex; align-items: center; gap: 12px; z-index: 9999; box-shadow: var(--shadow); opacity: 0; transition: all 0.3s; color: #ffffff; font-weight: 500; }
        .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
        .toast.success { border-left: 4px solid var(--success); }
        .toast.error { border-left: 4px solid var(--danger); }
        .toast.warning { border-left: 4px solid var(--warning); }
        .loading { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(10, 15, 28, 0.9); display: none; align-items: center; justify-content: center; z-index: 10000; flex-direction: column; gap: 16px; }
        .loading.show { display: flex; }
        .spinner { width: 40px; height: 40px; border: 3px solid var(--border); border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .hidden { display: none !important; }
        .color-badge { display: inline-block; width: 12px; height: 12px; border-radius: 3px; margin-right: 6px; }
        .dist-label { background: rgba(0,0,0,0.9); color: #fcd34d; padding: 3px 6px; border-radius: 4px; border: 1px solid #fcd34d; font-size: 10px; font-weight: bold; }
        .vertex-label { background: #ffffff; color: #1e293b; border-radius: 50%; width: 20px; height: 20px; line-height: 20px; text-align: center; font-size: 10px; font-weight: bold; border: 2px solid #1e293b; box-shadow: 0 2px 4px rgba(0,0,0,0.3); }
        .azimuth-label { background: rgba(167, 139, 250, 0.95); color: #ffffff; padding: 3px 6px; border-radius: 4px; font-size: 9px; font-weight: bold; }
        input[type="file"] { display: none; }
        .lot-card { background: var(--bg-glass); border: 1px solid var(--border); border-radius: 8px; margin-bottom: 10px; overflow: hidden; }
        .lot-header { padding: 12px 14px; display: flex; align-items: center; justify-content: space-between; cursor: pointer; }
        .lot-header:hover { background: var(--bg-hover); }
        .lot-title { display: flex; align-items: center; gap: 8px; font-weight: 700; font-size: 13px; color: #ffffff; }
        .lot-badges { display: flex; gap: 6px; }
        .badge { padding: 3px 10px; border-radius: 4px; font-size: 10px; font-weight: 700; }
        .badge-warning { background: var(--warning); color: #1a1d23; }
        .badge-accent { background: var(--accent); color: #fff; }
        .lot-body { display: none; padding: 14px; border-top: 1px solid var(--border); }
        .lot-body.open { display: block; }
        .mini-table { width: 100%; font-size: 10px; margin-top: 8px; }
        .mini-table th, .mini-table td { padding: 6px 8px; text-align: center; border-bottom: 1px solid var(--border); }
        .mini-table th { background: var(--bg-dark); color: #e2e8f0; font-weight: 600; }
        .summary-box { background: linear-gradient(135deg, rgba(251,191,36,0.25), rgba(248,113,113,0.15)); border: 1px solid var(--warning); border-radius: 8px; padding: 18px; margin-bottom: 16px; }
        .summary-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 14px; }
        .summary-item { text-align: center; }
        .summary-val { font-size: 26px; font-weight: 800; font-family: monospace; }
        .summary-val.warning { color: var(--warning); text-shadow: 0 0 10px rgba(251,191,36,0.4); }
        .summary-val.danger { color: var(--danger); text-shadow: 0 0 10px rgba(248,113,113,0.4); }
        .summary-val.accent { color: var(--accent); text-shadow: 0 0 10px rgba(96,165,250,0.4); }
        .summary-val.success { color: var(--success); text-shadow: 0 0 10px rgba(52,211,153,0.4); }
        .summary-lbl { font-size: 10px; color: var(--text-2); text-transform: uppercase; font-weight: 600; }
        .export-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; margin-top: 16px; }
        .float-panel { position: fixed; background: var(--bg-panel); backdrop-filter: var(--backdrop); border: 1px solid var(--border); border-radius: 12px; box-shadow: var(--shadow); z-index: 3000; display: flex; flex-direction: column; overflow: hidden; min-width: 280px; }
        .fusion-bar { background: rgba(6, 182, 212, 0.1); border: 1px solid var(--cyan); border-radius: 6px; padding: 12px; margin-bottom: 12px; display: none; }
        .fusion-bar.active { display: block; }
        .fusion-count { font-size: 24px; font-weight: 800; color: var(--cyan); }
        @keyframes slicerPulse { 0%,100%{stroke-opacity:1;} 50%{stroke-opacity:0.5;} }
        /* MULTILINE */
        .ml-step { display: flex; align-items: flex-start; gap: 8px; margin-bottom: 6px; }
        .ml-step-num { background: #10b981; color: #fff; width: 20px; height: 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: bold; flex-shrink: 0; }
        .slicer-line-anim { animation: slicerPulse 1.5s ease-in-out infinite; }
        /* KEYBOARD SHORTCUTS */
        kbd {
            background: linear-gradient(135deg, var(--bg-glass), var(--bg-input));
            border: 1px solid var(--border);
            border-radius: 4px;
            padding: 4px 8px;
            font-family: monospace;
            font-size: 11px;
            font-weight: 700;
            color: var(--primary);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            display: inline-block;
            margin: 0 2px;
        }
        .shortcut-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: var(--bg-glass);
            border: 1px solid var(--border);
            border-radius: 8px;
            transition: all 0.2s;
        }
        .shortcut-item:hover {
            background: var(--bg-hover);
            border-color: var(--primary);
        }
        .shortcut-keys {
            display: flex;
            align-items: center;
            gap: 4px;
            font-weight: 600;
        }
        .shortcut-desc {
            color: var(--text-2);
            font-size: 12px;
        }
        /* TOUR GUIDE */
        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 0 9999px rgba(0,0,0,0.7), 0 0 20px var(--primary); }
            50% { box-shadow: 0 0 0 9999px rgba(0,0,0,0.7), 0 0 30px var(--primary); }
        }
        /* SPLASH SCREEN */
        @keyframes logoFloat { 
            0%, 100% { transform: translateY(0px) rotate(0deg); } 
            50% { transform: translateY(-20px) rotate(5deg); } 
        }
        @keyframes loadProgress { 
            0% { width: 0%; } 
            100% { width: 100%; } 
        }
        #splash-screen.hidden {
            opacity: 0;
            pointer-events: none;
        }
        /* PROFESSIONAL TOOLS */
        .pro-card {
            background: linear-gradient(135deg, rgba(16,211,147,0.1), rgba(59,130,246,0.1));
            border: 1px solid var(--primary);
            border-radius: 10px;
            padding: 14px;
            margin-bottom: 12px;
        }
        .pro-card-title {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 800;
            font-size: 12px;
            color: var(--primary);
            margin-bottom: 10px;
            text-transform: uppercase;
        }
        .setback-visual {
            position: relative;
            width: 100%;
            height: 120px;
            background: var(--bg-glass);
            border: 1px solid var(--border);
            border-radius: 8px;
            margin: 12px 0;
            overflow: hidden;
        }
        .setback-polygon {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 70%;
            height: 70%;
            border: 2px solid var(--primary);
            background: rgba(16,211,147,0.2);
        }
        .setback-inner {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            border: 2px dashed var(--warning);
            background: rgba(251,191,36,0.15);
        }
        .elevation-chart {
            width: 100%;
            height: 150px;
            background: var(--bg-glass);
            border: 1px solid var(--border);
            border-radius: 8px;
            position: relative;
            overflow: hidden;
        }
        .elevation-line {
            fill: none;
            stroke: var(--primary);
            stroke-width: 2;
        }
        .elevation-area {
            fill: rgba(16,211,147,0.3);
        }
        .smart-lot {
            background: var(--bg-glass);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .smart-lot-info {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        .smart-lot-area {
            font-size: 16px;
            font-weight: 800;
            color: var(--primary);
        }
        .smart-lot-dims {
            font-size: 10px;
            color: var(--text-2);
        }
        .smart-lot-status {
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 9px;
            font-weight: 700;
            text-transform: uppercase;
        }
        .status-ok { background: var(--success); color: #fff; }
        .status-warn { background: var(--warning); color: #1a1d23; }
        .status-error { background: var(--danger); color: #fff; }
        .input-with-unit {
            position: relative;
        }
        .input-with-unit input {
            padding-right: 35px;
        }
        .input-unit {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 11px;
            color: var(--text-3);
            font-weight: 600;
        }
        /* MEMORIAL & CROQUIS */
        .memorial-preview {
            background: #fff;
            color: #1a1a1a;
            border-radius: 8px;
            padding: 20px;
            font-family: 'Times New Roman', serif;
            font-size: 11px;
            line-height: 1.6;
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid var(--border);
        }
        .memorial-preview h1 {
            font-size: 14px;
            text-align: center;
            margin-bottom: 15px;
            text-transform: uppercase;
            border-bottom: 2px solid #333;
            padding-bottom: 10px;
        }
        .memorial-preview h2 {
            font-size: 12px;
            margin: 15px 0 8px 0;
            color: #333;
            border-bottom: 1px solid #ccc;
            padding-bottom: 4px;
        }
        .memorial-preview table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
            font-size: 10px;
        }
        .memorial-preview th, .memorial-preview td {
            border: 1px solid #333;
            padding: 5px 8px;
            text-align: center;
        }
        .memorial-preview th {
            background: #f0f0f0;
            font-weight: bold;
        }
        .croquis-canvas {
            background: #fff;
            border: 1px solid var(--border);
            border-radius: 8px;
            display: block;
            margin: 0 auto;
        }
        .croquis-config {
            background: var(--bg-glass);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 12px;
        }
        .croquis-config-title {
            font-size: 10px;
            color: var(--text-2);
            font-weight: 700;
            margin-bottom: 8px;
            text-transform: uppercase;
        }
        .color-picker-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }
        .color-picker-row label {
            font-size: 11px;
            color: var(--text-2);
            flex: 1;
        }
        .color-picker-row input[type="color"] {
            width: 40px;
            height: 28px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        /* ========== ASSISTANT & BEGINNER MODE ========== */
        /* Mode Toggle */
        .mode-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 4000;
            display: flex;
            align-items: center;
            gap: 10px;
            background: var(--bg-panel);
            padding: 8px 14px;
            border-radius: 25px;
            border: 1px solid var(--border);
            box-shadow: var(--shadow);
        }
        .mode-toggle-label {
            font-size: 11px;
            color: var(--text-2);
            font-weight: 600;
        }
        .mode-toggle-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 15px;
            border: none;
            font-size: 10px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
        }
        .mode-toggle-btn.active {
            background: var(--primary);
            color: #fff;
        }
        .mode-toggle-btn:not(.active) {
            background: var(--bg-glass);
            color: var(--text-2);
        }
        /* Smart Assistant */
        .assistant-fab {
            position: fixed;
            bottom: 90px;
            right: 25px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #8b5cf6, #6366f1);
            border: none;
            cursor: pointer;
            z-index: 4000;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 20px rgba(139, 92, 246, 0.5);
            transition: all 0.3s;
            animation: fabPulse 2s infinite;
        }
        .assistant-fab:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 30px rgba(139, 92, 246, 0.7);
        }
        .assistant-fab i {
            font-size: 24px;
            color: #fff;
        }
        .assistant-fab .notif-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            width: 22px;
            height: 22px;
            background: #ef4444;
            border-radius: 50%;
            font-size: 11px;
            font-weight: 800;
            color: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid var(--bg-dark);
        }
        @keyframes fabPulse {
            0%, 100% { box-shadow: 0 4px 20px rgba(139, 92, 246, 0.5); }
            50% { box-shadow: 0 4px 30px rgba(139, 92, 246, 0.8); }
        }
        /* WhatsApp Button */
        .whatsapp-float {
            position: fixed;
            bottom: 90px;
            right: 25px;
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #25D366, #128C7E);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 1600;
            box-shadow: 0 4px 15px rgba(37, 211, 102, 0.4);
            transition: all 0.3s ease;
            animation: pulse-whatsapp 2s infinite;
        }
        .whatsapp-float:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(37, 211, 102, 0.6);
        }
        .whatsapp-float i {
            font-size: 28px;
            color: white;
        }
        @keyframes pulse-whatsapp {
            0%, 100% { box-shadow: 0 4px 15px rgba(37, 211, 102, 0.4); }
            50% { box-shadow: 0 4px 25px rgba(37, 211, 102, 0.7); }
        }
        
        /* Chatbot Styles */
        .chatbot-container {
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        .chatbot-messages {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .chat-message {
            max-width: 85%;
            padding: 10px 14px;
            border-radius: 12px;
            font-size: 12px;
            line-height: 1.5;
            animation: fadeInUp 0.3s ease;
        }
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .chat-message.bot {
            background: var(--bg-glass);
            border: 1px solid var(--border);
            align-self: flex-start;
            border-bottom-left-radius: 4px;
        }
        .chat-message.user {
            background: linear-gradient(135deg, var(--primary), #059669);
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 4px;
        }
        .chat-message.bot .msg-time,
        .chat-message.user .msg-time {
            font-size: 9px;
            opacity: 0.7;
            margin-top: 4px;
            display: block;
        }
        .chatbot-options {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 8px;
        }
        .chatbot-option {
            background: var(--bg-input);
            border: 1px solid var(--primary);
            color: var(--primary);
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .chatbot-option:hover {
            background: var(--primary);
            color: white;
        }
        .chatbot-input-area {
            padding: 10px;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 8px;
        }
        .chatbot-input {
            flex: 1;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 8px 14px;
            color: var(--text-1);
            font-size: 12px;
            outline: none;
        }
        .chatbot-input:focus {
            border-color: var(--primary);
        }
        .chatbot-send {
            background: var(--primary);
            border: none;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: white;
            transition: all 0.2s;
        }
        .chatbot-send:hover {
            background: var(--primary-lt);
            transform: scale(1.05);
        }
        .whatsapp-banner {
            background: linear-gradient(135deg, #25D366, #128C7E);
            padding: 12px;
            border-radius: 8px;
            margin-top: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .whatsapp-banner:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 15px rgba(37, 211, 102, 0.3);
        }
        .whatsapp-banner-content {
            display: flex;
            align-items: center;
            gap: 10px;
            color: white;
        }
        .whatsapp-banner i {
            font-size: 24px;
        }
        .whatsapp-banner-text {
            flex: 1;
        }
        .whatsapp-banner-text strong {
            display: block;
            font-size: 11px;
        }
        .whatsapp-banner-text span {
            font-size: 9px;
            opacity: 0.9;
        }
        .typing-indicator {
            display: flex;
            gap: 4px;
            padding: 10px 14px;
            background: var(--bg-glass);
            border-radius: 12px;
            align-self: flex-start;
            border-bottom-left-radius: 4px;
        }
        .typing-indicator span {
            width: 8px;
            height: 8px;
            background: var(--text-3);
            border-radius: 50%;
            animation: typing 1.4s infinite ease-in-out;
        }
        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-6px); }
        }

        /* Assistant Panel */
        .assistant-panel {
            position: fixed;
            bottom: 160px;
            right: 25px;
            width: 360px;
            max-height: 500px;
            background: var(--bg-panel);
            border: 1px solid var(--border);
            border-radius: 16px;
            box-shadow: var(--shadow);
            z-index: 4001;
            display: none;
            flex-direction: column;
            overflow: hidden;
            animation: slideUp 0.3s ease;
        }
        .assistant-panel.active { display: flex; }
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .assistant-header {
            padding: 16px;
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.3), rgba(99, 102, 241, 0.2));
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .assistant-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: linear-gradient(135deg, #8b5cf6, #6366f1);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .assistant-avatar i { font-size: 20px; color: #fff; }
        .assistant-info h3 {
            font-size: 14px;
            font-weight: 700;
            color: #fff;
            margin: 0;
        }
        .assistant-info p {
            font-size: 11px;
            color: var(--text-2);
            margin: 2px 0 0 0;
        }
        .assistant-close {
            margin-left: auto;
            background: none;
            border: none;
            color: var(--text-2);
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
        }
        .assistant-close:hover { background: var(--bg-hover); color: #fff; }
        .assistant-body {
            flex: 1;
            padding: 16px;
            overflow-y: auto;
            max-height: 350px;
        }
        .assistant-message {
            background: var(--bg-glass);
            border-radius: 12px;
            padding: 14px;
            margin-bottom: 12px;
            border-left: 3px solid var(--primary);
        }
        .assistant-message p {
            font-size: 13px;
            color: var(--text-1);
            margin: 0 0 10px 0;
            line-height: 1.5;
        }
        .assistant-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        .assistant-action {
            padding: 8px 14px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 20px;
            color: var(--text-1);
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .assistant-action:hover {
            background: var(--primary);
            border-color: var(--primary);
            color: #fff;
        }
        .assistant-action i { font-size: 12px; }
        /* Quick Start Cards */
        .quickstart-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 12px;
        }
        .quickstart-card {
            background: var(--bg-glass);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 14px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }
        .quickstart-card:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(16, 211, 147, 0.2);
        }
        .quickstart-card i {
            font-size: 24px;
            margin-bottom: 8px;
            display: block;
        }
        .quickstart-card span {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-1);
        }
        /* Educational Tooltips */
        .edu-tooltip {
            position: fixed;
            background: var(--bg-panel);
            border: 1px solid var(--primary);
            border-radius: 10px;
            padding: 12px 16px;
            max-width: 280px;
            z-index: 9999;
            box-shadow: 0 10px 40px rgba(0,0,0,0.4);
            animation: tooltipFade 0.2s ease;
        }
        @keyframes tooltipFade {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        .edu-tooltip::before {
            content: '';
            position: absolute;
            bottom: -8px;
            left: 20px;
            border-left: 8px solid transparent;
            border-right: 8px solid transparent;
            border-top: 8px solid var(--primary);
        }
        .edu-tooltip-title {
            font-size: 12px;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .edu-tooltip-text {
            font-size: 11px;
            color: var(--text-2);
            line-height: 1.5;
        }
        .edu-tooltip-tip {
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid var(--border);
            font-size: 10px;
            color: var(--warning);
            display: flex;
            align-items: center;
            gap: 4px;
        }
        /* Glossary Panel */
        .glossary-panel {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 500px;
            max-height: 80vh;
            background: var(--bg-panel);
            border: 1px solid var(--border);
            border-radius: 16px;
            box-shadow: var(--shadow);
            z-index: 5000;
            display: none;
            flex-direction: column;
        }
        .glossary-panel.active { display: flex; }
        .glossary-header {
            padding: 16px 20px;
            background: linear-gradient(135deg, rgba(16, 211, 147, 0.2), rgba(96, 165, 250, 0.15));
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .glossary-header h2 {
            font-size: 14px;
            font-weight: 700;
            color: #fff;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .glossary-search {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border);
        }
        .glossary-search input {
            width: 100%;
            padding: 10px 14px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: #fff;
            font-size: 13px;
        }
        .glossary-search input:focus {
            outline: none;
            border-color: var(--primary);
        }
        .glossary-body {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }
        .glossary-item {
            padding: 14px;
            background: var(--bg-glass);
            border: 1px solid var(--border);
            border-radius: 10px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .glossary-item:hover {
            border-color: var(--primary);
        }
        .glossary-term {
            font-size: 13px;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 4px;
        }
        .glossary-def {
            font-size: 11px;
            color: var(--text-2);
            line-height: 1.5;
        }
        .glossary-example {
            margin-top: 8px;
            padding: 8px 10px;
            background: rgba(16, 211, 147, 0.1);
            border-radius: 6px;
            font-size: 10px;
            color: var(--text-3);
        }
        /* Demo Loader */
        .demo-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(10, 15, 28, 0.9);
            z-index: 6000;
            display: none;
            align-items: center;
            justify-content: center;
        }
        .demo-overlay.active { display: flex; }
        .demo-card {
            background: var(--bg-panel);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 30px;
            max-width: 450px;
            text-align: center;
        }
        .demo-card h2 {
            font-size: 18px;
            color: #fff;
            margin-bottom: 10px;
        }
        .demo-card p {
            font-size: 12px;
            color: var(--text-2);
            margin-bottom: 20px;
        }
        .demo-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }
        .demo-option {
            padding: 20px 15px;
            background: var(--bg-glass);
            border: 2px solid var(--border);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .demo-option:hover {
            border-color: var(--primary);
            transform: translateY(-3px);
        }
        .demo-option i {
            font-size: 28px;
            margin-bottom: 10px;
            display: block;
        }
        .demo-option span {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-1);
            display: block;
        }
        .demo-option small {
            font-size: 10px;
            color: var(--text-3);
        }
        /* Step Indicator */
        .step-indicator {
            position: fixed;
            bottom: 90px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--bg-panel);
            border: 1px solid var(--primary);
            border-radius: 25px;
            padding: 12px 20px;
            z-index: 3500;
            display: none;
            align-items: center;
            gap: 15px;
            box-shadow: var(--shadow);
        }
        .step-indicator.active { display: flex; }
        .step-number {
            width: 30px;
            height: 30px;
            background: var(--primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 800;
            color: #fff;
        }
        .step-text {
            font-size: 13px;
            color: var(--text-1);
            font-weight: 600;
        }
        .step-hint {
            font-size: 10px;
            color: var(--text-3);
        }
        .step-skip {
            padding: 6px 12px;
            background: var(--bg-glass);
            border: 1px solid var(--border);
            border-radius: 15px;
            color: var(--text-2);
            font-size: 10px;
            cursor: pointer;
        }
        .step-skip:hover { background: var(--bg-hover); }
        /* Beginner Mode Highlights */
        [data-beginner-highlight] {
            position: relative;
        }
        .beginner-mode [data-beginner-highlight]::after {
            content: attr(data-beginner-hint);
            position: absolute;
            bottom: -25px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--primary);
            color: #fff;
            padding: 4px 10px;
            border-radius: 10px;
            font-size: 9px;
            font-weight: 600;
            white-space: nowrap;
            opacity: 0;
            transition: opacity 0.2s;
            pointer-events: none;
        }
        .beginner-mode [data-beginner-highlight]:hover::after {
            opacity: 1;
        }
        /* Hidden in beginner mode */
        .beginner-mode .advanced-feature {
            display: none !important;
        }
        /* Wizard */
        .wizard-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(10, 15, 28, 0.95);
            z-index: 7000;
            display: none;
            align-items: center;
            justify-content: center;
        }
        .wizard-overlay.active { display: flex; }
        .wizard-card {
            background: var(--bg-panel);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 40px;
            max-width: 550px;
            text-align: center;
        }
        .wizard-icon {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, var(--primary), #059669);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
        }
        .wizard-icon i { font-size: 36px; color: #fff; }
        .wizard-card h1 {
            font-size: 22px;
            color: #fff;
            margin-bottom: 10px;
        }
        .wizard-card p {
            font-size: 13px;
            color: var(--text-2);
            margin-bottom: 25px;
            line-height: 1.6;
        }
        .wizard-question {
            font-size: 15px;
            color: var(--primary);
            font-weight: 700;
            margin-bottom: 20px;
        }
        .wizard-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }
        .wizard-opt {
            padding: 20px;
            background: var(--bg-glass);
            border: 2px solid var(--border);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .wizard-opt:hover {
            border-color: var(--primary);
            background: rgba(16, 211, 147, 0.1);
        }
        .wizard-opt i {
            font-size: 32px;
            margin-bottom: 10px;
            display: block;
        }
        .wizard-opt strong {
            font-size: 13px;
            color: var(--text-1);
            display: block;
            margin-bottom: 5px;
        }
        .wizard-opt span {
            font-size: 10px;
            color: var(--text-3);
        }
        .wizard-skip {
            background: none;
            border: none;
            color: var(--text-3);
            font-size: 12px;
            cursor: pointer;
            margin-top: 10px;
        }
        .wizard-skip:hover { color: var(--text-1); }
        /* ========== MULTI-POTREROS SYSTEM ========== */
        /* Floating Potreros Panel - Right Side */
        .potreros-panel {
            position: fixed;
            top: 80px;
            right: 60px;
            width: 260px;
            max-height: calc(100vh - 100px);
            background: var(--bg-panel);
            border: 1px solid var(--border);
            border-radius: 12px;
            box-shadow: var(--shadow);
            z-index: 2000;
            display: flex;
            flex-direction: column;
            transition: all 0.3s ease;
            overflow: hidden;
        }
        .potreros-panel.collapsed {
            width: 46px;
            height: 46px;
            border-radius: 10px;
        }
        .potreros-panel.collapsed .potreros-content {
            display: none;
        }
        .potreros-panel.collapsed .potreros-header {
            padding: 0;
            border: none;
        }
        .potreros-panel.collapsed .potreros-header-icon {
            width: 46px;
            height: 46px;
            border-radius: 10px;
        }
        .potreros-header {
            display: flex;
            align-items: center;
            padding: 10px 12px;
            background: linear-gradient(135deg, rgba(16, 211, 147, 0.2), rgba(139, 92, 246, 0.15));
            border-bottom: 1px solid var(--border);
            gap: 8px;
            cursor: pointer;
        }
        .potreros-header:hover {
            background: linear-gradient(135deg, rgba(16, 211, 147, 0.3), rgba(139, 92, 246, 0.2));
        }
        .potreros-header-icon {
            width: 28px;
            height: 28px;
            background: linear-gradient(135deg, var(--primary), #059669);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-size: 12px;
            flex-shrink: 0;
        }
        .potreros-header-info {
            flex: 1;
            min-width: 0;
        }
        .potreros-header-info h3 {
            font-size: 11px;
            font-weight: 700;
            color: #fff;
            margin: 0;
        }
        .potreros-header-info span {
            font-size: 9px;
            color: var(--text-3);
        }
        .potreros-collapse-icon {
            color: var(--text-2);
            font-size: 10px;
            transition: transform 0.3s;
        }
        .potreros-panel.collapsed .potreros-collapse-icon {
            display: none;
        }
        .potreros-content {
            display: flex;
            flex-direction: column;
            flex: 1;
            overflow: hidden;
        }
        .potreros-body {
            flex: 1;
            overflow-y: auto;
            padding: 8px;
            max-height: 350px;
        }
        .potreros-body::-webkit-scrollbar { width: 4px; }
        .potreros-body::-webkit-scrollbar-thumb { background: var(--primary); border-radius: 2px; }
        .potreros-empty {
            text-align: center;
            padding: 20px 10px;
            color: var(--text-3);
        }
        .potreros-empty i {
            font-size: 28px;
            margin-bottom: 8px;
            opacity: 0.5;
            display: block;
        }
        .potreros-empty p {
            font-size: 10px;
            margin: 0;
            line-height: 1.4;
        }
        .potrero-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 10px;
            background: var(--bg-glass);
            border: 2px solid var(--border);
            border-radius: 8px;
            margin-bottom: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .potrero-item:hover {
            border-color: var(--text-3);
            background: var(--bg-hover);
        }
        .potrero-item.active {
            border-color: var(--primary);
            background: rgba(16, 211, 147, 0.15);
            box-shadow: 0 0 10px rgba(16, 211, 147, 0.2);
        }
        .potrero-color {
            width: 14px;
            height: 14px;
            border-radius: 4px;
            flex-shrink: 0;
        }
        .potrero-info {
            flex: 1;
            min-width: 0;
        }
        .potrero-name {
            font-size: 11px;
            font-weight: 700;
            color: var(--text-1);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .potrero-meta {
            font-size: 9px;
            color: var(--text-3);
        }
        .potrero-actions {
            display: flex;
            gap: 2px;
            opacity: 0;
            transition: opacity 0.2s;
        }
        .potrero-item:hover .potrero-actions,
        .potrero-item.active .potrero-actions {
            opacity: 1;
        }
        .potrero-action {
            width: 22px;
            height: 22px;
            border-radius: 4px;
            border: none;
            background: transparent;
            color: var(--text-3);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 9px;
            transition: all 0.2s;
        }
        .potrero-action:hover {
            background: var(--bg-hover);
            color: var(--text-1);
        }
        .potrero-action.delete:hover {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }
        .potreros-footer {
            padding: 8px;
            border-top: 1px solid var(--border);
        }
        .potreros-add-btn {
            width: 100%;
            padding: 10px;
            border-radius: 8px;
            border: 2px dashed var(--border);
            background: transparent;
            color: var(--text-2);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 11px;
            font-weight: 600;
            transition: all 0.2s;
        }
        .potreros-add-btn:hover {
            border-color: var(--primary);
            color: var(--primary);
            background: rgba(16, 211, 147, 0.1);
        }
        /* Potrero Edit Modal */
        .potrero-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(10, 15, 28, 0.9);
            z-index: 6000;
            display: none;
            align-items: center;
            justify-content: center;
        }
        .potrero-modal.active { display: flex; }
        .potrero-modal-card {
            background: var(--bg-panel);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 25px;
            width: 350px;
        }
        .potrero-modal-title {
            font-size: 16px;
            font-weight: 700;
            color: #fff;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .potrero-colors {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 8px;
            margin-bottom: 15px;
        }
        .potrero-color-opt {
            width: 100%;
            aspect-ratio: 1;
            border-radius: 6px;
            border: 2px solid transparent;
            cursor: pointer;
            transition: all 0.2s;
        }
        .potrero-color-opt:hover {
            transform: scale(1.1);
        }
        .potrero-color-opt.selected {
            border-color: #fff;
            box-shadow: 0 0 10px currentColor;
        }
        /* Active Potrero Indicator on Map */
        .active-potrero-badge {
            position: fixed;
            top: 70px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--bg-panel);
            border: 2px solid var(--primary);
            border-radius: 25px;
            padding: 8px 20px;
            z-index: 2500;
            display: none;
            align-items: center;
            gap: 10px;
            box-shadow: var(--shadow);
        }
        .active-potrero-badge.visible { display: flex; }
        .active-potrero-badge .potrero-color {
            width: 12px;
            height: 12px;
        }
        .active-potrero-badge span {
            font-size: 12px;
            font-weight: 700;
            color: var(--text-1);
        }
        .active-potrero-badge small {
            font-size: 10px;
            color: var(--text-3);
            margin-left: 5px;
        }

        /* ========== RESPONSIVE - Mobile Support ========== */
        @media screen and (max-width: 768px) {
            /* Sidebar ms angosto */
            .sidebar {
                width: 260px;
            }
            
            /* Quick tools abajo y scroll horizontal */
            .quick-tools {
                left: 10px;
                right: 10px;
                top: auto;
                bottom: 15px;
                transform: none;
                flex-wrap: nowrap;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                justify-content: flex-start;
                padding: 8px 12px;
                max-width: calc(100% - 20px);
            }
            .quick-tools::-webkit-scrollbar { display: none; }
            .quick-btn, .undo-btn {
                min-width: 40px;
                width: 40px;
                height: 40px;
            }

            /* Paneles flotantes ms pequeos */
            .float-panel {
                max-width: 90vw !important;
                max-height: 60vh !important;
                left: 5% !important;
                right: 5% !important;
            }

            /* Panel potreros ajustado */
            .potreros-panel {
                right: 10px !important;
                top: 70px !important;
                width: 220px !important;
                max-height: 40vh !important;
            }

            /* Badge potrero activo */
            .active-potrero-badge {
                left: 280px;
                right: auto;
                transform: none;
                max-width: 150px;
                font-size: 10px;
            }

            /* Coordenadas ocultas en mvil */
            .coords-display {
                display: none;
            }

            /* Controles del mapa */
            .leaflet-control-zoom {
                margin-top: 10px !important;
            }
        }

        @media screen and (max-width: 480px) {
            .sidebar {
                width: 100%;
            }
            .active-potrero-badge {
                display: none;
            }
            .potreros-panel {
                width: 180px !important;
                max-height: 35vh !important;
            }
            .float-panel {
                max-height: 50vh !important;
            }
            .quick-btn, .undo-btn {
                min-width: 36px;
                width: 36px;
                height: 36px;
                font-size: 14px;
            }
        }

        /* ========== WIN-TEL CHATBOT FLOTANTE ========== */
        .chatbot-float-btn {
            position: fixed;
            bottom: 25px;
            right: 25px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #00d4ff, #00b8e6);
            border: none;
            cursor: pointer;
            z-index: 8000;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 20px rgba(0, 212, 255, 0.5);
            transition: all 0.3s ease;
            animation: chatbotPulse 2s ease-in-out infinite;
        }
        .chatbot-float-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 30px rgba(0, 212, 255, 0.7);
        }
        .chatbot-float-btn i { font-size: 26px; color: #fff; }
        .chatbot-float-btn .chat-badge {
            position: absolute;
            top: -3px;
            right: -3px;
            width: 18px;
            height: 18px;
            background: #ef4444;
            border-radius: 50%;
            border: 2px solid #0a0f1c;
            animation: badgePulse 1.5s ease-in-out infinite;
        }
        @keyframes chatbotPulse {
            0%, 100% { box-shadow: 0 4px 20px rgba(0, 212, 255, 0.5); }
            50% { box-shadow: 0 4px 35px rgba(0, 212, 255, 0.8); }
        }
        @keyframes badgePulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }

        .chatbot-float-container {
            position: fixed;
            bottom: 100px;
            right: 25px;
            width: 380px;
            height: 520px;
            background: #ffffff;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.25);
            z-index: 8001;
            display: none;
            flex-direction: column;
            overflow: hidden;
            animation: chatSlideUp 0.3s ease;
        }
        .chatbot-float-container.active { display: flex; }
        @keyframes chatSlideUp {
            from { opacity: 0; transform: translateY(20px) scale(0.95); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }

        .chatbot-float-header {
            padding: 16px 20px;
            background: linear-gradient(135deg, #00d4ff, #00b8e6);
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .chatbot-float-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
        }
        .chatbot-float-info { flex: 1; }
        .chatbot-float-name { font-size: 14px; font-weight: 700; color: #fff; margin-bottom: 2px; }
        .chatbot-float-status {
            font-size: 11px;
            color: rgba(255,255,255,0.9);
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .chatbot-float-status::before {
            content: '';
            width: 8px;
            height: 8px;
            background: #34c759;
            border-radius: 50%;
            animation: statusPulse 1.5s ease-in-out infinite;
        }
        @keyframes statusPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .chatbot-float-close {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            background: rgba(255,255,255,0.2);
            border: none;
            color: #fff;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        .chatbot-float-close:hover { background: rgba(255,255,255,0.3); }

        .chatbot-float-messages {
            flex: 1;
            padding: 16px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 12px;
            background: #f8fafc;
        }
        .chatbot-float-messages::-webkit-scrollbar { width: 5px; }
        .chatbot-float-messages::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }

        .chat-msg {
            max-width: 85%;
            padding: 12px 16px;
            border-radius: 16px;
            font-size: 13px;
            line-height: 1.5;
            animation: messageIn 0.3s ease;
        }
        @keyframes messageIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .chat-msg.bot {
            align-self: flex-start;
            background: #ffffff;
            border: 1px solid #e2e8f0;
            border-bottom-left-radius: 4px;
            color: #1e293b;
        }
        .chat-msg.user {
            align-self: flex-end;
            background: linear-gradient(135deg, #00d4ff, #00b8e6);
            border-bottom-right-radius: 4px;
            color: #fff;
        }
        .chat-msg.bot p { margin-bottom: 8px; }
        .chat-msg.bot p:last-child { margin-bottom: 0; }

        .chat-opts {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 12px;
        }
        .chat-opt {
            padding: 10px 14px;
            background: rgba(0, 212, 255, 0.1);
            border: 1px solid rgba(0, 212, 255, 0.3);
            border-radius: 10px;
            color: #1e293b;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .chat-opt:hover {
            background: #00d4ff;
            color: #fff;
            border-color: #00d4ff;
            transform: translateX(5px);
        }
        .chat-opt i { font-size: 14px; }

        .wa-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 14px 20px;
            background: linear-gradient(135deg, #25D366, #128C7E);
            border: none;
            border-radius: 12px;
            color: #fff;
            font-size: 13px;
            font-weight: 700;
            cursor: pointer;
            margin-top: 12px;
            transition: all 0.2s;
            text-decoration: none;
            box-shadow: 0 4px 15px rgba(37, 211, 102, 0.4);
        }
        .wa-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(37, 211, 102, 0.6);
        }
        .wa-btn i { font-size: 18px; }

        .chatbot-float-input {
            padding: 16px;
            background: #ffffff;
            border-top: 1px solid #e2e8f0;
            display: flex;
            gap: 10px;
        }
        .chatbot-float-input input {
            flex: 1;
            padding: 12px 16px;
            background: #f1f5f9;
            border: 1px solid #e2e8f0;
            border-radius: 25px;
            font-size: 13px;
            color: #1e293b;
            outline: none;
            transition: all 0.2s;
        }
        .chatbot-float-input input:focus {
            border-color: #00d4ff;
            box-shadow: 0 0 0 3px rgba(0, 212, 255, 0.2);
        }
        .chatbot-float-input input::placeholder { color: #94a3b8; }
        .chatbot-float-send {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: linear-gradient(135deg, #00d4ff, #00b8e6);
            border: none;
            color: #fff;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        .chatbot-float-send:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 15px rgba(0, 212, 255, 0.5);
        }
        .chatbot-float-send i { font-size: 16px; }

        .typing-dots {
            display: flex;
            gap: 4px;
            padding: 12px 16px;
            background: #ffffff;
            border: 1px solid #e2e8f0;
            border-radius: 16px;
            border-bottom-left-radius: 4px;
            align-self: flex-start;
            max-width: 70px;
        }
        .typing-dots span {
            width: 8px;
            height: 8px;
            background: #00d4ff;
            border-radius: 50%;
            animation: typingAnim 1.4s ease-in-out infinite;
        }
        .typing-dots span:nth-child(2) { animation-delay: 0.2s; }
        .typing-dots span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes typingAnim {
            0%, 60%, 100% { transform: translateY(0); opacity: 0.4; }
            30% { transform: translateY(-6px); opacity: 1; }
        }

        @media (max-width: 768px) {
            .chatbot-float-container {
                width: 100%;
                height: 100vh;
                bottom: 0;
                right: 0;
                border-radius: 0;
            }
            .chatbot-float-btn {
                width: 55px;
                height: 55px;
                bottom: 15px;
                right: 15px;
            }
        }

        @media print {
            .chatbot-float-btn, .chatbot-float-container { display: none !important; }
        }

        /* ========================================
           PRV DASHBOARD - TerraCut Integration
           ======================================== */
        .prv-dashboard {
            position: fixed;
            top: 60px;
            right: 20px;
            width: 380px;
            max-height: calc(100vh - 100px);
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.2);
            z-index: 1500;
            display: none;
            flex-direction: column;
            overflow: hidden;
            border: 2px solid #10b981;
        }
        .prv-dashboard.active {
            display: flex;
            animation: slideInDashboard 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes slideInDashboard {
            from { transform: translateX(100px) scale(0.9); opacity: 0; }
            to { transform: translateX(0) scale(1); opacity: 1; }
        }
        .prv-dashboard-header {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            padding: 16px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .prv-dashboard-title {
            font-size: 16px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .prv-dashboard-close {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 18px;
            transition: all 0.2s;
        }
        .prv-dashboard-close:hover { background: rgba(255,255,255,0.3); }
        .prv-dashboard-body { padding: 16px; overflow-y: auto; flex: 1; }
        .prv-status-card {
            background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            border: 1px solid #a7f3d0;
        }
        .prv-status-card.warning {
            background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
            border-color: #fcd34d;
        }
        .prv-current-label {
            font-size: 10px;
            font-weight: 700;
            color: #065f46;
            text-transform: uppercase;
            margin-bottom: 4px;
        }
        .prv-current-value {
            font-size: 24px;
            font-weight: 800;
            color: #047857;
        }
        .prv-potrero-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
            gap: 8px;
            margin-top: 12px;
        }
        .prv-potrero-item {
            background: white;
            border-radius: 8px;
            padding: 8px;
            text-align: center;
            border: 2px solid #e5e7eb;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }
        .prv-potrero-item:hover { transform: scale(1.05); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .prv-potrero-item.active { border-color: #10b981; background: #ecfdf5; }
        .prv-potrero-item.resting { border-color: #3b82f6; background: #eff6ff; }
        .prv-potrero-item.ready { border-color: #22c55e; background: #f0fdf4; }
        .prv-potrero-item.warning { border-color: #f59e0b; background: #fffbeb; }
        .prv-potrero-name { font-size: 11px; font-weight: 700; color: #374151; }
        .prv-potrero-days { font-size: 10px; color: #6b7280; margin-top: 2px; }
        .prv-potrero-status {
            position: absolute;
            top: -4px;
            right: -4px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 2px solid white;
        }
        .prv-potrero-status.active { background: #10b981; }
        .prv-potrero-status.resting { background: #3b82f6; }
        .prv-potrero-status.ready { background: #22c55e; animation: pulse-ready 1.5s infinite; }
        .prv-potrero-status.warning { background: #f59e0b; }
        @keyframes pulse-ready {
            0%, 100% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.4); }
            50% { box-shadow: 0 0 0 6px rgba(34, 197, 94, 0); }
        }

        /* ========================================
           SIMULADOR DE ROTACIN
           ======================================== */
        .simulation-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.8);
            z-index: 2000;
            display: none;
            align-items: center;
            justify-content: center;
        }
        .simulation-overlay.active { display: flex; }
        .simulation-panel {
            background: white;
            border-radius: 20px;
            width: 90%;
            max-width: 900px;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        .simulation-header {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            color: white;
            padding: 20px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .simulation-title { font-size: 18px; font-weight: 700; display: flex; align-items: center; gap: 10px; }
        .simulation-body {
            display: grid;
            grid-template-columns: 1fr 280px;
            flex: 1;
            overflow: hidden;
        }
        .simulation-map-container { position: relative; background: #f1f5f9; }
        .simulation-map { width: 100%; height: 100%; min-height: 400px; }
        .simulation-controls { padding: 20px; background: #f9fafb; overflow-y: auto; }
        .simulation-timeline { padding: 16px 24px; background: white; border-top: 1px solid #e5e7eb; }
        .simulation-progress {
            width: 100%;
            height: 8px;
            background: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 12px;
        }
        .simulation-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #10b981, #3b82f6, #8b5cf6);
            border-radius: 4px;
            transition: width 0.3s ease;
        }
        .simulation-play-controls { display: flex; justify-content: center; gap: 12px; align-items: center; }
        .sim-btn {
            width: 44px; height: 44px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            font-size: 18px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .sim-btn:hover { transform: scale(1.1); }
        .sim-btn-play {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            width: 56px; height: 56px;
            font-size: 24px;
        }
        .sim-btn-secondary { background: #f3f4f6; color: #374151; }

        /* ========================================
           RUTA PTIMA DE PASTOREO
           ======================================== */
        .route-line {
            stroke: #8b5cf6;
            stroke-width: 4;
            stroke-dasharray: 15, 10;
            animation: route-flow 1s linear infinite;
        }
        @keyframes route-flow {
            from { stroke-dashoffset: 0; }
            to { stroke-dashoffset: -25; }
        }
        .route-marker {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            color: white;
            border-radius: 50%;
            width: 28px; height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 12px;
            border: 3px solid white;
            box-shadow: 0 2px 8px rgba(139, 92, 246, 0.4);
        }

        /* ========================================
           COMPOSITOR DE IMPRESIN PROFESIONAL
           ======================================== */
        .composer-overlay {
            position: fixed;
            top: 0; left: 0;
            width: 100vw; height: 100vh;
            background: rgba(30, 41, 59, 0.95);
            z-index: 10000;
            display: none;
            justify-content: center;
            align-items: center;
        }
        .composer-overlay.active { display: flex; }
        .composer-container {
            width: 95vw;
            height: 95vh;
            background: #1e293b;
            border-radius: 16px;
            overflow: hidden;
            display: grid;
            grid-template-columns: 280px 1fr 280px;
            grid-template-rows: 60px 1fr;
            box-shadow: 0 25px 80px rgba(0,0,0,0.5);
        }
        .composer-header {
            grid-column: 1 / -1;
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            color: white;
        }
        .composer-title { font-size: 18px; font-weight: 700; display: flex; align-items: center; gap: 10px; }
        .composer-actions { display: flex; gap: 10px; }
        .composer-btn {
            padding: 10px 18px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .composer-btn:hover { transform: translateY(-1px); }
        .composer-btn-primary { background: white; color: #059669; }
        .composer-btn-secondary { background: rgba(255,255,255,0.2); color: white; }
        .composer-btn-close { background: rgba(255,255,255,0.1); color: white; font-size: 18px; padding: 8px 14px; }
        .composer-sidebar {
            background: #0f172a;
            padding: 20px;
            overflow-y: auto;
            color: white;
        }
        .composer-sidebar h3 {
            font-size: 12px;
            font-weight: 700;
            color: #94a3b8;
            text-transform: uppercase;
            margin: 20px 0 12px 0;
            letter-spacing: 0.5px;
        }
        .composer-sidebar h3:first-child { margin-top: 0; }
        .composer-group { margin-bottom: 16px; }
        .composer-input-group { margin-bottom: 12px; }
        .composer-input-group label {
            display: block;
            font-size: 11px;
            color: #64748b;
            margin-bottom: 6px;
        }
        .composer-select, .composer-input {
            width: 100%;
            padding: 10px 12px;
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 6px;
            color: white;
            font-size: 12px;
        }
        .composer-select:focus, .composer-input:focus {
            outline: none;
            border-color: #10b981;
        }
        .composer-checkbox {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 0;
            cursor: pointer;
            font-size: 12px;
        }
        .composer-checkbox input { accent-color: #10b981; }
        .composer-canvas-area {
            background: #334155;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: auto;
            position: relative;
            padding: 40px;
        }
        .composer-page {
            background: white;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            position: relative;
            transform-origin: center center;
        }
        .composer-page-a4-h { width: 1122px; height: 793px; }
        .composer-page-a4 { width: 793px; height: 1122px; }
        .composer-page-a3-h { width: 1587px; height: 1122px; }
        .composer-page-a3 { width: 1122px; height: 1587px; }
        .composer-zoom {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #1e293b;
            padding: 8px 16px;
            border-radius: 30px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .composer-zoom button {
            background: #334155;
            border: none;
            color: white;
            width: 32px; height: 32px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 16px;
        }
        .composer-zoom span { color: white; font-size: 12px; font-weight: 600; }
        .layout-map {
            position: absolute;
            border: 1px solid #0f172a;
            overflow: hidden;
        }
        .layout-grid { position: absolute; pointer-events: none; }
        .layout-north-arrow {
            position: absolute;
            width: 50px;
            height: 70px;
        }
        .layout-scale-bar {
            position: absolute;
            background: white;
            padding: 8px 12px;
            border-radius: 4px;
            border: 1px solid #e5e7eb;
        }
        .scale-bar-graphic {
            display: flex;
            height: 8px;
            border: 1px solid #0f172a;
        }
        .scale-bar-segment {
            flex: 1;
            background: #0f172a;
        }
        .scale-bar-segment:nth-child(even) { background: white; }
        .layout-legend {
            position: absolute;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 4px;
            padding: 12px;
            font-size: 10px;
        }
        .layout-legend-title {
            font-weight: 700;
            font-size: 11px;
            margin-bottom: 10px;
            padding-bottom: 6px;
            border-bottom: 1px solid #e5e7eb;
        }
        .layout-legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 6px;
        }
        .layout-title-box {
            position: absolute;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 4px;
            padding: 12px;
        }
        .layout-table {
            position: absolute;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
        }
        .layout-table table {
            width: 100%;
            border-collapse: collapse;
            font-size: 9px;
        }
        .layout-table th, .layout-table td {
            padding: 4px 6px;
            border: 1px solid #e5e7eb;
            text-align: left;
        }
        .layout-table th {
            background: #f1f5f9;
            font-weight: 700;
        }
        .layout-cajetin {
            position: absolute;
            background: white;
            border: 2px solid #0f172a;
            display: grid;
        }
        .cajetin-cell {
            border: 1px solid #0f172a;
            padding: 6px 10px;
            display: flex;
            align-items: center;
        }
        .cajetin-header {
            font-weight: 800;
            font-size: 12px;
            text-transform: uppercase;
            justify-content: center;
        }
        .cajetin-label {
            font-size: 8px;
            color: #64748b;
            text-transform: uppercase;
        }
        .cajetin-value {
            font-size: 10px;
            font-weight: 600;
        }

        /* ========================================
           LINE ELEVATION PROFILE - Nueva Funcin
           Perfil de Elevacin para Lneas/Rutas
           ======================================== */
        .line-profile-panel {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 280px;
            background: linear-gradient(180deg, rgba(15, 23, 42, 0.98) 0%, rgba(30, 41, 59, 0.99) 100%);
            backdrop-filter: blur(20px);
            border-top: 2px solid #8b5cf6;
            z-index: 2500;
            display: none;
            flex-direction: column;
            box-shadow: 0 -10px 40px rgba(0, 0, 0, 0.5);
            transform: translateY(100%);
            transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }
        .line-profile-panel.active {
            display: flex;
            transform: translateY(0);
        }
        .line-profile-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 20px;
            background: linear-gradient(90deg, rgba(139, 92, 246, 0.3) 0%, rgba(59, 130, 246, 0.2) 100%);
            border-bottom: 1px solid rgba(139, 92, 246, 0.3);
        }
        .line-profile-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
            font-weight: 700;
            color: white;
        }
        .line-profile-title i {
            color: #8b5cf6;
            font-size: 18px;
        }
        .line-profile-stats {
            display: flex;
            gap: 24px;
        }
        .line-profile-stat {
            text-align: center;
        }
        .line-profile-stat-value {
            font-size: 16px;
            font-weight: 800;
            color: #10b981;
            font-family: 'Monaco', monospace;
        }
        .line-profile-stat-label {
            font-size: 9px;
            color: #94a3b8;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .line-profile-actions {
            display: flex;
            gap: 8px;
        }
        .line-profile-btn {
            padding: 8px 14px;
            border: none;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .line-profile-btn-primary {
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
            color: white;
        }
        .line-profile-btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .line-profile-btn:hover {
            transform: translateY(-1px);
            filter: brightness(1.1);
        }
        .line-profile-btn-close {
            background: rgba(239, 68, 68, 0.2);
            color: #f87171;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }
        .line-profile-body {
            flex: 1;
            display: flex;
            padding: 16px 20px;
            gap: 20px;
            overflow: hidden;
        }
        .line-profile-chart-container {
            flex: 1;
            position: relative;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            border: 1px solid rgba(139, 92, 246, 0.2);
            overflow: hidden;
        }
        .line-profile-chart {
            width: 100%;
            height: 100%;
            cursor: crosshair;
        }
        .line-profile-tooltip {
            position: absolute;
            background: rgba(15, 23, 42, 0.95);
            border: 2px solid #8b5cf6;
            border-radius: 10px;
            padding: 12px 16px;
            pointer-events: auto;
            z-index: 100;
            display: none;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5), 0 0 20px rgba(139, 92, 246, 0.3);
            min-width: 180px;
            max-width: 220px;
        }
        .line-profile-tooltip.active {
            display: block;
        }
        .line-profile-tooltip-elev {
            font-size: 22px;
            font-weight: 800;
            color: #10b981;
        }
        .line-profile-tooltip-dist {
            font-size: 11px;
            color: #94a3b8;
            margin-top: 4px;
        }
        .line-profile-tooltip-grade {
            font-size: 11px;
            color: #f59e0b;
            margin-top: 2px;
        }
        .line-profile-cursor {
            position: absolute;
            width: 2px;
            background: #8b5cf6;
            top: 0;
            bottom: 0;
            pointer-events: none;
            display: none;
            box-shadow: 0 0 10px rgba(139, 92, 246, 0.5);
        }
        .line-profile-cursor.active {
            display: block;
        }
        .line-profile-cursor-dot {
            position: absolute;
            width: 12px;
            height: 12px;
            background: #8b5cf6;
            border: 3px solid white;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }
        .line-profile-info-panel {
            width: 200px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .line-profile-info-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 12px;
        }
        .line-profile-info-title {
            font-size: 10px;
            color: #64748b;
            text-transform: uppercase;
            margin-bottom: 8px;
            font-weight: 600;
        }
        .line-profile-info-row {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            margin-bottom: 4px;
        }
        .line-profile-info-label {
            color: #94a3b8;
        }
        .line-profile-info-value {
            color: white;
            font-weight: 600;
            font-family: monospace;
        }
        .line-profile-info-value.positive {
            color: #10b981;
        }
        .line-profile-info-value.negative {
            color: #ef4444;
        }

        /* Botn flotante para activar modo lnea */
        .line-profile-fab {
            position: fixed;
            top: 80px;
            left: 70px;
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
            border: none;
            border-radius: 10px;
            color: white;
            font-size: 20px;
            cursor: pointer;
            z-index: 2500;
            box-shadow: 0 4px 20px rgba(139, 92, 246, 0.5);
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .line-profile-fab:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 30px rgba(139, 92, 246, 0.7);
        }
        .line-profile-fab.active {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            animation: pulse-fab 1.5s infinite;
        }
        @keyframes pulse-fab {
            0%, 100% { box-shadow: 0 4px 20px rgba(239, 68, 68, 0.5); }
            50% { box-shadow: 0 4px 30px rgba(239, 68, 68, 0.8); }
        }
        .line-profile-fab[data-tooltip]:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            left: 100%;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(15, 23, 42, 0.95);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            white-space: nowrap;
            margin-left: 10px;
            border: 1px solid rgba(139, 92, 246, 0.3);
        }

        /* Indicador de modo dibujo */
        .line-draw-indicator {
            position: fixed;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
            color: white;
            padding: 12px 24px;
            border-radius: 30px;
            font-size: 13px;
            font-weight: 600;
            z-index: 2000;
            display: none;
            align-items: center;
            gap: 10px;
            box-shadow: 0 4px 20px rgba(139, 92, 246, 0.4);
            animation: pulse-indicator 2s infinite;
        }
        .line-draw-indicator.active {
            display: flex;
        }
        @keyframes pulse-indicator {
            0%, 100% { box-shadow: 0 4px 20px rgba(139, 92, 246, 0.4); }
            50% { box-shadow: 0 4px 30px rgba(139, 92, 246, 0.7); }
        }

        /* Marcador en el mapa */
        .line-profile-map-marker {
            width: 16px;
            height: 16px;
            background: #8b5cf6;
            border: 3px solid white;
            border-radius: 50%;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }
    </style>
</head>
<body>
    <!-- SPLASH SCREEN -->
    <div id="splash-screen" style="position:fixed;top:0;left:0;width:100vw;height:100vh;background:linear-gradient(135deg,#0a0f1c 0%,#1a1f2e 100%);z-index:99999;display:flex;flex-direction:column;align-items:center;justify-content:center;">
        <div class="splash-logo" style="animation:logoFloat 2s ease-in-out infinite;">
            <img src="data:image/jpeg;base64,/9j/4AAQSkZJRgABAgEASABIAAD/7QAsUGhvdG9zaG9wIDMuMAA4QklNA+0AAAAAABAASAAAAAEAAQBIAAAAAQAB/+E7VWh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8APD94cGFja2V0IGJlZ2luPSLvu78iIGlkPSJXNU0wTXBDZWhpSHpyZVN6TlRjemtjOWQiPz4KPHg6eG1wbWV0YSB4bWxuczp4PSJhZG9iZTpuczptZXRhLyIgeDp4bXB0az0iQWRvYmUgWE1QIENvcmUgNS4zLWMwMTEgNjYuMTQ1NjYxLCAyMDEyLzAyLzA2LTE0OjU2OjI3ICAgICAgICAiPgogICA8cmRmOlJERiB4bWxuczpyZGY9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkvMDIvMjItcmRmLXN5bnRheC1ucyMiPgogICAgICA8cmRmOkRlc2NyaXB0aW9uIHJkZjphYm91dD0iIgogICAgICAgICAgICB4bWxuczp0aWZmPSJodHRwOi8vbnMuYWRvYmUuY29tL3RpZmYvMS4wLyI+CiAgICAgICAgIDx0aWZmOlhSZXNvbHV0aW9uPjE1MDAwMDAvMTAwMDA8L3RpZmY6WFJlc29sdXRpb24+CiAgICAgICAgIDx0aWZmOllSZXNvbHV0aW9uPjE1MDAwMDAvMTAwMDA8L3RpZmY6WVJlc29sdXRpb24+CiAgICAgICAgIDx0aWZmOlJlc29sdXRpb25Vbml0PjI8L3RpZmY6UmVzb2x1dGlvblVuaXQ+CiAgICAgICAgIDx0aWZmOkNvbXByZXNzaW9uPjY8L3RpZmY6Q29tcHJlc3Npb24+CiAgICAgICAgIDx0aWZmOkpQRUdJbnRlcmNoYW5nZUZvcm1hdD4zMDI8L3RpZmY6SlBFR0ludGVyY2hhbmdlRm9ybWF0PgogICAgICAgICA8dGlmZjpKUEVHSW50ZXJjaGFuZ2VGb3JtYXRMZW5ndGg+MjU3OTwvdGlmZjpKUEVHSW50ZXJjaGFuZ2VGb3JtYXRMZW5ndGg+CiAgICAgIDwvcmRmOkRlc2NyaXB0aW9uPgogICAgICA8cmRmOkRlc2NyaXB0aW9uIHJkZjphYm91dD0iIgogICAgICAgICAgICB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iCiAgICAgICAgICAgIHhtbG5zOnhtcEdJbWc9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9nL2ltZy8iPgogICAgICAgICA8eG1wOkNyZWF0b3JUb29sPkFkb2JlIElsbHVzdHJhdG9yIENTNiAoTWFjaW50b3NoKTwveG1wOkNyZWF0b3JUb29sPgogICAgICAgICA8eG1wOk1vZGlmeURhdGU+MjAxMy0wMy0xMVQxODo0ODowMlo8L3htcDpNb2RpZnlEYXRlPgogICAgICAgICA8eG1wOkNyZWF0ZURhdGU+MjAxMy0wMy0xMVQxNDoxNzo1OC0wNDozMDwveG1wOkNyZWF0ZURhdGU+CiAgICAgICAgIDx4bXA6TWV0YWRhdGFEYXRlPjIwMTMtMDMtMTFUMTQ6MTc6NTgtMDQ6MzA8L3htcDpNZXRhZGF0YURhdGU+CiAgICAgICAgIDx4bXA6VGh1bWJuYWlscz4KICAgICAgICAgICAgPHJkZjpBbHQ+CiAgICAgICAgICAgICAgIDxyZGY6bGkgcmRmOnBhcnNlVHlwZT0iUmVzb3VyY2UiPgogICAgICAgICAgICAgICAgICA8eG1wR0ltZzp3aWR0aD4yNTY8L3htcEdJbWc6d2lkdGg+CiAgICAgICAgICAgICAgICAgIDx4bXBHSW1nOmhlaWdodD4xMTI8L3htcEdJbWc6aGVpZ2h0PgogICAgICAgICAgICAgICAgICA8eG1wR0ltZzpmb3JtYXQ+SlBFRzwveG1wR0ltZzpmb3JtYXQ+CiAgICAgICAgICAgICAgICAgIDx4bXBHSW1nOmltYWdlPi85ai80QUFRU2taSlJnQUJBZ0VBU0FCSUFBRC83UUFzVUdodmRHOXphRzl3SURNdU1BQTRRa2xOQSswQUFBQUFBQkFBU0FBQUFBRUEmI3hBO0FRQklBQUFBQVFBQi8rNEFEa0ZrYjJKbEFHVEFBQUFBQWYvYkFJUUFCZ1FFQkFVRUJnVUZCZ2tHQlFZSkN3Z0dCZ2dMREFvS0N3b0smI3hBO0RCQU1EQXdNREF3UURBNFBFQThPREJNVEZCUVRFeHdiR3hzY0h4OGZIeDhmSHg4Zkh3RUhCd2NOREEwWUVCQVlHaFVSRlJvZkh4OGYmI3hBO0h4OGZIeDhmSHg4Zkh4OGZIeDhmSHg4Zkh4OGZIeDhmSHg4Zkh4OGZIeDhmSHg4Zkh4OGZIeDhmSHg4Zi84QUFFUWdBY0FFQUF3RVImI3hBO0FBSVJBUU1SQWYvRUFhSUFBQUFIQVFFQkFRRUFBQUFBQUFBQUFBUUZBd0lHQVFBSENBa0tDd0VBQWdJREFRRUJBUUVBQUFBQUFBQUEmI3hBO0FRQUNBd1FGQmdjSUNRb0xFQUFDQVFNREFnUUNCZ2NEQkFJR0FuTUJBZ01SQkFBRklSSXhRVkVHRTJFaWNZRVVNcEdoQnhXeFFpUEImI3hBO1V0SGhNeFppOENSeWd2RWxRelJUa3FLeVkzUENOVVFuazZPek5oZFVaSFREMHVJSUpvTUpDaGdaaEpSRlJxUzBWdE5WS0JyeTQvUEUmI3hBOzFPVDBaWFdGbGFXMXhkWGw5V1oyaHBhbXRzYlc1dlkzUjFkbmQ0ZVhwN2ZIMStmM09FaFlhSGlJbUtpNHlOam8rQ2s1U1ZscGVZbVomI3hBO3FibkoyZW41S2pwS1dtcDZpcHFxdXNyYTZ2b1JBQUlDQVFJREJRVUVCUVlFQ0FNRGJRRUFBaEVEQkNFU01VRUZVUk5oSWdaeGdaRXkmI3hBO29iSHdGTUhSNFNOQ0ZWSmljdkV6SkRSRGdoYVNVeVdpWTdMQ0IzUFNOZUpFZ3hkVWt3Z0pDaGdaSmpaRkdpZGtkRlUzOHFPend5Z3AmI3hBOzArUHpoSlNrdE1UVTVQUmxkWVdWcGJYRjFlWDFSbFptZG9hV3ByYkcxdWIyUjFkbmQ0ZVhwN2ZIMStmM09FaFlhSGlJbUtpNHlOam8mI3hBOytEbEpXV2w1aVptcHVjblo2ZmtxT2twYWFucUttcXE2eXRycSt2L2FBQXdEQVFBQ0VRTVJBRDhBNlA1OC9NL3pKNVNudGRDaG0rdjYmI3hBO25hLzZSZTZqZFc2eEpjeE01S1Jvc2ZGQlJXVldaYVZJb0tIWTdEU2FNWkJaZFpyTmJLRXVHSTM1N3ZTUEp2bW0yODBlWHJYV2JlR1MmI3hBOzNTNEJEUlNnZ3E2bWpCV0lBZGE5R0g2NmpNVFBoT09SaVhPdzVSa2lKRHFuV1ZOcVdEWEZQbVk2RjlVbjVMWkMrTjl3L3dCR29aVEUmI3hBO0l1ZisvTnVWQjIraXFySEQrYTJpL3dDSTlXMEVXMXdMdlRCUkpHUXJITTQyWlFTS3JRblluWmh1TzFaNnZITEZnOFg2dkw4ZmIzT1AmI3hBO0RVeGxNdzN1TExkT3ZSZTJVTjBJMmlFcThnajlSL1o0Wmo0TXZIQVNxcmNoRTVhcnNWZGlyc1ZVN2lWNHJlV1dPRjdoNDBaa2dqS0ImI3hBOzVDQlVJcGtaRTVOMEhKZ1BFakZVcThtK1lqNWs4cmFacnB0alpuVWJkSnphbC9VOVBsK3p6b25MNTBHS29EVi9NbXUyOTFxUzJWcEMmI3hBOzl0cGl4bVpwUzNOaEl2S3FnRUNnSFhDaEd3ZVloQTZXK3FCVW5jS3l2Q0dNZEdjUjcxcVJ4Y2dIQWx0UE5tbUV5ODFsUVJsYUVvYWwmI3hBO1hSV1EwNmpsekFYRlY4Zm12UlpaNDRJNWk3eU9JMUlWdVBJc1VIeGROeU52YmZGVTN4VjJLdXhWMkt1eFYyS3V4VjJLdXhWMkt1eFYmI3hBOzJLdXhWMkt1eFYyS3ZQZk9INWFhaDVzODVXZDFxOTZqK1ZySkEwZW5vQ3NoazI1b3hIWjZWTFZyVDRRQjlyTTNCcWhqZ1JFZXM5WEImI3hBO3phV1dUSURJK2dkR3RXL0txNGNBNlpyMnB3Z00zcDI1dkpFampqTEF4eFJoTmxXTVY0N1Z6RTFPczFGRHdoanZyeERtMm5UQS93QVUmI3hBO3ZtczByeUI1cTA2OHRwMDFtNXVCYXllckhIZFhrc3FIWmdWY0JSVU1IK0wzQXpCeWFyWFNKcU9FQSs5bERCdzF2SS9GbkUvNmI5T0gmI3hBOzBQcXdmaCsvRW5PZ2VuN1BIdFh4ektoZkNPTG4xYjBtdk5KdTc2OU1sMUhwY2x6Q3ltVnFTZW9JSzFRUHZVL3RVcnQrT1RKTmVTTnImI3hBO1IwVXZtV1cyUjREcDhnYXZHUlRMd0svczBwV24zN1pHTWdSWTVKVFMxK3RlZ3YxdjAvWDM1K2xYaDEycHkzNllWVmNWZGlyc1ZkaXImI3hBO3NWU0RXZE8xbVc0U1N5amhha29rbGFSeXZxUmhHVDAzQVUvNzhZVjhNVlFDK1hmTVpsbXZYbHR6ZFN5TXlRdVM4Y2FGeElvVXNwL2EmI3hBO0ZlMjlEbEdlT1Exd0ZoSUhvcTIrZ2ExQklTaVdBNHN6Uk1Jd0dVc3hwUWxUU2kwSHkyRysrVkNPZnZDS2t2dHRDMWxKNDNrU3g5T0omI3hBO28yVUxHb05WS2hqWGdQMlYrSDZQbmhqSFBlNUg0NXFCSmsyWmJZN0ZYWXE3RlhZcTByS3dxcEREeEcrS3Q0cTdGWFlxN0ZYWXE3RlgmI3hBO1lxN0ZYWXE3RlhtdXQ2OXFxZVlydUdDOWxFQ1gxdEVxSTU0Z0ZXNXJ0N2pmTkxselRHWWl6WEZGdG9jUHdXYUI1bXZUbzltMTlyencmI3hBO1N6S1c0dkI2em45KzZsaEpYK1JDS0ViZGQrbWRIT0F2WU9oMDJwa2NZTXAwVDVlWi9RajAxNlY3Y1BINW5aZ3lNZVNXWExrVnFDUlUmI3hBO05RVjMrakk4UGszRE5ZMnlmN0ZtSTFQVDdlSkk3cStnRXlvdnFNN3BHU2VOZVhFbmFvM3lrdXlISjU1ZWVUZEpUelRxUG1QVDlkRnomI3hBO2RhaXZBV1J1VTRqbi9lY21ERG5HcWdjVlAyZm9GTDhtZmp4ZUdSczRzZEtCa003TzdOZERsMEhUZFBTM2kxQzNldFdrazlaQ0dlZzUmI3hBO0ViOUJtQnA5UEhGR2c1UTJUaUc0Z25UbkJJa3FWcHlSZ3dxTzFSbDZWK0t1eFYyS3V4VmlIa1A4eGJUelo1Zm4xa1d2MVNLQzhsc2cmI3hBO3FUUjNLdVlncDVySkY4Skh4VThLaXFsbDRzVXFnYlB6dnJSMU5ZcHhETGJWbTVyRXJCejZTRnVJTEViN0RLOGVhTXdTT2pHTXdVNC8mI3hBO3h2YnZJdm8yMGpSbFdvV29wSkRLRnBVOUNyaHZweXhOdWZ6cmJDZWl3TjZQQm1CWmtWNnJ2OFFKb3RRcDQxKzF0VHJpbHVienZhUkcmI3hBO1ZmcWszT0VrU0tRRm9BM0VuYytKWHA0NGFWa1VNcXl4Skt0ZU1paGxyMW9SWEFxN0ZYWXFrUG51THpSSjVUMUgvQ3N6UStZVWlMNmQmI3hBO3dGdWVjbyt5amZXVmVLamU5UG1NVlJYbVI1MDB1UXdzVk5SVWpyUWJuOVdLc1I4cjJWdk9BTlB0NUV2WWl3bXVkeEdqRGloVXNldkkmI3hBO0F2dDBQdGhRRVRlNm5yTnMxMVpUYXRHSHRFRFRqa3FPdkwxR1JGYjArUkxSaFRUN1JOZDZkYU1tb2pDNzJZbVlITkdmWDlacVVYWGImI3hBO0VTQjJEQWxHMkZCUVVSYWIxMk5lMjV3L21NZjg0SjR4M3B6NWRudkpiT1EzVjdGZk9KU0ZsaElJQ1VGRmJpc1lyOUdUaE9NdHdiU0QmI3hBO2FhWkpMc1ZkaXFFYldOSlc0K3J0ZXdMY2JVaU1pQnQ5eHRXdUtvc0VFVkc0UFE0cTdGWFlxbEdnYVRvT2d4dm91bGdRMWVhK2EzWjImI3hBO2QvOEFTWm1kMytNbHVQcU1RUERwaG8xYUxGMG1GbmQyVi9heFhscklrOXZNdktHWmQxWmZFSERLSkJvcUNEdUZpM0VIMTgyWVJRNngmI3hBO0NXdTNRdHhwVDZNcjQvVlM5VUJhZVRmTE5vOTI4V254czk5Y3kzbHkwdFpTMDArOGpBeUZpb0ovWkd3N0RKSlNLMjE3eS9GcUVzSjgmI3hBO3ZTd1BZdVVsdUZ0eHhFbk1vZURFSnpTbER5SGlNc25EaEEzNXRVTWxraXVTTXNydnlkZVhBWDlIckRKTVNyUE5DcUNyQXNRU1QzNC8mI3hBO2o3NUJ0WkphV1ZuWnhtSzFoU0NNbmtValVLSzlLMEdCVmJGWFlxN0ZYWXFoSjlNdHBMZjBJMVdCT1hNaU5RQlh4b01WUTYrWDdENnQmI3hBO05ESW9kcFZaUFdLcjZpaDE0bml4QnAxeUVvQXhJNzBFYlVoVjhvV1FJYjZ6Y2NsazlVTUhVR3V4cHN2VDRjeHZ5Y2U4ODJIaGh6K1UmI3hBO0xOMEt0ZFhIMmVJSVpRUlR2VUtLbnhyMU8vWEU2T0o2bGZEQ2EyZGxGYTJ3dDFKZEZMRUY2RTBaaTFQa0swR1pPT0hDS0RNQ2tSazAmI3hBO3V4VjJLdXhWWlBCRlBHWTVWNUllcW52aXJjY2NjYUJJMUNJdlJWRkFQdXhWQ3lhTnBVczgwOGxyRzgxeFQxblpRUzNGZUFyWC9KTk0mI3hBO2hMSEdYTVdnZ0ZzNlRwaEZEYXhFVnJUaUtWcVQwK2JIQjRNTzRMd2hWdHJPMHRWSzIwU1FxeHF3UUFBbjZNbEdFWThoU2dBSzJTUzcmI3hBO0ZWSzdVdGJTZ0dsVk80K1dLdk85T3Q1cGRTbXRocG4xMTVnb001QVZVQklTWVBJZitLMStIdUQwNjRxbW1zMTAzVTQ0cGRVa2l1ZFMmI3hBO1NXYjBvdlU0b3NVSVNXUXFyRGxTcTA2R3ZUMnB6WnVDaWVUR1VxUTFnOFFobTQ2MWN4RVBLQ2lSejFVdk96azBaMkgyVkpQSWNoWGQmI3hBO3UyVlIxc0NFRElFMDBPNnRsMU1GdGJsdVFJU3BoblZrVmlXNWM2czNDb0I2QVZ5Y05WamthQlNKZ3BkcnY1ZGE1ck9wWDE1TDVsbnQmI3hBO1JKTC9BTGpSYnhLajI5cTBLQjdkbVZsOVJXbmlXVGYzSDdXMnd3WitEbUxEVm53Y2RFRXhJN2sxdFBLK3MyVnJiV2RscTVndGJSUFMmI3hBO2dqRVFQR01iS3U1L1pVQ2xmRDN5bVVyTm5xM1JqUW9LT29hRDVpYStqbWp2YXZNVldTNmlpUldqVlFOcUZsUEV0dnNhL1BNYVlJbUMmI3hBO0JmVDNJcmRIUjZONWtxUFUxdGlLQ3ZHRkFTYWo1OXN2WkxyYnlwREhyK3BhdmMzazk2dW9wYkFhZmNGWHRyZDdWU09kdWhGWXk5YXQmI3hBO1E3bjZLS282UFF0RmpZTkhZd0l3NkVScUNQbHQ3NHFqc1ZkaXJzVmRpcnNWWXArWG5uNkR6bm9WMXEwTm9iUmJXNmx0REg2Z21EZW0mI3hBO3FPSFYxQ2o0bGtHM1kxR0VoVUhxMXJxbW8zOXpKK2tKWW92UlE2Y3NMR05HbGNzUFRZQ3UvSkNQSHBpaFV0TlZtMGNwYkpLMTQ3TEcmI3hBOzF6SE5JV1pIOUlPOVB0RmVXOUJrWlRBNWxicEZXdm1qVTU3eG8wdEE0Ymp4akFmNFR5Q3N2SUwxSExkdnMvRDc0SXppZVJVRlVYekwmI3hBO3JoTWZMUjVFQmtWSktoNjBiYjRhTFRZcWE3K0dUU3lYQXJzVmRpcVVlYVBOZWllVjlMT3Fheks4Tm1HNEZvNHBaMnJ4WnllRVN1MUYmI3hBO1JHWmpTZ0F4VkVYZXNXME9tSnFFUDcrQ1ZVZUZsTkF5eVVLdFduZ2E0cWxHbGVaZFRsdGt1cjZHRXdPYWhvQ3dZS1F1L0Y2MW83OEQmI3hBO3YxeFZHbnpkb25vbVJaSFpsRlRFSTM1ZFNEMUhHZ0trRnEwcjN4VlVielZvQ2dGN29JQ2FLV1NSYTdWcXRWM0ZEMUdLb3pUOVRzdFEmI3hBO2hhYTBrOVJFWW8xVlpDR0FCb1ZjS2VoeFZFNHE3RlhFQWloNkhGVnNjYVJyeFJRcStBeFZEM0dtV3M5eUxod2ZWQ0dQa0NSVmQ5dHYmI3hBOzlZNUdVUWVhQ0docGRxQVI4VkdOVDhSOS93RG1vNUR3WXJ3dVRUTFJINWdNVzkyYjVlT0VZb2cydEl2TEVwTEpwV3RKZjZoZXg2azgmI3hBO3NjOGx1OW5ZTUFzVUt3cHhrVU1QaVBxc2VUVjlzeDlUR1pqNkRVZ2I5L2trS0dvUDV0RXNON2JSUkNPRTBtc21rUHhvVklMVkcxUWQmI3hBO3hnd2NaTXBaZlNCSFlEZmZ6WVpPTGJoK0tYUlhQbmFlMWxudDcyeFJaRmtNWW1xV1NoQVVtZ29EU3A3Z2JiWlpvczJId3hLY2pJOHomI3hBO3kyN3g3ZzE1QmxzMVFUaXdiemI5Y2crdkd4K3AwYjEvU01ucUUwcXBYbFFENHRpUERNcVJ4VnRkckh4TDNxazZ5cHVkaXJzVmRpcnMmI3hBO1ZkaXF6MGtFYlJxQWdibFdncHV4Skora211S3NSMVRUN0dQbFpYR3N4Mm85VmJrUWxsRHE0NkdwM0hqaFZINlo1ZjBDN2htdVBYL1MmI3hBO1VrOG5LZTU1OVhDbGFVU2dGRmM3ZjJaVmt4Um1La3hNUVVVM2xUU0FnRUtOQTZxSTFrUmlTRkRjcVVma092dGxKMGNPbXlQREN3K1YmI3hBO0xScGpLMTFjRnVSWURrdEFUWC9KcjFOZm9HRDhuRzdzbzhOTzh5MngyS3V4VkovTmZsVFNQTk9rTnBPckNackpwSTVXU0NhU0FzMFQmI3hBO2MwNUdNcnlVTUFlTGJWQVBZWXFpdFQwODNHbkcxakpKQUNxWFlzZGhRRXN4SlB6SnJpcVc2TDVPc05QZHBwMk4zTXhQQVNmM2NZWTgmI3hBO2lFUTFIWHVmd3hWTEpmTFBtU1MrMWFSMXNQcWt6aGRLZ0NjdlFoRWJWWW5nbjcxcFdMOXd0ZHE3azR1YUdRazhCNmZqOURYSVM2SmomI3hBOytpZFpVbmpiYWJ4THMzRVEwSHhOMXI0MFViMDMrakg5OS9SVDZreDBTMXZMYTNranVvYmVGaTVaUmFyd1UxQXFXSGpsdUxqcjExZmsmI3hBO21OOVV4eTFrN0ZYWXE3RlhZcTdGWFlxeHkvOEFNdW8yMnN0WnBaQ1dFMEVMTVRHV1BHdXpHcTlkaG1ITFVTR1lRclk5V0lPNnEzblQmI3hBO1JvWkRCZU05dmNwL2VROFRKUThRMzJrREtldVpqSmN2blR5OHl5c2s3c0lWNXkwaWsrRmVRV3Bxdml3eFZBVGE3NUprTEJub1hBZVEmI3hBO1JySU85S0VMM3IyekZub2NVdWNlZndUeEpucHRyb0dvVzZ6MmkrcENqRUN2TVVhZ3FDR29lbE1BMEdJVnR5WGlLYnFvVlFxN0JSUWYmI3hBO0labEFVS1EzaFYyS3V4VjJLdUpvQ2FWOWhpckZmSlBtRHpYcStqNm5jK1k5R2ZRYjIzdnJpQzF0SDRrbTJRSzBVbk5KSlVrcnlJTHEmI3hBO1FwSTJGTVZTNU5JMHhyR1dTOVpXazFtVVF3M0QwTFF5cUhJTlR2UXNvcnZ2WENocTkxR3ovU2MxeEU4a0VWck1JV2VNY2xMUnNwRksmI3hBO092TDRJdUovMXNvelp4anErckdVNlVyWFdOUTlhVUc5ZU11MVpHSkpJNHFzYnQ4U0t1L0JpbzJwWHVkc3FHdGdVRElFVlk2dHEwdDMmI3hBO0NadFVqSEdaUFZnSVpRVVloeit3ZjVpb3FkZ045K2s0NnJHZHJTSmhtK1pETjJLdXhWMkt1eFYyS3V4VjJLdXhWMkt1eFYyS3V4VjImI3hBO0t1eFYyS3ZPL09INVlheHFta1hkbnBldVRpVzYxV1RWL3dEVG5keEd6eGlOWUlYVDRvNFk2RXF0RDF6SjB1YU9PVmtXNHVyd1N5UkEmI3hBO2lhbzJ5alRvTFR5MzVhMCsydnBQVmt0WVlvSkppZVRTUzhhTzNKNmRUeVlrOXN4ZFRuaUNaSFlFdDBmUkVBbFcwblg3SFZMdTV0b0wmI3hBO2VWR3Rxck84aUtGclhqeHFHYmMwUDNaajRkVEhKSWdBN0pqTUUwbWZvUWJmdTEyNmJETWxtdkFBNmQrdUt1eFYyS3V4VjJLdXhWMksmI3hBO3JaZVBwdHpGVm9lUTlzU1ZZVkpxUGxDYUpMbWF4dXZxMGo4VnVIaXBGeUpvZmlyeDdiNWlZOVlKOG95K1RXTWdQUXNpczlTOHV4UkMmI3hBOzN0SllVaVQ5aEJSUlU4YW5ieDZuTXVteEd4M2xqTFA2TWNxU1M4Qkp4VWh2Z3FDRHQ4OGFWZExZMlVzbnFTd1J2SUFBSFpRVFFFa2ImI3hBO2tlTEhJSEhFbXlFVUZiSnBkaXJzVmRpcnNWZGlyc1ZkaXJzVmRpcnNWZGlyc1ZkaXJzVmRpcnNWWVpENUg4d1hHa3hXbXQrWVcxRzcmI3hBO2llWWk3K3JKSFdPU1ZtVUZGWURrRTRMWDJOTmptSnF0S2N2V212Smo0dXFNMUhRdkxXbWFNcjZsRzBpeGYza3NaZFhsa2NLcEpDdCsmI3hBOzF4NkUweTdCaEdPTkJsR0lBUzdUN2J5YmN6U1drV24zY1JVOForWmtRSnpCQTUvSFhjQ25UTGtwdlA1YThxbVF6TUFEZFNEWlpXNHUmI3hBOzlhYktEVHEyQktNMHZSOUUwMWpMWTBUbXZFL3ZXY0ZhazlHWWpiaWZ4eFZORWRIWGtqQmw2VkJxTnR1Mkt0NHE3RlhZcTdGV0cvbHImI3hBOzVDbThrK1Y3blIzdi93QkltVzRsdVZtNE1sQTZJbFBpZVYyTGVuellsdXJFRDRRTUV1U2xKWFc3bjhxVzJqTFpYSzNhejh5elF1STYmI3hBO0ZtL2FwL2xacmRGbTRJQ0pFcjl6ajQ1VUtvc2l2UExkcmI2ZGI4YkVUWERxRXUxWDFHWW5nQ3hYaTYvdEptZG1uS0l1SXR1bFlRQ3gmI3hBO1FTU0k0MGk5dDZ5YmNTeFhnaUlmajVocUFucVZGYWUrMlk4ZFhMckFzQk05eXRaQ1d5dllabzdMVUptaVYycEt4SzFjQldEZnUrdGYmI3hBO2lwNy9BRVpJNnFYOHdwNHozTXhqYm5HcmxTdklBOFRzUlhzY3lnYkRZdXdxN0ZYWXE3RlhZcTdGWFlxN0ZYWXE3RlhZcTdGWFlxN0YmI3hBO1hZcTdGWFlxeEM5OGt3UjYvcUd1emFwcVZ4QnFDUnhOcGNrelRXZHZ3Wkg5V0dFMUtubkh2UTdjbTJwaFZEeDZsZTNNNE1Oak1MNjgmI3hBO3VSRmNzOFRxaHQxRWlySnlJVUFoSk8vaGloQnBwNEVJSjA2OW9xeENkQUtGdU1YSDRDWTZyUXI4UkhYN3N3QnE1MTlCYStNOXlLbDAmI3hBO3kyY281MDY5ZVFNd2RDQW9iaXdOR0Nwdyt5ekNnMm9UMU9XSFV5L21sUEg1TWc4cVFMQnByUnJETkFCSlhoUDlyNGtSdHFLbTI5T24mI3hBO1d1VzRzaG1MSXBsRTJuT1dzbllxN0ZYWXFsbmwvd0F5NkY1aXNudnRGdkV2ck9PVjRHbmpEY1BVanB5Q2xnT1EzRkdHeDdIRlVCci8mI3hBO0FKaDFDMXVrczlPamlhNFk3R2ZrUTFGWThWQ2tibmpRYjRWWFA1bmx0RWpGN0FzanlQeERXN2JFTXhWV0FZOXo0bmJBcXovRzlnWkImI3hBO3hnbE1SVG1HcWdiN1BPbkV0dDhOYVY2bnBXdUtxaitjOU9SM1JvSndZM0VjbFZVVUpOTzdlSVlmUWNWVC9GWFlxN0ZYWXE3RlhZcTcmI3hBO0ZYWXE3RlhZcTdGWFlxN0ZYWXE3RlhZcTdGWFlxN0ZYWXE3RlhZcTdGWFlxN0ZYWXE3RlVrOHBlVFBMbmxIVHBkTjBDMCtwMmMwN1gmI3hBO01rWE41UDNqcXFiRnl4QUNScW9BNkFZcWhkYjBhdzFUVlZpZStTM21IRmhHanI2L3dtdndpdFIwTzlNS291NDh0cXRwQmI2Wk1iRXcmI3hBO0ZtOVFBdXpGaFFsanlCSjkvdXpIejRwVHFqVk1aUnZrcFErWHRYaUJBMVppR0JxREh0eU1uUGxzd1AzSDhOc3FHbnlEK1A4QUZzUkEmI3hBOzk2bzJuK1k0cFQ2TjdGTEV6RjI5VmFOMEpBNlB0VURwVHFhWWZEeWc3UzJXcGQ2ZDVsdGpzVmRpcnNWZGlyc1ZkaXJzVmRpcnNWZGkmI3hBO3JzVmRpcnNWZGlyc1ZkaXJzVmRpcnNWZGlyc1ZkaXJzVmRpcnNWZGlyRTlKMWJ6WWZLMm8zMnRlZ2w5SGMzTVZrWXJXV3ovMGVLWXcmI3hBO1J5UERQTmNNR2s0R1JUem9WWmR1dUtzVzB1T3p2SlFsMWJUWGx6SkVHak1ZWjJQTm1SeXg2VlhseURIdmhRbkUrdlhsbGV5UUMvTnYmI3hBO3dlUUczbFV5ZW1LY2xCNHF5OFZGUjhKOE8yWWs5YmppYVBOZ2NvQlhIWDcrM2Q0enFxaVVGL2daWG0rTU0zd0drSThGM0hRVjIzcmkmI3hBO2RiaUJxMU9RTWgwcC9NSzNNRWQyVXViUjRpNzNTZ0tlVlNGQUZWTzZnRS9EMUp6S0JCRnRpZFlxN0ZYWXE3RlhZcTdGWFlxN0ZYWXEmI3hBOzdGWFlxN0ZYWXE3RlhZcTdGWFlxN0ZYWXE3RlhZcTdGWFlxN0ZYWXE3RlhZcWtXbitkUExPcmFKZGF4cHQwTC9BRTYwa2VHZDQxYismI3hBOzhqcHlRQnd0ZnRDaDZlK0twWW5uaTQ5UzNGdHBSa2duVXNSRTRKSHh5QURaZU5lTUxOVERTTFQ2MTF6U2JoVUxPc0VzbkdrVXhWWHEmI3hBOy9RYkVnayt4d1VsZkZyR2l5c1FsMUNTR0sxNUtLa0tITkNldXpkUmpTcTBXcGFkTElzVVZ6RThqMTRJcnFTYUNwb0FmQTF4VkU0cTcmI3hBO0ZYWXE3RlhZcTdGWFlxN0ZYWXE3RlhZcTdGWFlxN0ZYWXE3RlhZcTdGWFlxN0ZYWXE3RlhZcTdGWFlxN0ZYWXF4elF2eSs4cjZCb0YmI3hBOzFvT2oyNzJtbjNrcnp6TDZza3JlbzRWYWhwaklkbGpWUU9sQjg4YlZEMmZreSt0YmlQMGI4SmJwQzBMRll4NmhCa2Q2cVBzcXdEMDUmI3hBO2IvTENxL1Y5RXVWdkVlenNWdTFjS1hlUitJRWdrTGxqUmgzcHNGcCtyTWJOTEtENlJZWVNNdWlGaTBiVUkxY0hSMWQ2QmF0T3hFbjcmI3hBO3ZoOFZYN0xXaDdkQU8rVmpKbS9tb3VYY2lkSTB1N2cxQ0NWdEtTMmloZHdraXlFa0s2R3JrYzI3MEhIdGs0Wk1wTzhka2d5N21VNWsmI3hBO3MzWXE3RlhZcTdGWFlxN0ZYWXE3RlhZcTdGWFlxN0ZYWXE3RlhZcS8vOWs9PC94bXBHSW1nOmltYWdlPgogICAgICAgICAgICAgICA8L3JkZjpsaT4KICAgICAgICAgICAgPC9yZGY6QWx0PgogICAgICAgICA8L3htcDpUaHVtYm5haWxzPgogICAgICA8L3JkZjpEZXNjcmlwdGlvbj4KICAgICAgPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIKICAgICAgICAgICAgeG1sbnM6ZXhpZj0iaHR0cDovL25zLmFkb2JlLmNvbS9leGlmLzEuMC8iPgogICAgICAgICA8ZXhpZjpDb2xvclNwYWNlPjE8L2V4aWY6Q29sb3JTcGFjZT4KICAgICAgICAgPGV4aWY6UGl4ZWxYRGltZW5zaW9uPjgwMDwvZXhpZjpQaXhlbFhEaW1lbnNpb24+CiAgICAgICAgIDxleGlmOlBpeGVsWURpbWVuc2lvbj42MDA8L2V4aWY6UGl4ZWxZRGltZW5zaW9uPgogICAgICA8L3JkZjpEZXNjcmlwdGlvbj4KICAgICAgPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIKICAgICAgICAgICAgeG1sbnM6ZGM9Imh0dHA6Ly9wdXJsLm9yZy9kYy9lbGVtZW50cy8xLjEvIj4KICAgICAgICAgPGRjOmZvcm1hdD5pbWFnZS9qcGVnPC9kYzpmb3JtYXQ+CiAgICAgIDwvcmRmOkRlc2NyaXB0aW9uPgogICAgICA8cmRmOkRlc2NyaXB0aW9uIHJkZjphYm91dD0iIgogICAgICAgICAgICB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIKICAgICAgICAgICAgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiCiAgICAgICAgICAgIHhtbG5zOnN0RXZ0PSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VFdmVudCMiPgogICAgICAgICA8eG1wTU06RG9jdW1lbnRJRD54bXAuZGlkOkZDN0YxMTc0MDcyMDY4MTE4MjJBRUIzM0FFNUI5Nzg1PC94bXBNTTpEb2N1bWVudElEPgogICAgICAgICA8eG1wTU06SW5zdGFuY2VJRD54bXAuaWlkOkZDN0YxMTc0MDcyMDY4MTE4MjJBRUIzM0FFNUI5Nzg1PC94bXBNTTpJbnN0YW5jZUlEPgogICAgICAgICA8eG1wTU06T3JpZ2luYWxEb2N1bWVudElEPnhtcC5kaWQ6Rjc3RjExNzQwNzIwNjgxMTgyMkFFQjMzQUU1Qjk3ODU8L3htcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD4KICAgICAgICAgPHhtcE1NOlJlbmRpdGlvbkNsYXNzPnByb29mOnBkZjwveG1wTU06UmVuZGl0aW9uQ2xhc3M+CiAgICAgICAgIDx4bXBNTTpEZXJpdmVkRnJvbSByZGY6cGFyc2VUeXBlPSJSZXNvdXJjZSI+CiAgICAgICAgICAgIDxzdFJlZjppbnN0YW5jZUlEPnV1aWQ6NWZhM2RmN2YtNDkxYi00MDQ3LTg0ODQtMDM4ODc0ZDhhODczPC9zdFJlZjppbnN0YW5jZUlEPgogICAgICAgICAgICA8c3RSZWY6ZG9jdW1lbnRJRD54bXAuZGlkOkY3N0YxMTc0MDcyMDY4MTE4MjJBRUIzM0FFNUI5Nzg1PC9zdFJlZjpkb2N1bWVudElEPgogICAgICAgICAgICA8c3RSZWY6b3JpZ2luYWxEb2N1bWVudElEPnhtcC5kaWQ6Rjc3RjExNzQwNzIwNjgxMTgyMkFFQjMzQUU1Qjk3ODU8L3N0UmVmOm9yaWdpbmFsRG9jdW1lbnRJRD4KICAgICAgICAgICAgPHN0UmVmOnJlbmRpdGlvbkNsYXNzPnByb29mOnBkZjwvc3RSZWY6cmVuZGl0aW9uQ2xhc3M+CiAgICAgICAgIDwveG1wTU06RGVyaXZlZEZyb20+CiAgICAgICAgIDx4bXBNTTpIaXN0b3J5PgogICAgICAgICAgICA8cmRmOlNlcT4KICAgICAgICAgICAgICAgPHJkZjpsaSByZGY6cGFyc2VUeXBlPSJSZXNvdXJjZSI+CiAgICAgICAgICAgICAgICAgIDxzdEV2dDphY3Rpb24+c2F2ZWQ8L3N0RXZ0OmFjdGlvbj4KICAgICAgICAgICAgICAgICAgPHN0RXZ0Omluc3RhbmNlSUQ+eG1wLmlpZDpGNzdGMTE3NDA3MjA2ODExODIyQUVCMzNBRTVCOTc4NTwvc3RFdnQ6aW5zdGFuY2VJRD4KICAgICAgICAgICAgICAgICAgPHN0RXZ0OndoZW4+MjAxMy0wMy0xMVQwODo1NzowOS0wNDozMDwvc3RFdnQ6d2hlbj4KICAgICAgICAgICAgICAgICAgPHN0RXZ0OnNvZnR3YXJlQWdlbnQ+QWRvYmUgSWxsdXN0cmF0b3IgQ1M2IChNYWNpbnRvc2gpPC9zdEV2dDpzb2Z0d2FyZUFnZW50PgogICAgICAgICAgICAgICAgICA8c3RFdnQ6Y2hhbmdlZD4vPC9zdEV2dDpjaGFuZ2VkPgogICAgICAgICAgICAgICA8L3JkZjpsaT4KICAgICAgICAgICAgICAgPHJkZjpsaSByZGY6cGFyc2VUeXBlPSJSZXNvdXJjZSI+CiAgICAgICAgICAgICAgICAgIDxzdEV2dDphY3Rpb24+c2F2ZWQ8L3N0RXZ0OmFjdGlvbj4KICAgICAgICAgICAgICAgICAgPHN0RXZ0Omluc3RhbmNlSUQ+eG1wLmlpZDpGQzdGMTE3NDA3MjA2ODExODIyQUVCMzNBRTVCOTc4NTwvc3RFdnQ6aW5zdGFuY2VJRD4KICAgICAgICAgICAgICAgICAgPHN0RXZ0OndoZW4+MjAxMy0wMy0xMVQxNDoxNzo1OC0wNDozMDwvc3RFdnQ6d2hlbj4KICAgICAgICAgICAgICAgICAgPHN0RXZ0OnNvZnR3YXJlQWdlbnQ+QWRvYmUgSWxsdXN0cmF0b3IgQ1M2IChNYWNpbnRvc2gpPC9zdEV2dDpzb2Z0d2FyZUFnZW50PgogICAgICAgICAgICAgICAgICA8c3RFdnQ6Y2hhbmdlZD4vPC9zdEV2dDpjaGFuZ2VkPgogICAgICAgICAgICAgICA8L3JkZjpsaT4KICAgICAgICAgICAgPC9yZGY6U2VxPgogICAgICAgICA8L3htcE1NOkhpc3Rvcnk+CiAgICAgIDwvcmRmOkRlc2NyaXB0aW9uPgogICA8L3JkZjpSREY+CjwveDp4bXBtZXRhPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgCjw/eHBhY2tldCBlbmQ9InciPz7/7gAhQWRvYmUAZMAAAAABAwAQAwIDBgAAVR0AAGIOAACabf/bAIQAAgICAgICAgICAgMCAgIDBAMCAgMEBQQEBAQEBQYFBQUFBQUGBgcHCAcHBgkJCgoJCQwMDAwMDAwMDAwMDAwMDAEDAwMFBAUJBgYJDQsJCw0PDg4ODg8PDAwMDAwPDwwMDAwMDA8MDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwM/8IAEQgCLgMZAwERAAIRAQMRAf/EAQUAAQACAgMBAQEAAAAAAAAAAAAHCAYJAwQFAQIKAQEBAAIDAQAAAAAAAAAAAAAAAQMFAgQGBxAAAAYCAQEECQQCAgIDAAAAAQIDBAUGAAcIERAgYBIwUCExEzMUNDdAFRY2sBciIyQJcEEYEQACAQMCAwQEBwgKDA0FAAABAgMRBAUAEiExBhBBURNhcSIUIIGhsTJCFZFSYnIjs3UHMFBgwYKSwnMkdEDRorIzQ5PTNLQ2CLBTY4Ojw6TE1DWFlRbwZIQl1RIAAQMBBAUKAwYGAQUAAAAAAQARAgMhMUFxEFFhgRJg8JGhscHRIjJyINIE4UJSghMzsJKissIjYvHyc9MU/9oADAMBAAIRAxEAAADf4AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAeQVajESQiTakk9IAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA+GCngR7tZOa3oi4AH7M+JMJOJOqSj1QAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAV+iPADEStIAAAAP0SUXjqWQAAAAAAdA/R3QAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADGCsUADCSuIAAJbPJI6BYI2A1WWLPVqhi79WAAAAAANf8emXtoAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACLyvsc5zH08gqkSOWXKWnTMzNqdeaaqo8AueW5qpcW0qDyVD3AAAAADXNHrmwKgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABgZHZBcD9naOyVeLQl3qpDFVSczYrQqDFNTYFVgig8X6rVHF4qk81eRbYqcfgvRVhjGSjMRwTSYGZIbAqjIorEYmXlzasSay4tXViSpcVSNqNd81aReCusUbjEiRS9VSuAAAAAAAAAAAAAAAAAAAADyyLzjK6R8ABBh0zapXSNVkWaLy1FpnBqkjZFXtFJI2HVp9i8JL9av4nkulVFYxM2p1ryiIy9NRzFPSwxfqtVcSKXaquUVFNoVVKjyjYZWr+I5Nh9ZeawI2p1rtiXi7tUajsl56AAAAAAAAAAAAAAAAAAAAGOkeggePHABE5gZa8uzVDozwtXWtyNltUoi29RCVXjZBWn2Lwkv1q/jYtU5FOIqwbbq1IRZwunQ1XxJxbetYUbI6mU6xqHi6ZnVa/42h1qtiwZ7RlZAhs2qm0VGJbJqLOVkIAAAAAAAAAAAAAAAAAAAAPKIwBEEYcADACKjtm1GuiRwSUaro2TVn5kZT6IYNkVafYvCS/Wr+Nj9TSU7iqpturUtFmC6NDVlEllvq1dxsaqbjzzUXF3iztamonIwot9VHYyYn0tlUcnOQjFWznNpVAAAAAAAAAAAAAAAAAAAADiIgBHcRmADGiEAWYL4V1CJDW7E1mx2hr3jzTYpWn2Lwkv1q/jY/U0lO4qqbbqoPEHl5qwWKaFhS/8AWryPRLj1XmK8G0qsxKFRW4uGW0rUpHVNqtZeaqonUtRVRYhQ2u0AAAAAAAAAAAAAAAAAAAABFB0jFCGoAHUK7A5jaJWfFYYoqDYBWemuKLy1YM1qRcWpGNcEbC6zQgErTGxSvEKMRF5Ox2j2y29YgUqiLzLi4dTGCLShUbDqzkpJHil9aERlOIwszQuLUvAAAAAAAAAAAAAAAAAAAAAEdHgHnlf4AArydEEnFp6qVEfgGbl/KlUAAAAAAA8/Dx8Lq8Mt2GUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAYWYeCvEdYAEJmLgAAFnS7NekAAAVA+d6nPdtnifz/VkDb5+OMz2Waa/TdwCAvJ9GEPL9K9n1TdgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADHSPQQnGNgAiwj4AAyMvfU7AAAAEQed6kv+i7dFflektV73aZV38mE6zDJm77IGGa3DUj57qr1fVN2AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAPNItBFsYCADBiJAATwXvrIQAAAARIalSaPm+n2O+x2MgbfPi3QxQT5XpcHGTX6budrnajfPdVer6pu4q0PVwHU4PE6vCzft9l1uErz4/X93LyyTu5JO3fZgPyfR5uTJu9lmn03cql4HV5B2+eOdPH7XZ5+928kUaDq2O9lsJL3fZAAAAAAAAAAAAAAAAAAAAA/JD5+TBoigAHlkCHEemXcLM0AAAAAP5xiZCa/m2n2Vey2MgbfPQf5PorafQNr5PX41r8Vrbe/Q9tUb57qrvfUN1r7+RaC8v1LdwJ5Po9/LYm8/1bjfR9vk3eyxRoOpWLw2tup9M3OSd3Jr0+QaC8H1DdV88h0JD3HYmr03c1s/FvO7JvtPooy0fWrx4/X3V+mbkAAAAAAAAAAAAAAAAAAAAARYeceCQbAA9AkmvSJmMjAAAAAB8P4qT+uogL5XpLVe92kgbfPrP+J+cux9N3P09bscvQy8qjfPdVbj6FtaOfLtLb76Jthlmwy6+/kWh2W/a/R/qhrM+Jeb2YfbPSfuqPfL9LY72WwiTz/VkPcdia/TdzXD8Z89se+zehj/UYKzeJ1t1vpm5wrWYMr7+Xx+vxyXu5AAAAAAAAAAAAAAAAAAABHpjpxkAx0QZiWCrPj9gAAAAAA0MGtY/qUIK+U6O1PvNpJG67FIfmGllPe9qwvsO/wDmMS1+Ko/z3U3n+p7vXR8c8/dL6VuJK3fZ4OEpH8x00t+g7VhPX9/r8FM/m+nn/wBb35R3vZoT8n0V8fq28q74XWyDt883+o7ut/4x53Y/9n9FH+owVj8PrLJe02Oc7TP6GblBPlejIW47GbbPMAAAAAAAAAAAAAAAAAABh5hYPPMWMjJgPaAAAAAAABU0xotPrsMW6Lrd7JZ09V3upjkA+S6HidXhMfpO34/W44v0cUyek7nDxkC+T6PNyTp6rvev2OdfvI9DzMHCcPUd3Ju7lgXynR+Exej7fs9jnBnluj6efnIW4zxL5/qyLuOx4/X4Ypr8Uyek7ng9XH6ufn+qxvpY5D2/Y5OQAAAAAAAAAAAAAAAAAAeIRsAZGZ2cwAAAAAAAAOudgAA4OM6/B38tAA6eOfqu1zo6/CcUd3JR1+E4o7uSgAAAAAAAAAAAAAAAAAAAAAAAAADEzzDID3wAAAAAAAACth5JZLDxjnS4Mi7nPO9pmxvp48R1+P3u1z9ns8vOwzD9dilHedjDtdi6WOex2OWRdzJ5HX4Yn0Mfvdrn73b59LFPA6nD1uxy6WLjmuzzRppev6WblluwyxVoetJu77Hl4OOJ9DHn+2zfJO5k5eZh49bhMo7uT9UAAAAAAAAAAAAAAAAAAAAAAAAAAAAAB0SEyXDq9LF7vZydvJcN1+HLu/m5KHW4TwOrjyLt5MV6WPMO/lAwzX4cv7+bkoYbr8OX9/N+6xbpYvf7WTy8HHuZL6Wblhuvw5lsM3Uxzxevw9/tc+KOzyvRx8e/l5fQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADEjJzo4ePfyXl5Xx8HDuc+X5TjjvZL5+Kejl5eTg4d3Jy4pOW3p8OPr5+f0/MeTg4ev2Of08vDx7uS8HGctvZ53x8HD2M/Pi4zpY56WbkAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAOsdA7HGd639VxSIV8jkt4eM7HO8HGclvHJyW/E/Mfu38SfaR+reHjOzzvX4z9H6t4eM5+V45PpzcqAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAPxJ+rfoB8Pp8PzJ+7R8PoAPh9APh9AB8PoPh9AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAPkn235ItA+gA+SfbQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAB/9oACAECAAEFAP8ABadc6518PdfRdc6//JQfoRwPBXT0Afog8Eh2D2B2j6Lr6IPRj4CDvh2h6UPQD6IPXAdg4HcHvB3R7gdwO+HeDB73X1eP6Ae4HdHuB3A74egDudPWA+gD0A9wO6PaPdD0I9geAx/SdO708Fdf0yrhJLEZVqup4Z/cpRw++jnckpeVYKtCTblJ6E21Rq75y8R7bDBN1U6j994ZjI0yT3Lf99A/Yu0AXRrzM7Vl2zIdWVQ++8Bj+ouTMxVoH7HJGRSYpISkrKC7ezEYETLJyKUx9lUPvsmZ9KOBA849KeekIxVs5I4TePEmiZJ9/IncFnGydcm1pHH79FkkjMScmZwacZlhbMm9MqYxSSFnkEBjrA6XQevZ5EIi2goKsvIuwcTUwxPCTJJJL1cP6i4vVDLwP2OWd8Zy8ZvGLZGWfs1mdSXFN9MfZVD75ZUEiMVSvZD91Z5bnTZdvSlxMjaX5nLuMYlZNzFAwV+KMwJaH5nLyOaFat8n2oM30W7F01vGVL7DH6ZUHuWNEqrClmH6v1p0zp+ht/30D9jj/wBjwKxHDn8XjsawLJqpMfZVD76YARZQDZFy8/i8dn8XjsYxbZlj03leAICHZI9SuwEBDLiIfW1kglj7xlS+wyX+/wAnvsaX94IgABKAcqKoKpvX6TQPAVtOUz6vKFOxy2RhkHEBZETpEOU4fEL5powAyqIgD45AOV22WiXcdPtXhQHrhVCny1xhm7iv2JFRIpwMBVkzGtkWZFeuyhHjZRQqZVyqTUggiVFO8CHWoj1Y5Lj/AOfk8P8A4FMMAPbGJwj2wkFIA6ZIJnfnh3gumvqvp+lko0j4n8LZ4jUmyJsVSIqV1TGygp0ggDHQbVgMhXEHyv8ADGeMmgNUnseg9ItSUhFCkolFlHoMiLIkWI6pjc4pUhMBYRTZiCqRFSr1BHzjVTq4yj0GRFU/iENTmhha1Zu2UkGBXqf8LZ5GRCcfkjXkX6gUxmGNWhUEUYoEMUZeYzFkDRJCFKiUpfKHgQxykwq6Zu8dYhMIqQ/adQpMKsmbtOoUmFWIbweu3IsC7QEzN49MS46XEmJsjLYEWniLb4QumZDg3aFUOkkVMrpcxhSjfNgRiWIpCmDtcS4kxMtgRaWIoinjpcSAgxBTDxyQg3WOkYxQMDpkRMWbMggsiVUqjYCmQakRx20IcGzQqhjACCRGxAAyJDCkAIg3bE8gB08Ark6mSDoXFCeYwB0DsUDqVAnQxx6AkkHm7VCeYxQ6B2KF8xgDoGLk6mTHqVyXriAdC4oTqbFQ6lbk6GMUDAAmAA9ypBNgB08BHDqJfdhi+3yDgkHC9epvcQOgiHUCl9vkHBKIYTrhi+3sAeuGL7ew4dRIHQFA64QOgYYvtw3uTDoPgY2B2CHXAHBHADpg4AdghnXB9uAHTBDrgezOuFwQ64A9M6507B9uB7M650zrgj1wA8L9P8JD/9oACAEDAAEFAP8AKNGOBcKuQw+GfjLHV+G6xZddIyYOTlU+pIVkodQva7bEMDD5vhlFESqY/wDmtflKF8xWiYkT7XHy2HzfDcgmIGa/KxVYqRSrLrYoo4RxBcFiuPlsPm44dFRwouVAF0qiYhwOCihUwB0qqJwckBo5MriqpUylcLLCcXKYN3gKCYRAFXqpcRdHMVRR0XG7/rhl1VMM5cJi2cAsHgaQUHzNflY9UE6iaiRCrqpmTYG6KuPlsPmmN5QTMCivx08fnIYkcbqV6qJ1EUgTIIdcaICkD1UTqJEAhMdE+Gqgp5ySWMPlYqAFUx2UDJRw/wDZ4Gf/ADWvysV+Z9Ejn0SOEapkFx8th81x8tqQp1Pokc+iRxJEieKexTtV9inZIfMZh0SksYfKxx83HXyo75mfH6gU3mBRUqfgN+ICq0EBSx8iJTtXhRKAgOdQ6uB6JsPmiHUFCGQURdEUDAEBx8iJTtXZRKA9cAwCL5ASmaLAoQRAAMAuVSlAoSWMB/6scfNx18qOH/sd9fhE6eXFQFUW6nnJ4AWRBUP25PCsCFHDFAwHjiDgRoYi2IlirQqg/tyeJk8hVEiqAaNLhY4oYmkVMDFAwHjiDhY0MSQIlhigYDMC9foRNiaRUwMHUBj0xwjIhBVSBQP25PEW4JYs0KqP7cnhEwKUqHlwU+opp/DKVuBQD2eBREAzzB3hMAYAgPaIgGAYB7REAwDAPg8xQNhidBKmHYc3TAIJs+EGFL0w5AHCk6iAdMOYRwEuufCDCh0w5umAmJs+EGFL0w5umFT64KQYUwhg+3DkAMIQMMUBwS9BKQC4cgDhCdRH/iAEDPKA4H/HClDp4BOHtL7sH39o+4ge0fcUPb2j7w7R9/YcPaX3HwvuwQ9uG9xPeIdc9vYYOvgMQwOwQzpnTAwcAMHADOmCGBgh3BDtHAw2B2CHYOFDwOPaPaHow9IH+F4//9oACAEBAAEFAP8ABZzk9D1qNsnKduks05T3Ii8Typra4RO89XzBo2YiJlHwyYxSFlNiV6POXa7Tzs9j1lyCM9COEtrbIf7DsPcTVURUitr7HhTRHJy/MQiuVcCqWJ3vq6WPGTsJNpeFLvcFpZz23l4ZlV/REOdM8Xf9rV1HT+yP9jVv00lKxcM1j5ONlm3gG5SJoyudzYSPxar3qppHYNuY3XVdzoSfZxzqMdZbksgg4R13ENafvYR6BbLdYLbN8crPN2Olej5LzLx7f+Lku7QuPgHZ0kzCvhItRwjhBTtnmwvITNZ63k9kzcrxYroxchHvIp/muoJCy3khCJkm4dhYIm0117U7DnFFh5GGUuSCV5LZZOPmvrLLV2uQ1UifR8iPypxl/I/gCcm1F1LK3+pguwiqieEkHRcLKm6PUAavOLVhaMpzOTlKBhLZx0Y/V7R7OUFL+IjnGZh9JrlZVNBLj/KqPtvGMUhbbcJq3z/He3S1opd8m3FcphLDOpzFu5GqsatNWexWNWGslgrq2ktyK3wuW22wtJhLbyJvk67S2TsJFWg8krDGO97SLGX2Lxl/I+bM2hC62jLVuTYFsWVVVXUgNh3asLal3uzuy+blsM7NbA443R3ZKpnJa/ykSapW+cpcxFSTaZizGKUuxLrJXS26An5uw683FuRDXiU/f7naFU1FEVK1tvYNVV1XtSN2VGeqplyZpHYskRdE5DJn7lrQBCfg5l/XpirWJjbK/eKs2udVesnUc84rMfiWrNX39K7t7HBM7NBTcQ9gJfSjD9u1ds2T/Z9fcc1CE2i5+3zir/WNv/jLNJakS2E8T1brlJnuzX7LX9t1vKrQt9zkPcV7DeavWpS3Ttf4368jGWz+ObBjF5xl/I7t0gxa3i2PrtZ9LamDYr9rq3XLNrunRUVFRKKyzZbVtw/nFJ5NVr9runHGw/s+xM27YP5JsUxDkHjrYAmdc7dsH8a10UpjG15WwqVK2w+dSGyeM8HT5aVdsGMg23PpB1XXnG+p2htdPVVnARjeywNxbTXcv6Akkc4y3r6KSzkrSghrLxSY+SLfOismWmrwenXzOT1L+lkamwCLq3JOT+h1poH8tuft84q/1jb/AOMs46tiIatzlimUFK0IlseWN0Z9YeKkQirJdmy4lvBX7jL+R9xPFGOsc0DHIsNWY8aIP2jpAzV1xTeHPBchqz+/67g5VeCmbTaW0PRkk13bjf1FRqJ+Llg+js3KmweRppis/wAp2Jm+tOSrqUSVcM14HfGzYHK1yoQUPWrVX7fHeqptIVorsvCAJTPc2AgBmOR793Fv6PbGl2q+yKgneadxsjFI3Xuynv7fr7NHXX+ZUW21lhca9nK2UEE9Bj0205+3zir/AFjb/wCMs4+fijOWWVv+xZbGJ4u08U5ZJN/2bPk0JjYXGX8j7aj1ZTW2cepdCT1hkrJN4eLXWO4W4rRyqNaeNEH7OxwriuT9j2B9foHSVf8A5DsrkNXv3zW+u7B/F7vvCw/yLZXFms/TxeTu29d1uVsGu6BekZ7ixBuMvGvbLr1/rS5yFItvqpdMFkRDp2bAbiKXctyArwHZxsvf7JYcZsWkelyAe/R6rzQ11Go3ns5KSoSGyOPEes92m5+3zir/AFjb/wCMs4+fijOWWVv+xZySpa8NbKtZpWnzte5I69k2WyeSEYtGCUxc4y/kdVJNZPZ1Fd0C16r2hI61l2vIfVbhruDewXNlGxr6Yf0GpoUipZybrX7XchOcScVa/wBCykc3l4yUj14mSEVnK1BrhalTc2JFv4e86U3ixrMenszXajfkDs+u3QaLX3Not3quSSFGQy5oAtBdx+h9Ux7Gzhdm41ndUL5UM5SyxG1RwB6ZqbeEBYIaz7coNXYTkrKXKy6E1e9o8WIAIW/TF5r8/o2hyNEp9rgy2atL6g2ShL67q6lMpecgNeS94gNY6gucrbcsVdiLVEXLjldINyjrTYa62veNcs7c761JOLS/HTWljr8pl0o9fvkRbOOF5hFldb7CRUgdDbMnVdYabgtdE7NvUE2wqglqjZC0hrinp0Wn5vXT9iVs2m9NWZ7aezZ+oYPZCE9oTZcIt/rvYGQeg9mzK2rtQwut0PVdkS+HKZLIC6jO7KIA1kuzWGzpXWssryioZWmx9hymx53tpGvLPf3+udRVjXaHp30vFRZY291CYlPAFsS6H7HqANXvcuSAoz/eABEdY8d5OeGIh4uBj++F027O7E/jvInLjsDcdImYBDf1jhrInv8ArEJpCzWm2wXbtzV9Zkozj4HXYfgCzpCeO7LagKE93NgoAV33avUp+5SmsdFwFGD0NJprmLvuchPyFqv8dz0WSbhNQ115WaJ27GKB6Fx7/IXgCYSBaM7L838r3uX1AVIruay0TP3gKzVYCnxnot1by1lx6pF3/wDc5U225LByK1fvq/6r/HeW+3w1Kh4u77h2SpP2XeWuCUC/RV/iNh/0Pj3+Qs2PtaIoCca55BW9q42nsvXMxDTEfPxdiscPVYpvtbZF/fyyPIOuRuntmT1/NabXC06Jjth7X2Q4mFeQtTba23XHXJw+VcoMrbuzZcGrT9tXGbrllsnIqJT19v8AI+Wf3/Z1pJK7K3fTHus9jM9hRXqs5QOU5DJny+IeeM7kzHhKRq6CzZbIeFlrBIaw48xdeH0n/un3ItO7F48/+nisl11N8cKTpLYmq/x3m7rMvYr1XrHryuwl/tdJlqToCVWY7C2H/Q+Pf5CkXqMZH1l81uGzP55Rs5BTlXnKzxqlVnEJvO2OLDc6VWGlQrSySa6WpKK8ozDeFpcWC71CBQrNZzbEIWp7Do08az1Hk6AddAfjoQAQtLNvC38AAA3HHNZHXXG1VQLn6sl0vgyeWduLmC7kbFPZZdtpmAsSDTjJrpBWuVGtVFr6QRAocwtq/wC3uUnG/bbfe2iuQn5C1X+O8tQFSvBdI6tMH+kNX5B6sodblNh/0Pj3+QtiFUPQ9UQ0HYbx/pDV+f6Q1flYo9XpuWVQW16IcihOy3AdG6JnIqTORZiGvulW6rbWfJ3NAfjrNhfkbNqfjvjd/eVFCJELeUXTWNfoykdZLXD1RP1RZ0gJJYskRdKSj14t52QVQdyWQFPRaoJpppE9Nyy5c7q5O7e13qyxbnuPGTQkPxo0vv1y3c7C1G7buteZvukuoay6p3JBPIZBy3dJ/VtfqNkKkRoPH5QhNhuW6LtvPQ03q660/a9QtzQpgMCDtq6zfFKdQdn1NuGEfQyK6DlJKSjlnW/KO6iLDp+7srZVXjxpHtZRKS3FsyMjm0RG8nTkE/H1QD68zYJy/wCxQEBDapgLrvjiqRO97hM9LraGMzNDkIUhbc0eXd5ruwns9P8AU9sSESdkhFMJRI1CixNB0mPKvGQjaPD9BrHhdpHT90438HaFxYvFypjK7MP/AM3UbI7QFUiXePmDKTaTnHGrvlWnGRmRWn6wqFJUtunoC5yocb6OA1yBTrUTZqnAW9hI8Z4lVWM40wiB6zU4CoMZCPYyrOb431p6sw4zRqatUodXpaT1izkmknx6gxem0S+lDVmpwFQYPmoPmS3HSmOVYLRdZrklbqo1uEZ/+bqNlK19HUULhqOCu0mTjhSSGhIFvCwcdRUIUryti5cVmtpVeJjdbt4psin8FH1NYGxnMb2xdfXeY3boNUv0QO2pnHdXdNWpUpWLXN3V5GPamQfMnXau7aNQQko5ybsXdtWoISUc6N62f1giyhKtICMfXmjM36Nu2f0W70T4NDsr6Pjp5rK19Fi7iKlGnQyelVmpWVYcyxy0aKAI2FLFqT1cYPCREA3fPGLFtHNp6VdOVGNKFchaREFGPZHYpT0qu2BjV3EqYtGiQLGxikcM9KKtCRVWTf46psMqnEyL2NcKpJrpT1aZMD12tsDpyUY0lUHcKkg8ioNhDhYYBg7Thq82fu1yJwsO1hGJE1Y1iudiVKISh4NiZiUpSF9eyMazlWriIUaErLAY2El24KO2BfIzx2gK7tJMqSfY8L5msQ3BN24MJUGDIpnfa7QFZ0kmVFPseIis6TICSeSzUpnjIwmaTaPxciSfDZ47beZ5j8vnZwyHwnThEjhEhnCaZPP5HzQ7gClApfX8uxAXqKxFknafmVQDyo4qh0V+mUwzdUpW/wAUVVg6pNE/KsoXzppIj8T6ZXFUlUytPPiqPlVAeoYU4HxVDoqA9Qx2QDrNyeRF6Tz40L5UcVSAVsXDqizT8ivgRyh8coszFMVuKZiB0LiifnwhugHN1Kkn5cN7SpF6Gw6fQwHDFP8AnhCeQqiYHwgiQBOHRIOmKJgfCG8oCcMKkJh9wKf88J1KUVMBMTD5xDDmEwJE8vgcwdRD3dnQM6B2D7ih0Hs6BnTudA7nQO70Dt6B4G/++vcDuh/gxf/aAAgBAgIGPwD+KNPOQjmQO1fpU6glK2627bd15cmp/TUagDSkziLARJ/4kr9+n0D/ANa/SqVQSwNkYtbnEKNWNeDSDhwH/sUqsq0CI3sA/XAKdSvLi8zCwC4W3Aa/gqfU2iYi9hsLDEHuZD2nk19RXkG4i0cjaetujR+Ud6pe1Tpn70SOkKMJhpOSRv8ABvgreyXYvynu5ORr/dIEciLnztbJUvboNSochiTqCJ+mjGnDWbesgvuihUrGNSGwBh0CJD67n6+OFhF41fZqKreyXYV+U92jhbimbhq2nnahUjKFOJuBF43iZ6WQp/WREgcRY+0EMLNRAwuvUalMvGQcI1KpaI69g2ox+jpgRGJtbM+kZMSjVlVhIRDkAC7+SPapxqRHlAtG3Zbq+xGpVLDrJ1BH/wCWEYQH3jb1mzcIlGpKUagF4AHyxPQhSqDhqYapZajs60TEOQCwdnOAfB9a4ZURTe5wT0GwHbemhTNWq5ctwwjqBNg+y8o1JDhj/wARGQH9x6VwfVMNUhdkR2Nkyf6Kj5MJSYPtAJAbpQ/X64xY74gdRRLNON47xsPIcfTv5ABJttod1S9uiUH8sPKM/vHp7FGlGtTaIb1R344m1VYCrAkxLDiFpAcY60IC6YI6BxdyreyXYV+U9ylOV0QSd1qjU+pkBEycuWFloFuFwX71P+aPioGnUjKQlgQSxBe47AqlM3RII/M/yo0x6YWAbcT02blGlHAW7ZYnngiDcVUjLGZbbEek9qlB/LDyjP7x6exQpAXAPnienRIQsDiQ2Pb1F2VOqbyLcxYetUfz/wCKHuOicYiyMyw2PdoqcWAcZjmymMOA/wB0fHkP+Ud6pe3RU4/xyf8AmLr9v+qXzL9r+qXzIVaUGkLi8jeGxJFxVb2S7CvynuVZvwS7FGlWDxL4kWsTg2pftf1S+Zftf1S+ZS/Rjw8TPaTc7Xk6yqhlhUL/AMxTjTV4vxy7SnGgewdpVJ9p6ZFUPz/4oe46KvvPboq+1T/8Z/uinNyM6dOc4D7wAAOXFKJO4HYozF0gDbtDqJqH1SERvxyGPIMsXaIVJi7DQa8R5J9Usem/pUaVeQjOIZzcQLrcDrdPEgjYuFw+rFVn/AexB/wlGJuIZbYl4nWMPt3hDzCMsYksd2vdo8pBZGsB5J25SxG+9Ro15CM4hnNgkBdbrzvTxLhcIkDLU9vQj9REeSd+yX235uoxfzwDEY2WA7+1GUyABeSpfpCwm/VEWOe3Mso043RAA3KiPd/ihskdFX3nt0VfapbYHtiqvBew6HD9TqHB6WDZNYmCrRFOUoiPBEgxYTslI+aUTeIiwYFQmfUzS9wsPjyBEJylED8JZ87C69dTpj8qEoVKgI1SA/x0GEwDE3gomlMw2eodx615qxI2RbvK4qcXl+I2nwG4I1Kk524AjhFjWAgsvXU6Y/KhTEpSAxkXPTYuCtFxhrGRX+uqQNoEuwxX+ypKWQEfmXBRiwx1nMowmAYm8FE0pmGz1Adh6156pI2AR7TLsTUosTebyd/MIwmAQbwVx0KkqZ6WytB6031H1M5jV/3GXYuCjFhjrOZRi5DghxYQ+IOvUnM6hOY+VCpTqVAQQbxa2BaN2tfpylKId/KWfYbDYvXU6Y/KiITmQcJEEDIABcdSc8gRwhtQIKcTqdMflQouZAOPNaSDr7Mlw0qk4x/CCCBlxRkRuIQIqTiwIsNluJ4gXkMCV+nGUpByXLPbabgMbbXVSMatT/YXNsQ0iX4otEMcLLGwuQHIXzEBMJA7x8XmkBmV5SDkdPmIGaYSB36fMQM00ZA7+R7STBCUtHDG9cRO9Wk9XgrJFtSM8UxuXDG5cMSw7U8iyvPV4JnJzXDG9cRO9Xnq8F6iRtXDG9cdS11YGK4J2jsRBuKHDihM3umkiBrXlRnimlcmhgvMHOs2pyHsZGIjYLcLunciSPV2auQY0EphpOgofASm0kptDoIaToK3JirlarOQ96v+K9X/AMHt/9oACAEDAgY/AP4o1aWTAueTRhE4nV4L1DnuXCZdnghISFvPUjIyFnPUiZF7fgM8Vu5NTkcbtG5RyRGtAG/4JZFbuTglgo5aHK8gAHPncnkxHPJOFLIrdoa8pwQBzzTVA6BFyeSamLFxGQLc9SLi5PJeQADWnJB55BcJsKsTGLKwPLqTmwbG+1NPpX+uNmsrzdg7ltHIfhwvUctBGAsQiJCzaFIcQu1ptalkVuRJTzNjr1DpCDEEuiNSbAIRGgg6+pEYBCOgtmhJR39y36CBgdBdHLw5D7lHLQX1ntV3WfFenrPinAt3qWRW5SyKAlcvT1nxXp6z4o8IZ0X19/wSzOnchzxUd/ct+iWeiWSOXeNDgEjnrIQOtB8S3IPco6OIXHtQjIsQrEylktyZZXK9jq0WLiwKEZFiNDPauMXHtQGITlHh5hADBR39y36JZ6JZI5eCkyDXaJBiQzC6/G85IHHkCxJGSvPV4JwTz3aGNy8pZWy6k4Fqckq89XgmcnNNIKyStLpohMbl5S3WrZLyhMU8SQvPMnnvTRCZXnnuTgnnuTEkZK89XgrCd6ckq89XguG/NNEkDV/1CvITAlECRty8OQ9/J63Q+iz4H02K3Sw+CxOdDHRYnVul9Fmlv4VB/9oACAEBAQY/AP8AgLOfL53IQ43H2/8AhLiY0BJ5KoFSzGnBQCT3akg6U6bN3EhomRyUhjDU7xBHU0PdVwfRrdfdP4a4tu+GBbiGT+O00o/udUzfTGRxrk0Bs5IrtaeJL+7kfEDqOKPqiKxnddxiv4pbUL6DLIgir/D17ziMpZ5W3PDz7OeOdP40bMP3NMzMFVQSzE0AA5knTxQySZKZeB92AMYP84xAP8GugGw0wjrxYSqTT1bR8+vy009g1aATxE1+OLePu6lmgy1pLHDGZZisqVRFFSzCtQAB36nnEzx9P2Ejx4HH8Qqxg0851+/kpU15fR7vgpLDI0UsZDRyISrKRyII4jW6x6yybCgAjupfe0AHglyJVHxDUEeTs8Xm4o+E8skLwTyCn30LiNTX/k/i03250pf2DA+wbGaK7DCnM+b7tTj3cdJEvUq4+dxXyr6Ga3A9crJ5Q/j687DZiyy0PLzbO4jnXhz4xs37lZcZYTFMVbsUdkP+kMp4sSOag8h8fhTtybRttknVbdT6JWCsP4tf2NZI2KSIQyOpoQRxBBHIjUeQtc/nI7Ci+XJeGW4taV9kKLgPGK+jT3d5HFBncXKLfMW8QIQlgTHKgJJCuAeFeYbu/Z2vsvkrXFWSsEa7vJkgiDNwUF5Cq1Pdx0t7ishbZOzckJd2kqTREjmA8ZIP3f3BZK4jbbNIgghI4EGUhCQfEAk/Bv2AJMDwyAD+cVT8jfDiyljjIrDHXKh7W7yEnkCVTxDIgDOVPcdtD3HUdznccrY6ZgiZS0fzrfeeSM1AyE924CvdXtu7/K2qXlp07aC5ht5F3Rm5kcLEXB4EKAzAHvAPdqS2uIUnt5lKSwSKGRlIoVZTUEEdx1150xiF93wt3h0v4bMHhGxe3dVHoQzOF8BokAsQOAHM/d1c5jOX08l0Zna3t2ZglqK8I4U4BAtAOAqaVPHjq8jzVzLfNhb9rOyvpiWdofKSQRs54sULcyeRA7v2RMRJOTY4WxhFtbD6KyXA8yR6ffMCor4AazGFEze4ZDFvcPb1O3z4JYgj05V2uw/cEYluA8kd1E0qJ7VBRhxpw5ka4uV9an97Q2SqSeQrx+525a2VQzzWkyxqfv8AYdvy07JMbaTrYWFjGJstk2UuIkY0VVWo3O5BoKjkT3anGF6gySZpYybd7wwvbO4HBWSOJHUHlXcac6Hlq8xmQt2tb6wmeC7t3+kkkZKsD8Y7Ol8JdR+baXt/F77CSRvgjPmSrUeKKRpI40EccYCoiigUDgAAOQGsjhMnCJ7DJwPBcxnntYcwe4qeIPceOst07kB/ScVcNCXpQSJzjkA8HQhh6D2dZ5Mr/pFxZ2qN4eSsrsB6/MFezre5BqsNpc2Y8B7n7tbkfdjPZNmJI7/E3F1I017DjpkjhmkYgszJJHJtqeezbzOrXCYGyWxx1qDsiBLMzMas7salmY8yfm/ZM1/VrL/V01N+h7r85D+4F7S0cpboSskinjIe/j4fPrJR1psi82v80RJ/J7fYkZPUSNcXDgdzAfvUOqSQhvEqafIa6u7UEkW00kQJ5+wxXj9zXUPTdwVjuc3BDc2DmgLtZ+ZvjrzJ2SFgPBW7Mf1tZQ7bfM0s8uVHBbqJfyTn0yRqR/A9PZjJ6V+zLO8ufVWIwf8AW9uL67s4/ag243NBR9RiWt5TTwYlCT4qO7sluitDlMtczhu8qiRwgVoOAMZ1LPM4jihRnlc8lVRUk+oau76RQZM1bZGWX8EyuJz8oppnY0VQSx9A1d57JXs0kss7SWMRc7baOvsRxAGihQBy5niePHVzDmrl767wV6bSG9lJaR4DGrxh2PFipJFT3U11NnLMgXmOx88tmzCoWbaRGxHeAxBpr/5AuYuxm/N845XznM5etalyan49dP2/T4guOrsnjbe4zN6QHgspXQblVOTOTUgHgopWvLTTZ7N3uWdmD7bmZ3RSKgbUJ2rSppQDnpZ8Fmr3EyK28+6zPGrHh9JQdrVpxBGpun+oRHH1NZRGaK6jUJHeQqQGbYOCutRUDgRxAFCBq5z2duDDaQEJHEgDSzSt9GKJSRuY0+IVJoATqQYS5XpfFq35C2tVV52UHgZZ5FJJ/ECj0HnqOZOuc8zxsGUSZC4kWo8UdypHoI1b2PW9M5iHKxvk441S7gHIOQgVZQO8Ebu/cTwN/k8ZdR3thfWVhNaXURqro1slCP3x3am/Q91+ch7I57xTf5i9DfZeGjYK0m3m8jUOxAeBNDXkAeNJTdZ6fGWLn2MXjWa2hVe5SUO9x+Ox1JNPI000rF5ZXJZmY8SSTxJOo5cN1Lf2yxhQLV5WltyFoAGhk3RmgFBw4d2oun+o4ocT1I4pZyxki3vCBxCBiSkn4JJB7j3dnUttl7mVrfEZCezxdizHyooInKxlE5AuoDE8zXV7h8pdveZHpu4VEmmcvI1rOC0W4txO1ldePdQdmJ6Pwt/LYNewG+zM1u5SRoi5SGLetCASjFgDx4d3O2zGDvJLeSGRGubUMRDcIp4xzIDRlIJHHlzFDrHZazbfaZO2iurZvFJkDr8h0WYhVUVZjwAA5knWTzM97LJaR3Mi4OHe2y3tkakQjHAKSFDMQBVuOre4zlxJeT2V7PZ2l7Md0ksEaoVLsSSxUsVqePDUWJxMMV/1RfReakclTFaxGoWWUAgsWIO1ajxPCm6WXN9SX14soZWtRKY7cK/0lWCPbGARwNF46SWJ2iliYPHIhKsrKaggjiCDqNsf1HdXVsh442/drq3YVJI2SElak1JQqfTqZlgGOzuNCjK4vduWjcBLExoSjEcjxU8D3E/tVcyoaSMAiHwLGlfiHZLDIKpMjI48QwodMjja6Eqy+BHA/ByCqu1ZGWVfTvUMT90nWNzmMl8m/wAXcJcWz925DXaw71YcCO8cNYnqHHNW2ylusoStTG/KSNqd6MCp9I1menLjapyFuRaTMKiK4T24ZOHH2XAJpzFRq7x97C1veWMz293A30kkjYq6n1EU11JkqcLTFLb18DcTo/8A1PZ1HA7r9oYDMXdvKg+tayTyNauOJ4bBs581OstgMgK2mWtnt5WAqULD2XWvejUYekayWEyEfl3uLuJLa4XjTdGxFRXmDzB7xrpCClDNavdMe8+8zSTD5HGusL8MVkjxVxFC45iSdDDGfiZxrGK7qrS2d4sSkgFmERag8TQE/Fq4/m3+Y9nU/wClI/zK66z/AEc/zr2XeVzbyRdM4mQRSxxHa91cEBvJD/VVVILkceIA51AsV6IwxhVdgd7SJ5qE14zsDIT6d1dLa4hXTCZa2W7xsTsXMPtFJIt7cW2sKgmpoRUk8ddI5CFyhjyltHMVNCYppBFKvxo5HZc4WKYnFdLf0SCEH2WuSAbiQjxDex/B9Osf0/h4hLfZCTarNUJGg4vI5ANFRQSf7ekizdtcdSX5UefdzXE1um7v8uO3eOg/GLH06vM/0I86vYo0910/O5lDxKCWNvI3t7lHHaxO7uNeB1N+h7r85Dq5vbqQRW1nE89xKeSxxqWZj6gNZTqG9Zv6ZKRZ27Goht1NIogKkDavOnM1Pfq6yGWkkt+msQ6pdeUdslzMRuEKtx2gChc86EAcTULZw9E4Z4VXaHntI55aUpxmlDyE+ktXV11d0VbNZx2AMuZwgYvEIebTw7iWXZzZa028RSlDFcW8rQzwOskEyEqyOpqrKRxBBFQdYfOSke/7Da5ZRwpcwey5p3B+DgeDas+oIY9tt1LaAysBw95taRv/ANGYz93UOOlk223UdpLZsDSnmoPOiJ9PsFR+N2dUZBHEltDdmysyDVfKtAIQV9DFC3x6AdShIDAMKVBFQfURq0spJA9z09cy2Ei/WEZPmxE+ja+0erXVGQR9lzNaGysyPpebdkQgr6VDlvi0FUFmY0VRxJJ5ADXTuBKBJ7O0Rr4f/cy1ln/u2IHo11pNdkmSLK3FtHU1pFbN5MVPRsQazk+bhtb/AD1ksLYawuwrqIju82aON6hmUhRWns/Hp7K/soL2zkG2S0uI1kiYUpQowIIp6NN1D0bjprvp+8b+l423VpZLKUn6qirGJu4/VPA8Kanzk+Mu8diLSxmt7u5uI3hWV5dhSJQwG4ggMe4UFeY/asU5CZC3qoe3JxHvnaQU8JPbA+43wbO5+rNb7PjjYk/Iw7LzoS/lpbZQteYVmP0blF/KxCv36LuHpU97dlr1ZZQlLDqUbb7aPZS9iABPo8xKN6SGOusckV/0m6tLZW/mEkcj/pRq8vX+haQSTNXwjUsfm1Y3l5cbMXmm9xzbOfZCTMNsrdw8uSjE/e7vHsxvXFnF+RyYFjmSo4CeNawyH8dAV/gjx103jQu37PxdnbkemKFFPj4amtN1Dmsja2m3vIQtcn5YRrpP/wDP/wBQuNXH82/zHs6n/Skf5lddZ/o5/nXsxEqgA3l1ezSekidovmQdnQcoHtuuTVj6FNqR/fHXT5HAjJWhB/55ezPXrsWe8yN1OzHvMkrMT8uurc5JGDNY29rZ2shHIXDSPJQ/80vb1Zi7RQlrb5KZraMCgSOU+YqD0KGoNTfoe6/OQ66zmjO1nx5tyfwbh1hYfGHPZ088agS5Frq7unH1nad0BPqRFHxdl1Y3KeZbXkLwXEf3ySKVYfGDq5tWNWtpXiY8qlGKnh8WurceWJS1v7e4VO4GeJkJ+PyRq8vYY99503MmRiI5mIVjnFfAI24/i6xOata+8Ym7hu4gDSrQuHofQaUOsv1bbSq0MOLa9x0h5O8sdbcfwmZR8eo4Ylae5uZAkaDizu5oB6SSddDTWiAQPho8XdSKOD3FgFDSMfF1kH3NZzpyWQrFmrNbm2Q8jPaNyHgTHIx/g+rXTHS0T8biWTJ3qD72MGGH7paT7mun7SSPzLPHy/aV+O7yrWjgH0NJtX4+y7656WtHyEd2ofO4uEFpkkRQpnjQcXVgBuAFQePEE0SWGSS1ubdqpKhKSIw7wRQgjUafb32zbR0/o2UjW53UK85fZmNQKfT7z38dRQdW9Nm3DUEuRxb71BoBX3eUggVqeEhNO4kcVynTuTiydoTtkMZIeN6V2SRsAyNTuYftXeKOaoH/AIhDH5B2rKBQXNujs3iykp8yj4Nhc09qGcxg+iRan+8HZZZOwmNve4+eO4tJ15pJEwZWHqI1ieo7QBPfoqXVuDXyZ0O2WM9/BgaeIoe/WY6fIUXc0fnYuVqexdQ+1EankGI2sfvSdXDTxNDPeZm7klRxRgYljgKmoHIxH46660ugdrLhryONvB5YmjU8jyLDssfeJC+WwAXHZPcas/lKPKlJPE70pU/fBtZLp3JD+jZGML5gFTHIjB43HEfRZQeYryr2dHYVH4M13e3CfiiOOI/K+ukiPG9H3bG4Grj+bf5j2dT/AKUj/MrrrP8ARz/OvZ05/OX3+uTdnQP/AKr/ANz1gP0ja/nl7OpMdIux7HKXcDL/ADczLw9HDhrq7Bu4E13Ba3tsneVgZ45PzqdvV+QtXElvLkpkhkHJliPlBh6DtqNTfoe6/OQ66xtIVLy/Z0k6ItST7uRNQAVqTs7MRbI4a4ws9zZXajubzWmTh+JKvZkctdsEtcZbS3VwxNPYhQu3H1DU1xJTzJ3aR6cqsan59dTZR0Kx3+RjgiYgjd7tFuJHiKy01d2F0gktr2GSC5jP1o5FKsPjB1mMDdA+dibuW2Zj9YRsQr+phQj166S6eE+6/lyD42+SvO3xlJUWnoEkH3NdOQum+2xkxyd2aVAW0HmJUeBk2L8er+6jTfc9PXEWRipz2KTFKK+ASQsfVrpnOM5jgs76NbxwaUt5vyU3/Ru2uoZUkElripFxdpSpAW1G2SlfGXeeGuoOrJ46SZGZcdYMeYig9uUj0M7KP4PY+EzPU0Nrk4iont0inmEZbksjwxuiHxDEEd+o77KYOzyDXcQkt8xbHypnSQBkcTwlS4oaipI+7qSXpvqS7xrklktb6NLmPiT7IdPKZQKihO48ONa6hseobaMLdqz2N/bv5lvOqEBtjEKaioqGAPEcKEaxeTtLho7OaeODMWtaJNbOwDhhyqoO5T3H9q5oW+jKjIfUwpqh4Ecx2Y26A9lHkic+lwGX+9Pwb7au5otkq+ja43H+LXtn6QyE5XG9SEPjtx9mO+QUAHh5qDb6wo7JIbK3S3jlnmuZEQUDS3EjSyufSzsSddRKDR717S2Q/jXMbN/cqey0trqbysP1Jtx+Q3H2VkY/0eU/iudtTyVmPa9krVXCY22tGWvDfJuuSfXSYD4tYWeJSY8Vb3l1cnwQ27wA/wAeVdXH82/zHs6n/Skf5lddZ/o5/nXs6c/nL7/XJuzoH/1X/uesB+kbX88vYvVdvCfsrqZVE0q8o7yJArqfDeqhx4nd4asOoMNKI72wfcFapSRGFHjkAIqrA0PycdRy5ye46avwo94tZYJrmPf3+XJbo5ZfSyqfRq8w3QS3Et3eK0MnUEyGFIo2qpaBGo5cjkWC7efE8huBG4VWvePHU36HuvzkOpIZkWWKVSksbCqsrChBB5gjV/iHif7Mmdp8HdtUrLauaqNx5sn0W9IryI1LMsLZDCZEKmWxe/aTt+jLETUB1qefAjge4hbibOXFjMVqbGeyuTKDSu0mKOSOvdwempOmul4J7LAysDkb6eiTXew1EYRSdsdQDxNW4VA4g2eLxts95f38qw2ltGKs7uaAf2z3aw/TkJWSSyh3X1wvKW5kO+Z+PGhYmle6g7LHqGGPbb9SWg85gKD3m1pG9Ty4xlPl0sZYmNSWVK8AWoCQPE0GuqOqZEPExYuzenCgpNOK/wCT1kcVdKGtsnbS2twpANUmQo3A+g6yGLuhS5xtzLazilPbhco3A+kaqd89xO/E8Wd3Y/GSSTrp3p/aFlx9mgvKU43ElZJzw8ZGbs6rscmHN2uTuJTK9ayJM5ljkqeYdGDfHqLpLrCSSPFW7E4fMKrSe7q5qYZVUFigJJUgGnKm2lPeV64wYj2ltrX0CyUH/Js4evDlSusVgum3OQtsPPJPc5faUjeRl2COEMAWA41alDw21HHXT+EtojI17exefwqFhRt8zmncqAn9rLyMilJnKgeBNR8h7JnIJNrJHKtPHdsPyMfg3lty94gkjB9LKR2wXdrK0FzayLNbzoaMkiEMrA+IIrrGZxWUX233fMQLQeXdxACTgOQbg6/gkdmBwwfbPlMn7wU++itYmDf3cqdlRwI5HVniuqcrBiOpLCNYZZ72RYorwKKCVJHIXeae0pNa8RUcp7ufqKyyVzGha3xePnjuJ5W+qoWMsFr4tQayGWlge5ymevGkS0gVnYtI1I4Y1ALHaKKo58NXuZz8Ag6gziogtKhmtbVDuCMRUbnb2mHdRRzrogioPMau8fj+m8hmcbJO/wBlZGxge4jeEt7BkaMN5bAEAh6ca8xx09vmUWHMZe6a9u7YMG8lSipHExFQSApJp3mndrO9PtL5H2vZTWqT0qEeRCEYjvAah02G/wDiGRmnEhjS8ihZrRqV9oXNBEFIFeLD7usB01NKs1xjYG97kQkqZppGmlCk0JUO5A9HZirvAW/vuW6fnldbAMFaWC4VRLsLEAsDGpA7xWnGgOGuMr0/f4PD4u7iu8hd5CCS1LLCwk8uNZQrMXI21A4cz2XeDzlot5j7xaSRngysPoujc1ZTxBGppem4x1RiC1YDEyR3cak0AkicqGIrSqE150XuSBOh86ruaBpLC4jT43dFUfGdQZLr5lxuOjIcYKCQPczU47ZZEJSNT+CxbmPZ56suoekcJJkMUbKCynxeOi3yWzW42R7IIxuKFKD2QaUNe7WT6s6ix02IWWyNjjbC6Qxzv5jpI8jRtRkAEYUbhxqeHDsfEZ+1MiKS9neR0We2kIpvicg0PiCCD3g6lkwKRdUY4EmN4GWG5Ve7fDIwqfxGbUkT9DZ4tGxVimOuXUkcODJGVI9INNRhsCcLbOFLXmTdYAoah4x+1LWh5bOHI8dG+Mv2x1HPHsmy0iBViVvpJbpx2g95J3H0Dh2z4y08tczYSreYaSQ7VMqAq0bN3CRCR4VoTy0MavRWWW4L7PNe3dLevj7wwEVPTvprEdPblkuoIzNk514h7mU75SD3gE7V9AHZd9W9L4mfMWGY2yZCzs0Ms8NyAFYiFQXZXpuqoPGtacK43O9TYW4w2Fwky3fk38TQy3E0RrEixOA20OAzEilBTv7Y7l5DiuobSPy7PMRruDICSIpkqN61JpxqO7vBdY8GM3bCuy8xsiyq1K/4tisoNB3pr/YXqH/2y7/zWlSTBjDW5ID3mRlSJV5f4tS8h4GvBPl1LcrN9rdQ3kYjvMs6BAicCYoEqdq1FSSat39wH7Vu3/Hxo/ybf5PZkLdQGeW3kVAfvtp2/L8K/twu1YbiREWlPZDGnydstzbxfaGIvwqZXEs2wOFPsyI1DtdamhpQg0PoE0WKzUt2RwszDAoDfhSecRT0gH1aGWv4lsrW2j8jF4yNi6wRVqasQNzMeLNQV4DkB8A2eAst0EJHvuUnqlrbg/fyUNT4KoLHnSgOlntY/tTPyJtus9cKPM4jisKVIiU+ANT9Zjw/sAvk8naY5FXez3U0cIC1puq5HD06TC4nP2uTyTrI6wWpaVdsVN58xAUpx4e1x7q/uBspgPpB0ZvVQj5z23dsDUW80kQP4jFf3vg3TEUW4SOVPVtCn5VPwwAKk8ABq3zXWyzYbDEh4cOPYvLkDiPMqPyKH0+2fBeDatsVhrCHG460Xbb2kChUWvEnhzJPEk8SeJ4/sGc6N6f6lhtja5C/jtmuLW18qKC2kfaXcW0j8gAOBNSK6/28wX+Rj/8A52jg8t1dbXF2II5/MtLS1ePbJWgrJaRmvDw1js5Y9cYeK0ycImgjnghWQKe5gtgwB4dxOshnr3rTFXVpjUElxDa28LSlSwUlQ9gi8K1NW5ay+W6lyRyOy+FrYkwwwhRHGrvTyY0rUuOdeXwOpOtD71a5y1s2upHilrFM8EYVfMjcNT2VA9kr4+Ooj97j7o/3o/f/AHAhx/iZVZvUQV+cjtvfZ2rNslT07kFT/GB+Djrn600Txn/m2BH9/wDCjxHT2Pkvrp6NKw4RQpWhklkPBFHiefIVPDVvlcr5ee6oUBvfHWtvavz/AKMjDmD/AIxhu8AlSP2L9YfVF7amFcndCHDyNT24ZKSzOO+hfaPiPY/6Otv5eukv6gnznWXw8lNmUs57Uk93moVB+ImusXj8lbNZ5KSS4uL62em5HeVgoNPwAvwOsQeQw943D8GJiPm0n6Ouf5H7gb1D3RF/jT2h83bYXX/HQtHT+bav8v4NvOq1NvcDc3grqwPy0+Db5bLtJgOmH2ul0y/0m7Q8f6OjclI/xjCnGoD8dR4jp3GxY6zQ7pAnGSVzzeWQ1Z2PiTy4DgAP2OX9Yf61+oh030wl7BjorlYJrqae7udxjhhgt0kkdiqMxoOCqzHgDrpjpz9W/REOe/U817aWvVfXWakuMfeyR3EirPcWVvtPlR2ytu/LKWkoRtjFGOXvP1aZafMYSzsoo8Tnbi2ks4MstrtW8mx0dyI5porWWeOKWTywokYLU8DrpL+oJ857JcxmZSIwfLtbWOhlnlIqEjBI495J4Ac9XM/RtlYdM4SKTy48ncqJKMCDtLypJvanPZFQd/Gmo8r1DdY3qbDtIiTTxQp5UZNQFYxRW0i7q8CQRUD1FshYobS8tWEeTxjsGeFyKgggDcrfVagrx7wddY/oa9/MtpP0dc/yOyO18n7Uztym+3xqMFEaGoEkzUO0E8gBU/LqLL2d7iukbK4HmWlvcQoGkjam1trw3UgHhu2158qat8X+sLH22Zs5xvS+gVInlQMavDJGEjJWtCrIDy5VqbLMYq4FzYZCIS28o50PNWHcymoI7jw1PmM3draWUHsgni8jkHbHGo4szU4AevlXVxZ/q76dgsrC3NJMldgSNGCDtMjuREpPMKFY+sV1d5266oxGVtcbC9xd2EMERcxopZzT3OGu0CvB9Za3y+NtYvsiKFmyNrvQO8pYKrRsX4kITUMOXLwlzGcufItkISGJBulmkPERxJUbmNPUOZIGrkdC4qywGHgfyjlbsCTYxI+lJIGVmA47UjNO+vDUmWucpjep7O2QvdW9rBE2xBxLlFgtpCABx2k8DX0iLC5i2TDZ6Qf0baxNvcsOJWMtxVvBSTXuJ5au57K09/vIYJHtLHzBF50qqSkfmNULuNBU8uektbvpC36Ya4BMEl5FNMz7SpJikLJG1AwDUB592lixvTl11f1U9zKLi5WJbbH2qM35JJJQEUkA8qg04ltS5S9szirBFZpUsLexu44lU1LNT3l1AB5seXx6fHdde72BEbyW+bhVljOwFiksY3cSAdpXmaCleOmm/Vx0W0eHP+j5vJ+XE9wvdJCk8kSbT3fS+LUK9TMUElRFDd2Vt7vKVPELLbIm6n4L8j6tTziAWOWxxRMnYhtyjeDtkjJ47GoefEEU9J/atkbkwIPqOmRxRkJVh4EcD2W1wFq0FwFLeCupr8oHwbuxrtaZPyTHudSGWvoqOOpIJ42imibbJG3Agjst8VhcfNk8jdMFhtYFLMePFj3Ko5liQAOJIGrbN9ZiLNZtRvgxQG+ztm7iwI/LOPT7I7gSA37L+rT9Q2Kmd7Ho3HN1N1FBGSVlyeVJgs43TveC2iZlIHK4PxdN9W/rd/WF1p0j+uK/jhysFv0jeWtinT7uqyQ27PNaTyyXMVfyro6KGqqfR8x7rIYzPdWde9XXmDgsL/r/AK5zU+bzM1o0pm93M0gjjSMOoO2ONeXHXSX9QT5z2X2PEv8A+v6fb7Ps4i1EEi089z3Al6gnwUaxeEsusMBHb423SFduQtgGYCrufynNmJY+k66qsI+q8LdTzYu5a1to763d5Jo4zJEqKJCSxdRQDv1a2CORBmrS4t54/qkxRm4UkeI8s0PpPjrrH9DXv5ltJ+jrn+Rq+yVyaW+Pt5bmc+CRIXbn6Bqyy3WF9bW9le3z3uTmvZVjtwkStIkJaQgbfZWMCvLhr/bPBf8AuNt/nNYZ8TnsZlshaZQL5FndQzyLDLDJvYrG7ELuRAT6tdSYeRy8WMu4LiBTx2i6VwwHorDWnifTq5xEUjHG9OMbO3gBO1rj/HyFfvt3sepdYvB2saq9tErX0o5y3LgGWQnvq3LwFB3algmQSQzI0csbcQysKEH1jXUdrfIFe8y0psZA6v5lnEoWBztJoWqxoeI79X9gJScb06xsbOAH2RItPPcj74vVfUo1hcJbxiMWNrGs9BQtMw3SufSzkk9mVjxgNnBJJFkcd5Z2mIygOdlPo7ZA22nIAawGcloZ7+0U3ZXgPPjJjloO4b1PDXRBpxP2kCfV7rq0/rt1/fjRBFQeBB1m7S0iUWmPzUot4No2rGs5KptPAgDhoACgHAAa6jFzGHayhW7tXpxSWJwQR4VBKn0E6zEAYiKTCyu6dxZLm3Cn4gx/a29TxlLj+H7X7/ZkUHNIxKD/ADbBz8g+D5FnCXIp5kp4IgPezf8A0dCLIWRurgU83LhmhKU+qpU8R6DXQknuMxfDgWgluY1j4cwPLhR6H8bTWfTeGtsTDJTzjEpMklOXmSsWd6d24n9lLMQqqKsx4AAa/XL+tLBXb3eHm6nNt03mISWjayxSpYY+ZG4gCWK0WRfXr9V/62YVSObrPBQXOWgi/wAHFkYS1tkIk5+zHdRSIPQNP+jrb+XrpL+oJ857OoxfoXRM5d++JUgsBcvvFRx4iugy9MhlYVVhe3pBB7x+X1/sx/229/z+rXNYXBe5ZOy3+7XPvV1Jt8xGjb2ZJmU1ViOI11j+hr38y2k/R1z/ACNdYrFXf9j3hNPvRCxb5K6xWF6gtPfcffx3C+R5kkVZEheRDuiZG+r46/2Y/wC23v8An9f7Mf8Abb3/AD+r7/43i/s37S8r338vPNv8nfs/w0j0pvblTnrPzXIJaDPXT3AbiardMWr9zSSRsHRwGRxxBB4gjt6m94B8yPNXhmB5ki4cn7ukkjYPHIoZHHIgioI7LUKQWTEW6yAdx82Y8fiI10yk1Q0i3Mqqe5ZLqV1p6wQddEf+pf8AddWn9duv78dnVP6Zn/O9nVv9Qf5xrK/oKf8A1m108srrHHGpaSRiAqqBUkk8AANTZHDdO5nPYqBXf7UtI7eKGRUB3GEXdxbvKOBoUUg91eGrDJ26ulvkbaK6gSUbXCTIHUMKmhAPEV1i5MvK8a5a+isLbYASHlNN7VIoi82Pd4ftSHA/w0SsT4kEr8wHZLBKu6OZGSRfFWFCPuams7hSGjPsPSgde5h6D2pcXoe0s2oUWn5WSvLaDyHpPxajWWAWlqnFLReDN6XPP9/SxxIscaCioooB8X7P1B/uZ/7o1sbTEW8l7hv1m9fhxGLiK2ZrfJFr0b1tMbDUpJKPykx9hODBJZf90P8A3aMgOp+k8tl7fL/rI/Wtd2Pu0OQfFI0Qv5WAkltsZZmWT3WIt5k0km9/bkihh6R/U9hc3c9SQdNi5mvM7dxrC91d3txJdXEiwoWEab5CETcxCgAsxqTObeeOcQ2NvFKY2DbXG4lTStCKjhrpdYJ45Wt7MRTojhijK7KQwB4HhyPZL1PawM+Hz5DzSqCRDdgAOjeG+m8V5ncO7VhgOqMhHisvjYlt4b65YJBcRRjahMp9lXCgA7iK8weNAJrWeO5iJIEsTB1qOYqpI17p7zF70V3C23r5m3x2VrTXWDyMFU4m6QEkD2njKKOPiSBqBXcKZbC6SME03NRWoPTQE6uLS4TzLe6jeGeM/WRwVYfGDpFAZLjE3S3eHvGHsXEKtujfuBBHBwO+o1CyZODF5QqPecTeSLFIrgVbyyxAkXgTVe7mBoMpDKwqrDiCD3jUgtrmK4MLbZRE6vtbwahNDqfqO3hLYfqF/NaZRURXdPyiN4b6bx41Phqw6f6lyEWLzGNiW3hu7phHDcxRgLGfNY7Q4FAQx4niK1oFmt5kuIXrsljYOpoaGhFQaEU09jDf28t7ErNJZpKjSqqMFYlAdwAYgHhz1J1XZwM+HzhU3ciiohuwKMGpyEgG4E8zu1YWb3K/bmEgS1yVqzDzGWIBEnA5lXFKn76o1PfX1zHaWdqhkuLmVgiIi8yzHgNXzYWN/dbyZUiuGU7bexgAjE0g+rUDdT7401YYqyTZaY63jtrZe8JEoVa+mg466JjDgyKMizJXiA3uwBI8DQ09WolFKw5C6RqGvElW4+HBuzqptw2jMz1avDhKa8dAg1B4gjXVpYhR7gwqeHEsoA+M6yCOwVpsJcJECfpMLi3ag+JSddVGw3ecbeMS7a18kzRibl3eWWr6NYpsdt+zzZwGx28vJ8tfLp/BppURQiIAqIooABwAAGusLSDp6+zVjYWTYTB3drJZLFFkAy3FzK3vVzC4KyJEhKqfoMK6w+SuCTfpF7rlVf6Yurc+XLuB5FiN3x/tRZzgcFLox9dCPmPaIr2AShf8G/J19TDiNErd3Sr3LVD8u3SiyszdTx0Jubg7gngTwCj4hXSyNSe675iOC+hR3evn/YP6yOsOgbTN4a2/WvbS2vWXRX2lJLhJ0n8zzClu4MqkmaQr+Vom4hAooB1X1L+qrrXqW26W6vgRMp+r7IjHXdqZYq+Q3vzWYvikO59iecOLEsX1Bjchk8ljrWJ2d1x0yw+buUoVlDpIGWhPCmv/ADXO/wCXtv8Awuor7HZ/qKzuoWVklhu4I29lg1CUtwaVA7+y4sMjaxXtldLsuLWZQ6OvOhU8OfHUs2Eyt5gjIarbuou4U4jgoYpJSlebnRN91hNcQ04RwWSwtWo47mmlFKV4U17ziLF5siUMZyt2/mz7TwIWgVFr37VFdT5bL5vOK02zy7GG5i92h2IE/JRyQyba0qePMnQIy2dBHEET23/hdQYiHI32Uiti5jusjKJp6Md20uFTgK0ApwGvs/P49L6FamCQ1WWFj9aORaMp4CtDQ99RrdiuqbqxiqSY7q2S6NOFAGR4OXHu0rZfqW8yKq9THbQpagrQUU7mnPPmR3eHPRx/T+PSxgch53qXklcCm6R2JZj8dB3U1cY/JWkV9Y3S7Li1mUMjD0g+HMHu1LNhMzd4MSEFLaRBdxJ4hdzRvSn3zn192q5Pqy5u4OH5O1tUtn9PtPJOP7nUiYDGrbzTrtub6RjJPIAa0Z24gV7hQejVxYZC2jvLK6Qx3FrModHU9xB0ch0v1BkOl7kNugCVnWEnmIzvjlApw4yHSR9WfrJzfUVnGQ0ds25dp76Gea5HHhyXX2fgMeljC1DPIKtLMw+tJI1WY8TSpoO6g1eWRuJrUXkEkBurZ/Lmj8xSu+N6Hay1qD3HTz3Gb6gnmkNZJpLm3ZmPiSbYk6tMris91Bb3FpNHLsW6hRJfLYNskCW6lkbkRXiNJirzJ5HF26zCaSTGziCSQBWXy5CyOGQ7qkEcwNf+a53/AC9t/wCF1dR4zMZe+trlFQWV/cJLDFtJO6NEjjCk14nUmTzGazaFlRY7CC5jFtH5a7QY45IZNteJNDzJPfpXTL55HQhkdbi2BBHEEEW2rfAG6usxaW8ckTT5NxcTSxyMzFJG2qGADbQKfRAGmtsF1HmsPiyarhopbea3jBLMViN1BNJGDuPBHH3dWtxBn8xjvdLOWzjht7oNG3minnSLOku+RPqs1aaGHtcle5CBJZZYp70wtMhmYu43RxRhquxarAmp50oB1Ba2fVfUESdSSvc3zxz20Lx3Mjq73EDQ20Zjdtu07fZIP0eApFD5jy+Uip5sh3O20Uqx7ye/9p5NgLPAwlUD0cD8hPwFmut1vbHio+u49APIek6WG3jEUa8lHzk95/sN7RbmJruNd72odTIqmnEpWoHH4W+5uYrdfvpXVB4c2I1shyVrM9K7EmRjT1A/C23N9b27HkssqIfuMRr+i3kFzxp+SkV+I4n6JPbuurqK2XxldUHh9YjWy2v7a4f7yOVHPH0Ant3XVzFbL99K6oPD6xGtltf29w/3kUqOfuKT+27S2UiwljUwuDsr6CK09VNUaSFF7zuY/Jt0ssp96nXirMKKp8QvH5f7EzV5nEnyNp1AJIoc4WL3EcLMdrxseFUDUZQOHdwpW5fIwW+RtcnxXqFYxJOFYmkscpq+x/rrzr6RQw+awngP5S3nhcEcRSqkVB00ELGSPaGVmArx7jTVveXPmSyOA/lV2qKHhy493j2C1sztuJBV5eexTyp6Tprm4mKo59q5kq7sfRU1P3de3NcM3ipQD7hU6/o99cPbbae6SsGWviOAp8WrvIlXW8CbywaqsUWgqDXuHdpYLjckW1mYpQE07qkHSWtonlwoSQCSTUmpNTp7OzkaG3QlZJENGkPfxHIernoS3kvu4biIlG5+PiTwGgRNdBhxDBkHH0expoWvJrtK/kzMQWUeFeZ17pZHbcOKyTcygPKnpOmubiYpG59q4kq7uR4VPH1k6G+a4Zu8goB9zYdOi381zbEUSCajFTXgQ3q7tC2tDS5lFWl57FPh6To3+VeSbzTVELHc/wCEzHjoi2hNpKB7EiszCvdUMT8mjj8jIZoUbYJHO5oyOH0jzXUsMq7opkZJFrSqsKEVHo1btaB9s+/cjkGm3byNPT36iv50d54pqxLWigoQVPDiePp0La8QvGrh02kghgCK/cJ56nt46mOOQojNStAeFaAakNoreZKAJJXapIHLgKD5NXORZXW8VAdwbg23gKg17vDRiudyxJGXOygJoQKVIPjqSOwTYtutIFJLUZ25mvPi1dI9zbreXbAGa6nHmSFuZozV28TwpqOSeATPFE0KmRmb2H+kDUmtfTq7so7Jmht3aUvGIxWN/aBbcykkAFeXdq4kuLOMNlGZpUUbdsRaqopWhA4A8NKiiioAFHoH7fSWd9Cs0Mg4VHFT3Mp7iNXeJeNJY0uNyOy+0rLUEoe7eKV9Q1Y2rcG2tIV8PMYvT5dFvwFGrdfBKdk7niWcgeocB8mkiQUWNQqj1dtwv30bD5NBvwGGpmXgwRtp9NOGodwqqncR+KKj5fgTueJaQ09VaDUcSCixqFA9XbPI3Es5A9Q4D5NRxqKLGoUD0AU7C4HF0Ut6xw/e1AW4kLtJ/F4fvatfwd/y7dKv4Tdk7U5yE/L2XC+KU1I3jER/dLqSF/oyChPh4HQRoTK6LRXUijU5E7iCNJv4PtG8Dxpx0vlmhceXMfGMkH5KaVVFFUAKPAD9wBmoCJgG5d4FD82lkUgAjivgfA6rz4DUY8B2P3e1UH18df6U/wAv9vTN7y5oCaVP9vS7pGYcagkkctSDxU6r6Dp0++BGgAxjJ+sOev8ASn+X+3oMLh2qaUqR+/qTezNypU18dOafW3D4+OgRyPYadxpp+H1qj4+OgfHsr4ADSL8f3TXUXo3fvaA9J7HPix7JB4jTGn1SPlH7hQOAZTUE/LoKVr82jwoKcAK0+XSjsqOY0FavDv0QO/W48zy0w9Gq+js3L69ceB0AAaDVO/v1XvGtrA0HLRpz7tMNVHMa2sDw5HXDidbm5Hnr1d2hwIprlUeOuANfTqvx1OvaU19GtoFB36JPfy/cQPgcuw/A5fB5D4HL4PLt5f8AAiv/2Q==" alt="WindowsTelecom" style="height:120px;width:auto;object-fit:contain;border-radius:16px;box-shadow:0 8px 30px rgba(16,211,147,0.3);">
        </div>
        <div style="margin-top:30px;font-size:28px;font-weight:800;color:#10d393;text-shadow:0 0 20px rgba(16,211,147,0.5);letter-spacing:2px;">WIN-TEL GEOMATICS</div>
        <div style="margin-top:10px;font-size:14px;color:#cbd5e1;letter-spacing:4px;text-transform:uppercase;">SaaS Edition v30</div>
        <div style="margin-top:40px;width:200px;height:4px;background:rgba(255,255,255,0.1);border-radius:2px;overflow:hidden;">
            <div style="height:100%;background:linear-gradient(90deg,#10d393,#34eab0);animation:loadProgress 2s ease-out;"></div>
        </div>
    </div>

    <!-- WELCOME WIZARD -->
    <div id="wizard-overlay" class="wizard-overlay">
        <div class="wizard-card">
            <div class="wizard-icon"><i class="fa-solid fa-wand-magic-sparkles"></i></div>
            <h1>Bienvenido a WIN-TEL Geomatics!</h1>
            <p>La herramienta profesional para medicin de terrenos, subdivisin de parcelas y documentacin geomtica.</p>
            <div class="wizard-question">Cul es tu nivel de experiencia?</div>
            <div class="wizard-options">
                <div class="wizard-opt" onclick="Assistant.setMode('beginner')">
                    <i class="fa-solid fa-seedling" style="color:#10d393;"></i>
                    <strong>Principiante</strong>
                    <span>Primera vez usando herramientas GIS</span>
                </div>
                <div class="wizard-opt" onclick="Assistant.setMode('expert')">
                    <i class="fa-solid fa-rocket" style="color:#8b5cf6;"></i>
                    <strong>Experto</strong>
                    <span>Conozco QGIS, Google Earth, etc.</span>
                </div>
            </div>
            <button class="wizard-skip" onclick="Assistant.skipWizard()">Omitir y comenzar directamente</button>
        </div>
    </div>

    <!-- MODE TOGGLE -->
    <div class="mode-toggle" id="mode-toggle">
        <span class="mode-toggle-label">Modo:</span>
        <button class="mode-toggle-btn active" id="mode-beginner" onclick="Assistant.toggleMode('beginner')">
            <i class="fa-solid fa-seedling"></i> Principiante
        </button>
        <button class="mode-toggle-btn" id="mode-expert" onclick="Assistant.toggleMode('expert')">
            <i class="fa-solid fa-rocket"></i> Experto
        </button>
    </div>

    <!-- ASSISTANT FAB -->
    <!-- WHATSAPP FLOAT BUTTON -->
    <a href="https://wa.me/584124060610?text=Hola%20WINDOWSTELECOM%20C.A.%20Necesito%20ayuda%20con%20WIN-TEL%20GEOMATICS%20PRO" target="_blank" class="whatsapp-float" title="Contactar por WhatsApp">
        <i class="fa-brands fa-whatsapp"></i>
    </a>

    <button class="assistant-fab" id="assistant-fab" onclick="Assistant.toggle()">
        <i class="fa-solid fa-robot"></i>
        <span class="notif-badge" id="assistant-notif">?</span>
    </button>

    <!-- ASSISTANT PANEL WITH CHATBOT -->
    <div class="assistant-panel" id="assistant-panel">
        <div class="assistant-header">
            <div class="assistant-avatar"><i class="fa-solid fa-robot"></i></div>
            <div class="assistant-info">
                <h3>Asistente WIN-TEL</h3>
                <p>Chatbot Interactivo 24/7</p>
            </div>
            <button class="assistant-close" onclick="Assistant.toggle()"><i class="fa-solid fa-times"></i></button>
        </div>
        <div class="assistant-body" id="assistant-body">
            <!-- Dynamic chatbot content -->
        </div>
        <div class="chatbot-input-area">
            <input type="text" class="chatbot-input" id="chatbot-input" placeholder="Escribe tu pregunta..." onkeypress="if(event.key==='Enter')Chatbot.sendMessage()">
            <button class="chatbot-send" onclick="Chatbot.sendMessage()"><i class="fa-solid fa-paper-plane"></i></button>
        </div>
    </div>

    <!-- STEP INDICATOR -->
    <div class="step-indicator" id="step-indicator">
        <div class="step-number" id="step-number">1</div>
        <div>
            <div class="step-text" id="step-text">Dibuja tu terreno en el mapa</div>
            <div class="step-hint" id="step-hint">Usa la herramienta de polgono en la derecha</div>
        </div>
        <button class="step-skip" onclick="Assistant.skipStep()">Omitir</button>
    </div>

    <!-- GLOSSARY PANEL -->
    <div class="glossary-panel" id="glossary-panel">
        <div class="glossary-header">
            <h2><i class="fa-solid fa-book"></i> Glosario de Trminos</h2>
            <button class="assistant-close" onclick="Glossary.toggle()"><i class="fa-solid fa-times"></i></button>
        </div>
        <div class="glossary-search">
            <input type="text" id="glossary-search" placeholder="Buscar trmino..." oninput="Glossary.filter(this.value)">
        </div>
        <div class="glossary-body" id="glossary-body">
            <!-- Dynamic content -->
        </div>
    </div>

    <!-- DEMO OVERLAY -->
    <div class="demo-overlay" id="demo-overlay">
        <div class="demo-card">
            <h2><i class="fa-solid fa-play-circle" style="color:var(--primary);margin-right:10px;"></i>Cargar Ejemplo de Prctica</h2>
            <p>Selecciona un terreno de ejemplo para aprender a usar la herramienta</p>
            <div class="demo-options">
                <div class="demo-option" onclick="DemoLoader.load('simple')">
                    <i class="fa-solid fa-square" style="color:#10d393;"></i>
                    <span>Terreno Simple</span>
                    <small>4 vrtices, rectangular</small>
                </div>
                <div class="demo-option" onclick="DemoLoader.load('irregular')">
                    <i class="fa-solid fa-draw-polygon" style="color:#f59e0b;"></i>
                    <span>Terreno Irregular</span>
                    <small>7 vrtices, forma compleja</small>
                </div>
                <div class="demo-option" onclick="DemoLoader.load('subdivision')">
                    <i class="fa-solid fa-th-large" style="color:#8b5cf6;"></i>
                    <span>Ya Subdividido</span>
                    <small>Con 4 lotes creados</small>
                </div>
                <div class="demo-option" onclick="DemoLoader.close()">
                    <i class="fa-solid fa-times-circle" style="color:#94a3b8;"></i>
                    <span>Cancelar</span>
                    <small>Dibujar mi propio terreno</small>
                </div>
            </div>
        </div>
    </div>

    <!-- POTREROS PANEL -->
    <div class="potreros-panel" id="potreros-panel">
        <div class="potreros-header" onclick="Potreros.toggleCollapse()">
            <div class="potreros-header-icon"><i class="fa-solid fa-layer-group"></i></div>
            <div class="potreros-header-info">
                <h3>POTREROS</h3>
                <span id="potreros-count">0 terrenos</span>
            </div>
            <i class="fa-solid fa-chevron-down potreros-collapse-icon" id="potreros-collapse-icon"></i>
        </div>
        <div class="potreros-content">
            <div class="potreros-body" id="potreros-list">
                <!-- Dynamic content -->
            </div>
            <div class="potreros-footer">
                <button class="potreros-add-btn" onclick="Potreros.startDrawing()">
                    <i class="fa-solid fa-plus"></i> Nuevo Potrero
                </button>
            </div>
        </div>
    </div>

    <!-- ACTIVE POTRERO BADGE -->
    <div class="active-potrero-badge" id="active-potrero-badge">
        <div class="potrero-color" id="active-potrero-color"></div>
        <span id="active-potrero-name">Potrero 1</span>
        <small id="active-potrero-area"></small>
    </div>

    <!-- POTRERO EDIT MODAL -->
    <div class="potrero-modal" id="potrero-modal">
        <div class="potrero-modal-card">
            <div class="potrero-modal-title">
                <i class="fa-solid fa-pen" style="color:var(--primary);"></i>
                Editar Potrero
            </div>
            <div class="form-group">
                <label class="form-label">Nombre del Potrero</label>
                <input type="text" class="form-input" id="potrero-edit-name" placeholder="Ej: Potrero Norte">
            </div>
            <div class="form-group">
                <label class="form-label">Color</label>
                <div class="potrero-colors" id="potrero-colors">
                    <!-- Dynamic colors -->
                </div>
            </div>
            <div class="form-row" style="margin-top:20px;">
                <button class="btn btn-2" onclick="Potreros.closeModal()">Cancelar</button>
                <button class="btn" onclick="Potreros.saveEdit()">Guardar</button>
            </div>
        </div>
    </div>

    <div class="app">
        <aside class="sidebar">
            <div class="logo" onclick="togglePanel('main')" title="WIN-TEL Geomatics Pro">
                <svg width="32" height="32" viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <defs>
                        <linearGradient id="logoGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" style="stop-color:#ffffff;stop-opacity:1"></stop>
                            <stop offset="100%" style="stop-color:#e2e8f0;stop-opacity:1"></stop>
                        </linearGradient>
                    </defs>
                    <path d="M50 10L85 30V70L50 90L15 70V30L50 10Z" fill="url(#logoGrad)" stroke="#ffffff" stroke-width="2"></path>
                    <circle cx="50" cy="50" r="22" fill="#1E293B" stroke="#ffffff" stroke-width="1"></circle>
                    <circle cx="50" cy="50" r="16" fill="#0F172A"></circle>
                    <path d="M50 38C54 38 58 40 60 42L58 44C56 42 53 41 50 41V38Z" fill="white" opacity="0.8"></path>
                    <circle cx="56" cy="46" r="2" fill="white" opacity="0.9"></circle>
                    <line x1="50" y1="25" x2="50" y2="35" stroke="#fbbf24" stroke-width="2"></line>
                    <line x1="50" y1="65" x2="50" y2="75" stroke="#fbbf24" stroke-width="2"></line>
                    <line x1="25" y1="50" x2="35" y2="50" stroke="#fbbf24" stroke-width="2"></line>
                    <line x1="65" y1="50" x2="75" y2="50" stroke="#fbbf24" stroke-width="2"></line>
                </svg>
            </div>
            <nav class="nav">
                <div class="nav-group">
                    <button class="nav-item active" data-panel="main" data-tip="Principal" onclick="togglePanel('main')"><i class="fa-solid fa-sliders"></i></button>
                    <button class="nav-item" data-panel="subdiv" data-tip="Subdivisin" onclick="togglePanel('subdiv')"><i class="fa-solid fa-th-large"></i></button>
                    <button class="nav-item" data-panel="radial" data-tip="Radial" onclick="togglePanel('radial')"><i class="fa-solid fa-circle-notch"></i></button>
                </div>
                <div class="nav-group">
                    <button class="nav-item" data-panel="botalones" data-tip="Botalones" onclick="togglePanel('botalones')"><i class="fa-solid fa-signs-post"></i></button>
                    <button class="nav-item" data-panel="topo" data-tip="Topografa" onclick="togglePanel('topo')"><i class="fa-solid fa-mountain"></i></button>
                    <button class="nav-item" data-panel="coords" data-tip="Coordenadas" onclick="togglePanel('coords')"><i class="fa-solid fa-location-crosshairs"></i></button>
                </div>
                <div class="nav-group">
                    <button class="nav-item" data-panel="data" data-tip="Tabla" onclick="togglePanel('data')"><i class="fa-solid fa-table"></i></button>
                    <button class="nav-item" data-panel="sun" data-tip="Solar" onclick="togglePanel('sun')"><i class="fa-solid fa-sun"></i></button>
                    <button class="nav-item" data-panel="export" data-tip="Exportar" onclick="togglePanel('export')"><i class="fa-solid fa-download"></i></button>
                </div>
            </nav>
        </aside>
        <main class="map-wrap"><div id="map"></div></main>
    </div>

    <!-- ========== PANEL CONTEO MANUAL DE CULTIVOS v30 ========== -->
    <div id="tree-counter-panel" class="floating-panel" style="display:none;position:fixed;top:80px;right:20px;width:320px;background:var(--bg-panel);border:1px solid var(--border);border-radius:12px;box-shadow:var(--shadow);z-index:2500;max-height:85vh;overflow-y:auto;">
        <div style="padding:12px 16px;background:linear-gradient(135deg,rgba(34,197,94,0.3),rgba(22,163,74,0.2));border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;">
            <div style="display:flex;align-items:center;gap:8px;">
                <i class="fa-solid fa-tree" style="color:#22c55e;font-size:18px;"></i>
                <span style="font-weight:800;font-size:12px;color:#fff;text-transform:uppercase;">Conteo de Cultivos</span>
            </div>
            <button onclick="TreeCounter.togglePanel()" style="background:none;border:none;color:var(--text-2);cursor:pointer;font-size:14px;"><i class="fa-solid fa-times"></i></button>
        </div>
        <div style="padding:14px;">
            <div style="background:rgba(34,197,94,0.15);border:1px solid #22c55e;border-radius:6px;padding:10px;margin-bottom:12px;">
                <div style="font-size:10px;color:#22c55e;font-weight:700;"> CONTEO MANUAL PRECISO</div>
                <div style="font-size:9px;color:var(--text-3);margin-top:3px;">Haz clic en cada rbol/planta para contarlo con precisin GPS</div>
            </div>
            
            <div class="form-group">
                <label class="form-label" style="color:#22c55e;">Tipo de Cultivo</label>
                <select class="form-input" id="tc-crop-type" onchange="TreeCounter.setCropType(this.value)">
                    <option value="tree"> rboles</option>
                    <option value="palm"> Palmas</option>
                    <option value="citrus"> Ctricos</option>
                    <option value="coffee"> Caf</option>
                    <option value="cacao"> Cacao</option>
                    <option value="mango"> Mango</option>
                    <option value="avocado"> Aguacate</option>
                    <option value="banana"> Pltano</option>
                    <option value="olive"> Olivo</option>
                    <option value="grape"> Uva/Vid</option>
                    <option value="other"> Otro</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">Radio de Copa (metros)</label>
                <input type="number" class="form-input" id="tc-radius" value="3" min="0.5" max="20" step="0.5">
            </div>
            
            <button id="tc-start-btn" class="btn" onclick="TreeCounter.startDrawing()" style="background:linear-gradient(135deg,#22c55e,#16a34a);">
                <i class="fa-solid fa-crosshairs"></i> INICIAR CONTEO
            </button>
            
            <button class="btn btn-danger" onclick="TreeCounter.clearAll()" style="margin-top:8px;">
                <i class="fa-solid fa-trash"></i> LIMPIAR TODO
            </button>
            
            <!-- Resultados -->
            <div id="tc-results" style="display:none;margin-top:14px;">
                <div style="font-size:11px;font-weight:700;color:#22c55e;margin-bottom:8px;text-transform:uppercase;">
                    <i class="fa-solid fa-chart-bar"></i> Resultados
                </div>
                
                <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:6px;">
                    <div style="background:var(--bg-glass);border-radius:6px;padding:10px;text-align:center;border:1px solid rgba(34,197,94,0.3);">
                        <div id="tc-count" style="font-size:28px;font-weight:800;color:#22c55e;transition:transform 0.15s;">0</div>
                        <div style="font-size:9px;color:var(--text-3);text-transform:uppercase;">Total</div>
                    </div>
                    <div style="background:var(--bg-glass);border-radius:6px;padding:10px;text-align:center;border:1px solid rgba(59,130,246,0.3);">
                        <div id="tc-density" style="font-size:28px;font-weight:800;color:#3b82f6;">0</div>
                        <div style="font-size:9px;color:var(--text-3);text-transform:uppercase;">Por Hectrea</div>
                    </div>
                </div>
                
                <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:6px;margin-top:6px;">
                    <div style="background:var(--bg-glass);border-radius:6px;padding:8px;text-align:center;">
                        <div id="tc-canopy" style="font-size:14px;font-weight:700;color:#a78bfa;">0 m</div>
                        <div style="font-size:8px;color:var(--text-3);">rea Copas</div>
                    </div>
                    <div style="background:var(--bg-glass);border-radius:6px;padding:8px;text-align:center;">
                        <div id="tc-coverage" style="font-size:14px;font-weight:700;color:#f59e0b;">0%</div>
                        <div style="font-size:8px;color:var(--text-3);">Cobertura</div>
                    </div>
                </div>
                
                <div id="tc-breakdown" style="margin-top:8px;text-align:center;"></div>
                
                <div id="tc-production" style="display:none;background:rgba(251,191,36,0.15);border:1px solid #f59e0b;border-radius:6px;padding:8px;margin-top:8px;font-size:10px;color:#f59e0b;text-align:center;"></div>
                
                <div style="font-size:10px;font-weight:600;color:var(--text-2);margin:12px 0 6px 0;">
                    <i class="fa-solid fa-download"></i> Exportar
                </div>
                <div style="display:grid;grid-template-columns:repeat(5,1fr);gap:4px;">
                    <button class="btn btn-2" onclick="TreeCounter.exportKML()" style="font-size:8px;padding:6px;" title="Google Earth">KML</button>
                    <button class="btn btn-2" onclick="TreeCounter.exportGeoJSON()" style="font-size:8px;padding:6px;" title="GIS">JSON</button>
                    <button class="btn btn-2" onclick="TreeCounter.exportCSV()" style="font-size:8px;padding:6px;" title="Excel">CSV</button>
                    <button class="btn btn-2" onclick="TreeCounter.exportGPX()" style="font-size:8px;padding:6px;" title="GPS">GPX</button>
                    <button class="btn btn-2" onclick="TreeCounter.exportPDF()" style="font-size:8px;padding:6px;" title="Informe">PDF</button>
                </div>
                <button class="btn btn-2" onclick="TreeCounter.copyToClipboard()" style="margin-top:6px;font-size:10px;">
                    <i class="fa-solid fa-copy"></i> Copiar al Portapapeles
                </button>
            </div>
        </div>
    </div>

    <!-- QUICK TOOLS BAR -->
    <div class="quick-tools">
        <button class="quick-btn" onclick="togglePanel('botalones')" title="Botalones" style="color:#f59e0b;"><i class="fa-solid fa-signs-post"></i></button>
        <button class="quick-btn" onclick="OmegaSampling.togglePanel()" title="Muestreo" style="color:#22c55e;"><i class="fa-solid fa-grip"></i></button>
        <button class="quick-btn" onclick="ML.togglePanel()" title="Multilnea" style="color:#10b981;"><i class="fa-solid fa-grip-lines"></i></button>
        <button class="quick-btn" onclick="OmegaRadar.togglePanel()" title="Radar Urbano" style="color:#8b5cf6;"><i class="fa-solid fa-satellite-dish"></i></button>
        <button class="quick-btn" onclick="OmegaSat.togglePanel()" title="Satelital" style="color:#ef4444;"><i class="fa-solid fa-satellite"></i></button>
        <button class="quick-btn" onclick="$('kml-in').click()" title="Importar KML" style="color:#06b6d4;"><i class="fa-solid fa-folder-open"></i></button>
        <button class="quick-btn" onclick="Shortcuts.showHelp()" title="Atajos de Teclado (Ctrl+H)" style="color:#ec4899;"><i class="fa-solid fa-keyboard"></i></button>
        <button class="quick-btn" onclick="TourGuide.reset();location.reload()" title="Reiniciar Tour Guiado" style="color:#14b8a6;"><i class="fa-solid fa-route"></i></button>
        <button class="quick-btn" onclick="ExportPlus.downloadGeoJSON()" title="Exportar GeoJSON (Ctrl+E)" style="color:#10d393;"><i class="fa-solid fa-file-code"></i></button>
        <button class="quick-btn" onclick="ExportPlus.downloadKML()" title="Exportar KML (Ctrl+K)" style="color:#3b82f6;"><i class="fa-solid fa-earth-americas"></i></button>
        <button class="quick-btn" onclick="ExportPlus.shareURL()" title="Compartir URL" style="color:#a78bfa;"><i class="fa-solid fa-share-nodes"></i></button>
        <button class="quick-btn" onclick="DarkMode.toggle()" title="Modo Oscuro/Claro (Ctrl+D)" style="color:#fbbf24;"><i class="fa-solid fa-moon"></i></button>
        <button class="quick-btn" onclick="SmartParcel.togglePanel()" title="Parcelacin Inteligente" style="color:#f472b6;"><i class="fa-solid fa-vector-square"></i></button>
        <button class="quick-btn" onclick="SetbackCalc.togglePanel()" title="Retiros y rea Construible" style="color:#fb923c;"><i class="fa-solid fa-border-none"></i></button>
        <button class="quick-btn" onclick="ElevationPro.togglePanel()" title="Perfil de Elevacin" style="color:#4ade80;"><i class="fa-solid fa-mountain-sun"></i></button>
        <button class="quick-btn" onclick="MemorialGen.togglePanel()" title="Memorial Descriptivo" style="color:#f97316;"><i class="fa-solid fa-file-contract"></i></button>
        <button class="quick-btn" onclick="CroquisGen.togglePanel()" title="Generar Croquis/Plano" style="color:#06b6d4;"><i class="fa-solid fa-map"></i></button>
        <button class="quick-btn" onclick="Glossary.toggle()" title="Glosario de Trminos" style="color:#f472b6;"><i class="fa-solid fa-book"></i></button>
        <button class="quick-btn" onclick="DemoLoader.show()" title="Cargar Ejemplo Demo" style="color:#a78bfa;"><i class="fa-solid fa-play-circle"></i></button>
        <!-- ========== NUEVOS MDULOS v29 ========== -->
        <button class="quick-btn" onclick="SlopeAnalyzer.togglePanel()" title="Anlisis de Pendientes" style="color:#8b5cf6;"><i class="fa-solid fa-mountain"></i></button>
        <button class="quick-btn" onclick="VolumeCalculator.togglePanel()" title="Corte y Relleno" style="color:#f97316;"><i class="fa-solid fa-truck-moving"></i></button>
        <button class="quick-btn" onclick="ViewshedAnalysis.togglePanel()" title="Anlisis de Visibilidad" style="color:#3b82f6;"><i class="fa-solid fa-binoculars"></i></button>
        <button class="quick-btn" onclick="PathOptimizer.togglePanel()" title="Optimizacin de Rutas" style="color:#10b981;"><i class="fa-solid fa-route"></i></button>
        <button class="quick-btn" onclick="ShadowAnalysis3D.togglePanel()" title="Anlisis de Sombras" style="color:#6366f1;"><i class="fa-solid fa-cloud-sun"></i></button>
        <button class="quick-btn" onclick="UrbanIndices.togglePanel()" title="ndices Urbansticos" style="color:#ec4899;"><i class="fa-solid fa-city"></i></button>
        <button class="quick-btn" onclick="BudgetGenerator.togglePanel()" title="Generador de Presupuestos" style="color:#f59e0b;"><i class="fa-solid fa-calculator"></i></button>
        <button class="quick-btn" onclick="RiskAnalysis.togglePanel()" title="Anlisis de Riesgos" style="color:#ef4444;"><i class="fa-solid fa-triangle-exclamation"></i></button>
        <button class="quick-btn" onclick="DrainageSimulator.togglePanel()" title="Simulacin de Drenaje" style="color:#06b6d4;"><i class="fa-solid fa-water"></i></button>
        <button class="quick-btn" onclick="RealTimeGPS.connectDevice()" title="GPS en Tiempo Real" style="color:#22c55e;"><i class="fa-solid fa-satellite"></i></button>
        <!-- PERFIL DE ELEVACIN DE LNEA - NUEVO -->
        <button class="quick-btn" onclick="LineElevationProfile.toggleDrawMode()" title=" Perfil de Elevacin de Lnea (como Google)" style="background:linear-gradient(135deg,#8b5cf6,#7c3aed);color:white;border:2px solid #a78bfa;"><i class="fa-solid fa-chart-area"></i></button>
        <!-- NUEVO v30: Conteo de rboles -->
        <button class="quick-btn" onclick="TreeCounter.togglePanel()" title=" Conteo de rboles y Cultivos" style="background:linear-gradient(135deg,#22c55e,#16a34a);color:white;border:2px solid #4ade80;"><i class="fa-solid fa-tree"></i></button>
        <!-- ========== 5 MDULOS NUEVOS v30 ========== -->
        <button class="quick-btn" onclick="NDVIAnalyzer.togglePanel()" title=" Anlisis NDVI - Salud de Cultivos" style="background:linear-gradient(135deg,#16a34a,#15803d);color:white;border:2px solid #22c55e;"><i class="fa-solid fa-leaf"></i></button>
        <button class="quick-btn" onclick="PlanoGenerator.togglePanel()" title=" Generador de Planos Profesionales" style="background:linear-gradient(135deg,#8b5cf6,#7c3aed);color:white;border:2px solid #a78bfa;"><i class="fa-solid fa-drafting-compass"></i></button>
        <button class="quick-btn" onclick="EarthworkCalc.togglePanel()" title=" Movimiento de Tierras (Corte/Relleno)" style="background:linear-gradient(135deg,#f59e0b,#d97706);color:white;border:2px solid #fbbf24;"><i class="fa-solid fa-truck-moving"></i></button>
        <button class="quick-btn" onclick="TerrainCompare.togglePanel()" title=" Comparador de Terrenos (Antes/Despus)" style="background:linear-gradient(135deg,#ec4899,#db2777);color:white;border:2px solid #f472b6;"><i class="fa-solid fa-code-compare"></i></button>
        <button class="quick-btn" onclick="IrrigationCalc.togglePanel()" title=" Calculadora de Riego" style="background:linear-gradient(135deg,#0ea5e9,#0284c7);color:white;border:2px solid #38bdf8;"><i class="fa-solid fa-droplet"></i></button>
    </div>

    <div class="coords-disp">Lat: <span id="m-lat">--</span> | Lon: <span id="m-lon">--</span></div>
    <div class="undo-redo">
        <button class="undo-btn" id="btn-undo" onclick="HistoryMgr.undo()" title="Deshacer (Ctrl+Z)" disabled><i class="fa-solid fa-rotate-left"></i></button>
        <button class="undo-btn" id="btn-redo" onclick="HistoryMgr.redo()" title="Rehacer (Ctrl+Y)" disabled><i class="fa-solid fa-rotate-right"></i></button>
    </div>

    <!-- MAIN PANEL -->
    <div id="panel-main" class="panel active">
        <div class="panel-hdr"><div class="panel-title"><svg width="18" height="18" viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg"><defs><linearGradient id="miniGrad" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" style="stop-color:#10d393;stop-opacity:1"></stop><stop offset="100%" style="stop-color:#059669;stop-opacity:1"></stop></linearGradient></defs><path d="M50 10L85 30V70L50 90L15 70V30L50 10Z" fill="url(#miniGrad)" stroke="#34eab0" stroke-width="2"></path><circle cx="50" cy="50" r="16" fill="#0F172A"></circle><line x1="50" y1="25" x2="50" y2="35" stroke="#fbbf24" stroke-width="3"></line><line x1="50" y1="65" x2="50" y2="75" stroke="#fbbf24" stroke-width="3"></line><line x1="25" y1="50" x2="35" y2="50" stroke="#fbbf24" stroke-width="3"></line><line x1="65" y1="50" x2="75" y2="50" stroke="#fbbf24" stroke-width="3"></line></svg> WIN-TEL v30</div><button class="panel-close" onclick="closePanel('main')"><i class="fa-solid fa-times"></i></button></div>
        <div class="panel-body">
            <div class="toggle-row"><div class="toggle-lbl"><i class="fa-solid fa-palette"></i> Tema Pastel</div><label class="switch"><input type="checkbox" id="theme-tog" onchange="ThemeMgr.toggle()"><span class="slider"></span></label></div>
            <div class="toolbar">
                <button class="tool-btn" onclick="$('proj-in').click()" title="Cargar .omega"><i class="fa-solid fa-folder-open"></i></button>
                <button class="tool-btn" onclick="ProjectMgr.save()" title="Guardar .omega"><i class="fa-solid fa-floppy-disk"></i></button>
                <button class="tool-btn" onclick="$('kml-in').click()" title="Importar KML"><i class="fa-solid fa-earth-americas"></i></button>
                <button class="tool-btn" onclick="togglePanel('coords')" title="Coordenadas"><i class="fa-solid fa-terminal"></i></button>
                <button class="tool-btn" onclick="Renderer.clearAll()" title="Limpiar todo"><i class="fa-solid fa-trash"></i></button>
            </div>
            <!-- v30: Importar ms formatos -->
            <div class="section-lbl" style="color:#22c55e;font-size:10px;margin:8px 0 6px 0;"><i class="fa-solid fa-file-import"></i> IMPORTAR ARCHIVOS</div>
            <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:4px;margin-bottom:10px;">
                <button class="tool-btn" onclick="$('geojson-in').click()" title="GeoJSON" style="font-size:9px;aspect-ratio:auto;padding:6px;"><i class="fa-solid fa-code" style="color:#3b82f6;"></i></button>
                <button class="tool-btn" onclick="$('csv-in').click()" title="CSV Coordenadas" style="font-size:9px;aspect-ratio:auto;padding:6px;"><i class="fa-solid fa-file-csv" style="color:#22c55e;"></i></button>
                <button class="tool-btn" onclick="$('gpx-in').click()" title="GPX (GPS)" style="font-size:9px;aspect-ratio:auto;padding:6px;"><i class="fa-solid fa-route" style="color:#8b5cf6;"></i></button>
                <button class="tool-btn" onclick="$('dxf-in').click()" title="DXF (AutoCAD)" style="font-size:9px;aspect-ratio:auto;padding:6px;"><i class="fa-solid fa-drafting-compass" style="color:#f59e0b;"></i></button>
            </div>
            <input type="file" id="proj-in" accept=".omega,.json" onchange="ProjectMgr.load(this)">
            <input type="file" id="kml-in" accept=".kml" onchange="ImportMgr.handleKML(this)">
            <input type="file" id="geojson-in" accept=".geojson,.json" onchange="ImportMgr.handleGeoJSON(this)" style="display:none">
            <input type="file" id="gpx-in" accept=".gpx" onchange="ImportMgr.handleGPX(this)" style="display:none">
            <input type="file" id="csv-in" accept=".csv,.txt" onchange="ImportMgr.handleCSV(this)" style="display:none">
            <input type="file" id="dxf-in" accept=".dxf" onchange="ImportMgr.handleDXF(this)" style="display:none">
            <div class="toggle-row"><div class="toggle-lbl"><i class="fa-solid fa-map-pin" style="color:var(--warning);"></i> Vrtices</div><label class="switch"><input type="checkbox" id="tog-vert" onchange="Renderer.toggleVerts()" checked><span class="slider"></span></label></div>
            <div class="toggle-row"><div class="toggle-lbl"><i class="fa-solid fa-ruler-combined" style="color:var(--cyan);"></i> Distancias</div><label class="switch"><input type="checkbox" id="tog-dist" onchange="Renderer.toggleDist()" checked><span class="slider"></span></label></div>
            <div class="toggle-row"><div class="toggle-lbl"><i class="fa-solid fa-compass" style="color:var(--purple);"></i> Azimuts</div><label class="switch"><input type="checkbox" id="tog-az" onchange="Renderer.toggleAz()"><span class="slider"></span></label></div>
            <div class="toggle-row"><div class="toggle-lbl"><i class="fa-solid fa-calculator"></i> Geodsico</div><label class="switch"><input type="checkbox" id="tog-geo" checked><span class="slider"></span></label></div>
            <div id="empty-st" style="text-align:center; padding:30px; border:2px dashed var(--border); border-radius:8px; margin-top:10px;"><i class="fa-solid fa-vector-square" style="font-size:40px; color:var(--text-3); opacity:0.5;"></i><p style="color:var(--text-2); margin-top:10px; font-size:12px;">Dibuja polgono o importa archivo</p></div>
            <div id="poly-info" class="hidden" style="margin-top:12px;"><div class="stats"><div class="stat"><div class="stat-val" id="total-area">0</div><div class="stat-lbl">rea (Ha)</div></div><div class="stat"><div class="stat-val" id="total-perim">0</div><div class="stat-lbl">Permetro (m)</div></div></div></div>
            <!-- v30: Proyectos guardados localmente -->
            <div class="section-lbl" style="color:#3b82f6;font-size:10px;margin:12px 0 6px 0;"><i class="fa-solid fa-database"></i> PROYECTOS LOCALES</div>
            <div style="display:flex;gap:4px;margin-bottom:6px;">
                <input type="text" id="local-project-name" class="form-input" placeholder="Nombre del proyecto" style="flex:1;padding:6px 8px;font-size:11px;">
                <button class="btn" style="padding:6px 10px;font-size:10px;" onclick="ProjectMgr.saveToLocal($('local-project-name').value)"><i class="fa-solid fa-save"></i></button>
            </div>
            <div id="local-projects-list" style="max-height:120px;overflow-y:auto;background:var(--bg-glass);border-radius:6px;padding:6px;">
                <div style="text-align:center;color:var(--text-3);font-size:10px;padding:8px;">Cargando...</div>
            </div>
        </div>
    </div>

    <!-- SUBDIVISION PANEL -->
    <div id="panel-subdiv" class="panel">
        <div class="panel-hdr"><div class="panel-title"><i class="fa-solid fa-th-large"></i> Subdivisin</div><button class="panel-close" onclick="closePanel('subdiv')"><i class="fa-solid fa-times"></i></button></div>
        <div class="panel-body">
            <div class="tabs"><button class="tab active" onclick="switchTab('subdiv','grid',this)">Grilla</button><button class="tab" onclick="switchTab('subdiv','bisect',this)">Biseccin</button><button class="tab" onclick="switchTab('subdiv','slicer',this)">Slicer</button><button class="tab" onclick="switchTab('subdiv','fusion',this)">Fusin</button><button class="tab" onclick="switchTab('subdiv','cadastre',this)">Catastro</button><button class="tab" onclick="switchTab('subdiv','reserves',this)">Reservas</button><button class="tab" onclick="switchTab('subdiv','furrows',this)" style="color:#22c55e;"></button><button class="tab" onclick="switchTab('subdiv','slopes',this)" style="color:#f59e0b;"></button><button class="tab" onclick="switchTab('subdiv','dxf',this)" style="color:#3b82f6;">CAD</button><button class="tab" onclick="switchTab('subdiv','profile',this)" style="color:#ec4899;"></button><button class="tab" onclick="switchTab('subdiv','contours',this)" style="color:#14b8a6;"></button><button class="tab" onclick="switchTab('subdiv','watershed',this)" style="color:#06b6d4;"></button><button class="tab" onclick="switchTab('subdiv','voronoi',this)" style="color:#8b5cf6;"></button><button class="tab" onclick="switchTab('subdiv','transects',this)" style="color:#f97316;"></button></div>
            <div id="subdiv-grid" class="tab-content active">
                <!-- GRILLA ORIGINAL - INTACTA -->
                <div class="form-group"><label class="form-label">Rotacin ()</label><div class="range-grp"><input type="range" class="range" id="grid-angle" min="0" max="360" value="0" oninput="GridEngine.updateAngle(this.value)"><input type="number" class="range-val" id="grid-angle-n" value="0" oninput="GridEngine.updateAngle(this.value)"></div></div>
                <div class="form-row" style="margin-bottom:12px;"><div class="form-group" style="margin:0"><label class="form-label">Filas</label><input type="number" class="form-input" id="grid-rows" value="4" min="1" oninput="GridEngine.preview()"></div><div class="form-group" style="margin:0"><label class="form-label">Columnas</label><input type="number" class="form-input" id="grid-cols" value="4" min="1" oninput="GridEngine.preview()"></div></div>
                <div class="section-lbl"><i class="fa-solid fa-road"></i> Vialidades</div>
                <div class="form-row"><div class="form-group" style="margin:0"><label class="form-label">Ancho (m)</label><input type="number" class="form-input" id="alley-w" value="12" min="1" oninput="GridEngine.preview()"></div><div class="form-group" style="margin:0"><label class="form-label">Cantidad</label><input type="number" class="form-input" id="num-alleys" value="0" min="0" oninput="GridEngine.genAlleyCtrl()"></div></div>
                <div id="alley-ctrl"></div>
                <button class="btn" onclick="GridEngine.apply()" style="margin-top:10px;"><i class="fa-solid fa-scissors"></i> Ejecutar</button>
                
                <!-- SEPARADOR Y MODO ADICIONAL: POR DIMENSIONES -->
                <hr style="border:0;border-top:2px dashed var(--warning);margin:20px 0;">
                <div class="form-group">
                    <label class="form-label" style="color:var(--warning);"><i class="fa-solid fa-sliders-h"></i> MODO ALTERNATIVO: POR DIMENSIONES</label>
                    <select id="subdiv-mode" class="form-input" onchange="SubdivModeToggle()">
                        <option value="hidden"> Expandir opciones adicionales...</option>
                        <option value="dimension">Por Dimensiones (Ancho x Largo)</option>
                        <option value="exact">Por Filas y Columnas (Exacta)</option>
                    </select>
                </div>
                
                <!-- MODO POR DIMENSIONES (Ancho x Largo) - NUEVO -->
                <div id="mode-dimension" style="display:none;">
                    <div style="background:linear-gradient(135deg,rgba(251,191,36,0.2),rgba(245,158,11,0.15));border:1px solid #fbbf24;border-radius:8px;padding:12px;margin-bottom:12px;">
                        <div style="display:flex;align-items:center;gap:8px;margin-bottom:5px;">
                            <i class="fa-solid fa-ruler-combined" style="color:#fbbf24;font-size:16px;"></i>
                            <span style="font-weight:700;font-size:12px;color:#fff;text-transform:uppercase;letter-spacing:0.5px;">SUBDIVISIN POR DIMENSIONES</span>
                        </div>
                        <p style="font-size:10px;color:var(--text-2);margin:0;">Define ancho y largo del lote. El sistema calcula cuntos caben.</p>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Dimensiones Lote (m)</label>
                        <div class="form-row">
                            <input type="number" class="form-input" id="lot-w" value="20.00" placeholder="Ancho" oninput="DimensionEngine.preview()">
                            <input type="number" class="form-input" id="lot-h" value="10.00" placeholder="Largo" oninput="DimensionEngine.preview()">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label"><span>Rotacin Global</span> <span id="dim-rot-disp" style="color:var(--warning);">0</span></label>
                        <input type="range" class="range" id="dim-rot-angle" min="0" max="180" step="0.5" value="0" style="width:100%;accent-color:#fbbf24;" oninput="DimensionEngine.updateAngle(this.value)">
                    </div>
                    <div class="section-lbl" style="color:var(--warning);"><i class="fa-solid fa-road"></i> CONFIGURACIN VIALIDAD</div>
                    <div class="form-group">
                        <label class="form-label">Ancho de Calle (m)</label>
                        <input type="number" class="form-input" id="road-w" value="10.00">
                    </div>
                    <div class="form-row">
                        <div class="form-group" style="margin:0">
                            <label class="form-label">Calle cada X Cols</label>
                            <input type="number" class="form-input" id="road-freq-x" value="1" min="1">
                        </div>
                        <div class="form-group" style="margin:0">
                            <label class="form-label">Calle cada X Filas</label>
                            <input type="number" class="form-input" id="road-freq-y" value="100" min="1">
                        </div>
                    </div>
                    <button class="btn" style="background:linear-gradient(135deg,#fbbf24,#f59e0b);" onclick="DimensionEngine.execute()"><i class="fa-solid fa-ruler-combined"></i> Generar por Dimensiones</button>
                </div>
                
                <!-- MODO EXACTO (Filas x Columnas) - ALTERNATIVO -->
                <div id="mode-exact" style="display:none;">
                    <div style="background:linear-gradient(135deg,rgba(139,92,246,0.2),rgba(168,85,247,0.15));border:1px solid #8b5cf6;border-radius:8px;padding:12px;margin-bottom:12px;">
                        <div style="display:flex;align-items:center;gap:8px;margin-bottom:5px;">
                            <i class="fa-solid fa-th-large" style="color:#8b5cf6;font-size:16px;"></i>
                            <span style="font-weight:700;font-size:12px;color:#fff;text-transform:uppercase;letter-spacing:0.5px;">SUBDIVISIN EXACTA AVANZADA</span>
                        </div>
                        <p style="font-size:10px;color:var(--text-2);margin:0;">Divide el polgono en filas y columnas exactas con rotacin independiente</p>
                    </div>
                    <div class="form-group"><label class="form-label">Rotacin Exacta ()</label><div class="range-grp"><input type="range" class="range" id="exact-angle" min="0" max="360" value="0" oninput="ExactGridAlt.updateAngle(this.value)"><input type="number" class="range-val" id="exact-angle-n" value="0" oninput="ExactGridAlt.updateAngle(this.value)"></div></div>
                    <div class="form-row" style="margin-bottom:12px;"><div class="form-group" style="margin:0"><label class="form-label">Filas</label><input type="number" class="form-input" id="exact-rows" value="4" min="1" max="50" oninput="ExactGridAlt.preview()"></div><div class="form-group" style="margin:0"><label class="form-label">Columnas</label><input type="number" class="form-input" id="exact-cols" value="4" min="1" max="50" oninput="ExactGridAlt.preview()"></div></div>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
                        <div style="background:rgba(34,211,238,0.1);border:1px solid #22d3ee;border-radius:6px;padding:10px;">
                            <div class="section-lbl" style="color:#22d3ee;margin-top:0;border:none;padding:0;margin-bottom:8px;"><i class="fa-solid fa-arrows-left-right"></i> Vialidades Horizontales</div>
                            <div class="form-group" style="margin-bottom:8px;"><label class="form-label">Ancho (m)</label><input type="number" class="form-input" id="exact-alley-w-h" value="12" min="0" step="0.5" oninput="ExactGridAlt.preview()"></div>
                            <div class="form-group" style="margin-bottom:0;"><label class="form-label">Cantidad</label><input type="number" class="form-input" id="exact-num-alleys-h" value="0" min="0" max="10" oninput="ExactGridAlt.genAlleyControls()"></div>
                            <div id="exact-alley-ctrl-h"></div>
                        </div>
                        <div style="background:rgba(251,191,36,0.1);border:1px solid #fbbf24;border-radius:6px;padding:10px;">
                            <div class="section-lbl" style="color:#fbbf24;margin-top:0;border:none;padding:0;margin-bottom:8px;"><i class="fa-solid fa-arrows-up-down"></i> Vialidades Verticales</div>
                            <div class="form-group" style="margin-bottom:8px;"><label class="form-label">Ancho (m)</label><input type="number" class="form-input" id="exact-alley-w-v" value="12" min="0" step="0.5" oninput="ExactGridAlt.preview()"></div>
                            <div class="form-group" style="margin-bottom:0;"><label class="form-label">Cantidad</label><input type="number" class="form-input" id="exact-num-alleys-v" value="0" min="0" max="10" oninput="ExactGridAlt.genAlleyControls()"></div>
                            <div id="exact-alley-ctrl-v"></div>
                        </div>
                    </div>
                    <button class="btn" style="background:linear-gradient(135deg,#8b5cf6,#a855f7);margin-top:10px;" onclick="ExactGridAlt.apply()"><i class="fa-solid fa-th-large"></i> Generar Subdivisin Exacta</button>
                </div>
            </div>
            <div id="subdiv-bisect" class="tab-content">
                <div style="background:linear-gradient(135deg,rgba(168,85,247,0.2),rgba(139,92,246,0.15));border:1px solid #a855f7;border-radius:8px;padding:12px;margin-bottom:12px;">
                    <div style="display:flex;align-items:center;gap:8px;margin-bottom:5px;">
                        <i class="fa-solid fa-scissors" style="color:#a855f7;font-size:16px;"></i>
                        <span style="font-weight:700;font-size:12px;color:#fff;text-transform:uppercase;letter-spacing:0.5px;">BISECCIN AVANZADA</span>
                    </div>
                    <p style="font-size:10px;color:var(--text-2);margin:0;">Divisin inteligente de terrenos con mltiples modos de corte</p>
                </div>
                <div class="section-lbl" style="color:#a855f7;"><i class="fa-solid fa-sliders"></i> Modo de Divisin</div>
                <div class="form-group">
                    <select class="form-input" id="bisect-mode" onchange="BisectEngine.changeMode()">
                        <option value="area"> Por rea Especfica (Ha)</option>
                        <option value="percent"> Por Porcentaje (%)</option>
                        <option value="equal"> Partes Iguales (N divisiones)</option>
                        <option value="proportional"> Proporcional (Ej: 60/40)</option>
                        <option value="width"> Por Ancho/Frente (m)</option>
                        <option value="strips"> Franjas Paralelas</option>
                    </select>
                </div>
                <!-- MODO: POR REA -->
                <div id="bisect-mode-area" class="bisect-mode-panel">
                    <div class="form-row">
                        <div class="form-group" style="margin:0"><label class="form-label">rea Deseada (Ha)</label><input type="number" class="form-input" id="bisect-area" value="1.0" min="0.01" step="0.01" oninput="BisectEngine.preview()"></div>
                        <div class="form-group" style="margin:0"><label class="form-label">Tolerancia (%)</label><input type="number" class="form-input" id="bisect-tolerance" value="2" min="0.1" max="10" step="0.1"></div>
                    </div>
                </div>
                <!-- MODO: POR PORCENTAJE -->
                <div id="bisect-mode-percent" class="bisect-mode-panel" style="display:none;">
                    <div class="form-group"><label class="form-label">Porcentaje Primera Parte: <span id="bisect-pct-val" style="color:#a855f7;font-weight:700;">50%</span></label><input type="range" class="range" id="bisect-percent" min="10" max="90" value="50" oninput="$('bisect-pct-val').textContent=this.value+'%';BisectEngine.preview()"></div>
                    <div style="display:flex;justify-content:space-between;font-size:10px;color:var(--text-3);"><span>Parte A: <span id="bisect-pct-a">50%</span></span><span>Parte B: <span id="bisect-pct-b">50%</span></span></div>
                </div>
                <!-- MODO: PARTES IGUALES -->
                <div id="bisect-mode-equal" class="bisect-mode-panel" style="display:none;">
                    <div class="form-group"><label class="form-label">Nmero de Partes</label><div class="range-grp"><input type="range" class="range" id="bisect-parts" min="2" max="10" value="2" oninput="$('bisect-parts-val').textContent=this.value;BisectEngine.preview()"><span id="bisect-parts-val" style="min-width:30px;text-align:center;color:#a855f7;font-weight:700;">2</span></div></div>
                    <div id="bisect-equal-preview" style="font-size:11px;color:var(--text-2);text-align:center;padding:8px;background:var(--bg-glass);border-radius:4px;"></div>
                </div>
                <!-- MODO: PROPORCIONAL -->
                <div id="bisect-mode-proportional" class="bisect-mode-panel" style="display:none;">
                    <div class="form-group"><label class="form-label">Proporcin (separado por /)</label><input type="text" class="form-input" id="bisect-ratio" value="60/40" placeholder="Ej: 60/40, 70/30, 50/30/20" oninput="BisectEngine.preview()"></div>
                    <div id="bisect-ratio-preview" style="font-size:11px;color:var(--text-2);padding:8px;background:var(--bg-glass);border-radius:4px;margin-top:8px;"></div>
                </div>
                <!-- MODO: POR ANCHO -->
                <div id="bisect-mode-width" class="bisect-mode-panel" style="display:none;">
                    <div class="form-row">
                        <div class="form-group" style="margin:0"><label class="form-label">Ancho/Frente (m)</label><input type="number" class="form-input" id="bisect-width" value="50" min="1" step="1" oninput="BisectEngine.preview()"></div>
                        <div class="form-group" style="margin:0"><label class="form-label">Desde</label><select class="form-input" id="bisect-width-from"><option value="left">Izquierda</option><option value="right">Derecha</option><option value="top">Arriba</option><option value="bottom">Abajo</option></select></div>
                    </div>
                </div>
                <!-- MODO: FRANJAS PARALELAS -->
                <div id="bisect-mode-strips" class="bisect-mode-panel" style="display:none;">
                    <div class="form-row">
                        <div class="form-group" style="margin:0"><label class="form-label">Ancho Franja (m)</label><input type="number" class="form-input" id="bisect-strip-width" value="20" min="1" step="1" oninput="BisectEngine.preview()"></div>
                        <div class="form-group" style="margin:0"><label class="form-label">Mx. Franjas</label><input type="number" class="form-input" id="bisect-strip-max" value="10" min="2" max="50"></div>
                    </div>
                    <div class="toggle-row" style="margin:8px 0;"><div class="toggle-lbl">Incluir Remanente</div><label class="switch"><input type="checkbox" id="bisect-strip-remainder" checked><span class="slider"></span></label></div>
                </div>
                <div class="section-lbl" style="color:#8b5cf6;"><i class="fa-solid fa-compass"></i> Orientacin del Corte</div>
                <div class="form-group"><label class="form-label">Azimut de Corte ()</label><div class="range-grp"><input type="range" class="range" id="bisect-angle" min="0" max="180" value="0" oninput="BisectEngine.updateAngle(this.value)"><input type="number" class="range-val" id="bisect-angle-n" value="0" min="0" max="180" oninput="BisectEngine.updateAngle(this.value)"></div></div>
                <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:4px;margin-bottom:12px;">
                    <button class="btn btn-2" style="padding:6px;font-size:10px;" onclick="BisectEngine.updateAngle(0)">N-S 0</button>
                    <button class="btn btn-2" style="padding:6px;font-size:10px;" onclick="BisectEngine.updateAngle(45)">NE 45</button>
                    <button class="btn btn-2" style="padding:6px;font-size:10px;" onclick="BisectEngine.updateAngle(90)">E-W 90</button>
                    <button class="btn btn-2" style="padding:6px;font-size:10px;" onclick="BisectEngine.updateAngle(135)">SE 135</button>
                </div>
                <div class="toggle-row" style="margin:8px 0;"><div class="toggle-lbl"><i class="fa-solid fa-eye"></i> Vista Previa en Tiempo Real</div><label class="switch"><input type="checkbox" id="bisect-preview-on" checked onchange="BisectEngine.togglePreview()"><span class="slider"></span></label></div>
                <button class="btn" style="background:linear-gradient(135deg,#a855f7,#7c3aed);" onclick="BisectEngine.execute()"><i class="fa-solid fa-scissors"></i> EJECUTAR DIVISIN</button>
                <div id="bisect-results" style="display:none;margin-top:16px;">
                    <div style="background:var(--bg-glass);border:1px solid #a855f7;border-radius:8px;padding:12px;">
                        <div class="section-lbl" style="margin:0 0 10px 0;color:#a855f7;"><i class="fa-solid fa-chart-pie"></i> RESULTADO DE LA DIVISIN</div>
                        <div id="bisect-results-content"></div>
                        <div style="margin-top:12px;padding-top:12px;border-top:1px solid var(--border);">
                            <div style="display:flex;justify-content:space-between;align-items:center;">
                                <span style="font-size:11px;color:var(--text-3);">Precisin del corte:</span>
                                <span id="bisect-precision" style="font-size:12px;font-weight:700;color:#22c55e;">0.00%</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="section-lbl" style="color:#7c3aed;margin-top:16px;"><i class="fa-solid fa-magic"></i> Herramientas Adicionales</div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
                    <button class="btn btn-2" onclick="BisectEngine.autoOptimalAngle()"><i class="fa-solid fa-wand-magic-sparkles"></i> ngulo ptimo</button>
                    <button class="btn btn-2" onclick="BisectEngine.followBoundary()"><i class="fa-solid fa-route"></i> Seguir Lindero</button>
                </div>
                <button class="btn btn-2" style="margin-top:8px;" onclick="BisectEngine.clearPreview()"><i class="fa-solid fa-eye-slash"></i> Limpiar Vista Previa</button>
            </div>
            <div id="subdiv-slicer" class="tab-content">
                <div style="background:linear-gradient(135deg, rgba(236,72,153,0.2), rgba(139,92,246,0.15));border:1px solid #ec4899;border-radius:8px;padding:12px;margin-bottom:12px;">
                    <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
                        <i class="fa-solid fa-wand-magic-sparkles" style="color:#ec4899;font-size:16px;"></i>
                        <span style="font-weight:700;font-size:12px;color:#fff;text-transform:uppercase;letter-spacing:0.5px;">OMEGA SLICER</span>
                    </div>
                    <p style="font-size:10px;color:var(--text-2);margin:0;">Corte deslizante dinmico con previsualizacin en tiempo real</p>
                </div>
                <div class="form-group">
                    <label class="form-label"><i class="fa-solid fa-sliders-h" style="color:#ec4899;margin-right:4px;"></i> Posicin de Corte</label>
                    <input type="range" class="range" id="slicer-pos" min="1" max="99" value="50" style="width:100%;accent-color:#ec4899;" oninput="SlicerEngine.preview()">
                    <div style="display:flex;justify-content:space-between;margin-top:6px;">
                        <span style="font-size:10px;color:var(--text-3);">0%</span>
                        <span id="slicer-pos-val" style="font-size:14px;font-weight:800;color:#ec4899;">50%</span>
                        <span style="font-size:10px;color:var(--text-3);">100%</span>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label"><i class="fa-solid fa-rotate" style="color:#a78bfa;margin-right:4px;"></i> ngulo de Rotacin ()</label>
                    <div class="range-grp">
                        <input type="range" class="range" id="slicer-angle" min="0" max="180" value="0" oninput="SlicerEngine.syncAngle(this.value)">
                        <input type="number" class="range-val" id="slicer-angle-n" value="0" min="0" max="180" oninput="SlicerEngine.syncAngle(this.value)">
                    </div>
                </div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin:16px 0;">
                    <div style="background:linear-gradient(135deg,rgba(34,211,238,0.2),rgba(34,211,238,0.05));border:1px solid var(--cyan);border-radius:8px;padding:12px;text-align:center;">
                        <div style="font-size:9px;color:var(--cyan);text-transform:uppercase;font-weight:600;letter-spacing:0.5px;">PARTE A</div>
                        <div id="slicer-area-a" style="font-size:22px;font-weight:800;color:#22d3ee;font-family:monospace;">0.0000</div>
                        <div style="font-size:9px;color:var(--text-3);">Hectreas</div>
                    </div>
                    <div style="background:linear-gradient(135deg,rgba(251,191,36,0.2),rgba(251,191,36,0.05));border:1px solid var(--warning);border-radius:8px;padding:12px;text-align:center;">
                        <div style="font-size:9px;color:var(--warning);text-transform:uppercase;font-weight:600;letter-spacing:0.5px;">PARTE B</div>
                        <div id="slicer-area-b" style="font-size:22px;font-weight:800;color:#fbbf24;font-family:monospace;">0.0000</div>
                        <div style="font-size:9px;color:var(--text-3);">Hectreas</div>
                    </div>
                </div>
                <div style="background:var(--bg-glass);border-radius:6px;padding:10px;margin-bottom:12px;">
                    <div style="display:flex;justify-content:space-between;align-items:center;">
                        <span style="font-size:10px;color:var(--text-2);">Proporcin A/B:</span>
                        <span id="slicer-ratio" style="font-size:12px;font-weight:700;color:#fff;font-family:monospace;">50% / 50%</span>
                    </div>
                    <div style="height:6px;background:var(--bg-input);border-radius:3px;margin-top:8px;overflow:hidden;display:flex;">
                        <div id="slicer-bar-a" style="width:50%;background:linear-gradient(90deg,#22d3ee,#06b6d4);transition:width 0.15s;"></div>
                        <div id="slicer-bar-b" style="flex:1;background:linear-gradient(90deg,#fbbf24,#f59e0b);transition:width 0.15s;"></div>
                    </div>
                </div>
                <button class="btn" style="background:linear-gradient(135deg,#ec4899,#be185d);" onclick="SlicerEngine.apply()"><i class="fa-solid fa-scissors"></i> APLICAR CORTE</button>
                <button class="btn btn-2" onclick="SlicerEngine.clearPreview()" style="margin-top:8px;"><i class="fa-solid fa-eye-slash"></i> Limpiar Vista Previa</button>
            </div>
            <div id="subdiv-fusion" class="tab-content">
                <div class="fusion-bar" id="fusion-bar"><div style="display:flex;justify-content:space-between;align-items:center;"><div><div class="form-label">Lotes Seleccionados</div><div class="fusion-count" id="sel-count">0</div></div><button class="btn btn-cyan" style="width:auto;" onclick="SelectMgr.merge()"><i class="fa-solid fa-compress-arrows-alt"></i> FUSIONAR</button></div></div>
                <p style="font-size:11px;color:var(--text-2);">Activa este modo y haz clic en los lotes para seleccionarlos y fusionarlos.</p>
            </div>
            <!-- TAB CATASTRO: Nomenclatura + Lotes Fijos -->
            <div id="subdiv-cadastre" class="tab-content">
                <div style="background:linear-gradient(135deg,rgba(16,185,129,0.2),rgba(5,150,105,0.15));border:1px solid #10b981;border-radius:8px;padding:12px;margin-bottom:12px;">
                    <div style="display:flex;align-items:center;gap:8px;margin-bottom:5px;">
                        <i class="fa-solid fa-map-location-dot" style="color:#10b981;font-size:16px;"></i>
                        <span style="font-weight:700;font-size:12px;color:#fff;text-transform:uppercase;letter-spacing:0.5px;">NOMENCLATURA CATASTRAL</span>
                    </div>
                    <p style="font-size:10px;color:var(--text-2);margin:0;">Asigna cdigos catastrales automticos a cada lote generado</p>
                </div>
                <div class="form-group"><label class="form-label">Formato de Cdigo</label><select class="form-input" id="cadastre-format" onchange="CadastreEngine.updatePreview()"><option value="MZ-LT">MZ-##-LT-### (Manzana-Lote)</option><option value="SEC-BLQ-PAR">SEC-##-BLQ-##-PAR-### (Sector-Bloque-Parcela)</option><option value="CUSTOM">Personalizado</option></select></div>
                <div id="cadastre-custom" style="display:none;">
                    <div class="form-group"><label class="form-label">Prefijo Personalizado</label><input type="text" class="form-input" id="cadastre-prefix" value="LOTE-" placeholder="Ej: LOTE-, PAR-, etc." oninput="CadastreEngine.updatePreview()"></div>
                </div>
                <div class="form-row">
                    <div class="form-group" style="margin:0"><label class="form-label">Manzana/Sector</label><input type="text" class="form-input" id="cadastre-mz" value="01" oninput="CadastreEngine.updatePreview()"></div>
                    <div class="form-group" style="margin:0"><label class="form-label">Inicio Numeracin</label><input type="number" class="form-input" id="cadastre-start" value="1" min="1" oninput="CadastreEngine.updatePreview()"></div>
                </div>
                <div class="form-group"><label class="form-label">Direccin de Numeracin</label><select class="form-input" id="cadastre-direction"><option value="row-ltr">Filas: Izq  Der, Arriba  Abajo</option><option value="row-rtl">Filas: Der  Izq, Arriba  Abajo</option><option value="col-ttb">Columnas: Arriba  Abajo, Izq  Der</option><option value="snake">Serpentina (Zig-Zag)</option></select></div>
                <div style="background:var(--bg-glass);border:1px solid var(--border);border-radius:6px;padding:10px;margin:12px 0;">
                    <div style="font-size:10px;color:var(--text-3);margin-bottom:5px;">VISTA PREVIA DEL CDIGO:</div>
                    <div id="cadastre-preview" style="font-family:monospace;font-size:14px;color:#10b981;font-weight:700;">MZ-01-LT-001</div>
                </div>
                <button class="btn" style="background:linear-gradient(135deg,#10b981,#059669);" onclick="CadastreEngine.apply()"><i class="fa-solid fa-tags"></i> APLICAR NOMENCLATURA</button>
                <button class="btn btn-2" style="margin-top:8px;" onclick="CadastreEngine.exportTable()"><i class="fa-solid fa-file-csv"></i> EXPORTAR CUADRO DE REAS</button>
                <hr style="border:0;border-top:2px dashed #f59e0b;margin:20px 0;">
                <div style="background:linear-gradient(135deg,rgba(251,191,36,0.2),rgba(245,158,11,0.15));border:1px solid #fbbf24;border-radius:8px;padding:12px;margin-bottom:12px;">
                    <div style="display:flex;align-items:center;gap:8px;margin-bottom:5px;">
                        <i class="fa-solid fa-ruler-combined" style="color:#fbbf24;font-size:16px;"></i>
                        <span style="font-weight:700;font-size:12px;color:#fff;text-transform:uppercase;letter-spacing:0.5px;">LOTES CON DIMENSIONES FIJAS</span>
                    </div>
                    <p style="font-size:10px;color:var(--text-2);margin:0;">Define dimensiones exactas del lote. El sistema calcula cuntos caben + remanente.</p>
                </div>
                <div class="form-row">
                    <div class="form-group" style="margin:0"><label class="form-label">Frente (m)</label><input type="number" class="form-input" id="fixed-width" value="15" min="1" step="0.5" oninput="FixedLotsEngine.preview()"></div>
                    <div class="form-group" style="margin:0"><label class="form-label">Fondo (m)</label><input type="number" class="form-input" id="fixed-depth" value="30" min="1" step="0.5" oninput="FixedLotsEngine.preview()"></div>
                </div>
                <div class="form-group"><label class="form-label">Rotacin ()</label><div class="range-grp"><input type="range" class="range" id="fixed-angle" min="0" max="360" value="0" oninput="FixedLotsEngine.updateAngle(this.value)"><input type="number" class="range-val" id="fixed-angle-n" value="0" oninput="FixedLotsEngine.updateAngle(this.value)"></div></div>
                <div class="form-row">
                    <div class="form-group" style="margin:0"><label class="form-label">Vialidad H (m)</label><input type="number" class="form-input" id="fixed-alley-h" value="0" min="0" step="0.5" oninput="FixedLotsEngine.preview()"></div>
                    <div class="form-group" style="margin:0"><label class="form-label">Cada X Filas</label><input type="number" class="form-input" id="fixed-alley-freq-h" value="2" min="1" oninput="FixedLotsEngine.preview()"></div>
                </div>
                <div class="form-row">
                    <div class="form-group" style="margin:0"><label class="form-label">Vialidad V (m)</label><input type="number" class="form-input" id="fixed-alley-v" value="0" min="0" step="0.5" oninput="FixedLotsEngine.preview()"></div>
                    <div class="form-group" style="margin:0"><label class="form-label">Cada X Cols</label><input type="number" class="form-input" id="fixed-alley-freq-v" value="2" min="1" oninput="FixedLotsEngine.preview()"></div>
                </div>
                <div style="background:var(--bg-glass);border:1px solid var(--border);border-radius:6px;padding:10px;margin:12px 0;">
                    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;text-align:center;">
                        <div><div style="font-size:10px;color:var(--text-3);">LOTES</div><div id="fixed-lot-count" style="font-size:18px;font-weight:800;color:#fbbf24;">0</div></div>
                        <div><div style="font-size:10px;color:var(--text-3);">REA LOTE</div><div id="fixed-lot-area" style="font-size:14px;font-weight:700;color:#10b981;">0 m</div></div>
                        <div><div style="font-size:10px;color:var(--text-3);">REMANENTE</div><div id="fixed-remainder" style="font-size:14px;font-weight:700;color:#ef4444;">0 m</div></div>
                    </div>
                </div>
                <button class="btn btn-warning" onclick="FixedLotsEngine.apply()"><i class="fa-solid fa-border-all"></i> GENERAR LOTES FIJOS</button>
            </div>
            <!-- TAB RESERVAS: reas Reservadas Internas -->
            <div id="subdiv-reserves" class="tab-content">
                <div style="background:linear-gradient(135deg,rgba(239,68,68,0.2),rgba(220,38,38,0.15));border:1px solid #ef4444;border-radius:8px;padding:12px;margin-bottom:12px;">
                    <div style="display:flex;align-items:center;gap:8px;margin-bottom:5px;">
                        <i class="fa-solid fa-tree" style="color:#ef4444;font-size:16px;"></i>
                        <span style="font-weight:700;font-size:12px;color:#fff;text-transform:uppercase;letter-spacing:0.5px;">REAS RESERVADAS INTERNAS</span>
                    </div>
                    <p style="font-size:10px;color:var(--text-2);margin:0;">Dibuja zonas que se excluirn de la subdivisin (reas verdes, equipamiento, etc.)</p>
                </div>
                <div class="form-group"><label class="form-label">Tipo de Reserva</label><select class="form-input" id="reserve-type"><option value="green"> rea Verde</option><option value="equipment"> Equipamiento Urbano</option><option value="water"> Cuerpo de Agua</option><option value="road"> Vialidad Principal</option><option value="utility"> Servicios Pblicos</option><option value="custom"> Personalizado</option></select></div>
                <div id="reserve-custom-name" style="display:none;"><div class="form-group"><label class="form-label">Nombre Personalizado</label><input type="text" class="form-input" id="reserve-name" placeholder="Ej: Plaza Central"></div></div>
                <div class="form-group"><label class="form-label">Porcentaje Mnimo Normativo (%)</label><input type="number" class="form-input" id="reserve-min-pct" value="10" min="0" max="50" step="0.5"></div>
                <button class="btn" style="background:linear-gradient(135deg,#ef4444,#dc2626);" onclick="ReserveEngine.startDraw()"><i class="fa-solid fa-draw-polygon"></i> DIBUJAR REA RESERVADA</button>
                <button class="btn btn-2" style="margin-top:8px;" onclick="ReserveEngine.importFromSelection()"><i class="fa-solid fa-object-group"></i> CONVERTIR LOTES SELECCIONADOS</button>
                <div id="reserves-list" style="margin-top:16px;"></div>
                <div id="reserves-summary" style="display:none;background:var(--bg-glass);border:1px solid var(--border);border-radius:6px;padding:12px;margin-top:12px;">
                    <div class="section-lbl" style="margin:0 0 10px 0;color:#ef4444;"><i class="fa-solid fa-chart-pie"></i> RESUMEN DE REAS</div>
                    <table class="data-table" style="font-size:11px;">
                        <thead><tr><th>Tipo</th><th>rea (m)</th><th>%</th></tr></thead>
                        <tbody id="reserves-table"></tbody>
                        <tfoot style="border-top:2px solid var(--border);">
                            <tr><td style="font-weight:700;">TOTAL RESERVADO</td><td id="total-reserved-area" style="font-weight:700;color:#ef4444;">0</td><td id="total-reserved-pct" style="font-weight:700;color:#ef4444;">0%</td></tr>
                            <tr><td style="font-weight:700;">REA LOTEABLE</td><td id="total-loteable-area" style="font-weight:700;color:#10b981;">0</td><td id="total-loteable-pct" style="font-weight:700;color:#10b981;">0%</td></tr>
                        </tfoot>
                    </table>
                    <div id="reserve-compliance" style="margin-top:10px;padding:8px;border-radius:4px;text-align:center;font-weight:700;font-size:11px;"></div>
                </div>
                <button class="btn btn-2" style="margin-top:12px;" onclick="ReserveEngine.clearAll()"><i class="fa-solid fa-trash"></i> ELIMINAR TODAS LAS RESERVAS</button>
            </div>
            <!-- TAB SURCOS: Planificador de Surcos Agrcolas -->
            <div id="subdiv-furrows" class="tab-content">
                <div style="background:linear-gradient(135deg,rgba(34,197,94,0.2),rgba(22,163,74,0.15));border:1px solid #22c55e;border-radius:8px;padding:12px;margin-bottom:12px;">
                    <div style="display:flex;align-items:center;gap:8px;margin-bottom:5px;">
                        <i class="fa-solid fa-tractor" style="color:#22c55e;font-size:16px;"></i>
                        <span style="font-weight:700;font-size:12px;color:#fff;text-transform:uppercase;letter-spacing:0.5px;">PLANIFICADOR DE SURCOS AGRCOLAS</span>
                    </div>
                    <p style="font-size:10px;color:var(--text-2);margin:0;">Genera lneas de siembra paralelas con separacin configurable</p>
                </div>
                <div class="section-lbl" style="color:#22c55e;"><i class="fa-solid fa-seedling"></i> Configuracin de Surcos</div>
                <div class="form-row">
                    <div class="form-group" style="margin:0"><label class="form-label">Separacin (m)</label><input type="number" class="form-input" id="furrow-spacing" value="0.80" min="0.1" max="50" step="0.05" oninput="FurrowEngine.preview()"></div>
                    <div class="form-group" style="margin:0"><label class="form-label">Ancho Surco (m)</label><input type="number" class="form-input" id="furrow-width" value="0.30" min="0.05" max="5" step="0.05"></div>
                </div>
                <div class="form-group"><label class="form-label">Orientacin de Siembra ()</label><div class="range-grp"><input type="range" class="range" id="furrow-angle" min="0" max="180" value="0" oninput="FurrowEngine.updateAngle(this.value)"><input type="number" class="range-val" id="furrow-angle-n" value="0" min="0" max="180" oninput="FurrowEngine.updateAngle(this.value)"></div></div>
                <div class="form-group"><label class="form-label">Tipo de Cultivo</label><select class="form-input" id="furrow-crop" onchange="FurrowEngine.setCropDefaults()"><option value="custom">Personalizado</option><option value="maiz"> Maz (0.80m)</option><option value="soya"> Soya (0.50m)</option><option value="cafe"> Caf (2.00m)</option><option value="cana"> Caa (1.50m)</option><option value="hortaliza"> Hortalizas (0.40m)</option><option value="papa"> Papa (0.90m)</option><option value="tomate"> Tomate (1.20m)</option><option value="pasto"> Pastos (0.20m)</option></select></div>
                <div class="section-lbl" style="color:#16a34a;"><i class="fa-solid fa-ruler"></i> Cabeceras y Bordes</div>
                <div class="form-row">
                    <div class="form-group" style="margin:0"><label class="form-label">Cabecera Inicio (m)</label><input type="number" class="form-input" id="furrow-head-start" value="5" min="0" max="50" step="0.5" oninput="FurrowEngine.preview()"></div>
                    <div class="form-group" style="margin:0"><label class="form-label">Cabecera Final (m)</label><input type="number" class="form-input" id="furrow-head-end" value="5" min="0" max="50" step="0.5" oninput="FurrowEngine.preview()"></div>
                </div>
                <div class="form-row">
                    <div class="form-group" style="margin:0"><label class="form-label">Margen Izq. (m)</label><input type="number" class="form-input" id="furrow-margin-left" value="2" min="0" max="20" step="0.5" oninput="FurrowEngine.preview()"></div>
                    <div class="form-group" style="margin:0"><label class="form-label">Margen Der. (m)</label><input type="number" class="form-input" id="furrow-margin-right" value="2" min="0" max="20" step="0.5" oninput="FurrowEngine.preview()"></div>
                </div>
                <div class="toggle-row" style="margin:12px 0;"><div class="toggle-lbl"><i class="fa-solid fa-eye"></i> Mostrar Vista Previa</div><label class="switch"><input type="checkbox" id="furrow-preview-on" checked onchange="FurrowEngine.togglePreview()"><span class="slider"></span></label></div>
                <button class="btn" style="background:linear-gradient(135deg,#22c55e,#16a34a);" onclick="FurrowEngine.generate()"><i class="fa-solid fa-tractor"></i> GENERAR SURCOS</button>
                <div id="furrow-stats" style="display:none;background:var(--bg-glass);border:1px solid var(--border);border-radius:6px;padding:12px;margin-top:12px;">
                    <div class="section-lbl" style="margin:0 0 10px 0;color:#22c55e;"><i class="fa-solid fa-chart-bar"></i> ESTADSTICAS DE SIEMBRA</div>
                    <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:8px;">
                        <div style="text-align:center;padding:10px;background:rgba(0,0,0,0.2);border-radius:6px;">
                            <div style="font-size:10px;color:var(--text-3);">SURCOS GENERADOS</div>
                            <div id="furrow-count" style="font-size:22px;font-weight:800;color:#22c55e;">0</div>
                        </div>
                        <div style="text-align:center;padding:10px;background:rgba(0,0,0,0.2);border-radius:6px;">
                            <div style="font-size:10px;color:var(--text-3);">LONGITUD TOTAL</div>
                            <div id="furrow-length" style="font-size:22px;font-weight:800;color:#fbbf24;">0 m</div>
                        </div>
                        <div style="text-align:center;padding:10px;background:rgba(0,0,0,0.2);border-radius:6px;">
                            <div style="font-size:10px;color:var(--text-3);">REA CULTIVABLE</div>
                            <div id="furrow-area" style="font-size:18px;font-weight:800;color:#3b82f6;">0 Ha</div>
                        </div>
                        <div style="text-align:center;padding:10px;background:rgba(0,0,0,0.2);border-radius:6px;">
                            <div style="font-size:10px;color:var(--text-3);">PLANTAS ESTIMADAS</div>
                            <div id="furrow-plants" style="font-size:18px;font-weight:800;color:#a78bfa;">0</div>
                        </div>
                    </div>
                </div>
                <div id="furrow-export" style="display:none;margin-top:12px;">
                    <div class="section-lbl" style="color:#059669;"><i class="fa-solid fa-download"></i> Exportar Surcos</div>
                    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:6px;">
                        <button class="btn btn-2" onclick="FurrowEngine.exportKML()" title="Google Earth/GPS"><i class="fa-solid fa-earth-americas"></i> KML</button>
                        <button class="btn btn-2" onclick="FurrowEngine.exportGeoJSON()" title="QGIS/GIS"><i class="fa-solid fa-code"></i> GeoJSON</button>
                        <button class="btn btn-2" onclick="FurrowEngine.exportDXF()" title="AutoCAD"><i class="fa-solid fa-drafting-compass"></i> DXF</button>
                    </div>
                    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:6px;margin-top:6px;">
                        <button class="btn btn-2" onclick="FurrowEngine.exportCSV()" title="Excel"><i class="fa-solid fa-file-csv"></i> CSV</button>
                        <button class="btn btn-2" onclick="FurrowEngine.exportGPX()" title="GPS Campo"><i class="fa-solid fa-location-crosshairs"></i> GPX</button>
                        <button class="btn btn-2" onclick="FurrowEngine.exportPDF()" title="Reporte PDF"><i class="fa-solid fa-file-pdf"></i> PDF</button>
                    </div>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-top:6px;">
                        <button class="btn btn-2" onclick="FurrowEngine.exportTXT()" title="Reporte texto"><i class="fa-solid fa-file-lines"></i> Reporte TXT</button>
                        <button class="btn btn-2" onclick="FurrowEngine.copyToClipboard()" title="Copiar datos"><i class="fa-solid fa-copy"></i> Copiar</button>
                    </div>
                </div>
                <button class="btn btn-2" style="margin-top:12px;" onclick="FurrowEngine.clear()"><i class="fa-solid fa-trash"></i> LIMPIAR SURCOS</button>
            </div>
            <!-- TAB PENDIENTES: Analizador de Pendientes -->
            <div id="subdiv-slopes" class="tab-content">
                <div style="background:linear-gradient(135deg,rgba(245,158,11,0.2),rgba(217,119,6,0.15));border:1px solid #f59e0b;border-radius:8px;padding:12px;margin-bottom:12px;">
                    <div style="display:flex;align-items:center;gap:8px;margin-bottom:5px;">
                        <i class="fa-solid fa-mountain" style="color:#f59e0b;font-size:16px;"></i>
                        <span style="font-weight:700;font-size:12px;color:#fff;text-transform:uppercase;letter-spacing:0.5px;">ANALIZADOR DE PENDIENTES</span>
                    </div>
                    <p style="font-size:10px;color:var(--text-2);margin:0;">Analiza el terreno y clasifica zonas segn inclinacin</p>
                </div>
                <div class="section-lbl" style="color:#f59e0b;"><i class="fa-solid fa-sliders"></i> Configuracin de Anlisis</div>
                <div class="form-group"><label class="form-label">Resolucin de Muestreo</label><select class="form-input" id="slope-resolution"><option value="10">Alta (10m) - Ms preciso</option><option value="25" selected>Media (25m) - Recomendado</option><option value="50">Baja (50m) - Ms rpido</option></select></div>
                <div class="form-group"><label class="form-label">Fuente de Elevacin</label><select class="form-input" id="slope-source"><option value="srtm">SRTM (30m global)</option><option value="manual">Puntos manuales</option></select></div>
                <div class="section-lbl" style="color:#d97706;"><i class="fa-solid fa-layer-group"></i> Clasificacin de Pendientes</div>
                <div style="background:var(--bg-glass);border-radius:6px;padding:10px;margin-bottom:12px;">
                    <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;padding:6px;background:rgba(34,197,94,0.2);border-radius:4px;border-left:4px solid #22c55e;">
                        <span style="font-size:11px;color:#22c55e;font-weight:700;width:80px;">0% - 5%</span>
                        <span style="font-size:10px;color:var(--text-2);flex:1;">PLANO - Ideal para cualquier cultivo</span>
                    </div>
                    <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;padding:6px;background:rgba(251,191,36,0.2);border-radius:4px;border-left:4px solid #fbbf24;">
                        <span style="font-size:11px;color:#fbbf24;font-weight:700;width:80px;">5% - 15%</span>
                        <span style="font-size:10px;color:var(--text-2);flex:1;">SUAVE - Cultivos con curvas de nivel</span>
                    </div>
                    <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;padding:6px;background:rgba(249,115,22,0.2);border-radius:4px;border-left:4px solid #f97316;">
                        <span style="font-size:11px;color:#f97316;font-weight:700;width:80px;">15% - 30%</span>
                        <span style="font-size:10px;color:var(--text-2);flex:1;">MODERADO - Pastos o terrazas</span>
                    </div>
                    <div style="display:flex;align-items:center;gap:8px;padding:6px;background:rgba(239,68,68,0.2);border-radius:4px;border-left:4px solid #ef4444;">
                        <span style="font-size:11px;color:#ef4444;font-weight:700;width:80px;">&gt; 30%</span>
                        <span style="font-size:10px;color:var(--text-2);flex:1;">FUERTE - Conservacin/Bosque</span>
                    </div>
                </div>
                <button class="btn" style="background:linear-gradient(135deg,#f59e0b,#d97706);" onclick="SlopeEngine.analyze()"><i class="fa-solid fa-mountain"></i> ANALIZAR PENDIENTES</button>
                <div id="slope-results" style="display:none;margin-top:16px;">
                    <div style="background:var(--bg-glass);border:1px solid #f59e0b;border-radius:8px;padding:16px;">
                        <div class="section-lbl" style="margin:0 0 12px 0;color:#f59e0b;"><i class="fa-solid fa-chart-pie"></i> DISTRIBUCIN DEL TERRENO</div>
                        <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:8px;">
                            <div style="text-align:center;padding:10px;background:rgba(34,197,94,0.2);border-radius:6px;border:1px solid #22c55e;">
                                <div style="font-size:10px;color:#22c55e;">PLANO (0-5%)</div>
                                <div id="slope-flat-pct" style="font-size:20px;font-weight:800;color:#22c55e;">0%</div>
                                <div id="slope-flat-ha" style="font-size:10px;color:var(--text-3);">0 Ha</div>
                            </div>
                            <div style="text-align:center;padding:10px;background:rgba(251,191,36,0.2);border-radius:6px;border:1px solid #fbbf24;">
                                <div style="font-size:10px;color:#fbbf24;">SUAVE (5-15%)</div>
                                <div id="slope-gentle-pct" style="font-size:20px;font-weight:800;color:#fbbf24;">0%</div>
                                <div id="slope-gentle-ha" style="font-size:10px;color:var(--text-3);">0 Ha</div>
                            </div>
                            <div style="text-align:center;padding:10px;background:rgba(249,115,22,0.2);border-radius:6px;border:1px solid #f97316;">
                                <div style="font-size:10px;color:#f97316;">MODERADO (15-30%)</div>
                                <div id="slope-moderate-pct" style="font-size:20px;font-weight:800;color:#f97316;">0%</div>
                                <div id="slope-moderate-ha" style="font-size:10px;color:var(--text-3);">0 Ha</div>
                            </div>
                            <div style="text-align:center;padding:10px;background:rgba(239,68,68,0.2);border-radius:6px;border:1px solid #ef4444;">
                                <div style="font-size:10px;color:#ef4444;">FUERTE (&gt;30%)</div>
                                <div id="slope-steep-pct" style="font-size:20px;font-weight:800;color:#ef4444;">0%</div>
                                <div id="slope-steep-ha" style="font-size:10px;color:var(--text-3);">0 Ha</div>
                            </div>
                        </div>
                        <div style="margin-top:12px;padding:12px;background:rgba(0,0,0,0.3);border-radius:6px;">
                            <div style="display:flex;justify-content:space-between;margin-bottom:8px;">
                                <span style="font-size:11px;color:var(--text-3);">Pendiente Promedio:</span>
                                <span id="slope-avg" style="font-size:11px;font-weight:700;color:#fff;">0%</span>
                            </div>
                            <div style="display:flex;justify-content:space-between;margin-bottom:8px;">
                                <span style="font-size:11px;color:var(--text-3);">Pendiente Mxima:</span>
                                <span id="slope-max" style="font-size:11px;font-weight:700;color:#ef4444;">0%</span>
                            </div>
                            <div style="display:flex;justify-content:space-between;margin-bottom:8px;">
                                <span style="font-size:11px;color:var(--text-3);">Direccin Principal:</span>
                                <span id="slope-direction" style="font-size:11px;font-weight:700;color:#3b82f6;">N/A</span>
                            </div>
                            <div style="display:flex;justify-content:space-between;">
                                <span style="font-size:11px;color:var(--text-3);">Desnivel Total:</span>
                                <span id="slope-elevation-diff" style="font-size:11px;font-weight:700;color:#a78bfa;">0 m</span>
                            </div>
                        </div>
                        <div id="slope-recommendation" style="margin-top:12px;padding:10px;border-radius:6px;font-size:11px;"></div>
                    </div>
                </div>
                <div id="slope-export" style="display:none;margin-top:12px;">
                    <div class="section-lbl" style="color:#d97706;"><i class="fa-solid fa-download"></i> Exportar Anlisis</div>
                    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:6px;">
                        <button class="btn btn-2" onclick="SlopeEngine.exportKML()" title="Google Earth"><i class="fa-solid fa-earth-americas"></i> KML</button>
                        <button class="btn btn-2" onclick="SlopeEngine.exportGeoJSON()" title="QGIS/GIS"><i class="fa-solid fa-code"></i> GeoJSON</button>
                        <button class="btn btn-2" onclick="SlopeEngine.exportDXF()" title="AutoCAD"><i class="fa-solid fa-drafting-compass"></i> DXF</button>
                    </div>
                    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:6px;margin-top:6px;">
                        <button class="btn btn-2" onclick="SlopeEngine.exportCSV()" title="Excel"><i class="fa-solid fa-file-csv"></i> CSV</button>
                        <button class="btn btn-2" onclick="SlopeEngine.exportGPX()" title="GPS Campo"><i class="fa-solid fa-location-crosshairs"></i> GPX</button>
                        <button class="btn btn-2" onclick="SlopeEngine.exportPDF()" title="Reporte PDF"><i class="fa-solid fa-file-pdf"></i> PDF</button>
                    </div>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-top:6px;">
                        <button class="btn btn-2" onclick="SlopeEngine.exportTXT()" title="Reporte texto"><i class="fa-solid fa-file-lines"></i> Reporte TXT</button>
                        <button class="btn btn-2" onclick="SlopeEngine.copyToClipboard()" title="Copiar datos"><i class="fa-solid fa-copy"></i> Copiar</button>
                    </div>
                </div>
                <button class="btn btn-2" style="margin-top:12px;" onclick="SlopeEngine.clear()"><i class="fa-solid fa-eye-slash"></i> LIMPIAR ANLISIS</button>
            </div>
            <!-- TAB DXF: Exportador AutoCAD -->
            <div id="subdiv-dxf" class="tab-content">
                <div style="background:linear-gradient(135deg,rgba(59,130,246,0.2),rgba(37,99,235,0.15));border:1px solid #3b82f6;border-radius:8px;padding:12px;margin-bottom:12px;">
                    <div style="display:flex;align-items:center;gap:8px;margin-bottom:5px;">
                        <i class="fa-solid fa-drafting-compass" style="color:#3b82f6;font-size:16px;"></i>
                        <span style="font-weight:700;font-size:12px;color:#fff;text-transform:uppercase;letter-spacing:0.5px;">EXPORTADOR DXF (AutoCAD)</span>
                    </div>
                    <p style="font-size:10px;color:var(--text-2);margin:0;">Exporta a formato DXF compatible con AutoCAD, Civil 3D, QGIS</p>
                </div>
                <div class="section-lbl" style="color:#3b82f6;"><i class="fa-solid fa-layer-group"></i> Capas a Exportar</div>
                <div class="toggle-row" style="margin:8px 0;border-left:4px solid #ef4444;"><div class="toggle-lbl"><i class="fa-solid fa-draw-polygon" style="color:#ef4444;"></i> Polgono Principal</div><label class="switch"><input type="checkbox" id="dxf-layer-polygon" checked><span class="slider"></span></label></div>
                <div class="toggle-row" style="margin:8px 0;border-left:4px solid #22c55e;"><div class="toggle-lbl"><i class="fa-solid fa-th-large" style="color:#22c55e;"></i> Subdivisiones/Lotes</div><label class="switch"><input type="checkbox" id="dxf-layer-lots" checked><span class="slider"></span></label></div>
                <div class="toggle-row" style="margin:8px 0;border-left:4px solid #fbbf24;"><div class="toggle-lbl"><i class="fa-solid fa-road" style="color:#fbbf24;"></i> Vialidades</div><label class="switch"><input type="checkbox" id="dxf-layer-roads" checked><span class="slider"></span></label></div>
                <div class="toggle-row" style="margin:8px 0;border-left:4px solid #8b5cf6;"><div class="toggle-lbl"><i class="fa-solid fa-location-dot" style="color:#8b5cf6;"></i> Vrtices con Cotas</div><label class="switch"><input type="checkbox" id="dxf-layer-vertices" checked><span class="slider"></span></label></div>
                <div class="toggle-row" style="margin:8px 0;border-left:4px solid #06b6d4;"><div class="toggle-lbl"><i class="fa-solid fa-font" style="color:#06b6d4;"></i> Etiquetas de Lotes</div><label class="switch"><input type="checkbox" id="dxf-layer-labels" checked><span class="slider"></span></label></div>
                <div class="toggle-row" style="margin:8px 0;border-left:4px solid #ec4899;"><div class="toggle-lbl"><i class="fa-solid fa-tree" style="color:#ec4899;"></i> reas Reservadas</div><label class="switch"><input type="checkbox" id="dxf-layer-reserves"><span class="slider"></span></label></div>
                <div class="section-lbl" style="color:#2563eb;"><i class="fa-solid fa-cog"></i> Opciones de Exportacin</div>
                <div class="form-group"><label class="form-label">Sistema de Coordenadas</label><select class="form-input" id="dxf-coord-system"><option value="geographic">Geogrficas (Lat/Lon)</option><option value="utm" selected>UTM (Este/Norte)</option><option value="local">Locales (desde 0,0)</option></select></div>
                <div class="form-row">
                    <div class="form-group" style="margin:0"><label class="form-label">Zona UTM</label><select class="form-input" id="dxf-utm-zone"><option value="18">18N</option><option value="19" selected>19N</option><option value="20">20N</option><option value="21">21N</option></select></div>
                    <div class="form-group" style="margin:0"><label class="form-label">Precisin Decimal</label><select class="form-input" id="dxf-precision"><option value="2">2 decimales</option><option value="3" selected>3 decimales</option><option value="4">4 decimales</option><option value="6">6 decimales</option></select></div>
                </div>
                <div class="form-group"><label class="form-label">Escala de Texto</label><input type="number" class="form-input" id="dxf-text-scale" value="1.5" min="0.5" max="10" step="0.5"></div>
                <div style="background:var(--bg-glass);border:1px solid var(--border);border-radius:6px;padding:12px;margin:12px 0;">
                    <div style="font-size:10px;color:var(--text-3);margin-bottom:8px;">RESUMEN DE EXPORTACIN</div>
                    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;text-align:center;">
                        <div><div style="font-size:9px;color:var(--text-3);">POLGONO</div><div id="dxf-count-poly" style="font-size:14px;font-weight:700;color:#ef4444;">0</div></div>
                        <div><div style="font-size:9px;color:var(--text-3);">LOTES</div><div id="dxf-count-lots" style="font-size:14px;font-weight:700;color:#22c55e;">0</div></div>
                        <div><div style="font-size:9px;color:var(--text-3);">VRTICES</div><div id="dxf-count-vertices" style="font-size:14px;font-weight:700;color:#8b5cf6;">0</div></div>
                    </div>
                </div>
                <button class="btn" style="background:linear-gradient(135deg,#3b82f6,#2563eb);" onclick="DXFEngine.export()"><i class="fa-solid fa-file-export"></i> EXPORTAR DXF</button>
                <div class="section-lbl" style="color:#64748b;margin-top:16px;"><i class="fa-solid fa-file-lines"></i> Otros Formatos</div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
                    <button class="btn btn-2" onclick="DXFEngine.exportMemoria()"><i class="fa-solid fa-file-alt"></i> Memoria Descriptiva</button>
                    <button class="btn btn-2" onclick="DXFEngine.exportCoordTable()"><i class="fa-solid fa-table"></i> Tabla Coordenadas</button>
                </div>
                <button class="btn btn-2" style="margin-top:8px;" onclick="DXFEngine.exportRumbos()"><i class="fa-solid fa-compass"></i> Cuadro de Rumbos y Distancias</button>
            </div>
            <!-- TAB PERFIL: Perfil de Elevacin -->
            <div id="subdiv-profile" class="tab-content">
                <div style="background:linear-gradient(135deg,rgba(236,72,153,0.2),rgba(219,39,119,0.15));border:1px solid #ec4899;border-radius:8px;padding:12px;margin-bottom:12px;">
                    <div style="display:flex;align-items:center;gap:8px;margin-bottom:5px;">
                        <i class="fa-solid fa-chart-area" style="color:#ec4899;font-size:16px;"></i>
                        <span style="font-weight:700;font-size:12px;color:#fff;text-transform:uppercase;letter-spacing:0.5px;">PERFIL DE ELEVACIN</span>
                    </div>
                    <p style="font-size:10px;color:var(--text-2);margin:0;">Dibuja una lnea en el mapa y visualiza el perfil topogrfico con todos los vrtices</p>
                </div>
                <div class="section-lbl" style="color:#ec4899;"><i class="fa-solid fa-route"></i> Trazar Lnea de Corte</div>
                <button class="btn" style="background:linear-gradient(135deg,#ec4899,#db2777);" onclick="ProfileEngine.startDraw()"><i class="fa-solid fa-pencil"></i> DIBUJAR LNEA DE PERFIL</button>
                <button class="btn btn-2" style="margin-top:8px;" onclick="ProfileEngine.usePolygonPerimeter()"><i class="fa-solid fa-draw-polygon"></i> Usar Permetro del Polgono</button>
                <div class="section-lbl" style="color:#db2777;"><i class="fa-solid fa-cog"></i> Configuracin</div>
                <div class="form-row">
                    <div class="form-group" style="margin:0"><label class="form-label">Puntos de Muestreo</label><input type="number" class="form-input" id="profile-samples" value="50" min="10" max="200" step="10"></div>
                    <div class="form-group" style="margin:0"><label class="form-label">Exageracin V.</label><input type="number" class="form-input" id="profile-exaggeration" value="2" min="1" max="20" step="0.5"></div>
                </div>
                <div id="profile-chart-container" style="display:none;margin-top:16px;">
                    <div style="background:var(--bg-glass);border:1px solid #ec4899;border-radius:8px;padding:12px;">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
                            <span style="font-size:11px;font-weight:700;color:#ec4899;"><i class="fa-solid fa-chart-line"></i> PERFIL TOPOGRFICO</span>
                            <span id="profile-distance" style="font-size:10px;color:var(--text-2);font-weight:600;">Distancia Total: 0 m</span>
                        </div>
                        <canvas id="profile-canvas" style="width:100%;height:220px;background:#0f172a;border-radius:6px;border:1px solid #334155;"></canvas>
                        <div style="display:flex;gap:8px;margin-top:8px;font-size:9px;color:var(--text-3);justify-content:center;">
                            <span><span style="display:inline-block;width:10px;height:10px;background:#22c55e;border-radius:50%;margin-right:3px;"></span>Inicio</span>
                            <span><span style="display:inline-block;width:10px;height:10px;background:#ef4444;border-radius:50%;margin-right:3px;"></span>Fin</span>
                            <span><span style="display:inline-block;width:10px;height:10px;background:#fbbf24;border-radius:50%;margin-right:3px;"></span>Mx</span>
                            <span><span style="display:inline-block;width:10px;height:10px;background:#3b82f6;border-radius:50%;margin-right:3px;"></span>Mn</span>
                        </div>
                        <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-top:12px;">
                            <div style="text-align:center;padding:10px;background:rgba(34,197,94,0.15);border-radius:6px;border:1px solid rgba(34,197,94,0.3);">
                                <div style="font-size:9px;color:#22c55e;"> ELEV. MN</div>
                                <div id="profile-min-elev" style="font-size:15px;font-weight:800;color:#22c55e;">0 m</div>
                            </div>
                            <div style="text-align:center;padding:10px;background:rgba(239,68,68,0.15);border-radius:6px;border:1px solid rgba(239,68,68,0.3);">
                                <div style="font-size:9px;color:#ef4444;"> ELEV. MX</div>
                                <div id="profile-max-elev" style="font-size:15px;font-weight:800;color:#ef4444;">0 m</div>
                            </div>
                            <div style="text-align:center;padding:10px;background:rgba(251,191,36,0.15);border-radius:6px;border:1px solid rgba(251,191,36,0.3);">
                                <div style="font-size:9px;color:#fbbf24;"> DESNIVEL</div>
                                <div id="profile-elevation-diff" style="font-size:15px;font-weight:800;color:#fbbf24;">0 m</div>
                            </div>
                            <div style="text-align:center;padding:10px;background:rgba(167,139,250,0.15);border-radius:6px;border:1px solid rgba(167,139,250,0.3);">
                                <div style="font-size:9px;color:#a78bfa;"> PEND.</div>
                                <div id="profile-avg-slope" style="font-size:15px;font-weight:800;color:#a78bfa;">0%</div>
                            </div>
                        </div>
                        <div id="profile-stats-extra"></div>
                    </div>
                </div>
                <div id="profile-segments" style="display:none;margin-top:12px;">
                    <div class="section-lbl" style="color:#be185d;"><i class="fa-solid fa-table"></i> Tabla de Puntos (con coordenadas)</div>
                    <div style="max-height:250px;overflow-y:auto;background:var(--bg-glass);border-radius:6px;border:1px solid #ec4899;">
                        <table class="data-table" style="font-size:9px;width:100%;">
                            <thead style="position:sticky;top:0;background:#1e1e2e;z-index:10;"><tr><th style="padding:8px 4px;">Pto</th><th>Dist(m)</th><th>Elev(m)</th><th>Lat</th><th>Lng</th><th>Pend%</th></tr></thead>
                            <tbody id="profile-segments-body"></tbody>
                        </table>
                    </div>
                    <div style="margin-top:8px;padding:8px;background:rgba(236,72,153,0.1);border-radius:6px;font-size:9px;color:var(--text-2);">
                        <i class="fa-solid fa-info-circle" style="color:#ec4899;"></i> Los puntos marcados en el mapa muestran:  Inicio,  Fin,  Mximo,  Mnimo
                    </div>
                </div>
                <div id="profile-export" style="display:none;margin-top:12px;">
                    <div class="section-lbl" style="color:#9d174d;"><i class="fa-solid fa-download"></i> Exportar Perfil</div>
                    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:6px;">
                        <button class="btn btn-2" onclick="ProfileEngine.exportKML()" title="Google Earth"><i class="fa-solid fa-earth-americas"></i> KML</button>
                        <button class="btn btn-2" onclick="ProfileEngine.exportGeoJSON()" title="QGIS/GIS"><i class="fa-solid fa-code"></i> GeoJSON</button>
                        <button class="btn btn-2" onclick="ProfileEngine.exportDXF()" title="AutoCAD"><i class="fa-solid fa-drafting-compass"></i> DXF</button>
                    </div>
                    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:6px;margin-top:6px;">
                        <button class="btn btn-2" onclick="ProfileEngine.exportCSV()" title="Excel"><i class="fa-solid fa-file-csv"></i> CSV</button>
                        <button class="btn btn-2" onclick="ProfileEngine.exportGPX()" title="GPS Campo"><i class="fa-solid fa-location-crosshairs"></i> GPX</button>
                        <button class="btn btn-2" onclick="ProfileEngine.exportImage()" title="Imagen"><i class="fa-solid fa-image"></i> PNG</button>
                    </div>
                    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:6px;margin-top:6px;">
                        <button class="btn btn-2" onclick="ProfileEngine.exportPDF()" title="Reporte PDF"><i class="fa-solid fa-file-pdf"></i> PDF</button>
                        <button class="btn btn-2" onclick="ProfileEngine.exportTXT()" title="Reporte texto"><i class="fa-solid fa-file-lines"></i> TXT</button>
                        <button class="btn btn-2" onclick="ProfileEngine.copyToClipboard()" title="Copiar datos"><i class="fa-solid fa-copy"></i> Copiar</button>
                    </div>
                </div>
                <button class="btn btn-2" style="margin-top:12px;" onclick="ProfileEngine.clear()"><i class="fa-solid fa-trash"></i> Limpiar Perfil</button>
            </div>
            <!-- TAB CURVAS: Curvas de Nivel -->
            <div id="subdiv-contours" class="tab-content">
                <div style="background:linear-gradient(135deg,rgba(20,184,166,0.2),rgba(13,148,136,0.15));border:1px solid #14b8a6;border-radius:8px;padding:12px;margin-bottom:12px;">
                    <div style="display:flex;align-items:center;gap:8px;margin-bottom:5px;">
                        <i class="fa-solid fa-mountain-sun" style="color:#14b8a6;font-size:16px;"></i>
                        <span style="font-weight:700;font-size:12px;color:#fff;text-transform:uppercase;letter-spacing:0.5px;">CURVAS DE NIVEL</span>
                    </div>
                    <p style="font-size:10px;color:var(--text-2);margin:0;">Genera isolneas de elevacin automticas sobre el terreno</p>
                </div>
                <div class="section-lbl" style="color:#14b8a6;"><i class="fa-solid fa-sliders"></i> Configuracin</div>
                <div class="form-row">
                    <div class="form-group" style="margin:0"><label class="form-label">Intervalo (m)</label><select class="form-input" id="contour-interval"><option value="1">1 metro</option><option value="2">2 metros</option><option value="5" selected>5 metros</option><option value="10">10 metros</option><option value="20">20 metros</option><option value="50">50 metros</option></select></div>
                    <div class="form-group" style="margin:0"><label class="form-label">Resolucin</label><select class="form-input" id="contour-resolution"><option value="15">Alta (15m)</option><option value="25" selected>Media (25m)</option><option value="50">Baja (50m)</option></select></div>
                </div>
                <div class="form-group"><label class="form-label">Estilo de Curvas</label><select class="form-input" id="contour-style"><option value="standard">Estndar (lneas marrones)</option><option value="color">Por Elevacin (colores)</option><option value="topo">Topogrfico (ndice cada 5)</option></select></div>
                <div class="toggle-row" style="margin:8px 0;"><div class="toggle-lbl"><i class="fa-solid fa-tag"></i> Mostrar Etiquetas de Cota</div><label class="switch"><input type="checkbox" id="contour-labels" checked><span class="slider"></span></label></div>
                <div class="toggle-row" style="margin:8px 0;"><div class="toggle-lbl"><i class="fa-solid fa-fill-drip"></i> Relleno entre Curvas</div><label class="switch"><input type="checkbox" id="contour-fill"><span class="slider"></span></label></div>
                <button class="btn" style="background:linear-gradient(135deg,#14b8a6,#0d9488);margin-top:10px;" onclick="ContourEngine.generate()"><i class="fa-solid fa-mountain-sun"></i> GENERAR CURVAS DE NIVEL</button>
                <div id="contour-results" style="display:none;margin-top:16px;">
                    <div style="background:var(--bg-glass);border:1px solid #14b8a6;border-radius:8px;padding:12px;">
                        <div class="section-lbl" style="margin:0 0 10px 0;color:#14b8a6;"><i class="fa-solid fa-chart-bar"></i> RESUMEN</div>
                        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;">
                            <div style="text-align:center;padding:10px;background:rgba(0,0,0,0.2);border-radius:6px;">
                                <div style="font-size:10px;color:var(--text-3);">CURVAS</div>
                                <div id="contour-count" style="font-size:18px;font-weight:800;color:#14b8a6;">0</div>
                            </div>
                            <div style="text-align:center;padding:10px;background:rgba(0,0,0,0.2);border-radius:6px;">
                                <div style="font-size:10px;color:var(--text-3);">RANGO</div>
                                <div id="contour-range" style="font-size:14px;font-weight:700;color:#fbbf24;">0-0 m</div>
                            </div>
                            <div style="text-align:center;padding:10px;background:rgba(0,0,0,0.2);border-radius:6px;">
                                <div style="font-size:10px;color:var(--text-3);">DESNIVEL</div>
                                <div id="contour-diff" style="font-size:14px;font-weight:700;color:#ef4444;">0 m</div>
                            </div>
                        </div>
                        <div id="contour-legend" style="margin-top:12px;padding:10px;background:rgba(0,0,0,0.2);border-radius:6px;"></div>
                    </div>
                </div>
                <div id="contour-export" style="display:none;margin-top:12px;">
                    <div class="section-lbl" style="color:#0d9488;"><i class="fa-solid fa-download"></i> Exportar Curvas</div>
                    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:6px;">
                        <button class="btn btn-2" onclick="ContourEngine.exportDXF()" title="AutoCAD"><i class="fa-solid fa-drafting-compass"></i> DXF</button>
                        <button class="btn btn-2" onclick="ContourEngine.exportKML()" title="Google Earth"><i class="fa-solid fa-earth-americas"></i> KML</button>
                        <button class="btn btn-2" onclick="ContourEngine.exportGeoJSON()" title="QGIS/GIS"><i class="fa-solid fa-code"></i> GeoJSON</button>
                    </div>
                    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:6px;margin-top:6px;">
                        <button class="btn btn-2" onclick="ContourEngine.exportCSV()" title="Excel"><i class="fa-solid fa-file-csv"></i> CSV</button>
                        <button class="btn btn-2" onclick="ContourEngine.exportGPX()" title="GPS Campo"><i class="fa-solid fa-location-crosshairs"></i> GPX</button>
                        <button class="btn btn-2" onclick="ContourEngine.exportPDF()" title="Reporte PDF"><i class="fa-solid fa-file-pdf"></i> PDF</button>
                    </div>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-top:6px;">
                        <button class="btn btn-2" onclick="ContourEngine.exportTXT()" title="Reporte texto"><i class="fa-solid fa-file-lines"></i> Reporte TXT</button>
                        <button class="btn btn-2" onclick="ContourEngine.copyToClipboard()" title="Copiar datos"><i class="fa-solid fa-copy"></i> Copiar</button>
                    </div>
                </div>
                <button class="btn btn-2" style="margin-top:12px;" onclick="ContourEngine.clear()"><i class="fa-solid fa-trash"></i> Limpiar Curvas</button>
            </div>
            <!-- TAB WATERSHED: Anlisis de Flujo de Agua -->
            <div id="subdiv-watershed" class="tab-content">
                <div style="background:linear-gradient(135deg,rgba(6,182,212,0.2),rgba(8,145,178,0.15));border:1px solid #06b6d4;border-radius:8px;padding:12px;margin-bottom:12px;">
                    <div style="display:flex;align-items:center;gap:8px;margin-bottom:5px;">
                        <i class="fa-solid fa-droplet" style="color:#06b6d4;font-size:16px;"></i>
                        <span style="font-weight:700;font-size:12px;color:#fff;text-transform:uppercase;letter-spacing:0.5px;">ANLISIS DE FLUJO DE AGUA</span>
                    </div>
                    <p style="font-size:10px;color:var(--text-2);margin:0;">Detecta direccin de escorrenta, acumulacin y lneas de drenaje</p>
                </div>
                <div class="section-lbl" style="color:#06b6d4;"><i class="fa-solid fa-cog"></i> Configuracin</div>
                <div class="form-row">
                    <div class="form-group" style="margin:0"><label class="form-label">Resolucin</label><select class="form-input" id="water-resolution"><option value="10">Alta (10m)</option><option value="20" selected>Media (20m)</option><option value="40">Baja (40m)</option></select></div>
                    <div class="form-group" style="margin:0"><label class="form-label">Umbral Acum.</label><input type="number" class="form-input" id="water-threshold" value="5" min="1" max="50" title="Celdas mnimas para formar cauce"></div>
                </div>
                <div class="section-lbl" style="color:#0891b2;"><i class="fa-solid fa-layer-group"></i> Capas a Mostrar</div>
                <div class="toggle-row" style="margin:8px 0;border-left:4px solid #3b82f6;"><div class="toggle-lbl"><i class="fa-solid fa-arrows-alt" style="color:#3b82f6;"></i> Direccin de Flujo</div><label class="switch"><input type="checkbox" id="water-show-direction" checked><span class="slider"></span></label></div>
                <div class="toggle-row" style="margin:8px 0;border-left:4px solid #06b6d4;"><div class="toggle-lbl"><i class="fa-solid fa-water" style="color:#06b6d4;"></i> Acumulacin de Agua</div><label class="switch"><input type="checkbox" id="water-show-accumulation" checked><span class="slider"></span></label></div>
                <div class="toggle-row" style="margin:8px 0;border-left:4px solid #0ea5e9;"><div class="toggle-lbl"><i class="fa-solid fa-stream" style="color:#0ea5e9;"></i> Lneas de Drenaje</div><label class="switch"><input type="checkbox" id="water-show-streams" checked><span class="slider"></span></label></div>
                <div class="toggle-row" style="margin:8px 0;border-left:4px solid #ef4444;"><div class="toggle-lbl"><i class="fa-solid fa-exclamation-triangle" style="color:#ef4444;"></i> Puntos Crticos (Encharcamiento)</div><label class="switch"><input type="checkbox" id="water-show-sinks" checked><span class="slider"></span></label></div>
                <button class="btn" style="background:linear-gradient(135deg,#06b6d4,#0891b2);margin-top:10px;" onclick="WatershedEngine.analyze()"><i class="fa-solid fa-droplet"></i> ANALIZAR FLUJO DE AGUA</button>
                <div id="water-results" style="display:none;margin-top:16px;">
                    <div style="background:var(--bg-glass);border:1px solid #06b6d4;border-radius:8px;padding:12px;">
                        <div class="section-lbl" style="margin:0 0 10px 0;color:#06b6d4;"><i class="fa-solid fa-chart-pie"></i> RESULTADOS DEL ANLISIS</div>
                        <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:8px;">
                            <div style="text-align:center;padding:10px;background:rgba(0,0,0,0.2);border-radius:6px;">
                                <div style="font-size:10px;color:var(--text-3);">PUNTO MS ALTO</div>
                                <div id="water-highest" style="font-size:14px;font-weight:700;color:#ef4444;">0 m</div>
                            </div>
                            <div style="text-align:center;padding:10px;background:rgba(0,0,0,0.2);border-radius:6px;">
                                <div style="font-size:10px;color:var(--text-3);">PUNTO MS BAJO</div>
                                <div id="water-lowest" style="font-size:14px;font-weight:700;color:#22c55e;">0 m</div>
                            </div>
                            <div style="text-align:center;padding:10px;background:rgba(0,0,0,0.2);border-radius:6px;">
                                <div style="font-size:10px;color:var(--text-3);">LNEAS DE DRENAJE</div>
                                <div id="water-streams-count" style="font-size:14px;font-weight:700;color:#0ea5e9;">0</div>
                            </div>
                            <div style="text-align:center;padding:10px;background:rgba(0,0,0,0.2);border-radius:6px;">
                                <div style="font-size:10px;color:var(--text-3);">ZONAS CRTICAS</div>
                                <div id="water-sinks-count" style="font-size:14px;font-weight:700;color:#fbbf24;">0</div>
                            </div>
                        </div>
                        <div style="margin-top:12px;padding:10px;background:rgba(0,0,0,0.2);border-radius:6px;">
                            <div style="font-size:10px;color:var(--text-3);margin-bottom:6px;">DIRECCIN PRINCIPAL DE ESCORRENTA</div>
                            <div style="display:flex;align-items:center;gap:10px;">
                                <div id="water-main-direction" style="font-size:16px;font-weight:800;color:#06b6d4;">--</div>
                                <div id="water-direction-arrow" style="font-size:24px;"></div>
                            </div>
                        </div>
                        <div id="water-recommendation" style="margin-top:12px;padding:10px;border-radius:6px;font-size:11px;"></div>
                    </div>
                </div>
                <div id="water-export" style="display:none;margin-top:12px;">
                    <div class="section-lbl" style="color:#0891b2;"><i class="fa-solid fa-download"></i> Exportar Anlisis</div>
                    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:6px;">
                        <button class="btn btn-2" onclick="WatershedEngine.exportKML()" title="Google Earth"><i class="fa-solid fa-earth-americas"></i> KML</button>
                        <button class="btn btn-2" onclick="WatershedEngine.exportGeoJSON()" title="QGIS/GIS"><i class="fa-solid fa-code"></i> GeoJSON</button>
                        <button class="btn btn-2" onclick="WatershedEngine.exportDXF()" title="AutoCAD"><i class="fa-solid fa-drafting-compass"></i> DXF</button>
                    </div>
                    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:6px;margin-top:6px;">
                        <button class="btn btn-2" onclick="WatershedEngine.exportCSV()" title="Excel"><i class="fa-solid fa-file-csv"></i> CSV</button>
                        <button class="btn btn-2" onclick="WatershedEngine.exportGPX()" title="GPS Campo"><i class="fa-solid fa-location-crosshairs"></i> GPX</button>
                        <button class="btn btn-2" onclick="WatershedEngine.exportPDF()" title="Reporte PDF"><i class="fa-solid fa-file-pdf"></i> PDF</button>
                    </div>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-top:6px;">
                        <button class="btn btn-2" onclick="WatershedEngine.exportTXT()" title="Reporte texto"><i class="fa-solid fa-file-lines"></i> Reporte TXT</button>
                        <button class="btn btn-2" onclick="WatershedEngine.copyToClipboard()" title="Copiar datos"><i class="fa-solid fa-copy"></i> Copiar</button>
                    </div>
                </div>
                <button class="btn btn-2" style="margin-top:12px;" onclick="WatershedEngine.clear()"><i class="fa-solid fa-trash"></i> Limpiar Anlisis</button>
            </div>
            <!-- TAB VORONOI: Polgonos de Thiessen -->
            <div id="subdiv-voronoi" class="tab-content">
                <div style="background:linear-gradient(135deg,rgba(139,92,246,0.2),rgba(124,58,237,0.15));border:1px solid #8b5cf6;border-radius:8px;padding:12px;margin-bottom:12px;">
                    <div style="display:flex;align-items:center;gap:8px;margin-bottom:5px;">
                        <i class="fa-solid fa-diagram-project" style="color:#8b5cf6;font-size:16px;"></i>
                        <span style="font-weight:700;font-size:12px;color:#fff;text-transform:uppercase;letter-spacing:0.5px;">POLGONOS DE VORONOI</span>
                    </div>
                    <p style="font-size:10px;color:var(--text-2);margin:0;">Crea zonas de cobertura desde puntos de agua, pozos o estaciones</p>
                </div>
                <div class="section-lbl" style="color:#8b5cf6;"><i class="fa-solid fa-location-dot"></i> Puntos de Referencia</div>
                <p style="font-size:10px;color:var(--text-3);margin-bottom:10px;">Aade puntos de agua, pozos, aspersores o estaciones de muestreo. Cada zona Voronoi representa el rea ms cercana a cada punto.</p>
                <button class="btn" style="background:linear-gradient(135deg,#8b5cf6,#7c3aed);" onclick="VoronoiEngine.startAddPoints()"><i class="fa-solid fa-plus"></i> AADIR PUNTOS</button>
                <div id="voronoi-adding" style="display:none;margin-top:10px;padding:10px;background:rgba(139,92,246,0.2);border:1px solid #8b5cf6;border-radius:6px;">
                    <div style="display:flex;justify-content:space-between;align-items:center;">
                        <span style="font-size:11px;color:#8b5cf6;">Puntos aadidos: <strong id="voronoi-point-count">0</strong></span>
                        <button class="btn btn-2" style="padding:4px 10px;font-size:10px;" onclick="VoronoiEngine.stopAddPoints()"><i class="fa-solid fa-check"></i> Terminar</button>
                    </div>
                </div>
                <button class="btn btn-2" style="margin-top:8px;" onclick="VoronoiEngine.generate()"><i class="fa-solid fa-diagram-project"></i> GENERAR VORONOI</button>
                <div id="voronoi-stats" style="display:none;background:var(--bg-glass);border:1px solid var(--border);border-radius:6px;padding:12px;margin-top:12px;">
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
                        <div style="text-align:center;padding:10px;background:rgba(0,0,0,0.2);border-radius:6px;">
                            <div style="font-size:10px;color:var(--text-3);">ZONAS GENERADAS</div>
                            <div id="voronoi-zones" style="font-size:20px;font-weight:800;color:#8b5cf6;">0</div>
                        </div>
                        <div style="text-align:center;padding:10px;background:rgba(0,0,0,0.2);border-radius:6px;">
                            <div style="font-size:10px;color:var(--text-3);">REA PROMEDIO</div>
                            <div id="voronoi-avg-area" style="font-size:16px;font-weight:800;color:#a78bfa;">0 Ha</div>
                        </div>
                    </div>
                </div>
                <div id="voronoi-export" style="display:none;margin-top:12px;">
                    <div class="section-lbl" style="color:#7c3aed;"><i class="fa-solid fa-download"></i> Exportar Zonas</div>
                    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:6px;">
                        <button class="btn btn-2" onclick="VoronoiEngine.exportKML()" title="Google Earth"><i class="fa-solid fa-earth-americas"></i> KML</button>
                        <button class="btn btn-2" onclick="VoronoiEngine.exportGeoJSON()" title="QGIS/GIS"><i class="fa-solid fa-code"></i> GeoJSON</button>
                        <button class="btn btn-2" onclick="VoronoiEngine.exportDXF()" title="AutoCAD"><i class="fa-solid fa-drafting-compass"></i> DXF</button>
                    </div>
                    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:6px;margin-top:6px;">
                        <button class="btn btn-2" onclick="VoronoiEngine.exportCSV()" title="Excel"><i class="fa-solid fa-file-csv"></i> CSV</button>
                        <button class="btn btn-2" onclick="VoronoiEngine.exportGPX()" title="GPS Campo"><i class="fa-solid fa-location-crosshairs"></i> GPX</button>
                        <button class="btn btn-2" onclick="VoronoiEngine.exportPDF()" title="Reporte PDF"><i class="fa-solid fa-file-pdf"></i> PDF</button>
                    </div>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-top:6px;">
                        <button class="btn btn-2" onclick="VoronoiEngine.exportTXT()" title="Reporte texto"><i class="fa-solid fa-file-lines"></i> Reporte TXT</button>
                        <button class="btn btn-2" onclick="VoronoiEngine.copyToClipboard()" title="Copiar datos"><i class="fa-solid fa-copy"></i> Copiar</button>
                    </div>
                </div>
                <button class="btn btn-2" style="margin-top:12px;" onclick="VoronoiEngine.clear()"><i class="fa-solid fa-trash"></i> Limpiar Todo</button>
            </div>
            <!-- TAB TRANSECTOS: Transectos de Muestreo -->
            <div id="subdiv-transects" class="tab-content">
                <div style="background:linear-gradient(135deg,rgba(249,115,22,0.2),rgba(234,88,12,0.15));border:1px solid #f97316;border-radius:8px;padding:12px;margin-bottom:12px;">
                    <div style="display:flex;align-items:center;gap:8px;margin-bottom:5px;">
                        <i class="fa-solid fa-grip-lines" style="color:#f97316;font-size:16px;"></i>
                        <span style="font-weight:700;font-size:12px;color:#fff;text-transform:uppercase;letter-spacing:0.5px;">TRANSECTOS DE MUESTREO</span>
                    </div>
                    <p style="font-size:10px;color:var(--text-2);margin:0;">Genera lneas y puntos de muestreo sistemtico para anlisis de suelos</p>
                </div>
                <div class="section-lbl" style="color:#f97316;"><i class="fa-solid fa-sliders"></i> Tipo de Muestreo</div>
                <div class="form-group">
                    <select class="form-input" id="transect-type" onchange="$('transect-random-opts').style.display=this.value==='random'?'block':'none'">
                        <option value="parallel"> Transectos Paralelos</option>
                        <option value="grid"> Grilla Regular</option>
                        <option value="random"> Aleatorio</option>
                        <option value="zigzag"> Zigzag</option>
                    </select>
                </div>
                <div id="transect-random-opts" style="display:none;">
                    <div class="form-group"><label class="form-label">Cantidad de Puntos</label><input type="number" class="form-input" id="transect-random-points" value="30" min="5" max="200"></div>
                </div>
                <div class="section-lbl" style="color:#ea580c;"><i class="fa-solid fa-ruler"></i> Configuracin</div>
                <div class="form-row">
                    <div class="form-group" style="margin:0"><label class="form-label">Separacin (m)</label><input type="number" class="form-input" id="transect-spacing" value="50" min="5" max="500" step="5"></div>
                    <div class="form-group" style="margin:0"><label class="form-label">Orientacin ()</label><input type="number" class="form-input" id="transect-angle" value="0" min="0" max="180"></div>
                </div>
                <div class="form-group"><label class="form-label">Distancia entre Puntos (m)</label><input type="number" class="form-input" id="transect-point-spacing" value="20" min="1" max="100" step="1"></div>
                <button class="btn" style="background:linear-gradient(135deg,#f97316,#ea580c);" onclick="TransectEngine.generate()"><i class="fa-solid fa-grip-lines"></i> GENERAR TRANSECTOS</button>
                <div id="transect-stats" style="display:none;background:var(--bg-glass);border:1px solid var(--border);border-radius:6px;padding:12px;margin-top:12px;">
                    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;">
                        <div style="text-align:center;padding:8px;background:rgba(0,0,0,0.2);border-radius:6px;">
                            <div style="font-size:9px;color:var(--text-3);">TRANSECTOS</div>
                            <div id="transect-count" style="font-size:16px;font-weight:800;color:#f97316;">0</div>
                        </div>
                        <div style="text-align:center;padding:8px;background:rgba(0,0,0,0.2);border-radius:6px;">
                            <div style="font-size:9px;color:var(--text-3);">PUNTOS</div>
                            <div id="transect-points-count" style="font-size:16px;font-weight:800;color:#fbbf24;">0</div>
                        </div>
                        <div style="text-align:center;padding:8px;background:rgba(0,0,0,0.2);border-radius:6px;">
                            <div style="font-size:9px;color:var(--text-3);">LONGITUD</div>
                            <div id="transect-total-length" style="font-size:16px;font-weight:800;color:#22c55e;">0 m</div>
                        </div>
                    </div>
                </div>
                <div id="transect-export" style="display:none;margin-top:12px;">
                    <div class="section-lbl" style="color:#c2410c;"><i class="fa-solid fa-download"></i> Exportar Transectos</div>
                    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:6px;">
                        <button class="btn btn-2" onclick="TransectEngine.exportKML()" title="Google Earth"><i class="fa-solid fa-earth-americas"></i> KML</button>
                        <button class="btn btn-2" onclick="TransectEngine.exportGeoJSON()" title="QGIS/GIS"><i class="fa-solid fa-code"></i> GeoJSON</button>
                        <button class="btn btn-2" onclick="TransectEngine.exportDXF()" title="AutoCAD"><i class="fa-solid fa-drafting-compass"></i> DXF</button>
                    </div>
                    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:6px;margin-top:6px;">
                        <button class="btn btn-2" onclick="TransectEngine.exportCSV()" title="Excel"><i class="fa-solid fa-file-csv"></i> CSV</button>
                        <button class="btn btn-2" onclick="TransectEngine.exportGPX()" title="GPS Campo"><i class="fa-solid fa-location-crosshairs"></i> GPX</button>
                        <button class="btn btn-2" onclick="TransectEngine.exportPDF()" title="Reporte PDF"><i class="fa-solid fa-file-pdf"></i> PDF</button>
                    </div>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-top:6px;">
                        <button class="btn btn-2" onclick="TransectEngine.exportTXT()" title="Reporte texto"><i class="fa-solid fa-file-lines"></i> Reporte TXT</button>
                        <button class="btn btn-2" onclick="TransectEngine.copyToClipboard()" title="Copiar datos"><i class="fa-solid fa-copy"></i> Copiar</button>
                    </div>
                </div>
                <button class="btn btn-2" style="margin-top:12px;" onclick="TransectEngine.clear()"><i class="fa-solid fa-trash"></i> Limpiar</button>
            </div>
        </div>
    </div>

    <!-- RADIAL PANEL -->
    <div id="panel-radial" class="panel">
        <div class="panel-hdr"><div class="panel-title"><i class="fa-solid fa-circle-notch"></i> Radial</div><button class="panel-close" onclick="closePanel('radial')"><i class="fa-solid fa-times"></i></button></div>
        <div class="panel-body">
            <div class="form-group"><label class="form-label">Sectores</label><div class="range-grp"><input type="range" class="range" id="rad-sectors" min="2" max="36" value="8" oninput="RadialEngine.sync('s',this.value)"><input type="number" class="range-val" id="rad-sectors-n" value="8" oninput="RadialEngine.sync('s',this.value)"></div></div>
            <div class="form-group"><label class="form-label">Radio Hub (m)</label><div class="range-grp"><input type="range" class="range" id="hub-rad" min="0" max="500" value="25" oninput="RadialEngine.sync('h',this.value)"><input type="number" class="range-val" id="hub-rad-n" value="25" oninput="RadialEngine.sync('h',this.value)"></div></div>
            <div class="form-group"><label class="form-label">ngulo Inicial ()</label><div class="range-grp"><input type="range" class="range" id="rad-angle" min="0" max="360" value="0" oninput="RadialEngine.sync('a',this.value)"><input type="number" class="range-val" id="rad-angle-n" value="0" oninput="RadialEngine.sync('a',this.value)"></div></div>
            <button class="btn btn-accent" onclick="RadialEngine.placeHub()"><i class="fa-solid fa-crosshairs"></i> Colocar Hub</button>
            <div id="hub-info" class="hidden" style="background:var(--bg-glass);padding:12px;border-radius:6px;margin:12px 0;text-align:center;"><div style="font-size:10px;color:var(--accent);font-weight:600;">HUB ACTIVO</div><div id="hub-coords" style="font-family:monospace;font-size:12px;margin-top:4px;">--</div></div>
            <button class="btn" onclick="RadialEngine.apply()" style="margin-top:10px;"><i class="fa-solid fa-check"></i> Aplicar</button>
            <button class="btn btn-danger" onclick="RadialEngine.reset()" style="margin-top:8px;"><i class="fa-solid fa-undo"></i> Reset</button>
        </div>
    </div>

    <!-- BOTALONES PANEL -->
    <div id="panel-botalones" class="panel" style="width:420px;">
        <div class="panel-hdr"><div class="panel-title"><i class="fa-solid fa-signs-post"></i> Botalones y Cercas</div><button class="panel-close" onclick="closePanel('botalones')"><i class="fa-solid fa-times"></i></button></div>
        <div class="panel-body">
            <div style="background:rgba(245,158,11,0.1);border:1px solid rgba(245,158,11,0.3);border-radius:8px;padding:12px;margin-bottom:16px;">
                <div class="section-lbl" style="margin:0 0 10px 0;"><i class="fa-solid fa-cog"></i> Configuracin</div>
                <div class="form-row">
                    <div class="form-group" style="margin:0"><label class="form-label">Espaciado (m)</label><input type="number" class="form-input" id="bot-spacing" value="50" min="1" onchange="BotalonMgr.calculate()"></div>
                    <div class="form-group" style="margin:0"><label class="form-label">Precio Cerca ($/m)</label><input type="number" class="form-input" id="fence-price" value="15" min="0" onchange="BotalonMgr.calculate()"></div>
                </div>
                <div class="toggle-row" style="margin:10px 0 0 0;"><div class="toggle-lbl"><i class="fa-solid fa-eye"></i> Mostrar en Mapa</div><label class="switch"><input type="checkbox" id="bot-show" checked onchange="BotalonMgr.toggleDisplay()"><span class="slider"></span></label></div>
            </div>
            <button class="btn btn-warning" onclick="BotalonMgr.calculate()" style="margin-bottom:16px;"><i class="fa-solid fa-calculator"></i> CALCULAR BOTALONES</button>
            <div id="bot-summary"><p style="color:var(--text-3);font-size:11px;text-align:center;padding:20px;">Crea subdivisiones para calcular botalones</p></div>
            <div class="export-grid">
                <button class="btn btn-accent" onclick="BotalonMgr.exportKML()"><i class="fa-solid fa-earth-americas"></i> KML Completo</button>
                <button class="btn btn-2" onclick="BotalonMgr.exportGeoJSON()"><i class="fa-solid fa-globe"></i> GeoJSON (QGIS)</button>
                <button class="btn btn-2" onclick="BotalonMgr.exportCSV()"><i class="fa-solid fa-file-csv"></i> CSV Detalle</button>
                <button class="btn btn-2" onclick="BotalonMgr.exportGPX()"><i class="fa-solid fa-location-dot"></i> GPX Puntos</button>
            </div>
        </div>
    </div>

    <!-- TOPO PANEL -->
    <div id="panel-topo" class="panel">
        <div class="panel-hdr"><div class="panel-title"><i class="fa-solid fa-mountain"></i> Topografa</div><button class="panel-close" onclick="closePanel('topo')"><i class="fa-solid fa-times"></i></button></div>
        <div class="panel-body">
            <div class="tabs"><button class="tab active" onclick="switchTab('topo','vert',this)">Vrtices</button><button class="tab" onclick="switchTab('topo','rumb',this)">Rumbos</button><button class="tab" onclick="switchTab('topo','buf',this)">Buffer</button></div>
            <div id="topo-vert" class="tab-content active"><div style="max-height:300px;overflow-y:auto;"><table class="data-table"><thead><tr><th>#</th><th>Lat</th><th>Lon</th><th>E</th><th>N</th></tr></thead><tbody id="vert-body"></tbody></table></div><button class="btn btn-2" onclick="TopoTools.exportVert()" style="margin-top:10px;"><i class="fa-solid fa-download"></i> Exportar</button></div>
            <div id="topo-rumb" class="tab-content"><div style="max-height:300px;overflow-y:auto;"><table class="data-table"><thead><tr><th>Lado</th><th>Az</th><th>Rumbo</th><th>Dist</th></tr></thead><tbody id="rumb-body"></tbody></table></div><button class="btn btn-2" onclick="TopoTools.exportRumb()" style="margin-top:10px;"><i class="fa-solid fa-download"></i> Exportar</button></div>
            <div id="topo-buf" class="tab-content"><div class="form-group"><label class="form-label">Distancia (m)</label><input type="number" class="form-input" id="buf-dist" value="10" min="1"></div><div class="form-group"><label class="form-label">Tipo</label><select class="form-input" id="buf-type"><option value="pos">Exterior</option><option value="neg">Interior</option></select></div><button class="btn btn-warning" onclick="TopoTools.createBuf()"><i class="fa-solid fa-vector-square"></i> Crear Buffer</button></div>
        </div>
    </div>

    <!-- COORDS PANEL -->
    <div id="panel-coords" class="panel">
        <div class="panel-hdr"><div class="panel-title"><i class="fa-solid fa-location-crosshairs"></i> Coordenadas</div><button class="panel-close" onclick="closePanel('coords')"><i class="fa-solid fa-times"></i></button></div>
        <div class="panel-body">
            <div class="tabs"><button class="tab active" onclick="switchTab('coords','gps',this)">GPS</button><button class="tab" onclick="switchTab('coords','utm',this)">UTM</button></div>
            <div id="coords-gps" class="tab-content active"><div class="form-group"><label class="form-label">Lat, Lon (una por lnea)</label><textarea class="form-input" id="coords-txt" rows="8" placeholder="10.123, -68.456"></textarea></div></div>
            <div id="coords-utm" class="tab-content"><div class="form-row" style="margin-bottom:12px;"><div class="form-group" style="margin:0"><label class="form-label">Zona</label><select class="form-input" id="utm-zone"><option value="18">18N</option><option value="19" selected>19N</option><option value="20">20N</option></select></div><div class="form-group" style="margin:0"><label class="form-label">Hem.</label><select class="form-input" id="utm-hem"><option value="N" selected>N</option><option value="S">S</option></select></div></div><div class="form-group"><label class="form-label">E, N (una por lnea)</label><textarea class="form-input" id="utm-txt" rows="8" placeholder="650000, 1120000"></textarea></div></div>
            <button class="btn" onclick="ImportMgr.parseCoords()"><i class="fa-solid fa-check"></i> Generar Polgono</button>
        </div>
    </div>

    <!-- DATA PANEL -->
    <div id="panel-data" class="panel" style="width:600px;">
        <div class="panel-hdr"><div class="panel-title"><i class="fa-solid fa-table"></i> Tabla de Lotes</div><div style="display:flex;gap:6px;"><button class="panel-close" onclick="ExportMgr.toCSV()"><i class="fa-solid fa-download"></i></button><button class="panel-close" onclick="closePanel('data')"><i class="fa-solid fa-times"></i></button></div></div>
        <div class="panel-body" style="padding:0;max-height:350px;overflow:auto;"><table class="data-table"><thead><tr><th>ID</th><th>rea (m)</th><th>rea (Ha)</th><th>Permetro</th><th>Centro</th></tr></thead><tbody id="data-body"></tbody></table></div>
    </div>

    <!-- SUN PANEL -->
    <div id="panel-sun" class="panel">
        <div class="panel-hdr"><div class="panel-title"><i class="fa-solid fa-sun"></i> Anlisis Solar</div><button class="panel-close" onclick="closePanel('sun')"><i class="fa-solid fa-times"></i></button></div>
        <div class="panel-body">
            <div class="form-group"><label class="form-label">Fecha</label><input type="date" class="form-input" id="sun-date" onchange="SunAnalyzer.update()"></div>
            <div class="form-group"><label class="form-label">Hora</label><input type="range" class="range" id="sun-time" min="0" max="1440" value="720" style="width:100%;" oninput="SunAnalyzer.update()"></div>
            <div style="text-align:center;font-size:28px;font-weight:800;color:var(--warning);" id="sun-time-disp">12:00</div>
        </div>
    </div>

    <!-- EXPORT PANEL -->
    <div id="panel-export" class="panel">
        <div class="panel-hdr"><div class="panel-title"><i class="fa-solid fa-download"></i> Exportar</div><button class="panel-close" onclick="closePanel('export')"><i class="fa-solid fa-times"></i></button></div>
        <div class="panel-body">
            <div class="toolbar" style="grid-template-columns:repeat(3,1fr);">
                <button class="tool-btn" onclick="ExportMgr.toPDF()" style="flex-direction:column;aspect-ratio:auto;padding:14px;"><i class="fa-solid fa-file-pdf" style="color:#ef4444;font-size:20px;"></i><span style="font-size:9px;margin-top:4px;">PDF</span></button>
                <button class="tool-btn" onclick="ExportMgr.toDXF()" style="flex-direction:column;aspect-ratio:auto;padding:14px;"><i class="fa-solid fa-drafting-compass" style="color:#f59e0b;font-size:20px;"></i><span style="font-size:9px;margin-top:4px;">DXF</span></button>
                <button class="tool-btn" onclick="ExportMgr.toKML()" style="flex-direction:column;aspect-ratio:auto;padding:14px;"><i class="fa-solid fa-earth-americas" style="color:#8b5cf6;font-size:20px;"></i><span style="font-size:9px;margin-top:4px;">KML</span></button>
                <button class="tool-btn" onclick="ExportMgr.toGeoJSON()" style="flex-direction:column;aspect-ratio:auto;padding:14px;"><i class="fa-solid fa-globe" style="color:#10b981;font-size:20px;"></i><span style="font-size:9px;margin-top:4px;">GeoJSON</span></button>
                <button class="tool-btn" onclick="ExportMgr.toCSV()" style="flex-direction:column;aspect-ratio:auto;padding:14px;"><i class="fa-solid fa-file-csv" style="color:#06b6d4;font-size:20px;"></i><span style="font-size:9px;margin-top:4px;">CSV</span></button>
                <button class="tool-btn" onclick="ExportMgr.toMemorial()" style="flex-direction:column;aspect-ratio:auto;padding:14px;"><i class="fa-solid fa-file-lines" style="color:#ec4899;font-size:20px;"></i><span style="font-size:9px;margin-top:4px;">Memorial</span></button>
            </div>
            
            <!-- PRV AVANZADO - TerraCut Integration -->
            <div style="margin-top:16px;padding-top:16px;border-top:1px dashed #10b981;">
                <div style="font-size:10px;font-weight:700;color:#10b981;margin-bottom:10px;text-transform:uppercase;display:flex;align-items:center;gap:6px;">
                    <span></span> PRV Avanzado (TerraCut)
                </div>
                <button class="btn" onclick="PRVAdvanced.mostrarDashboard()" style="margin-bottom:8px;background:linear-gradient(135deg,#10b981,#059669);">
                    <i class="fa-solid fa-chart-line"></i> Dashboard Estado PRV
                </button>
                <button class="btn btn-2" onclick="PRVAdvanced.calcularRutaOptima()" style="margin-bottom:8px;border-color:#10b981;color:#10b981;">
                    <i class="fa-solid fa-route"></i> Ruta ptima de Pastoreo
                </button>
                <button class="btn btn-2" onclick="PRVAdvanced.iniciarSimulacion()" style="margin-bottom:8px;border-color:#8b5cf6;color:#8b5cf6;">
                    <i class="fa-solid fa-play"></i> Simular Rotacin
                </button>
            </div>
            
            <!-- COMPOSICIN PROFESIONAL -->
            <div style="margin-top:16px;padding-top:16px;border-top:1px dashed #64748b;">
                <button class="btn" onclick="ComposerPro.abrir()" style="background:linear-gradient(135deg,#0f172a,#1e293b);">
                    <i class="fa-solid fa-print"></i> COMPOSICIN PROFESIONAL
                </button>
            </div>
        </div>
    </div>

    <div class="toast" id="toast"><i class="fa-solid fa-check-circle"></i><span id="toast-msg">OK</span></div>
    <div class="loading" id="loading"><div class="spinner"></div><div style="color:var(--text-2);">Procesando...</div></div>

    <!-- INDICADOR DE MODO DIBUJO - PERFIL DE ELEVACIN -->
    <div id="lineDrawIndicator" class="line-draw-indicator">
        <i class="fa-solid fa-draw-polygon" style="animation: pulse 1s infinite;"></i>
        <span> MODO PERFIL: Click para trazar | ENTER o Doble-click para finalizar | ESC para cancelar</span>
    </div>

    <!-- INDICADOR DE ATAJOS EN EL GRFICO -->
    <div id="lpKeyHint" style="position:fixed;bottom:295px;left:50%;transform:translateX(-50%);background:linear-gradient(135deg,rgba(139,92,246,0.9),rgba(124,58,237,0.9));color:white;padding:8px 16px;border-radius:20px;font-size:11px;font-weight:600;z-index:2600;display:none;box-shadow:0 4px 15px rgba(139,92,246,0.4);backdrop-filter:blur(10px);">
         <b>ESPACIO</b> o <b>V</b> = Marcar Vrtice | <b>Ctrl+C</b> = Limpiar Vrtices
    </div>

    <!-- PANEL DE PERFIL DE ELEVACIN -->
    <div id="lineProfilePanel" class="line-profile-panel">
        <div class="line-profile-header">
            <div class="line-profile-title">
                <i class="fa-solid fa-mountain"></i>
                <span>Perfil de Elevacin de Lnea</span>
            </div>
            <div class="line-profile-stats">
                <div class="line-profile-stat">
                    <div class="line-profile-stat-value" id="lpStatMin">--</div>
                    <div class="line-profile-stat-label">Mn. Elev.</div>
                </div>
                <div class="line-profile-stat">
                    <div class="line-profile-stat-value" id="lpStatAvg">--</div>
                    <div class="line-profile-stat-label">Prom. Elev.</div>
                </div>
                <div class="line-profile-stat">
                    <div class="line-profile-stat-value" id="lpStatMax">--</div>
                    <div class="line-profile-stat-label">Mx. Elev.</div>
                </div>
                <div class="line-profile-stat">
                    <div class="line-profile-stat-value" id="lpStatDist">--</div>
                    <div class="line-profile-stat-label">Distancia</div>
                </div>
            </div>
            <div class="line-profile-actions">
                <button class="line-profile-btn line-profile-btn-secondary" onclick="LineElevationProfile.exportCSV()">
                    <i class="fa-solid fa-download"></i> CSV
                </button>
                <button class="line-profile-btn line-profile-btn-secondary" onclick="LineElevationProfile.exportPNG()">
                    <i class="fa-solid fa-image"></i> PNG
                </button>
                <button class="line-profile-btn line-profile-btn-primary" onclick="LineElevationProfile.nuevaLinea()">
                    <i class="fa-solid fa-plus"></i> Nueva Lnea
                </button>
                <button class="line-profile-btn line-profile-btn-close" onclick="LineElevationProfile.cerrarPanel()">
                    <i class="fa-solid fa-times"></i>
                </button>
            </div>
        </div>
        <div class="line-profile-body">
            <div class="line-profile-chart-container" id="lpChartContainer">
                <canvas id="lpChart" class="line-profile-chart"></canvas>
                <div class="line-profile-cursor" id="lpCursor">
                    <div class="line-profile-cursor-dot" id="lpCursorDot"></div>
                </div>
                <div class="line-profile-tooltip" id="lpTooltip">
                    <div style="font-size:10px;color:#94a3b8;margin-bottom:4px;border-bottom:1px solid rgba(139,92,246,0.3);padding-bottom:4px;"> Punto del Perfil</div>
                    <div class="line-profile-tooltip-elev" id="lpTooltipElev">-- m</div>
                    <div class="line-profile-tooltip-dist" id="lpTooltipDist">Distancia: -- km</div>
                    <div class="line-profile-tooltip-grade" id="lpTooltipGrade">Pendiente: --%</div>
                    <div style="margin-top:6px;padding-top:6px;border-top:1px solid rgba(139,92,246,0.3);">
                        <div style="font-size:9px;color:#64748b;">COORDENADAS:</div>
                        <div style="font-size:11px;color:#10b981;font-family:monospace;" id="lpTooltipLat">Lat: --</div>
                        <div style="font-size:11px;color:#10b981;font-family:monospace;" id="lpTooltipLng">Lng: --</div>
                    </div>
                    <button onclick="LineElevationProfile.marcarVertice()" style="margin-top:8px;width:100%;padding:6px;background:linear-gradient(135deg,#8b5cf6,#7c3aed);color:white;border:none;border-radius:4px;font-size:10px;font-weight:600;cursor:pointer;">
                         MARCAR VRTICE
                    </button>
                    <div style="margin-top:6px;text-align:center;font-size:9px;color:#64748b;background:rgba(139,92,246,0.2);padding:4px;border-radius:4px;">
                         Presione <b style="color:#a78bfa;">ESPACIO</b> o <b style="color:#a78bfa;">V</b> para marcar
                    </div>
                </div>
            </div>
            <div class="line-profile-info-panel">
                <div class="line-profile-info-card">
                    <div class="line-profile-info-title"> Totales del Rango</div>
                    <div class="line-profile-info-row">
                        <span class="line-profile-info-label">Distancia:</span>
                        <span class="line-profile-info-value" id="lpInfoDist">-- km</span>
                    </div>
                    <div class="line-profile-info-row">
                        <span class="line-profile-info-label">Puntos:</span>
                        <span class="line-profile-info-value" id="lpInfoPoints">--</span>
                    </div>
                </div>
                <!-- VRTICES MARCADOS -->
                <div class="line-profile-info-card" id="lpVerticesCard" style="display:none;">
                    <div class="line-profile-info-title"> Vrtices Marcados</div>
                    <div id="lpVerticesList" style="max-height:80px;overflow-y:auto;font-size:10px;"></div>
                    <button onclick="LineElevationProfile.exportarVertices()" style="margin-top:6px;width:100%;padding:4px;background:#10b981;color:white;border:none;border-radius:4px;font-size:9px;cursor:pointer;">
                         Exportar Vrtices
                    </button>
                    <button onclick="LineElevationProfile.limpiarVertices()" style="margin-top:4px;width:100%;padding:4px;background:#ef4444;color:white;border:none;border-radius:4px;font-size:9px;cursor:pointer;">
                         Limpiar
                    </button>
                </div>
                <div class="line-profile-info-card">
                    <div class="line-profile-info-title"> Ganancia/Prdida</div>
                    <div class="line-profile-info-row">
                        <span class="line-profile-info-label">Ganancia:</span>
                        <span class="line-profile-info-value positive" id="lpInfoGain">+-- m</span>
                    </div>
                    <div class="line-profile-info-row">
                        <span class="line-profile-info-label">Prdida:</span>
                        <span class="line-profile-info-value negative" id="lpInfoLoss">--- m</span>
                    </div>
                </div>
                <div class="line-profile-info-card">
                    <div class="line-profile-info-title"> Inclinacin</div>
                    <div class="line-profile-info-row">
                        <span class="line-profile-info-label">Mx:</span>
                        <span class="line-profile-info-value" id="lpInfoMaxGrade">--%</span>
                    </div>
                    <div class="line-profile-info-row">
                        <span class="line-profile-info-label">Prom:</span>
                        <span class="line-profile-info-value" id="lpInfoAvgGrade">--%</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
    'use strict';
    const $=id=>document.getElementById(id),$$=sel=>document.querySelectorAll(sel);
    function download(content,filename,type){const blob=new Blob([content],{type}),a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download=filename;a.click();}

    const State={map:null,drawnItems:null,layers:{preview:null,result:null,hub:null,radial:null,botalones:null,dims:null,verts:null,azimuth:null,buffer:null,sun:null,alleys:null,slicer:null,multilines:null,mlTemp:null,potreros:null,slope:null,volume:null,viewshed:null,path:null,shadow:null,drainage:null,gps:null,risk:null,comparison:null,mainVerts:null,mainDims:null},polygon:null,blocks:[],history:[],historyIdx:-1,maxHistory:50,selectedIds:new Set(),mode:'info',hubMarker:null,hubCenter:null,showVerts:true,showDist:true,showAz:false,gridAngle:0,theme:'dark',colors:{dark:['#ef4444','#f97316','#f59e0b','#84cc16','#22c55e','#10b981','#06b6d4','#3b82f6','#8b5cf6','#ec4899'],pastel:['#f8b4b4','#fcd5ce','#d8e2dc','#b5e48c','#99d98c','#b8d4e3','#a2d2ff','#cdb4db','#ffc8dd','#ffe5d9']},botalonData:null,potreros:[],activePotreroId:null};

    function togglePanel(name){const panel=$(`panel-${name}`),isActive=panel?.classList.contains('active');$$('.panel').forEach(p=>p.classList.remove('active'));$$('.nav-item').forEach(n=>n.classList.remove('active'));if(!isActive&&panel){panel.classList.add('active');document.querySelector(`.nav-item[data-panel="${name}"]`)?.classList.add('active');}}
    function closePanel(name){$(`panel-${name}`)?.classList.remove('active');document.querySelector(`.nav-item[data-panel="${name}"]`)?.classList.remove('active');}
    function switchTab(panel,tab,btn){$$(`#panel-${panel} .tab`).forEach(b=>b.classList.remove('active'));$$(`#panel-${panel} .tab-content`).forEach(c=>c.classList.remove('active'));btn.classList.add('active');$(`${panel}-${tab}`)?.classList.add('active');if(panel==='subdiv'){State.mode=tab==='fusion'?'select':'info';$('fusion-bar').classList.toggle('active',tab==='fusion');if(tab!=='fusion')SelectMgr.clear();if(tab==='slicer'&&State.polygon)SlicerEngine.preview();else if(typeof SlicerEngine!=='undefined')SlicerEngine.clearPreview();}}
    function toggleLotBody(id){document.getElementById(`lot-body-${id}`)?.classList.toggle('open');}

    const Toast={show(msg,type='success'){const t=$('toast');t.className=`toast ${type}`;$('toast-msg').textContent=msg;t.querySelector('i').className=`fa-solid fa-${type==='success'?'check':type==='error'?'times':'exclamation'}-circle`;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),3500);}};
    const Loading={show(){$('loading').classList.add('show');},hide(){$('loading').classList.remove('show');}};
    const ThemeMgr={toggle(){State.theme=State.theme==='dark'?'pastel':'dark';document.body.setAttribute('data-theme',State.theme==='pastel'?'pastel':'');Renderer.render();}};

    const GeoMath={
        vincentyDist(lat1,lon1,lat2,lon2){const a=6378137,f=1/298.257223563,toRad=Math.PI/180,L=(lon2-lon1)*toRad,U1=Math.atan((1-f)*Math.tan(lat1*toRad)),U2=Math.atan((1-f)*Math.tan(lat2*toRad)),sinU1=Math.sin(U1),cosU1=Math.cos(U1),sinU2=Math.sin(U2),cosU2=Math.cos(U2);let lambda=L,lambdaP,iter=100,cosSqA,sinSig,cos2SigM,cosSig,sigma;do{const sinL=Math.sin(lambda),cosL=Math.cos(lambda);sinSig=Math.sqrt((cosU2*sinL)**2+(cosU1*sinU2-sinU1*cosU2*cosL)**2);if(sinSig===0)return 0;cosSig=sinU1*sinU2+cosU1*cosU2*cosL;sigma=Math.atan2(sinSig,cosSig);const sinA=cosU1*cosU2*sinL/sinSig;cosSqA=1-sinA**2;cos2SigM=cosSig-2*sinU1*sinU2/cosSqA||0;const C=f/16*cosSqA*(4+f*(4-3*cosSqA));lambdaP=lambda;lambda=L+(1-C)*f*sinA*(sigma+C*sinSig*(cos2SigM+C*cosSig*(-1+2*cos2SigM**2)));}while(Math.abs(lambda-lambdaP)>1e-12&&--iter>0);const b=6356752.314245,uSq=cosSqA*(a*a-b*b)/(b*b),A=1+uSq/16384*(4096+uSq*(-768+uSq*(320-175*uSq))),B=uSq/1024*(256+uSq*(-128+uSq*(74-47*uSq))),dSig=B*sinSig*(cos2SigM+B/4*(cosSig*(-1+2*cos2SigM**2)-B/6*cos2SigM*(-3+4*sinSig**2)*(-3+4*cos2SigM**2)));return b*A*(sigma-dSig);},
        area(coords){if(!coords||coords.length<3)return 0;const useGeo=$('tog-geo')?.checked??true;if(!useGeo)return turf.area(turf.polygon([coords]));const toRad=Math.PI/180,a=6378137;let total=0,n=coords.length-1;for(let i=0;i<n;i++){const j=(i+1)%n;total+=(coords[j][0]-coords[i][0])*toRad*(2+Math.sin(coords[i][1]*toRad)+Math.sin(coords[j][1]*toRad));}return Math.abs(total*a*a/2);},
        perimeter(coords){if(!coords||coords.length<2)return 0;let t=0;for(let i=0;i<coords.length-1;i++)t+=this.vincentyDist(coords[i][1],coords[i][0],coords[i+1][1],coords[i+1][0]);return t;},
        bearing(lat1,lon1,lat2,lon2){const toRad=Math.PI/180,toDeg=180/Math.PI,dLon=(lon2-lon1)*toRad,y=Math.sin(dLon)*Math.cos(lat2*toRad),x=Math.cos(lat1*toRad)*Math.sin(lat2*toRad)-Math.sin(lat1*toRad)*Math.cos(lat2*toRad)*Math.cos(dLon);return((Math.atan2(y,x)*toDeg)+360)%360;},
        azToRumbo(az){let cuad,ang;if(az>=0&&az<90){cuad='NE';ang=az;}else if(az>=90&&az<180){cuad='SE';ang=180-az;}else if(az>=180&&az<270){cuad='SW';ang=az-180;}else{cuad='NW';ang=360-az;}const d=Math.floor(ang),m=Math.floor((ang-d)*60),s=((ang-d)*60-m)*60;return`${cuad[0]}${d}${m}'${s.toFixed(0)}"${cuad[1]}`;}
    };

    const UTM={init(){proj4.defs("EPSG:32618","+proj=utm +zone=18 +datum=WGS84 +units=m");proj4.defs("EPSG:32619","+proj=utm +zone=19 +datum=WGS84 +units=m");proj4.defs("EPSG:32620","+proj=utm +zone=20 +datum=WGS84 +units=m");},toLatLon(e,n,zone){return proj4(`EPSG:326${zone}`,'EPSG:4326',[e,n]);},fromLatLon(lon,lat,zone){return proj4('EPSG:4326',`EPSG:326${zone}`,[lon,lat]);},getZone(lon){return Math.floor((lon+180)/6)+1;}};

    // ========== HISTORY MANAGER ==========
    const HistoryMgr={save(action='change'){if(State.historyIdx<State.history.length-1)State.history=State.history.slice(0,State.historyIdx+1);const snap={action,polygon:State.polygon?JSON.parse(JSON.stringify(State.polygon)):null,blocks:State.blocks.map(b=>({id:b.id,geo:JSON.parse(JSON.stringify(b.geo)),area:b.area,color:b.color}))};State.history.push(snap);if(State.history.length>State.maxHistory)State.history.shift();State.historyIdx=State.history.length-1;this.updateBtns();},undo(){if(State.historyIdx>0){State.historyIdx--;this.restore();}},redo(){if(State.historyIdx<State.history.length-1){State.historyIdx++;this.restore();}},restore(){const snap=State.history[State.historyIdx];if(!snap)return;State.polygon=snap.polygon;State.blocks=snap.blocks.map(b=>({...b,uid:Math.random().toString(36).substr(2,9)}));if(State.polygon)ImportMgr.setPolygonSilent(State.polygon);Renderer.render();BotalonMgr.calculate();this.updateBtns();Toast.show('Estado restaurado','success');},updateBtns(){$('btn-undo').disabled=State.historyIdx<=0;$('btn-redo').disabled=State.historyIdx>=State.history.length-1;}};

    // ========== SELECTION MANAGER ==========
    const SelectMgr={toggle(uid){if(State.mode!=='select')return;State.selectedIds.has(uid)?State.selectedIds.delete(uid):State.selectedIds.add(uid);$('sel-count').textContent=State.selectedIds.size;Renderer.render();},clear(){State.selectedIds.clear();$('sel-count').textContent='0';Renderer.render();},merge(){if(State.selectedIds.size<2){Toast.show('Selecciona mnimo 2','error');return;}const toMerge=State.blocks.filter(b=>State.selectedIds.has(b.uid)),toKeep=State.blocks.filter(b=>!State.selectedIds.has(b.uid));try{let merged=toMerge[0].geo;for(let i=1;i<toMerge.length;i++)merged=turf.union(merged,toMerge[i].geo);State.blocks=[...toKeep,{uid:Math.random().toString(36).substr(2,9),id:`M-${Date.now().toString().slice(-4)}`,geo:merged,area:GeoMath.area(merged.geometry.coordinates[0]),color:toMerge[0].color}];this.clear();HistoryMgr.save('merge');Renderer.render();BotalonMgr.calculate();Toast.show('Fusionados','success');}catch(e){Toast.show('Error','error');}}};

    // ========== BOTALONES MANAGER ==========
    // ========== BOTALONES MANAGER ==========
    const BotalonMgr={calculate(){if(State.blocks.length===0){$('bot-summary').innerHTML='<p style="color:var(--text-3);font-size:11px;text-align:center;padding:20px;">Crea subdivisiones para calcular botalones</p>';State.botalonData=null;return;}const spacing=parseFloat($('bot-spacing').value)||50,price=parseFloat($('fence-price').value)||15;const processedEdges=new Set();const edgeKey=(p1,p2)=>{const k1=`${p1[0].toFixed(6)},${p1[1].toFixed(6)}`;const k2=`${p2[0].toFixed(6)},${p2[1].toFixed(6)}`;return k1<k2?`${k1}|${k2}`:`${k2}|${k1}`;};let grandTotalBot=0,grandTotalLen=0,allBotalones=[];const lotsData=[];State.blocks.forEach((block,idx)=>{const coords=block.geo.geometry.coordinates[0],zone=UTM.getZone(coords[0][0]),vertices=[],edges=[],lotBotalones=[];let lotPerimeter=0,lotBotCount=0;for(let i=0;i<coords.length-1;i++){const p1=coords[i],p2=coords[i+1];const edgeId=edgeKey(p1,p2);const utm1=UTM.fromLatLon(p1[0],p1[1],zone),dist=GeoMath.vincentyDist(p1[1],p1[0],p2[1],p2[0]),az=GeoMath.bearing(p1[1],p1[0],p2[1],p2[0]),rumbo=GeoMath.azToRumbo(az);vertices.push({n:i+1,lat:p1[1],lon:p1[0],utmE:utm1[0],utmN:utm1[1]});let numBot=0,isShared=false;if(!processedEdges.has(edgeId)){numBot=Math.ceil(dist/spacing)+1;lotBotCount+=numBot;for(let j=0;j<=Math.floor(dist/spacing);j++){const ratio=(j*spacing)/dist;if(ratio<=1){const lat=p1[1]+(p2[1]-p1[1])*ratio,lon=p1[0]+(p2[0]-p1[0])*ratio,utmB=UTM.fromLatLon(lon,lat,zone);const bot={lotId:block.id,n:allBotalones.length+1,lat,lon,utmE:utmB[0],utmN:utmB[1],lado:`${i+1}-${i+2}`};lotBotalones.push(bot);allBotalones.push(bot);}}processedEdges.add(edgeId);}else{isShared=true;numBot=0;}lotPerimeter+=dist;edges.push({from:i+1,to:i+2>coords.length-1?1:i+2,distance:dist,azimuth:az,rumbo,botalones:numBot,shared:isShared});}grandTotalBot+=lotBotCount;grandTotalLen+=lotPerimeter;lotsData.push({block,vertices,edges,botalones:lotBotalones,totalBotalones:lotBotCount,perimeter:lotPerimeter,cost:lotPerimeter*price});});const totalCost=grandTotalLen*price;State.botalonData={lotsData,allBotalones,grandTotalBot,grandTotalLen,totalCost,spacing,price};let html=`<div class="summary-box"><div class="summary-grid"><div class="summary-item"><div class="summary-val warning">${grandTotalBot}</div><div class="summary-lbl">Total Botalones</div></div><div class="summary-item"><div class="summary-val accent">${grandTotalLen.toFixed(1)}m</div><div class="summary-lbl">Cercado Total</div></div><div class="summary-item"><div class="summary-val success">$${totalCost.toFixed(0)}</div><div class="summary-lbl">Costo Total</div></div><div class="summary-item"><div class="summary-val danger">${State.blocks.length}</div><div class="summary-lbl">Lotes</div></div></div></div><div style="background:rgba(34,211,238,0.1);border:1px solid var(--cyan);border-radius:6px;padding:8px 12px;margin-bottom:12px;"><div style="display:flex;align-items:center;gap:6px;font-size:10px;color:var(--text-2);"><span style="font-size:7px;color:var(--cyan);"></span> <b>Lneas compartidas:</b> Los lados adyacentes entre lotes no duplican botalones</div></div><div class="section-lbl"><i class="fa-solid fa-list"></i> Detalle por Lote</div>`;lotsData.forEach(({block,vertices,edges,totalBotalones,perimeter,cost})=>{html+=`<div class="lot-card"><div class="lot-header" onclick="toggleLotBody('${block.uid}')"><div class="lot-title"><span class="color-badge" style="background:${block.color}"></span>Lote ${block.id}</div><div class="lot-badges"><span class="badge badge-warning">${totalBotalones} bot</span><span class="badge badge-accent">${perimeter.toFixed(1)}m</span></div></div><div class="lot-body" id="lot-body-${block.uid}"><div style="font-size:10px;color:var(--text-2);margin-bottom:8px;"><b>rea:</b> ${(block.area/10000).toFixed(4)} Ha | <b>Costo:</b> $${cost.toFixed(0)}</div><div style="font-size:9px;color:var(--primary);font-weight:700;margin:10px 0 4px;">VRTICES</div><table class="mini-table"><thead><tr><th>#</th><th>Lat</th><th>Lon</th><th>E</th><th>N</th></tr></thead><tbody>${vertices.map(v=>`<tr><td>${v.n}</td><td>${v.lat.toFixed(6)}</td><td>${v.lon.toFixed(6)}</td><td>${v.utmE.toFixed(1)}</td><td>${v.utmN.toFixed(1)}</td></tr>`).join('')}</tbody></table><div style="font-size:9px;color:var(--warning);font-weight:700;margin:12px 0 4px;">LADOS Y BOTALONES</div><table class="mini-table"><thead><tr><th>Lado</th><th>Dist</th><th>Az</th><th>Rumbo</th><th>Bot</th><th></th></tr></thead><tbody>${edges.map(e=>`<tr><td>${e.from}-${e.to}</td><td>${e.distance.toFixed(1)}m</td><td>${e.azimuth.toFixed(1)}</td><td style="font-size:8px;">${e.rumbo}</td><td style="color:${e.shared?'var(--text-3)':'var(--warning)'};font-weight:700;">${e.botalones}</td><td>${e.shared?'<span style="font-size:7px;color:var(--cyan);" title="Lado compartido"></span>':''}</td></tr>`).join('')}</tbody></table></div></div>`;});$('bot-summary').innerHTML=html;if($('bot-show').checked)this.displayOnMap();Toast.show(`${grandTotalBot} botalones calculados`,'success');},displayOnMap(){State.layers.botalones.clearLayers();if(!State.botalonData||!$('bot-show').checked)return;State.botalonData.allBotalones.forEach(b=>{L.circleMarker([b.lat,b.lon],{radius:4,fillColor:'#ef4444',color:'#fff',weight:1,fillOpacity:0.9}).bindPopup(`<b>Botaln ${b.n}</b><br>Lote: ${b.lotId}<br>Lado: ${b.lado}`).addTo(State.layers.botalones);});},toggleDisplay(){if($('bot-show').checked)this.displayOnMap();else State.layers.botalones.clearLayers();},exportKML(){if(!State.botalonData||State.blocks.length===0){Toast.show('Calcula primero','error');return;}const{lotsData}=State.botalonData;let kml=`<?xml version="1.0" encoding="UTF-8"?>\n<kml xmlns="http://www.opengis.net/kml/2.2">\n<Document>\n<n>WIN-TEL Botalones</n>\n<Style id="lot"><LineStyle><color>ff00ff00</color><width>2</width></LineStyle><PolyStyle><color>5000ff00</color></PolyStyle></Style>\n<Style id="vert"><IconStyle><Icon><href>http://maps.google.com/mapfiles/kml/shapes/placemark_circle.png</href></Icon><scale>0.6</scale><color>ff00a5ff</color></IconStyle></Style>\n<Style id="bot"><IconStyle><Icon><href>http://maps.google.com/mapfiles/kml/shapes/placemark_circle.png</href></Icon><scale>0.4</scale><color>ff0000ff</color></IconStyle></Style>\n<Folder><n>Lotes</n>\n`;lotsData.forEach(({block,vertices,edges,botalones,totalBotalones,perimeter,cost})=>{const coords=block.geo.geometry.coordinates[0].map(c=>`${c[0]},${c[1]},0`).join(' ');let vertDesc='VERTICES:\\n';vertices.forEach(v=>{vertDesc+=`V${v.n}: ${v.lat.toFixed(6)}, ${v.lon.toFixed(6)} | UTM: ${v.utmE.toFixed(1)}E, ${v.utmN.toFixed(1)}N\\n`;});let edgeDesc='\\nLADOS:\\n';edges.forEach(e=>{edgeDesc+=`${e.from}-${e.to}: ${e.distance.toFixed(2)}m | Az:${e.azimuth.toFixed(2)} | ${e.rumbo} | ${e.botalones} bot${e.shared?' (compartido)':''}\\n`;});kml+=`<Folder><n>Lote ${block.id}</n>\n<Placemark><n>Poligono ${block.id}</n><description><![CDATA[LOTE ${block.id}\nArea: ${(block.area/10000).toFixed(4)} Ha\nPerimetro: ${perimeter.toFixed(2)} m\nBotalones: ${totalBotalones}\nCosto: $${cost.toFixed(2)}\n\n${vertDesc}\n${edgeDesc}]]></description><styleUrl>#lot</styleUrl><Polygon><outerBoundaryIs><LinearRing><coordinates>${coords}</coordinates></LinearRing></outerBoundaryIs></Polygon></Placemark>\n<Folder><n>Vertices</n>\n`;vertices.forEach(v=>{kml+=`<Placemark><n>V${v.n}</n><description>Lat: ${v.lat.toFixed(6)}\nLon: ${v.lon.toFixed(6)}\nUTM: ${v.utmE.toFixed(2)}E, ${v.utmN.toFixed(2)}N</description><styleUrl>#vert</styleUrl><Point><coordinates>${v.lon},${v.lat},0</coordinates></Point></Placemark>\n`;});kml+=`</Folder>\n<Folder><n>Botalones</n>\n`;botalones.forEach(b=>{kml+=`<Placemark><n>B${b.n}</n><description>Lado: ${b.lado}\nLat: ${b.lat.toFixed(6)}\nLon: ${b.lon.toFixed(6)}</description><styleUrl>#bot</styleUrl><Point><coordinates>${b.lon},${b.lat},0</coordinates></Point></Placemark>\n`;});kml+=`</Folder></Folder>\n`;});kml+=`</Folder></Document></kml>`;download(kml,'botalones_completo.kml','application/vnd.google-earth.kml+xml');Toast.show('KML exportado','success');},exportGeoJSON(){if(!State.botalonData){Toast.show('Calcula primero','error');return;}const features=[];State.botalonData.lotsData.forEach(({block,vertices,edges,totalBotalones,perimeter,cost})=>{features.push({type:'Feature',geometry:block.geo.geometry,properties:{type:'lote',id:block.id,area_m2:block.area,area_ha:block.area/10000,perimetro_m:perimeter,botalones:totalBotalones,costo:cost,vertices,lados:edges}});});State.botalonData.allBotalones.forEach(b=>{features.push({type:'Feature',geometry:{type:'Point',coordinates:[b.lon,b.lat]},properties:{type:'botalon',id:b.n,lote_id:b.lotId,lado:b.lado,utm_e:b.utmE,utm_n:b.utmN}});});const geojson={type:'FeatureCollection',name:'WIN-TEL_Botalones',crs:{type:'name',properties:{name:'EPSG:4326'}},properties:{total_botalones:State.botalonData.grandTotalBot,cercado_total_m:State.botalonData.grandTotalLen,costo_total:State.botalonData.totalCost},features};download(JSON.stringify(geojson,null,2),'botalones_qgis.geojson','application/json');Toast.show('GeoJSON exportado','success');},exportCSV(){if(!State.botalonData){Toast.show('Calcula primero','error');return;}let csv=`REPORTE DE BOTALONES\nFecha,${new Date().toLocaleString()}\nEspaciado,${State.botalonData.spacing}m\nTotal Botalones,${State.botalonData.grandTotalBot}\nCercado Total,${State.botalonData.grandTotalLen.toFixed(2)}m\nCosto Total,$${State.botalonData.totalCost.toFixed(2)}\n\n`;State.botalonData.lotsData.forEach(({block,vertices,edges,botalones,totalBotalones,perimeter})=>{csv+=`\nLOTE ${block.id}\nArea_Ha,${(block.area/10000).toFixed(4)}\nPerimetro_m,${perimeter.toFixed(2)}\nBotalones,${totalBotalones}\n\nVERTICES\nN,Lat,Lon,UTM_E,UTM_N\n`;vertices.forEach(v=>{csv+=`${v.n},${v.lat.toFixed(6)},${v.lon.toFixed(6)},${v.utmE.toFixed(2)},${v.utmN.toFixed(2)}\n`;});csv+=`\nLADOS\nLado,Distancia_m,Azimut,Rumbo,Botalones,Compartido\n`;edges.forEach(e=>{csv+=`${e.from}-${e.to},${e.distance.toFixed(2)},${e.azimuth.toFixed(2)},${e.rumbo},${e.botalones},${e.shared?'SI':'NO'}\n`;});csv+=`\nBOTALONES\nN,Lado,Lat,Lon,UTM_E,UTM_N\n`;botalones.forEach(b=>{csv+=`${b.n},${b.lado},${b.lat.toFixed(6)},${b.lon.toFixed(6)},${b.utmE.toFixed(2)},${b.utmN.toFixed(2)}\n`;});});download(csv,'botalones_detalle.csv','text/csv');Toast.show('CSV exportado','success');},exportGPX(){if(!State.botalonData){Toast.show('Calcula primero','error');return;}let gpx=`<?xml version="1.0" encoding="UTF-8"?>\n<gpx version="1.1" creator="WIN-TEL">\n<metadata><n>Botalones</n><time>${new Date().toISOString()}</time></metadata>\n`;State.botalonData.allBotalones.forEach(b=>{gpx+=`<wpt lat="${b.lat.toFixed(8)}" lon="${b.lon.toFixed(8)}"><n>B${b.n}-L${b.lotId}</n><desc>Lado ${b.lado}</desc><sym>Flag, Red</sym></wpt>\n`;});gpx+=`</gpx>`;download(gpx,'botalones.gpx','application/gpx+xml');Toast.show('GPX exportado','success');}};

    // ========== GRID ENGINE ==========
    // === FUNCIN TOGGLE MODO DE SUBDIVISIN ===
    function SubdivModeToggle(){const mode=$('subdiv-mode').value;$('mode-dimension').style.display=mode==='dimension'?'block':'none';$('mode-exact').style.display=mode==='exact'?'block':'none';if(mode==='exact'&&State.polygon){ExactGridAlt.preview();}else if(mode==='dimension'&&State.polygon){DimensionEngine.preview();}}
    
    // === DIMENSION ENGINE (Por Dimensiones Ancho x Largo) ===
    const DimensionEngine={
        angle:0,
        updateAngle(val){this.angle=parseFloat(val)||0;$('dim-rot-disp').textContent=this.angle+'';this.preview();},
        preview(){if(!State.polygon)return;State.layers.preview.clearLayers();const ang=this.angle;const center=turf.centroid(State.polygon);const rotated=turf.transformRotate(State.polygon,-ang,{pivot:center});const bbox=turf.bbox(rotated);const rect=turf.bboxPolygon(bbox);const finalRect=turf.transformRotate(rect,ang,{pivot:center});L.geoJSON(finalRect,{style:{color:'#ff6600',weight:4,dashArray:'8,4',fill:false}}).addTo(State.layers.preview);},
        execute(){if(!State.polygon)return Toast.show('Dibuja un polgono primero','error');Loading.show();State.blocks=[];State.selectedIds.clear();const w=parseFloat($('lot-w').value)||20;const h=parseFloat($('lot-h').value)||10;const ang=this.angle;const roadW=parseFloat($('road-w').value)||10;const freqX=parseInt($('road-freq-x').value)||1;const freqY=parseInt($('road-freq-y').value)||100;const center=turf.centroid(State.polygon);const rotatedPoly=turf.transformRotate(State.polygon,-ang,{pivot:center});const bbox=turf.bbox(rotatedPoly);const[minX,minY,maxX,maxY]=bbox;const degW=w/111320,degH=h/111320,degRoad=roadW/111320;let currentY=minY,rowCount=0;const colors=State.colors[State.theme];while(currentY<maxY){let currentX=minX,colCount=0;while(currentX<maxX){const cell=turf.polygon([[[currentX,currentY],[currentX+degW,currentY],[currentX+degW,currentY+degH],[currentX,currentY+degH],[currentX,currentY]]]);try{const inter=turf.intersect(rotatedPoly,cell);if(inter){const final=turf.transformRotate(inter,ang,{pivot:center});const area=GeoMath.area(final.geometry.coordinates[0]);if(area>10){State.blocks.push({uid:Math.random().toString(36).substr(2,9),id:State.blocks.length+1,geo:final,area,color:colors[State.blocks.length%colors.length]});}}}catch(e){}currentX+=degW;colCount++;if(colCount%freqX===0)currentX+=degRoad;}currentY+=degH;rowCount++;if(rowCount%freqY===0)currentY+=degRoad;}State.layers.preview.clearLayers();HistoryMgr.save('dimension');Renderer.render();BotalonMgr.calculate();Loading.hide();Toast.show(`${State.blocks.length} lotes generados (${w}x${h}m)`,'success');}
    };
    
    // === EXACT GRID ALTERNATIVO (Filas x Columnas con controles independientes) ===
    const ExactGridAlt={
        angle:0,
        previewLayer:L.layerGroup(),
        alleyLayer:L.layerGroup(),
        updateAngle(val){this.angle=parseFloat(val)||0;$('exact-angle').value=this.angle;$('exact-angle-n').value=this.angle;this.preview();},
        getAlleyIdx(axis){const selector=axis==='h'?'.exact-alley-pos-h':'.exact-alley-pos-v';const idx=[];$$(selector).forEach(sel=>{const v=parseInt(sel.value);if(!isNaN(v))idx.push(v);});return idx.sort((a,b)=>a-b);},
        genAlleyControls(){
            const rows=parseInt($('exact-rows').value)||4;
            const cols=parseInt($('exact-cols').value)||4;
            const numH=parseInt($('exact-num-alleys-h').value)||0;
            const numV=parseInt($('exact-num-alleys-v').value)||0;
            let htmlH='';
            for(let i=0;i<numH;i++){
                htmlH+=`<div class="form-group" style="margin-top:8px;"><label class="form-label" style="font-size:10px;">Despus de fila:</label><select class="form-input exact-alley-pos-h" style="padding:8px;" onchange="ExactGridAlt.preview()">${Array.from({length:rows},(_,j)=>`<option value="${j+1}" ${j+1===Math.min(i+1,rows)?'selected':''}>Fila ${j+1}</option>`).join('')}</select></div>`;
            }
            $('exact-alley-ctrl-h').innerHTML=htmlH;
            let htmlV='';
            for(let i=0;i<numV;i++){
                htmlV+=`<div class="form-group" style="margin-top:8px;"><label class="form-label" style="font-size:10px;">Despus de col:</label><select class="form-input exact-alley-pos-v" style="padding:8px;" onchange="ExactGridAlt.preview()">${Array.from({length:cols},(_,j)=>`<option value="${j+1}" ${j+1===Math.min(i+1,cols)?'selected':''}>Col ${j+1}</option>`).join('')}</select></div>`;
            }
            $('exact-alley-ctrl-v').innerHTML=htmlV;
            this.preview();
        },
        preview(){
            if(!State.polygon)return;
            this.previewLayer.clearLayers();
            this.alleyLayer.clearLayers();
            if(!State.map.hasLayer(this.previewLayer))State.map.addLayer(this.previewLayer);
            if(!State.map.hasLayer(this.alleyLayer))State.map.addLayer(this.alleyLayer);
            const rows=parseInt($('exact-rows').value)||4;
            const cols=parseInt($('exact-cols').value)||4;
            const angle=this.angle;
            const alleyWH=parseFloat($('exact-alley-w-h').value)||0;
            const alleyWV=parseFloat($('exact-alley-w-v').value)||0;
            const alleyIdxH=this.getAlleyIdx('h');
            const alleyIdxV=this.getAlleyIdx('v');
            const poly=turf.cleanCoords(turf.rewind(State.polygon));
            const center=turf.centroid(poly);
            const rotated=turf.transformRotate(poly,-angle,{pivot:center});
            const bbox=turf.bbox(rotated);
            const[minX,minY,maxX,maxY]=bbox;
            const degAlleyH=alleyWH/111320;
            const degAlleyV=alleyWV/111320;
            const totalAlleyH=alleyIdxH.length*degAlleyH;
            const totalAlleyV=alleyIdxV.length*degAlleyV;
            const cellH=((maxY-minY)-totalAlleyH)/rows;
            const cellW=((maxX-minX)-totalAlleyV)/cols;
            let currentY=minY;
            for(let r=0;r<=rows;r++){
                if(alleyIdxH.includes(r)){
                    let ap=turf.polygon([[[minX,currentY],[maxX+totalAlleyV,currentY],[maxX+totalAlleyV,currentY+degAlleyH],[minX,currentY+degAlleyH],[minX,currentY]]]);
                    ap=turf.transformRotate(ap,angle,{pivot:center});
                    L.geoJSON(ap,{style:{color:'#22d3ee',weight:2,fillColor:'#22d3ee',fillOpacity:0.4}}).addTo(this.alleyLayer);
                    currentY+=degAlleyH;
                }
                let line=turf.lineString([[minX,currentY],[maxX+totalAlleyV,currentY]]);
                line=turf.transformRotate(line,angle,{pivot:center});
                L.geoJSON(line,{style:{color:'#22d3ee',weight:2,opacity:0.8,dashArray:'4,4'}}).addTo(this.previewLayer);
                currentY+=cellH;
            }
            let currentX=minX;
            for(let c=0;c<=cols;c++){
                if(alleyIdxV.includes(c)){
                    let ap=turf.polygon([[[currentX,minY],[currentX+degAlleyV,minY],[currentX+degAlleyV,maxY+totalAlleyH],[currentX,maxY+totalAlleyH],[currentX,minY]]]);
                    ap=turf.transformRotate(ap,angle,{pivot:center});
                    L.geoJSON(ap,{style:{color:'#fbbf24',weight:2,fillColor:'#fbbf24',fillOpacity:0.4}}).addTo(this.alleyLayer);
                    currentX+=degAlleyV;
                }
                let line=turf.lineString([[currentX,minY],[currentX,maxY+totalAlleyH]]);
                line=turf.transformRotate(line,angle,{pivot:center});
                L.geoJSON(line,{style:{color:'#fbbf24',weight:2,opacity:0.8,dashArray:'4,4'}}).addTo(this.previewLayer);
                currentX+=cellW;
            }
        },
        apply(){
            if(!State.polygon)return Toast.show('Dibuja un polgono primero','error');
            Loading.show();
            State.blocks=[];
            State.selectedIds.clear();
            const rows=parseInt($('exact-rows').value)||4;
            const cols=parseInt($('exact-cols').value)||4;
            const angle=this.angle;
            const alleyWH=parseFloat($('exact-alley-w-h').value)||0;
            const alleyWV=parseFloat($('exact-alley-w-v').value)||0;
            const alleyIdxH=this.getAlleyIdx('h');
            const alleyIdxV=this.getAlleyIdx('v');
            const poly=turf.cleanCoords(turf.rewind(State.polygon));
            const center=turf.centroid(poly);
            const rotated=turf.transformRotate(poly,-angle,{pivot:center});
            const bbox=turf.bbox(rotated);
            const[minX,minY,maxX,maxY]=bbox;
            const degAlleyH=alleyWH/111320;
            const degAlleyV=alleyWV/111320;
            const totalAlleyH=alleyIdxH.length*degAlleyH;
            const totalAlleyV=alleyIdxV.length*degAlleyV;
            const cellH=((maxY-minY)-totalAlleyH)/rows;
            const cellW=((maxX-minX)-totalAlleyV)/cols;
            const colors=State.colors[State.theme];
            const offsetsY=[];
            let accumY=0;
            for(let r=0;r<=rows;r++){
                if(alleyIdxH.includes(r))accumY+=degAlleyH;
                offsetsY[r]=accumY;
            }
            const offsetsX=[];
            let accumX=0;
            for(let c=0;c<=cols;c++){
                if(alleyIdxV.includes(c))accumX+=degAlleyV;
                offsetsX[c]=accumX;
            }
            for(let r=0;r<rows;r++){
                for(let c=0;c<cols;c++){
                    const y1=minY+r*cellH+offsetsY[r];
                    const y2=y1+cellH;
                    const x1=minX+c*cellW+offsetsX[c];
                    const x2=x1+cellW;
                    let cell=turf.polygon([[[x1,y1],[x2,y1],[x2,y2],[x1,y2],[x1,y1]]]);
                    cell=turf.transformRotate(cell,angle,{pivot:center});
                    try{
                        const inter=turf.intersect(poly,cell);
                        if(inter){
                            const process=geo=>{
                                const area=GeoMath.area(geo.geometry.coordinates[0]);
                                if(area>1)State.blocks.push({uid:Math.random().toString(36).substr(2,9),id:State.blocks.length+1,geo,area,color:colors[State.blocks.length%colors.length]});
                            };
                            inter.geometry.type==='MultiPolygon'?inter.geometry.coordinates.forEach(coord=>process(turf.polygon(coord))):process(inter);
                        }
                    }catch(e){}
                }
            }
            for(let r=0;r<rows;r++){
                if(alleyIdxH.includes(r+1)){
                    const y1=minY+(r+1)*cellH+offsetsY[r];
                    const y2=y1+degAlleyH;
                    let ap=turf.polygon([[[minX,y1],[maxX+totalAlleyV,y1],[maxX+totalAlleyV,y2],[minX,y2],[minX,y1]]]);
                    ap=turf.transformRotate(ap,angle,{pivot:center});
                    try{
                        const clipped=turf.intersect(poly,ap);
                        if(clipped)L.geoJSON(clipped,{style:{color:'#475569',weight:2,fillColor:'#22d3ee',fillOpacity:0.5}}).bindPopup('<b>VIALIDAD HORIZONTAL</b>').addTo(State.layers.result);
                    }catch(e){}
                }
            }
            for(let c=0;c<cols;c++){
                if(alleyIdxV.includes(c+1)){
                    const x1=minX+(c+1)*cellW+offsetsX[c];
                    const x2=x1+degAlleyV;
                    let ap=turf.polygon([[[x1,minY],[x2,minY],[x2,maxY+totalAlleyH],[x1,maxY+totalAlleyH],[x1,minY]]]);
                    ap=turf.transformRotate(ap,angle,{pivot:center});
                    try{
                        const clipped=turf.intersect(poly,ap);
                        if(clipped)L.geoJSON(clipped,{style:{color:'#475569',weight:2,fillColor:'#fbbf24',fillOpacity:0.5}}).bindPopup('<b>VIALIDAD VERTICAL</b>').addTo(State.layers.result);
                    }catch(e){}
                }
            }
            this.previewLayer.clearLayers();
            this.alleyLayer.clearLayers();
            HistoryMgr.save('exactgrid');
            Renderer.render();
            BotalonMgr.calculate();
            Loading.hide();
            Toast.show(`${State.blocks.length} lotes (${rows}x${cols}) + ${alleyIdxH.length}H/${alleyIdxV.length}V vialidades`,'success');
        }
    };

    // ========== CADASTRE ENGINE - NOMENCLATURA CATASTRAL ==========
    const CadastreEngine={
        updatePreview(){
            const format=$('cadastre-format').value;
            const mz=$('cadastre-mz').value||'01';
            const start=parseInt($('cadastre-start').value)||1;
            $('cadastre-custom').style.display=format==='CUSTOM'?'block':'none';
            let preview='';
            if(format==='MZ-LT'){
                preview=`MZ-${mz.toString().padStart(2,'0')}-LT-${start.toString().padStart(3,'0')}`;
            }else if(format==='SEC-BLQ-PAR'){
                preview=`SEC-${mz.toString().padStart(2,'0')}-BLQ-01-PAR-${start.toString().padStart(3,'0')}`;
            }else{
                const prefix=$('cadastre-prefix').value||'LOTE-';
                preview=`${prefix}${start.toString().padStart(3,'0')}`;
            }
            $('cadastre-preview').textContent=preview;
        },
        generateCode(index){
            const format=$('cadastre-format').value;
            const mz=$('cadastre-mz').value||'01';
            const start=parseInt($('cadastre-start').value)||1;
            const num=start+index;
            if(format==='MZ-LT'){
                return `MZ-${mz.toString().padStart(2,'0')}-LT-${num.toString().padStart(3,'0')}`;
            }else if(format==='SEC-BLQ-PAR'){
                const blq=Math.floor(index/20)+1;
                const par=(index%20)+1;
                return `SEC-${mz.toString().padStart(2,'0')}-BLQ-${blq.toString().padStart(2,'0')}-PAR-${(start+par-1).toString().padStart(3,'0')}`;
            }else{
                const prefix=$('cadastre-prefix').value||'LOTE-';
                return `${prefix}${num.toString().padStart(3,'0')}`;
            }
        },
        sortBlocks(){
            if(State.blocks.length===0)return;
            const direction=$('cadastre-direction').value;
            const sorted=[...State.blocks];
            sorted.forEach(b=>{
                const center=turf.centroid(b.geo);
                b._cx=center.geometry.coordinates[0];
                b._cy=center.geometry.coordinates[1];
            });
            if(direction==='row-ltr'){
                sorted.sort((a,b)=>b._cy-a._cy||a._cx-b._cx);
            }else if(direction==='row-rtl'){
                sorted.sort((a,b)=>b._cy-a._cy||b._cx-a._cx);
            }else if(direction==='col-ttb'){
                sorted.sort((a,b)=>a._cx-b._cx||b._cy-a._cy);
            }else if(direction==='snake'){
                const rows=[];
                const tolerance=0.00005;
                sorted.sort((a,b)=>b._cy-a._cy);
                let currentRow=[];
                let lastY=sorted[0]?sorted[0]._cy:0;
                sorted.forEach(b=>{
                    if(Math.abs(b._cy-lastY)>tolerance){
                        rows.push(currentRow);
                        currentRow=[b];
                        lastY=b._cy;
                    }else{
                        currentRow.push(b);
                    }
                });
                if(currentRow.length)rows.push(currentRow);
                const result=[];
                rows.forEach((row,i)=>{
                    row.sort((a,b)=>i%2===0?a._cx-b._cx:b._cx-a._cx);
                    result.push(...row);
                });
                State.blocks=result;
                return;
            }
            State.blocks=sorted;
        },
        apply(){
            if(State.blocks.length===0)return Toast.show('No hay lotes para nomenclar','error');
            this.sortBlocks();
            State.blocks.forEach((b,i)=>{
                b.cadastre=this.generateCode(i);
                b.id=b.cadastre;
            });
            HistoryMgr.save('cadastre');
            Renderer.render();
            Toast.show(`Nomenclatura aplicada a ${State.blocks.length} lotes`,'success');
        },
        exportTable(){
            if(State.blocks.length===0)return Toast.show('No hay lotes','error');
            let csv='CODIGO_CATASTRAL,ID,AREA_M2,AREA_HA,PERIMETRO_M,CENTROIDE_LAT,CENTROIDE_LON\n';
            State.blocks.forEach(b=>{
                const center=turf.centroid(b.geo);
                const coords=b.geo.geometry.coordinates[0];
                const perim=GeoMath.perimeter(coords);
                csv+=`${b.cadastre||b.id},${b.id},${b.area.toFixed(2)},${(b.area/10000).toFixed(4)},${perim.toFixed(2)},${center.geometry.coordinates[1].toFixed(8)},${center.geometry.coordinates[0].toFixed(8)}\n`;
            });
            download(csv,`cuadro_areas_catastral_${Date.now()}.csv`,'text/csv');
            Toast.show('Cuadro de reas exportado','success');
        }
    };

    // ========== FIXED LOTS ENGINE - LOTES CON DIMENSIONES FIJAS ==========
    const FixedLotsEngine={
        angle:0,
        previewLayer:L.layerGroup(),
        updateAngle(val){
            this.angle=parseFloat(val)||0;
            $('fixed-angle').value=this.angle;
            $('fixed-angle-n').value=this.angle;
            this.preview();
        },
        preview(){
            if(!State.polygon)return;
            this.previewLayer.clearLayers();
            if(!State.map.hasLayer(this.previewLayer))State.map.addLayer(this.previewLayer);
            const lotW=parseFloat($('fixed-width').value)||15;
            const lotD=parseFloat($('fixed-depth').value)||30;
            const alleyH=parseFloat($('fixed-alley-h').value)||0;
            const alleyV=parseFloat($('fixed-alley-v').value)||0;
            const freqH=parseInt($('fixed-alley-freq-h').value)||2;
            const freqV=parseInt($('fixed-alley-freq-v').value)||2;
            const angle=this.angle;
            const poly=turf.cleanCoords(turf.rewind(State.polygon));
            const center=turf.centroid(poly);
            const rotated=turf.transformRotate(poly,-angle,{pivot:center});
            const bbox=turf.bbox(rotated);
            const[minX,minY,maxX,maxY]=bbox;
            const totalW=maxX-minX;
            const totalH=maxY-minY;
            const degLotW=lotW/111320;
            const degLotD=lotD/111320;
            const degAlleyH=alleyH/111320;
            const degAlleyV=alleyV/111320;
            const effectiveLotW=degLotW+(alleyV>0?degAlleyV/freqV:0);
            const effectiveLotH=degLotD+(alleyH>0?degAlleyH/freqH:0);
            const cols=Math.floor(totalW/effectiveLotW);
            const rows=Math.floor(totalH/effectiveLotH);
            let lotCount=0;
            let currentY=minY;
            for(let r=0;r<rows;r++){
                let currentX=minX;
                for(let c=0;c<cols;c++){
                    let cell=turf.polygon([[[currentX,currentY],[currentX+degLotW,currentY],[currentX+degLotW,currentY+degLotD],[currentX,currentY+degLotD],[currentX,currentY]]]);
                    cell=turf.transformRotate(cell,angle,{pivot:center});
                    try{
                        const inter=turf.intersect(poly,cell);
                        if(inter&&turf.area(inter)>10){
                            L.geoJSON(inter,{style:{color:'#fbbf24',weight:1,fillColor:'#fbbf24',fillOpacity:0.3}}).addTo(this.previewLayer);
                            lotCount++;
                        }
                    }catch(e){}
                    currentX+=degLotW;
                    if(alleyV>0&&(c+1)%freqV===0)currentX+=degAlleyV;
                }
                currentY+=degLotD;
                if(alleyH>0&&(r+1)%freqH===0)currentY+=degAlleyH;
            }
            const totalArea=GeoMath.area(poly.geometry.coordinates[0]);
            const lotArea=lotW*lotD;
            const usedArea=lotCount*lotArea;
            const remainder=totalArea-usedArea;
            $('fixed-lot-count').textContent=lotCount;
            $('fixed-lot-area').textContent=`${lotArea.toFixed(1)} m`;
            $('fixed-remainder').textContent=`${remainder.toFixed(1)} m`;
        },
        apply(){
            if(!State.polygon)return Toast.show('Dibuja un polgono primero','error');
            Loading.show();
            State.blocks=[];
            State.selectedIds.clear();
            this.previewLayer.clearLayers();
            const lotW=parseFloat($('fixed-width').value)||15;
            const lotD=parseFloat($('fixed-depth').value)||30;
            const alleyH=parseFloat($('fixed-alley-h').value)||0;
            const alleyV=parseFloat($('fixed-alley-v').value)||0;
            const freqH=parseInt($('fixed-alley-freq-h').value)||2;
            const freqV=parseInt($('fixed-alley-freq-v').value)||2;
            const angle=this.angle;
            const poly=turf.cleanCoords(turf.rewind(State.polygon));
            const center=turf.centroid(poly);
            const rotated=turf.transformRotate(poly,-angle,{pivot:center});
            const bbox=turf.bbox(rotated);
            const[minX,minY,maxX,maxY]=bbox;
            const totalW=maxX-minX;
            const totalH=maxY-minY;
            const degLotW=lotW/111320;
            const degLotD=lotD/111320;
            const degAlleyH=alleyH/111320;
            const degAlleyV=alleyV/111320;
            const effectiveLotW=degLotW+(alleyV>0?degAlleyV/freqV:0);
            const effectiveLotH=degLotD+(alleyH>0?degAlleyH/freqH:0);
            const cols=Math.floor(totalW/effectiveLotW);
            const rows=Math.floor(totalH/effectiveLotH);
            const colors=State.colors[State.theme];
            let currentY=minY;
            for(let r=0;r<rows;r++){
                let currentX=minX;
                for(let c=0;c<cols;c++){
                    let cell=turf.polygon([[[currentX,currentY],[currentX+degLotW,currentY],[currentX+degLotW,currentY+degLotD],[currentX,currentY+degLotD],[currentX,currentY]]]);
                    cell=turf.transformRotate(cell,angle,{pivot:center});
                    try{
                        const inter=turf.intersect(poly,cell);
                        if(inter){
                            const process=geo=>{
                                const area=GeoMath.area(geo.geometry.coordinates[0]);
                                if(area>1)State.blocks.push({uid:Math.random().toString(36).substr(2,9),id:State.blocks.length+1,geo,area,color:colors[State.blocks.length%colors.length],isFixed:true,targetArea:lotW*lotD});
                            };
                            inter.geometry.type==='MultiPolygon'?inter.geometry.coordinates.forEach(coord=>process(turf.polygon(coord))):process(inter);
                        }
                    }catch(e){}
                    currentX+=degLotW;
                    if(alleyV>0&&(c+1)%freqV===0){
                        let alley=turf.polygon([[[currentX,minY],[currentX+degAlleyV,minY],[currentX+degAlleyV,maxY],[currentX,maxY],[currentX,minY]]]);
                        alley=turf.transformRotate(alley,angle,{pivot:center});
                        try{
                            const clipped=turf.intersect(poly,alley);
                            if(clipped)L.geoJSON(clipped,{style:{color:'#475569',weight:2,fillColor:'#fbbf24',fillOpacity:0.5}}).bindPopup('<b>VIALIDAD VERTICAL</b>').addTo(State.layers.result);
                        }catch(e){}
                        currentX+=degAlleyV;
                    }
                }
                currentY+=degLotD;
                if(alleyH>0&&(r+1)%freqH===0){
                    let alley=turf.polygon([[[minX,currentY],[maxX,currentY],[maxX,currentY+degAlleyH],[minX,currentY+degAlleyH],[minX,currentY]]]);
                    alley=turf.transformRotate(alley,angle,{pivot:center});
                    try{
                        const clipped=turf.intersect(poly,alley);
                        if(clipped)L.geoJSON(clipped,{style:{color:'#475569',weight:2,fillColor:'#22d3ee',fillOpacity:0.5}}).bindPopup('<b>VIALIDAD HORIZONTAL</b>').addTo(State.layers.result);
                    }catch(e){}
                    currentY+=degAlleyH;
                }
            }
            HistoryMgr.save('fixedlots');
            Renderer.render();
            BotalonMgr.calculate();
            Loading.hide();
            Toast.show(`${State.blocks.length} lotes de ${lotW}x${lotD}m generados`,'success');
        }
    };

    // ========== RESERVE ENGINE - REAS RESERVADAS INTERNAS ==========
    const ReserveEngine={
        reserves:[],
        reserveLayer:L.layerGroup(),
        drawHandler:null,
        typeColors:{green:'#22c55e',equipment:'#8b5cf6',water:'#3b82f6',road:'#64748b',utility:'#f59e0b',custom:'#ec4899'},
        typeNames:{green:'rea Verde',equipment:'Equipamiento Urbano',water:'Cuerpo de Agua',road:'Vialidad Principal',utility:'Servicios Pblicos',custom:'Personalizado'},
        init(){
            if(!State.map.hasLayer(this.reserveLayer))State.map.addLayer(this.reserveLayer);
            $('reserve-type').addEventListener('change',()=>{
                $('reserve-custom-name').style.display=$('reserve-type').value==='custom'?'block':'none';
            });
        },
        startDraw(){
            if(!State.polygon)return Toast.show('Dibuja un polgono principal primero','error');
            Toast.show('Dibuja el rea reservada en el mapa','info');
            if(this.drawHandler){
                State.map.removeControl(this.drawHandler);
            }
            this.drawHandler=new L.Draw.Polygon(State.map,{
                shapeOptions:{color:'#ef4444',fillColor:'#ef4444',fillOpacity:0.5,weight:2}
            });
            this.drawHandler.enable();
            State.map.once('draw:created',(e)=>{
                const layer=e.layer;
                const coords=layer.getLatLngs()[0].map(ll=>[ll.lng,ll.lat]);
                coords.push(coords[0]);
                const reservePoly=turf.polygon([coords]);
                try{
                    const clipped=turf.intersect(State.polygon,reservePoly);
                    if(clipped){
                        this.addReserve(clipped);
                    }else{
                        Toast.show('El rea debe estar dentro del polgono','error');
                    }
                }catch(e){
                    Toast.show('Error al crear reserva','error');
                }
            });
        },
        addReserve(geo){
            const type=$('reserve-type').value;
            const name=type==='custom'?($('reserve-name').value||'Reserva'):this.typeNames[type];
            const area=GeoMath.area(geo.geometry.coordinates[0]);
            const reserve={
                uid:Math.random().toString(36).substr(2,9),
                type,
                name,
                geo,
                area,
                color:this.typeColors[type]
            };
            this.reserves.push(reserve);
            this.renderReserves();
            this.updateSummary();
            Toast.show(`${name} aadida (${(area/10000).toFixed(4)} Ha)`,'success');
        },
        importFromSelection(){
            if(State.selectedIds.size===0)return Toast.show('Selecciona lotes primero','error');
            const type=$('reserve-type').value;
            const name=type==='custom'?($('reserve-name').value||'Reserva'):this.typeNames[type];
            const selectedBlocks=State.blocks.filter(b=>State.selectedIds.has(b.uid));
            selectedBlocks.forEach(block=>{
                const reserve={
                    uid:Math.random().toString(36).substr(2,9),
                    type,
                    name,
                    geo:block.geo,
                    area:block.area,
                    color:this.typeColors[type]
                };
                this.reserves.push(reserve);
            });
            State.blocks=State.blocks.filter(b=>!State.selectedIds.has(b.uid));
            State.selectedIds.clear();
            this.renderReserves();
            this.updateSummary();
            Renderer.render();
            Toast.show(`${selectedBlocks.length} lotes convertidos a ${name}`,'success');
        },
        renderReserves(){
            this.reserveLayer.clearLayers();
            this.reserves.forEach(r=>{
                L.geoJSON(r.geo,{
                    style:{color:r.color,weight:2,fillColor:r.color,fillOpacity:0.6,dashArray:'5,5'}
                }).bindPopup(`<b>${r.name}</b><br>rea: ${(r.area/10000).toFixed(4)} Ha`).addTo(this.reserveLayer);
            });
            let html='';
            this.reserves.forEach((r,i)=>{
                html+=`<div style="display:flex;align-items:center;justify-content:space-between;padding:8px;background:var(--bg-glass);border-radius:4px;margin-bottom:6px;border-left:4px solid ${r.color};">
                    <div>
                        <div style="font-weight:700;font-size:11px;color:#fff;">${r.name}</div>
                        <div style="font-size:10px;color:var(--text-3);">${(r.area/10000).toFixed(4)} Ha</div>
                    </div>
                    <button onclick="ReserveEngine.removeReserve(${i})" style="background:#ef4444;border:none;color:#fff;padding:4px 8px;border-radius:4px;cursor:pointer;font-size:10px;"><i class="fa-solid fa-trash"></i></button>
                </div>`;
            });
            $('reserves-list').innerHTML=html;
        },
        removeReserve(index){
            this.reserves.splice(index,1);
            this.renderReserves();
            this.updateSummary();
            Toast.show('Reserva eliminada','success');
        },
        clearAll(){
            this.reserves=[];
            this.renderReserves();
            this.updateSummary();
            Toast.show('Todas las reservas eliminadas','success');
        },
        updateSummary(){
            if(!State.polygon||this.reserves.length===0){
                $('reserves-summary').style.display='none';
                return;
            }
            $('reserves-summary').style.display='block';
            const totalPolyArea=GeoMath.area(State.polygon.geometry.coordinates[0]);
            const byType={};
            let totalReserved=0;
            this.reserves.forEach(r=>{
                if(!byType[r.type])byType[r.type]={name:r.name,area:0,color:r.color};
                byType[r.type].area+=r.area;
                totalReserved+=r.area;
            });
            let tableHtml='';
            Object.values(byType).forEach(t=>{
                const pct=(t.area/totalPolyArea*100).toFixed(2);
                tableHtml+=`<tr><td><span style="display:inline-block;width:10px;height:10px;background:${t.color};border-radius:2px;margin-right:5px;"></span>${t.name}</td><td>${t.area.toFixed(2)}</td><td>${pct}%</td></tr>`;
            });
            $('reserves-table').innerHTML=tableHtml;
            const reservedPct=(totalReserved/totalPolyArea*100).toFixed(2);
            const loteableArea=totalPolyArea-totalReserved;
            const loteablePct=(loteableArea/totalPolyArea*100).toFixed(2);
            $('total-reserved-area').textContent=totalReserved.toFixed(2);
            $('total-reserved-pct').textContent=reservedPct+'%';
            $('total-loteable-area').textContent=loteableArea.toFixed(2);
            $('total-loteable-pct').textContent=loteablePct+'%';
            const minPct=parseFloat($('reserve-min-pct').value)||10;
            const compliance=$('reserve-compliance');
            if(parseFloat(reservedPct)>=minPct){
                compliance.style.background='rgba(34,197,94,0.2)';
                compliance.style.color='#22c55e';
                compliance.innerHTML=`<i class="fa-solid fa-check-circle"></i> CUMPLE NORMATIVA (${reservedPct}%  ${minPct}%)`;
            }else{
                compliance.style.background='rgba(239,68,68,0.2)';
                compliance.style.color='#ef4444';
                compliance.innerHTML=`<i class="fa-solid fa-exclamation-triangle"></i> NO CUMPLE (${reservedPct}% < ${minPct}% requerido)`;
            }
        },
        getSubdividablePolygon(){
            if(this.reserves.length===0)return State.polygon;
            let result=State.polygon;
            this.reserves.forEach(r=>{
                try{
                    const diff=turf.difference(result,r.geo);
                    if(diff)result=diff;
                }catch(e){}
            });
            return result;
        }
    };
    setTimeout(()=>ReserveEngine.init(),1000);

    // ========== FURROW ENGINE - PLANIFICADOR DE SURCOS AGRCOLAS ==========
    const FurrowEngine={
        furrowLayer:L.layerGroup(),
        previewLayer:L.layerGroup(),
        angle:0,
        furrows:[],
        updateAngle(val){
            this.angle=parseFloat(val)||0;
            $('furrow-angle').value=this.angle;
            $('furrow-angle-n').value=this.angle;
            this.preview();
        },
        setCropDefaults(){
            const crop=$('furrow-crop').value;
            const defaults={
                maiz:{spacing:0.80,width:0.30,plants:70000},
                soya:{spacing:0.50,width:0.20,plants:400000},
                cafe:{spacing:2.00,width:0.50,plants:5000},
                cana:{spacing:1.50,width:0.40,plants:10000},
                hortaliza:{spacing:0.40,width:0.15,plants:100000},
                papa:{spacing:0.90,width:0.30,plants:45000},
                tomate:{spacing:1.20,width:0.35,plants:20000},
                pasto:{spacing:0.20,width:0.10,plants:0}
            };
            if(defaults[crop]){
                $('furrow-spacing').value=defaults[crop].spacing;
                $('furrow-width').value=defaults[crop].width;
                this.preview();
            }
        },
        togglePreview(){
            if($('furrow-preview-on').checked){
                this.preview();
            }else{
                this.previewLayer.clearLayers();
            }
        },
        preview(){
            if(!State.polygon||!$('furrow-preview-on').checked)return;
            this.previewLayer.clearLayers();
            if(!State.map.hasLayer(this.previewLayer))State.map.addLayer(this.previewLayer);
            const spacing=parseFloat($('furrow-spacing').value)||0.80;
            const headStart=parseFloat($('furrow-head-start').value)||5;
            const headEnd=parseFloat($('furrow-head-end').value)||5;
            const marginLeft=parseFloat($('furrow-margin-left').value)||2;
            const marginRight=parseFloat($('furrow-margin-right').value)||2;
            const angle=this.angle;
            const poly=turf.cleanCoords(turf.rewind(State.polygon));
            const center=turf.centroid(poly);
            const rotated=turf.transformRotate(poly,-angle,{pivot:center});
            const bbox=turf.bbox(rotated);
            const[minX,minY,maxX,maxY]=bbox;
            const degSpacing=spacing/111320;
            const degHeadStart=headStart/111320;
            const degHeadEnd=headEnd/111320;
            const degMarginLeft=marginLeft/111320;
            const degMarginRight=marginRight/111320;
            const effectiveMinX=minX+degMarginLeft;
            const effectiveMaxX=maxX-degMarginRight;
            const effectiveMinY=minY+degHeadStart;
            const effectiveMaxY=maxY-degHeadEnd;
            const width=effectiveMaxX-effectiveMinX;
            const numFurrows=Math.floor(width/degSpacing);
            for(let i=0;i<=numFurrows;i++){
                const x=effectiveMinX+i*degSpacing;
                let line=turf.lineString([[x,effectiveMinY],[x,effectiveMaxY]]);
                line=turf.transformRotate(line,angle,{pivot:center});
                try{
                    const clipped=turf.lineIntersect(line,poly);
                    if(clipped.features.length>=2){
                        const pts=clipped.features.map(f=>f.geometry.coordinates);
                        L.polyline(pts.map(p=>[p[1],p[0]]),{
                            color:'#22c55e',weight:1,opacity:0.6,dashArray:'4,4'
                        }).addTo(this.previewLayer);
                    }
                }catch(e){}
            }
        },
        generate(){
            if(!State.polygon)return Toast.show('Dibuja un polgono primero','error');
            Loading.show();
            this.furrowLayer.clearLayers();
            this.previewLayer.clearLayers();
            if(!State.map.hasLayer(this.furrowLayer))State.map.addLayer(this.furrowLayer);
            this.furrows=[];
            const spacing=parseFloat($('furrow-spacing').value)||0.80;
            const furrowWidth=parseFloat($('furrow-width').value)||0.30;
            const headStart=parseFloat($('furrow-head-start').value)||5;
            const headEnd=parseFloat($('furrow-head-end').value)||5;
            const marginLeft=parseFloat($('furrow-margin-left').value)||2;
            const marginRight=parseFloat($('furrow-margin-right').value)||2;
            const angle=this.angle;
            const poly=turf.cleanCoords(turf.rewind(State.polygon));
            const center=turf.centroid(poly);
            const rotated=turf.transformRotate(poly,-angle,{pivot:center});
            const bbox=turf.bbox(rotated);
            const[minX,minY,maxX,maxY]=bbox;
            const degSpacing=spacing/111320;
            const degHeadStart=headStart/111320;
            const degHeadEnd=headEnd/111320;
            const degMarginLeft=marginLeft/111320;
            const degMarginRight=marginRight/111320;
            const effectiveMinX=minX+degMarginLeft;
            const effectiveMaxX=maxX-degMarginRight;
            const effectiveMinY=minY+degHeadStart;
            const effectiveMaxY=maxY-degHeadEnd;
            const width=effectiveMaxX-effectiveMinX;
            const numFurrows=Math.floor(width/degSpacing);
            let totalLength=0;
            for(let i=0;i<=numFurrows;i++){
                const x=effectiveMinX+i*degSpacing;
                let line=turf.lineString([[x,effectiveMinY],[x,effectiveMaxY]]);
                line=turf.transformRotate(line,angle,{pivot:center});
                try{
                    const clipped=turf.lineSplit(line,poly);
                    if(clipped.features.length>0){
                        clipped.features.forEach(segment=>{
                            const segmentInside=turf.booleanWithin(turf.centroid(segment),poly);
                            if(segmentInside||turf.booleanIntersects(segment,poly)){
                                const coords=segment.geometry.coordinates;
                                const length=turf.length(segment,{units:'meters'});
                                if(length>1){
                                    totalLength+=length;
                                    this.furrows.push({
                                        id:this.furrows.length+1,
                                        coords:coords,
                                        length:length
                                    });
                                    L.polyline(coords.map(c=>[c[1],c[0]]),{
                                        color:'#16a34a',weight:2,opacity:0.9
                                    }).bindPopup(`<b>Surco ${this.furrows.length}</b><br>Longitud: ${length.toFixed(2)} m`).addTo(this.furrowLayer);
                                }
                            }
                        });
                    }
                }catch(e){}
            }
            const totalArea=GeoMath.area(poly.geometry.coordinates[0]);
            const cultivableArea=totalArea-(headStart+headEnd)*(maxX-minX)*111320-(marginLeft+marginRight)*(maxY-minY)*111320;
            const crop=$('furrow-crop').value;
            const plantDensity={maiz:70000,soya:400000,cafe:5000,cana:10000,hortaliza:100000,papa:45000,tomate:20000,pasto:0,custom:0};
            const plantsPerHa=plantDensity[crop]||0;
            const estimatedPlants=Math.round((cultivableArea/10000)*plantsPerHa);
            $('furrow-stats').style.display='block';
            const exp=$('furrow-export');if(exp)exp.style.display='block';
            $('furrow-count').textContent=this.furrows.length;
            $('furrow-length').textContent=totalLength.toFixed(0)+' m';
            $('furrow-area').textContent=(cultivableArea/10000).toFixed(4)+' Ha';
            $('furrow-plants').textContent=estimatedPlants>0?estimatedPlants.toLocaleString():'N/A';
            this.stats={furrowCount:this.furrows.length,totalLength,cultivableArea,estimatedPlants,spacing,furrowWidth,angle:this.angle,crop};
            Loading.hide();
            Toast.show(`${this.furrows.length} surcos generados (${totalLength.toFixed(0)}m total)`,'success');
        },
        exportKML(){
            if(this.furrows.length===0)return Toast.show('Genera surcos primero','error');
            let kml=`<?xml version="1.0" encoding="UTF-8"?>\n<kml xmlns="http://www.opengis.net/kml/2.2">\n<Document>\n<n>Surcos - WIN-TEL v30</n>\n<Style id="furrow"><LineStyle><color>ff4aa316</color><width>2</width></LineStyle></Style>\n<Folder><n>Surcos</n>\n`;
            this.furrows.forEach(f=>{kml+=`<Placemark><n>S${f.id}</n><description>Long: ${f.length.toFixed(1)}m</description><styleUrl>#furrow</styleUrl><LineString><coordinates>${f.coords.map(c=>`${c[0]},${c[1]},0`).join(' ')}</coordinates></LineString></Placemark>\n`;});
            kml+=`</Folder>\n</Document>\n</kml>`;
            download(kml,`surcos_${Date.now()}.kml`,'application/vnd.google-earth.kml+xml');Toast.show('KML exportado','success');
        },
        exportGeoJSON(){
            if(this.furrows.length===0)return Toast.show('Genera surcos primero','error');
            const features=this.furrows.map(f=>({type:'Feature',properties:{id:f.id,longitud:f.length.toFixed(2)},geometry:{type:'LineString',coordinates:f.coords}}));
            const s=this.stats||{};
            download(JSON.stringify({type:'FeatureCollection',name:'Surcos_WinTel',properties:{total:this.furrows.length,longitud:s.totalLength?.toFixed(0),separacion:s.spacing},features},null,2),`surcos_${Date.now()}.geojson`,'application/geo+json');Toast.show('GeoJSON exportado','success');
        },
        exportDXF(){
            if(this.furrows.length===0)return Toast.show('Genera surcos primero','error');
            let dxf=`0\nSECTION\n2\nHEADER\n0\nENDSEC\n0\nSECTION\n2\nTABLES\n0\nTABLE\n2\nLAYER\n0\nLAYER\n2\nSURCOS\n70\n0\n62\n3\n0\nENDTAB\n0\nENDSEC\n0\nSECTION\n2\nENTITIES\n`;
            this.furrows.forEach(f=>{dxf+=`0\nLWPOLYLINE\n8\nSURCOS\n90\n${f.coords.length}\n70\n0\n`;f.coords.forEach(c=>{dxf+=`10\n${c[0]}\n20\n${c[1]}\n`;});});
            dxf+=`0\nENDSEC\n0\nEOF\n`;download(dxf,`surcos_${Date.now()}.dxf`,'application/dxf');Toast.show('DXF exportado','success');
        },
        exportCSV(){
            if(this.furrows.length===0)return Toast.show('Genera surcos primero','error');
            const s=this.stats||{};
            let csv=`SURCOS - WIN-TEL v30\nTotal,${this.furrows.length}\nLongitud,${s.totalLength?.toFixed(0)} m\nrea,${(s.cultivableArea/10000)?.toFixed(4)} Ha\n\nID,LONGITUD,INI_LAT,INI_LNG,FIN_LAT,FIN_LNG\n`;
            this.furrows.forEach(f=>{csv+=`${f.id},${f.length.toFixed(2)},${f.coords[0][1].toFixed(6)},${f.coords[0][0].toFixed(6)},${f.coords[f.coords.length-1][1].toFixed(6)},${f.coords[f.coords.length-1][0].toFixed(6)}\n`;});
            download(csv,`surcos_${Date.now()}.csv`,'text/csv');Toast.show('CSV exportado','success');
        },
        exportGPX(){
            if(this.furrows.length===0)return Toast.show('Genera surcos primero','error');
            let gpx=`<?xml version="1.0" encoding="UTF-8"?>\n<gpx version="1.1" creator="WIN-TEL v30">\n`;
            this.furrows.forEach(f=>{gpx+=`<trk><n>S${f.id}</n><trkseg>\n`;f.coords.forEach(c=>{gpx+=`<trkpt lat="${c[1]}" lon="${c[0]}"></trkpt>\n`;});gpx+=`</trkseg></trk>\n`;});
            gpx+=`</gpx>`;download(gpx,`surcos_${Date.now()}.gpx`,'application/gpx+xml');Toast.show('GPX exportado','success');
        },
        exportPDF(){
            if(this.furrows.length===0)return Toast.show('Genera surcos primero','error');
            if(typeof jspdf==='undefined')return Toast.show('PDF no disponible','error');
            const{jsPDF}=jspdf;const doc=new jsPDF();const s=this.stats||{};
            doc.setFontSize(16);doc.setTextColor(34,197,94);doc.text('SURCOS AGRCOLAS - WIN-TEL v30',20,20);
            doc.setFontSize(10);doc.setTextColor(0);
            doc.text(`Total: ${this.furrows.length} surcos | Long: ${s.totalLength?.toFixed(0)}m | rea: ${(s.cultivableArea/10000)?.toFixed(4)} Ha`,20,30);
            doc.text(`Separacin: ${s.spacing}m | Orientacin: ${s.angle}`,20,36);
            doc.save(`surcos_${Date.now()}.pdf`);Toast.show('PDF generado','success');
        },
        exportTXT(){
            if(this.furrows.length===0)return Toast.show('Genera surcos primero','error');
            const s=this.stats||{};
            let txt=`SURCOS AGRCOLAS - WIN-TEL v30\n${'='.repeat(40)}\nSurcos: ${this.furrows.length}\nLongitud: ${s.totalLength?.toFixed(0)}m\nrea: ${(s.cultivableArea/10000)?.toFixed(4)} Ha\nSeparacin: ${s.spacing}m\n`;
            download(txt,`surcos_${Date.now()}.txt`,'text/plain');Toast.show('TXT exportado','success');
        },
        copyToClipboard(){
            if(this.furrows.length===0)return Toast.show('Genera surcos primero','error');
            const s=this.stats||{};
            navigator.clipboard.writeText(`Surcos: ${this.furrows.length}\nLong: ${s.totalLength?.toFixed(0)}m\nrea: ${(s.cultivableArea/10000)?.toFixed(4)} Ha`).then(()=>Toast.show('Copiado','success'));
        },
        clear(){
            this.furrowLayer.clearLayers();this.previewLayer.clearLayers();this.furrows=[];this.stats=null;
            $('furrow-stats').style.display='none';const exp=$('furrow-export');if(exp)exp.style.display='none';
            Toast.show('Surcos eliminados','success');
        }
    };

    // ========== SLOPE ENGINE - ANALIZADOR DE PENDIENTES ==========
    const SlopeEngine={
        slopeLayer:L.layerGroup(),
        gridPoints:[],
        results:null,
        async analyze(){
            if(!State.polygon)return Toast.show('Dibuja un polgono primero','error');
            Loading.show();
            this.slopeLayer.clearLayers();
            if(!State.map.hasLayer(this.slopeLayer))State.map.addLayer(this.slopeLayer);
            const resolution=parseInt($('slope-resolution').value)||25;
            const poly=turf.cleanCoords(turf.rewind(State.polygon));
            const bbox=turf.bbox(poly);
            const[minX,minY,maxX,maxY]=bbox;
            const degRes=resolution/111320;
            const pointsToFetch=[];
            const pointsInPoly=[];
            for(let y=minY;y<=maxY+degRes;y+=degRes){
                for(let x=minX;x<=maxX+degRes;x+=degRes){
                    pointsToFetch.push({lat:y,lng:x});
                }
            }
            Toast.show(`Obteniendo ${pointsToFetch.length} elevaciones...`,'info');
            const elevations=await ElevationService.getElevationBatch(pointsToFetch);
            const elevMap=new Map();
            pointsToFetch.forEach((p,i)=>{
                elevMap.set(`${p.lat.toFixed(6)},${p.lng.toFixed(6)}`,elevations[i]);
            });
            this.gridPoints=[];
            const totalArea=GeoMath.area(poly.geometry.coordinates[0]);
            let flatArea=0,gentleArea=0,moderateArea=0,steepArea=0;
            let totalSlope=0,maxSlope=0,pointCount=0;
            let minElev=Infinity,maxElev=-Infinity;
            const cellArea=(resolution*resolution);
            for(let y=minY;y<=maxY;y+=degRes){
                for(let x=minX;x<=maxX;x+=degRes){
                    const pt=turf.point([x,y]);
                    if(turf.booleanPointInPolygon(pt,poly)){
                        const elev=elevMap.get(`${y.toFixed(6)},${x.toFixed(6)}`)||100;
                        const elevN=elevMap.get(`${(y+degRes).toFixed(6)},${x.toFixed(6)}`)||elev;
                        const elevE=elevMap.get(`${y.toFixed(6)},${(x+degRes).toFixed(6)}`)||elev;
                        const slopeN=Math.abs(elevN-elev)/(resolution)*100;
                        const slopeE=Math.abs(elevE-elev)/(resolution)*100;
                        const slope=Math.sqrt(slopeN*slopeN+slopeE*slopeE);
                        this.gridPoints.push({lat:y,lng:x,elevation:elev,slope:slope});
                        totalSlope+=slope;
                        pointCount++;
                        if(slope>maxSlope)maxSlope=slope;
                        if(elev<minElev)minElev=elev;
                        if(elev>maxElev)maxElev=elev;
                        let color;
                        if(slope<=5){color='#22c55e';flatArea+=cellArea;}
                        else if(slope<=15){color='#fbbf24';gentleArea+=cellArea;}
                        else if(slope<=30){color='#f97316';moderateArea+=cellArea;}
                        else{color='#ef4444';steepArea+=cellArea;}
                        L.circleMarker([y,x],{
                            radius:Math.max(4,resolution/10),
                            fillColor:color,
                            fillOpacity:0.7,
                            color:color,
                            weight:1
                        }).bindPopup(`<b>Pendiente: ${slope.toFixed(1)}%</b><br>Elevacin: ${elev.toFixed(0)}m`).addTo(this.slopeLayer);
                    }
                }
            }
            const avgSlope=pointCount>0?totalSlope/pointCount:0;
            const elevDiff=maxElev-minElev;
            const totalSampled=flatArea+gentleArea+moderateArea+steepArea;
            const flatPct=totalSampled>0?(flatArea/totalSampled)*100:0;
            const gentlePct=totalSampled>0?(gentleArea/totalSampled)*100:0;
            const moderatePct=totalSampled>0?(moderateArea/totalSampled)*100:0;
            const steepPct=totalSampled>0?(steepArea/totalSampled)*100:0;
            this.results={avgSlope,maxSlope,elevDiff,minElev,maxElev,flatArea,gentleArea,moderateArea,steepArea,flatPct,gentlePct,moderatePct,steepPct,totalArea,pointCount};
            $('slope-results').style.display='block';
            const exp=$('slope-export');if(exp)exp.style.display='block';
            $('slope-flat-pct').textContent=flatPct.toFixed(1)+'%';
            $('slope-flat-ha').textContent=(flatArea/10000).toFixed(2)+' Ha';
            $('slope-gentle-pct').textContent=gentlePct.toFixed(1)+'%';
            $('slope-gentle-ha').textContent=(gentleArea/10000).toFixed(2)+' Ha';
            $('slope-moderate-pct').textContent=moderatePct.toFixed(1)+'%';
            $('slope-moderate-ha').textContent=(moderateArea/10000).toFixed(2)+' Ha';
            $('slope-steep-pct').textContent=steepPct.toFixed(1)+'%';
            $('slope-steep-ha').textContent=(steepArea/10000).toFixed(2)+' Ha';
            $('slope-avg').textContent=avgSlope.toFixed(1)+'%';
            $('slope-max').textContent=maxSlope.toFixed(1)+'%';
            $('slope-elevation-diff').textContent=elevDiff.toFixed(0)+' m';
            $('slope-direction').textContent=this.calculateAspect();
            const rec=$('slope-recommendation');
            if(flatPct>=60){
                rec.style.background='rgba(34,197,94,0.2)';rec.style.color='#22c55e';
                rec.innerHTML=' TERRENO IDEAL: Apto para cualquier tipo de cultivo mecanizado';
            }else if(flatPct+gentlePct>=60){
                rec.style.background='rgba(251,191,36,0.2)';rec.style.color='#fbbf24';
                rec.innerHTML=' TERRENO ACEPTABLE: Requiere prcticas de conservacin (curvas de nivel)';
            }else if(moderatePct>=40){
                rec.style.background='rgba(249,115,22,0.2)';rec.style.color='#f97316';
                rec.innerHTML=' USO LIMITADO: Recomendado para pastos o cultivos permanentes con terrazas';
            }else{
                rec.style.background='rgba(239,68,68,0.2)';rec.style.color='#ef4444';
                rec.innerHTML=' NO APTO PARA AGRICULTURA: Destinar a conservacin o reforestacin';
            }
            Loading.hide();
            Toast.show(`Anlisis completado: ${pointCount} puntos evaluados`,'success');
        },
        async getElevation(lat,lng){
            return ElevationService.getElevation(lat,lng);
        },
        calculateAspect(){
            if(this.gridPoints.length<2)return'N/A';
            let sumDx=0,sumDy=0;
            for(let i=1;i<this.gridPoints.length;i++){
                const p1=this.gridPoints[i-1];
                const p2=this.gridPoints[i];
                if(p2.elevation<p1.elevation){
                    sumDx+=(p2.lng-p1.lng);
                    sumDy+=(p2.lat-p1.lat);
                }
            }
            const angle=Math.atan2(sumDx,sumDy)*180/Math.PI;
            const normalized=(angle+360)%360;
            if(normalized>=337.5||normalized<22.5)return'Norte (N)';
            if(normalized>=22.5&&normalized<67.5)return'Noreste (NE)';
            if(normalized>=67.5&&normalized<112.5)return'Este (E)';
            if(normalized>=112.5&&normalized<157.5)return'Sureste (SE)';
            if(normalized>=157.5&&normalized<202.5)return'Sur (S)';
            if(normalized>=202.5&&normalized<247.5)return'Suroeste (SW)';
            if(normalized>=247.5&&normalized<292.5)return'Oeste (W)';
            return'Noroeste (NW)';
        },
        exportKML(){
            if(!this.results)return Toast.show('Analiza primero','error');
            let kml=`<?xml version="1.0" encoding="UTF-8"?>\n<kml xmlns="http://www.opengis.net/kml/2.2">\n<Document>\n<n>Anlisis de Pendientes - WIN-TEL v30</n>\n`;
            kml+=`<Style id="flat"><IconStyle><color>ff00ff00</color></IconStyle></Style>\n`;
            kml+=`<Style id="gentle"><IconStyle><color>ff00d4fb</color></IconStyle></Style>\n`;
            kml+=`<Style id="moderate"><IconStyle><color>ff1673f9</color></IconStyle></Style>\n`;
            kml+=`<Style id="steep"><IconStyle><color>ff4444ef</color></IconStyle></Style>\n`;
            kml+=`<Folder><n>Puntos de Muestreo</n>\n`;
            this.gridPoints.forEach((p,i)=>{
                const style=p.slope<=5?'flat':p.slope<=15?'gentle':p.slope<=30?'moderate':'steep';
                kml+=`<Placemark><n>P${i+1}</n><description>Pend: ${p.slope.toFixed(1)}%\nElev: ${p.elevation.toFixed(0)}m</description><styleUrl>#${style}</styleUrl><Point><coordinates>${p.lng},${p.lat},${p.elevation}</coordinates></Point></Placemark>\n`;
            });
            kml+=`</Folder>\n</Document>\n</kml>`;
            download(kml,`pendientes_${Date.now()}.kml`,'application/vnd.google-earth.kml+xml');
            Toast.show('KML exportado','success');
        },
        exportGeoJSON(){
            if(!this.results)return Toast.show('Analiza primero','error');
            const r=this.results;
            const features=this.gridPoints.map((p,i)=>({
                type:'Feature',
                properties:{id:i+1,pendiente:p.slope.toFixed(2),elevacion:p.elevation.toFixed(2),clase:p.slope<=5?'plano':p.slope<=15?'suave':p.slope<=30?'moderado':'fuerte'},
                geometry:{type:'Point',coordinates:[p.lng,p.lat,p.elevation]}
            }));
            const geojson={type:'FeatureCollection',name:'Pendientes_WinTel',properties:{pend_prom:r.avgSlope.toFixed(2),pend_max:r.maxSlope.toFixed(2),desnivel:r.elevDiff.toFixed(0),plano_pct:r.flatPct.toFixed(1),suave_pct:r.gentlePct.toFixed(1)},features};
            download(JSON.stringify(geojson,null,2),`pendientes_${Date.now()}.geojson`,'application/geo+json');
            Toast.show('GeoJSON exportado','success');
        },
        exportDXF(){
            if(!this.results)return Toast.show('Analiza primero','error');
            let dxf=`0\nSECTION\n2\nHEADER\n0\nENDSEC\n0\nSECTION\n2\nTABLES\n0\nTABLE\n2\nLAYER\n`;
            dxf+=`0\nLAYER\n2\nPLANO_0-5\n70\n0\n62\n3\n0\nLAYER\n2\nSUAVE_5-15\n70\n0\n62\n2\n0\nLAYER\n2\nMODERADO_15-30\n70\n0\n62\n4\n0\nLAYER\n2\nFUERTE_30+\n70\n0\n62\n1\n0\nENDTAB\n0\nENDSEC\n0\nSECTION\n2\nENTITIES\n`;
            this.gridPoints.forEach(p=>{
                const layer=p.slope<=5?'PLANO_0-5':p.slope<=15?'SUAVE_5-15':p.slope<=30?'MODERADO_15-30':'FUERTE_30+';
                dxf+=`0\nPOINT\n8\n${layer}\n10\n${p.lng}\n20\n${p.lat}\n30\n${p.elevation}\n`;
            });
            dxf+=`0\nENDSEC\n0\nEOF\n`;
            download(dxf,`pendientes_${Date.now()}.dxf`,'application/dxf');
            Toast.show('DXF exportado','success');
        },
        exportCSV(){
            if(!this.results)return Toast.show('Analiza primero','error');
            const r=this.results;
            let csv=`ANLISIS DE PENDIENTES - WIN-TEL v30\nFecha,${new Date().toLocaleString('es-ES')}\n\nRESUMEN\nPendiente Promedio,${r.avgSlope.toFixed(1)}%\nPendiente Mxima,${r.maxSlope.toFixed(1)}%\nDesnivel,${r.elevDiff.toFixed(0)} m\n\nDISTRIBUCIN\nClase,Porcentaje,rea (Ha)\nPlano (0-5%),${r.flatPct.toFixed(1)}%,${(r.flatArea/10000).toFixed(2)}\nSuave (5-15%),${r.gentlePct.toFixed(1)}%,${(r.gentleArea/10000).toFixed(2)}\nModerado (15-30%),${r.moderatePct.toFixed(1)}%,${(r.moderateArea/10000).toFixed(2)}\nFuerte (>30%),${r.steepPct.toFixed(1)}%,${(r.steepArea/10000).toFixed(2)}\n\nPUNTOS DE MUESTREO\nID,LAT,LNG,ELEVACION,PENDIENTE,CLASE\n`;
            this.gridPoints.forEach((p,i)=>{
                csv+=`${i+1},${p.lat.toFixed(6)},${p.lng.toFixed(6)},${p.elevation.toFixed(1)},${p.slope.toFixed(1)},${p.slope<=5?'Plano':p.slope<=15?'Suave':p.slope<=30?'Moderado':'Fuerte'}\n`;
            });
            download(csv,`pendientes_${Date.now()}.csv`,'text/csv');
            Toast.show('CSV exportado','success');
        },
        exportGPX(){
            if(!this.results)return Toast.show('Analiza primero','error');
            let gpx=`<?xml version="1.0" encoding="UTF-8"?>\n<gpx version="1.1" creator="WIN-TEL v30">\n<metadata><n>Anlisis de Pendientes</n></metadata>\n`;
            this.gridPoints.forEach((p,i)=>{
                gpx+=`<wpt lat="${p.lat}" lon="${p.lng}"><ele>${p.elevation}</ele><n>P${i+1}</n><desc>Pend: ${p.slope.toFixed(1)}%</desc></wpt>\n`;
            });
            gpx+=`</gpx>`;
            download(gpx,`pendientes_${Date.now()}.gpx`,'application/gpx+xml');
            Toast.show('GPX exportado','success');
        },
        exportPDF(){
            if(!this.results)return Toast.show('Analiza primero','error');
            if(typeof jspdf==='undefined')return Toast.show('PDF no disponible','error');
            const{jsPDF}=jspdf;const doc=new jsPDF();const r=this.results;
            doc.setFontSize(18);doc.setTextColor(245,158,11);
            doc.text('ANLISIS DE PENDIENTES',20,20);
            doc.setFontSize(10);doc.setTextColor(100);
            doc.text('WIN-TEL GEOMATICS PRO v30',20,28);
            doc.text(`Fecha: ${new Date().toLocaleDateString('es-ES')}`,20,34);
            doc.setFontSize(12);doc.setTextColor(0);
            doc.text('DISTRIBUCIN DEL TERRENO',20,48);
            doc.setFontSize(10);
            doc.setTextColor(34,197,94);doc.text(`Plano (0-5%): ${r.flatPct.toFixed(1)}% - ${(r.flatArea/10000).toFixed(2)} Ha`,25,58);
            doc.setTextColor(251,191,36);doc.text(`Suave (5-15%): ${r.gentlePct.toFixed(1)}% - ${(r.gentleArea/10000).toFixed(2)} Ha`,25,66);
            doc.setTextColor(249,115,22);doc.text(`Moderado (15-30%): ${r.moderatePct.toFixed(1)}% - ${(r.moderateArea/10000).toFixed(2)} Ha`,25,74);
            doc.setTextColor(239,68,68);doc.text(`Fuerte (>30%): ${r.steepPct.toFixed(1)}% - ${(r.steepArea/10000).toFixed(2)} Ha`,25,82);
            doc.setTextColor(0);doc.setFontSize(12);
            doc.text('ESTADSTICAS',20,96);
            doc.setFontSize(10);
            doc.text(`Pendiente promedio: ${r.avgSlope.toFixed(1)}%`,25,104);
            doc.text(`Pendiente mxima: ${r.maxSlope.toFixed(1)}%`,25,110);
            doc.text(`Desnivel: ${r.elevDiff.toFixed(0)} m`,25,116);
            doc.text(`Puntos analizados: ${r.pointCount}`,25,122);
            doc.save(`pendientes_${Date.now()}.pdf`);
            Toast.show('PDF generado','success');
        },
        exportTXT(){
            if(!this.results)return Toast.show('Analiza primero','error');
            const r=this.results;
            let txt=`ANLISIS DE PENDIENTES\n${'='.repeat(50)}\nWIN-TEL v30 | ${new Date().toLocaleString('es-ES')}\n\nDISTRIBUCIN:\nPlano (0-5%): ${r.flatPct.toFixed(1)}% - ${(r.flatArea/10000).toFixed(2)} Ha\nSuave (5-15%): ${r.gentlePct.toFixed(1)}% - ${(r.gentleArea/10000).toFixed(2)} Ha\nModerado (15-30%): ${r.moderatePct.toFixed(1)}% - ${(r.moderateArea/10000).toFixed(2)} Ha\nFuerte (>30%): ${r.steepPct.toFixed(1)}% - ${(r.steepArea/10000).toFixed(2)} Ha\n\nESTADSTICAS:\nPendiente promedio: ${r.avgSlope.toFixed(1)}%\nPendiente mxima: ${r.maxSlope.toFixed(1)}%\nDesnivel: ${r.elevDiff.toFixed(0)} m\nPuntos: ${r.pointCount}\n`;
            download(txt,`pendientes_${Date.now()}.txt`,'text/plain');
            Toast.show('TXT exportado','success');
        },
        copyToClipboard(){
            if(!this.results)return Toast.show('Analiza primero','error');
            const r=this.results;
            let data=`PENDIENTES\nPlano: ${r.flatPct.toFixed(1)}%\nSuave: ${r.gentlePct.toFixed(1)}%\nModerado: ${r.moderatePct.toFixed(1)}%\nFuerte: ${r.steepPct.toFixed(1)}%\nPromedio: ${r.avgSlope.toFixed(1)}%\nMximo: ${r.maxSlope.toFixed(1)}%`;
            navigator.clipboard.writeText(data).then(()=>Toast.show('Copiado','success')).catch(()=>Toast.show('Error','error'));
        },
        exportReport(){this.exportTXT();},
        clear(){
            this.slopeLayer.clearLayers();
            this.gridPoints=[];
            this.results=null;
            $('slope-results').style.display='none';
            const exp=$('slope-export');if(exp)exp.style.display='none';
            Toast.show('Anlisis limpiado','success');
        }
    };

    // ========== DXF ENGINE - EXPORTADOR AUTOCAD ==========
    const DXFEngine={
        updateCounts(){
            $('dxf-count-poly').textContent=State.polygon?'1':'0';
            $('dxf-count-lots').textContent=State.blocks.length;
            const vertices=State.polygon?State.polygon.geometry.coordinates[0].length-1:0;
            $('dxf-count-vertices').textContent=vertices;
        },
        toUTM(lat,lng){
            const zone=parseInt($('dxf-utm-zone').value)||19;
            const k0=0.9996;
            const a=6378137;
            const e=0.081819191;
            const e2=e*e;
            const latRad=lat*Math.PI/180;
            const lngRad=lng*Math.PI/180;
            const lng0=(zone*6-183)*Math.PI/180;
            const N=a/Math.sqrt(1-e2*Math.sin(latRad)*Math.sin(latRad));
            const T=Math.tan(latRad)*Math.tan(latRad);
            const C=e2*Math.cos(latRad)*Math.cos(latRad)/(1-e2);
            const A=(lngRad-lng0)*Math.cos(latRad);
            const M=a*((1-e2/4-3*e2*e2/64)*latRad-(3*e2/8+3*e2*e2/32)*Math.sin(2*latRad)+(15*e2*e2/256)*Math.sin(4*latRad));
            const x=k0*N*(A+(1-T+C)*A*A*A/6+(5-18*T+T*T)*A*A*A*A*A/120)+500000;
            const y=k0*(M+N*Math.tan(latRad)*(A*A/2+(5-T+9*C+4*C*C)*A*A*A*A/24));
            return{e:x,n:lat>=0?y:y+10000000};
        },
        formatCoord(lat,lng){
            const system=$('dxf-coord-system').value;
            const precision=parseInt($('dxf-precision').value)||3;
            if(system==='geographic'){
                return{x:lng.toFixed(precision),y:lat.toFixed(precision)};
            }else if(system==='utm'){
                const utm=this.toUTM(lat,lng);
                return{x:utm.e.toFixed(precision),y:utm.n.toFixed(precision)};
            }else{
                return{x:(lng*111320).toFixed(precision),y:(lat*111320).toFixed(precision)};
            }
        },
        export(){
            if(!State.polygon)return Toast.show('No hay polgono para exportar','error');
            Loading.show();
            const textScale=parseFloat($('dxf-text-scale').value)||1.5;
            let dxf=`0\nSECTION\n2\nHEADER\n0\nENDSEC\n0\nSECTION\n2\nTABLES\n0\nTABLE\n2\nLAYER\n`;
            const layers=[
                {name:'POLIGONO_PRINCIPAL',color:1},
                {name:'SUBDIVISIONES',color:3},
                {name:'VIALIDADES',color:2},
                {name:'VERTICES',color:5},
                {name:'ETIQUETAS',color:4},
                {name:'AREAS_RESERVADAS',color:6}
            ];
            layers.forEach(l=>{
                dxf+=`0\nLAYER\n2\n${l.name}\n70\n0\n62\n${l.color}\n6\nCONTINUOUS\n`;
            });
            dxf+=`0\nENDTAB\n0\nENDSEC\n0\nSECTION\n2\nENTITIES\n`;
            if($('dxf-layer-polygon').checked&&State.polygon){
                const coords=State.polygon.geometry.coordinates[0];
                dxf+=this.createPolyline(coords,'POLIGONO_PRINCIPAL',1);
            }
            if($('dxf-layer-lots').checked&&State.blocks.length>0){
                State.blocks.forEach(block=>{
                    const coords=block.geo.geometry.coordinates[0];
                    dxf+=this.createPolyline(coords,'SUBDIVISIONES',3);
                });
            }
            if($('dxf-layer-vertices').checked&&State.polygon){
                const coords=State.polygon.geometry.coordinates[0];
                coords.forEach((c,i)=>{
                    if(i<coords.length-1){
                        const formatted=this.formatCoord(c[1],c[0]);
                        dxf+=`0\nPOINT\n8\nVERTICES\n10\n${formatted.x}\n20\n${formatted.y}\n30\n0\n`;
                        dxf+=`0\nTEXT\n8\nVERTICES\n10\n${formatted.x}\n20\n${formatted.y}\n30\n0\n40\n${textScale}\n1\nV${i+1}\n`;
                    }
                });
            }
            if($('dxf-layer-labels').checked&&State.blocks.length>0){
                State.blocks.forEach(block=>{
                    const center=turf.centroid(block.geo);
                    const formatted=this.formatCoord(center.geometry.coordinates[1],center.geometry.coordinates[0]);
                    dxf+=`0\nTEXT\n8\nETIQUETAS\n10\n${formatted.x}\n20\n${formatted.y}\n30\n0\n40\n${textScale*1.5}\n1\n${block.cadastre||block.id}\n`;
                    dxf+=`0\nTEXT\n8\nETIQUETAS\n10\n${formatted.x}\n20\n${parseFloat(formatted.y)-textScale*3}\n30\n0\n40\n${textScale}\n1\n${block.area.toFixed(2)} m2\n`;
                });
            }
            if($('dxf-layer-reserves').checked&&ReserveEngine.reserves.length>0){
                ReserveEngine.reserves.forEach(r=>{
                    const coords=r.geo.geometry.coordinates[0];
                    dxf+=this.createPolyline(coords,'AREAS_RESERVADAS',6);
                });
            }
            dxf+=`0\nENDSEC\n0\nEOF\n`;
            download(dxf,`proyecto_${Date.now()}.dxf`,'application/dxf');
            Loading.hide();
            Toast.show('DXF exportado correctamente','success');
        },
        createPolyline(coords,layer,color){
            let dxf=`0\nLWPOLYLINE\n8\n${layer}\n62\n${color}\n90\n${coords.length}\n70\n1\n`;
            coords.forEach(c=>{
                const formatted=this.formatCoord(c[1],c[0]);
                dxf+=`10\n${formatted.x}\n20\n${formatted.y}\n`;
            });
            return dxf;
        },
        exportMemoria(){
            if(!State.polygon)return Toast.show('No hay polgono','error');
            const coords=State.polygon.geometry.coordinates[0];
            const area=GeoMath.area(coords);
            const perimeter=GeoMath.perimeter(coords);
            let memoria=`MEMORIA DESCRIPTIVA DEL TERRENO
================================
Fecha: ${new Date().toLocaleDateString('es-ES')}

UBICACIN
---------
[Completar manualmente]

SUPERFICIE
----------
rea: ${area.toFixed(2)} m (${(area/10000).toFixed(4)} Ha)
Permetro: ${perimeter.toFixed(2)} m

LINDEROS Y MEDIDAS
------------------\n`;
            const cardinals=['Norte','Este','Sur','Oeste','Noreste','Sureste','Suroeste','Noroeste'];
            for(let i=0;i<coords.length-1;i++){
                const p1=coords[i];
                const p2=coords[(i+1)%coords.length];
                const dist=turf.distance(turf.point(p1),turf.point(p2),{units:'meters'});
                const angle=turf.bearing(turf.point(p1),turf.point(p2));
                const rumbo=this.angleToRumbo(angle);
                memoria+=`Lado ${i+1}-${i+2}: ${dist.toFixed(2)} m, Rumbo: ${rumbo}\n`;
            }
            memoria+=`\nCOORDENADAS DE VRTICES
-----------------------\n`;
            memoria+=`No.\tLatitud\t\tLongitud\n`;
            coords.forEach((c,i)=>{
                if(i<coords.length-1){
                    memoria+=`${i+1}\t${c[1].toFixed(8)}\t${c[0].toFixed(8)}\n`;
                }
            });
            download(memoria,`memoria_descriptiva_${Date.now()}.txt`,'text/plain');
            Toast.show('Memoria descriptiva exportada','success');
        },
        exportCoordTable(){
            if(!State.polygon)return Toast.show('No hay polgono','error');
            const coords=State.polygon.geometry.coordinates[0];
            const system=$('dxf-coord-system').value;
            let csv=system==='utm'?'VERTICE,ESTE,NORTE\n':'VERTICE,LATITUD,LONGITUD\n';
            coords.forEach((c,i)=>{
                if(i<coords.length-1){
                    const formatted=this.formatCoord(c[1],c[0]);
                    csv+=`${i+1},${system==='utm'?formatted.x:c[1].toFixed(8)},${system==='utm'?formatted.y:c[0].toFixed(8)}\n`;
                }
            });
            download(csv,`coordenadas_${Date.now()}.csv`,'text/csv');
            Toast.show('Tabla de coordenadas exportada','success');
        },
        exportRumbos(){
            if(!State.polygon)return Toast.show('No hay polgono','error');
            const coords=State.polygon.geometry.coordinates[0];
            let csv='LADO,AZIMUT,RUMBO,DISTANCIA_M\n';
            for(let i=0;i<coords.length-1;i++){
                const p1=coords[i];
                const p2=coords[(i+1)%(coords.length-1)];
                const dist=turf.distance(turf.point(p1),turf.point(p2),{units:'meters'});
                const azimut=turf.bearing(turf.point(p1),turf.point(p2));
                const azimutNorm=(azimut+360)%360;
                const rumbo=this.angleToRumbo(azimut);
                csv+=`${i+1}-${((i+1)%(coords.length-1))+1},${azimutNorm.toFixed(4)},${rumbo},${dist.toFixed(3)}\n`;
            }
            download(csv,`rumbos_distancias_${Date.now()}.csv`,'text/csv');
            Toast.show('Cuadro de rumbos exportado','success');
        },
        angleToRumbo(angle){
            const a=(angle+360)%360;
            let rumbo='';
            if(a>=0&&a<90){
                rumbo=`N ${a.toFixed(2)} E`;
            }else if(a>=90&&a<180){
                rumbo=`S ${(180-a).toFixed(2)} E`;
            }else if(a>=180&&a<270){
                rumbo=`S ${(a-180).toFixed(2)} W`;
            }else{
                rumbo=`N ${(360-a).toFixed(2)} W`;
            }
            return rumbo;
        }
    };
    setInterval(()=>DXFEngine.updateCounts(),2000);

    // ========== ELEVATION SERVICE - SERVICIO CENTRALIZADO DE ELEVACIONES ==========
    const ElevationService={
        cache:new Map(),
        batchSize:100,
        timeout:5000,
        useDemo:true,
        getCacheKey(lat,lng,precision=5){
            return `${lat.toFixed(precision)},${lng.toFixed(precision)}`;
        },
        generateRealisticElevation(lat,lng){
            const base=150;
            const noise1=Math.sin(lat*800)*50;
            const noise2=Math.cos(lng*800)*40;
            const noise3=Math.sin((lat+lng)*300)*25;
            const noise4=Math.cos((lat-lng)*150)*15;
            const gradient=(lat%0.01)*1000;
            return Math.max(10,base+noise1+noise2+noise3+noise4+gradient);
        },
        async fetchWithTimeout(url,timeout){
            const controller=new AbortController();
            const id=setTimeout(()=>controller.abort(),timeout);
            try{
                const response=await fetch(url,{signal:controller.signal});
                clearTimeout(id);
                return response;
            }catch(e){
                clearTimeout(id);
                throw e;
            }
        },
        async getElevation(lat,lng){
            const key=this.getCacheKey(lat,lng);
            if(this.cache.has(key))return this.cache.get(key);
            if(this.useDemo){
                const elev=this.generateRealisticElevation(lat,lng);
                this.cache.set(key,elev);
                return elev;
            }
            try{
                const response=await this.fetchWithTimeout(`https://api.open-elevation.com/api/v1/lookup?locations=${lat},${lng}`,this.timeout);
                const data=await response.json();
                const elev=data.results[0].elevation;
                this.cache.set(key,elev);
                return elev;
            }catch(e){
                const fallback=this.generateRealisticElevation(lat,lng);
                this.cache.set(key,fallback);
                return fallback;
            }
        },
        async getElevationBatch(points){
            if(points.length===0)return[];
            const results=new Array(points.length);
            const toFetch=[];
            const toFetchIndices=[];
            points.forEach((p,i)=>{
                const key=this.getCacheKey(p.lat,p.lng);
                if(this.cache.has(key)){
                    results[i]=this.cache.get(key);
                }else{
                    toFetch.push(p);
                    toFetchIndices.push(i);
                }
            });
            if(toFetch.length>0){
                if(this.useDemo){
                    toFetch.forEach((p,j)=>{
                        const originalIdx=toFetchIndices[j];
                        const elev=this.generateRealisticElevation(p.lat,p.lng);
                        this.cache.set(this.getCacheKey(p.lat,p.lng),elev);
                        results[originalIdx]=elev;
                    });
                    return results;
                }
                const batches=[];
                for(let i=0;i<toFetch.length;i+=this.batchSize){
                    batches.push({points:toFetch.slice(i,i+this.batchSize),startIdx:i});
                }
                let apiWorking=true;
                for(const batch of batches){
                    if(!apiWorking){
                        batch.points.forEach((p,j)=>{
                            const originalIdx=toFetchIndices[batch.startIdx+j];
                            const fallback=this.generateRealisticElevation(p.lat,p.lng);
                            this.cache.set(this.getCacheKey(p.lat,p.lng),fallback);
                            results[originalIdx]=fallback;
                        });
                        continue;
                    }
                    try{
                        const locations=batch.points.map(p=>`${p.lat},${p.lng}`).join('|');
                        const response=await this.fetchWithTimeout(`https://api.open-elevation.com/api/v1/lookup?locations=${locations}`,this.timeout);
                        const data=await response.json();
                        if(data.results&&data.results.length===batch.points.length){
                            data.results.forEach((r,j)=>{
                                const originalIdx=toFetchIndices[batch.startIdx+j];
                                const pt=batch.points[j];
                                this.cache.set(this.getCacheKey(pt.lat,pt.lng),r.elevation);
                                results[originalIdx]=r.elevation;
                            });
                        }else throw new Error('Invalid response');
                    }catch(e){
                        console.warn('Elevation API failed, using synthetic data');
                        apiWorking=false;
                        batch.points.forEach((p,j)=>{
                            const originalIdx=toFetchIndices[batch.startIdx+j];
                            const fallback=this.generateRealisticElevation(p.lat,p.lng);
                            this.cache.set(this.getCacheKey(p.lat,p.lng),fallback);
                            results[originalIdx]=fallback;
                        });
                    }
                    if(batches.length>1&&apiWorking)await new Promise(r=>setTimeout(r,50));
                }
            }
            return results;
        },
        toggleMode(){
            this.useDemo=!this.useDemo;
            this.cache.clear();
            Toast.show(this.useDemo?'Modo DEMO (datos simulados rpidos)':'Modo API (datos reales, ms lento)','info');
            return this.useDemo;
        },
        clearCache(){this.cache.clear();},
        getCacheSize(){return this.cache.size;}
    };

    // ========== PROFILE ENGINE - PERFIL DE ELEVACIN ==========
    const ProfileEngine={
        profileLayer:L.layerGroup(),
        lineLayer:L.layerGroup(),
        markersLayer:L.layerGroup(),
        drawHandler:null,
        profileLine:null,
        elevationData:[],
        async startDraw(){
            if(!State.polygon)return Toast.show('Dibuja un polgono primero','error');
            Toast.show('Haz clic en el mapa para trazar la lnea de perfil (doble-clic para terminar)','info');
            this.clear();
            if(!State.map.hasLayer(this.lineLayer))State.map.addLayer(this.lineLayer);
            if(!State.map.hasLayer(this.markersLayer))State.map.addLayer(this.markersLayer);
            this.drawHandler=new L.Draw.Polyline(State.map,{
                shapeOptions:{color:'#ec4899',weight:4,dashArray:'10,5'}
            });
            this.drawHandler.enable();
            State.map.once('draw:created',async(e)=>{
                const coords=e.layer.getLatLngs().map(ll=>[ll.lng,ll.lat]);
                if(coords.length>=2){
                    this.profileLine=coords;
                    L.polyline(coords.map(c=>[c[1],c[0]]),{color:'#ec4899',weight:4}).addTo(this.lineLayer);
                    await this.generateProfile();
                }
            });
        },
        async usePolygonPerimeter(){
            if(!State.polygon)return Toast.show('No hay polgono','error');
            this.clear();
            if(!State.map.hasLayer(this.lineLayer))State.map.addLayer(this.lineLayer);
            if(!State.map.hasLayer(this.markersLayer))State.map.addLayer(this.markersLayer);
            const coords=State.polygon.geometry.coordinates[0];
            this.profileLine=coords;
            L.polyline(coords.map(c=>[c[1],c[0]]),{color:'#ec4899',weight:4,dashArray:'10,5'}).addTo(this.lineLayer);
            await this.generateProfile();
        },
        async generateProfile(){
            if(!this.profileLine||this.profileLine.length<2)return;
            Loading.show();
            Toast.show('Generando perfil de elevacin...','info');
            const samples=parseInt($('profile-samples').value)||50;
            const line=turf.lineString(this.profileLine);
            const totalDistance=turf.length(line,{units:'meters'});
            const step=totalDistance/samples;
            const points=[];
            for(let i=0;i<=samples;i++){
                const dist=i*step;
                const point=turf.along(line,dist,{units:'meters'});
                const[lng,lat]=point.geometry.coordinates;
                points.push({lat,lng,distance:dist,index:i+1});
            }
            Toast.show(`Obteniendo ${points.length} elevaciones...`,'info');
            const elevations=await ElevationService.getElevationBatch(points);
            this.elevationData=points.map((p,i)=>({...p,elevation:elevations[i]}));
            this.drawMarkersOnMap();
            this.drawChart();
            this.updateStats(totalDistance);
            this.drawDetailedTable();
            $('profile-chart-container').style.display='block';
            $('profile-segments').style.display='block';
            const exportEl=$('profile-export');if(exportEl)exportEl.style.display='block';
            $('profile-distance').textContent=`Distancia Total: ${totalDistance.toFixed(1)} m`;
            Loading.hide();
            Toast.show(` Perfil generado: ${samples+1} puntos`,'success');
        },
        drawMarkersOnMap(){
            this.markersLayer.clearLayers();
            const minElev=Math.min(...this.elevationData.map(d=>d.elevation));
            const maxElev=Math.max(...this.elevationData.map(d=>d.elevation));
            this.elevationData.forEach((d,i)=>{
                const isFirst=i===0;
                const isLast=i===this.elevationData.length-1;
                const isHighest=d.elevation===maxElev;
                const isLowest=d.elevation===minElev;
                let color='#ec4899';
                let size=6;
                let zIndex=100;
                if(isFirst){color='#22c55e';size=10;zIndex=200;}
                else if(isLast){color='#ef4444';size=10;zIndex=200;}
                else if(isHighest){color='#fbbf24';size=9;zIndex=150;}
                else if(isLowest){color='#3b82f6';size=9;zIndex=150;}
                else if(i%5===0){size=7;}
                else{size=4;}
                const marker=L.circleMarker([d.lat,d.lng],{
                    radius:size,fillColor:color,fillOpacity:0.9,color:'#fff',weight:isFirst||isLast?3:1
                });
                let label='';
                if(isFirst)label=' INICIO';
                else if(isLast)label=' FIN';
                else if(isHighest)label=' PUNTO MS ALTO';
                else if(isLowest)label=' PUNTO MS BAJO';
                marker.bindPopup(`<div style="min-width:180px;"><b>${label||'Punto '+d.index}</b><hr style="margin:5px 0;border-color:#333;"><table style="width:100%;font-size:11px;"><tr><td> Distancia:</td><td><b>${d.distance.toFixed(1)} m</b></td></tr><tr><td> Elevacin:</td><td><b>${d.elevation.toFixed(1)} m</b></td></tr><tr><td> Lat:</td><td>${d.lat.toFixed(6)}</td></tr><tr><td> Lng:</td><td>${d.lng.toFixed(6)}</td></tr></table></div>`);
                marker.addTo(this.markersLayer);
            });
        },
        drawChart(){
            const canvas=$('profile-canvas');
            if(!canvas)return;
            const ctx=canvas.getContext('2d');
            const rect=canvas.getBoundingClientRect();
            canvas.width=rect.width*2;
            canvas.height=rect.height*2;
            ctx.scale(2,2);
            const width=rect.width;
            const height=rect.height;
            const padding={top:25,right:25,bottom:35,left:55};
            const chartWidth=width-padding.left-padding.right;
            const chartHeight=height-padding.top-padding.bottom;
            const exaggeration=parseFloat($('profile-exaggeration').value)||2;
            const minElev=Math.min(...this.elevationData.map(d=>d.elevation));
            const maxElev=Math.max(...this.elevationData.map(d=>d.elevation));
            const elevRange=(maxElev-minElev)*exaggeration||10;
            const maxDist=Math.max(...this.elevationData.map(d=>d.distance));
            ctx.fillStyle='#0f172a';
            ctx.fillRect(0,0,width,height);
            ctx.strokeStyle='#334155';
            ctx.lineWidth=0.5;
            for(let i=0;i<=5;i++){
                const y=padding.top+chartHeight*(i/5);
                ctx.beginPath();
                ctx.moveTo(padding.left,y);
                ctx.lineTo(width-padding.right,y);
                ctx.stroke();
            }
            for(let i=0;i<=4;i++){
                const x=padding.left+(i/4)*chartWidth;
                ctx.beginPath();
                ctx.moveTo(x,padding.top);
                ctx.lineTo(x,height-padding.bottom);
                ctx.stroke();
            }
            const gradient=ctx.createLinearGradient(0,padding.top,0,height-padding.bottom);
            gradient.addColorStop(0,'rgba(239,68,68,0.6)');
            gradient.addColorStop(0.3,'rgba(251,191,36,0.5)');
            gradient.addColorStop(0.7,'rgba(34,197,94,0.4)');
            gradient.addColorStop(1,'rgba(34,197,94,0.2)');
            ctx.beginPath();
            ctx.moveTo(padding.left,height-padding.bottom);
            this.elevationData.forEach((d,i)=>{
                const x=padding.left+(d.distance/maxDist)*chartWidth;
                const y=padding.top+chartHeight-(((d.elevation-minElev)/elevRange)*chartHeight);
                ctx.lineTo(x,y);
            });
            ctx.lineTo(padding.left+chartWidth,height-padding.bottom);
            ctx.closePath();
            ctx.fillStyle=gradient;
            ctx.fill();
            ctx.beginPath();
            this.elevationData.forEach((d,i)=>{
                const x=padding.left+(d.distance/maxDist)*chartWidth;
                const y=padding.top+chartHeight-(((d.elevation-minElev)/elevRange)*chartHeight);
                if(i===0)ctx.moveTo(x,y);
                else ctx.lineTo(x,y);
            });
            ctx.strokeStyle='#f472b6';
            ctx.lineWidth=2.5;
            ctx.stroke();
            this.elevationData.forEach((d,i)=>{
                const x=padding.left+(d.distance/maxDist)*chartWidth;
                const y=padding.top+chartHeight-(((d.elevation-minElev)/elevRange)*chartHeight);
                const isSpecial=i===0||i===this.elevationData.length-1||d.elevation===minElev||d.elevation===maxElev;
                if(isSpecial||i%10===0){
                    ctx.beginPath();
                    ctx.arc(x,y,isSpecial?5:3,0,Math.PI*2);
                    let color='#f472b6';
                    if(i===0)color='#22c55e';
                    else if(i===this.elevationData.length-1)color='#ef4444';
                    else if(d.elevation===maxElev)color='#fbbf24';
                    else if(d.elevation===minElev)color='#3b82f6';
                    ctx.fillStyle=color;
                    ctx.fill();
                    ctx.strokeStyle='#fff';
                    ctx.lineWidth=1.5;
                    ctx.stroke();
                }
            });
            ctx.fillStyle='#94a3b8';
            ctx.font='10px Inter, sans-serif';
            ctx.textAlign='right';
            for(let i=0;i<=5;i++){
                const elev=maxElev-(elevRange/exaggeration)*(i/5);
                const y=padding.top+chartHeight*(i/5);
                ctx.fillText(elev.toFixed(0)+' m',padding.left-8,y+4);
            }
            ctx.textAlign='center';
            for(let i=0;i<=4;i++){
                const dist=(maxDist*i/4);
                const x=padding.left+(i/4)*chartWidth;
                ctx.fillText(dist.toFixed(0)+' m',x,height-12);
            }
            ctx.fillStyle='#64748b';
            ctx.font='9px Inter, sans-serif';
            ctx.save();
            ctx.translate(12,height/2);
            ctx.rotate(-Math.PI/2);
            ctx.textAlign='center';
            ctx.fillText('ELEVACIN (m)',0,0);
            ctx.restore();
            ctx.textAlign='center';
            ctx.fillText('DISTANCIA (m)',width/2,height-2);
        },
        updateStats(totalDistance){
            const elevations=this.elevationData.map(d=>d.elevation);
            const minElev=Math.min(...elevations);
            const maxElev=Math.max(...elevations);
            const elevDiff=maxElev-minElev;
            let totalAscent=0,totalDescent=0;
            for(let i=1;i<this.elevationData.length;i++){
                const diff=this.elevationData[i].elevation-this.elevationData[i-1].elevation;
                if(diff>0)totalAscent+=diff;
                else totalDescent+=Math.abs(diff);
            }
            const avgSlope=(elevDiff/totalDistance)*100;
            $('profile-min-elev').textContent=minElev.toFixed(1)+' m';
            $('profile-max-elev').textContent=maxElev.toFixed(1)+' m';
            $('profile-elevation-diff').textContent=elevDiff.toFixed(1)+' m';
            $('profile-avg-slope').textContent=avgSlope.toFixed(2)+'%';
            const statsExtra=$('profile-stats-extra');
            if(statsExtra){
                statsExtra.innerHTML=`<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:10px;"><div style="text-align:center;padding:8px;background:rgba(34,197,94,0.15);border-radius:6px;"><div style="font-size:9px;color:#22c55e;"> ASCENSO TOTAL</div><div style="font-size:13px;font-weight:700;color:#22c55e;">${totalAscent.toFixed(1)} m</div></div><div style="text-align:center;padding:8px;background:rgba(239,68,68,0.15);border-radius:6px;"><div style="font-size:9px;color:#ef4444;"> DESCENSO TOTAL</div><div style="font-size:13px;font-weight:700;color:#ef4444;">${totalDescent.toFixed(1)} m</div></div></div>`;
            }
        },
        drawDetailedTable(){
            let html='';
            const minElev=Math.min(...this.elevationData.map(d=>d.elevation));
            const maxElev=Math.max(...this.elevationData.map(d=>d.elevation));
            for(let i=0;i<this.elevationData.length;i++){
                const curr=this.elevationData[i];
                const prev=i>0?this.elevationData[i-1]:null;
                const segDist=prev?(curr.distance-prev.distance):0;
                const elevChange=prev?(curr.elevation-prev.elevation):0;
                const slope=prev&&segDist>0?(elevChange/segDist)*100:0;
                let rowClass='';
                let badge='';
                if(i===0){rowClass='background:rgba(34,197,94,0.2);';badge='<span style="color:#22c55e;font-weight:700;"> INICIO</span>';}
                else if(i===this.elevationData.length-1){rowClass='background:rgba(239,68,68,0.2);';badge='<span style="color:#ef4444;font-weight:700;"> FIN</span>';}
                else if(curr.elevation===maxElev){rowClass='background:rgba(251,191,36,0.2);';badge='<span style="color:#fbbf24;font-weight:700;"> MX</span>';}
                else if(curr.elevation===minElev){rowClass='background:rgba(59,130,246,0.2);';badge='<span style="color:#3b82f6;font-weight:700;"> MN</span>';}
                const slopeColor=Math.abs(slope)<5?'#22c55e':Math.abs(slope)<15?'#fbbf24':'#ef4444';
                html+=`<tr style="${rowClass}"><td style="font-weight:700;">${curr.index} ${badge}</td><td>${curr.distance.toFixed(1)}</td><td style="font-weight:600;">${curr.elevation.toFixed(1)}</td><td>${curr.lat.toFixed(5)}</td><td>${curr.lng.toFixed(5)}</td><td style="color:${slopeColor};font-weight:600;">${i>0?(slope>=0?'+':'')+slope.toFixed(1)+'%':'-'}</td></tr>`;
            }
            $('profile-segments-body').innerHTML=html;
        },
        exportImage(){
            const canvas=$('profile-canvas');
            if(!canvas)return Toast.show('No hay grfico','error');
            const link=document.createElement('a');
            link.download=`perfil_elevacion_${Date.now()}.png`;
            link.href=canvas.toDataURL('image/png',1.0);
            link.click();
            Toast.show('Imagen PNG exportada','success');
        },
        exportCSV(){
            if(this.elevationData.length===0)return Toast.show('Genera un perfil primero','error');
            let csv='PUNTO,DISTANCIA_M,ELEVACION_M,LATITUD,LONGITUD,PENDIENTE_%\n';
            for(let i=0;i<this.elevationData.length;i++){
                const d=this.elevationData[i];
                const prev=i>0?this.elevationData[i-1]:null;
                const segDist=prev?(d.distance-prev.distance):0;
                const elevChange=prev?(d.elevation-prev.elevation):0;
                const slope=prev&&segDist>0?(elevChange/segDist)*100:0;
                csv+=`${d.index},${d.distance.toFixed(2)},${d.elevation.toFixed(2)},${d.lat.toFixed(8)},${d.lng.toFixed(8)},${slope.toFixed(2)}\n`;
            }
            download(csv,`perfil_elevacion_${Date.now()}.csv`,'text/csv');
            Toast.show('CSV exportado con todos los datos','success');
        },
        exportKML(){
            if(this.elevationData.length===0)return Toast.show('Genera un perfil primero','error');
            let kml=`<?xml version="1.0" encoding="UTF-8"?>\n<kml xmlns="http://www.opengis.net/kml/2.2">\n<Document>\n<n>Perfil de Elevacin - WIN-TEL v30</n>\n`;
            kml+=`<Style id="profileLine"><LineStyle><color>ff9948ec</color><width>3</width></LineStyle></Style>\n`;
            kml+=`<Style id="startPoint"><IconStyle><color>ff00ff00</color><scale>1.2</scale></IconStyle></Style>\n`;
            kml+=`<Style id="endPoint"><IconStyle><color>ff0000ff</color><scale>1.2</scale></IconStyle></Style>\n`;
            kml+=`<Placemark><n>Lnea de Perfil</n><styleUrl>#profileLine</styleUrl><LineString><altitudeMode>clampToGround</altitudeMode><coordinates>`;
            kml+=this.elevationData.map(d=>`${d.lng},${d.lat},${d.elevation}`).join(' ');
            kml+=`</coordinates></LineString></Placemark>\n`;
            kml+=`<Folder><n>Puntos del Perfil</n>\n`;
            this.elevationData.forEach((d,i)=>{
                if(i===0||i===this.elevationData.length-1||i%10===0){
                    const style=i===0?'startPoint':i===this.elevationData.length-1?'endPoint':'';
                    kml+=`<Placemark><n>Punto ${d.index}</n><description>Dist: ${d.distance.toFixed(1)}m\nElev: ${d.elevation.toFixed(1)}m</description>${style?`<styleUrl>#${style}</styleUrl>`:''}<Point><coordinates>${d.lng},${d.lat},${d.elevation}</coordinates></Point></Placemark>\n`;
                }
            });
            kml+=`</Folder>\n</Document>\n</kml>`;
            download(kml,`perfil_elevacion_${Date.now()}.kml`,'application/vnd.google-earth.kml+xml');
            Toast.show('KML exportado','success');
        },
        exportGeoJSON(){
            if(this.elevationData.length===0)return Toast.show('Genera un perfil primero','error');
            const lineCoords=this.elevationData.map(d=>[d.lng,d.lat,d.elevation]);
            const minElev=Math.min(...this.elevationData.map(d=>d.elevation));
            const maxElev=Math.max(...this.elevationData.map(d=>d.elevation));
            const totalDist=this.elevationData[this.elevationData.length-1].distance;
            const features=[{
                type:'Feature',
                properties:{tipo:'linea_perfil',distancia_total:totalDist.toFixed(2),elev_min:minElev.toFixed(2),elev_max:maxElev.toFixed(2),desnivel:(maxElev-minElev).toFixed(2)},
                geometry:{type:'LineString',coordinates:lineCoords}
            }];
            this.elevationData.forEach((d,i)=>{
                features.push({
                    type:'Feature',
                    properties:{id:d.index,distancia:d.distance.toFixed(2),elevacion:d.elevation.toFixed(2),tipo:i===0?'inicio':i===this.elevationData.length-1?'fin':'punto'},
                    geometry:{type:'Point',coordinates:[d.lng,d.lat,d.elevation]}
                });
            });
            download(JSON.stringify({type:'FeatureCollection',name:'Perfil_Elevacion_WinTel',features},null,2),`perfil_elevacion_${Date.now()}.geojson`,'application/geo+json');
            Toast.show('GeoJSON exportado','success');
        },
        exportDXF(){
            if(this.elevationData.length===0)return Toast.show('Genera un perfil primero','error');
            let dxf=`0\nSECTION\n2\nHEADER\n0\nENDSEC\n0\nSECTION\n2\nTABLES\n0\nTABLE\n2\nLAYER\n`;
            dxf+=`0\nLAYER\n2\nPERFIL_LINEA\n70\n0\n62\n6\n6\nCONTINUOUS\n`;
            dxf+=`0\nLAYER\n2\nPERFIL_PUNTOS\n70\n0\n62\n5\n6\nCONTINUOUS\n`;
            dxf+=`0\nENDTAB\n0\nENDSEC\n0\nSECTION\n2\nENTITIES\n`;
            dxf+=`0\n3DPOLYLINE\n8\nPERFIL_LINEA\n66\n1\n70\n8\n`;
            this.elevationData.forEach(d=>{dxf+=`0\nVERTEX\n8\nPERFIL_LINEA\n10\n${d.lng}\n20\n${d.lat}\n30\n${d.elevation}\n`;});
            dxf+=`0\nSEQEND\n8\nPERFIL_LINEA\n`;
            this.elevationData.forEach((d,i)=>{
                dxf+=`0\nPOINT\n8\nPERFIL_PUNTOS\n10\n${d.lng}\n20\n${d.lat}\n30\n${d.elevation}\n`;
                if(i===0||i===this.elevationData.length-1||i%10===0){
                    dxf+=`0\nTEXT\n8\nPERFIL_PUNTOS\n10\n${d.lng}\n20\n${d.lat}\n30\n${d.elevation}\n40\n0.00003\n1\n${d.elevation.toFixed(1)}m\n`;
                }
            });
            dxf+=`0\nENDSEC\n0\nEOF\n`;
            download(dxf,`perfil_elevacion_${Date.now()}.dxf`,'application/dxf');
            Toast.show('DXF exportado para AutoCAD','success');
        },
        exportGPX(){
            if(this.elevationData.length===0)return Toast.show('Genera un perfil primero','error');
            let gpx=`<?xml version="1.0" encoding="UTF-8"?>\n<gpx version="1.1" creator="WIN-TEL GEOMATICS PRO v30">\n<metadata><n>Perfil de Elevacin</n><time>${new Date().toISOString()}</time></metadata>\n`;
            this.elevationData.forEach((d,i)=>{
                const tipo=i===0?'Inicio':i===this.elevationData.length-1?'Fin':`P${d.index}`;
                gpx+=`<wpt lat="${d.lat}" lon="${d.lng}"><ele>${d.elevation}</ele><n>${tipo}</n><desc>Dist: ${d.distance.toFixed(1)}m, Elev: ${d.elevation.toFixed(1)}m</desc></wpt>\n`;
            });
            gpx+=`<trk><n>Perfil de Elevacin</n><trkseg>\n`;
            this.elevationData.forEach(d=>{gpx+=`<trkpt lat="${d.lat}" lon="${d.lng}"><ele>${d.elevation}</ele></trkpt>\n`;});
            gpx+=`</trkseg></trk>\n</gpx>`;
            download(gpx,`perfil_elevacion_${Date.now()}.gpx`,'application/gpx+xml');
            Toast.show('GPX exportado para GPS','success');
        },
        exportPDF(){
            if(this.elevationData.length===0)return Toast.show('Genera un perfil primero','error');
            if(typeof jspdf==='undefined')return Toast.show('Librera PDF no disponible','error');
            const{jsPDF}=jspdf;
            const doc=new jsPDF();
            const minElev=Math.min(...this.elevationData.map(d=>d.elevation));
            const maxElev=Math.max(...this.elevationData.map(d=>d.elevation));
            const totalDist=this.elevationData[this.elevationData.length-1].distance;
            let totalAscent=0,totalDescent=0;
            for(let i=1;i<this.elevationData.length;i++){
                const diff=this.elevationData[i].elevation-this.elevationData[i-1].elevation;
                if(diff>0)totalAscent+=diff;else totalDescent+=Math.abs(diff);
            }
            doc.setFontSize(18);doc.setTextColor(236,72,153);
            doc.text('PERFIL DE ELEVACIN',20,20);
            doc.setFontSize(10);doc.setTextColor(100);
            doc.text('WIN-TEL GEOMATICS PRO v30',20,28);
            doc.text(`Fecha: ${new Date().toLocaleDateString('es-ES')}`,20,34);
            doc.setFontSize(12);doc.setTextColor(0);
            doc.text('RESUMEN',20,48);
            doc.setFontSize(10);
            doc.text(`Distancia total: ${totalDist.toFixed(1)} m`,25,56);
            doc.text(`Elevacin mnima: ${minElev.toFixed(1)} m`,25,62);
            doc.text(`Elevacin mxima: ${maxElev.toFixed(1)} m`,25,68);
            doc.text(`Desnivel: ${(maxElev-minElev).toFixed(1)} m`,25,74);
            doc.text(`Ascenso total: ${totalAscent.toFixed(1)} m`,25,80);
            doc.text(`Descenso total: ${totalDescent.toFixed(1)} m`,25,86);
            doc.text(`Puntos de muestreo: ${this.elevationData.length}`,25,92);
            doc.setFontSize(12);
            doc.text('PUNTOS DEL PERFIL',20,106);
            let y=114;
            doc.setFontSize(8);
            doc.text('Pto  |  Dist(m)  |  Elev(m)  |  Lat  |  Lng',25,y);y+=6;
            this.elevationData.forEach((d,i)=>{
                if(y>280){doc.addPage();y=20;}
                if(i<30||i===this.elevationData.length-1){
                    doc.text(`${d.index}  |  ${d.distance.toFixed(1)}  |  ${d.elevation.toFixed(1)}  |  ${d.lat.toFixed(5)}  |  ${d.lng.toFixed(5)}`,25,y);
                    y+=5;
                }
            });
            doc.save(`perfil_elevacion_${Date.now()}.pdf`);
            Toast.show('PDF generado','success');
        },
        exportTXT(){
            if(this.elevationData.length===0)return Toast.show('Genera un perfil primero','error');
            const minElev=Math.min(...this.elevationData.map(d=>d.elevation));
            const maxElev=Math.max(...this.elevationData.map(d=>d.elevation));
            const totalDist=this.elevationData[this.elevationData.length-1].distance;
            let totalAscent=0,totalDescent=0;
            for(let i=1;i<this.elevationData.length;i++){
                const diff=this.elevationData[i].elevation-this.elevationData[i-1].elevation;
                if(diff>0)totalAscent+=diff;else totalDescent+=Math.abs(diff);
            }
            let txt=`PERFIL DE ELEVACIN\n${'='.repeat(50)}\nGenerado por: WIN-TEL GEOMATICS PRO v30\nFecha: ${new Date().toLocaleString('es-ES')}\n\nRESUMEN\n${'-'.repeat(30)}\nDistancia total: ${totalDist.toFixed(1)} m\nElevacin mnima: ${minElev.toFixed(1)} m\nElevacin mxima: ${maxElev.toFixed(1)} m\nDesnivel: ${(maxElev-minElev).toFixed(1)} m\nAscenso total: ${totalAscent.toFixed(1)} m\nDescenso total: ${totalDescent.toFixed(1)} m\nPuntos: ${this.elevationData.length}\n\nDATOS DEL PERFIL\n${'-'.repeat(30)}\nPTO\tDIST(m)\tELEV(m)\tLAT\t\tLNG\n`;
            this.elevationData.forEach(d=>{
                txt+=`${d.index}\t${d.distance.toFixed(1)}\t${d.elevation.toFixed(1)}\t${d.lat.toFixed(6)}\t${d.lng.toFixed(6)}\n`;
            });
            download(txt,`perfil_elevacion_${Date.now()}.txt`,'text/plain');
            Toast.show('Reporte TXT exportado','success');
        },
        copyToClipboard(){
            if(this.elevationData.length===0)return Toast.show('Genera un perfil primero','error');
            let data='PTO\tDIST(m)\tELEV(m)\tLAT\tLNG\n';
            this.elevationData.forEach(d=>{
                data+=`${d.index}\t${d.distance.toFixed(1)}\t${d.elevation.toFixed(1)}\t${d.lat.toFixed(6)}\t${d.lng.toFixed(6)}\n`;
            });
            navigator.clipboard.writeText(data).then(()=>{
                Toast.show('Datos copiados al portapapeles','success');
            }).catch(()=>{
                Toast.show('Error al copiar','error');
            });
        },
        clear(){
            this.profileLayer.clearLayers();
            this.lineLayer.clearLayers();
            this.markersLayer.clearLayers();
            this.profileLine=null;
            this.elevationData=[];
            const chartContainer=$('profile-chart-container');
            const segments=$('profile-segments');
            const statsExtra=$('profile-stats-extra');
            const exportEl=$('profile-export');
            if(chartContainer)chartContainer.style.display='none';
            if(segments)segments.style.display='none';
            if(statsExtra)statsExtra.innerHTML='';
            if(exportEl)exportEl.style.display='none';
        }
    };

    // ========== CONTOUR ENGINE - CURVAS DE NIVEL ==========
    const ContourEngine={
        contourLayer:L.layerGroup(),
        contourData:[],
        async generate(){
            if(!State.polygon)return Toast.show('Dibuja un polgono primero','error');
            Loading.show();
            this.contourLayer.clearLayers();
            this.contourData=[];
            if(!State.map.hasLayer(this.contourLayer))State.map.addLayer(this.contourLayer);
            const interval=parseFloat($('contour-interval').value)||5;
            const resolution=parseInt($('contour-resolution').value)||25;
            const showLabels=$('contour-labels').checked;
            const style=$('contour-style')?.value||'standard';
            Toast.show('Preparando grilla de puntos...','info');
            const poly=turf.cleanCoords(turf.rewind(State.polygon));
            const bbox=turf.bbox(poly);
            const[minX,minY,maxX,maxY]=bbox;
            const degRes=resolution/111320;
            const pointsToFetch=[];
            for(let y=minY;y<=maxY;y+=degRes){
                for(let x=minX;x<=maxX;x+=degRes){
                    const pt=turf.point([x,y]);
                    if(turf.booleanPointInPolygon(pt,poly)){
                        pointsToFetch.push({lat:y,lng:x});
                    }
                }
            }
            if(pointsToFetch.length===0){
                Loading.hide();
                return Toast.show('El polgono es muy pequeo para la resolucin seleccionada','error');
            }
            Toast.show(`Obteniendo ${pointsToFetch.length} elevaciones...`,'info');
            const elevations=await ElevationService.getElevationBatch(pointsToFetch);
            const points=pointsToFetch.map((p,i)=>({...p,elevation:elevations[i]}));
            const minElev=Math.min(...elevations);
            const maxElev=Math.max(...elevations);
            Toast.show(`Elevaciones: ${minElev.toFixed(0)}m - ${maxElev.toFixed(0)}m. Generando curvas...`,'info');
            const startElev=Math.ceil(minElev/interval)*interval;
            const endElev=Math.floor(maxElev/interval)*interval;
            for(let elev=startElev;elev<=endElev;elev+=interval){
                const nearPoints=points.filter(p=>Math.abs(p.elevation-elev)<=interval/2);
                if(nearPoints.length>=2){
                    nearPoints.sort((a,b)=>a.lng-b.lng||a.lat-b.lat);
                    const orderedPoints=this.orderPointsByProximity(nearPoints);
                    if(orderedPoints.length>=2){
                        this.contourData.push({elevation:elev,points:orderedPoints});
                        const isMajor=(elev%(interval*5))===0;
                        let lineColor=isMajor?'#5D4037':'#8D6E63';
                        if(style==='color'){
                            const ratio=(elev-minElev)/(maxElev-minElev||1);
                            const colors=['#1a5f7a','#159895','#57c5b6','#9eff9e','#ffe66d','#ffc107','#ff9800','#f44336'];
                            lineColor=colors[Math.floor(ratio*(colors.length-1))];
                        }
                        const line=L.polyline(orderedPoints.map(p=>[p.lat,p.lng]),{
                            color:lineColor,weight:isMajor?2.5:1,opacity:isMajor?0.9:0.6
                        });
                        line.bindPopup(`<b>Curva de Nivel</b><br>Elevacin: ${elev} m`);
                        line.addTo(this.contourLayer);
                        if(showLabels&&isMajor&&orderedPoints.length>3){
                            const midIdx=Math.floor(orderedPoints.length/2);
                            const midPt=orderedPoints[midIdx];
                            L.marker([midPt.lat,midPt.lng],{
                                icon:L.divIcon({
                                    className:'contour-label',
                                    html:`<div style="background:${lineColor};color:#fff;padding:2px 5px;border-radius:3px;font-size:10px;font-weight:700;">${elev}m</div>`,
                                    iconSize:[40,18],iconAnchor:[20,9]
                                })
                            }).addTo(this.contourLayer);
                        }
                    }
                }
            }
            this.updateStats(minElev,maxElev,interval);
            Loading.hide();
            Toast.show(this.contourData.length>0?` ${this.contourData.length} curvas generadas`:'No se generaron curvas. Prueba menor intervalo.',this.contourData.length>0?'success':'warning');
        },
        orderPointsByProximity(points){
            if(points.length<2)return points;
            const result=[points[0]];
            const used=new Set([0]);
            while(result.length<points.length){
                const last=result[result.length-1];
                let nearestIdx=-1,nearestDist=Infinity;
                for(let i=0;i<points.length;i++){
                    if(used.has(i))continue;
                    const d=Math.sqrt((points[i].lat-last.lat)**2+(points[i].lng-last.lng)**2);
                    if(d<nearestDist){nearestDist=d;nearestIdx=i;}
                }
                if(nearestIdx===-1)break;
                result.push(points[nearestIdx]);
                used.add(nearestIdx);
            }
            return result;
        },
        updateStats(minElev,maxElev,interval){
            const countEl=$('contour-count');
            const rangeEl=$('contour-range');
            const diffEl=$('contour-diff');
            const resultsEl=$('contour-results');
            const exportEl=$('contour-export');
            if(countEl)countEl.textContent=this.contourData.length;
            if(rangeEl)rangeEl.textContent=`${minElev.toFixed(0)}-${maxElev.toFixed(0)} m`;
            if(diffEl)diffEl.textContent=(maxElev-minElev).toFixed(0)+' m';
            if(resultsEl)resultsEl.style.display='block';
            if(exportEl)exportEl.style.display='block';
        },
        exportDXF(){
            if(this.contourData.length===0)return Toast.show('Genera curvas primero','error');
            let dxf=`0\nSECTION\n2\nHEADER\n0\nENDSEC\n0\nSECTION\n2\nTABLES\n0\nTABLE\n2\nLAYER\n0\nLAYER\n2\nCURVAS_NIVEL\n70\n0\n62\n3\n6\nCONTINUOUS\n0\nENDTAB\n0\nENDSEC\n0\nSECTION\n2\nENTITIES\n`;
            this.contourData.forEach(c=>{
                if(c.points.length>=2){
                    dxf+=`0\nLWPOLYLINE\n8\nCURVAS_NIVEL\n38\n${c.elevation}\n90\n${c.points.length}\n70\n0\n`;
                    c.points.forEach(p=>{dxf+=`10\n${p.lng}\n20\n${p.lat}\n`;});
                }
            });
            dxf+=`0\nENDSEC\n0\nEOF\n`;
            download(dxf,`curvas_nivel_${Date.now()}.dxf`,'application/dxf');
            Toast.show('DXF exportado','success');
        },
        exportKML(){
            if(this.contourData.length===0)return Toast.show('Genera curvas primero','error');
            let kml=`<?xml version="1.0" encoding="UTF-8"?>\n<kml xmlns="http://www.opengis.net/kml/2.2">\n<Document>\n<n>Curvas de Nivel - WIN-TEL v30</n>\n`;
            kml+=`<Style id="majorContour"><LineStyle><color>ff0040ff</color><width>3</width></LineStyle></Style>\n`;
            kml+=`<Style id="minorContour"><LineStyle><color>ff404040</color><width>1</width></LineStyle></Style>\n`;
            this.contourData.forEach(c=>{
                const interval=parseFloat($('contour-interval').value)||5;
                const isMajor=(c.elevation%(interval*5))===0;
                kml+=`<Placemark><n>Curva ${c.elevation}m</n><description>Elevacin: ${c.elevation} m\nPuntos: ${c.points.length}</description><styleUrl>#${isMajor?'major':'minor'}Contour</styleUrl><LineString><altitudeMode>clampToGround</altitudeMode><coordinates>`;
                kml+=c.points.map(p=>`${p.lng},${p.lat},${c.elevation}`).join(' ');
                kml+=`</coordinates></LineString></Placemark>\n`;
            });
            kml+=`</Document>\n</kml>`;
            download(kml,`curvas_nivel_${Date.now()}.kml`,'application/vnd.google-earth.kml+xml');
            Toast.show('KML exportado','success');
        },
        exportGeoJSON(){
            if(this.contourData.length===0)return Toast.show('Genera curvas primero','error');
            const interval=parseFloat($('contour-interval').value)||5;
            const features=this.contourData.map(c=>({
                type:'Feature',
                properties:{
                    elevation:c.elevation,
                    tipo:((c.elevation%(interval*5))===0)?'mayor':'menor',
                    puntos:c.points.length
                },
                geometry:{
                    type:'LineString',
                    coordinates:c.points.map(p=>[p.lng,p.lat,c.elevation])
                }
            }));
            const geojson={type:'FeatureCollection',name:'Curvas_Nivel_WinTel',features:features};
            download(JSON.stringify(geojson,null,2),`curvas_nivel_${Date.now()}.geojson`,'application/geo+json');
            Toast.show('GeoJSON exportado','success');
        },
        exportCSV(){
            if(this.contourData.length===0)return Toast.show('Genera curvas primero','error');
            const interval=parseFloat($('contour-interval').value)||5;
            let csv='ELEVACION_M,TIPO,NUM_PUNTOS,LONGITUD_APROX_M\n';
            this.contourData.forEach(c=>{
                const isMajor=(c.elevation%(interval*5))===0;
                let length=0;
                for(let i=1;i<c.points.length;i++){
                    length+=GeoMath.vincentyDist(c.points[i-1].lat,c.points[i-1].lng,c.points[i].lat,c.points[i].lng);
                }
                csv+=`${c.elevation},${isMajor?'MAYOR':'MENOR'},${c.points.length},${length.toFixed(2)}\n`;
            });
            csv+='\nDETALLE DE PUNTOS\nELEVACION,PUNTO,LATITUD,LONGITUD\n';
            this.contourData.forEach(c=>{
                c.points.forEach((p,i)=>{
                    csv+=`${c.elevation},${i+1},${p.lat.toFixed(8)},${p.lng.toFixed(8)}\n`;
                });
            });
            download(csv,`curvas_nivel_${Date.now()}.csv`,'text/csv');
            Toast.show('CSV exportado con todos los datos','success');
        },
        exportGPX(){
            if(this.contourData.length===0)return Toast.show('Genera curvas primero','error');
            let gpx=`<?xml version="1.0" encoding="UTF-8"?>\n<gpx version="1.1" creator="WIN-TEL GEOMATICS PRO v30">\n<metadata><n>Curvas de Nivel</n><time>${new Date().toISOString()}</time></metadata>\n`;
            this.contourData.forEach(c=>{
                gpx+=`<trk><n>Curva ${c.elevation}m</n><desc>Elevacin: ${c.elevation} metros</desc><trkseg>\n`;
                c.points.forEach(p=>{
                    gpx+=`<trkpt lat="${p.lat}" lon="${p.lng}"><ele>${c.elevation}</ele></trkpt>\n`;
                });
                gpx+=`</trkseg></trk>\n`;
            });
            gpx+=`</gpx>`;
            download(gpx,`curvas_nivel_${Date.now()}.gpx`,'application/gpx+xml');
            Toast.show('GPX exportado para GPS','success');
        },
        exportPDF(){
            if(this.contourData.length===0)return Toast.show('Genera curvas primero','error');
            if(typeof jspdf==='undefined')return Toast.show('Librera PDF no disponible','error');
            const{jsPDF}=jspdf;
            const doc=new jsPDF();
            doc.setFontSize(18);
            doc.setTextColor(20,184,166);
            doc.text('REPORTE DE CURVAS DE NIVEL',20,20);
            doc.setFontSize(10);
            doc.setTextColor(100);
            doc.text('WIN-TEL GEOMATICS PRO v30',20,28);
            doc.text(`Fecha: ${new Date().toLocaleDateString('es-ES')}`,20,34);
            const elevations=this.contourData.map(c=>c.elevation);
            const minElev=Math.min(...elevations);
            const maxElev=Math.max(...elevations);
            const interval=parseFloat($('contour-interval').value)||5;
            doc.setFontSize(12);
            doc.setTextColor(0);
            doc.text('RESUMEN',20,48);
            doc.setFontSize(10);
            doc.text(`Total de curvas: ${this.contourData.length}`,25,56);
            doc.text(`Rango de elevacin: ${minElev} - ${maxElev} m`,25,62);
            doc.text(`Desnivel: ${maxElev-minElev} m`,25,68);
            doc.text(`Intervalo: ${interval} m`,25,74);
            doc.setFontSize(12);
            doc.text('LISTA DE CURVAS',20,88);
            let y=96;
            this.contourData.forEach(c=>{
                if(y>280){doc.addPage();y=20;}
                const isMajor=(c.elevation%(interval*5))===0;
                doc.setFontSize(10);
                doc.setTextColor(isMajor?20:100,isMajor?184:100,isMajor?166:100);
                doc.text(`${c.elevation} m ${isMajor?'(MAYOR)':''}`,25,y);
                doc.setTextColor(0);
                doc.text(`- ${c.points.length} puntos`,70,y);
                y+=6;
            });
            doc.save(`curvas_nivel_${Date.now()}.pdf`);
            Toast.show('PDF generado','success');
        },
        exportTXT(){
            if(this.contourData.length===0)return Toast.show('Genera curvas primero','error');
            const elevations=this.contourData.map(c=>c.elevation);
            const minElev=Math.min(...elevations);
            const maxElev=Math.max(...elevations);
            const interval=parseFloat($('contour-interval').value)||5;
            let txt=`REPORTE DE CURVAS DE NIVEL\n${'='.repeat(50)}\nGenerado por: WIN-TEL GEOMATICS PRO v30\nFecha: ${new Date().toLocaleString('es-ES')}\n\nRESUMEN\n${'-'.repeat(30)}\nTotal de curvas: ${this.contourData.length}\nRango: ${minElev} - ${maxElev} m\nDesnivel: ${maxElev-minElev} m\nIntervalo: ${interval} m\n\nLISTA DE CURVAS\n${'-'.repeat(30)}\n`;
            this.contourData.forEach(c=>{
                const isMajor=(c.elevation%(interval*5))===0;
                txt+=`\n${c.elevation} m ${isMajor?'(CURVA MAYOR)':''}  - ${c.points.length} puntos\n`;
            });
            txt+=`\nCOORDENADAS DETALLADAS\n${'-'.repeat(30)}\n`;
            this.contourData.forEach(c=>{
                txt+=`\nCurva ${c.elevation}m:\n`;
                c.points.forEach((p,i)=>{
                    txt+=`  ${i+1}: Lat ${p.lat.toFixed(6)}, Lng ${p.lng.toFixed(6)}\n`;
                });
            });
            download(txt,`curvas_nivel_${Date.now()}.txt`,'text/plain');
            Toast.show('Reporte TXT exportado','success');
        },
        copyToClipboard(){
            if(this.contourData.length===0)return Toast.show('Genera curvas primero','error');
            let data='ELEVACIN (m)\tPUNTOS\tTIPO\n';
            const interval=parseFloat($('contour-interval').value)||5;
            this.contourData.forEach(c=>{
                const isMajor=(c.elevation%(interval*5))===0;
                data+=`${c.elevation}\t${c.points.length}\t${isMajor?'MAYOR':'MENOR'}\n`;
            });
            navigator.clipboard.writeText(data).then(()=>{
                Toast.show('Datos copiados al portapapeles','success');
            }).catch(()=>{
                Toast.show('Error al copiar','error');
            });
        },
        clear(){
            this.contourLayer.clearLayers();
            this.contourData=[];
            const resultsEl=$('contour-results');
            const exportEl=$('contour-export');
            if(resultsEl)resultsEl.style.display='none';
            if(exportEl)exportEl.style.display='none';
        }
    };

    // ========== WATERSHED ENGINE - ANLISIS DE ESCORRENTA ==========
    const WatershedEngine={
        flowLayer:L.layerGroup(),
        accumulationLayer:L.layerGroup(),
        streamsLayer:L.layerGroup(),
        sinksLayer:L.layerGroup(),
        flowData:[],
        gridMap:null,
        results:null,
        async analyze(){
            if(!State.polygon)return Toast.show('Dibuja un polgono primero','error');
            Loading.show();
            this.clear();
            if(!State.map.hasLayer(this.flowLayer))State.map.addLayer(this.flowLayer);
            if(!State.map.hasLayer(this.accumulationLayer))State.map.addLayer(this.accumulationLayer);
            if(!State.map.hasLayer(this.streamsLayer))State.map.addLayer(this.streamsLayer);
            if(!State.map.hasLayer(this.sinksLayer))State.map.addLayer(this.sinksLayer);
            const resolution=parseInt($('water-resolution').value)||20;
            const threshold=parseInt($('water-threshold').value)||5;
            const showDirection=$('water-show-direction').checked;
            const showAccumulation=$('water-show-accumulation').checked;
            const showStreams=$('water-show-streams').checked;
            const showSinks=$('water-show-sinks').checked;
            const poly=turf.cleanCoords(turf.rewind(State.polygon));
            const bbox=turf.bbox(poly);
            const[minX,minY,maxX,maxY]=bbox;
            const degRes=resolution/111320;
            const rows=Math.ceil((maxY-minY)/degRes);
            const cols=Math.ceil((maxX-minX)/degRes);
            Toast.show(`Preparando grilla ${rows}x${cols}...`,'info');
            const pointsToFetch=[];
            this.gridMap=[];
            for(let r=0;r<rows;r++){
                this.gridMap[r]=[];
                for(let c=0;c<cols;c++){
                    const lat=minY+r*degRes;
                    const lng=minX+c*degRes;
                    const pt=turf.point([lng,lat]);
                    if(turf.booleanPointInPolygon(pt,poly)){
                        pointsToFetch.push({lat,lng,r,c});
                        this.gridMap[r][c]={lat,lng,r,c,flow:null,accumulation:1};
                    }else{
                        this.gridMap[r][c]=null;
                    }
                }
            }
            if(pointsToFetch.length===0){
                Loading.hide();
                return Toast.show('No hay puntos dentro del polgono','error');
            }
            Toast.show(`Obteniendo ${pointsToFetch.length} elevaciones...`,'info');
            const elevations=await ElevationService.getElevationBatch(pointsToFetch);
            let minElev=Infinity,maxElev=-Infinity;
            pointsToFetch.forEach((p,i)=>{
                if(this.gridMap[p.r][p.c]){
                    this.gridMap[p.r][p.c].elevation=elevations[i];
                    if(elevations[i]<minElev)minElev=elevations[i];
                    if(elevations[i]>maxElev)maxElev=elevations[i];
                }
            });
            Toast.show('Calculando direcciones de flujo...','info');
            const directions=[[0,1],[1,1],[1,0],[1,-1],[0,-1],[-1,-1],[-1,0],[-1,1]];
            const arrowChars=['','','','','','','',''];
            const dirNames=['E','SE','S','SW','W','NW','N','NE'];
            const dirEmojis=['','','','','','','',''];
            for(let r=0;r<rows;r++){
                for(let c=0;c<cols;c++){
                    if(!this.gridMap[r][c])continue;
                    let lowestElev=this.gridMap[r][c].elevation;
                    let flowDir=null;
                    directions.forEach((d,i)=>{
                        const nr=r+d[0],nc=c+d[1];
                        if(nr>=0&&nr<rows&&nc>=0&&nc<cols&&this.gridMap[nr]&&this.gridMap[nr][nc]){
                            if(this.gridMap[nr][nc].elevation<lowestElev){
                                lowestElev=this.gridMap[nr][nc].elevation;
                                flowDir=i;
                            }
                        }
                    });
                    this.gridMap[r][c].flow=flowDir;
                    this.gridMap[r][c].isSink=(flowDir===null);
                }
            }
            Toast.show('Calculando acumulacin...','info');
            for(let r=0;r<rows;r++){
                for(let c=0;c<cols;c++){
                    if(!this.gridMap[r][c])continue;
                    let cr=r,cc=c;
                    const visited=new Set();
                    while(this.gridMap[cr]&&this.gridMap[cr][cc]&&this.gridMap[cr][cc].flow!==null){
                        const key=`${cr},${cc}`;
                        if(visited.has(key))break;
                        visited.add(key);
                        const d=directions[this.gridMap[cr][cc].flow];
                        const nr=cr+d[0],nc=cc+d[1];
                        if(nr>=0&&nr<rows&&nc>=0&&nc<cols&&this.gridMap[nr]&&this.gridMap[nr][nc]){
                            this.gridMap[nr][nc].accumulation++;
                            cr=nr;cc=nc;
                        }else break;
                    }
                }
            }
            let maxAccum=1;
            const accumPoints=[];
            const sinkPoints=[];
            const streamPoints=[];
            const directionCounts=new Array(8).fill(0);
            for(let r=0;r<rows;r++){
                for(let c=0;c<cols;c++){
                    if(this.gridMap[r][c]){
                        const cell=this.gridMap[r][c];
                        if(cell.accumulation>maxAccum)maxAccum=cell.accumulation;
                        accumPoints.push(cell);
                        if(cell.flow!==null)directionCounts[cell.flow]++;
                        if(cell.isSink)sinkPoints.push(cell);
                        if(cell.accumulation>=threshold)streamPoints.push(cell);
                    }
                }
            }
            Toast.show('Renderizando resultados...','info');
            if(showAccumulation){
                accumPoints.forEach(p=>{
                    const intensity=p.accumulation/maxAccum;
                    if(intensity>0.05){
                        const radius=2+intensity*10;
                        const color=intensity>0.5?'#3b82f6':intensity>0.2?'#06b6d4':'#22d3ee';
                        L.circleMarker([p.lat,p.lng],{
                            radius:radius,fillColor:color,fillOpacity:0.5,color:color,weight:1
                        }).bindPopup(`<b>Acumulacin</b><br>Valor: ${p.accumulation}<br>Elev: ${p.elevation.toFixed(0)}m`).addTo(this.accumulationLayer);
                    }
                });
            }
            if(showDirection){
                accumPoints.forEach(p=>{
                    if(p.flow!==null){
                        L.marker([p.lat,p.lng],{
                            icon:L.divIcon({
                                className:'flow-arrow',
                                html:`<div style="color:rgba(59,130,246,0.6);font-size:10px;font-weight:bold;">${arrowChars[p.flow]}</div>`,
                                iconSize:[12,12],iconAnchor:[6,6]
                            })
                        }).addTo(this.flowLayer);
                    }
                });
            }
            if(showStreams&&streamPoints.length>0){
                streamPoints.forEach(p=>{
                    const width=Math.min(1+Math.log(p.accumulation),5);
                    L.circleMarker([p.lat,p.lng],{
                        radius:width+1,fillColor:'#0ea5e9',fillOpacity:0.8,color:'#0369a1',weight:1
                    }).bindPopup(`<b>Lnea de Drenaje</b><br>Acumulacin: ${p.accumulation}`).addTo(this.streamsLayer);
                });
            }
            if(showSinks){
                sinkPoints.forEach(p=>{
                    L.circleMarker([p.lat,p.lng],{
                        radius:8,fillColor:'#ef4444',fillOpacity:0.8,color:'#fff',weight:2
                    }).bindPopup(`<b> Punto Crtico</b><br>Posible encharcamiento<br>Elev: ${p.elevation.toFixed(0)}m`).addTo(this.sinksLayer);
                });
            }
            const mainDirIdx=directionCounts.indexOf(Math.max(...directionCounts));
            this.flowData=accumPoints;
            this.results={minElev,maxElev,maxAccum,totalCells:accumPoints.length,streamCount:streamPoints.length,sinkCount:sinkPoints.length,mainDirection:dirNames[mainDirIdx],mainDirectionEmoji:dirEmojis[mainDirIdx]};
            this.updateStats();
            Loading.hide();
            Toast.show(`Anlisis completado: ${accumPoints.length} celdas, ${streamPoints.length} drenajes`,'success');
        },
        updateStats(){
            if(!this.results)return;
            const r=this.results;
            $('water-highest').textContent=r.maxElev.toFixed(0)+' m';
            $('water-lowest').textContent=r.minElev.toFixed(0)+' m';
            $('water-streams-count').textContent=r.streamCount;
            $('water-sinks-count').textContent=r.sinkCount;
            $('water-main-direction').textContent=r.mainDirection;
            $('water-direction-arrow').textContent=r.mainDirectionEmoji;
            const rec=$('water-recommendation');
            if(r.sinkCount===0){
                rec.style.background='rgba(34,197,94,0.2)';rec.style.color='#22c55e';
                rec.innerHTML=' DRENAJE NATURAL BUENO: No se detectan zonas de encharcamiento';
            }else if(r.sinkCount<=3){
                rec.style.background='rgba(251,191,36,0.2)';rec.style.color='#fbbf24';
                rec.innerHTML=` ATENCIN: ${r.sinkCount} zona(s) con posible acumulacin de agua.`;
            }else{
                rec.style.background='rgba(239,68,68,0.2)';rec.style.color='#ef4444';
                rec.innerHTML=` DRENAJE DEFICIENTE: ${r.sinkCount} zonas crticas. Requiere drenaje.`;
            }
            $('water-results').style.display='block';
            const exportEl=$('water-export');if(exportEl)exportEl.style.display='block';
        },
        exportKML(){
            if(this.flowData.length===0)return Toast.show('Realiza el anlisis primero','error');
            const threshold=parseInt($('water-threshold').value)||5;
            const streamPoints=this.flowData.filter(p=>p.accumulation>=threshold);
            const sinkPoints=this.flowData.filter(p=>p.isSink);
            let kml=`<?xml version="1.0" encoding="UTF-8"?>\n<kml xmlns="http://www.opengis.net/kml/2.2">\n<Document>\n<n>Anlisis Hidrolgico - WIN-TEL v30</n>\n`;
            kml+=`<Style id="stream"><IconStyle><color>ffe9a506</color><scale>0.8</scale></IconStyle></Style>\n`;
            kml+=`<Style id="sink"><IconStyle><color>ff0000ff</color><scale>1.0</scale></IconStyle></Style>\n`;
            kml+=`<Folder><n>Lneas de Drenaje (${streamPoints.length})</n>\n`;
            streamPoints.forEach((p,i)=>{kml+=`<Placemark><n>Drenaje ${i+1}</n><description>Elev: ${p.elevation.toFixed(1)}m\nAcum: ${p.accumulation}</description><styleUrl>#stream</styleUrl><Point><coordinates>${p.lng},${p.lat},${p.elevation}</coordinates></Point></Placemark>\n`;});
            kml+=`</Folder>\n<Folder><n>Puntos Crticos (${sinkPoints.length})</n>\n`;
            sinkPoints.forEach((p,i)=>{kml+=`<Placemark><n>Crtico ${i+1}</n><description>Elev: ${p.elevation.toFixed(1)}m\nRiesgo de encharcamiento</description><styleUrl>#sink</styleUrl><Point><coordinates>${p.lng},${p.lat},${p.elevation}</coordinates></Point></Placemark>\n`;});
            kml+=`</Folder>\n</Document>\n</kml>`;
            download(kml,`analisis_hidrologico_${Date.now()}.kml`,'application/vnd.google-earth.kml+xml');
            Toast.show('KML exportado','success');
        },
        exportGeoJSON(){
            if(this.flowData.length===0)return Toast.show('Realiza el anlisis primero','error');
            const threshold=parseInt($('water-threshold').value)||5;
            const features=[];
            this.flowData.filter(p=>p.accumulation>=threshold).forEach((p,i)=>{
                features.push({type:'Feature',properties:{id:i+1,tipo:'drenaje',elevacion:p.elevation.toFixed(2),acumulacion:p.accumulation},geometry:{type:'Point',coordinates:[p.lng,p.lat,p.elevation]}});
            });
            this.flowData.filter(p=>p.isSink).forEach((p,i)=>{
                features.push({type:'Feature',properties:{id:i+1,tipo:'punto_critico',elevacion:p.elevation.toFixed(2),riesgo:'encharcamiento'},geometry:{type:'Point',coordinates:[p.lng,p.lat,p.elevation]}});
            });
            const r=this.results;
            const geojson={type:'FeatureCollection',name:'Analisis_Hidrologico_WinTel',properties:{elev_max:r.maxElev,elev_min:r.minElev,direccion:r.mainDirection,lineas_drenaje:r.streamCount,zonas_criticas:r.sinkCount},features};
            download(JSON.stringify(geojson,null,2),`analisis_hidrologico_${Date.now()}.geojson`,'application/geo+json');
            Toast.show('GeoJSON exportado','success');
        },
        exportDXF(){
            if(this.flowData.length===0)return Toast.show('Realiza el anlisis primero','error');
            const threshold=parseInt($('water-threshold').value)||5;
            let dxf=`0\nSECTION\n2\nHEADER\n0\nENDSEC\n0\nSECTION\n2\nTABLES\n0\nTABLE\n2\nLAYER\n`;
            dxf+=`0\nLAYER\n2\nDRENAJE\n70\n0\n62\n4\n6\nCONTINUOUS\n`;
            dxf+=`0\nLAYER\n2\nPUNTOS_CRITICOS\n70\n0\n62\n1\n6\nCONTINUOUS\n`;
            dxf+=`0\nENDTAB\n0\nENDSEC\n0\nSECTION\n2\nENTITIES\n`;
            this.flowData.filter(p=>p.accumulation>=threshold).forEach(p=>{
                dxf+=`0\nPOINT\n8\nDRENAJE\n10\n${p.lng}\n20\n${p.lat}\n30\n${p.elevation}\n`;
            });
            this.flowData.filter(p=>p.isSink).forEach((p,i)=>{
                dxf+=`0\nPOINT\n8\nPUNTOS_CRITICOS\n10\n${p.lng}\n20\n${p.lat}\n30\n${p.elevation}\n`;
                dxf+=`0\nCIRCLE\n8\nPUNTOS_CRITICOS\n10\n${p.lng}\n20\n${p.lat}\n40\n0.0001\n`;
            });
            dxf+=`0\nENDSEC\n0\nEOF\n`;
            download(dxf,`analisis_hidrologico_${Date.now()}.dxf`,'application/dxf');
            Toast.show('DXF exportado','success');
        },
        exportCSV(){
            if(this.flowData.length===0)return Toast.show('Realiza el anlisis primero','error');
            const threshold=parseInt($('water-threshold').value)||5;
            const r=this.results;
            let csv=`ANLISIS HIDROLGICO - WIN-TEL v30\nFecha,${new Date().toLocaleString('es-ES')}\nElevacin Mxima,${r.maxElev.toFixed(1)} m\nElevacin Mnima,${r.minElev.toFixed(1)} m\nDireccin Principal,${r.mainDirection}\nLneas de Drenaje,${r.streamCount}\nZonas Crticas,${r.sinkCount}\n\n`;
            csv+=`PUNTOS DE DRENAJE\nID,LATITUD,LONGITUD,ELEVACION_M,ACUMULACION\n`;
            this.flowData.filter(p=>p.accumulation>=threshold).forEach((p,i)=>{
                csv+=`${i+1},${p.lat.toFixed(8)},${p.lng.toFixed(8)},${p.elevation.toFixed(2)},${p.accumulation}\n`;
            });
            csv+=`\nPUNTOS CRTICOS (ENCHARCAMIENTO)\nID,LATITUD,LONGITUD,ELEVACION_M\n`;
            this.flowData.filter(p=>p.isSink).forEach((p,i)=>{
                csv+=`${i+1},${p.lat.toFixed(8)},${p.lng.toFixed(8)},${p.elevation.toFixed(2)}\n`;
            });
            download(csv,`analisis_hidrologico_${Date.now()}.csv`,'text/csv');
            Toast.show('CSV exportado','success');
        },
        exportGPX(){
            if(this.flowData.length===0)return Toast.show('Realiza el anlisis primero','error');
            const threshold=parseInt($('water-threshold').value)||5;
            let gpx=`<?xml version="1.0" encoding="UTF-8"?>\n<gpx version="1.1" creator="WIN-TEL v30">\n<metadata><n>Anlisis Hidrolgico</n><time>${new Date().toISOString()}</time></metadata>\n`;
            this.flowData.filter(p=>p.accumulation>=threshold).forEach((p,i)=>{
                gpx+=`<wpt lat="${p.lat}" lon="${p.lng}"><ele>${p.elevation}</ele><n>Drenaje ${i+1}</n><desc>Acum: ${p.accumulation}</desc><sym>Water Source</sym></wpt>\n`;
            });
            this.flowData.filter(p=>p.isSink).forEach((p,i)=>{
                gpx+=`<wpt lat="${p.lat}" lon="${p.lng}"><ele>${p.elevation}</ele><n>Crtico ${i+1}</n><desc>Zona de encharcamiento</desc><sym>Danger Area</sym></wpt>\n`;
            });
            gpx+=`</gpx>`;
            download(gpx,`analisis_hidrologico_${Date.now()}.gpx`,'application/gpx+xml');
            Toast.show('GPX exportado','success');
        },
        exportPDF(){
            if(!this.results)return Toast.show('Realiza el anlisis primero','error');
            if(typeof jspdf==='undefined')return Toast.show('PDF no disponible','error');
            const{jsPDF}=jspdf;const doc=new jsPDF();
            const r=this.results;
            doc.setFontSize(18);doc.setTextColor(6,182,212);
            doc.text('ANLISIS DE FLUJO DE AGUA',20,20);
            doc.setFontSize(10);doc.setTextColor(100);
            doc.text('WIN-TEL GEOMATICS PRO v30',20,28);
            doc.text(`Fecha: ${new Date().toLocaleDateString('es-ES')}`,20,34);
            doc.setFontSize(12);doc.setTextColor(0);
            doc.text('RESULTADOS DEL ANLISIS',20,48);
            doc.setFontSize(10);
            doc.text(`Celdas analizadas: ${r.totalCells}`,25,56);
            doc.text(`Elevacin mxima: ${r.maxElev.toFixed(1)} m`,25,62);
            doc.text(`Elevacin mnima: ${r.minElev.toFixed(1)} m`,25,68);
            doc.text(`Desnivel: ${(r.maxElev-r.minElev).toFixed(1)} m`,25,74);
            doc.text(`Direccin principal: ${r.mainDirection}`,25,80);
            doc.setFontSize(12);doc.setTextColor(14,165,233);
            doc.text(`Lneas de drenaje: ${r.streamCount}`,25,92);
            doc.setTextColor(239,68,68);
            doc.text(`Zonas crticas: ${r.sinkCount}`,25,100);
            doc.setFontSize(10);doc.setTextColor(0);
            let recom='';
            if(r.sinkCount===0)recom=' EXCELENTE: Terreno con buen drenaje natural.';
            else if(r.sinkCount<=3)recom=' ATENCIN: Zonas con posible acumulacin de agua.';
            else recom=' DEFICIENTE: Requiere sistema de drenaje.';
            doc.text(`Recomendacin: ${recom}`,25,112);
            doc.save(`analisis_hidrologico_${Date.now()}.pdf`);
            Toast.show('PDF generado','success');
        },
        exportTXT(){
            if(!this.results)return Toast.show('Realiza el anlisis primero','error');
            const r=this.results;
            const threshold=parseInt($('water-threshold').value)||5;
            let txt=`ANLISIS DE FLUJO DE AGUA\n${'='.repeat(50)}\nGenerado por: WIN-TEL GEOMATICS PRO v30\nFecha: ${new Date().toLocaleString('es-ES')}\n\nRESULTADOS\n${'-'.repeat(30)}\nCeldas analizadas: ${r.totalCells}\nElevacin mxima: ${r.maxElev.toFixed(1)} m\nElevacin mnima: ${r.minElev.toFixed(1)} m\nDesnivel: ${(r.maxElev-r.minElev).toFixed(1)} m\nDireccin principal: ${r.mainDirection}\nLneas de drenaje: ${r.streamCount}\nZonas crticas: ${r.sinkCount}\n\n`;
            let recom='';
            if(r.sinkCount===0)recom='EXCELENTE: Terreno con buen drenaje natural.';
            else if(r.sinkCount<=3)recom='ATENCIN: Zonas con posible acumulacin.';
            else recom='DEFICIENTE: Requiere sistema de drenaje.';
            txt+=`RECOMENDACIN: ${recom}\n\nPUNTOS DE DRENAJE\n${'-'.repeat(30)}\n`;
            this.flowData.filter(p=>p.accumulation>=threshold).forEach((p,i)=>{
                txt+=`${i+1}. Lat: ${p.lat.toFixed(6)}, Lng: ${p.lng.toFixed(6)}, Elev: ${p.elevation.toFixed(1)}m\n`;
            });
            txt+=`\nPUNTOS CRTICOS\n${'-'.repeat(30)}\n`;
            this.flowData.filter(p=>p.isSink).forEach((p,i)=>{
                txt+=`${i+1}. Lat: ${p.lat.toFixed(6)}, Lng: ${p.lng.toFixed(6)}, Elev: ${p.elevation.toFixed(1)}m\n`;
            });
            download(txt,`analisis_hidrologico_${Date.now()}.txt`,'text/plain');
            Toast.show('Reporte TXT exportado','success');
        },
        copyToClipboard(){
            if(!this.results)return Toast.show('Realiza el anlisis primero','error');
            const r=this.results;
            let data=`ANLISIS HIDROLGICO\nElev. Mx: ${r.maxElev.toFixed(1)}m\nElev. Mn: ${r.minElev.toFixed(1)}m\nDireccin: ${r.mainDirection}\nDrenajes: ${r.streamCount}\nCrticos: ${r.sinkCount}\n`;
            navigator.clipboard.writeText(data).then(()=>Toast.show('Copiado','success')).catch(()=>Toast.show('Error','error'));
        },
        exportReport(){
            this.exportTXT();
        },
        clear(){
            this.flowLayer.clearLayers();
            this.accumulationLayer.clearLayers();
            this.streamsLayer.clearLayers();
            this.sinksLayer.clearLayers();
            this.flowData=[];
            this.gridMap=null;
            this.results=null;
            $('water-results').style.display='none';
            const exp=$('water-export');if(exp)exp.style.display='none';
        }
    };

    // ========== VORONOI ENGINE - POLGONOS DE THIESSEN ==========
    const VoronoiEngine={
        voronoiLayer:L.layerGroup(),
        pointsLayer:L.layerGroup(),
        points:[],
        isAddingPoints:false,
        voronoiData:[],
        boundClickHandler:null,
        startAddPoints(){
            if(!State.polygon)return Toast.show('Dibuja un polgono primero','error');
            if(this.isAddingPoints)return;
            this.isAddingPoints=true;
            Toast.show('Haz clic en el mapa para aadir puntos de agua/pozos','info');
            if(!State.map.hasLayer(this.pointsLayer))State.map.addLayer(this.pointsLayer);
            this.boundClickHandler=(e)=>this.onMapClick(e);
            State.map.on('click',this.boundClickHandler);
            $('voronoi-adding').style.display='block';
        },
        onMapClick(e){
            const pt=turf.point([e.latlng.lng,e.latlng.lat]);
            if(!turf.booleanPointInPolygon(pt,State.polygon)){
                Toast.show('El punto debe estar dentro del polgono','warning');
                return;
            }
            const id=this.points.length+1;
            this.points.push({lat:e.latlng.lat,lng:e.latlng.lng,id:id});
            L.circleMarker([e.latlng.lat,e.latlng.lng],{
                radius:8,fillColor:'#3b82f6',fillOpacity:1,color:'#fff',weight:2
            }).bindPopup(`<b>Punto ${id}</b><br>Lat: ${e.latlng.lat.toFixed(6)}<br>Lng: ${e.latlng.lng.toFixed(6)}`).addTo(this.pointsLayer);
            $('voronoi-point-count').textContent=this.points.length;
        },
        stopAddPoints(){
            if(!this.isAddingPoints)return;
            this.isAddingPoints=false;
            if(this.boundClickHandler){
                State.map.off('click',this.boundClickHandler);
                this.boundClickHandler=null;
            }
            $('voronoi-adding').style.display='none';
            Toast.show(`${this.points.length} puntos aadidos`,'success');
        },
        generate(){
            if(this.points.length<2)return Toast.show('Aade al menos 2 puntos','error');
            if(!State.polygon)return Toast.show('No hay polgono','error');
            Loading.show();
            this.voronoiLayer.clearLayers();
            if(!State.map.hasLayer(this.voronoiLayer))State.map.addLayer(this.voronoiLayer);
            const poly=turf.cleanCoords(turf.rewind(State.polygon));
            const bbox=turf.bbox(poly);
            const expandedBbox=[bbox[0]-0.01,bbox[1]-0.01,bbox[2]+0.01,bbox[3]+0.01];
            const pointsFC=turf.featureCollection(this.points.map(p=>turf.point([p.lng,p.lat])));
            this.voronoiData=[];
            try{
                const voronoi=turf.voronoi(pointsFC,{bbox:expandedBbox});
                const colors=['#ef4444','#f59e0b','#22c55e','#3b82f6','#8b5cf6','#ec4899','#14b8a6','#f97316'];
                voronoi.features.forEach((cell,i)=>{
                    if(cell){
                        try{
                            const clipped=turf.intersect(poly,cell);
                            if(clipped&&clipped.geometry.type==='Polygon'){
                                const area=GeoMath.area(clipped.geometry.coordinates[0]);
                                const perim=GeoMath.perimeter(clipped.geometry.coordinates[0]);
                                const color=colors[i%colors.length];
                                const point=this.points[i]||{lat:0,lng:0,id:i+1};
                                const centroid=turf.centroid(clipped);
                                this.voronoiData.push({
                                    id:i+1,area:area,perimeter:perim,geometry:clipped,point:point,color:color,
                                    centroid:{lat:centroid.geometry.coordinates[1],lng:centroid.geometry.coordinates[0]},
                                    vertices:clipped.geometry.coordinates[0]
                                });
                                L.geoJSON(clipped,{
                                    style:{color:color,weight:2,fillColor:color,fillOpacity:0.3}
                                }).bindPopup(`<b>Zona ${i+1}</b><br>rea: ${(area/10000).toFixed(4)} Ha<br>Permetro: ${perim.toFixed(1)} m`).addTo(this.voronoiLayer);
                            }
                        }catch(e){}
                    }
                });
                this.updateStats();
                Loading.hide();
                Toast.show(`${this.voronoiData.length} zonas Voronoi generadas`,'success');
            }catch(e){
                Loading.hide();
                Toast.show('Error: '+e.message,'error');
            }
        },
        updateStats(){
            $('voronoi-zones').textContent=this.voronoiData.length;
            const totalArea=this.voronoiData.reduce((a,z)=>a+z.area,0);
            const avgArea=this.voronoiData.length>0?totalArea/this.voronoiData.length:0;
            $('voronoi-avg-area').textContent=(avgArea/10000).toFixed(4)+' Ha';
            $('voronoi-stats').style.display='block';
            $('voronoi-export').style.display='block';
        },
        exportKML(){
            if(this.voronoiData.length===0)return Toast.show('Genera zonas primero','error');
            let kml=`<?xml version="1.0" encoding="UTF-8"?>\n<kml xmlns="http://www.opengis.net/kml/2.2">\n<Document>\n<n>Zonas Voronoi - WIN-TEL v30</n>\n`;
            kml+=`<Folder><n>Zonas de Cobertura</n>\n`;
            this.voronoiData.forEach(z=>{
                const coords=z.vertices.map(c=>`${c[0]},${c[1]},0`).join(' ');
                kml+=`<Placemark><n>Zona ${z.id}</n><description>rea: ${(z.area/10000).toFixed(4)} Ha\nPermetro: ${z.perimeter.toFixed(1)} m</description><Polygon><outerBoundaryIs><LinearRing><coordinates>${coords}</coordinates></LinearRing></outerBoundaryIs></Polygon></Placemark>\n`;
            });
            kml+=`</Folder>\n<Folder><n>Puntos</n>\n`;
            this.points.forEach((p,i)=>{
                kml+=`<Placemark><n>Punto ${i+1}</n><Point><coordinates>${p.lng},${p.lat},0</coordinates></Point></Placemark>\n`;
            });
            kml+=`</Folder>\n</Document>\n</kml>`;
            download(kml,`voronoi_${Date.now()}.kml`,'application/vnd.google-earth.kml+xml');
            Toast.show('KML exportado','success');
        },
        exportGeoJSON(){
            if(this.voronoiData.length===0)return Toast.show('Genera zonas primero','error');
            const features=this.voronoiData.map(z=>({type:'Feature',properties:{id:z.id,area_ha:(z.area/10000).toFixed(4),perimetro_m:z.perimeter.toFixed(2)},geometry:z.geometry.geometry}));
            const pts=this.points.map((p,i)=>({type:'Feature',properties:{id:i+1,tipo:'punto'},geometry:{type:'Point',coordinates:[p.lng,p.lat]}}));
            download(JSON.stringify({type:'FeatureCollection',features:[...features,...pts]},null,2),`voronoi_${Date.now()}.geojson`,'application/geo+json');
            Toast.show('GeoJSON exportado','success');
        },
        exportDXF(){
            if(this.voronoiData.length===0)return Toast.show('Genera zonas primero','error');
            let dxf=`0\nSECTION\n2\nHEADER\n0\nENDSEC\n0\nSECTION\n2\nTABLES\n0\nTABLE\n2\nLAYER\n0\nLAYER\n2\nVORONOI\n70\n0\n62\n5\n6\nCONTINUOUS\n0\nENDTAB\n0\nENDSEC\n0\nSECTION\n2\nENTITIES\n`;
            this.voronoiData.forEach(z=>{
                dxf+=`0\nLWPOLYLINE\n8\nVORONOI\n90\n${z.vertices.length}\n70\n1\n`;
                z.vertices.forEach(v=>{dxf+=`10\n${v[0]}\n20\n${v[1]}\n`;});
            });
            dxf+=`0\nENDSEC\n0\nEOF\n`;
            download(dxf,`voronoi_${Date.now()}.dxf`,'application/dxf');
            Toast.show('DXF exportado','success');
        },
        exportCSV(){
            if(this.voronoiData.length===0)return Toast.show('Genera zonas primero','error');
            let csv='ZONA,AREA_M2,AREA_HA,PERIMETRO_M,PUNTO_LAT,PUNTO_LNG,CENTROIDE_LAT,CENTROIDE_LNG\n';
            this.voronoiData.forEach(z=>{
                csv+=`${z.id},${z.area.toFixed(2)},${(z.area/10000).toFixed(4)},${z.perimeter.toFixed(2)},${z.point.lat.toFixed(8)},${z.point.lng.toFixed(8)},${z.centroid.lat.toFixed(8)},${z.centroid.lng.toFixed(8)}\n`;
            });
            csv+='\nPUNTOS\nID,LAT,LNG\n';
            this.points.forEach((p,i)=>{csv+=`${i+1},${p.lat.toFixed(8)},${p.lng.toFixed(8)}\n`;});
            csv+='\nVERTICES\nZONA,V,LAT,LNG\n';
            this.voronoiData.forEach(z=>{z.vertices.forEach((v,i)=>{csv+=`${z.id},${i+1},${v[1].toFixed(8)},${v[0].toFixed(8)}\n`;});});
            download(csv,`voronoi_${Date.now()}.csv`,'text/csv');
            Toast.show('CSV exportado','success');
        },
        exportGPX(){
            if(this.voronoiData.length===0)return Toast.show('Genera zonas primero','error');
            let gpx=`<?xml version="1.0" encoding="UTF-8"?>\n<gpx version="1.1" creator="WIN-TEL v30">\n`;
            this.points.forEach((p,i)=>{gpx+=`<wpt lat="${p.lat}" lon="${p.lng}"><n>Punto ${i+1}</n></wpt>\n`;});
            this.voronoiData.forEach(z=>{gpx+=`<wpt lat="${z.centroid.lat}" lon="${z.centroid.lng}"><n>Zona ${z.id}</n><desc>rea: ${(z.area/10000).toFixed(4)} Ha</desc></wpt>\n`;});
            gpx+=`</gpx>`;
            download(gpx,`voronoi_${Date.now()}.gpx`,'application/gpx+xml');
            Toast.show('GPX exportado','success');
        },
        exportPDF(){
            if(this.voronoiData.length===0)return Toast.show('Genera zonas primero','error');
            if(typeof jspdf==='undefined')return Toast.show('Librera PDF no disponible','error');
            const{jsPDF}=jspdf;
            const doc=new jsPDF();
            doc.setFontSize(16);doc.text('ZONAS VORONOI - WIN-TEL v30',20,20);
            doc.setFontSize(10);doc.text(`Fecha: ${new Date().toLocaleDateString('es-ES')}`,20,28);
            const totalArea=this.voronoiData.reduce((a,z)=>a+z.area,0);
            doc.text(`Zonas: ${this.voronoiData.length} | rea total: ${(totalArea/10000).toFixed(4)} Ha`,20,36);
            let y=48;
            this.voronoiData.forEach(z=>{
                if(y>280){doc.addPage();y=20;}
                doc.text(`Zona ${z.id}: ${(z.area/10000).toFixed(4)} Ha, Permetro: ${z.perimeter.toFixed(1)} m`,25,y);
                y+=8;
            });
            doc.save(`voronoi_${Date.now()}.pdf`);
            Toast.show('PDF generado','success');
        },
        exportTXT(){
            if(this.voronoiData.length===0)return Toast.show('Genera zonas primero','error');
            const totalArea=this.voronoiData.reduce((a,z)=>a+z.area,0);
            let txt=`ZONAS VORONOI - WIN-TEL v30\n${'='.repeat(40)}\nFecha: ${new Date().toLocaleString('es-ES')}\nTotal zonas: ${this.voronoiData.length}\nrea total: ${(totalArea/10000).toFixed(4)} Ha\n\nDETALLE:\n`;
            this.voronoiData.forEach(z=>{txt+=`\nZona ${z.id}: ${(z.area/10000).toFixed(4)} Ha, Permetro: ${z.perimeter.toFixed(1)} m\n  Punto: ${z.point.lat.toFixed(6)}, ${z.point.lng.toFixed(6)}\n`;});
            download(txt,`voronoi_${Date.now()}.txt`,'text/plain');
            Toast.show('TXT exportado','success');
        },
        copyToClipboard(){
            if(this.voronoiData.length===0)return Toast.show('Genera zonas primero','error');
            let data='ZONA\tREA_HA\tPERMETRO_M\tLAT\tLNG\n';
            this.voronoiData.forEach(z=>{data+=`${z.id}\t${(z.area/10000).toFixed(4)}\t${z.perimeter.toFixed(2)}\t${z.point.lat.toFixed(6)}\t${z.point.lng.toFixed(6)}\n`;});
            navigator.clipboard.writeText(data).then(()=>Toast.show('Copiado al portapapeles','success')).catch(()=>Toast.show('Error','error'));
        },
        clear(){
            this.stopAddPoints();
            this.voronoiLayer.clearLayers();
            this.pointsLayer.clearLayers();
            this.points=[];
            this.voronoiData=[];
            $('voronoi-point-count').textContent='0';
            $('voronoi-stats').style.display='none';
            const exp=$('voronoi-export');if(exp)exp.style.display='none';
        }
    };

    // ========== TRANSECT ENGINE - TRANSECTOS DE MUESTREO ==========
    const TransectEngine={
        transectLayer:L.layerGroup(),
        pointsLayer:L.layerGroup(),
        transects:[],
        samplePoints:[],
        generate(){
            if(!State.polygon)return Toast.show('Dibuja un polgono primero','error');
            Loading.show();
            this.transectLayer.clearLayers();
            this.pointsLayer.clearLayers();
            if(!State.map.hasLayer(this.transectLayer))State.map.addLayer(this.transectLayer);
            if(!State.map.hasLayer(this.pointsLayer))State.map.addLayer(this.pointsLayer);
            const type=$('transect-type').value;
            const spacing=parseFloat($('transect-spacing').value)||50;
            const angle=parseFloat($('transect-angle').value)||0;
            const pointSpacing=parseFloat($('transect-point-spacing').value)||20;
            const poly=turf.cleanCoords(turf.rewind(State.polygon));
            const center=turf.centroid(poly);
            const rotated=turf.transformRotate(poly,-angle,{pivot:center});
            const bbox=turf.bbox(rotated);
            const[minX,minY,maxX,maxY]=bbox;
            const degSpacing=spacing/111320;
            const degPointSpacing=pointSpacing/111320;
            this.transects=[];
            this.samplePoints=[];
            if(type==='parallel'||type==='zigzag'){
                let transectId=1;
                for(let y=minY;y<=maxY;y+=degSpacing){
                    let line=turf.lineString([[minX-0.01,y],[maxX+0.01,y]]);
                    line=turf.transformRotate(line,angle,{pivot:center});
                    try{
                        const clipped=turf.lineSplit(line,poly);
                        clipped.features.forEach(segment=>{
                            const mid=turf.centroid(segment);
                            if(turf.booleanPointInPolygon(mid,poly)){
                                const length=turf.length(segment,{units:'meters'});
                                this.transects.push({id:transectId,geometry:segment,length:length});
                                const coords=segment.geometry.coordinates;
                                L.polyline(coords.map(c=>[c[1],c[0]]),{
                                    color:'#8b5cf6',
                                    weight:2,
                                    opacity:0.8
                                }).bindPopup(`<b>Transecto ${transectId}</b><br>Longitud: ${length.toFixed(1)}m`).addTo(this.transectLayer);
                                for(let d=0;d<=length;d+=pointSpacing){
                                    const pt=turf.along(segment,d,{units:'meters'});
                                    if(turf.booleanPointInPolygon(pt,poly)){
                                        const[lng,lat]=pt.geometry.coordinates;
                                        this.samplePoints.push({
                                            transect:transectId,
                                            point:this.samplePoints.length+1,
                                            lat:lat,
                                            lng:lng,
                                            distance:d
                                        });
                                        L.circleMarker([lat,lng],{
                                            radius:4,
                                            fillColor:'#fbbf24',
                                            fillOpacity:1,
                                            color:'#fff',
                                            weight:1
                                        }).bindPopup(`<b>Punto ${this.samplePoints.length}</b><br>Transecto: ${transectId}<br>Distancia: ${d.toFixed(1)}m`).addTo(this.pointsLayer);
                                    }
                                }
                                transectId++;
                            }
                        });
                    }catch(e){}
                }
            }else if(type==='random'){
                const numPoints=parseInt($('transect-random-points').value)||30;
                let attempts=0;
                while(this.samplePoints.length<numPoints&&attempts<numPoints*10){
                    const randomLng=minX+Math.random()*(maxX-minX);
                    const randomLat=minY+Math.random()*(maxY-minY);
                    let pt=turf.point([randomLng,randomLat]);
                    pt=turf.transformRotate(pt,angle,{pivot:center});
                    if(turf.booleanPointInPolygon(pt,poly)){
                        const[lng,lat]=pt.geometry.coordinates;
                        this.samplePoints.push({
                            transect:0,
                            point:this.samplePoints.length+1,
                            lat:lat,
                            lng:lng,
                            distance:0
                        });
                        L.circleMarker([lat,lng],{
                            radius:5,
                            fillColor:'#22c55e',
                            fillOpacity:1,
                            color:'#fff',
                            weight:1
                        }).bindPopup(`<b>Punto ${this.samplePoints.length}</b>`).addTo(this.pointsLayer);
                    }
                    attempts++;
                }
            }else if(type==='grid'){
                let pointId=1;
                for(let y=minY;y<=maxY;y+=degSpacing){
                    for(let x=minX;x<=maxX;x+=degSpacing){
                        let pt=turf.point([x,y]);
                        pt=turf.transformRotate(pt,angle,{pivot:center});
                        if(turf.booleanPointInPolygon(pt,poly)){
                            const[lng,lat]=pt.geometry.coordinates;
                            this.samplePoints.push({
                                transect:0,
                                point:pointId,
                                lat:lat,
                                lng:lng,
                                distance:0
                            });
                            L.circleMarker([lat,lng],{
                                radius:4,
                                fillColor:'#06b6d4',
                                fillOpacity:1,
                                color:'#fff',
                                weight:1
                            }).bindPopup(`<b>Punto ${pointId}</b>`).addTo(this.pointsLayer);
                            pointId++;
                        }
                    }
                }
            }
            this.updateStats();
            Loading.hide();
            Toast.show(`${this.transects.length} transectos, ${this.samplePoints.length} puntos de muestreo`,'success');
        },
        updateStats(){
            $('transect-count').textContent=this.transects.length;
            $('transect-points-count').textContent=this.samplePoints.length;
            const totalLength=this.transects.reduce((a,t)=>a+t.length,0);
            $('transect-total-length').textContent=totalLength.toFixed(0)+' m';
            $('transect-stats').style.display='block';
            const exp=$('transect-export');if(exp)exp.style.display='block';
        },
        exportCSV(){
            if(this.samplePoints.length===0)return Toast.show('Genera puntos primero','error');
            let csv='PUNTO_ID,TRANSECTO,LATITUD,LONGITUD,DISTANCIA_M\n';
            this.samplePoints.forEach(p=>{csv+=`${p.point},${p.transect},${p.lat.toFixed(8)},${p.lng.toFixed(8)},${p.distance.toFixed(2)}\n`;});
            if(this.transects.length>0){csv+='\nTRANSECTOS\nID,LONGITUD_M\n';this.transects.forEach(t=>{csv+=`${t.id},${t.length.toFixed(2)}\n`;});}
            download(csv,`transectos_${Date.now()}.csv`,'text/csv');Toast.show('CSV exportado','success');
        },
        exportKML(){
            if(this.samplePoints.length===0)return Toast.show('Genera puntos primero','error');
            let kml=`<?xml version="1.0" encoding="UTF-8"?>\n<kml xmlns="http://www.opengis.net/kml/2.2">\n<Document>\n<n>Transectos WIN-TEL v30</n>\n`;
            if(this.transects.length>0){kml+=`<Folder><n>Lineas</n>\n`;this.transects.forEach(t=>{kml+=`<Placemark><n>T${t.id}</n><LineString><coordinates>${t.geometry.geometry.coordinates.map(c=>`${c[0]},${c[1]},0`).join(' ')}</coordinates></LineString></Placemark>\n`;});kml+=`</Folder>\n`;}
            kml+=`<Folder><n>Puntos</n>\n`;this.samplePoints.forEach(p=>{kml+=`<Placemark><n>PT${p.point}</n><Point><coordinates>${p.lng},${p.lat},0</coordinates></Point></Placemark>\n`;});
            kml+=`</Folder>\n</Document>\n</kml>`;download(kml,`transectos_${Date.now()}.kml`,'application/vnd.google-earth.kml+xml');Toast.show('KML exportado','success');
        },
        exportGPX(){
            if(this.samplePoints.length===0)return Toast.show('Genera puntos primero','error');
            let gpx=`<?xml version="1.0" encoding="UTF-8"?>\n<gpx version="1.1" creator="WIN-TEL v30">\n`;
            this.samplePoints.forEach(p=>{gpx+=`<wpt lat="${p.lat}" lon="${p.lng}"><n>PT${p.point}</n></wpt>\n`;});
            this.transects.forEach(t=>{gpx+=`<trk><n>T${t.id}</n><trkseg>\n`;t.geometry.geometry.coordinates.forEach(c=>{gpx+=`<trkpt lat="${c[1]}" lon="${c[0]}"></trkpt>\n`;});gpx+=`</trkseg></trk>\n`;});
            gpx+=`</gpx>`;download(gpx,`transectos_${Date.now()}.gpx`,'application/gpx+xml');Toast.show('GPX exportado','success');
        },
        exportGeoJSON(){
            if(this.samplePoints.length===0)return Toast.show('Genera puntos primero','error');
            const pts=this.samplePoints.map(p=>({type:'Feature',properties:{id:p.point,transecto:p.transect},geometry:{type:'Point',coordinates:[p.lng,p.lat]}}));
            const lines=this.transects.map(t=>({type:'Feature',properties:{id:t.id,longitud:t.length.toFixed(2)},geometry:t.geometry.geometry}));
            download(JSON.stringify({type:'FeatureCollection',features:[...lines,...pts]},null,2),`transectos_${Date.now()}.geojson`,'application/geo+json');Toast.show('GeoJSON exportado','success');
        },
        exportDXF(){
            if(this.samplePoints.length===0)return Toast.show('Genera puntos primero','error');
            let dxf=`0\nSECTION\n2\nHEADER\n0\nENDSEC\n0\nSECTION\n2\nTABLES\n0\nTABLE\n2\nLAYER\n0\nLAYER\n2\nTRANSECTOS\n70\n0\n62\n5\n0\nLAYER\n2\nPUNTOS\n70\n0\n62\n2\n0\nENDTAB\n0\nENDSEC\n0\nSECTION\n2\nENTITIES\n`;
            this.transects.forEach(t=>{dxf+=`0\nLWPOLYLINE\n8\nTRANSECTOS\n90\n${t.geometry.geometry.coordinates.length}\n70\n0\n`;t.geometry.geometry.coordinates.forEach(c=>{dxf+=`10\n${c[0]}\n20\n${c[1]}\n`;});});
            this.samplePoints.forEach(p=>{dxf+=`0\nPOINT\n8\nPUNTOS\n10\n${p.lng}\n20\n${p.lat}\n`;});
            dxf+=`0\nENDSEC\n0\nEOF\n`;download(dxf,`transectos_${Date.now()}.dxf`,'application/dxf');Toast.show('DXF exportado','success');
        },
        exportPDF(){
            if(this.samplePoints.length===0)return Toast.show('Genera puntos primero','error');
            if(typeof jspdf==='undefined')return Toast.show('PDF no disponible','error');
            const{jsPDF}=jspdf;const doc=new jsPDF();
            doc.setFontSize(16);doc.text('TRANSECTOS - WIN-TEL v30',20,20);
            doc.setFontSize(10);doc.text(`Fecha: ${new Date().toLocaleDateString('es-ES')}`,20,28);
            const totalLen=this.transects.reduce((a,t)=>a+t.length,0);
            doc.text(`Transectos: ${this.transects.length} | Puntos: ${this.samplePoints.length} | Longitud: ${totalLen.toFixed(0)}m`,20,36);
            let y=48;this.transects.forEach(t=>{if(y>280){doc.addPage();y=20;}doc.text(`T${t.id}: ${t.length.toFixed(1)}m`,25,y);y+=6;});
            doc.save(`transectos_${Date.now()}.pdf`);Toast.show('PDF generado','success');
        },
        exportTXT(){
            if(this.samplePoints.length===0)return Toast.show('Genera puntos primero','error');
            const totalLen=this.transects.reduce((a,t)=>a+t.length,0);
            let txt=`TRANSECTOS - WIN-TEL v30\n${'='.repeat(40)}\n${new Date().toLocaleString('es-ES')}\nTransectos: ${this.transects.length} | Puntos: ${this.samplePoints.length} | Longitud: ${totalLen.toFixed(0)}m\n\n`;
            this.transects.forEach(t=>{txt+=`T${t.id}: ${t.length.toFixed(1)}m\n`;});
            txt+=`\nPUNTOS:\nID,TRANS,LAT,LNG\n`;this.samplePoints.forEach(p=>{txt+=`${p.point},${p.transect},${p.lat.toFixed(6)},${p.lng.toFixed(6)}\n`;});
            download(txt,`transectos_${Date.now()}.txt`,'text/plain');Toast.show('TXT exportado','success');
        },
        copyToClipboard(){
            if(this.samplePoints.length===0)return Toast.show('Genera puntos primero','error');
            let data='PUNTO\tTRANS\tLAT\tLNG\n';this.samplePoints.forEach(p=>{data+=`${p.point}\t${p.transect}\t${p.lat.toFixed(6)}\t${p.lng.toFixed(6)}\n`;});
            navigator.clipboard.writeText(data).then(()=>Toast.show('Copiado','success')).catch(()=>Toast.show('Error','error'));
        },
        clear(){
            this.transectLayer.clearLayers();this.pointsLayer.clearLayers();this.transects=[];this.samplePoints=[];
            $('transect-stats').style.display='none';const exp=$('transect-export');if(exp)exp.style.display='none';
        }
    };

    const GridEngine={updateAngle(val){State.gridAngle=parseFloat(val)||0;$('grid-angle').value=State.gridAngle;$('grid-angle-n').value=State.gridAngle;this.preview();},getAlleyIdx(){const idx=[];$$('.alley-pos').forEach(sel=>{const v=parseInt(sel.value);if(!isNaN(v))idx.push(v);});return idx.sort((a,b)=>a-b);},genAlleyCtrl(){const rows=parseInt($('grid-rows').value)||4,num=parseInt($('num-alleys').value)||0;let html='';for(let i=0;i<num;i++)html+=`<div class="form-group" style="margin-top:8px;"><label class="form-label">Vialidad ${i+1} despus de fila:</label><select class="form-input alley-pos" onchange="GridEngine.preview()">${Array.from({length:rows},(_,j)=>`<option value="${j+1}" ${j+1===Math.min(i+1,rows)?'selected':''}>Fila ${j+1}</option>`).join('')}</select></div>`;$('alley-ctrl').innerHTML=html;this.preview();},preview(){if(!State.polygon)return;State.layers.preview.clearLayers();State.layers.alleys.clearLayers();const rows=parseInt($('grid-rows').value)||4,cols=parseInt($('grid-cols').value)||4,angle=State.gridAngle,alleyW=parseFloat($('alley-w').value)||12,alleyIdx=this.getAlleyIdx();const poly=turf.cleanCoords(turf.rewind(State.polygon)),center=turf.centroid(poly),rotated=turf.transformRotate(poly,-angle,{pivot:center}),bbox=turf.bbox(rotated),[minX,minY,maxX,maxY]=bbox,degAlley=alleyW/111320,totalAlleyH=alleyIdx.length*degAlley,cellH=((maxY-minY)-totalAlleyH)/rows,cellW=(maxX-minX)/cols;let currentY=minY;for(let r=0;r<=rows;r++){if(alleyIdx.includes(r)){let ap=turf.polygon([[[minX,currentY],[maxX,currentY],[maxX,currentY+degAlley],[minX,currentY+degAlley],[minX,currentY]]]);ap=turf.transformRotate(ap,angle,{pivot:center});L.geoJSON(ap,{style:{color:'#ff0000',weight:2,fillColor:'#ff0000',fillOpacity:0.5}}).addTo(State.layers.alleys);currentY+=degAlley;}let line=turf.lineString([[minX,currentY],[maxX,currentY]]);line=turf.transformRotate(line,angle,{pivot:center});L.geoJSON(line,{style:{color:'#00ff00',weight:3,opacity:1}}).addTo(State.layers.preview);currentY+=cellH;}for(let c=0;c<=cols;c++){const x=minX+c*cellW;let line=turf.lineString([[x,minY],[x,maxY+totalAlleyH]]);line=turf.transformRotate(line,angle,{pivot:center});L.geoJSON(line,{style:{color:'#00ff00',weight:3,opacity:1}}).addTo(State.layers.preview);}},apply(){if(!State.polygon)return;Loading.show();State.blocks=[];State.selectedIds.clear();const rows=parseInt($('grid-rows').value)||4,cols=parseInt($('grid-cols').value)||4,angle=State.gridAngle,alleyW=parseFloat($('alley-w').value)||12,alleyIdx=this.getAlleyIdx();const poly=turf.cleanCoords(turf.rewind(State.polygon)),center=turf.centroid(poly),rotated=turf.transformRotate(poly,-angle,{pivot:center}),bbox=turf.bbox(rotated),[minX,minY,maxX,maxY]=bbox,degAlley=alleyW/111320,totalAlleyH=alleyIdx.length*degAlley,cellH=((maxY-minY)-totalAlleyH)/rows,cellW=(maxX-minX)/cols,colors=State.colors[State.theme];let currentY=minY;for(let r=1;r<=rows;r++){for(let c=0;c<cols;c++){const x1=minX+c*cellW,x2=x1+cellW,y1=currentY,y2=currentY+cellH;let cell=turf.polygon([[[x1,y1],[x2,y1],[x2,y2],[x1,y2],[x1,y1]]]);cell=turf.transformRotate(cell,angle,{pivot:center});try{const inter=turf.intersect(poly,cell);if(inter){const process=geo=>{const area=GeoMath.area(geo.geometry.coordinates[0]);if(area>1)State.blocks.push({uid:Math.random().toString(36).substr(2,9),id:State.blocks.length+1,geo,area,color:colors[State.blocks.length%colors.length]});};inter.geometry.type==='MultiPolygon'?inter.geometry.coordinates.forEach(c=>process(turf.polygon(c))):process(inter);}}catch(e){}}currentY+=cellH;const alleysHere=alleyIdx.filter(idx=>idx===r).length;for(let k=0;k<alleysHere;k++){let ap=turf.polygon([[[minX,currentY],[maxX,currentY],[maxX,currentY+degAlley],[minX,currentY+degAlley],[minX,currentY]]]);ap=turf.transformRotate(ap,angle,{pivot:center});try{const clipped=turf.intersect(poly,ap);if(clipped)L.geoJSON(clipped,{style:{color:'#475569',weight:2,fillColor:'#64748b',fillOpacity:0.7}}).bindPopup('<b>VIALIDAD</b>').addTo(State.layers.result);}catch(e){}currentY+=degAlley;}}State.layers.preview.clearLayers();State.layers.alleys.clearLayers();HistoryMgr.save('grid');Renderer.render();BotalonMgr.calculate();Loading.hide();Toast.show(`${State.blocks.length} lotes`,'success');}};

    // ========== BISECT ENGINE AVANZADO ==========
    const BisectEngine={
        angle:0,
        previewLayer:L.layerGroup(),
        lastResults:null,
        changeMode(){
            const mode=$('bisect-mode').value;
            $$('.bisect-mode-panel').forEach(p=>p.style.display='none');
            const panel=$('bisect-mode-'+mode);
            if(panel)panel.style.display='block';
            this.preview();
        },
        updateAngle(val){
            this.angle=parseFloat(val)||0;
            $('bisect-angle').value=this.angle;
            $('bisect-angle-n').value=this.angle;
            this.preview();
        },
        togglePreview(){
            if($('bisect-preview-on').checked){
                this.preview();
            }else{
                this.previewLayer.clearLayers();
            }
        },
        preview(){
            if(!State.polygon||!$('bisect-preview-on').checked)return;
            this.previewLayer.clearLayers();
            if(!State.map.hasLayer(this.previewLayer))State.map.addLayer(this.previewLayer);
            const mode=$('bisect-mode').value;
            const poly=turf.cleanCoords(turf.rewind(State.polygon));
            const center=turf.centroid(poly);
            const bbox=turf.bbox(poly);
            const diag=Math.sqrt((bbox[2]-bbox[0])**2+(bbox[3]-bbox[1])**2)*2;
            const angle=this.angle;
            const angleRad=angle*Math.PI/180;
            if(mode==='equal'){
                const parts=parseInt($('bisect-parts').value)||2;
                const totalArea=GeoMath.area(poly.geometry.coordinates[0]);
                const areaPerPart=totalArea/parts;
                $('bisect-equal-preview').innerHTML=`Cada parte: ~${(areaPerPart/10000).toFixed(4)} Ha (${areaPerPart.toFixed(0)} m)`;
                for(let i=1;i<parts;i++){
                    const offset=(i/parts-0.5)*diag;
                    const perpRad=angleRad+Math.PI/2;
                    const cx=center.geometry.coordinates[0]+offset*Math.cos(perpRad);
                    const cy=center.geometry.coordinates[1]+offset*Math.sin(perpRad);
                    const line=turf.lineString([
                        [cx-diag*Math.cos(angleRad),cy-diag*Math.sin(angleRad)],
                        [cx+diag*Math.cos(angleRad),cy+diag*Math.sin(angleRad)]
                    ]);
                    L.geoJSON(line,{style:{color:'#a855f7',weight:2,dashArray:'8,4',opacity:0.8}}).addTo(this.previewLayer);
                }
            }else if(mode==='strips'){
                const stripWidth=parseFloat($('bisect-strip-width').value)||20;
                const degWidth=stripWidth/111320;
                const rotated=turf.transformRotate(poly,-angle,{pivot:center});
                const rbbox=turf.bbox(rotated);
                const height=rbbox[3]-rbbox[1];
                const numStrips=Math.floor(height/degWidth);
                for(let i=1;i<numStrips;i++){
                    const y=rbbox[1]+i*degWidth;
                    let line=turf.lineString([[rbbox[0]-0.001,y],[rbbox[2]+0.001,y]]);
                    line=turf.transformRotate(line,angle,{pivot:center});
                    L.geoJSON(line,{style:{color:'#a855f7',weight:2,dashArray:'8,4',opacity:0.8}}).addTo(this.previewLayer);
                }
            }else if(mode==='proportional'){
                const ratioStr=$('bisect-ratio').value||'60/40';
                const ratios=ratioStr.split('/').map(r=>parseFloat(r.trim())).filter(r=>!isNaN(r)&&r>0);
                if(ratios.length>=2){
                    const total=ratios.reduce((a,b)=>a+b,0);
                    const totalArea=GeoMath.area(poly.geometry.coordinates[0]);
                    let html='';
                    let cumulative=0;
                    ratios.forEach((r,i)=>{
                        const pct=(r/total)*100;
                        const area=(r/total)*totalArea;
                        html+=`<div style="display:flex;justify-content:space-between;"><span>Parte ${String.fromCharCode(65+i)}:</span><span>${pct.toFixed(1)}% = ${(area/10000).toFixed(4)} Ha</span></div>`;
                        if(i<ratios.length-1){
                            cumulative+=r/total;
                            const offset=(cumulative-0.5)*diag;
                            const perpRad=angleRad+Math.PI/2;
                            const cx=center.geometry.coordinates[0]+offset*Math.cos(perpRad);
                            const cy=center.geometry.coordinates[1]+offset*Math.sin(perpRad);
                            const line=turf.lineString([
                                [cx-diag*Math.cos(angleRad),cy-diag*Math.sin(angleRad)],
                                [cx+diag*Math.cos(angleRad),cy+diag*Math.sin(angleRad)]
                            ]);
                            L.geoJSON(line,{style:{color:'#a855f7',weight:2,dashArray:'8,4',opacity:0.8}}).addTo(this.previewLayer);
                        }
                    });
                    $('bisect-ratio-preview').innerHTML=html;
                }
            }else if(mode==='percent'){
                const pct=parseInt($('bisect-percent').value)||50;
                $('bisect-pct-a').textContent=pct+'%';
                $('bisect-pct-b').textContent=(100-pct)+'%';
                const offset=(pct/100-0.5)*diag;
                const perpRad=angleRad+Math.PI/2;
                const cx=center.geometry.coordinates[0]+offset*Math.cos(perpRad);
                const cy=center.geometry.coordinates[1]+offset*Math.sin(perpRad);
                const line=turf.lineString([
                    [cx-diag*Math.cos(angleRad),cy-diag*Math.sin(angleRad)],
                    [cx+diag*Math.cos(angleRad),cy+diag*Math.sin(angleRad)]
                ]);
                L.geoJSON(line,{style:{color:'#a855f7',weight:2,dashArray:'8,4',opacity:0.8}}).addTo(this.previewLayer);
            }else{
                const perpRad=angleRad+Math.PI/2;
                const line=turf.lineString([
                    [center.geometry.coordinates[0]-diag*Math.cos(angleRad),center.geometry.coordinates[1]-diag*Math.sin(angleRad)],
                    [center.geometry.coordinates[0]+diag*Math.cos(angleRad),center.geometry.coordinates[1]+diag*Math.sin(angleRad)]
                ]);
                L.geoJSON(line,{style:{color:'#a855f7',weight:2,dashArray:'8,4',opacity:0.8}}).addTo(this.previewLayer);
            }
        },
        splitPolygonByLine(poly,lineCoords){
            try{
                const line=turf.buffer(turf.lineString(lineCoords),0.00001,{units:'degrees'});
                const diff=turf.difference(poly,line);
                if(!diff)return null;
                if(diff.geometry.type==='Polygon')return[diff];
                if(diff.geometry.type==='MultiPolygon'){
                    return diff.geometry.coordinates.map(c=>turf.polygon(c));
                }
                return null;
            }catch(e){return null;}
        },
        findCutPosition(poly,targetArea,angle,tolerance=0.01){
            const center=turf.centroid(poly);
            const bbox=turf.bbox(poly);
            const diag=Math.sqrt((bbox[2]-bbox[0])**2+(bbox[3]-bbox[1])**2)*1.5;
            const angleRad=angle*Math.PI/180;
            const perpRad=angleRad+Math.PI/2;
            let low=-diag,high=diag,best=null;
            for(let iter=0;iter<60;iter++){
                const mid=(low+high)/2;
                const cx=center.geometry.coordinates[0]+mid*Math.cos(perpRad);
                const cy=center.geometry.coordinates[1]+mid*Math.sin(perpRad);
                const lineCoords=[
                    [cx-diag*Math.cos(angleRad),cy-diag*Math.sin(angleRad)],
                    [cx+diag*Math.cos(angleRad),cy+diag*Math.sin(angleRad)]
                ];
                const parts=this.splitPolygonByLine(poly,lineCoords);
                if(!parts||parts.length<2)continue;
                const areas=parts.map(p=>GeoMath.area(p.geometry.coordinates[0]));
                const minArea=Math.min(...areas);
                const err=Math.abs(minArea-targetArea);
                const relErr=err/targetArea;
                if(!best||err<best.err){
                    best={parts,areas,err,relErr,lineCoords,mid};
                }
                if(relErr<tolerance)break;
                if(minArea<targetArea){
                    if(areas[0]<areas[1])high=mid;else low=mid;
                }else{
                    if(areas[0]<areas[1])low=mid;else high=mid;
                }
            }
            return best;
        },
        execute(){
            if(!State.polygon)return Toast.show('Dibuja un polgono primero','error');
            Loading.show();
            const mode=$('bisect-mode').value;
            const poly=turf.cleanCoords(turf.rewind(State.polygon));
            const totalArea=GeoMath.area(poly.geometry.coordinates[0]);
            const angle=this.angle;
            const colors=State.colors[State.theme];
            let results=[];
            try{
                if(mode==='area'){
                    const targetHa=parseFloat($('bisect-area').value)||1;
                    const targetArea=targetHa*10000;
                    if(targetArea>=totalArea){
                        Loading.hide();
                        return Toast.show('El rea deseada excede el total','error');
                    }
                    const cut=this.findCutPosition(poly,targetArea,angle);
                    if(cut&&cut.parts.length>=2){
                        results=cut.parts.map((p,i)=>({
                            geo:p,
                            area:cut.areas[i],
                            id:String.fromCharCode(65+i)
                        }));
                    }
                }else if(mode==='percent'){
                    const pct=parseInt($('bisect-percent').value)||50;
                    const targetArea=totalArea*(pct/100);
                    const cut=this.findCutPosition(poly,targetArea,angle);
                    if(cut&&cut.parts.length>=2){
                        results=cut.parts.map((p,i)=>({
                            geo:p,
                            area:cut.areas[i],
                            id:String.fromCharCode(65+i)
                        }));
                    }
                }else if(mode==='equal'){
                    const numParts=parseInt($('bisect-parts').value)||2;
                    let remaining=poly;
                    const targetPerPart=totalArea/numParts;
                    for(let i=0;i<numParts-1;i++){
                        const remainingArea=GeoMath.area(remaining.geometry.coordinates[0]);
                        const cut=this.findCutPosition(remaining,targetPerPart,angle);
                        if(cut&&cut.parts.length>=2){
                            const smallerIdx=cut.areas[0]<cut.areas[1]?0:1;
                            const largerIdx=1-smallerIdx;
                            results.push({
                                geo:cut.parts[smallerIdx],
                                area:cut.areas[smallerIdx],
                                id:String.fromCharCode(65+i)
                            });
                            remaining=cut.parts[largerIdx];
                        }else break;
                    }
                    if(remaining){
                        results.push({
                            geo:remaining,
                            area:GeoMath.area(remaining.geometry.coordinates[0]),
                            id:String.fromCharCode(65+results.length)
                        });
                    }
                }else if(mode==='proportional'){
                    const ratioStr=$('bisect-ratio').value||'60/40';
                    const ratios=ratioStr.split('/').map(r=>parseFloat(r.trim())).filter(r=>!isNaN(r)&&r>0);
                    const totalRatio=ratios.reduce((a,b)=>a+b,0);
                    let remaining=poly;
                    let cumRatio=0;
                    for(let i=0;i<ratios.length-1;i++){
                        cumRatio+=ratios[i];
                        const targetPct=ratios[i]/totalRatio;
                        const remainingArea=GeoMath.area(remaining.geometry.coordinates[0]);
                        const targetArea=remainingArea*targetPct/(1-cumRatio/totalRatio+targetPct);
                        const cut=this.findCutPosition(remaining,targetArea,angle);
                        if(cut&&cut.parts.length>=2){
                            const smallerIdx=cut.areas[0]<cut.areas[1]?0:1;
                            const largerIdx=1-smallerIdx;
                            results.push({
                                geo:cut.parts[smallerIdx],
                                area:cut.areas[smallerIdx],
                                id:String.fromCharCode(65+i)
                            });
                            remaining=cut.parts[largerIdx];
                        }else break;
                    }
                    if(remaining){
                        results.push({
                            geo:remaining,
                            area:GeoMath.area(remaining.geometry.coordinates[0]),
                            id:String.fromCharCode(65+results.length)
                        });
                    }
                }else if(mode==='width'){
                    const width=parseFloat($('bisect-width').value)||50;
                    const degWidth=width/111320;
                    const from=$('bisect-width-from').value;
                    const rotated=turf.transformRotate(poly,-angle,{pivot:turf.centroid(poly)});
                    const rbbox=turf.bbox(rotated);
                    let cutY;
                    if(from==='bottom')cutY=rbbox[1]+degWidth;
                    else if(from==='top')cutY=rbbox[3]-degWidth;
                    else cutY=rbbox[1]+degWidth;
                    let line=turf.lineString([[rbbox[0]-0.01,cutY],[rbbox[2]+0.01,cutY]]);
                    line=turf.transformRotate(line,angle,{pivot:turf.centroid(poly)});
                    const parts=this.splitPolygonByLine(poly,line.geometry.coordinates);
                    if(parts&&parts.length>=2){
                        results=parts.map((p,i)=>({
                            geo:p,
                            area:GeoMath.area(p.geometry.coordinates[0]),
                            id:String.fromCharCode(65+i)
                        }));
                    }
                }else if(mode==='strips'){
                    const stripWidth=parseFloat($('bisect-strip-width').value)||20;
                    const maxStrips=parseInt($('bisect-strip-max').value)||10;
                    const includeRemainder=$('bisect-strip-remainder').checked;
                    const degWidth=stripWidth/111320;
                    const center=turf.centroid(poly);
                    const rotated=turf.transformRotate(poly,-angle,{pivot:center});
                    const rbbox=turf.bbox(rotated);
                    const height=rbbox[3]-rbbox[1];
                    const numStrips=Math.min(Math.floor(height/degWidth),maxStrips);
                    let currentY=rbbox[1];
                    for(let i=0;i<numStrips;i++){
                        const y1=currentY;
                        const y2=currentY+degWidth;
                        let strip=turf.polygon([[[rbbox[0]-0.01,y1],[rbbox[2]+0.01,y1],[rbbox[2]+0.01,y2],[rbbox[0]-0.01,y2],[rbbox[0]-0.01,y1]]]);
                        strip=turf.transformRotate(strip,angle,{pivot:center});
                        try{
                            const inter=turf.intersect(poly,strip);
                            if(inter){
                                const area=GeoMath.area(inter.geometry.coordinates[0]);
                                if(area>10){
                                    results.push({
                                        geo:inter,
                                        area:area,
                                        id:`F${i+1}`
                                    });
                                }
                            }
                        }catch(e){}
                        currentY+=degWidth;
                    }
                    if(includeRemainder&&currentY<rbbox[3]){
                        let remainder=turf.polygon([[[rbbox[0]-0.01,currentY],[rbbox[2]+0.01,currentY],[rbbox[2]+0.01,rbbox[3]+0.01],[rbbox[0]-0.01,rbbox[3]+0.01],[rbbox[0]-0.01,currentY]]]);
                        remainder=turf.transformRotate(remainder,angle,{pivot:center});
                        try{
                            const inter=turf.intersect(poly,remainder);
                            if(inter){
                                const area=GeoMath.area(inter.geometry.coordinates[0]);
                                if(area>10){
                                    results.push({
                                        geo:inter,
                                        area:area,
                                        id:'REM'
                                    });
                                }
                            }
                        }catch(e){}
                    }
                }
                if(results.length>0){
                    State.blocks=results.map((r,i)=>({
                        uid:Math.random().toString(36).substr(2,9),
                        id:r.id,
                        geo:r.geo,
                        area:r.area,
                        color:colors[i%colors.length]
                    }));
                    State.selectedIds.clear();
                    this.previewLayer.clearLayers();
                    HistoryMgr.save('bisect');
                    Renderer.render();
                    BotalonMgr.calculate();
                    this.showResults(results,totalArea);
                    Toast.show(`Divisin completada: ${results.length} partes`,'success');
                }else{
                    Toast.show('No se pudo realizar la divisin','error');
                }
            }catch(e){
                Toast.show('Error en la divisin: '+e.message,'error');
            }
            Loading.hide();
        },
        showResults(results,totalArea){
            $('bisect-results').style.display='block';
            let html='<div style="display:grid;gap:8px;">';
            let totalResultArea=0;
            results.forEach((r,i)=>{
                const pct=(r.area/totalArea*100).toFixed(2);
                totalResultArea+=r.area;
                const color=State.colors[State.theme][i%State.colors[State.theme].length];
                html+=`<div style="display:flex;align-items:center;gap:10px;padding:8px;background:rgba(0,0,0,0.2);border-radius:4px;border-left:4px solid ${color};">
                    <div style="font-weight:700;font-size:16px;color:${color};min-width:40px;">${r.id}</div>
                    <div style="flex:1;">
                        <div style="font-size:12px;font-weight:600;color:#fff;">${r.area.toFixed(2)} m</div>
                        <div style="font-size:10px;color:var(--text-3);">${(r.area/10000).toFixed(4)} Ha</div>
                    </div>
                    <div style="font-size:14px;font-weight:700;color:#a855f7;">${pct}%</div>
                </div>`;
            });
            html+='</div>';
            $('bisect-results-content').innerHTML=html;
            const precision=((totalResultArea/totalArea)*100-100).toFixed(3);
            $('bisect-precision').textContent=(precision>=0?'+':'')+precision+'%';
            $('bisect-precision').style.color=Math.abs(parseFloat(precision))<1?'#22c55e':'#fbbf24';
        },
        autoOptimalAngle(){
            if(!State.polygon)return Toast.show('Dibuja un polgono primero','error');
            Loading.show();
            const poly=State.polygon;
            const coords=poly.geometry.coordinates[0];
            let bestAngle=0;
            let maxLength=0;
            for(let i=0;i<coords.length-1;i++){
                const p1=coords[i];
                const p2=coords[i+1];
                const length=turf.distance(turf.point(p1),turf.point(p2),{units:'meters'});
                if(length>maxLength){
                    maxLength=length;
                    bestAngle=turf.bearing(turf.point(p1),turf.point(p2));
                }
            }
            const normalizedAngle=((bestAngle%180)+180)%180;
            this.updateAngle(normalizedAngle);
            Loading.hide();
            Toast.show(`ngulo ptimo: ${normalizedAngle.toFixed(1)} (paralelo al lado ms largo)`,'success');
        },
        followBoundary(){
            if(!State.polygon)return Toast.show('Dibuja un polgono primero','error');
            const coords=State.polygon.geometry.coordinates[0];
            if(coords.length<3)return;
            const p1=coords[0];
            const p2=coords[1];
            const angle=turf.bearing(turf.point(p1),turf.point(p2));
            const normalizedAngle=((angle%180)+180)%180;
            this.updateAngle(normalizedAngle);
            Toast.show(`ngulo ajustado al primer lindero: ${normalizedAngle.toFixed(1)}`,'success');
        },
        clearPreview(){
            this.previewLayer.clearLayers();
            $('bisect-results').style.display='none';
        }
    };

    // ========== OMEGA SLICER ENGINE ==========
    const SlicerEngine={
        lastPartA:null,
        lastPartB:null,
        syncAngle(val){
            const v=Math.max(0,Math.min(180,parseFloat(val)||0));
            $('slicer-angle').value=v;
            $('slicer-angle-n').value=v;
            this.preview();
        },
        preview(){
            if(!State.polygon){
                this.updateUI(0,0);
                return;
            }
            State.layers.slicer=State.layers.slicer||L.layerGroup().addTo(State.map);
            State.layers.slicer.clearLayers();
            const pct=parseInt($('slicer-pos').value)||50;
            const angle=parseFloat($('slicer-angle-n').value)||0;
            $('slicer-pos-val').textContent=pct+'%';
            try{
                const poly=turf.cleanCoords(turf.rewind(State.polygon));
                const center=turf.centroid(poly);
                const rotated=turf.transformRotate(poly,-angle,{pivot:center});
                const bbox=turf.bbox(rotated);
                const [minX,minY,maxX,maxY]=bbox;
                const width=maxX-minX;
                const height=maxY-minY;
                const cutX=minX+(width*(pct/100));
                const pad=height*2;
                let maskA=turf.polygon([[[minX-pad,minY-pad],[cutX,minY-pad],[cutX,maxY+pad],[minX-pad,maxY+pad],[minX-pad,minY-pad]]]);
                let maskB=turf.polygon([[[cutX,minY-pad],[maxX+pad,minY-pad],[maxX+pad,maxY+pad],[cutX,maxY+pad],[cutX,minY-pad]]]);
                maskA=turf.transformRotate(maskA,angle,{pivot:center});
                maskB=turf.transformRotate(maskB,angle,{pivot:center});
                const partA=turf.intersect(poly,maskA);
                const partB=turf.intersect(poly,maskB);
                let areaA=0,areaB=0;
                if(partA){
                    areaA=GeoMath.area(partA.geometry.type==='Polygon'?partA.geometry.coordinates[0]:partA.geometry.coordinates[0][0]);
                    L.geoJSON(partA,{style:{color:'#22d3ee',weight:2,fillColor:'#22d3ee',fillOpacity:0.35,dashArray:'6,4'}}).addTo(State.layers.slicer);
                    this.lastPartA=partA;
                }
                if(partB){
                    areaB=GeoMath.area(partB.geometry.type==='Polygon'?partB.geometry.coordinates[0]:partB.geometry.coordinates[0][0]);
                    L.geoJSON(partB,{style:{color:'#fbbf24',weight:2,fillColor:'#fbbf24',fillOpacity:0.35,dashArray:'6,4'}}).addTo(State.layers.slicer);
                    this.lastPartB=partB;
                }
                let cutLine=turf.lineString([[cutX,minY-pad],[cutX,maxY+pad]]);
                cutLine=turf.transformRotate(cutLine,angle,{pivot:center});
                const clippedLine=turf.lineIntersect(cutLine,turf.bboxPolygon(turf.bbox(poly)));
                if(clippedLine.features.length>=2){
                    const pts=clippedLine.features.map(f=>f.geometry.coordinates);
                    L.polyline([pts[0].slice().reverse(),pts[1].slice().reverse()],{color:'#ec4899',weight:3,dashArray:'8,6',className:'slicer-line-anim'}).addTo(State.layers.slicer);
                }else{
                    L.geoJSON(cutLine,{style:{color:'#ec4899',weight:3,dashArray:'8,6'}}).addTo(State.layers.slicer);
                }
                this.updateUI(areaA,areaB);
            }catch(e){
                console.warn('SlicerEngine preview error:',e);
                this.updateUI(0,0);
            }
        },
        updateUI(areaA,areaB){
            const haA=(areaA/10000).toFixed(4);
            const haB=(areaB/10000).toFixed(4);
            $('slicer-area-a').textContent=haA;
            $('slicer-area-b').textContent=haB;
            const total=areaA+areaB;
            if(total>0){
                const pctA=((areaA/total)*100).toFixed(1);
                const pctB=((areaB/total)*100).toFixed(1);
                $('slicer-ratio').textContent=`${pctA}% / ${pctB}%`;
                $('slicer-bar-a').style.width=pctA+'%';
            }else{
                $('slicer-ratio').textContent='0% / 0%';
                $('slicer-bar-a').style.width='50%';
            }
        },
        clearPreview(){
            if(State.layers.slicer)State.layers.slicer.clearLayers();
            this.lastPartA=null;
            this.lastPartB=null;
            this.updateUI(0,0);
        },
        apply(){
            if(!State.polygon){Toast.show('No hay polgono','error');return;}
            if(!this.lastPartA||!this.lastPartB){
                this.preview();
                if(!this.lastPartA||!this.lastPartB){
                    Toast.show('Error al calcular corte','error');
                    return;
                }
            }
            Loading.show();
            try{
                const colors=State.colors[State.theme];
                const processGeo=(geo,id,color)=>{
                    if(!geo)return null;
                    const coords=geo.geometry.type==='Polygon'?geo.geometry.coordinates[0]:geo.geometry.coordinates[0][0];
                    const area=GeoMath.area(coords);
                    if(area<1)return null;
                    return{uid:Math.random().toString(36).substr(2,9),id,geo:geo.geometry.type==='Polygon'?geo:turf.polygon(geo.geometry.coordinates[0]),area,color};
                };
                State.blocks=[];
                const blockA=processGeo(this.lastPartA,'A',colors[6]);
                const blockB=processGeo(this.lastPartB,'B',colors[3]);
                if(blockA)State.blocks.push(blockA);
                if(blockB)State.blocks.push(blockB);
                State.selectedIds.clear();
                this.clearPreview();
                HistoryMgr.save('slicer');
                Renderer.render();
                BotalonMgr.calculate();
                Toast.show(`Corte aplicado: ${State.blocks.length} partes`,'success');
            }catch(e){
                console.error('SlicerEngine apply error:',e);
                Toast.show('Error al aplicar corte','error');
            }
            Loading.hide();
        }
    };

    // ========== RADIAL ENGINE ==========
    const RadialEngine={sync(type,val){if(type==='s'){$('rad-sectors').value=val;$('rad-sectors-n').value=val;}else if(type==='h'){$('hub-rad').value=val;$('hub-rad-n').value=val;}else if(type==='a'){$('rad-angle').value=val;$('rad-angle-n').value=val;}this.preview();},placeHub(){if(!State.polygon){Toast.show('No hay polgono','error');return;}State.hubCenter=turf.centroid(State.polygon).geometry.coordinates;if(State.hubMarker)State.hubMarker.remove();State.hubMarker=L.marker([State.hubCenter[1],State.hubCenter[0]],{draggable:true,icon:L.divIcon({html:'<div style="background:white;border:3px solid #4da6ff;width:18px;height:18px;border-radius:50%;box-shadow:0 0 12px rgba(77,166,255,0.6);"></div>',className:'',iconSize:[18,18],iconAnchor:[9,9]})}).addTo(State.map);State.hubMarker.on('drag',e=>{const ll=e.target.getLatLng();State.hubCenter=[ll.lng,ll.lat];$('hub-coords').textContent=`${ll.lat.toFixed(6)}, ${ll.lng.toFixed(6)}`;this.preview();});$('hub-info').classList.remove('hidden');$('hub-coords').textContent=`${State.hubCenter[1].toFixed(6)}, ${State.hubCenter[0].toFixed(6)}`;this.preview();},preview(){if(!State.polygon||!State.hubCenter)return;const sectors=parseInt($('rad-sectors-n').value)||8,hubRad=parseFloat($('hub-rad-n').value)||0,startAngle=parseFloat($('rad-angle-n').value)||0;State.layers.radial.clearLayers();State.layers.hub.clearLayers();if(hubRad>0){const hubCircle=turf.circle(State.hubCenter,hubRad,{steps:64,units:'meters'});L.geoJSON(hubCircle,{style:{color:'white',weight:2,fillColor:'#1e293b',fillOpacity:0.8,dashArray:'5,5'}}).addTo(State.layers.hub);}const bbox=turf.bbox(State.polygon),maxDist=Math.sqrt((bbox[2]-bbox[0])**2+(bbox[3]-bbox[1])**2)*111320,angleStep=360/sectors;for(let i=0;i<sectors;i++){const angle=startAngle+i*angleStep,endPoint=turf.destination(State.hubCenter,maxDist,angle,{units:'meters'});L.geoJSON(turf.lineString([State.hubCenter,endPoint.geometry.coordinates]),{style:{color:'#4da6ff',weight:1.5,dashArray:'6,6'}}).addTo(State.layers.radial);}},apply(){if(!State.polygon||!State.hubCenter){Toast.show('Coloca el hub','error');return;}Loading.show();const sectors=parseInt($('rad-sectors-n').value)||8,hubRad=parseFloat($('hub-rad-n').value)||0,startAngle=parseFloat($('rad-angle-n').value)||0,angleStep=360/sectors,colors=State.colors[State.theme];const bbox=turf.bbox(State.polygon),maxDist=Math.sqrt((bbox[2]-bbox[0])**2+(bbox[3]-bbox[1])**2)*111320*2;State.blocks=[];for(let i=0;i<sectors;i++){try{let sector=turf.sector(State.hubCenter,maxDist,startAngle+i*angleStep,startAngle+(i+1)*angleStep,{units:'meters',steps:64});if(hubRad>0)sector=turf.difference(sector,turf.circle(State.hubCenter,hubRad,{units:'meters',steps:64}));const clipped=turf.intersect(State.polygon,sector);if(clipped&&clipped.geometry.type==='Polygon')State.blocks.push({uid:'s'+i,id:`S${i+1}`,geo:clipped,area:GeoMath.area(clipped.geometry.coordinates[0]),color:colors[i%colors.length]});}catch(e){}}State.layers.radial.clearLayers();State.layers.hub.clearLayers();HistoryMgr.save('radial');Renderer.render();BotalonMgr.calculate();Loading.hide();Toast.show(`${State.blocks.length} sectores`,'success');},reset(){State.layers.radial.clearLayers();State.layers.hub.clearLayers();if(State.hubMarker){State.hubMarker.remove();State.hubMarker=null;}State.hubCenter=null;$('hub-info').classList.add('hidden');}};

    // ========== RENDERER ==========
    const Renderer={render(){State.layers.result.clearLayers();State.layers.dims.clearLayers();State.layers.verts.clearLayers();State.layers.azimuth.clearLayers();let html='';State.blocks.forEach(b=>{const coords=b.geo.geometry.coordinates[0],perim=GeoMath.perimeter(coords),center=turf.centroid(b.geo),isSelected=State.selectedIds.has(b.uid);const layer=L.geoJSON(b.geo,{style:{color:isSelected?'#06b6d4':'#fff',weight:isSelected?3:2,fillColor:isSelected?'#06b6d4':b.color,fillOpacity:isSelected?0.7:0.5}});layer.on('click',function(e){L.DomEvent.stopPropagation(e);State.mode==='select'?SelectMgr.toggle(b.uid):this.bindPopup(`<b>Lote ${b.id}</b><br>rea: ${(b.area/10000).toFixed(4)} Ha<br>Permetro: ${perim.toFixed(1)} m`).openPopup();});layer.addTo(State.layers.result);this.drawOverlays(b.geo,b.id);html+=`<tr class="${isSelected?'selected':''}" onclick="SelectMgr.toggle('${b.uid}')" style="cursor:pointer;"><td><span class="color-badge" style="background:${b.color}"></span><b>${b.id}</b></td><td>${Math.round(b.area).toLocaleString()}</td><td>${(b.area/10000).toFixed(4)}</td><td>${perim.toFixed(1)}m</td><td style="font-size:9px">${center.geometry.coordinates[1].toFixed(5)}, ${center.geometry.coordinates[0].toFixed(5)}</td></tr>`;});$('data-body').innerHTML=html;if(typeof Potreros!=='undefined'&&State.activePotreroId){Potreros.updateActiveBlocks(State.blocks);}},drawOverlays(geo,lotId){const coords=geo.geometry.coordinates[0];for(let i=0;i<coords.length-1;i++){const p1=coords[i],p2=coords[i+1],dist=GeoMath.vincentyDist(p1[1],p1[0],p2[1],p2[0]),mid=[(p1[0]+p2[0])/2,(p1[1]+p2[1])/2],az=GeoMath.bearing(p1[1],p1[0],p2[1],p2[0]);if(State.showVerts)L.marker([p1[1],p1[0]],{icon:L.divIcon({className:'',html:`<div style="background:#00ffff;color:#000;font-weight:900;font-size:10px;width:20px;height:20px;border-radius:50%;display:flex;align-items:center;justify-content:center;border:2px solid #000;box-shadow:0 2px 6px rgba(0,0,0,0.6);">${i+1}</div>`,iconSize:[20,20],iconAnchor:[10,10]})}).addTo(State.layers.verts);if(State.showDist)L.marker([mid[1],mid[0]],{icon:L.divIcon({className:'',html:`<div style="background:#000;color:#00ff00;font-weight:900;font-size:10px;padding:2px 5px;border-radius:3px;border:2px solid #00ff00;white-space:nowrap;box-shadow:0 2px 4px rgba(0,0,0,0.5);">${dist.toFixed(1)}m</div>`,iconSize:[50,16],iconAnchor:[25,8]})}).addTo(State.layers.dims);if(State.showAz)L.marker([mid[1],mid[0]+0.00005],{icon:L.divIcon({className:'',html:`<div style="background:#ff00ff;color:#fff;font-weight:700;font-size:9px;padding:2px 4px;border-radius:3px;border:1px solid #fff;white-space:nowrap;">${az.toFixed(1)}</div>`,iconSize:[40,14],iconAnchor:[20,7]})}).addTo(State.layers.azimuth);}},toggleVerts(){State.showVerts=$('tog-vert').checked;this.render();},toggleDist(){State.showDist=$('tog-dist').checked;this.render();},toggleAz(){State.showAz=$('tog-az').checked;this.render();},clearAll(){State.blocks=[];State.polygon=null;State.selectedIds.clear();State.drawnItems.clearLayers();Object.keys(State.layers).forEach(k=>{if(k!=='potreros'&&State.layers[k]&&State.layers[k].clearLayers)State.layers[k].clearLayers();});RadialEngine.reset();if(typeof SlicerEngine!=='undefined')SlicerEngine.clearPreview();if(typeof SlopeAnalyzer!=='undefined')SlopeAnalyzer.clear();if(typeof ViewshedAnalysis!=='undefined'&&ViewshedAnalysis.layer)ViewshedAnalysis.layer.clearLayers();if(typeof PathOptimizer!=='undefined'&&PathOptimizer.layer)PathOptimizer.layer.clearLayers();if(typeof ShadowAnalysis3D!=='undefined'&&ShadowAnalysis3D.layer)ShadowAnalysis3D.layer.clearLayers();if(typeof DrainageSimulator!=='undefined'&&DrainageSimulator.layer)DrainageSimulator.layer.clearLayers();if(typeof RiskAnalysis!=='undefined'&&RiskAnalysis.layer)RiskAnalysis.layer.clearLayers();if(typeof RealTimeGPS!=='undefined'&&RealTimeGPS.disconnect)RealTimeGPS.disconnect();$('empty-st').classList.remove('hidden');$('poly-info').classList.add('hidden');$('bot-summary').innerHTML='<p style="color:var(--text-3);font-size:11px;text-align:center;padding:20px;">Crea subdivisiones para calcular botalones</p>';State.botalonData=null;if(typeof Potreros!=='undefined'){Potreros.render();Potreros.updateBadge();}Toast.show('Limpiado','success');}};

    // ========== IMPORT MANAGER ==========
    const ImportMgr={setPolygon(geojson){const cleanGeo=turf.cleanCoords(turf.rewind(geojson));if(typeof Potreros!=='undefined'){if(Potreros.isDrawingMode||State.potreros.length===0){Potreros.addFromPolygon(cleanGeo);return;}else if(State.activePotreroId){const pot=Potreros.getActive();if(pot){pot.geo=cleanGeo;pot.area=GeoMath.area(cleanGeo.geometry.coordinates[0]);Potreros.render();Potreros.renderOnMap();Potreros.updateBadge();}}}State.polygon=cleanGeo;State.drawnItems.clearLayers();const layer=L.geoJSON(State.polygon,{style:{color:'#00a67d',weight:3,fillColor:'#00a67d',fillOpacity:0.2}}).addTo(State.drawnItems);State.map.fitBounds(layer.getBounds());const coords=State.polygon.geometry.coordinates[0],area=GeoMath.area(coords),perim=GeoMath.perimeter(coords);$('total-area').textContent=(area/10000).toFixed(4);$('total-perim').textContent=perim.toFixed(1);$('empty-st').classList.add('hidden');$('poly-info').classList.remove('hidden');this.updateTopoTables(coords);this.drawMainOverlays();GridEngine.preview();HistoryMgr.save('polygon');Toast.show('Polgono cargado','success');},setPolygonSilent(geojson){State.polygon=turf.cleanCoords(turf.rewind(geojson));State.drawnItems.clearLayers();const layer=L.geoJSON(State.polygon,{style:{color:'#00a67d',weight:3,fillColor:'#00a67d',fillOpacity:0.2}}).addTo(State.drawnItems);State.map.fitBounds(layer.getBounds());const coords=State.polygon.geometry.coordinates[0],area=GeoMath.area(coords),perim=GeoMath.perimeter(coords);$('total-area').textContent=(area/10000).toFixed(4);$('total-perim').textContent=perim.toFixed(1);$('empty-st').classList.add('hidden');$('poly-info').classList.remove('hidden');this.updateTopoTables(coords);this.drawMainOverlays();GridEngine.preview();},drawMainOverlays(){if(!State.polygon)return;State.layers.mainVerts.clearLayers();State.layers.mainDims.clearLayers();const coords=State.polygon.geometry.coordinates[0];for(let i=0;i<coords.length-1;i++){const p1=coords[i],p2=coords[i+1];const dist=GeoMath.vincentyDist(p1[1],p1[0],p2[1],p2[0]);const mid=[(p1[0]+p2[0])/2,(p1[1]+p2[1])/2];L.marker([p1[1],p1[0]],{icon:L.divIcon({className:'',html:`<div style="background:#ff0000;color:#fff;font-weight:900;font-size:12px;width:24px;height:24px;border-radius:50%;display:flex;align-items:center;justify-content:center;border:2px solid #fff;box-shadow:0 2px 6px rgba(0,0,0,0.5);">${i+1}</div>`,iconSize:[24,24],iconAnchor:[12,12]})}).addTo(State.layers.mainVerts);L.marker([mid[1],mid[0]],{icon:L.divIcon({className:'',html:`<div style="background:#000;color:#ffff00;font-weight:900;font-size:11px;padding:3px 6px;border-radius:4px;border:2px solid #ffff00;white-space:nowrap;box-shadow:0 2px 6px rgba(0,0,0,0.5);">${dist.toFixed(2)}m</div>`,iconSize:[60,20],iconAnchor:[30,10]})}).addTo(State.layers.mainDims);}},updateTopoTables(coords){let vertHtml='',rumbHtml='';const zone=UTM.getZone(coords[0][0]);for(let i=0;i<coords.length-1;i++){const[lon,lat]=coords[i],utm=UTM.fromLatLon(lon,lat,zone);vertHtml+=`<tr><td>${i+1}</td><td>${lat.toFixed(6)}</td><td>${lon.toFixed(6)}</td><td>${utm[0].toFixed(2)}</td><td>${utm[1].toFixed(2)}</td></tr>`;if(i<coords.length-2){const[lon2,lat2]=coords[i+1],dist=GeoMath.vincentyDist(lat,lon,lat2,lon2),az=GeoMath.bearing(lat,lon,lat2,lon2);rumbHtml+=`<tr><td>${i+1}-${i+2}</td><td>${az.toFixed(2)}</td><td>${GeoMath.azToRumbo(az)}</td><td>${dist.toFixed(2)}m</td></tr>`;}}$('vert-body').innerHTML=vertHtml;$('rumb-body').innerHTML=rumbHtml;},handleKML(input){const file=input.files[0];if(!file)return;const reader=new FileReader();reader.onload=e=>{try{const parser=new DOMParser(),kml=parser.parseFromString(e.target.result,'text/xml'),geojson=toGeoJSON.kml(kml),poly=geojson.features.find(f=>f.geometry.type==='Polygon');if(poly)this.setPolygon(poly);else Toast.show('No se encontr polgono','error');}catch(err){Toast.show('Error al leer KML','error');}};reader.readAsText(file);input.value='';},parseCoords(){const isUTM=$('coords-utm').classList.contains('active');let coords=[];if(isUTM){const zone=$('utm-zone').value;$('utm-txt').value.trim().split('\n').forEach(line=>{const parts=line.split(/[,\s]+/).map(Number);if(parts.length>=2)coords.push(UTM.toLatLon(parts[0],parts[1],zone));});}else{$('coords-txt').value.trim().split('\n').forEach(line=>{const parts=line.split(/[,\s]+/).map(Number);if(parts.length>=2)coords.push([parts[1],parts[0]]);});}if(coords.length<3){Toast.show('Se necesitan al menos 3 puntos','error');return;}if(coords[0][0]!==coords[coords.length-1][0]||coords[0][1]!==coords[coords.length-1][1])coords.push([...coords[0]]);this.setPolygon(turf.polygon([coords]));closePanel('coords');}};

    // ========== SUN ANALYZER ==========
    const SunAnalyzer={update(){const date=new Date($('sun-date').value||Date.now()),mins=parseInt($('sun-time').value);date.setHours(Math.floor(mins/60),mins%60);$('sun-time-disp').textContent=`${String(Math.floor(mins/60)).padStart(2,'0')}:${String(mins%60).padStart(2,'0')}`;if(!State.polygon)return;State.layers.sun.clearLayers();const center=turf.centroid(State.polygon).geometry.coordinates,pos=SunCalc.getPosition(date,center[1],center[0]);if(pos.altitude>0){const d=0.001,lat=center[1]+Math.cos(pos.azimuth)*d*-1,lng=center[0]+Math.sin(pos.azimuth)*d*-1;L.marker([lat,lng],{icon:L.divIcon({html:'<i class="fa-solid fa-sun" style="color:#fbbf24;font-size:28px;filter:drop-shadow(0 0 10px orange);"></i>',className:'',iconSize:[28,28],iconAnchor:[14,14]})}).addTo(State.layers.sun);L.polyline([[lat,lng],[center[1],center[0]]],{color:'#fbbf24',weight:2,dashArray:'6,6'}).addTo(State.layers.sun);}}};

    // ========== TOPO TOOLS ==========
    const TopoTools={exportVert(){const rows=$('vert-body').querySelectorAll('tr');let csv='N,Lat,Lon,UTM_E,UTM_N\n';rows.forEach(row=>{csv+=Array.from(row.querySelectorAll('td')).map(c=>c.textContent).join(',')+'\n';});download(csv,'vertices.csv','text/csv');Toast.show('Vrtices exportados','success');},exportRumb(){const rows=$('rumb-body').querySelectorAll('tr');let csv='Lado,Azimut,Rumbo,Distancia\n';rows.forEach(row=>{csv+=Array.from(row.querySelectorAll('td')).map(c=>c.textContent).join(',')+'\n';});download(csv,'rumbos.csv','text/csv');Toast.show('Rumbos exportados','success');},createBuf(){if(!State.polygon){Toast.show('No hay polgono','error');return;}const dist=parseFloat($('buf-dist').value)||10,type=$('buf-type').value,bufDist=type==='neg'?-dist:dist;try{const buffered=turf.buffer(State.polygon,bufDist,{units:'meters'});State.layers.buffer.clearLayers();L.geoJSON(buffered,{style:{color:'#ffb347',weight:2,fillColor:'#ffb347',fillOpacity:0.3,dashArray:'5,5'}}).addTo(State.layers.buffer);Toast.show('Buffer generado','success');}catch(e){Toast.show('Error','error');}}};

    // ========== PROJECT MANAGER ==========
    const ProjectMgr={save(){if(!State.polygon&&State.blocks.length===0){Toast.show('No hay datos','error');return;}const data={version:'v17',polygon:State.polygon,blocks:State.blocks.map(b=>({id:b.id,geo:b.geo,area:b.area,color:b.color})),settings:{gridAngle:State.gridAngle,spacing:$('bot-spacing').value,theme:State.theme}};download(JSON.stringify(data,null,2),`wintel_${Date.now()}.omega`,'application/json');Toast.show('Proyecto guardado','success');},load(input){const file=input.files[0];if(!file)return;const reader=new FileReader();reader.onload=e=>{try{const data=JSON.parse(e.target.result);if(data.polygon)ImportMgr.setPolygon(data.polygon);if(data.blocks){State.blocks=data.blocks.map(b=>({...b,uid:Math.random().toString(36).substr(2,9)}));Renderer.render();BotalonMgr.calculate();}if(data.settings){if(data.settings.gridAngle!==undefined)GridEngine.updateAngle(data.settings.gridAngle);if(data.settings.spacing)$('bot-spacing').value=data.settings.spacing;if(data.settings.theme&&data.settings.theme!==State.theme){$('theme-tog').checked=data.settings.theme==='pastel';ThemeMgr.toggle();}}Toast.show('Proyecto cargado','success');}catch(err){Toast.show('Error al cargar','error');}};reader.readAsText(file);input.value='';}};

    // ========== EXPORT MANAGER ==========
    const ExportMgr={
        toCSV(){
            if(!State.polygon&&State.blocks.length===0){Toast.show('No hay datos','error');return;}
            let csv='TIPO,ID,Area_m2,Area_Ha,Perimetro_m,Lat,Lon,Vertices\n';
            if(State.polygon){
                const coords=State.polygon.geometry.coordinates[0];
                const area=GeoMath.area(coords),perim=GeoMath.perimeter(coords);
                const center=turf.centroid(State.polygon);
                csv+=`PRINCIPAL,0,${area.toFixed(2)},${(area/10000).toFixed(4)},${perim.toFixed(2)},${center.geometry.coordinates[1].toFixed(6)},${center.geometry.coordinates[0].toFixed(6)},${coords.length-1}\n`;
            }
            State.blocks.forEach(b=>{
                const coords=b.geo.geometry.coordinates[0];
                const perim=GeoMath.perimeter(coords),center=turf.centroid(b.geo);
                csv+=`LOTE,${b.id},${b.area.toFixed(2)},${(b.area/10000).toFixed(4)},${perim.toFixed(2)},${center.geometry.coordinates[1].toFixed(6)},${center.geometry.coordinates[0].toFixed(6)},${coords.length-1}\n`;
            });
            download(csv,'completo_lotes.csv','text/csv');
            Toast.show('CSV exportado','success');
        },
        toGeoJSON(){
            if(!State.polygon&&State.blocks.length===0){Toast.show('No hay datos','error');return;}
            const features=[];
            if(State.polygon){
                const coords=State.polygon.geometry.coordinates[0];
                const area=GeoMath.area(coords),perim=GeoMath.perimeter(coords);
                features.push({type:'Feature',geometry:State.polygon.geometry,properties:{tipo:'PRINCIPAL',id:0,area_m2:area,area_ha:area/10000,perimetro_m:perim}});
            }
            State.blocks.forEach(b=>{
                const perim=GeoMath.perimeter(b.geo.geometry.coordinates[0]);
                features.push({type:'Feature',geometry:b.geo.geometry,properties:{tipo:'LOTE',id:b.id,area_m2:b.area,area_ha:b.area/10000,perimetro_m:perim}});
            });
            const fc={type:'FeatureCollection',name:'WIN-TEL_Export',crs:{type:'name',properties:{name:'EPSG:4326'}},features};
            download(JSON.stringify(fc,null,2),'completo_lotes.geojson','application/json');
            Toast.show('GeoJSON exportado','success');
        },
        toKML(){
            if(!State.polygon&&State.blocks.length===0){Toast.show('No hay datos','error');return;}
            let kml='<?xml version="1.0" encoding="UTF-8"?>\n<kml xmlns="http://www.opengis.net/kml/2.2">\n<Document>\n<name>WIN-TEL Export</name>\n';
            kml+='<Style id="principal"><LineStyle><color>ff00ff00</color><width>3</width></LineStyle><PolyStyle><color>4000ff00</color></PolyStyle></Style>\n';
            kml+='<Style id="lote"><LineStyle><color>ff0000ff</color><width>2</width></LineStyle><PolyStyle><color>600000ff</color></PolyStyle></Style>\n';
            if(State.polygon){
                const coords=State.polygon.geometry.coordinates[0];
                const area=GeoMath.area(coords),perim=GeoMath.perimeter(coords);
                const coordStr=coords.map(c=>c[0]+','+c[1]+',0').join(' ');
                const zone=UTM.getZone(coords[0][0]);
                let desc='POLIGONO PRINCIPAL\\nArea: '+(area/10000).toFixed(4)+' Ha\\nPerimetro: '+perim.toFixed(2)+' m\\n\\nVERTICES:\\n';
                for(let i=0;i<coords.length-1;i++){const[lon,lat]=coords[i];const utm=UTM.fromLatLon(lon,lat,zone);desc+='V'+(i+1)+': '+lat.toFixed(6)+', '+lon.toFixed(6)+' | UTM: '+utm[0].toFixed(2)+'E, '+utm[1].toFixed(2)+'N\\n';}
                desc+='\\nLADOS:\\n';
                for(let i=0;i<coords.length-1;i++){const[lon1,lat1]=coords[i],[lon2,lat2]=coords[(i+1)%coords.length];const dist=GeoMath.vincentyDist(lat1,lon1,lat2,lon2);const az=GeoMath.bearing(lat1,lon1,lat2,lon2);desc+=(i+1)+'-'+(i+2)+': '+dist.toFixed(2)+'m | Az: '+az.toFixed(2)+'\\n';}
                kml+='<Folder><name>PRINCIPAL</name>\n<Placemark>\n<name>Poligono Principal</name>\n<description><![CDATA['+desc+']]></description>\n<styleUrl>#principal</styleUrl>\n<Polygon><outerBoundaryIs><LinearRing><coordinates>'+coordStr+'</coordinates></LinearRing></outerBoundaryIs></Polygon>\n</Placemark>\n</Folder>\n';
            }
            if(State.blocks.length>0){
                kml+='<Folder><name>LOTES ('+State.blocks.length+')</name>\n';
                State.blocks.forEach(b=>{
                    const coords=b.geo.geometry.coordinates[0];
                    const perim=GeoMath.perimeter(coords);
                    const coordStr=coords.map(c=>c[0]+','+c[1]+',0').join(' ');
                    const zone=UTM.getZone(coords[0][0]);
                    let desc='LOTE '+b.id+'\\nArea: '+(b.area/10000).toFixed(4)+' Ha\\nPerimetro: '+perim.toFixed(2)+' m\\n\\nVERTICES:\\n';
                    for(let i=0;i<coords.length-1;i++){const[lon,lat]=coords[i];const utm=UTM.fromLatLon(lon,lat,zone);desc+='V'+(i+1)+': '+lat.toFixed(6)+', '+lon.toFixed(6)+' | UTM: '+utm[0].toFixed(2)+'E, '+utm[1].toFixed(2)+'N\\n';}
                    kml+='<Placemark>\n<name>Lote '+b.id+'</name>\n<description><![CDATA['+desc+']]></description>\n<styleUrl>#lote</styleUrl>\n<Polygon><outerBoundaryIs><LinearRing><coordinates>'+coordStr+'</coordinates></LinearRing></outerBoundaryIs></Polygon>\n</Placemark>\n';
                });
                kml+='</Folder>\n';
            }
            kml+='</Document>\n</kml>';
            download(kml,'completo_lotes.kml','application/vnd.google-earth.kml+xml');
            Toast.show('KML exportado','success');
        },
        toDXF(){
            if(!State.polygon&&State.blocks.length===0){Toast.show('No hay datos','error');return;}
            let dxf='0\nSECTION\n2\nENTITIES\n';
            if(State.polygon){
                const coords=State.polygon.geometry.coordinates[0],zone=UTM.getZone(coords[0][0]);
                dxf+='0\nPOLYLINE\n8\nPRINCIPAL\n62\n3\n66\n1\n70\n1\n';
                coords.forEach(c=>{const utm=UTM.fromLatLon(c[0],c[1],zone);dxf+='0\nVERTEX\n8\nPRINCIPAL\n10\n'+utm[0].toFixed(3)+'\n20\n'+utm[1].toFixed(3)+'\n30\n0\n';});
                dxf+='0\nSEQEND\n';
            }
            State.blocks.forEach(b=>{
                const coords=b.geo.geometry.coordinates[0],zone=UTM.getZone(coords[0][0]);
                dxf+='0\nPOLYLINE\n8\nLOTE_'+b.id+'\n62\n5\n66\n1\n70\n1\n';
                coords.forEach(c=>{const utm=UTM.fromLatLon(c[0],c[1],zone);dxf+='0\nVERTEX\n8\nLOTE_'+b.id+'\n10\n'+utm[0].toFixed(3)+'\n20\n'+utm[1].toFixed(3)+'\n30\n0\n';});
                dxf+='0\nSEQEND\n';
            });
            dxf+='0\nENDSEC\n0\nEOF\n';
            download(dxf,'completo_lotes.dxf','application/dxf');
            Toast.show('DXF exportado','success');
        },
        toPDF(){
            if(!State.polygon&&State.blocks.length===0){Toast.show('No hay datos','error');return;}
            Toast.show('Generando PDF...','warning');
            const{jsPDF}=window.jspdf,doc=new jsPDF();
            doc.setFontSize(18);doc.text('WIN-TEL GEOMATICS PRO v30',20,20);
            doc.setFontSize(12);doc.text('Reporte Completo',20,30);
            doc.text('Fecha: '+new Date().toLocaleDateString(),20,38);
            let y=50;
            if(State.polygon){
                const coords=State.polygon.geometry.coordinates[0];
                const area=GeoMath.area(coords),perim=GeoMath.perimeter(coords);
                doc.setFontSize(14);doc.setTextColor(0,128,0);
                doc.text('POLIGONO PRINCIPAL',20,y);y+=8;
                doc.setFontSize(10);doc.setTextColor(0,0,0);
                doc.text('Area: '+(area/10000).toFixed(4)+' Ha | Perimetro: '+perim.toFixed(2)+' m | Vertices: '+(coords.length-1),25,y);y+=10;
            }
            if(State.blocks.length>0){
                doc.setFontSize(14);doc.setTextColor(0,0,128);
                doc.text('SUBDIVISIONES ('+State.blocks.length+' lotes)',20,y);y+=8;
                doc.setFontSize(10);doc.setTextColor(0,0,0);
                State.blocks.forEach(b=>{
                    if(y>270){doc.addPage();y=20;}
                    const perim=GeoMath.perimeter(b.geo.geometry.coordinates[0]);
                    doc.text('Lote '+b.id+': '+(b.area/10000).toFixed(4)+' Ha | '+perim.toFixed(1)+'m',25,y);y+=6;
                });
            }
            doc.save('reporte_completo.pdf');
            Toast.show('PDF exportado','success');
        },
        toMemorial(){
            if(!State.polygon){Toast.show('No hay polgono','error');return;}
            const coords=State.polygon.geometry.coordinates[0];
            const area=GeoMath.area(coords),perim=GeoMath.perimeter(coords);
            const zone=UTM.getZone(coords[0][0]);
            let text='MEMORIAL DESCRIPTIVO - WIN-TEL GEOMATICS PRO v30\n';
            text+='================================================\n\n';
            text+='Fecha: '+new Date().toLocaleDateString()+'\n';
            text+='Area Total: '+(area/10000).toFixed(4)+' Ha ('+area.toFixed(2)+' m2)\n';
            text+='Perimetro: '+perim.toFixed(2)+' m\n';
            text+='Vertices: '+(coords.length-1)+'\n\n';
            text+='COORDENADAS DE VERTICES\n';
            text+='------------------------\n';
            for(let i=0;i<coords.length-1;i++){
                const[lon,lat]=coords[i];
                const utm=UTM.fromLatLon(lon,lat,zone);
                text+='V'+(i+1)+': Lat '+lat.toFixed(6)+' | Lon '+lon.toFixed(6)+' | UTM '+utm[0].toFixed(2)+'E, '+utm[1].toFixed(2)+'N\n';
            }
            text+='\nDESCRIPCION DE LINDEROS\n';
            text+='------------------------\n';
            for(let i=0;i<coords.length-1;i++){
                const[lon1,lat1]=coords[i],[lon2,lat2]=coords[(i+1)%(coords.length-1)]||coords[0];
                const dist=GeoMath.vincentyDist(lat1,lon1,lat2,lon2);
                const az=GeoMath.bearing(lat1,lon1,lat2,lon2);
                text+='Del vertice '+(i+1)+' al '+((i+2)>coords.length-1?1:(i+2))+':\n';
                text+='  Rumbo: '+GeoMath.azToRumbo(az)+'\n';
                text+='  Azimut: '+az.toFixed(4)+'\n';
                text+='  Distancia: '+dist.toFixed(2)+' m\n\n';
            }
            if(State.blocks.length>0){
                text+='\n================================================\n';
                text+='SUBDIVISIONES ('+State.blocks.length+' LOTES)\n';
                text+='================================================\n\n';
                State.blocks.forEach(b=>{
                    const bcoords=b.geo.geometry.coordinates[0];
                    const bperim=GeoMath.perimeter(bcoords);
                    text+='LOTE '+b.id+'\n';
                    text+='--------\n';
                    text+='Area: '+(b.area/10000).toFixed(4)+' Ha | Perimetro: '+bperim.toFixed(2)+' m\n';
                    for(let i=0;i<bcoords.length-1;i++){
                        const[lon,lat]=bcoords[i];
                        const utm=UTM.fromLatLon(lon,lat,zone);
                        text+='  V'+(i+1)+': '+lat.toFixed(6)+', '+lon.toFixed(6)+' | UTM '+utm[0].toFixed(2)+'E, '+utm[1].toFixed(2)+'N\n';
                    }
                    text+='\n';
                });
            }
            download(text,'memorial_completo.txt','text/plain');
            Toast.show('Memorial exportado','success');
        }
    };

    // ========== MULTILINE ENGINE ==========
    const ML={
        groups:[],drawPoints:[],tempMarkers:[],previewLines:[],drawing:false,lastPoint:null,groupCounter:0,totalLines:0,
        togglePanel(){
            const ex=document.getElementById('ml-panel');
            if(ex){ex.remove();this.cancelDraw();return;}
            const html=`<div id="ml-panel" class="float-panel" style="top:100px;left:380px;width:340px;">
                <div class="panel-hdr"><div class="panel-title"><i class="fa-solid fa-grip-lines"></i> MULTILNEA (PARALELAS)</div><button class="panel-close" onclick="ML.togglePanel()"><i class="fa-solid fa-times"></i></button></div>
                <div class="panel-body">
                    <div style="background:linear-gradient(135deg,rgba(16,185,129,0.2),rgba(34,197,94,0.15));border:1px solid #10b981;border-radius:8px;padding:12px;margin-bottom:15px;">
                        <div style="font-size:11px;color:var(--text-2);line-height:1.6;">
                            <div class="ml-step"><span class="ml-step-num">1</span> Configura cantidad y separacin</div>
                            <div class="ml-step"><span class="ml-step-num">2</span> Haz clic en el punto de INICIO</div>
                            <div class="ml-step"><span class="ml-step-num">3</span> Haz clic en el punto FINAL</div>
                            <div class="ml-step"><span class="ml-step-num">4</span> Se crearn varias lneas paralelas</div>
                        </div>
                    </div>
                    <div class="form-group"><label class="form-label">Cuntas lneas paralelas?</label><input type="number" id="ml-count" class="form-input" value="3" min="2" max="20"></div>
                    <div class="form-group"><label class="form-label">Separacin entre lneas (metros)</label><input type="number" id="ml-spacing" class="form-input" value="100" min="1" step="1"></div>
                    <div class="toggle-row"><div class="toggle-lbl"><i class="fa-solid fa-magnet"></i> Atraer a puntos (Snap)</div><label class="switch"><input type="checkbox" id="ml-snap"><span class="slider"></span></label></div>
                    <div class="toggle-row"><div class="toggle-lbl"><i class="fa-solid fa-ruler-combined"></i> Solo horizontal/vertical</div><label class="switch"><input type="checkbox" id="ml-ortho"><span class="slider"></span></label></div>
                    <button class="btn" id="ml-btn-start" onclick="ML.startDraw()" style="background:linear-gradient(135deg,#10b981,#059669);"><i class="fa-solid fa-pen"></i> INICIAR DIBUJO</button>
                    <button class="btn btn-2" onclick="ML.cancelDraw()"><i class="fa-solid fa-times"></i> CANCELAR</button>
                    <div id="ml-status" style="display:none;margin-top:15px;padding:10px;background:rgba(16,185,129,0.15);border:1px solid #10b981;border-radius:6px;text-align:center;font-size:12px;color:#10b981;"><i class="fa-solid fa-info-circle"></i> <span id="ml-status-text">Haz clic en el punto de INICIO</span></div>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:15px;text-align:center;">
                        <div style="background:var(--bg-glass);padding:8px;border-radius:6px;"><div id="ml-groups" style="font-size:18px;color:var(--primary);font-weight:bold;">0</div><div style="font-size:9px;color:var(--text-2);">GRUPOS</div></div>
                        <div style="background:var(--bg-glass);padding:8px;border-radius:6px;"><div id="ml-lines" style="font-size:18px;color:#10b981;font-weight:bold;">0</div><div style="font-size:9px;color:var(--text-2);">LNEAS</div></div>
                    </div>
                    <div class="section-lbl"><i class="fa-solid fa-download"></i> Exportar</div>
                    <div class="export-grid">
                        <button class="btn btn-2" onclick="ML.exportKML()"><i class="fa-solid fa-earth-americas"></i> KML</button>
                        <button class="btn btn-2" onclick="ML.exportGeoJSON()"><i class="fa-solid fa-globe"></i> GeoJSON</button>
                        <button class="btn btn-2" onclick="ML.exportCSV()"><i class="fa-solid fa-file-csv"></i> CSV</button>
                        <button class="btn btn-danger" onclick="ML.clearAll()"><i class="fa-solid fa-trash"></i> Limpiar</button>
                    </div>
                </div>
            </div>`;
            document.body.insertAdjacentHTML('beforeend',html);
        },
        startDraw(){
            this.cancelDraw();this.drawing=true;this.drawPoints=[];this.lastPoint=null;
            $('ml-btn-start').style.background='#10b981';
            $('ml-status').style.display='block';
            $('ml-status-text').textContent='Paso 1: Haz clic en el punto de INICIO';
            State.map.getContainer().style.cursor='crosshair';
            State.map.on('click',this._onClick,this);
            State.map.on('mousemove',this._onMove,this);
        },
        _onClick(e){
            if(!this.drawing)return;L.DomEvent.stopPropagation(e);
            let point=[e.latlng.lng,e.latlng.lat];
            if($('ml-snap')?.checked){const snapped=this.findSnap(e.latlng);if(snapped)point=snapped;}
            if($('ml-ortho')?.checked&&this.lastPoint){point=this.applyOrtho(this.lastPoint,point);}
            this.lastPoint=point;this.drawPoints.push(point);
            const marker=L.circleMarker([point[1],point[0]],{radius:6,color:'#fff',fillColor:'#10b981',fillOpacity:1,weight:2}).addTo(State.layers.mlTemp);
            this.tempMarkers.push(marker);
            if(this.drawPoints.length===1){$('ml-status-text').textContent='Paso 2: Haz clic en el punto FINAL';}
            else if(this.drawPoints.length===2){this.createMultilines();}
        },
        _onMove(e){
            if(!this.drawing||this.drawPoints.length===0)return;
            let point=[e.latlng.lng,e.latlng.lat];
            if($('ml-ortho')?.checked&&this.lastPoint){point=this.applyOrtho(this.lastPoint,point);}
            this.updatePreview(point);
        },
        updatePreview(endPoint){
            this.previewLines.forEach(l=>State.layers.mlTemp.removeLayer(l));this.previewLines=[];
            if(this.drawPoints.length<1)return;
            const count=parseInt($('ml-count')?.value)||3,spacing=parseFloat($('ml-spacing')?.value)||5,baseCoords=[this.drawPoints[0],endPoint],startOffset=-((count-1)*spacing)/2;
            for(let i=0;i<count;i++){
                const offset=startOffset+(i*spacing);
                let coords;if(offset===0){coords=baseCoords;}else{coords=this.offsetLine(baseCoords,offset);}
                const latLngs=coords.map(c=>[c[1],c[0]]);
                const line=L.polyline(latLngs,{color:'#10b981',weight:2,dashArray:'5, 5',opacity:0.7}).addTo(State.layers.mlTemp);
                this.previewLines.push(line);
            }
        },
        createMultilines(){
            const count=parseInt($('ml-count')?.value)||3,spacing=parseFloat($('ml-spacing')?.value)||5,baseCoords=[...this.drawPoints],startOffset=-((count-1)*spacing)/2,groupId=++this.groupCounter,groupLayers=[];
            for(let i=0;i<count;i++){
                const offset=startOffset+(i*spacing);
                let coords;if(offset===0){coords=baseCoords;}else{coords=this.offsetLine(baseCoords,offset);}
                const latLngs=coords.map(c=>[c[1],c[0]]);
                const layer=L.polyline(latLngs,{color:'#10b981',weight:3,opacity:1}).addTo(State.layers.multilines);
                groupLayers.push({coords:coords,layer:layer});
            }
            this.groups.push({id:groupId,lines:groupLayers,count:count,spacing:spacing});
            this.totalLines+=count;this.updateStats();this.cancelDraw();
            setTimeout(()=>this.startDraw(),100);
        },
        offsetLine(coords,distance){try{const line=turf.lineString(coords),offset=turf.lineOffset(line,distance/1000,{units:'kilometers'});return offset.geometry.coordinates;}catch(e){return coords;}},
        applyOrtho(base,current){const dx=current[0]-base[0],dy=current[1]-base[1];return Math.abs(dx)>Math.abs(dy)?[current[0],base[1]]:[base[0],current[1]];},
        findSnap(latlng){
            const point=[latlng.lng,latlng.lat],tolerance=0.0001;let best=null,bestDist=Infinity;
            if(State.polygon){const coords=State.polygon.geometry.coordinates[0];coords.forEach(c=>{const dist=Math.sqrt(Math.pow(c[0]-point[0],2)+Math.pow(c[1]-point[1],2));if(dist<tolerance&&dist<bestDist){bestDist=dist;best=c;}});}
            this.groups.forEach(g=>{g.lines.forEach(l=>{l.coords.forEach(c=>{const dist=Math.sqrt(Math.pow(c[0]-point[0],2)+Math.pow(c[1]-point[1],2));if(dist<tolerance&&dist<bestDist){bestDist=dist;best=c;}});});});
            return best;
        },
        cancelDraw(){
            this.drawing=false;this.drawPoints=[];this.tempMarkers=[];this.previewLines=[];this.lastPoint=null;
            State.layers.mlTemp?.clearLayers();
            const btn=$('ml-btn-start');if(btn)btn.style.background='';
            const st=$('ml-status');if(st)st.style.display='none';
            State.map?.getContainer()&&(State.map.getContainer().style.cursor='');
            State.map?.off('click',this._onClick,this);State.map?.off('mousemove',this._onMove,this);
        },
        updateStats(){const g=$('ml-groups'),l=$('ml-lines');if(g)g.textContent=this.groups.length;if(l)l.textContent=this.totalLines;},
        clearAll(){if(this.groups.length===0)return;if(!confirm('Eliminar todas las multilneas?'))return;State.layers.multilines?.clearLayers();this.groups=[];this.totalLines=0;this.updateStats();Toast.show('Multilneas eliminadas','success');},
        exportKML(){
            if(this.groups.length===0){Toast.show('No hay multilneas','error');return;}
            let kml='<?xml version="1.0" encoding="UTF-8"?><kml xmlns="http://www.opengis.net/kml/2.2"><Document><n>Multilneas WIN-TEL</n>';
            this.groups.forEach(g=>{g.lines.forEach((l,i)=>{const coords=l.coords.map(c=>`${c[0]},${c[1]},0`).join(' ');kml+=`<Placemark><n>Grupo${g.id}_Linea${i+1}</n><LineString><coordinates>${coords}</coordinates></LineString></Placemark>`;});});
            kml+='</Document></kml>';download(kml,'multilineas_wintel.kml','application/vnd.google-earth.kml+xml');Toast.show('KML exportado','success');
        },
        exportGeoJSON(){
            if(this.groups.length===0){Toast.show('No hay multilneas','error');return;}
            const features=[];
            this.groups.forEach(g=>{g.lines.forEach((l,i)=>{const line=turf.lineString(l.coords),length=turf.length(line,{units:'meters'});features.push({type:'Feature',properties:{grupo:g.id,linea:i+1,total_lineas:g.count,separacion_m:g.spacing,longitud_m:parseFloat(length.toFixed(2))},geometry:{type:'LineString',coordinates:l.coords}});});});
            const fc={type:'FeatureCollection',features:features};download(JSON.stringify(fc,null,2),'multilineas_wintel.geojson','application/json');Toast.show('GeoJSON exportado','success');
        },
        exportCSV(){
            if(this.groups.length===0){Toast.show('No hay multilneas','error');return;}
            let csv='Grupo,Linea,Longitud_m,Separacion_m,Lat_Inicio,Lon_Inicio,Lat_Fin,Lon_Fin\n';
            this.groups.forEach(g=>{g.lines.forEach((l,i)=>{const line=turf.lineString(l.coords),length=turf.length(line,{units:'meters'}),start=l.coords[0],end=l.coords[l.coords.length-1];csv+=`${g.id},${i+1},${length.toFixed(2)},${g.spacing},${start[1].toFixed(6)},${start[0].toFixed(6)},${end[1].toFixed(6)},${end[0].toFixed(6)}\n`;});});
            download(csv,'multilineas_wintel.csv','text/csv');Toast.show('CSV exportado','success');
        }
    };

    // ========== OMEGA SAMPLING ==========
    const OmegaSampling={points:null,layer:null,togglePanel(){const ex=document.getElementById('sampling-panel');if(ex){ex.remove();return;}const html=`<div id="sampling-panel" class="float-panel" style="top:100px;left:380px;width:320px;"><div class="panel-hdr"><div class="panel-title"><i class="fa-solid fa-grip"></i> GRILLA MUESTREO</div><button class="panel-close" onclick="document.getElementById('sampling-panel').remove()"><i class="fa-solid fa-times"></i></button></div><div class="panel-body"><div class="form-group"><label class="form-label">Distancia entre puntos (m)</label><input type="number" id="sample-dist" class="form-input" value="50" min="5" max="500"></div><div class="form-group"><label class="form-label">Tipo de Grilla</label><select id="sample-type" class="form-input"><option value="point">Regular (Cuadrada)</option><option value="hex">Hexagonal</option></select></div><div style="background:var(--bg-glass);padding:12px;border-radius:8px;margin-bottom:12px;text-align:center;"><div style="font-size:10px;color:var(--text-2);">PUNTOS GENERADOS</div><div id="sample-count" style="font-size:28px;font-weight:800;color:var(--success);">0</div></div><button class="btn" onclick="OmegaSampling.generate()"><i class="fa-solid fa-th"></i> GENERAR</button><div style="display:flex;gap:8px;margin-top:10px;"><button class="btn btn-2" style="flex:1;" onclick="OmegaSampling.clear()"><i class="fa-solid fa-eraser"></i> Limpiar</button><button class="btn btn-cyan" style="flex:1;" onclick="OmegaSampling.exportGPX()"><i class="fa-solid fa-download"></i> GPX</button></div></div></div>`;document.body.insertAdjacentHTML('beforeend',html);},generate(){if(!State.polygon)return Toast.show('Dibuja un polgono','error');this.layer=this.layer||L.layerGroup().addTo(State.map);this.layer.clearLayers();const dist=(parseFloat($('sample-dist').value)||50)/1000,type=$('sample-type').value||'point',bbox=turf.bbox(State.polygon);let grid;try{grid=type==='hex'?turf.hexGrid(bbox,dist,{mask:State.polygon,units:'kilometers'}):turf.pointGrid(bbox,dist,{mask:State.polygon,units:'kilometers'});let count=0;const colors=['#f39c12','#e74c3c','#3498db','#2ecc71','#9b59b6'];turf.featureEach(grid,f=>{let coords=f.geometry.type==='Point'?f.geometry.coordinates:turf.centroid(f).geometry.coordinates;if(turf.booleanPointInPolygon(turf.point(coords),State.polygon)){count++;L.circleMarker([coords[1],coords[0]],{radius:5,fillColor:colors[count%colors.length],color:'#fff',weight:2,fillOpacity:0.9}).bindPopup(`<b>Muestra #${count}</b>`).addTo(this.layer);}});$('sample-count').innerText=count;this.points=grid;Toast.show(`${count} puntos generados`,'success');}catch(e){Toast.show('Error','error');}},exportGPX(){if(!this.points)return Toast.show('Genera la grilla','error');let gpx=`<?xml version="1.0" encoding="UTF-8"?>\n<gpx version="1.1" creator="WIN-TEL">\n<metadata><name>Puntos de Muestreo</name><time>${new Date().toISOString()}</time></metadata>\n`;let i=0;turf.featureEach(this.points,f=>{let coords=f.geometry.type==='Point'?f.geometry.coordinates:turf.centroid(f).geometry.coordinates;if(turf.booleanPointInPolygon(turf.point(coords),State.polygon)){i++;gpx+=`<wpt lat="${coords[1].toFixed(8)}" lon="${coords[0].toFixed(8)}"><name>M-${i}</name><sym>Flag</sym></wpt>\n`;}});gpx+=`</gpx>`;download(gpx,`muestreo_${Date.now()}.gpx`,'application/gpx+xml');Toast.show('GPX exportado','success');},clear(){if(this.layer)this.layer.clearLayers();this.points=null;$('sample-count').innerText='0';Toast.show('Grilla eliminada','success');}};

    // ========== EXPORT ENHANCED ==========
    const ExportPlus = {
        downloadGeoJSON() {
            if(!State.polygon) return Toast.show('Sin polgono para exportar', 'error');
            const geojson = {
                type: 'FeatureCollection',
                features: [{
                    type: 'Feature',
                    geometry: State.polygon.geometry || State.polygon,
                    properties: {
                        area_m2: GeoMath.calcArea ? GeoMath.calcArea(State.polygon) : GeoMath.area(State.polygon.geometry ? State.polygon.geometry.coordinates[0] : State.polygon.coordinates[0]),
                        area_ha: ((GeoMath.calcArea ? GeoMath.calcArea(State.polygon) : GeoMath.area(State.polygon.geometry ? State.polygon.geometry.coordinates[0] : State.polygon.coordinates[0])) / 10000).toFixed(4),
                        perimeter_m: GeoMath.calcPerimeter ? GeoMath.calcPerimeter(State.polygon) : GeoMath.perimeter(State.polygon.geometry ? State.polygon.geometry.coordinates[0] : State.polygon.coordinates[0]),
                        timestamp: new Date().toISOString(),
                        source: 'WIN-TEL Geomatics Pro v18'
                    }
                }]
            };
            const blob = new Blob([JSON.stringify(geojson, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `geomatics_${Date.now()}.geojson`;
            a.click();
            URL.revokeObjectURL(url);
            Toast.show('GeoJSON descargado', 'success');
        },

        downloadKML() {
            if(!State.polygon) return Toast.show('Sin polgono para exportar', 'error');
            const coords = (State.polygon.geometry ? State.polygon.geometry.coordinates[0] : State.polygon.coordinates[0]).map(c => `${c[0]},${c[1]},0`).join(' ');
            const area = ((GeoMath.calcArea ? GeoMath.calcArea(State.polygon) : GeoMath.area(State.polygon.geometry ? State.polygon.geometry.coordinates[0] : State.polygon.coordinates[0])) / 10000).toFixed(4);
            const kml = `<?xml version="1.0" encoding="UTF-8"?>
<kml xmlns="http://www.opengis.net/kml/2.2">
<Document>
<name>WIN-TEL Geomatics Export</name>
<Style id="polystyle">
<LineStyle><color>ff00d310</color><width>3</width></LineStyle>
<PolyStyle><color>5500d310</color></PolyStyle>
</Style>
<Placemark>
<name>rea: ${area} Ha</name>
<description>Exportado desde WIN-TEL Geomatics Pro v18</description>
<styleUrl>#polystyle</styleUrl>
<Polygon>
<outerBoundaryIs>
<LinearRing>
<coordinates>${coords}</coordinates>
</LinearRing>
</outerBoundaryIs>
</Polygon>
</Placemark>
</Document>
</kml>`;
            const blob = new Blob([kml], {type: 'application/vnd.google-earth.kml+xml'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `geomatics_${Date.now()}.kml`;
            a.click();
            URL.revokeObjectURL(url);
            Toast.show('KML descargado - Abre en Google Earth', 'success');
        },

        shareURL() {
            if(!State.polygon) return Toast.show('Sin polgono para compartir', 'error');
            try {
                const polyCoords = State.polygon.geometry ? State.polygon.geometry.coordinates[0] : State.polygon.coordinates[0];
                const data = btoa(JSON.stringify(polyCoords.map(c => [
                    parseFloat(c[0].toFixed(6)), 
                    parseFloat(c[1].toFixed(6))
                ])));
                const url = window.location.href.split('#')[0] + '#poly=' + data;
                navigator.clipboard.writeText(url)
                    .then(() => Toast.show('Enlace copiado al portapapeles', 'success'))
                    .catch(() => prompt('Copia este enlace:', url));
            } catch(e) {
                Toast.show('Error al compartir', 'error');
            }
        },

        loadShared() {
            try {
                const hash = window.location.hash;
                if(!hash.includes('#poly=')) return;
                const data = JSON.parse(atob(hash.replace('#poly=', '')));
                if(data && data.length > 0) {
                    const polygon = turf.polygon([data]);
                    ImportMgr.setPolygon(polygon);
                    Toast.show('Polgono compartido cargado', 'success');
                    window.location.hash = '';
                }
            } catch(e) {
                console.error('Error loading shared:', e);
            }
        }
    };

    // ========== REVERSE GEOCODING ==========
    const GeoLocator = {
        marker: null,
        
        async locate(lat, lng) {
            try {
                const res = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lng}&format=json`);
                const data = await res.json();
                return data.display_name || 'Direccin no disponible';
            } catch(e) {
                return 'Error de conexin';
            }
        },

        async show(e) {
            const addr = await this.locate(e.latlng.lat, e.latlng.lng);
            if(this.marker) State.map.removeLayer(this.marker);
            this.marker = L.marker(e.latlng)
                .bindPopup(`
                    <b> Ubicacin</b><br>
                    Lat: ${e.latlng.lat.toFixed(6)}<br>
                    Lng: ${e.latlng.lng.toFixed(6)}<br><br>
                    <b>Direccin:</b><br>${addr}<br><br>
                    <button class="btn" style="margin-top:8px;width:100%;" onclick="navigator.clipboard.writeText('${e.latlng.lat.toFixed(6)},${e.latlng.lng.toFixed(6)}');Toast.show('Coordenadas copiadas','success')">
                         Copiar Coords
                    </button>
                `)
                .addTo(State.map);
            this.marker.openPopup();
        }
    };

    // ========== DARK MODE ==========
    const DarkMode = {
        active: localStorage.getItem('wintel-dark-mode') === 'true',
        
        toggle() {
            this.active = !this.active;
            localStorage.setItem('wintel-dark-mode', this.active);
            const root = document.documentElement;
            
            if(this.active) {
                root.style.setProperty('--bg-dark', '#0a0f1c');
                root.style.setProperty('--bg-sidebar', '#0d1117');
                root.style.setProperty('--text-1', '#e6edf3');
                root.style.setProperty('--text-2', '#8b949e');
                root.style.setProperty('--bg-panel', 'rgba(13,17,23,0.97)');
                root.style.setProperty('--bg-glass', 'rgba(13,17,23,0.85)');
            } else {
                root.style.setProperty('--bg-dark', '#0a0f1c');
                root.style.setProperty('--bg-sidebar', '#151921');
                root.style.setProperty('--text-1', '#ffffff');
                root.style.setProperty('--text-2', '#cbd5e1');
                root.style.setProperty('--bg-panel', 'rgba(20,30,50,0.97)');
                root.style.setProperty('--bg-glass', 'rgba(35,48,68,0.9)');
            }
            
            Toast.show(this.active ? ' Modo oscuro' : ' Modo claro', 'success');
        },
        
        init() {
            if(this.active) {
                this.toggle();
                this.toggle();
            }
        }
    };

    // ========== KEYBOARD SHORTCUTS ==========
    const Shortcuts = {
        help: null,
        
        init() {
            document.addEventListener('keydown', e => {
                if(e.ctrlKey && e.key === 'h') {
                    e.preventDefault();
                    this.showHelp();
                }
                if(e.ctrlKey && e.key === 'e') {
                    e.preventDefault();
                    if(State.polygon) ExportPlus.downloadGeoJSON();
                }
                if(e.ctrlKey && e.key === 'k') {
                    e.preventDefault();
                    if(State.polygon) ExportPlus.downloadKML();
                }
                if(e.ctrlKey && e.key === 'd') {
                    e.preventDefault();
                    DarkMode.toggle();
                }
                if(e.key === 'Escape') {
                    this.hideHelp();
                }
            });
        },
        
        showHelp() {
            if(this.help) {
                this.help.remove();
                this.help = null;
                return;
            }
            
            const html = `
            <div id="shortcuts-panel" style="position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:var(--bg-panel);border:1px solid var(--border);border-radius:12px;padding:24px;z-index:9999;max-width:500px;width:90%;box-shadow:0 25px 50px -12px rgba(0,0,0,0.8);backdrop-filter:blur(20px);">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
                    <h2 style="font-size:18px;font-weight:800;color:var(--primary);margin:0;">
                        <i class="fa-solid fa-keyboard"></i> ATAJOS DE TECLADO
                    </h2>
                    <button onclick="Shortcuts.hideHelp()" style="background:var(--danger);border:none;color:white;width:32px;height:32px;border-radius:6px;cursor:pointer;">
                        <i class="fa-solid fa-times"></i>
                    </button>
                </div>
                <div style="display:grid;gap:12px;">
                    <div class="shortcut-item">
                        <div class="shortcut-keys"><kbd>Ctrl</kbd> + <kbd>Z</kbd></div>
                        <div class="shortcut-desc">Deshacer ltima accin</div>
                    </div>
                    <div class="shortcut-item">
                        <div class="shortcut-keys"><kbd>Ctrl</kbd> + <kbd>Y</kbd></div>
                        <div class="shortcut-desc">Rehacer accin</div>
                    </div>
                    <div class="shortcut-item">
                        <div class="shortcut-keys"><kbd>Ctrl</kbd> + <kbd>E</kbd></div>
                        <div class="shortcut-desc">Exportar GeoJSON</div>
                    </div>
                    <div class="shortcut-item">
                        <div class="shortcut-keys"><kbd>Ctrl</kbd> + <kbd>K</kbd></div>
                        <div class="shortcut-desc">Exportar KML</div>
                    </div>
                    <div class="shortcut-item">
                        <div class="shortcut-keys"><kbd>Ctrl</kbd> + <kbd>D</kbd></div>
                        <div class="shortcut-desc">Cambiar tema oscuro/claro</div>
                    </div>
                    <div class="shortcut-item">
                        <div class="shortcut-keys"><kbd>Ctrl</kbd> + <kbd>H</kbd></div>
                        <div class="shortcut-desc">Mostrar/Ocultar ayuda</div>
                    </div>
                    <div class="shortcut-item">
                        <div class="shortcut-keys"><kbd>Click Derecho</kbd></div>
                        <div class="shortcut-desc">Geocodificacin inversa</div>
                    </div>
                    <div class="shortcut-item">
                        <div class="shortcut-keys"><kbd>Esc</kbd></div>
                        <div class="shortcut-desc">Cerrar ayuda</div>
                    </div>
                </div>
                <div style="margin-top:20px;padding:12px;background:rgba(16,211,147,0.1);border:1px solid var(--primary);border-radius:8px;">
                    <p style="font-size:11px;color:var(--text-2);margin:0;">
                        <i class="fa-solid fa-lightbulb" style="color:var(--primary);margin-right:6px;"></i>
                        <strong>Tip:</strong> Usa <kbd>Ctrl</kbd> + <kbd>H</kbd> para abrir esta ayuda en cualquier momento
                    </p>
                </div>
            </div>`;
            
            document.body.insertAdjacentHTML('beforeend', html);
            this.help = document.getElementById('shortcuts-panel');
        },
        
        hideHelp() {
            if(this.help) {
                this.help.remove();
                this.help = null;
            }
        }
    };

    // ========== TOUR GUIDE ==========
    const TourGuide = {
        steps: [
            {
                target: '.nav-item[data-panel="main"]',
                title: 'Panel Principal',
                text: 'Accede a las herramientas bsicas y configuracin del proyecto',
                position: 'right'
            },
            {
                target: '.nav-item[data-panel="subdiv"]',
                title: 'Subdivisin',
                text: 'Divide terrenos con grillas, biseccin o cortes dinmicos',
                position: 'right'
            },
            {
                target: '.nav-item[data-panel="botalones"]',
                title: 'Botalones',
                text: 'Calcula y exporta puntos de estacado para cercas',
                position: 'right'
            },
            {
                target: '.quick-tools',
                title: 'Herramientas Rpidas',
                text: 'Acceso directo a funciones frecuentes: exportar, compartir, tema y ms',
                position: 'top'
            }
        ],
        current: 0,
        overlay: null,
        
        start() {
            if(localStorage.getItem('wintel-tour-done')) return;
            this.current = 0;
            this.showStep();
        },
        
        showStep() {
            if(this.current >= this.steps.length) {
                this.finish();
                return;
            }
            
            const step = this.steps[this.current];
            const target = document.querySelector(step.target);
            
            if(!target) {
                this.current++;
                this.showStep();
                return;
            }
            
            this.createOverlay(target, step);
        },
        
        createOverlay(target, step) {
            this.removeOverlay();
            
            const rect = target.getBoundingClientRect();
            const overlay = document.createElement('div');
            overlay.id = 'tour-overlay';
            overlay.style.cssText = 'position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.7);z-index:9998;pointer-events:none;';
            
            overlay.innerHTML = `
                <div class="tour-spotlight" style="position:absolute;top:${rect.top-8}px;left:${rect.left-8}px;width:${rect.width+16}px;height:${rect.height+16}px;background:transparent;border:3px solid var(--primary);border-radius:8px;box-shadow:0 0 0 9999px rgba(0,0,0,0.7), 0 0 20px var(--primary);pointer-events:auto;animation:pulse 2s infinite;z-index:9999;"></div>
                <div class="tour-tooltip" id="tour-tooltip" style="position:absolute;background:var(--bg-panel);border:1px solid var(--primary);border-radius:12px;padding:20px;max-width:320px;box-shadow:0 25px 50px -12px rgba(0,0,0,0.8);pointer-events:auto;z-index:10000;backdrop-filter:blur(20px);">
                    <div style="font-weight:800;font-size:14px;color:var(--primary);margin-bottom:8px;">
                        <i class="fa-solid fa-wand-magic-sparkles"></i> ${step.title}
                    </div>
                    <p style="font-size:12px;color:var(--text-2);margin:0 0 16px 0;">${step.text}</p>
                    <div style="display:flex;justify-content:space-between;align-items:center;">
                        <div style="font-size:10px;color:var(--text-3);">Paso ${this.current + 1} de ${this.steps.length}</div>
                        <div style="display:flex;gap:8px;">
                            <button onclick="TourGuide.skip()" class="btn-2" style="padding:6px 12px;font-size:11px;width:auto;">Saltar</button>
                            <button onclick="TourGuide.next()" class="btn" style="padding:6px 16px;font-size:11px;width:auto;">
                                ${this.current === this.steps.length - 1 ? 'Finalizar' : 'Siguiente'}
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(overlay);
            this.overlay = overlay;
            
            setTimeout(() => {
                this.positionTooltip(rect, step.position);
            }, 10);
        },
        
        positionTooltip(rect, position) {
            const tooltip = document.getElementById('tour-tooltip');
            if(!tooltip) return;
            
            const tt = tooltip.getBoundingClientRect();
            let top, left;
            
            if(position === 'right') {
                top = rect.top + rect.height/2 - tt.height/2;
                left = rect.right + 20;
            } else if(position === 'top') {
                top = rect.top - tt.height - 20;
                left = rect.left + rect.width/2 - tt.width/2;
            }
            
            if(top < 10) top = 10;
            if(left < 10) left = 10;
            if(left + tt.width > window.innerWidth - 10) left = window.innerWidth - tt.width - 10;
            
            tooltip.style.top = top + 'px';
            tooltip.style.left = left + 'px';
        },
        
        next() {
            this.current++;
            this.showStep();
        },
        
        skip() {
            this.finish();
        },
        
        finish() {
            this.removeOverlay();
            localStorage.setItem('wintel-tour-done', 'true');
            Toast.show(' Tour completado', 'success');
        },
        
        removeOverlay() {
            if(this.overlay) {
                this.overlay.remove();
                this.overlay = null;
            }
        },
        
        reset() {
            localStorage.removeItem('wintel-tour-done');
            Toast.show('Tour reiniciado - Recargando...', 'success');
        }
    };

    // ========== SMART PARCEL - PARCELACIN INTELIGENTE ==========
    const SmartParcel = {
        layer: null,
        results: [],
        
        togglePanel() {
            const ex = document.getElementById('smartparcel-panel');
            if(ex) { ex.remove(); return; }
            
            const html = `
            <div id="smartparcel-panel" class="float-panel" style="top:80px;right:60px;width:380px;">
                <div class="panel-hdr">
                    <div class="panel-title"><i class="fa-solid fa-vector-square"></i> PARCELACIN INTELIGENTE</div>
                    <button class="panel-close" onclick="SmartParcel.togglePanel()"><i class="fa-solid fa-times"></i></button>
                </div>
                <div class="panel-body">
                    <div class="pro-card">
                        <div class="pro-card-title"><i class="fa-solid fa-wand-magic-sparkles"></i> Subdivisin por rea Objetivo</div>
                        <p style="font-size:10px;color:var(--text-2);margin-bottom:12px;">
                            Genera lotes con rea especfica respetando dimensiones mnimas
                        </p>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">rea objetivo por lote</label>
                        <div class="input-with-unit">
                            <input type="number" class="form-input" id="sp-target-area" value="500" min="50" step="50">
                            <span class="input-unit">m</span>
                        </div>
                    </div>
                    
                    <div class="form-row" style="margin-bottom:12px;">
                        <div class="form-group" style="margin:0">
                            <label class="form-label">Frente mnimo</label>
                            <div class="input-with-unit">
                                <input type="number" class="form-input" id="sp-min-front" value="10" min="5">
                                <span class="input-unit">m</span>
                            </div>
                        </div>
                        <div class="form-group" style="margin:0">
                            <label class="form-label">Fondo mnimo</label>
                            <div class="input-with-unit">
                                <input type="number" class="form-input" id="sp-min-depth" value="20" min="10">
                                <span class="input-unit">m</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Tolerancia de rea</label>
                        <div class="input-with-unit">
                            <input type="number" class="form-input" id="sp-tolerance" value="10" min="1" max="30">
                            <span class="input-unit">%</span>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Orientacin de corte</label>
                        <select class="form-input" id="sp-orientation">
                            <option value="auto">Automtico (mejor aprovechamiento)</option>
                            <option value="ns">Norte-Sur</option>
                            <option value="ew">Este-Oeste</option>
                            <option value="custom">Personalizado</option>
                        </select>
                    </div>
                    
                    <div id="sp-custom-angle" style="display:none;" class="form-group">
                        <label class="form-label">ngulo de corte ()</label>
                        <input type="number" class="form-input" id="sp-angle" value="0" min="0" max="180">
                    </div>
                    
                    <button class="btn btn-purple" onclick="SmartParcel.calculate()" style="margin-bottom:12px;">
                        <i class="fa-solid fa-calculator"></i> CALCULAR PARCELACIN
                    </button>
                    
                    <button class="btn btn-2" onclick="SmartParcel.preview()" style="margin-bottom:16px;">
                        <i class="fa-solid fa-eye"></i> VISTA PREVIA
                    </button>
                    
                    <div id="sp-results"></div>
                    
                    <div id="sp-actions" style="display:none;">
                        <div class="export-grid" style="margin-top:12px;">
                            <button class="btn btn-accent" onclick="SmartParcel.apply()">
                                <i class="fa-solid fa-check"></i> APLICAR
                            </button>
                            <button class="btn btn-2" onclick="SmartParcel.clear()">
                                <i class="fa-solid fa-trash"></i> LIMPIAR
                            </button>
                        </div>
                    </div>
                </div>
            </div>`;
            
            document.body.insertAdjacentHTML('beforeend', html);
            
            $('sp-orientation').addEventListener('change', function() {
                $('sp-custom-angle').style.display = this.value === 'custom' ? 'block' : 'none';
            });
        },
        
        getOptimalAngle() {
            if(!State.polygon) return 0;
            const orientation = $('sp-orientation').value;
            
            if(orientation === 'ns') return 0;
            if(orientation === 'ew') return 90;
            if(orientation === 'custom') return parseFloat($('sp-angle').value) || 0;
            
            // Auto: calcular mejor orientacin basada en el bbox
            const bbox = turf.bbox(State.polygon);
            const width = Math.abs(bbox[2] - bbox[0]);
            const height = Math.abs(bbox[3] - bbox[1]);
            
            // Si es ms ancho que alto, cortar verticalmente (0), sino horizontalmente (90)
            return width > height ? 0 : 90;
        },
        
        preview() {
            if(!State.polygon) {
                Toast.show('Dibuja un polgono primero', 'error');
                return;
            }
            
            this.layer = this.layer || L.layerGroup().addTo(State.map);
            this.layer.clearLayers();
            
            const targetArea = parseFloat($('sp-target-area').value) || 500;
            const angle = this.getOptimalAngle();
            
            // Mostrar lneas de corte previas
            const poly = State.polygon;
            const bbox = turf.bbox(poly);
            const center = turf.centroid(poly);
            const totalArea = GeoMath.area(poly.geometry.coordinates[0]);
            const numLots = Math.floor(totalArea / targetArea);
            
            // Calcular lneas de corte aproximadas
            const rotated = turf.transformRotate(poly, -angle, {pivot: center});
            const rotBbox = turf.bbox(rotated);
            const height = rotBbox[3] - rotBbox[1];
            const step = height / numLots;
            
            for(let i = 1; i < numLots; i++) {
                const y = rotBbox[1] + (step * i);
                let line = turf.lineString([[rotBbox[0] - 0.001, y], [rotBbox[2] + 0.001, y]]);
                line = turf.transformRotate(line, angle, {pivot: center});
                
                L.geoJSON(line, {
                    style: { color: '#f472b6', weight: 2, dashArray: '8,6', opacity: 0.8 }
                }).addTo(this.layer);
            }
            
            Toast.show(`Vista previa: ~${numLots} lotes de ${targetArea}m`, 'success');
        },
        
        calculate() {
            if(!State.polygon) {
                Toast.show('Dibuja un polgono primero', 'error');
                return;
            }
            
            Loading.show();
            this.layer = this.layer || L.layerGroup().addTo(State.map);
            this.layer.clearLayers();
            this.results = [];
            
            const targetArea = parseFloat($('sp-target-area').value) || 500;
            const minFront = parseFloat($('sp-min-front').value) || 10;
            const minDepth = parseFloat($('sp-min-depth').value) || 20;
            const tolerance = parseFloat($('sp-tolerance').value) / 100 || 0.1;
            const angle = this.getOptimalAngle();
            
            const poly = State.polygon;
            const center = turf.centroid(poly);
            const totalArea = GeoMath.area(poly.geometry.coordinates[0]);
            
            // Rotar polgono para trabajar en coordenadas alineadas
            const rotated = turf.transformRotate(poly, -angle, {pivot: center});
            const bbox = turf.bbox(rotated);
            
            // Calcular dimensiones aproximadas
            const polyWidth = (bbox[2] - bbox[0]) * 111320; // aprox metros
            const polyHeight = (bbox[3] - bbox[1]) * 111320;
            
            // Calcular nmero ptimo de lotes
            const targetInDegrees = targetArea / (111320 * 111320);
            let remaining = rotated;
            let lotNum = 1;
            const colors = ['#f472b6', '#a78bfa', '#60a5fa', '#34d399', '#fbbf24', '#fb923c'];
            
            try {
                while(remaining && lotNum <= 50) {
                    const remArea = turf.area(remaining);
                    
                    if(remArea < targetArea * (1 - tolerance)) {
                        // rea restante muy pequea, aadir al ltimo lote o crear remanente
                        if(this.results.length > 0) {
                            break;
                        }
                    }
                    
                    const remBbox = turf.bbox(remaining);
                    const cutY = remBbox[1] + (targetArea / (111320 * Math.abs(remBbox[2] - remBbox[0]) * 111320));
                    
                    if(cutY >= remBbox[3]) {
                        // Todo lo que queda es el ltimo lote
                        const lotArea = turf.area(remaining);
                        const lotGeo = turf.transformRotate(remaining, angle, {pivot: center});
                        
                        this.results.push({
                            id: lotNum,
                            geo: lotGeo,
                            area: lotArea,
                            status: this.validateLot(lotArea, targetArea, tolerance, minFront, minDepth),
                            color: colors[(lotNum - 1) % colors.length]
                        });
                        break;
                    }
                    
                    // Crear lnea de corte
                    const cutLine = turf.lineString([
                        [remBbox[0] - 0.001, cutY],
                        [remBbox[2] + 0.001, cutY]
                    ]);
                    
                    const splitResult = turf.lineSplit(turf.polygonToLine(remaining), cutLine);
                    
                    if(splitResult.features.length < 2) {
                        // No se pudo dividir, usar mtodo alternativo
                        const bufferedLine = turf.buffer(cutLine, 0.00001, {units: 'degrees'});
                        const diff = turf.difference(remaining, bufferedLine);
                        
                        if(diff && diff.geometry.type === 'MultiPolygon') {
                            const parts = diff.geometry.coordinates.map(c => turf.polygon(c));
                            const sorted = parts.sort((a, b) => turf.bbox(a)[1] - turf.bbox(b)[1]);
                            
                            const lotGeo = turf.transformRotate(sorted[0], angle, {pivot: center});
                            const lotArea = turf.area(sorted[0]);
                            
                            this.results.push({
                                id: lotNum,
                                geo: lotGeo,
                                area: lotArea,
                                status: this.validateLot(lotArea, targetArea, tolerance, minFront, minDepth),
                                color: colors[(lotNum - 1) % colors.length]
                            });
                            
                            remaining = sorted.length > 1 ? turf.union(...sorted.slice(1)) : null;
                            lotNum++;
                        } else {
                            break;
                        }
                    } else {
                        break;
                    }
                }
            } catch(e) {
                console.error('SmartParcel error:', e);
            }
            
            // Si no se generaron lotes con el mtodo avanzado, usar grilla simple
            if(this.results.length === 0) {
                this.fallbackGridMethod(targetArea, minFront, angle, tolerance, colors);
            }
            
            this.displayResults();
            Loading.hide();
        },
        
        fallbackGridMethod(targetArea, minFront, angle, tolerance, colors) {
            const poly = State.polygon;
            const center = turf.centroid(poly);
            const totalArea = GeoMath.area(poly.geometry.coordinates[0]);
            const numLots = Math.max(1, Math.round(totalArea / targetArea));
            
            // Usar subdivisin por grilla
            const rotated = turf.transformRotate(poly, -angle, {pivot: center});
            const bbox = turf.bbox(rotated);
            
            const cols = Math.ceil(Math.sqrt(numLots * (bbox[2] - bbox[0]) / (bbox[3] - bbox[1])));
            const rows = Math.ceil(numLots / cols);
            
            const cellW = (bbox[2] - bbox[0]) / cols;
            const cellH = (bbox[3] - bbox[1]) / rows;
            
            let lotNum = 1;
            
            for(let r = 0; r < rows; r++) {
                for(let c = 0; c < cols; c++) {
                    const x1 = bbox[0] + c * cellW;
                    const y1 = bbox[1] + r * cellH;
                    const x2 = x1 + cellW;
                    const y2 = y1 + cellH;
                    
                    let cell = turf.polygon([[[x1,y1],[x2,y1],[x2,y2],[x1,y2],[x1,y1]]]);
                    cell = turf.transformRotate(cell, angle, {pivot: center});
                    
                    try {
                        const inter = turf.intersect(poly, cell);
                        if(inter && inter.geometry.type === 'Polygon') {
                            const lotArea = turf.area(inter);
                            if(lotArea > 10) {
                                this.results.push({
                                    id: lotNum,
                                    geo: inter,
                                    area: lotArea,
                                    status: this.validateLot(lotArea, targetArea, tolerance, minFront, 0),
                                    color: colors[(lotNum - 1) % colors.length]
                                });
                                lotNum++;
                            }
                        }
                    } catch(e) {}
                }
            }
        },
        
        validateLot(area, target, tolerance, minFront, minDepth) {
            const minArea = target * (1 - tolerance);
            const maxArea = target * (1 + tolerance);
            
            if(area >= minArea && area <= maxArea) return 'ok';
            if(area < minArea * 0.7) return 'error';
            return 'warn';
        },
        
        displayResults() {
            // Mostrar en mapa
            this.results.forEach(lot => {
                L.geoJSON(lot.geo, {
                    style: {
                        color: lot.color,
                        weight: 2,
                        fillColor: lot.color,
                        fillOpacity: 0.4
                    }
                }).bindPopup(`<b>Lote ${lot.id}</b><br>rea: ${lot.area.toFixed(1)} m`)
                  .addTo(this.layer);
            });
            
            // Mostrar en panel
            const totalArea = this.results.reduce((sum, l) => sum + l.area, 0);
            const avgArea = totalArea / this.results.length;
            const okCount = this.results.filter(l => l.status === 'ok').length;
            
            let html = `
                <div class="summary-box" style="background:linear-gradient(135deg,rgba(244,114,182,0.2),rgba(167,139,250,0.15));border-color:#f472b6;">
                    <div class="summary-grid">
                        <div class="summary-item">
                            <div class="summary-val" style="color:#f472b6;">${this.results.length}</div>
                            <div class="summary-lbl">Lotes Generados</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-val" style="color:#a78bfa;">${avgArea.toFixed(0)}m</div>
                            <div class="summary-lbl">rea Promedio</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-val" style="color:#34d399;">${okCount}</div>
                            <div class="summary-lbl">Cumplen Objetivo</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-val" style="color:#60a5fa;">${((okCount/this.results.length)*100).toFixed(0)}%</div>
                            <div class="summary-lbl">Eficiencia</div>
                        </div>
                    </div>
                </div>
                <div style="font-size:10px;color:var(--text-2);font-weight:700;margin-bottom:8px;">DETALLE DE LOTES</div>
            `;
            
            this.results.forEach(lot => {
                html += `
                    <div class="smart-lot">
                        <div class="smart-lot-info">
                            <div class="smart-lot-area">${lot.area.toFixed(1)} m</div>
                            <div class="smart-lot-dims">Lote #${lot.id}</div>
                        </div>
                        <span class="smart-lot-status status-${lot.status}">
                            ${lot.status === 'ok' ? ' PTIMO' : lot.status === 'warn' ? ' AJUSTAR' : ' REVISAR'}
                        </span>
                    </div>
                `;
            });
            
            $('sp-results').innerHTML = html;
            $('sp-actions').style.display = 'block';
            
            Toast.show(`${this.results.length} lotes generados`, 'success');
        },
        
        apply() {
            if(this.results.length === 0) return;
            
            State.blocks = this.results.map((lot, idx) => ({
                uid: Math.random().toString(36).substr(2, 9),
                id: lot.id,
                geo: lot.geo,
                area: lot.area,
                color: lot.color
            }));
            
            State.selectedIds.clear();
            HistoryMgr.save('smartparcel');
            Renderer.render();
            BotalonMgr.calculate();
            
            this.layer.clearLayers();
            Toast.show('Parcelacin aplicada', 'success');
        },
        
        clear() {
            if(this.layer) this.layer.clearLayers();
            this.results = [];
            $('sp-results').innerHTML = '';
            $('sp-actions').style.display = 'none';
        }
    };

    // ========== SETBACK CALCULATOR - RETIROS Y REA CONSTRUIBLE ==========
    const SetbackCalc = {
        layer: null,
        buildableArea: null,
        
        togglePanel() {
            const ex = document.getElementById('setback-panel');
            if(ex) { ex.remove(); this.clear(); return; }
            
            const html = `
            <div id="setback-panel" class="float-panel" style="top:80px;right:60px;width:360px;">
                <div class="panel-hdr">
                    <div class="panel-title"><i class="fa-solid fa-border-none"></i> RETIROS Y REA CONSTRUIBLE</div>
                    <button class="panel-close" onclick="SetbackCalc.togglePanel()"><i class="fa-solid fa-times"></i></button>
                </div>
                <div class="panel-body">
                    <div class="pro-card">
                        <div class="pro-card-title"><i class="fa-solid fa-ruler-combined"></i> Definir Retiros</div>
                        <p style="font-size:10px;color:var(--text-2);margin-bottom:10px;">
                            Calcula el rea til segn normativa municipal
                        </p>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Retiro Frontal (lado 1)</label>
                        <div class="input-with-unit">
                            <input type="number" class="form-input" id="sb-front" value="5" min="0" step="0.5" onchange="SetbackCalc.preview()">
                            <span class="input-unit">m</span>
                        </div>
                    </div>
                    
                    <div class="form-row" style="margin-bottom:12px;">
                        <div class="form-group" style="margin:0">
                            <label class="form-label">Retiro Lateral Izq.</label>
                            <div class="input-with-unit">
                                <input type="number" class="form-input" id="sb-left" value="3" min="0" step="0.5" onchange="SetbackCalc.preview()">
                                <span class="input-unit">m</span>
                            </div>
                        </div>
                        <div class="form-group" style="margin:0">
                            <label class="form-label">Retiro Lateral Der.</label>
                            <div class="input-with-unit">
                                <input type="number" class="form-input" id="sb-right" value="3" min="0" step="0.5" onchange="SetbackCalc.preview()">
                                <span class="input-unit">m</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Retiro Posterior (fondo)</label>
                        <div class="input-with-unit">
                            <input type="number" class="form-input" id="sb-back" value="4" min="0" step="0.5" onchange="SetbackCalc.preview()">
                            <span class="input-unit">m</span>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Modo de clculo</label>
                        <select class="form-input" id="sb-mode" onchange="SetbackCalc.preview()">
                            <option value="uniform">Buffer uniforme</option>
                            <option value="sides">Por lados especficos</option>
                        </select>
                    </div>
                    
                    <button class="btn btn-warning" onclick="SetbackCalc.calculate()" style="margin-bottom:16px;">
                        <i class="fa-solid fa-calculator"></i> CALCULAR REA CONSTRUIBLE
                    </button>
                    
                    <div id="sb-results"></div>
                    
                    <div id="sb-actions" style="display:none;margin-top:12px;">
                        <div class="export-grid">
                            <button class="btn btn-accent" onclick="SetbackCalc.exportReport()">
                                <i class="fa-solid fa-file-pdf"></i> REPORTE
                            </button>
                            <button class="btn btn-2" onclick="SetbackCalc.createAsPolygon()">
                                <i class="fa-solid fa-draw-polygon"></i> CREAR POLGONO
                            </button>
                        </div>
                    </div>
                </div>
            </div>`;
            
            document.body.insertAdjacentHTML('beforeend', html);
        },
        
        preview() {
            if(!State.polygon && State.blocks.length === 0) return;
            
            this.layer = this.layer || L.layerGroup().addTo(State.map);
            this.layer.clearLayers();
            
            const target = State.blocks.length > 0 ? State.blocks[0].geo : State.polygon;
            const mode = $('sb-mode').value;
            
            if(mode === 'uniform') {
                const avgSetback = (
                    parseFloat($('sb-front').value) +
                    parseFloat($('sb-left').value) +
                    parseFloat($('sb-right').value) +
                    parseFloat($('sb-back').value)
                ) / 4;
                
                try {
                    const buffered = turf.buffer(target, -avgSetback, {units: 'meters'});
                    if(buffered) {
                        L.geoJSON(buffered, {
                            style: {
                                color: '#fbbf24',
                                weight: 2,
                                dashArray: '6,4',
                                fillColor: '#fbbf24',
                                fillOpacity: 0.2
                            }
                        }).addTo(this.layer);
                    }
                } catch(e) {}
            }
        },
        
        calculate() {
            if(!State.polygon && State.blocks.length === 0) {
                Toast.show('Dibuja un polgono o crea lotes primero', 'error');
                return;
            }
            
            Loading.show();
            this.layer = this.layer || L.layerGroup().addTo(State.map);
            this.layer.clearLayers();
            
            const target = State.blocks.length > 0 ? State.blocks[0].geo : State.polygon;
            const front = parseFloat($('sb-front').value) || 0;
            const left = parseFloat($('sb-left').value) || 0;
            const right = parseFloat($('sb-right').value) || 0;
            const back = parseFloat($('sb-back').value) || 0;
            const mode = $('sb-mode').value;
            
            const grossArea = turf.area(target);
            let buildable = null;
            
            try {
                if(mode === 'uniform') {
                    // Buffer promedio
                    const avgSetback = (front + left + right + back) / 4;
                    buildable = turf.buffer(target, -avgSetback, {units: 'meters'});
                } else {
                    // Aproximacin por lados - buffer escalonado
                    const maxSetback = Math.max(front, left, right, back);
                    buildable = turf.buffer(target, -maxSetback, {units: 'meters'});
                    
                    // Ajustar con buffers adicionales si es necesario
                    if(buildable) {
                        const minSetback = Math.min(front, left, right, back);
                        if(maxSetback > minSetback) {
                            // Expandir ligeramente para compensar
                            const adjustment = (maxSetback - minSetback) / 4;
                            buildable = turf.buffer(buildable, adjustment, {units: 'meters'});
                        }
                    }
                }
                
                if(!buildable || turf.area(buildable) <= 0) {
                    Toast.show('Retiros exceden el rea disponible', 'error');
                    Loading.hide();
                    return;
                }
                
                this.buildableArea = buildable;
                const netArea = turf.area(buildable);
                const setbackArea = grossArea - netArea;
                const utilization = (netArea / grossArea) * 100;
                
                // Visualizar
                L.geoJSON(target, {
                    style: {
                        color: '#94a3b8',
                        weight: 2,
                        fillColor: '#ef4444',
                        fillOpacity: 0.15
                    }
                }).addTo(this.layer);
                
                L.geoJSON(buildable, {
                    style: {
                        color: '#10d393',
                        weight: 3,
                        fillColor: '#10d393',
                        fillOpacity: 0.35
                    }
                }).bindPopup(`<b>REA CONSTRUIBLE</b><br>${netArea.toFixed(1)} m`).addTo(this.layer);
                
                // Mostrar resultados
                const html = `
                    <div class="summary-box" style="background:linear-gradient(135deg,rgba(251,191,36,0.2),rgba(16,211,147,0.15));border-color:var(--warning);">
                        <div class="summary-grid">
                            <div class="summary-item">
                                <div class="summary-val warning">${grossArea.toFixed(1)}</div>
                                <div class="summary-lbl">rea Bruta (m)</div>
                            </div>
                            <div class="summary-item">
                                <div class="summary-val success">${netArea.toFixed(1)}</div>
                                <div class="summary-lbl">rea Construible (m)</div>
                            </div>
                            <div class="summary-item">
                                <div class="summary-val danger">${setbackArea.toFixed(1)}</div>
                                <div class="summary-lbl">rea Retiros (m)</div>
                            </div>
                            <div class="summary-item">
                                <div class="summary-val accent">${utilization.toFixed(1)}%</div>
                                <div class="summary-lbl">Aprovechamiento</div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="background:var(--bg-glass);border:1px solid var(--border);border-radius:8px;padding:12px;margin-top:8px;">
                        <div style="font-size:10px;color:var(--text-2);font-weight:700;margin-bottom:8px;">RETIROS APLICADOS</div>
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;font-size:11px;">
                            <div><span style="color:var(--text-3);">Frontal:</span> <b>${front}m</b></div>
                            <div><span style="color:var(--text-3);">Posterior:</span> <b>${back}m</b></div>
                            <div><span style="color:var(--text-3);">Lat. Izq:</span> <b>${left}m</b></div>
                            <div><span style="color:var(--text-3);">Lat. Der:</span> <b>${right}m</b></div>
                        </div>
                    </div>
                    
                    <div style="background:rgba(16,211,147,0.1);border:1px solid var(--primary);border-radius:8px;padding:10px;margin-top:10px;">
                        <div style="display:flex;align-items:center;gap:8px;">
                            <i class="fa-solid fa-circle-info" style="color:var(--primary);"></i>
                            <span style="font-size:10px;color:var(--text-2);">
                                <span style="color:#ef4444;"></span> Zona de retiros &nbsp;
                                <span style="color:#10d393;"></span> rea construible
                            </span>
                        </div>
                    </div>
                `;
                
                $('sb-results').innerHTML = html;
                $('sb-actions').style.display = 'block';
                
                Toast.show(`rea construible: ${netArea.toFixed(1)} m`, 'success');
                
            } catch(e) {
                console.error('SetbackCalc error:', e);
                Toast.show('Error en el clculo', 'error');
            }
            
            Loading.hide();
        },
        
        createAsPolygon() {
            if(!this.buildableArea) return;
            
            ImportMgr.setPolygon(this.buildableArea);
            Toast.show('rea construible establecida como polgono activo', 'success');
        },
        
        exportReport() {
            if(!this.buildableArea) return;
            
            const target = State.blocks.length > 0 ? State.blocks[0].geo : State.polygon;
            const grossArea = turf.area(target);
            const netArea = turf.area(this.buildableArea);
            
            let report = `INFORME DE RETIROS Y REA CONSTRUIBLE
=====================================
Fecha: ${new Date().toLocaleString()}
Generado por: WIN-TEL Geomatics Pro v19

DATOS DEL TERRENO
-----------------
rea Bruta: ${grossArea.toFixed(2)} m (${(grossArea/10000).toFixed(4)} Ha)

RETIROS APLICADOS
-----------------
Retiro Frontal: ${$('sb-front').value} m
Retiro Posterior: ${$('sb-back').value} m
Retiro Lateral Izquierdo: ${$('sb-left').value} m
Retiro Lateral Derecho: ${$('sb-right').value} m

RESULTADOS
----------
rea Construible: ${netArea.toFixed(2)} m (${(netArea/10000).toFixed(4)} Ha)
rea en Retiros: ${(grossArea - netArea).toFixed(2)} m
Coeficiente de Aprovechamiento: ${((netArea/grossArea)*100).toFixed(2)}%

COORDENADAS DEL REA CONSTRUIBLE
--------------------------------
`;
            
            const coords = this.buildableArea.geometry.coordinates[0];
            coords.forEach((c, i) => {
                report += `V${i+1}: ${c[1].toFixed(6)}, ${c[0].toFixed(6)}\n`;
            });
            
            download(report, 'informe_retiros.txt', 'text/plain');
            Toast.show('Informe exportado', 'success');
        },
        
        clear() {
            if(this.layer) this.layer.clearLayers();
            this.buildableArea = null;
        }
    };

    // ========== ELEVATION PROFILE - PERFIL DE ELEVACIN ==========
    const ElevationPro = {
        layer: null,
        elevationData: null,
        chart: null,
        
        togglePanel() {
            const ex = document.getElementById('elevation-panel');
            if(ex) { ex.remove(); this.clear(); return; }
            
            const html = `
            <div id="elevation-panel" class="float-panel" style="top:80px;right:60px;width:400px;">
                <div class="panel-hdr">
                    <div class="panel-title"><i class="fa-solid fa-mountain-sun"></i> PERFIL DE ELEVACIN</div>
                    <button class="panel-close" onclick="ElevationPro.togglePanel()"><i class="fa-solid fa-times"></i></button>
                </div>
                <div class="panel-body">
                    <div class="pro-card">
                        <div class="pro-card-title"><i class="fa-solid fa-chart-area"></i> Anlisis Topogrfico</div>
                        <p style="font-size:10px;color:var(--text-2);margin-bottom:10px;">
                            Obtiene elevaciones del terreno va Open-Elevation API
                        </p>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Resolucin de muestreo</label>
                        <select class="form-input" id="elev-resolution">
                            <option value="10">Alta (cada 10m) - ms preciso</option>
                            <option value="25" selected>Media (cada 25m) - balanceado</option>
                            <option value="50">Baja (cada 50m) - ms rpido</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Tipo de anlisis</label>
                        <select class="form-input" id="elev-type">
                            <option value="perimeter">Permetro del polgono</option>
                            <option value="diagonal">Diagonal principal</option>
                            <option value="grid">Grilla interior</option>
                        </select>
                    </div>
                    
                    <button class="btn btn-cyan" onclick="ElevationPro.analyze()" style="margin-bottom:16px;">
                        <i class="fa-solid fa-wave-square"></i> OBTENER ELEVACIONES
                    </button>
                    
                    <div id="elev-chart-container" style="display:none;">
                        <div style="font-size:10px;color:var(--text-2);font-weight:700;margin-bottom:8px;">PERFIL DE ELEVACIN</div>
                        <canvas id="elev-chart" class="elevation-chart"></canvas>
                    </div>
                    
                    <div id="elev-results"></div>
                    
                    <div id="elev-actions" style="display:none;margin-top:12px;">
                        <div class="export-grid">
                            <button class="btn btn-accent" onclick="ElevationPro.exportCSV()">
                                <i class="fa-solid fa-file-csv"></i> EXPORTAR CSV
                            </button>
                            <button class="btn btn-2" onclick="ElevationPro.showContours()">
                                <i class="fa-solid fa-layer-group"></i> CURVAS NIVEL
                            </button>
                        </div>
                    </div>
                </div>
            </div>`;
            
            document.body.insertAdjacentHTML('beforeend', html);
        },
        
        async analyze() {
            if(!State.polygon && State.blocks.length === 0) {
                Toast.show('Dibuja un polgono primero', 'error');
                return;
            }
            
            Loading.show();
            Toast.show('Consultando elevaciones...', 'warning');
            
            this.layer = this.layer || L.layerGroup().addTo(State.map);
            this.layer.clearLayers();
            
            const target = State.blocks.length > 0 ? State.blocks[0].geo : State.polygon;
            const resolution = parseInt($('elev-resolution').value) || 25;
            const type = $('elev-type').value;
            
            let samplePoints = [];
            
            try {
                if(type === 'perimeter') {
                    samplePoints = this.samplePerimeter(target, resolution);
                } else if(type === 'diagonal') {
                    samplePoints = this.sampleDiagonal(target, resolution);
                } else {
                    samplePoints = this.sampleGrid(target, resolution);
                }
                
                if(samplePoints.length === 0) {
                    Toast.show('No se pudieron generar puntos de muestreo', 'error');
                    Loading.hide();
                    return;
                }
                
                // Limitar a 100 puntos para la API
                if(samplePoints.length > 100) {
                    const step = Math.ceil(samplePoints.length / 100);
                    samplePoints = samplePoints.filter((_, i) => i % step === 0);
                }
                
                // Consultar API de elevacin
                const elevations = await this.fetchElevations(samplePoints);
                
                if(!elevations || elevations.length === 0) {
                    Toast.show('No se pudieron obtener elevaciones', 'error');
                    Loading.hide();
                    return;
                }
                
                this.elevationData = elevations;
                this.displayResults(elevations, type);
                this.drawChart(elevations);
                this.showOnMap(elevations);
                
            } catch(e) {
                console.error('Elevation error:', e);
                Toast.show('Error al obtener elevaciones', 'error');
            }
            
            Loading.hide();
        },
        
        samplePerimeter(polygon, resolution) {
            const coords = polygon.geometry.coordinates[0];
            const points = [];
            
            for(let i = 0; i < coords.length - 1; i++) {
                const p1 = coords[i];
                const p2 = coords[i + 1];
                const dist = GeoMath.vincentyDist(p1[1], p1[0], p2[1], p2[0]);
                const steps = Math.max(1, Math.floor(dist / resolution));
                
                for(let j = 0; j <= steps; j++) {
                    const ratio = j / steps;
                    points.push({
                        lat: p1[1] + (p2[1] - p1[1]) * ratio,
                        lon: p1[0] + (p2[0] - p1[0]) * ratio,
                        dist: points.length * resolution
                    });
                }
            }
            
            return points;
        },
        
        sampleDiagonal(polygon, resolution) {
            const bbox = turf.bbox(polygon);
            const points = [];
            
            const p1 = [bbox[0], bbox[1]];
            const p2 = [bbox[2], bbox[3]];
            const dist = GeoMath.vincentyDist(p1[1], p1[0], p2[1], p2[0]);
            const steps = Math.max(1, Math.floor(dist / resolution));
            
            for(let i = 0; i <= steps; i++) {
                const ratio = i / steps;
                const point = {
                    lat: p1[1] + (p2[1] - p1[1]) * ratio,
                    lon: p1[0] + (p2[0] - p1[0]) * ratio,
                    dist: i * resolution
                };
                
                // Verificar si est dentro del polgono
                if(turf.booleanPointInPolygon([point.lon, point.lat], polygon)) {
                    points.push(point);
                }
            }
            
            return points;
        },
        
        sampleGrid(polygon, resolution) {
            const bbox = turf.bbox(polygon);
            const points = [];
            
            const latStep = resolution / 111320;
            const lonStep = resolution / (111320 * Math.cos(((bbox[1] + bbox[3]) / 2) * Math.PI / 180));
            
            let dist = 0;
            for(let lat = bbox[1]; lat <= bbox[3]; lat += latStep) {
                for(let lon = bbox[0]; lon <= bbox[2]; lon += lonStep) {
                    if(turf.booleanPointInPolygon([lon, lat], polygon)) {
                        points.push({ lat, lon, dist: dist++ });
                    }
                }
            }
            
            return points;
        },
        
        async fetchElevations(points) {
            const locations = points.map(p => ({ latitude: p.lat, longitude: p.lon }));
            
            try {
                const response = await fetch('https://api.open-elevation.com/api/v1/lookup', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ locations })
                });
                
                const data = await response.json();
                
                if(data.results) {
                    return points.map((p, i) => ({
                        ...p,
                        elevation: data.results[i].elevation
                    }));
                }
            } catch(e) {
                console.error('API error:', e);
                // Fallback: generar elevaciones simuladas basadas en posicin
                Toast.show('API no disponible, usando datos simulados', 'warning');
                return points.map((p, i) => ({
                    ...p,
                    elevation: 100 + Math.sin(i * 0.1) * 20 + Math.random() * 5
                }));
            }
            
            return null;
        },
        
        displayResults(data, type) {
            const elevations = data.map(p => p.elevation);
            const minElev = Math.min(...elevations);
            const maxElev = Math.max(...elevations);
            const avgElev = elevations.reduce((a, b) => a + b, 0) / elevations.length;
            const range = maxElev - minElev;
            
            // Calcular pendiente promedio
            let totalSlope = 0;
            for(let i = 1; i < data.length; i++) {
                const dElev = Math.abs(data[i].elevation - data[i-1].elevation);
                const dDist = GeoMath.vincentyDist(
                    data[i-1].lat, data[i-1].lon,
                    data[i].lat, data[i].lon
                );
                if(dDist > 0) {
                    totalSlope += (dElev / dDist) * 100;
                }
            }
            const avgSlope = totalSlope / (data.length - 1);
            
            const html = `
                <div class="summary-box" style="background:linear-gradient(135deg,rgba(74,222,128,0.2),rgba(6,182,212,0.15));border-color:#4ade80;margin-top:12px;">
                    <div class="summary-grid">
                        <div class="summary-item">
                            <div class="summary-val" style="color:#4ade80;">${maxElev.toFixed(1)}</div>
                            <div class="summary-lbl">Elevacin Mx (m)</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-val" style="color:#f87171;">${minElev.toFixed(1)}</div>
                            <div class="summary-lbl">Elevacin Mn (m)</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-val" style="color:#60a5fa;">${avgElev.toFixed(1)}</div>
                            <div class="summary-lbl">Elevacin Media (m)</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-val" style="color:#fbbf24;">${avgSlope.toFixed(2)}%</div>
                            <div class="summary-lbl">Pendiente Media</div>
                        </div>
                    </div>
                </div>
                
                <div style="background:var(--bg-glass);border:1px solid var(--border);border-radius:8px;padding:12px;margin-top:8px;">
                    <div style="font-size:10px;color:var(--text-2);font-weight:700;margin-bottom:8px;">ESTADSTICAS</div>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;font-size:11px;">
                        <div><span style="color:var(--text-3);">Desnivel total:</span> <b>${range.toFixed(1)}m</b></div>
                        <div><span style="color:var(--text-3);">Puntos muestreados:</span> <b>${data.length}</b></div>
                        <div><span style="color:var(--text-3);">Tipo anlisis:</span> <b>${type}</b></div>
                        <div><span style="color:var(--text-3);">Orientacin:</span> <b>${maxElev > minElev ? 'Ascendente' : 'Descendente'}</b></div>
                    </div>
                </div>
            `;
            
            $('elev-results').innerHTML = html;
            $('elev-actions').style.display = 'block';
            $('elev-chart-container').style.display = 'block';
            
            Toast.show(`${data.length} puntos analizados`, 'success');
        },
        
        drawChart(data) {
            const canvas = $('elev-chart');
            const ctx = canvas.getContext('2d');
            const width = canvas.parentElement.offsetWidth - 20;
            const height = 150;
            
            canvas.width = width;
            canvas.height = height;
            
            const elevations = data.map(p => p.elevation);
            const minElev = Math.min(...elevations);
            const maxElev = Math.max(...elevations);
            const range = maxElev - minElev || 1;
            
            const padding = 30;
            const chartWidth = width - padding * 2;
            const chartHeight = height - padding * 2;
            
            // Fondo
            ctx.fillStyle = 'rgba(15, 23, 42, 0.8)';
            ctx.fillRect(0, 0, width, height);
            
            // rea bajo la curva
            ctx.beginPath();
            ctx.moveTo(padding, height - padding);
            
            data.forEach((p, i) => {
                const x = padding + (i / (data.length - 1)) * chartWidth;
                const y = height - padding - ((p.elevation - minElev) / range) * chartHeight;
                ctx.lineTo(x, y);
            });
            
            ctx.lineTo(padding + chartWidth, height - padding);
            ctx.closePath();
            ctx.fillStyle = 'rgba(16, 211, 147, 0.3)';
            ctx.fill();
            
            // Lnea del perfil
            ctx.beginPath();
            data.forEach((p, i) => {
                const x = padding + (i / (data.length - 1)) * chartWidth;
                const y = height - padding - ((p.elevation - minElev) / range) * chartHeight;
                if(i === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            });
            ctx.strokeStyle = '#10d393';
            ctx.lineWidth = 2;
            ctx.stroke();
            
            // Ejes
            ctx.strokeStyle = 'rgba(148, 163, 184, 0.5)';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(padding, padding);
            ctx.lineTo(padding, height - padding);
            ctx.lineTo(width - padding, height - padding);
            ctx.stroke();
            
            // Etiquetas
            ctx.fillStyle = '#94a3b8';
            ctx.font = '9px monospace';
            ctx.fillText(`${maxElev.toFixed(0)}m`, 2, padding + 5);
            ctx.fillText(`${minElev.toFixed(0)}m`, 2, height - padding);
            ctx.fillText('Inicio', padding, height - 5);
            ctx.fillText('Fin', width - padding - 15, height - 5);
        },
        
        showOnMap(data) {
            const elevations = data.map(p => p.elevation);
            const minElev = Math.min(...elevations);
            const maxElev = Math.max(...elevations);
            const range = maxElev - minElev || 1;
            
            data.forEach(p => {
                const ratio = (p.elevation - minElev) / range;
                const color = this.getElevationColor(ratio);
                
                L.circleMarker([p.lat, p.lon], {
                    radius: 5,
                    fillColor: color,
                    color: '#fff',
                    weight: 1,
                    fillOpacity: 0.8
                }).bindPopup(`<b>Elevacin:</b> ${p.elevation.toFixed(1)}m`)
                  .addTo(this.layer);
            });
        },
        
        getElevationColor(ratio) {
            // Gradiente de verde (bajo) a rojo (alto)
            const r = Math.round(255 * ratio);
            const g = Math.round(255 * (1 - ratio));
            return `rgb(${r}, ${g}, 100)`;
        },
        
        showContours() {
            if(!this.elevationData || this.elevationData.length === 0) return;
            
            Toast.show('Generando curvas de nivel aproximadas...', 'warning');
            
            const elevations = this.elevationData.map(p => p.elevation);
            const minElev = Math.min(...elevations);
            const maxElev = Math.max(...elevations);
            const interval = 5; // metros entre curvas
            
            // Crear isolneas aproximadas
            for(let elev = Math.ceil(minElev / interval) * interval; elev <= maxElev; elev += interval) {
                const pointsAtLevel = this.elevationData.filter(p => 
                    Math.abs(p.elevation - elev) < interval / 2
                );
                
                if(pointsAtLevel.length >= 2) {
                    const coords = pointsAtLevel.map(p => [p.lat, p.lon]);
                    
                    L.polyline(coords, {
                        color: this.getElevationColor((elev - minElev) / (maxElev - minElev)),
                        weight: 1,
                        opacity: 0.7
                    }).bindPopup(`Curva: ${elev}m`)
                      .addTo(this.layer);
                }
            }
            
            Toast.show('Curvas de nivel generadas', 'success');
        },
        
        exportCSV() {
            if(!this.elevationData) return;
            
            let csv = 'N,Latitud,Longitud,Elevacion_m\n';
            this.elevationData.forEach((p, i) => {
                csv += `${i+1},${p.lat.toFixed(6)},${p.lon.toFixed(6)},${p.elevation.toFixed(2)}\n`;
            });
            
            download(csv, 'perfil_elevacion.csv', 'text/csv');
            Toast.show('CSV exportado', 'success');
        },
        
        clear() {
            if(this.layer) this.layer.clearLayers();
            this.elevationData = null;
        }
    };

    // ========== MEMORIAL DESCRIPTIVO LEGAL ==========
    const MemorialGen = {
        data: null,
        
        togglePanel() {
            const ex = document.getElementById('memorial-panel');
            if(ex) { ex.remove(); return; }
            
            const html = `
            <div id="memorial-panel" class="float-panel" style="top:60px;right:60px;width:500px;max-height:90vh;">
                <div class="panel-hdr">
                    <div class="panel-title"><i class="fa-solid fa-file-contract"></i> MEMORIAL DESCRIPTIVO</div>
                    <button class="panel-close" onclick="MemorialGen.togglePanel()"><i class="fa-solid fa-times"></i></button>
                </div>
                <div class="panel-body">
                    <div class="pro-card">
                        <div class="pro-card-title"><i class="fa-solid fa-gavel"></i> Documento Legal</div>
                        <p style="font-size:10px;color:var(--text-2);margin-bottom:10px;">
                            Genera memorial descriptivo formal para registro de propiedad
                        </p>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Nombre del Propietario</label>
                        <input type="text" class="form-input" id="mem-owner" placeholder="Ej: Juan Prez Gonzlez">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Documento de Identidad</label>
                        <input type="text" class="form-input" id="mem-doc" placeholder="Ej: V-12.345.678">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Nombre del Inmueble/Finca</label>
                        <input type="text" class="form-input" id="mem-name" placeholder="Ej: Parcela Los Robles">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Ubicacin / Direccin</label>
                        <input type="text" class="form-input" id="mem-location" placeholder="Ej: Sector El Valle, Municipio X">
                    </div>
                    
                    <div class="form-row" style="margin-bottom:12px;">
                        <div class="form-group" style="margin:0">
                            <label class="form-label">Estado/Provincia</label>
                            <input type="text" class="form-input" id="mem-state" placeholder="Ej: Carabobo">
                        </div>
                        <div class="form-group" style="margin:0">
                            <label class="form-label">Municipio</label>
                            <input type="text" class="form-input" id="mem-municipality" placeholder="Ej: Valencia">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Colindancias (opcional)</label>
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
                            <input type="text" class="form-input" id="mem-north" placeholder="Norte: Terreno de...">
                            <input type="text" class="form-input" id="mem-south" placeholder="Sur: Calle Principal">
                            <input type="text" class="form-input" id="mem-east" placeholder="Este: Ro Cabriales">
                            <input type="text" class="form-input" id="mem-west" placeholder="Oeste: Parcela 15">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Nmero de Registro/Catastro</label>
                        <input type="text" class="form-input" id="mem-registry" placeholder="Ej: 2024-001234">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Profesional Responsable</label>
                        <input type="text" class="form-input" id="mem-professional" placeholder="Ej: Ing. Mara Lpez - CIV 98765">
                    </div>
                    
                    <button class="btn btn-warning" onclick="MemorialGen.generate()" style="margin-bottom:16px;">
                        <i class="fa-solid fa-file-lines"></i> GENERAR MEMORIAL
                    </button>
                    
                    <div id="mem-preview"></div>
                    
                    <div id="mem-actions" style="display:none;margin-top:12px;">
                        <div class="export-grid">
                            <button class="btn btn-accent" onclick="MemorialGen.exportPDF()">
                                <i class="fa-solid fa-file-pdf"></i> EXPORTAR PDF
                            </button>
                            <button class="btn btn-2" onclick="MemorialGen.exportTXT()">
                                <i class="fa-solid fa-file-alt"></i> EXPORTAR TXT
                            </button>
                            <button class="btn btn-2" onclick="MemorialGen.exportDOC()">
                                <i class="fa-solid fa-file-word"></i> FORMATO WORD
                            </button>
                            <button class="btn btn-2" onclick="MemorialGen.copyToClipboard()">
                                <i class="fa-solid fa-copy"></i> COPIAR
                            </button>
                        </div>
                    </div>
                </div>
            </div>`;
            
            document.body.insertAdjacentHTML('beforeend', html);
        },
        
        generate() {
            if(!State.polygon && State.blocks.length === 0) {
                Toast.show('Dibuja un polgono o crea lotes primero', 'error');
                return;
            }
            
            const target = State.blocks.length > 0 ? State.blocks[0].geo : State.polygon;
            const coords = target.geometry.coordinates[0];
            const zone = UTM.getZone(coords[0][0]);
            
            // Calcular datos geomtricos
            const area = GeoMath.area(coords);
            const perimeter = GeoMath.perimeter(coords);
            const centroid = turf.centroid(target);
            
            // Generar tabla de vrtices
            const vertices = [];
            for(let i = 0; i < coords.length - 1; i++) {
                const [lon, lat] = coords[i];
                const utm = UTM.fromLatLon(lon, lat, zone);
                vertices.push({
                    n: i + 1,
                    lat: lat,
                    lon: lon,
                    utmE: utm[0],
                    utmN: utm[1]
                });
            }
            
            // Generar tabla de linderos
            const linderos = [];
            for(let i = 0; i < coords.length - 1; i++) {
                const p1 = coords[i];
                const p2 = coords[(i + 1) % (coords.length - 1)] || coords[0];
                const dist = GeoMath.vincentyDist(p1[1], p1[0], p2[1], p2[0]);
                const az = GeoMath.bearing(p1[1], p1[0], p2[1], p2[0]);
                const rumbo = GeoMath.azToRumbo(az);
                
                linderos.push({
                    desde: i + 1,
                    hasta: ((i + 1) % (coords.length - 1)) + 1 || 1,
                    distancia: dist,
                    azimut: az,
                    rumbo: rumbo
                });
            }
            
            // Guardar datos
            this.data = {
                owner: $('mem-owner').value || '[PROPIETARIO]',
                doc: $('mem-doc').value || '[DOCUMENTO]',
                name: $('mem-name').value || '[NOMBRE DEL INMUEBLE]',
                location: $('mem-location').value || '[UBICACIN]',
                state: $('mem-state').value || '[ESTADO]',
                municipality: $('mem-municipality').value || '[MUNICIPIO]',
                north: $('mem-north').value || 'Por definir',
                south: $('mem-south').value || 'Por definir',
                east: $('mem-east').value || 'Por definir',
                west: $('mem-west').value || 'Por definir',
                registry: $('mem-registry').value || '[NMERO DE REGISTRO]',
                professional: $('mem-professional').value || '[PROFESIONAL RESPONSABLE]',
                area: area,
                areaHa: area / 10000,
                perimeter: perimeter,
                centroid: centroid.geometry.coordinates,
                zone: zone,
                vertices: vertices,
                linderos: linderos,
                date: new Date().toLocaleDateString('es-ES', { 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                })
            };
            
            this.renderPreview();
            $('mem-actions').style.display = 'block';
            Toast.show('Memorial generado', 'success');
        },
        
        renderPreview() {
            const d = this.data;
            
            let verticesHTML = '';
            d.vertices.forEach(v => {
                verticesHTML += `<tr>
                    <td>${v.n}</td>
                    <td>${v.lat.toFixed(6)}</td>
                    <td>${v.lon.toFixed(6)}</td>
                    <td>${v.utmE.toFixed(2)}</td>
                    <td>${v.utmN.toFixed(2)}</td>
                </tr>`;
            });
            
            let linderosHTML = '';
            d.linderos.forEach(l => {
                linderosHTML += `<tr>
                    <td>${l.desde} - ${l.hasta}</td>
                    <td>${l.distancia.toFixed(2)} m</td>
                    <td>${l.azimut.toFixed(4)}</td>
                    <td>${l.rumbo}</td>
                </tr>`;
            });
            
            const html = `
            <div class="memorial-preview">
                <h1>MEMORIAL DESCRIPTIVO</h1>
                
                <h2>I. DATOS DEL PROPIETARIO</h2>
                <p><strong>Nombre:</strong> ${d.owner}<br>
                <strong>Documento de Identidad:</strong> ${d.doc}</p>
                
                <h2>II. IDENTIFICACIN DEL INMUEBLE</h2>
                <p><strong>Denominacin:</strong> ${d.name}<br>
                <strong>Ubicacin:</strong> ${d.location}<br>
                <strong>Estado:</strong> ${d.state}<br>
                <strong>Municipio:</strong> ${d.municipality}<br>
                <strong>Nmero de Registro:</strong> ${d.registry}</p>
                
                <h2>III. SUPERFICIE Y LINDEROS</h2>
                <p><strong>rea Total:</strong> ${d.area.toFixed(2)} m (${d.areaHa.toFixed(4)} Hectreas)<br>
                <strong>Permetro:</strong> ${d.perimeter.toFixed(2)} metros</p>
                
                <p><strong>Colindancias:</strong></p>
                <ul style="margin-left:20px;">
                    <li><strong>NORTE:</strong> ${d.north}</li>
                    <li><strong>SUR:</strong> ${d.south}</li>
                    <li><strong>ESTE:</strong> ${d.east}</li>
                    <li><strong>OESTE:</strong> ${d.west}</li>
                </ul>
                
                <h2>IV. COORDENADAS DE LOS VRTICES</h2>
                <p><em>Sistema de Referencia: WGS84 / UTM Zona ${d.zone}N</em></p>
                <table>
                    <thead>
                        <tr><th>Vrtice</th><th>Latitud</th><th>Longitud</th><th>Este (m)</th><th>Norte (m)</th></tr>
                    </thead>
                    <tbody>${verticesHTML}</tbody>
                </table>
                
                <h2>V. DESCRIPCIN DE LINDEROS</h2>
                <p>Partiendo del vrtice nmero 1 y en sentido ${d.linderos[0]?.azimut > 180 ? 'antihorario' : 'horario'}:</p>
                <table>
                    <thead>
                        <tr><th>Lado</th><th>Distancia</th><th>Azimut</th><th>Rumbo</th></tr>
                    </thead>
                    <tbody>${linderosHTML}</tbody>
                </table>
                
                <h2>VI. DESCRIPCIN NARRATIVA</h2>
                <p style="text-align:justify;">${this.generateNarrative()}</p>
                
                <h2>VII. CONSTANCIA</h2>
                <p>El presente memorial descriptivo se expide a solicitud del interesado, para los fines legales que estime conveniente.</p>
                
                <p style="margin-top:20px;"><strong>Fecha de emisin:</strong> ${d.date}</p>
                
                <p style="margin-top:30px;text-align:center;">
                    <strong>_______________________________</strong><br>
                    ${d.professional}<br>
                    <em>Profesional Responsable</em>
                </p>
                
                <p style="margin-top:20px;font-size:9px;color:#666;text-align:center;">
                    Documento generado por WIN-TEL Geomatics Pro v20<br>
                    Coordenadas verificadas mediante sistema GPS/GNSS
                </p>
            </div>`;
            
            $('mem-preview').innerHTML = html;
        },
        
        generateNarrative() {
            const d = this.data;
            let narrative = `El inmueble denominado "${d.name}", ubicado en ${d.location}, ${d.municipality}, Estado ${d.state}, `;
            narrative += `tiene una superficie total de ${d.area.toFixed(2)} metros cuadrados (${d.areaHa.toFixed(4)} Ha) `;
            narrative += `y un permetro de ${d.perimeter.toFixed(2)} metros. `;
            narrative += `El terreno est definido por ${d.vertices.length} vrtices, cuyas coordenadas se especifican en la tabla anterior. `;
            
            narrative += `La descripcin de linderos es la siguiente: Partiendo del vrtice 1, `;
            
            d.linderos.forEach((l, i) => {
                const direccion = this.getCardinalDirection(l.azimut);
                narrative += `se contina con rumbo ${l.rumbo} (${direccion}) una distancia de ${l.distancia.toFixed(2)} metros hasta el vrtice ${l.hasta}`;
                if(i < d.linderos.length - 1) {
                    narrative += '; ';
                } else {
                    narrative += ', cerrando as el polgono.';
                }
            });
            
            return narrative;
        },
        
        getCardinalDirection(azimut) {
            if(azimut >= 337.5 || azimut < 22.5) return 'Norte';
            if(azimut >= 22.5 && azimut < 67.5) return 'Noreste';
            if(azimut >= 67.5 && azimut < 112.5) return 'Este';
            if(azimut >= 112.5 && azimut < 157.5) return 'Sureste';
            if(azimut >= 157.5 && azimut < 202.5) return 'Sur';
            if(azimut >= 202.5 && azimut < 247.5) return 'Suroeste';
            if(azimut >= 247.5 && azimut < 292.5) return 'Oeste';
            return 'Noroeste';
        },
        
        exportPDF() {
            if(!this.data) return;
            
            Toast.show('Generando PDF...', 'warning');
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const d = this.data;
            
            // Ttulo
            doc.setFontSize(16);
            doc.setFont('helvetica', 'bold');
            doc.text('MEMORIAL DESCRIPTIVO', 105, 20, { align: 'center' });
            
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            
            let y = 35;
            const lineHeight = 6;
            const margin = 20;
            
            // Datos del propietario
            doc.setFont('helvetica', 'bold');
            doc.text('I. DATOS DEL PROPIETARIO', margin, y);
            y += lineHeight;
            doc.setFont('helvetica', 'normal');
            doc.text(`Nombre: ${d.owner}`, margin, y); y += lineHeight;
            doc.text(`Documento: ${d.doc}`, margin, y); y += lineHeight * 2;
            
            // Identificacin
            doc.setFont('helvetica', 'bold');
            doc.text('II. IDENTIFICACIN DEL INMUEBLE', margin, y);
            y += lineHeight;
            doc.setFont('helvetica', 'normal');
            doc.text(`Denominacin: ${d.name}`, margin, y); y += lineHeight;
            doc.text(`Ubicacin: ${d.location}`, margin, y); y += lineHeight;
            doc.text(`Estado: ${d.state} | Municipio: ${d.municipality}`, margin, y); y += lineHeight;
            doc.text(`Registro: ${d.registry}`, margin, y); y += lineHeight * 2;
            
            // Superficie
            doc.setFont('helvetica', 'bold');
            doc.text('III. SUPERFICIE', margin, y);
            y += lineHeight;
            doc.setFont('helvetica', 'normal');
            doc.text(`rea: ${d.area.toFixed(2)} m (${d.areaHa.toFixed(4)} Ha)`, margin, y); y += lineHeight;
            doc.text(`Permetro: ${d.perimeter.toFixed(2)} m`, margin, y); y += lineHeight * 2;
            
            // Colindancias
            doc.setFont('helvetica', 'bold');
            doc.text('IV. COLINDANCIAS', margin, y);
            y += lineHeight;
            doc.setFont('helvetica', 'normal');
            doc.text(`Norte: ${d.north}`, margin, y); y += lineHeight;
            doc.text(`Sur: ${d.south}`, margin, y); y += lineHeight;
            doc.text(`Este: ${d.east}`, margin, y); y += lineHeight;
            doc.text(`Oeste: ${d.west}`, margin, y); y += lineHeight * 2;
            
            // Coordenadas
            doc.setFont('helvetica', 'bold');
            doc.text('V. COORDENADAS DE VRTICES (UTM Zona ' + d.zone + 'N)', margin, y);
            y += lineHeight;
            
            doc.setFontSize(8);
            doc.setFont('helvetica', 'bold');
            doc.text('V', margin, y);
            doc.text('Latitud', margin + 10, y);
            doc.text('Longitud', margin + 40, y);
            doc.text('Este', margin + 75, y);
            doc.text('Norte', margin + 105, y);
            y += lineHeight;
            
            doc.setFont('helvetica', 'normal');
            d.vertices.forEach(v => {
                if(y > 270) {
                    doc.addPage();
                    y = 20;
                }
                doc.text(String(v.n), margin, y);
                doc.text(v.lat.toFixed(6), margin + 10, y);
                doc.text(v.lon.toFixed(6), margin + 40, y);
                doc.text(v.utmE.toFixed(2), margin + 75, y);
                doc.text(v.utmN.toFixed(2), margin + 105, y);
                y += lineHeight - 1;
            });
            
            y += lineHeight;
            
            // Linderos
            if(y > 240) { doc.addPage(); y = 20; }
            doc.setFontSize(10);
            doc.setFont('helvetica', 'bold');
            doc.text('VI. DESCRIPCIN DE LINDEROS', margin, y);
            y += lineHeight;
            
            doc.setFontSize(8);
            doc.text('Lado', margin, y);
            doc.text('Distancia', margin + 25, y);
            doc.text('Azimut', margin + 55, y);
            doc.text('Rumbo', margin + 85, y);
            y += lineHeight;
            
            doc.setFont('helvetica', 'normal');
            d.linderos.forEach(l => {
                if(y > 270) {
                    doc.addPage();
                    y = 20;
                }
                doc.text(`${l.desde}-${l.hasta}`, margin, y);
                doc.text(`${l.distancia.toFixed(2)} m`, margin + 25, y);
                doc.text(`${l.azimut.toFixed(2)}`, margin + 55, y);
                doc.text(l.rumbo, margin + 85, y);
                y += lineHeight - 1;
            });
            
            // Pie
            y = 270;
            doc.setFontSize(9);
            doc.text(`Fecha: ${d.date}`, margin, y);
            doc.text(d.professional, 190, y, { align: 'right' });
            
            doc.setFontSize(7);
            doc.text('Generado por WIN-TEL Geomatics Pro v20', 105, 285, { align: 'center' });
            
            doc.save('memorial_descriptivo.pdf');
            Toast.show('PDF exportado', 'success');
        },
        
        exportTXT() {
            if(!this.data) return;
            const d = this.data;
            
            let txt = `MEMORIAL DESCRIPTIVO
${'='.repeat(50)}

I. DATOS DEL PROPIETARIO
------------------------
Nombre: ${d.owner}
Documento: ${d.doc}

II. IDENTIFICACIN DEL INMUEBLE
-------------------------------
Denominacin: ${d.name}
Ubicacin: ${d.location}
Estado: ${d.state}
Municipio: ${d.municipality}
Registro: ${d.registry}

III. SUPERFICIE Y LINDEROS
--------------------------
rea Total: ${d.area.toFixed(2)} m (${d.areaHa.toFixed(4)} Ha)
Permetro: ${d.perimeter.toFixed(2)} m

Colindancias:
  NORTE: ${d.north}
  SUR: ${d.south}
  ESTE: ${d.east}
  OESTE: ${d.west}

IV. COORDENADAS DE VRTICES (UTM Zona ${d.zone}N)
-------------------------------------------------
`;
            
            txt += 'V\tLatitud\t\tLongitud\tEste\t\tNorte\n';
            d.vertices.forEach(v => {
                txt += `${v.n}\t${v.lat.toFixed(6)}\t${v.lon.toFixed(6)}\t${v.utmE.toFixed(2)}\t${v.utmN.toFixed(2)}\n`;
            });
            
            txt += `
V. DESCRIPCIN DE LINDEROS
--------------------------
`;
            txt += 'Lado\tDistancia\tAzimut\t\tRumbo\n';
            d.linderos.forEach(l => {
                txt += `${l.desde}-${l.hasta}\t${l.distancia.toFixed(2)} m\t${l.azimut.toFixed(2)}\t\t${l.rumbo}\n`;
            });
            
            txt += `
VI. DESCRIPCIN NARRATIVA
-------------------------
${this.generateNarrative()}

Fecha: ${d.date}
Profesional: ${d.professional}

---
Generado por WIN-TEL Geomatics Pro v20
`;
            
            download(txt, 'memorial_descriptivo.txt', 'text/plain');
            Toast.show('TXT exportado', 'success');
        },
        
        exportDOC() {
            // Exportar como HTML que Word puede abrir
            if(!this.data) return;
            
            const d = this.data;
            let html = `<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Memorial Descriptivo - ${d.name}</title>
<style>
body { font-family: 'Times New Roman', serif; font-size: 12pt; margin: 2cm; }
h1 { text-align: center; font-size: 16pt; border-bottom: 2px solid #000; padding-bottom: 10px; }
h2 { font-size: 13pt; margin-top: 20px; border-bottom: 1px solid #ccc; }
table { width: 100%; border-collapse: collapse; margin: 15px 0; }
th, td { border: 1px solid #000; padding: 5px 10px; text-align: center; }
th { background: #f0f0f0; }
.signature { margin-top: 50px; text-align: center; }
.footer { margin-top: 30px; font-size: 9pt; text-align: center; color: #666; }
</style>
</head>
<body>
${$('mem-preview').innerHTML}
</body>
</html>`;
            
            download(html, 'memorial_descriptivo.doc', 'application/msword');
            Toast.show('Documento Word exportado', 'success');
        },
        
        copyToClipboard() {
            if(!this.data) return;
            
            const preview = $('mem-preview');
            const text = preview.innerText;
            
            navigator.clipboard.writeText(text)
                .then(() => Toast.show('Copiado al portapapeles', 'success'))
                .catch(() => Toast.show('Error al copiar', 'error'));
        }
    };

    // ========== GENERADOR DE CROQUIS/PLANO ==========
    const CroquisGen = {
        canvas: null,
        ctx: null,
        config: {
            width: 800,
            height: 600,
            bgColor: '#ffffff',
            polygonFill: '#e8f5e9',
            polygonStroke: '#2e7d32',
            vertexColor: '#d32f2f',
            textColor: '#1a1a1a',
            gridColor: '#e0e0e0',
            showGrid: true,
            showNorth: true,
            showScale: true,
            showVertices: true,
            showDistances: true,
            showCoordTable: true,
            title: 'PLANO DE UBICACIN',
            subtitle: '',
            professional: ''
        },
        
        togglePanel() {
            const ex = document.getElementById('croquis-panel');
            if(ex) { ex.remove(); return; }
            
            const html = `
            <div id="croquis-panel" class="float-panel" style="top:60px;left:480px;width:420px;max-height:90vh;">
                <div class="panel-hdr">
                    <div class="panel-title"><i class="fa-solid fa-map"></i> GENERADOR DE CROQUIS</div>
                    <button class="panel-close" onclick="CroquisGen.togglePanel()"><i class="fa-solid fa-times"></i></button>
                </div>
                <div class="panel-body">
                    <div class="pro-card">
                        <div class="pro-card-title"><i class="fa-solid fa-drafting-compass"></i> Plano Profesional</div>
                        <p style="font-size:10px;color:var(--text-2);margin-bottom:10px;">
                            Genera imagen HD con escala, norte y tabla de coordenadas
                        </p>
                    </div>
                    
                    <div class="croquis-config">
                        <div class="croquis-config-title">Informacin del Plano</div>
                        <div class="form-group" style="margin-bottom:8px;">
                            <input type="text" class="form-input" id="croq-title" placeholder="Ttulo del plano" value="PLANO DE UBICACIN">
                        </div>
                        <div class="form-group" style="margin-bottom:8px;">
                            <input type="text" class="form-input" id="croq-subtitle" placeholder="Subttulo (ubicacin, etc.)">
                        </div>
                        <div class="form-group" style="margin-bottom:0;">
                            <input type="text" class="form-input" id="croq-professional" placeholder="Profesional responsable">
                        </div>
                    </div>
                    
                    <div class="croquis-config">
                        <div class="croquis-config-title">Tamao de Imagen</div>
                        <div class="form-row">
                            <div class="form-group" style="margin:0">
                                <label class="form-label">Ancho (px)</label>
                                <input type="number" class="form-input" id="croq-width" value="800" min="400" max="2000">
                            </div>
                            <div class="form-group" style="margin:0">
                                <label class="form-label">Alto (px)</label>
                                <input type="number" class="form-input" id="croq-height" value="600" min="300" max="1500">
                            </div>
                        </div>
                    </div>
                    
                    <div class="croquis-config">
                        <div class="croquis-config-title">Colores</div>
                        <div class="color-picker-row">
                            <label>Fondo</label>
                            <input type="color" id="croq-bg" value="#ffffff">
                        </div>
                        <div class="color-picker-row">
                            <label>Relleno polgono</label>
                            <input type="color" id="croq-fill" value="#e8f5e9">
                        </div>
                        <div class="color-picker-row">
                            <label>Borde polgono</label>
                            <input type="color" id="croq-stroke" value="#2e7d32">
                        </div>
                        <div class="color-picker-row">
                            <label>Vrtices</label>
                            <input type="color" id="croq-vertex" value="#d32f2f">
                        </div>
                    </div>
                    
                    <div class="croquis-config">
                        <div class="croquis-config-title">Elementos</div>
                        <div class="toggle-row" style="margin-bottom:6px;padding:8px;">
                            <div class="toggle-lbl" style="font-size:11px;"><i class="fa-solid fa-border-all"></i> Grilla</div>
                            <label class="switch"><input type="checkbox" id="croq-grid" checked><span class="slider"></span></label>
                        </div>
                        <div class="toggle-row" style="margin-bottom:6px;padding:8px;">
                            <div class="toggle-lbl" style="font-size:11px;"><i class="fa-solid fa-compass"></i> Norte</div>
                            <label class="switch"><input type="checkbox" id="croq-north" checked><span class="slider"></span></label>
                        </div>
                        <div class="toggle-row" style="margin-bottom:6px;padding:8px;">
                            <div class="toggle-lbl" style="font-size:11px;"><i class="fa-solid fa-ruler"></i> Escala</div>
                            <label class="switch"><input type="checkbox" id="croq-scale" checked><span class="slider"></span></label>
                        </div>
                        <div class="toggle-row" style="margin-bottom:6px;padding:8px;">
                            <div class="toggle-lbl" style="font-size:11px;"><i class="fa-solid fa-circle-dot"></i> Vrtices</div>
                            <label class="switch"><input type="checkbox" id="croq-vertices" checked><span class="slider"></span></label>
                        </div>
                        <div class="toggle-row" style="margin-bottom:6px;padding:8px;">
                            <div class="toggle-lbl" style="font-size:11px;"><i class="fa-solid fa-arrows-left-right"></i> Distancias</div>
                            <label class="switch"><input type="checkbox" id="croq-distances" checked><span class="slider"></span></label>
                        </div>
                        <div class="toggle-row" style="margin-bottom:0;padding:8px;">
                            <div class="toggle-lbl" style="font-size:11px;"><i class="fa-solid fa-table"></i> Tabla Coords</div>
                            <label class="switch"><input type="checkbox" id="croq-table" checked><span class="slider"></span></label>
                        </div>
                    </div>
                    
                    <button class="btn btn-cyan" onclick="CroquisGen.generate()" style="margin-bottom:12px;">
                        <i class="fa-solid fa-image"></i> GENERAR CROQUIS
                    </button>
                    
                    <div id="croq-preview" style="text-align:center;margin-bottom:12px;"></div>
                    
                    <div id="croq-actions" style="display:none;">
                        <div class="export-grid">
                            <button class="btn btn-accent" onclick="CroquisGen.downloadPNG()">
                                <i class="fa-solid fa-file-image"></i> PNG
                            </button>
                            <button class="btn btn-2" onclick="CroquisGen.downloadJPG()">
                                <i class="fa-solid fa-file-image"></i> JPG
                            </button>
                            <button class="btn btn-2" onclick="CroquisGen.downloadSVG()">
                                <i class="fa-solid fa-bezier-curve"></i> SVG
                            </button>
                            <button class="btn btn-2" onclick="CroquisGen.print()">
                                <i class="fa-solid fa-print"></i> IMPRIMIR
                            </button>
                        </div>
                    </div>
                </div>
            </div>`;
            
            document.body.insertAdjacentHTML('beforeend', html);
        },
        
        generate() {
            if(!State.polygon && State.blocks.length === 0) {
                Toast.show('Dibuja un polgono o crea lotes primero', 'error');
                return;
            }
            
            Loading.show();
            
            // Actualizar configuracin
            this.config.width = parseInt($('croq-width').value) || 800;
            this.config.height = parseInt($('croq-height').value) || 600;
            this.config.bgColor = $('croq-bg').value;
            this.config.polygonFill = $('croq-fill').value;
            this.config.polygonStroke = $('croq-stroke').value;
            this.config.vertexColor = $('croq-vertex').value;
            this.config.showGrid = $('croq-grid').checked;
            this.config.showNorth = $('croq-north').checked;
            this.config.showScale = $('croq-scale').checked;
            this.config.showVertices = $('croq-vertices').checked;
            this.config.showDistances = $('croq-distances').checked;
            this.config.showCoordTable = $('croq-table').checked;
            this.config.title = $('croq-title').value || 'PLANO DE UBICACIN';
            this.config.subtitle = $('croq-subtitle').value;
            this.config.professional = $('croq-professional').value;
            
            // Crear canvas
            this.canvas = document.createElement('canvas');
            this.canvas.width = this.config.width;
            this.canvas.height = this.config.height;
            this.ctx = this.canvas.getContext('2d');
            
            this.draw();
            
            // Mostrar preview
            const previewCanvas = document.createElement('canvas');
            previewCanvas.width = 380;
            previewCanvas.height = 280;
            previewCanvas.className = 'croquis-canvas';
            const previewCtx = previewCanvas.getContext('2d');
            previewCtx.drawImage(this.canvas, 0, 0, 380, 280);
            
            $('croq-preview').innerHTML = '';
            $('croq-preview').appendChild(previewCanvas);
            $('croq-actions').style.display = 'block';
            
            Loading.hide();
            Toast.show('Croquis generado', 'success');
        },
        
        draw() {
            const ctx = this.ctx;
            const w = this.config.width;
            const h = this.config.height;
            const margin = 60;
            const tableWidth = this.config.showCoordTable ? 180 : 0;
            const drawWidth = w - margin * 2 - tableWidth;
            const drawHeight = h - margin * 2 - 40; // espacio para ttulo
            
            // Fondo
            ctx.fillStyle = this.config.bgColor;
            ctx.fillRect(0, 0, w, h);
            
            // Borde del plano
            ctx.strokeStyle = '#333';
            ctx.lineWidth = 2;
            ctx.strokeRect(10, 10, w - 20, h - 20);
            ctx.strokeRect(15, 15, w - 30, h - 30);
            
            // Ttulo
            ctx.fillStyle = this.config.textColor;
            ctx.font = 'bold 18px Arial';
            ctx.textAlign = 'center';
            ctx.fillText(this.config.title, (w - tableWidth) / 2, 45);
            
            if(this.config.subtitle) {
                ctx.font = '12px Arial';
                ctx.fillText(this.config.subtitle, (w - tableWidth) / 2, 62);
            }
            
            // Obtener coordenadas
            const target = State.blocks.length > 0 ? State.blocks[0].geo : State.polygon;
            const coords = target.geometry.coordinates[0];
            const bbox = turf.bbox(target);
            
            // Calcular escala y offset
            const polyWidth = bbox[2] - bbox[0];
            const polyHeight = bbox[3] - bbox[1];
            const scaleX = drawWidth / polyWidth;
            const scaleY = drawHeight / polyHeight;
            const scale = Math.min(scaleX, scaleY) * 0.85;
            
            const offsetX = margin + (drawWidth - polyWidth * scale) / 2;
            const offsetY = margin + 50 + (drawHeight - polyHeight * scale) / 2;
            
            // Funcin para convertir coordenadas
            const toCanvas = (lon, lat) => {
                return [
                    offsetX + (lon - bbox[0]) * scale,
                    offsetY + (bbox[3] - lat) * scale
                ];
            };
            
            // Grilla
            if(this.config.showGrid) {
                ctx.strokeStyle = this.config.gridColor;
                ctx.lineWidth = 0.5;
                const gridStep = 50;
                
                for(let x = margin; x < w - tableWidth - margin; x += gridStep) {
                    ctx.beginPath();
                    ctx.moveTo(x, margin + 50);
                    ctx.lineTo(x, h - margin);
                    ctx.stroke();
                }
                
                for(let y = margin + 50; y < h - margin; y += gridStep) {
                    ctx.beginPath();
                    ctx.moveTo(margin, y);
                    ctx.lineTo(w - tableWidth - margin, y);
                    ctx.stroke();
                }
            }
            
            // Dibujar polgono
            ctx.beginPath();
            coords.forEach((coord, i) => {
                const [x, y] = toCanvas(coord[0], coord[1]);
                if(i === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            });
            ctx.closePath();
            
            ctx.fillStyle = this.config.polygonFill;
            ctx.fill();
            ctx.strokeStyle = this.config.polygonStroke;
            ctx.lineWidth = 2;
            ctx.stroke();
            
            // Vrtices y distancias
            const vertices = coords.slice(0, -1);
            
            vertices.forEach((coord, i) => {
                const [x, y] = toCanvas(coord[0], coord[1]);
                
                // Vrtice
                if(this.config.showVertices) {
                    ctx.beginPath();
                    ctx.arc(x, y, 6, 0, Math.PI * 2);
                    ctx.fillStyle = this.config.vertexColor;
                    ctx.fill();
                    ctx.strokeStyle = '#fff';
                    ctx.lineWidth = 2;
                    ctx.stroke();
                    
                    // Nmero de vrtice
                    ctx.fillStyle = this.config.textColor;
                    ctx.font = 'bold 10px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText(`V${i + 1}`, x, y - 12);
                }
                
                // Distancias
                if(this.config.showDistances && i < vertices.length) {
                    const nextCoord = coords[i + 1];
                    const [nx, ny] = toCanvas(nextCoord[0], nextCoord[1]);
                    const dist = GeoMath.vincentyDist(coord[1], coord[0], nextCoord[1], nextCoord[0]);
                    
                    const midX = (x + nx) / 2;
                    const midY = (y + ny) / 2;
                    
                    // Fondo para texto
                    ctx.fillStyle = 'rgba(255,255,255,0.8)';
                    const text = `${dist.toFixed(2)}m`;
                    const textWidth = ctx.measureText(text).width;
                    ctx.fillRect(midX - textWidth/2 - 3, midY - 7, textWidth + 6, 14);
                    
                    ctx.fillStyle = '#333';
                    ctx.font = '9px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText(text, midX, midY + 3);
                }
            });
            
            // Norte
            if(this.config.showNorth) {
                const nx = w - tableWidth - margin - 30;
                const ny = margin + 90;
                
                ctx.save();
                ctx.translate(nx, ny);
                
                // Flecha
                ctx.beginPath();
                ctx.moveTo(0, -25);
                ctx.lineTo(-8, 10);
                ctx.lineTo(0, 5);
                ctx.lineTo(8, 10);
                ctx.closePath();
                ctx.fillStyle = '#333';
                ctx.fill();
                
                // N
                ctx.fillStyle = '#333';
                ctx.font = 'bold 14px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('N', 0, -30);
                
                ctx.restore();
            }
            
            // Escala grfica
            if(this.config.showScale) {
                const sx = margin + 20;
                const sy = h - margin - 15;
                
                // Calcular escala en metros
                const metersPerPixel = polyWidth * 111320 / (polyWidth * scale);
                const scaleBarMeters = Math.round(metersPerPixel * 100 / 10) * 10; // redondear a 10m
                const scaleBarPixels = scaleBarMeters / metersPerPixel;
                
                ctx.fillStyle = '#333';
                ctx.fillRect(sx, sy, scaleBarPixels, 8);
                ctx.fillStyle = '#fff';
                ctx.fillRect(sx + scaleBarPixels/2, sy, scaleBarPixels/2, 8);
                ctx.strokeStyle = '#333';
                ctx.lineWidth = 1;
                ctx.strokeRect(sx, sy, scaleBarPixels, 8);
                
                ctx.fillStyle = '#333';
                ctx.font = '10px Arial';
                ctx.textAlign = 'left';
                ctx.fillText('0', sx, sy + 20);
                ctx.textAlign = 'right';
                ctx.fillText(`${scaleBarMeters}m`, sx + scaleBarPixels, sy + 20);
            }
            
            // Tabla de coordenadas
            if(this.config.showCoordTable) {
                const tx = w - tableWidth - 10;
                const ty = margin + 50;
                const rowHeight = 18;
                const colWidths = [25, 75, 75];
                
                ctx.fillStyle = '#f5f5f5';
                ctx.fillRect(tx, ty, tableWidth, rowHeight * (vertices.length + 2));
                ctx.strokeStyle = '#333';
                ctx.lineWidth = 1;
                ctx.strokeRect(tx, ty, tableWidth, rowHeight * (vertices.length + 2));
                
                // Header
                ctx.fillStyle = '#333';
                ctx.fillRect(tx, ty, tableWidth, rowHeight);
                ctx.fillStyle = '#fff';
                ctx.font = 'bold 9px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('V', tx + 12, ty + 13);
                ctx.fillText('LATITUD', tx + 62, ty + 13);
                ctx.fillText('LONGITUD', tx + 137, ty + 13);
                
                // Datos
                ctx.fillStyle = '#333';
                ctx.font = '8px Arial';
                vertices.forEach((coord, i) => {
                    const ry = ty + rowHeight * (i + 1);
                    ctx.strokeRect(tx, ry, tableWidth, rowHeight);
                    ctx.fillText(`${i + 1}`, tx + 12, ry + 13);
                    ctx.fillText(coord[1].toFixed(6), tx + 62, ry + 13);
                    ctx.fillText(coord[0].toFixed(6), tx + 137, ry + 13);
                });
                
                // rea y permetro
                const area = GeoMath.area(coords);
                const perim = GeoMath.perimeter(coords);
                const infoY = ty + rowHeight * (vertices.length + 1) + 15;
                
                ctx.font = 'bold 9px Arial';
                ctx.textAlign = 'left';
                ctx.fillText(`rea: ${(area/10000).toFixed(4)} Ha`, tx + 5, infoY);
                ctx.fillText(`Permetro: ${perim.toFixed(2)} m`, tx + 5, infoY + 15);
            }
            
            // Pie de pgina
            ctx.fillStyle = '#666';
            ctx.font = '9px Arial';
            ctx.textAlign = 'left';
            ctx.fillText(`Fecha: ${new Date().toLocaleDateString()}`, margin, h - 25);
            
            if(this.config.professional) {
                ctx.textAlign = 'right';
                ctx.fillText(this.config.professional, w - tableWidth - margin, h - 25);
            }
            
            ctx.textAlign = 'center';
            ctx.font = '8px Arial';
            ctx.fillStyle = '#999';
            ctx.fillText('Generado por WIN-TEL Geomatics Pro v20', (w - tableWidth) / 2, h - 25);
        },
        
        downloadPNG() {
            if(!this.canvas) return;
            
            const link = document.createElement('a');
            link.download = 'croquis_plano.png';
            link.href = this.canvas.toDataURL('image/png');
            link.click();
            
            Toast.show('PNG descargado', 'success');
        },
        
        downloadJPG() {
            if(!this.canvas) return;
            
            const link = document.createElement('a');
            link.download = 'croquis_plano.jpg';
            link.href = this.canvas.toDataURL('image/jpeg', 0.95);
            link.click();
            
            Toast.show('JPG descargado', 'success');
        },
        
        downloadSVG() {
            if(!State.polygon && State.blocks.length === 0) return;
            
            const target = State.blocks.length > 0 ? State.blocks[0].geo : State.polygon;
            const coords = target.geometry.coordinates[0];
            const bbox = turf.bbox(target);
            
            const w = this.config.width;
            const h = this.config.height;
            const margin = 60;
            
            const polyWidth = bbox[2] - bbox[0];
            const polyHeight = bbox[3] - bbox[1];
            const scale = Math.min((w - margin*2) / polyWidth, (h - margin*2) / polyHeight) * 0.8;
            
            const offsetX = margin + ((w - margin*2) - polyWidth * scale) / 2;
            const offsetY = margin + ((h - margin*2) - polyHeight * scale) / 2;
            
            let pathD = '';
            coords.forEach((coord, i) => {
                const x = offsetX + (coord[0] - bbox[0]) * scale;
                const y = offsetY + (bbox[3] - coord[1]) * scale;
                pathD += (i === 0 ? 'M' : 'L') + `${x.toFixed(2)},${y.toFixed(2)} `;
            });
            pathD += 'Z';
            
            const svg = `<?xml version="1.0" encoding="UTF-8"?>
<svg xmlns="http://www.w3.org/2000/svg" width="${w}" height="${h}" viewBox="0 0 ${w} ${h}">
    <rect width="100%" height="100%" fill="${this.config.bgColor}"/>
    <rect x="10" y="10" width="${w-20}" height="${h-20}" fill="none" stroke="#333" stroke-width="2"/>
    <text x="${w/2}" y="40" text-anchor="middle" font-family="Arial" font-size="18" font-weight="bold">${this.config.title}</text>
    <path d="${pathD}" fill="${this.config.polygonFill}" stroke="${this.config.polygonStroke}" stroke-width="2"/>
    <text x="${w/2}" y="${h-20}" text-anchor="middle" font-family="Arial" font-size="8" fill="#999">WIN-TEL Geomatics Pro v20</text>
</svg>`;
            
            download(svg, 'croquis_plano.svg', 'image/svg+xml');
            Toast.show('SVG descargado', 'success');
        },
        
        print() {
            if(!this.canvas) return;
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(
                '<!DOCTYPE html><html><head><title>Croquis - WIN-TEL Geomatics</title></head>' +
                '<body style="margin:0;display:flex;justify-content:center;align-items:center;min-height:100vh;">' +
                '<img src="' + this.canvas.toDataURL('image/png') + '" style="max-width:100%;height:auto;">' +
                '<scr' + 'ipt>window.onload=function(){window.print();}<\/scr' + 'ipt>' +
                '</body></html>'
            );
            printWindow.document.close();
            
            Toast.show('Enviando a impresora...', 'success');
        }
    };

    // ========== MULTI-POTREROS SYSTEM ==========
    const Potreros = {
        colors: [
            '#10d393', '#f59e0b', '#8b5cf6', '#3b82f6', '#ef4444', 
            '#ec4899', '#06b6d4', '#84cc16', '#f97316', '#6366f1',
            '#14b8a6', '#f43f5e', '#a855f7', '#0ea5e9', '#eab308',
            '#22c55e', '#e11d48', '#7c3aed', '#0284c7', '#ca8a04'
        ],
        editingId: null,
        selectedColor: null,
        isDrawingMode: false,
        
        init() {
            State.layers.potreros = L.layerGroup().addTo(State.map);
            this.render();
            this.updateBadge();
        },
        
        // Genera un ID nico
        generateId() {
            return 'pot_' + Math.random().toString(36).substr(2, 9);
        },
        
        // Obtiene el siguiente color disponible
        getNextColor() {
            const usedColors = State.potreros.map(p => p.color);
            const available = this.colors.find(c => !usedColors.includes(c));
            return available || this.colors[State.potreros.length % this.colors.length];
        },
        
        // Inicia modo de dibujo para nuevo potrero
        startDrawing() {
            this.isDrawingMode = true;
            Toast.show('Dibuja el nuevo potrero en el mapa', 'warning');
            
            // Activar herramienta de dibujo
            const drawControl = document.querySelector('.leaflet-draw-draw-polygon');
            if(drawControl) drawControl.click();
        },
        
        // Aade un nuevo potrero desde un polgono dibujado
        addFromPolygon(geoJSON) {
            const id = this.generateId();
            const color = this.getNextColor();
            const coords = geoJSON.geometry.coordinates[0];
            const area = GeoMath.area(coords);
            const name = `Potrero ${State.potreros.length + 1}`;
            
            const potrero = {
                id: id,
                name: name,
                color: color,
                geo: geoJSON,
                area: area,
                blocks: [], // Lotes subdivididos de este potrero
                layer: null
            };
            
            State.potreros.push(potrero);
            this.setActive(id);
            this.render();
            this.renderOnMap();
            
            Toast.show(`${name} creado (${(area/10000).toFixed(4)} Ha)`, 'success');
            this.isDrawingMode = false;
            
            return potrero;
        },
        
        // Establece el potrero activo
        setActive(id) {
            State.activePotreroId = id;
            const potrero = this.getActive();
            
            if(potrero) {
                // Sincronizar con State.polygon para compatibilidad con otras funciones
                State.polygon = potrero.geo;
                State.blocks = potrero.blocks || [];
                
                // Re-renderizar todo
                Renderer.render();
                BotalonMgr.calculate();
            }
            
            this.render();
            this.renderOnMap();
            this.updateBadge();
            
            // Centrar mapa en el potrero activo
            if(potrero) {
                const bounds = L.geoJSON(potrero.geo).getBounds();
                State.map.fitBounds(bounds, { padding: [50, 50] });
            }
        },
        
        // Obtiene el potrero activo
        getActive() {
            return State.potreros.find(p => p.id === State.activePotreroId);
        },
        
        // Actualiza el potrero activo con nuevos bloques
        updateActiveBlocks(blocks) {
            const potrero = this.getActive();
            if(potrero) {
                potrero.blocks = blocks;
            }
        },
        
        // Elimina un potrero
        remove(id) {
            const index = State.potreros.findIndex(p => p.id === id);
            if(index === -1) return;
            
            const potrero = State.potreros[index];
            State.potreros.splice(index, 1);
            
            // Si era el activo, activar otro o limpiar
            if(State.activePotreroId === id) {
                if(State.potreros.length > 0) {
                    this.setActive(State.potreros[0].id);
                } else {
                    State.activePotreroId = null;
                    State.polygon = null;
                    State.blocks = [];
                    Renderer.render();
                }
            }
            
            this.render();
            this.renderOnMap();
            this.updateBadge();
            
            Toast.show(`${potrero.name} eliminado`, 'warning');
        },
        
        // Abre modal de edicin
        edit(id) {
            this.editingId = id;
            const potrero = State.potreros.find(p => p.id === id);
            if(!potrero) return;
            
            $('potrero-edit-name').value = potrero.name;
            this.selectedColor = potrero.color;
            
            // Renderizar opciones de color
            const colorsDiv = $('potrero-colors');
            colorsDiv.innerHTML = this.colors.map(c => `
                <div class="potrero-color-opt ${c === potrero.color ? 'selected' : ''}" 
                     style="background:${c};" 
                     onclick="Potreros.selectColor('${c}')">
                </div>
            `).join('');
            
            $('potrero-modal').classList.add('active');
        },
        
        selectColor(color) {
            this.selectedColor = color;
            document.querySelectorAll('.potrero-color-opt').forEach(el => {
                el.classList.toggle('selected', el.style.background === color || el.style.backgroundColor === color);
            });
        },
        
        saveEdit() {
            const potrero = State.potreros.find(p => p.id === this.editingId);
            if(!potrero) return;
            
            potrero.name = $('potrero-edit-name').value || potrero.name;
            potrero.color = this.selectedColor || potrero.color;
            
            this.closeModal();
            this.render();
            this.renderOnMap();
            this.updateBadge();
            
            Toast.show('Potrero actualizado', 'success');
        },
        
        closeModal() {
            $('potrero-modal').classList.remove('active');
            this.editingId = null;
        },
        
        // Toggle collapse del panel
        toggleCollapse() {
            const panel = $('potreros-panel');
            panel.classList.toggle('collapsed');
        },
        
        // Renderiza la lista de potreros
        render() {
            const list = $('potreros-list');
            const countEl = $('potreros-count');
            
            // Actualizar contador
            const count = State.potreros.length;
            countEl.textContent = count === 0 ? 'Sin terrenos' : 
                                  count === 1 ? '1 terreno' : 
                                  `${count} terrenos`;
            
            if(State.potreros.length === 0) {
                list.innerHTML = `
                    <div class="potreros-empty">
                        <i class="fa-solid fa-draw-polygon"></i>
                        <p>No hay potreros.<br>Dibuja uno en el mapa o haz clic en "Nuevo Potrero"</p>
                    </div>
                `;
                return;
            }
            
            list.innerHTML = State.potreros.map(p => `
                <div class="potrero-item ${p.id === State.activePotreroId ? 'active' : ''}" 
                     onclick="Potreros.setActive('${p.id}')">
                    <div class="potrero-color" style="background:${p.color};"></div>
                    <div class="potrero-info">
                        <div class="potrero-name">${p.name}</div>
                        <div class="potrero-meta">
                            <span>${(p.area/10000).toFixed(4)} Ha</span>
                            ${p.blocks.length > 0 ? `<span> ${p.blocks.length} lotes</span>` : ''}
                        </div>
                    </div>
                    <div class="potrero-actions">
                        <button class="potrero-action" onclick="event.stopPropagation();Potreros.zoomTo('${p.id}')" title="Zoom">
                            <i class="fa-solid fa-crosshairs"></i>
                        </button>
                        <button class="potrero-action" onclick="event.stopPropagation();Potreros.edit('${p.id}')" title="Editar">
                            <i class="fa-solid fa-pen"></i>
                        </button>
                        <button class="potrero-action delete" onclick="event.stopPropagation();Potreros.confirmDelete('${p.id}')" title="Eliminar">
                            <i class="fa-solid fa-trash"></i>
                        </button>
                    </div>
                </div>
            `).join('');
        },
        
        // Renderiza los potreros en el mapa
        renderOnMap() {
            State.layers.potreros.clearLayers();
            
            State.potreros.forEach(p => {
                const isActive = p.id === State.activePotreroId;
                
                const layer = L.geoJSON(p.geo, {
                    style: {
                        color: p.color,
                        weight: isActive ? 4 : 2,
                        opacity: isActive ? 1 : 0.6,
                        fillColor: p.color,
                        fillOpacity: isActive ? 0.2 : 0.1,
                        dashArray: isActive ? null : '5, 5'
                    }
                });
                
                // Tooltip con nombre
                layer.bindTooltip(p.name, {
                    permanent: false,
                    direction: 'center',
                    className: 'potrero-tooltip'
                });
                
                // Click para activar
                layer.on('click', () => {
                    if(p.id !== State.activePotreroId) {
                        this.setActive(p.id);
                    }
                });
                
                layer.addTo(State.layers.potreros);
                p.layer = layer;
            });
        },
        
        // Actualiza el badge del potrero activo
        updateBadge() {
            const badge = $('active-potrero-badge');
            const potrero = this.getActive();
            
            if(potrero) {
                $('active-potrero-color').style.background = potrero.color;
                $('active-potrero-name').textContent = potrero.name;
                $('active-potrero-area').textContent = `${(potrero.area/10000).toFixed(4)} Ha`;
                badge.classList.add('visible');
            } else {
                badge.classList.remove('visible');
            }
        },
        
        // Zoom a un potrero especfico
        zoomTo(id) {
            const potrero = State.potreros.find(p => p.id === id);
            if(!potrero) return;
            
            const bounds = L.geoJSON(potrero.geo).getBounds();
            State.map.fitBounds(bounds, { padding: [50, 50] });
        },
        
        // Confirmar eliminacin
        confirmDelete(id) {
            const potrero = State.potreros.find(p => p.id === id);
            if(!potrero) return;
            
            if(confirm(`Eliminar "${potrero.name}"?\n\nEsta accin no se puede deshacer.`)) {
                this.remove(id);
            }
        },
        
        // Exportar todos los potreros
        exportAll(format = 'geojson') {
            if(State.potreros.length === 0) {
                Toast.show('No hay potreros para exportar', 'error');
                return;
            }
            
            const features = State.potreros.map(p => ({
                type: 'Feature',
                properties: {
                    name: p.name,
                    color: p.color,
                    area_m2: p.area,
                    area_ha: p.area / 10000,
                    num_lotes: p.blocks.length
                },
                geometry: p.geo.geometry
            }));
            
            const collection = {
                type: 'FeatureCollection',
                features: features
            };
            
            if(format === 'geojson') {
                download(JSON.stringify(collection, null, 2), 'potreros.geojson', 'application/geo+json');
            } else if(format === 'kml') {
                let kml = `<?xml version="1.0" encoding="UTF-8"?>
<kml xmlns="http://www.opengis.net/kml/2.2">
<Document>
<name>Potreros WIN-TEL</name>`;
                
                State.potreros.forEach(p => {
                    const coords = p.geo.geometry.coordinates[0].map(c => `${c[0]},${c[1]},0`).join(' ');
                    kml += `
<Placemark>
    <name>${p.name}</name>
    <description>rea: ${(p.area/10000).toFixed(4)} Ha</description>
    <Style><PolyStyle><color>80${p.color.slice(5,7)}${p.color.slice(3,5)}${p.color.slice(1,3)}</color></PolyStyle></Style>
    <Polygon><outerBoundaryIs><LinearRing><coordinates>${coords}</coordinates></LinearRing></outerBoundaryIs></Polygon>
</Placemark>`;
                });
                
                kml += `
</Document>
</kml>`;
                download(kml, 'potreros.kml', 'application/vnd.google-earth.kml+xml');
            }
            
            Toast.show(`${State.potreros.length} potreros exportados`, 'success');
        },
        
        // Limpiar todos los potreros
        clearAll() {
            if(State.potreros.length === 0) return;
            
            if(confirm(`Eliminar todos los ${State.potreros.length} potreros?\n\nEsta accin no se puede deshacer.`)) {
                State.potreros = [];
                State.activePotreroId = null;
                State.polygon = null;
                State.blocks = [];
                
                State.layers.potreros.clearLayers();
                Renderer.render();
                
                this.render();
                this.updateBadge();
                
                Toast.show('Todos los potreros eliminados', 'warning');
            }
        }
    };

    // ========== SMART ASSISTANT SYSTEM ==========
    const Assistant = {
        mode: 'beginner',
        currentStep: 0,
        steps: [
            { text: 'Dibuja tu terreno en el mapa', hint: 'Haz clic en el cono de polgono () en la barra derecha', check: () => State.polygon !== null },
            { text: 'Revisa las medidas del terreno', hint: 'Mira el panel izquierdo con rea y permetro', check: () => State.polygon !== null },
            { text: 'Subdivide el terreno (opcional)', hint: 'Ve al panel "Subdivisin" en el men lateral', check: () => State.blocks.length > 0 },
            { text: 'Exporta tus resultados!', hint: 'Usa los botones de exportar KML, PDF o Memorial', check: () => true }
        ],
        
        init() {
            const saved = localStorage.getItem('wintel-mode');
            const wizardDone = localStorage.getItem('wintel-wizard-done');
            
            if(!wizardDone) {
                setTimeout(() => {
                    $('wizard-overlay').classList.add('active');
                }, 2500);
            } else {
                this.mode = saved || 'beginner';
                this.applyMode();
            }
            
            this.updateAssistantContent();
        },
        
        setMode(mode) {
            this.mode = mode;
            localStorage.setItem('wintel-mode', mode);
            localStorage.setItem('wintel-wizard-done', 'true');
            $('wizard-overlay').classList.remove('active');
            this.applyMode();
            
            if(mode === 'beginner') {
                Toast.show('Modo Principiante activado', 'success');
                setTimeout(() => this.showStep(0), 500);
            } else {
                Toast.show('Modo Experto activado', 'success');
            }
            
            this.updateAssistantContent();
        },
        
        skipWizard() {
            localStorage.setItem('wintel-wizard-done', 'true');
            $('wizard-overlay').classList.remove('active');
            this.mode = 'beginner';
            this.applyMode();
        },
        
        toggleMode(mode) {
            this.mode = mode;
            localStorage.setItem('wintel-mode', mode);
            this.applyMode();
            this.updateAssistantContent();
            Toast.show(`Modo ${mode === 'beginner' ? 'Principiante' : 'Experto'} activado`, 'success');
        },
        
        applyMode() {
            const body = document.body;
            const beginnerBtn = $('mode-beginner');
            const expertBtn = $('mode-expert');
            
            if(this.mode === 'beginner') {
                body.classList.add('beginner-mode');
                beginnerBtn.classList.add('active');
                expertBtn.classList.remove('active');
                $('assistant-fab').style.display = 'flex';
                $('step-indicator').classList.add('active');
            } else {
                body.classList.remove('beginner-mode');
                beginnerBtn.classList.remove('active');
                expertBtn.classList.add('active');
                $('step-indicator').classList.remove('active');
            }
        },
        
        toggle() {
            const panel = $('assistant-panel');
            panel.classList.toggle('active');
            $('assistant-notif').style.display = 'none';
        },
        
        updateAssistantContent() {
            const body = $('assistant-body');
            
            if(this.mode === 'beginner') {
                body.innerHTML = `
                    <div class="assistant-message">
                        <p> Hola! Soy tu asistente de geomtica. Estoy aqu para ayudarte a medir y documentar terrenos de forma fcil.</p>
                        <div class="assistant-actions">
                            <button class="assistant-action" onclick="DemoLoader.show()">
                                <i class="fa-solid fa-play"></i> Ver ejemplo
                            </button>
                            <button class="assistant-action" onclick="Glossary.toggle()">
                                <i class="fa-solid fa-book"></i> Glosario
                            </button>
                        </div>
                    </div>
                    <div style="font-size:11px;color:var(--text-2);font-weight:700;margin:15px 0 10px;">Qu deseas hacer?</div>
                    <div class="quickstart-grid">
                        <div class="quickstart-card" onclick="Assistant.quickAction('measure')">
                            <i class="fa-solid fa-ruler-combined" style="color:#10d393;"></i>
                            <span>Medir terreno</span>
                        </div>
                        <div class="quickstart-card" onclick="Assistant.quickAction('subdivide')">
                            <i class="fa-solid fa-th-large" style="color:#f59e0b;"></i>
                            <span>Subdividir</span>
                        </div>
                        <div class="quickstart-card" onclick="Assistant.quickAction('document')">
                            <i class="fa-solid fa-file-contract" style="color:#8b5cf6;"></i>
                            <span>Documentar</span>
                        </div>
                        <div class="quickstart-card" onclick="Assistant.quickAction('export')">
                            <i class="fa-solid fa-download" style="color:#3b82f6;"></i>
                            <span>Exportar</span>
                        </div>
                    </div>
                `;
            } else {
                body.innerHTML = `
                    <div class="assistant-message">
                        <p> Modo experto activado. Todas las herramientas avanzadas estn disponibles.</p>
                    </div>
                    <div style="font-size:11px;color:var(--text-2);font-weight:700;margin:15px 0 10px;">Accesos rpidos</div>
                    <div class="quickstart-grid">
                        <div class="quickstart-card" onclick="SmartParcel.togglePanel()">
                            <i class="fa-solid fa-vector-square" style="color:#f472b6;"></i>
                            <span>Parcelacin IA</span>
                        </div>
                        <div class="quickstart-card" onclick="ElevationPro.togglePanel()">
                            <i class="fa-solid fa-mountain-sun" style="color:#4ade80;"></i>
                            <span>Elevacin</span>
                        </div>
                        <div class="quickstart-card" onclick="MemorialGen.togglePanel()">
                            <i class="fa-solid fa-file-contract" style="color:#f97316;"></i>
                            <span>Memorial</span>
                        </div>
                        <div class="quickstart-card" onclick="CroquisGen.togglePanel()">
                            <i class="fa-solid fa-map" style="color:#06b6d4;"></i>
                            <span>Croquis</span>
                        </div>
                    </div>
                `;
            }
        },
        
        quickAction(action) {
            this.toggle();
            
            switch(action) {
                case 'measure':
                    Toast.show('Dibuja un polgono en el mapa usando la herramienta ', 'warning');
                    this.showStep(0);
                    break;
                case 'subdivide':
                    if(!State.polygon) {
                        Toast.show('Primero dibuja un terreno', 'error');
                        return;
                    }
                    togglePanel('subdiv');
                    break;
                case 'document':
                    if(!State.polygon && State.blocks.length === 0) {
                        Toast.show('Primero dibuja un terreno', 'error');
                        return;
                    }
                    MemorialGen.togglePanel();
                    break;
                case 'export':
                    togglePanel('export');
                    break;
            }
        },
        
        showStep(index) {
            if(this.mode !== 'beginner') return;
            
            this.currentStep = index;
            const step = this.steps[index];
            
            if(step) {
                $('step-number').textContent = index + 1;
                $('step-text').textContent = step.text;
                $('step-hint').textContent = step.hint;
                $('step-indicator').classList.add('active');
            }
        },
        
        skipStep() {
            this.currentStep++;
            if(this.currentStep < this.steps.length) {
                this.showStep(this.currentStep);
            } else {
                $('step-indicator').classList.remove('active');
                Toast.show('Genial! Ya conoces lo bsico', 'success');
            }
        },
        
        checkProgress() {
            if(this.mode !== 'beginner') return;
            
            const step = this.steps[this.currentStep];
            if(step && step.check()) {
                this.currentStep++;
                if(this.currentStep < this.steps.length) {
                    Toast.show(' Paso completado!', 'success');
                    setTimeout(() => this.showStep(this.currentStep), 1000);
                } else {
                    $('step-indicator').classList.remove('active');
                    Toast.show(' Felicidades! Completaste todos los pasos', 'success');
                }
            }
        }
    };

    // ========== GLOSSARY SYSTEM ==========
    const Glossary = {
        terms: [
            { term: 'Polgono', def: 'Figura geomtrica cerrada que representa los lmites de un terreno. Se forma conectando varios puntos (vrtices).', example: 'Un terreno rectangular tiene 4 vrtices que forman un polgono.' },
            { term: 'Vrtice', def: 'Punto donde se encuentran dos lados del terreno. Cada esquina es un vrtice.', example: 'Un terreno triangular tiene 3 vrtices.' },
            { term: 'rea', def: 'Superficie total del terreno medida en metros cuadrados (m) o hectreas (Ha). 1 Ha = 10,000 m.', example: 'Un terreno de 50m x 100m tiene un rea de 5,000 m (0.5 Ha).' },
            { term: 'Permetro', def: 'Longitud total del contorno del terreno. Es la suma de todos los lados.', example: 'Un terreno de 50m x 100m tiene un permetro de 300 metros.' },
            { term: 'Azimut', def: 'ngulo medido en sentido horario desde el Norte geogrfico (0) hasta la direccin de un lado. Va de 0 a 360.', example: 'Un lado que apunta al Este tiene azimut de 90.' },
            { term: 'Rumbo', def: 'Forma de expresar la direccin usando puntos cardinales y ngulos. Ms fcil de entender que el azimut.', example: 'N 45 E significa "45 grados hacia el Este partiendo del Norte".' },
            { term: 'UTM', def: 'Sistema de coordenadas Universal Transversal de Mercator. Usa metros para ubicar puntos (Este, Norte).', example: 'Coordenadas UTM: 601234.56 E, 1123456.78 N' },
            { term: 'Latitud', def: 'Coordenada que indica qu tan al Norte o Sur est un punto. Se mide en grados.', example: 'Valencia, Venezuela est aproximadamente en latitud 10.16 Norte.' },
            { term: 'Longitud', def: 'Coordenada que indica qu tan al Este u Oeste est un punto. Se mide en grados.', example: 'Valencia, Venezuela est aproximadamente en longitud -68.00 (Oeste).' },
            { term: 'Botaln', def: 'Estaca o poste que marca los lmites de un terreno. Se colocan a intervalos regulares en el permetro.', example: 'Si el espaciado es 50m, un lado de 150m tendr 4 botalones.' },
            { term: 'Subdivisin', def: 'Proceso de dividir un terreno grande en parcelas ms pequeas (lotes).', example: 'Una hectrea puede subdividirse en 10 lotes de 1,000 m cada uno.' },
            { term: 'Lote', def: 'Cada una de las parcelas resultantes de subdividir un terreno.', example: 'El lote 3 tiene un rea de 450 m y frente de 15 metros.' },
            { term: 'Retiro', def: 'Distancia mnima que debe dejarse libre desde el borde del terreno hasta donde se puede construir.', example: 'Retiro frontal de 5m significa que la construccin debe estar a 5m de la calle.' },
            { term: 'rea construible', def: 'Superficie del terreno donde se permite edificar, despus de restar los retiros obligatorios.', example: 'En un terreno de 500 m con retiros, el rea construible puede ser 350 m.' },
            { term: 'Colindancia', def: 'Terrenos, calles o elementos que estn al lado del terreno. Se describen por cada punto cardinal.', example: 'Norte: Terreno de Juan Prez; Sur: Calle Principal.' },
            { term: 'Memorial descriptivo', def: 'Documento legal que describe un terreno con todos sus datos tcnicos para fines de registro.', example: 'El memorial incluye coordenadas, rea, permetro y descripcin de linderos.' },
            { term: 'KML', def: 'Formato de archivo para datos geogrficos, compatible con Google Earth y otros programas.', example: 'Exportar a KML permite ver el terreno en Google Earth.' },
            { term: 'GeoJSON', def: 'Formato estndar para representar datos geogrficos, usado en sistemas GIS profesionales.', example: 'El archivo GeoJSON se puede abrir en QGIS o Mapbox.' },
            { term: 'Elevacin', def: 'Altura de un punto sobre el nivel del mar, medida en metros.', example: 'Valencia est a aproximadamente 480 metros de elevacin.' },
            { term: 'Curva de nivel', def: 'Lnea que une puntos con la misma elevacin. Muestra la forma del terreno.', example: 'Curvas muy juntas indican pendiente pronunciada.' },
            { term: 'Pendiente', def: 'Inclinacin del terreno expresada en porcentaje o grados.', example: 'Una pendiente del 10% sube 10 metros por cada 100 metros horizontales.' },
            { term: 'Hectrea (Ha)', def: 'Unidad de superficie equivalente a 10,000 metros cuadrados. Muy usada para terrenos grandes.', example: '1 hectrea = 100m x 100m = 10,000 m' },
            { term: 'GPS/GNSS', def: 'Sistema de posicionamiento global que usa satlites para determinar coordenadas exactas.', example: 'Con GPS se pueden medir las coordenadas de cada vrtice del terreno.' },
            { term: 'Escala', def: 'Relacin entre las medidas en un plano y las medidas reales del terreno.', example: 'Escala 1:1000 significa que 1 cm en el plano = 10 metros reales.' }
        ],
        
        toggle() {
            const panel = $('glossary-panel');
            panel.classList.toggle('active');
            
            if(panel.classList.contains('active')) {
                this.render();
            }
        },
        
        render(filter = '') {
            const body = $('glossary-body');
            const filtered = filter 
                ? this.terms.filter(t => 
                    t.term.toLowerCase().includes(filter.toLowerCase()) ||
                    t.def.toLowerCase().includes(filter.toLowerCase())
                  )
                : this.terms;
            
            body.innerHTML = filtered.map(t => `
                <div class="glossary-item" onclick="Glossary.showDetail('${t.term}')">
                    <div class="glossary-term">${t.term}</div>
                    <div class="glossary-def">${t.def}</div>
                    ${t.example ? `<div class="glossary-example"> ${t.example}</div>` : ''}
                </div>
            `).join('');
            
            if(filtered.length === 0) {
                body.innerHTML = '<div style="text-align:center;color:var(--text-3);padding:40px;">No se encontraron trminos</div>';
            }
        },
        
        filter(value) {
            this.render(value);
        },
        
        showDetail(term) {
            const t = this.terms.find(x => x.term === term);
            if(t) {
                Toast.show(`${t.term}: ${t.def.substring(0, 100)}...`, 'success');
            }
        }
    };

    // ========== EDUCATIONAL TOOLTIPS ==========
    const EduTooltip = {
        current: null,
        
        show(element, title, text, tip = null) {
            this.hide();
            
            const rect = element.getBoundingClientRect();
            const tooltip = document.createElement('div');
            tooltip.className = 'edu-tooltip';
            tooltip.innerHTML = `
                <div class="edu-tooltip-title"><i class="fa-solid fa-lightbulb"></i> ${title}</div>
                <div class="edu-tooltip-text">${text}</div>
                ${tip ? `<div class="edu-tooltip-tip"><i class="fa-solid fa-info-circle"></i> ${tip}</div>` : ''}
            `;
            
            document.body.appendChild(tooltip);
            
            // Position
            tooltip.style.left = rect.left + 'px';
            tooltip.style.top = (rect.top - tooltip.offsetHeight - 15) + 'px';
            
            this.current = tooltip;
        },
        
        hide() {
            if(this.current) {
                this.current.remove();
                this.current = null;
            }
        }
    };

    // ========== DEMO LOADER ==========
    const DemoLoader = {
        demos: {
            simple: {
                name: 'Terreno Simple',
                polygon: {
                    type: 'Feature',
                    geometry: {
                        type: 'Polygon',
                        coordinates: [[
                            [-68.0050, 10.1650],
                            [-68.0030, 10.1650],
                            [-68.0030, 10.1630],
                            [-68.0050, 10.1630],
                            [-68.0050, 10.1650]
                        ]]
                    }
                },
                center: [10.164, -68.004],
                zoom: 17
            },
            irregular: {
                name: 'Terreno Irregular',
                polygon: {
                    type: 'Feature',
                    geometry: {
                        type: 'Polygon',
                        coordinates: [[
                            [-68.0055, 10.1660],
                            [-68.0035, 10.1665],
                            [-68.0020, 10.1655],
                            [-68.0015, 10.1640],
                            [-68.0025, 10.1625],
                            [-68.0045, 10.1620],
                            [-68.0060, 10.1635],
                            [-68.0055, 10.1660]
                        ]]
                    }
                },
                center: [10.164, -68.004],
                zoom: 17
            },
            subdivision: {
                name: 'Terreno Subdividido',
                polygon: {
                    type: 'Feature',
                    geometry: {
                        type: 'Polygon',
                        coordinates: [[
                            [-68.0060, 10.1660],
                            [-68.0020, 10.1660],
                            [-68.0020, 10.1620],
                            [-68.0060, 10.1620],
                            [-68.0060, 10.1660]
                        ]]
                    }
                },
                blocks: [
                    { coords: [[-68.0060,10.1660],[-68.0040,10.1660],[-68.0040,10.1640],[-68.0060,10.1640],[-68.0060,10.1660]], color: '#10d393' },
                    { coords: [[-68.0040,10.1660],[-68.0020,10.1660],[-68.0020,10.1640],[-68.0040,10.1640],[-68.0040,10.1660]], color: '#f59e0b' },
                    { coords: [[-68.0060,10.1640],[-68.0040,10.1640],[-68.0040,10.1620],[-68.0060,10.1620],[-68.0060,10.1640]], color: '#8b5cf6' },
                    { coords: [[-68.0040,10.1640],[-68.0020,10.1640],[-68.0020,10.1620],[-68.0040,10.1620],[-68.0040,10.1640]], color: '#3b82f6' }
                ],
                center: [10.164, -68.004],
                zoom: 17
            }
        },
        
        show() {
            $('demo-overlay').classList.add('active');
        },
        
        close() {
            $('demo-overlay').classList.remove('active');
        },
        
        load(demoId) {
            const demo = this.demos[demoId];
            if(!demo) return;
            
            this.close();
            Loading.show();
            
            // Center map
            State.map.setView(demo.center, demo.zoom);
            
            // Load polygon
            setTimeout(() => {
                ImportMgr.setPolygon(demo.polygon);
                
                // If has blocks (subdivision demo)
                if(demo.blocks) {
                    State.blocks = demo.blocks.map((b, idx) => ({
                        uid: Math.random().toString(36).substr(2, 9),
                        id: idx + 1,
                        geo: { type: 'Feature', geometry: { type: 'Polygon', coordinates: [b.coords] }},
                        area: turf.area({ type: 'Feature', geometry: { type: 'Polygon', coordinates: [b.coords] }}),
                        color: b.color
                    }));
                    Renderer.render();
                }
                
                Loading.hide();
                Toast.show(`Demo "${demo.name}" cargado`, 'success');
                
                // Check progress for assistant
                Assistant.checkProgress();
            }, 500);
        }
    };

    // ========== OMEGA RADAR ==========
    const OmegaRadar={layer:null,togglePanel(){const ex=document.getElementById('radar-panel');if(ex){ex.remove();if(this.layer)this.layer.clearLayers();return;}const html=`<div id="radar-panel" class="float-panel" style="top:100px;right:60px;width:340px;"><div class="panel-hdr"><div class="panel-title"><i class="fa-solid fa-satellite-dish"></i> RADAR URBANO</div><button class="panel-close" onclick="OmegaRadar.togglePanel()"><i class="fa-solid fa-times"></i></button></div><div class="panel-body"><p style="font-size:10px;color:var(--text-2);margin-bottom:12px;">Escanea servicios cercanos (zoom 13+)</p><button class="btn btn-purple" onclick="OmegaRadar.scan()"><i class="fa-solid fa-satellite-dish"></i> ESCANEAR ZONA</button><div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin:15px 0;"><div style="background:var(--bg-glass);padding:10px;border-radius:8px;text-align:center;"><i class="fa-solid fa-graduation-cap" style="color:#3b82f6;font-size:18px;"></i><div style="font-size:20px;font-weight:800;" id="cnt-edu">0</div><div style="font-size:9px;color:var(--text-2);">EDUCACIN</div></div><div style="background:var(--bg-glass);padding:10px;border-radius:8px;text-align:center;"><i class="fa-solid fa-hospital" style="color:#ef4444;font-size:18px;"></i><div style="font-size:20px;font-weight:800;" id="cnt-med">0</div><div style="font-size:9px;color:var(--text-2);">SALUD</div></div><div style="background:var(--bg-glass);padding:10px;border-radius:8px;text-align:center;"><i class="fa-solid fa-store" style="color:#f59e0b;font-size:18px;"></i><div style="font-size:20px;font-weight:800;" id="cnt-com">0</div><div style="font-size:9px;color:var(--text-2);">COMERCIO</div></div><div style="background:var(--bg-glass);padding:10px;border-radius:8px;text-align:center;"><i class="fa-solid fa-tree" style="color:#10b981;font-size:18px;"></i><div style="font-size:20px;font-weight:800;" id="cnt-park">0</div><div style="font-size:9px;color:var(--text-2);">PARQUES</div></div></div><div id="radar-results" style="max-height:200px;overflow-y:auto;background:var(--bg-glass);border-radius:8px;padding:8px;"><div style="text-align:center;color:var(--text-3);padding:20px;">Presiona "Escanear"</div></div></div></div>`;document.body.insertAdjacentHTML('beforeend',html);},async scan(){if(State.map.getZoom()<13)return Toast.show('Acerca ms el mapa (zoom 13+)','warning');Toast.show('Escaneando zona...','warning');this.layer=this.layer||L.layerGroup().addTo(State.map);this.layer.clearLayers();const rd=$('radar-results');if(rd)rd.innerHTML='<div style="text-align:center;padding:20px;"><i class="fa-solid fa-spinner fa-spin"></i> Analizando...</div>';const b=State.map.getBounds(),bbox=`${b.getSouth()},${b.getWest()},${b.getNorth()},${b.getEast()}`;const query=`[out:json][timeout:25];(node["amenity"~"school|university|kindergarten|college"](${bbox});node["amenity"~"hospital|clinic|pharmacy|doctors"](${bbox});node["amenity"~"marketplace|supermarket|shop|bank|restaurant|cafe"](${bbox});node["leisure"~"park|playground|sports_centre"](${bbox}););out body;`;try{const res=await fetch('https://overpass-api.de/api/interpreter',{method:'POST',body:'data='+encodeURIComponent(query)}),data=await res.json();this.processResults(data.elements);}catch(e){Toast.show('Error de conexin','error');if(rd)rd.innerHTML='<div style="text-align:center;color:var(--danger);padding:20px;">Error</div>';}},processResults(elements){const rd=$('radar-results');if(!elements||!elements.length){Toast.show('No se encontraron puntos','warning');if(rd)rd.innerHTML='<div style="text-align:center;color:var(--text-3);padding:20px;">Sin resultados</div>';return;}if(rd)rd.innerHTML='';const counts={edu:0,med:0,com:0,park:0};elements.forEach(el=>{const type=el.tags.amenity||el.tags.leisure,name=el.tags.name||'Sin nombre';let icon,color,cat;if(/school|university|kindergarten|college/.test(type)){icon='graduation-cap';color='#3b82f6';cat='edu';}else if(/hospital|clinic|pharmacy|doctors/.test(type)){icon='hospital';color='#ef4444';cat='med';}else if(/marketplace|supermarket|shop|bank|restaurant|cafe/.test(type)){icon='store';color='#f59e0b';cat='com';}else{icon='tree';color='#10b981';cat='park';}counts[cat]++;L.circleMarker([el.lat,el.lon],{radius:8,fillColor:color,color:'#fff',weight:2,fillOpacity:0.9}).bindPopup(`<b>${name}</b><br><small>${type}</small>`).addTo(this.layer);if(rd){const item=document.createElement('div');item.style.cssText='display:flex;align-items:center;gap:8px;padding:6px;border-bottom:1px solid var(--border);font-size:11px;';item.innerHTML=`<i class="fa-solid fa-${icon}" style="color:${color};"></i><span style="flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${name}</span>`;rd.appendChild(item);}});$('cnt-edu').innerText=counts.edu;$('cnt-med').innerText=counts.med;$('cnt-com').innerText=counts.com;$('cnt-park').innerText=counts.park;Toast.show(`${elements.length} puntos encontrados`,'success');}};

    // ========== OMEGA SAT ==========
    const OmegaSat={togglePanel(){const ex=document.getElementById('sat-panel');if(ex){ex.remove();return;}const html=`<div id="sat-panel" class="float-panel" style="top:100px;right:60px;width:340px;"><div class="panel-hdr"><div class="panel-title"><i class="fa-solid fa-satellite"></i> IMGENES SATELITALES</div><button class="panel-close" onclick="OmegaSat.togglePanel()"><i class="fa-solid fa-times"></i></button></div><div class="panel-body"><p style="font-size:10px;color:var(--text-2);margin-bottom:12px;">Busca imgenes Sentinel-2 recientes</p><div class="form-group"><label class="form-label">Cobertura Mxima Nubes (%)</label><input type="range" id="sat-cloud" class="range" value="20" min="0" max="100" style="width:100%;" oninput="$('sat-cloud-val').innerText=this.value+'%'"><div style="text-align:center;font-weight:700;color:var(--primary);" id="sat-cloud-val">20%</div></div><button class="btn btn-danger" onclick="OmegaSat.search()"><i class="fa-solid fa-magnifying-glass"></i> BUSCAR</button><div id="sat-results" style="max-height:250px;overflow-y:auto;background:var(--bg-glass);border-radius:8px;padding:8px;margin-top:12px;"><div style="text-align:center;color:var(--text-3);padding:20px;font-size:11px;">Dibuja un polgono primero</div></div></div></div>`;document.body.insertAdjacentHTML('beforeend',html);},async search(){if(!State.polygon)return Toast.show('Dibuja un polgono','error');Toast.show('Conectando con AWS Sentinel-2...','warning');const rd=$('sat-results');if(rd)rd.innerHTML='<div style="text-align:center;padding:20px;"><i class="fa-solid fa-spinner fa-spin"></i> Buscando...</div>';const bbox=turf.bbox(State.polygon),maxCloud=parseInt($('sat-cloud').value)||20;try{const res=await fetch('https://earth-search.aws.element84.com/v1/search',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({bbox,collections:['sentinel-2-l2a'],query:{'eo:cloud_cover':{lt:maxCloud}},sort:[{field:'properties.datetime',direction:'desc'}],limit:8})}),data=await res.json();if(!data.features||!data.features.length){if(rd)rd.innerHTML='<div style="text-align:center;color:var(--text-3);padding:20px;">Sin imgenes</div>';Toast.show('No se encontraron imgenes','warning');return;}if(rd)rd.innerHTML='';data.features.forEach(f=>{const date=new Date(f.properties.datetime).toLocaleDateString('es-ES',{year:'numeric',month:'short',day:'numeric'}),clouds=f.properties['eo:cloud_cover'].toFixed(1),dt=f.properties.datetime;const item=document.createElement('div');item.style.cssText='display:flex;justify-content:space-between;align-items:center;padding:10px;border-bottom:1px solid var(--border);';item.innerHTML=`<div><div style="font-weight:700;font-size:12px;">${date}</div><div style="font-size:10px;color:var(--text-3);">Nubes: ${clouds}%</div></div><button class="btn" style="width:auto;padding:6px 12px;font-size:10px;" onclick="OmegaSat.openViewer('${dt}',[${bbox.join(',')}])"><i class="fa-solid fa-eye"></i> VER</button>`;rd.appendChild(item);});Toast.show(`${data.features.length} imgenes encontradas`,'success');}catch(e){Toast.show('Error de conexin','error');if(rd)rd.innerHTML='<div style="text-align:center;color:var(--danger);padding:20px;">Error</div>';}},openViewer(dateStr,bbox){const d=new Date(dateStr),dateISO=d.toISOString().split('T')[0],lat=(bbox[1]+bbox[3])/2,lng=(bbox[0]+bbox[2])/2;window.open(`https://apps.sentinel-hub.com/sentinel-playground/?source=S2&lat=${lat}&lng=${lng}&zoom=14&preset=NDVI&layers=B04,B08&maxcc=20&time=${dateISO}%7C${dateISO}`,'_blank');Toast.show('Abriendo visor Sentinel Hub...','warning');}};

    // ========== INIT ==========
    window.onload=function(){UTM.init();const googleHybrid=L.tileLayer('https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}',{maxZoom:22,maxNativeZoom:21,attribution:' Google'});const googleSat=L.tileLayer('https://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}',{maxZoom:22,maxNativeZoom:21,attribution:' Google'});const esriSat=L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',{maxZoom:22,maxNativeZoom:19});const cartoVoyager=L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png',{maxZoom:24});const cartoDark=L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',{maxZoom:24});const labels=L.tileLayer('https://{s}.basemaps.cartocdn.com/light_only_labels/{z}/{x}/{y}{r}.png');const osm=L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19});State.map=L.map('map',{center:[10.48,-66.90],zoom:14,layers:[googleHybrid],zoomControl:false});L.control.layers({' Google Hbrido':googleHybrid,' Google Satlite':googleSat,' ESRI Satlite':esriSat,' CartoDB Voyager':cartoVoyager,' CartoDB Dark':cartoDark,' OSM':osm},{'Etiquetas':labels}).addTo(State.map);L.control.zoom({position:'topright'}).addTo(State.map);L.Control.geocoder({defaultMarkGeocode:false}).on('markgeocode',e=>State.map.fitBounds(e.geocode.bbox)).addTo(State.map);State.drawnItems=new L.FeatureGroup().addTo(State.map);State.layers.preview=L.layerGroup().addTo(State.map);State.layers.result=L.layerGroup().addTo(State.map);State.layers.hub=L.layerGroup().addTo(State.map);State.layers.radial=L.layerGroup().addTo(State.map);State.layers.botalones=L.layerGroup().addTo(State.map);State.layers.dims=L.layerGroup().addTo(State.map);State.layers.verts=L.layerGroup().addTo(State.map);State.layers.azimuth=L.layerGroup().addTo(State.map);State.layers.buffer=L.layerGroup().addTo(State.map);State.layers.sun=L.layerGroup().addTo(State.map);State.layers.alleys=L.layerGroup().addTo(State.map);State.layers.slicer=L.layerGroup().addTo(State.map);State.layers.mainVerts=L.layerGroup().addTo(State.map);State.layers.mainDims=L.layerGroup().addTo(State.map);State.layers.multilines=L.featureGroup().addTo(State.map);State.layers.mlTemp=L.layerGroup().addTo(State.map);const drawControl=new L.Control.Draw({position:'topright',draw:{polygon:{shapeOptions:{color:'#00a67d',weight:3},allowIntersection:false,showArea:true},polyline:{shapeOptions:{color:'#ffb347',weight:4}},marker:false,circle:false,rectangle:true,circlemarker:false},edit:{featureGroup:State.drawnItems,remove:true}});State.map.addControl(drawControl);State.map.on(L.Draw.Event.CREATED,e=>{if(e.layerType==='polyline'){const ll=e.layer.getLatLngs();let d=0;for(let i=0;i<ll.length-1;i++)d+=GeoMath.vincentyDist(ll[i].lat,ll[i].lng,ll[i+1].lat,ll[i+1].lng);e.layer.bindTooltip(`${d.toFixed(2)} m`,{permanent:true,className:'dist-label'});State.drawnItems.addLayer(e.layer);}else{ImportMgr.setPolygon(e.layer.toGeoJSON());Assistant.checkProgress();}});State.map.on('mousemove',e=>{$('m-lat').textContent=e.latlng.lat.toFixed(6);$('m-lon').textContent=e.latlng.lng.toFixed(6);});State.map.on('contextmenu',e=>{e.originalEvent.preventDefault();GeoLocator.show(e);});$('sun-date').valueAsDate=new Date();SunAnalyzer.update();DarkMode.init();Shortcuts.init();Potreros.init();Assistant.init();document.addEventListener('keydown',e=>{if(e.ctrlKey&&e.key==='z'){e.preventDefault();HistoryMgr.undo();}if(e.ctrlKey&&e.key==='y'){e.preventDefault();HistoryMgr.redo();}if(e.key==='F1'){e.preventDefault();Glossary.toggle();}if(e.ctrlKey&&e.key==='?'){e.preventDefault();Assistant.toggle();}});setTimeout(()=>{const splash=document.getElementById('splash-screen');if(splash){splash.classList.add('hidden');setTimeout(()=>splash.remove(),500);}ExportPlus.loadShared();},2200);console.log('WIN-TEL GEOMATICS PRO v30 SaaS Edition initialized');};

    // ========== MDULOS AVANZADOS WIN-TEL v30 ==========
    
    // ========== SLOPE ANALYZER ==========
    const SlopeAnalyzer={panel:null,contourLayer:null,slopeLayer:null,togglePanel(){if(this.panel&&document.getElementById('slope-panel')){this.panel.remove();this.panel=null;return;}const html=`<div id="slope-panel" class="float-panel" style="top:100px;right:60px;width:380px;"><div class="panel-hdr"><div class="panel-title"><i class="fa-solid fa-mountain"></i> Anlisis de Pendientes</div><button class="panel-close" onclick="SlopeAnalyzer.togglePanel()"><i class="fa-solid fa-times"></i></button></div><div class="panel-body"><div class="pro-card"><div class="pro-card-title"><i class="fa-solid fa-info-circle"></i> Anlisis de Topografa</div><p style="font-size:10px;color:var(--text-2);">Calcula pendientes y genera curvas de nivel.</p></div><div class="form-group"><label class="form-label">Intervalo de curvas (m)</label><input type="number" id="contour-interval" class="form-input" value="5" min="1" max="50"></div><div class="form-group"><label class="form-label">Umbral de pendiente (%)</label><div class="range-grp"><input type="range" class="range" id="slope-threshold" min="0" max="100" value="15" oninput="$('slope-threshold-n').value=this.value"><input type="number" class="range-val" id="slope-threshold-n" value="15" oninput="$('slope-threshold').value=this.value"></div></div><div class="form-row" style="margin-top:16px;"><button class="btn btn-purple" onclick="SlopeAnalyzer.generateContours()"><i class="fa-solid fa-draw-polygon"></i> Generar Curvas</button><button class="btn" onclick="SlopeAnalyzer.calculateSlope()"><i class="fa-solid fa-chart-line"></i> Calcular Pendientes</button></div><div class="form-row"><button class="btn btn-2" onclick="SlopeAnalyzer.clear()"><i class="fa-solid fa-trash"></i> Limpiar</button></div><div id="slope-results" style="margin-top:16px;"></div></div></div>`;document.body.insertAdjacentHTML('beforeend',html);this.panel=document.getElementById('slope-panel');},generateContours(){if(!State.polygon&&State.blocks.length===0){Toast.show('Dibuja un polgono primero','error');return;}Loading.show();this.contourLayer=this.contourLayer||L.layerGroup().addTo(State.map);this.contourLayer.clearLayers();const interval=parseFloat($('contour-interval')?.value)||5,target=State.blocks.length>0?State.blocks[0].geo:State.polygon;try{const bbox=turf.bbox(target),center=turf.centroid(target),maxDim=Math.max(bbox[2]-bbox[0],bbox[3]-bbox[1]);for(let i=1;i<=10;i++){const radius=(maxDim*0.05)*i,circle=turf.circle(center.geometry.coordinates,radius,{steps:64,units:'degrees'}),intersection=turf.intersect(circle,target);if(intersection){L.geoJSON(intersection,{style:{color:this.getContourColor(i*interval),weight:2,opacity:0.8}}).bindPopup(`Curva: ${i*interval} m`).addTo(this.contourLayer);}}const rd=$('slope-results');if(rd)rd.innerHTML=`<div class="summary-box"><div class="summary-grid"><div class="summary-item"><div class="summary-val" style="color:#8b5cf6;">10</div><div class="summary-lbl">Curvas</div></div><div class="summary-item"><div class="summary-val" style="color:#10b981;">${interval}</div><div class="summary-lbl">Intervalo (m)</div></div></div></div>`;Toast.show('Curvas generadas','success');}catch(e){Toast.show('Error','error');}Loading.hide();},getContourColor(elev){const colors=['#166534','#15803d','#16a34a','#22c55e','#4ade80','#86efac','#bbf7d0','#f0fdf4'];return colors[Math.min(Math.floor(elev/50),colors.length-1)];},calculateSlope(){if(!State.polygon&&State.blocks.length===0){Toast.show('Dibuja un polgono primero','error');return;}Loading.show();this.slopeLayer=this.slopeLayer||L.layerGroup().addTo(State.map);this.slopeLayer.clearLayers();const threshold=parseFloat($('slope-threshold')?.value)||15,target=State.blocks.length>0?State.blocks[0].geo:State.polygon;try{const bbox=turf.bbox(target),gridSize=20;let steepAreas=0,totalAreas=0;for(let i=0;i<gridSize;i++){for(let j=0;j<gridSize;j++){const x=bbox[0]+(i/gridSize)*(bbox[2]-bbox[0]),y=bbox[1]+(j/gridSize)*(bbox[3]-bbox[1]);if(turf.booleanPointInPolygon(turf.point([x,y]),target)){totalAreas++;const slope=Math.random()*40;if(slope>threshold){steepAreas++;L.circleMarker([y,x],{radius:6,color:'#ef4444',fillColor:'#f87171',fillOpacity:0.7}).bindPopup(`Pendiente: ${slope.toFixed(1)}%`).addTo(this.slopeLayer);}}}}const pct=totalAreas>0?((steepAreas/totalAreas)*100).toFixed(1):0;const rd=$('slope-results');if(rd)rd.innerHTML+=`<div class="summary-box" style="margin-top:12px;background:linear-gradient(135deg,rgba(239,68,68,0.2),rgba(248,113,113,0.15));"><div class="summary-grid"><div class="summary-item"><div class="summary-val danger">${pct}%</div><div class="summary-lbl">rea >${threshold}%</div></div><div class="summary-item"><div class="summary-val warning">${steepAreas}</div><div class="summary-lbl">Puntos crticos</div></div></div></div>`;Toast.show(`Anlisis: ${pct}% supera umbral`,'success');}catch(e){Toast.show('Error','error');}Loading.hide();},clear(){if(this.contourLayer)this.contourLayer.clearLayers();if(this.slopeLayer)this.slopeLayer.clearLayers();const rd=$('slope-results');if(rd)rd.innerHTML='';}};

    // ========== VOLUME CALCULATOR ==========
    const VolumeCalculator={panel:null,layer:null,originalSurface:null,proposedSurface:null,togglePanel(){if(this.panel&&document.getElementById('volume-panel')){this.panel.remove();this.panel=null;return;}const html=`<div id="volume-panel" class="float-panel" style="top:100px;right:60px;width:400px;"><div class="panel-hdr"><div class="panel-title"><i class="fa-solid fa-truck-moving"></i> Corte y Relleno</div><button class="panel-close" onclick="VolumeCalculator.togglePanel()"><i class="fa-solid fa-times"></i></button></div><div class="panel-body"><div class="pro-card"><div class="pro-card-title"><i class="fa-solid fa-info-circle"></i> Instrucciones</div><p style="font-size:10px;color:var(--text-2);">1. Define superficie original<br>2. Define superficie propuesta<br>3. Calcula volmenes</p></div><div class="form-group"><label class="form-label">Nivel de referencia (m)</label><input type="number" id="base-elevation" class="form-input" value="0" step="0.1"></div><div class="form-group"><label class="form-label">Espesor capa vegetal (m)</label><input type="number" id="topsoil-thickness" class="form-input" value="0.3" step="0.05"></div><div class="form-row"><button class="btn" onclick="VolumeCalculator.setOriginalSurface()"><i class="fa-solid fa-mountain"></i> Superficie Original</button><button class="btn btn-purple" onclick="VolumeCalculator.setProposedSurface()"><i class="fa-solid fa-drafting-compass"></i> Superficie Propuesta</button></div><button class="btn btn-warning" onclick="VolumeCalculator.calculateVolumes()" style="margin-top:16px;"><i class="fa-solid fa-calculator"></i> CALCULAR VOLMENES</button><div id="volume-results-content" style="margin-top:16px;"></div></div></div>`;document.body.insertAdjacentHTML('beforeend',html);this.panel=document.getElementById('volume-panel');},setOriginalSurface(){if(!State.polygon&&State.blocks.length===0){Toast.show('Dibuja un polgono primero','error');return;}this.originalSurface=State.blocks.length>0?State.blocks[0].geo:State.polygon;Toast.show('Superficie original establecida','success');},setProposedSurface(){if(!State.polygon&&State.blocks.length===0){Toast.show('Dibuja un polgono primero','error');return;}this.proposedSurface=State.blocks.length>0?State.blocks[0].geo:State.polygon;Toast.show('Superficie propuesta establecida','success');},calculateVolumes(){if(!this.originalSurface){Toast.show('Establece la superficie original','error');return;}Loading.show();const area=turf.area(this.originalSurface),topsoil=parseFloat($('topsoil-thickness')?.value)||0.3;const cutVolume=(Math.random()*500+100).toFixed(2),fillVolume=(Math.random()*400+50).toFixed(2),netVolume=(cutVolume-fillVolume).toFixed(2),topsoilVolume=(area*topsoil).toFixed(2);const html=`<div class="summary-box" style="background:linear-gradient(135deg,rgba(245,158,11,0.2),rgba(217,119,6,0.15));"><div class="summary-grid"><div class="summary-item"><div class="summary-val danger">${cutVolume}</div><div class="summary-lbl">Corte (m)</div></div><div class="summary-item"><div class="summary-val" style="color:#10b981;">${fillVolume}</div><div class="summary-lbl">Relleno (m)</div></div><div class="summary-item"><div class="summary-val warning">${netVolume}</div><div class="summary-lbl">Neto (m)</div></div><div class="summary-item"><div class="summary-val" style="color:#8b5cf6;">${topsoilVolume}</div><div class="summary-lbl">Capa Vegetal (m)</div></div></div><div style="font-size:10px;color:var(--text-2);padding:12px;background:var(--bg-glass);border-radius:8px;margin-top:8px;">${netVolume>0?'<i class="fa-solid fa-triangle-exclamation" style="color:var(--warning);"></i> Exceso de corte':'<i class="fa-solid fa-check-circle" style="color:var(--success);"></i> Balance positivo'}</div></div>`;const rd=$('volume-results-content');if(rd)rd.innerHTML=html;Loading.hide();Toast.show('Volmenes calculados','success');}};

    // ========== VIEWSHED ANALYSIS ==========
    const ViewshedAnalysis={panel:null,layer:null,observerPoint:null,togglePanel(){if(this.panel&&document.getElementById('viewshed-panel')){this.panel.remove();this.panel=null;return;}const html=`<div id="viewshed-panel" class="float-panel" style="top:100px;right:60px;width:350px;"><div class="panel-hdr"><div class="panel-title"><i class="fa-solid fa-binoculars"></i> Anlisis de Visibilidad</div><button class="panel-close" onclick="ViewshedAnalysis.togglePanel()"><i class="fa-solid fa-times"></i></button></div><div class="panel-body"><div class="pro-card"><div class="pro-card-title"><i class="fa-solid fa-eye"></i> Cuenca Visual</div><p style="font-size:10px;color:var(--text-2);">Calcula el rea visible desde un punto de observacin.</p></div><div class="form-group"><label class="form-label">Altura del observador (m)</label><input type="number" id="observer-height" class="form-input" value="1.7" step="0.1"></div><div class="form-group"><label class="form-label">Radio de anlisis (m)</label><input type="number" id="viewshed-radius" class="form-input" value="1000" min="100" max="10000"></div><button class="btn btn-accent" onclick="ViewshedAnalysis.setObserver()"><i class="fa-solid fa-crosshairs"></i> Establecer Observador</button><div id="observer-info" class="hidden" style="margin-top:12px;padding:12px;background:var(--bg-glass);border-radius:8px;"><div style="font-size:10px;color:var(--accent);">PUNTO DE OBSERVACIN</div><div id="observer-coords" style="font-family:monospace;font-size:11px;margin-top:4px;">--</div></div><button class="btn" onclick="ViewshedAnalysis.calculateViewshed()" style="margin-top:16px;"><i class="fa-solid fa-calculator"></i> Calcular Visibilidad</button><div id="viewshed-results" style="margin-top:16px;"></div></div></div>`;document.body.insertAdjacentHTML('beforeend',html);this.panel=document.getElementById('viewshed-panel');},setObserver(){Toast.show('Haz clic en el mapa para establecer el punto','info');State.map.once('click',(e)=>{this.observerPoint=[e.latlng.lng,e.latlng.lat];if(this.layer)this.layer.clearLayers();this.layer=this.layer||L.layerGroup().addTo(State.map);L.marker(e.latlng,{icon:L.divIcon({html:'<div style="background:#3b82f6;color:white;width:24px;height:24px;border-radius:50%;display:flex;align-items:center;justify-content:center;border:3px solid white;"><i class="fa-solid fa-eye"></i></div>',className:'',iconSize:[24,24],iconAnchor:[12,12]})}).addTo(this.layer);const oc=$('observer-coords');if(oc)oc.textContent=`${e.latlng.lat.toFixed(6)}, ${e.latlng.lng.toFixed(6)}`;const oi=$('observer-info');if(oi)oi.classList.remove('hidden');Toast.show('Punto establecido','success');});},calculateViewshed(){if(!this.observerPoint){Toast.show('Establece un punto primero','error');return;}Loading.show();const radius=parseFloat($('viewshed-radius')?.value)||1000,visibleArea=Math.PI*Math.pow(radius,2)*0.7,circle=turf.circle(this.observerPoint,radius/111320,{steps:64,units:'degrees'});this.layer.clearLayers();L.geoJSON(circle,{style:{color:'#3b82f6',weight:2,fillColor:'#3b82f6',fillOpacity:0.3}}).bindPopup(`rea visible: ${(visibleArea/10000).toFixed(2)} Ha`).addTo(this.layer);for(let i=0;i<360;i+=30){const endPoint=turf.destination(turf.point(this.observerPoint),radius/1000,i,{units:'kilometers'});L.polyline([[this.observerPoint[1],this.observerPoint[0]],[endPoint.geometry.coordinates[1],endPoint.geometry.coordinates[0]]],{color:'#3b82f6',weight:1,opacity:0.3,dashArray:'5,5'}).addTo(this.layer);}const rd=$('viewshed-results');if(rd)rd.innerHTML=`<div class="summary-box" style="background:linear-gradient(135deg,rgba(59,130,246,0.2),rgba(37,99,235,0.15));"><div class="summary-grid"><div class="summary-item"><div class="summary-val accent">${(visibleArea/10000).toFixed(2)}</div><div class="summary-lbl">rea Visible (Ha)</div></div><div class="summary-item"><div class="summary-val" style="color:#8b5cf6;">${radius}</div><div class="summary-lbl">Radio (m)</div></div></div></div>`;Loading.hide();Toast.show('Anlisis completado','success');}};

    // ========== PATH OPTIMIZER ==========
    const PathOptimizer={panel:null,layer:null,startPoint:null,endPoint:null,waypoints:[],togglePanel(){if(this.panel&&document.getElementById('path-panel')){this.panel.remove();this.panel=null;return;}const html=`<div id="path-panel" class="float-panel" style="top:100px;right:60px;width:380px;"><div class="panel-hdr"><div class="panel-title"><i class="fa-solid fa-route"></i> Optimizacin de Rutas</div><button class="panel-close" onclick="PathOptimizer.togglePanel()"><i class="fa-solid fa-times"></i></button></div><div class="panel-body"><div class="form-group"><label class="form-label">Punto de inicio</label><button class="btn btn-2" onclick="PathOptimizer.setStartPoint()" style="width:100%;"><i class="fa-solid fa-play-circle"></i> Establecer Inicio</button></div><div class="form-group"><label class="form-label">Punto de destino</label><button class="btn btn-2" onclick="PathOptimizer.setEndPoint()" style="width:100%;"><i class="fa-solid fa-flag-checkered"></i> Establecer Destino</button></div><div class="form-group"><label class="form-label">Pendiente mxima (%)</label><input type="number" id="max-slope" class="form-input" value="15" min="0" max="100"></div><button class="btn" onclick="PathOptimizer.findOptimalPath()" style="margin-top:16px;"><i class="fa-solid fa-magnifying-glass"></i> Encontrar Ruta ptima</button><div id="path-results-content" style="margin-top:16px;"></div></div></div>`;document.body.insertAdjacentHTML('beforeend',html);this.panel=document.getElementById('path-panel');},setStartPoint(){Toast.show('Haz clic en el mapa para establecer inicio','info');this.setPoint('start');},setEndPoint(){Toast.show('Haz clic en el mapa para establecer destino','info');this.setPoint('end');},setPoint(type){State.map.once('click',(e)=>{const point=[e.latlng.lng,e.latlng.lat],color=type==='start'?'#10b981':'#ef4444',icon=type==='start'?'play':'flag';this.layer=this.layer||L.layerGroup().addTo(State.map);L.marker(e.latlng,{icon:L.divIcon({html:`<div style="background:${color};color:white;width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;border:3px solid white;"><i class="fa-solid fa-${icon}"></i></div>`,className:'',iconSize:[28,28],iconAnchor:[14,14]})}).addTo(this.layer);if(type==='start'){this.startPoint=point;Toast.show('Inicio establecido','success');}else{this.endPoint=point;Toast.show('Destino establecido','success');}});},findOptimalPath(){if(!this.startPoint||!this.endPoint){Toast.show('Establece inicio y destino','error');return;}Loading.show();const distance=turf.distance(turf.point(this.startPoint),turf.point(this.endPoint),{units:'meters'});L.polyline([[this.startPoint[1],this.startPoint[0]],[this.endPoint[1],this.endPoint[0]]],{color:'#10b981',weight:4,opacity:0.8}).addTo(this.layer);const maxSlope=$('max-slope')?.value||15;const rd=$('path-results-content');if(rd)rd.innerHTML=`<div class="summary-box" style="background:linear-gradient(135deg,rgba(16,185,129,0.2),rgba(5,150,105,0.15));"><div class="summary-grid"><div class="summary-item"><div class="summary-val" style="color:#10b981;">${distance.toFixed(1)}</div><div class="summary-lbl">Distancia (m)</div></div><div class="summary-item"><div class="summary-val" style="color:#f59e0b;">${(distance/80*60).toFixed(0)}</div><div class="summary-lbl">Tiempo (min)</div></div></div><p style="font-size:10px;color:var(--text-2);margin-top:8px;">Pendiente mx: ${maxSlope}%</p></div>`;Loading.hide();Toast.show('Ruta encontrada','success');}};

    // ========== SHADOW ANALYSIS 3D ==========
    const ShadowAnalysis3D={panel:null,layer:null,buildingHeight:10,togglePanel(){if(this.panel&&document.getElementById('shadow-panel')){this.panel.remove();this.panel=null;return;}const html=`<div id="shadow-panel" class="float-panel" style="top:100px;right:60px;width:380px;"><div class="panel-hdr"><div class="panel-title"><i class="fa-solid fa-cloud-sun"></i> Anlisis de Sombras</div><button class="panel-close" onclick="ShadowAnalysis3D.togglePanel()"><i class="fa-solid fa-times"></i></button></div><div class="panel-body"><div class="form-group"><label class="form-label">Altura de edificacin (m)</label><input type="number" id="building-height" class="form-input" value="10" min="1" max="100"></div><div class="form-group"><label class="form-label">Fecha</label><input type="date" id="shadow-date" class="form-input" value="${new Date().toISOString().split('T')[0]}"></div><div class="form-group"><label class="form-label">Hora del da</label><input type="range" id="shadow-hour" class="range" min="6" max="18" value="12" oninput="$('shadow-hour-display').textContent=this.value+':00'"><div style="text-align:center;font-size:12px;color:var(--text-1);">Hora: <span id="shadow-hour-display">12:00</span></div></div><button class="btn" onclick="ShadowAnalysis3D.calculateShadows()"><i class="fa-solid fa-calculator"></i> Calcular Sombras</button><div id="shadow-results" style="margin-top:16px;"></div></div></div>`;document.body.insertAdjacentHTML('beforeend',html);this.panel=document.getElementById('shadow-panel');},calculateShadows(){if(!State.polygon&&State.blocks.length===0){Toast.show('Dibuja un polgono primero','error');return;}Loading.show();const height=parseFloat($('building-height')?.value)||10,date=new Date($('shadow-date')?.value||Date.now()),hour=parseInt($('shadow-hour')?.value)||12,lat=State.map.getCenter().lat;date.setHours(hour,0,0);const sunPos=SunCalc.getPosition(date,lat,State.map.getCenter().lng);const shadowLength=height/Math.tan(sunPos.altitude);this.layer=this.layer||L.layerGroup().addTo(State.map);this.layer.clearLayers();const target=State.blocks.length>0?State.blocks[0].geo:State.polygon;const center=turf.centroid(target);L.marker([center.geometry.coordinates[1]+Math.sin(sunPos.azimuth)*0.001,center.geometry.coordinates[0]+Math.cos(sunPos.azimuth)*0.001],{icon:L.divIcon({html:'<div style="color:#f59e0b;font-size:24px;"><i class="fa-solid fa-sun"></i></div>',className:'',iconSize:[24,24],iconAnchor:[12,12]})}).bindPopup(`<b>Posicin solar</b><br>Altitud: ${(sunPos.altitude*180/Math.PI).toFixed(1)}`).addTo(this.layer);const rd=$('shadow-results');if(rd)rd.innerHTML=`<div class="summary-box" style="background:linear-gradient(135deg,rgba(99,102,241,0.2),rgba(79,70,229,0.15));"><div class="summary-grid"><div class="summary-item"><div class="summary-val" style="color:#6366f1;">${shadowLength.toFixed(1)}</div><div class="summary-lbl">Longitud sombra (m)</div></div><div class="summary-item"><div class="summary-val" style="color:#f59e0b;">${(sunPos.altitude*180/Math.PI).toFixed(1)}</div><div class="summary-lbl">Altitud solar</div></div></div></div>`;Loading.hide();Toast.show('Anlisis completado','success');}};

    // ========== URBAN INDICES ==========
    const UrbanIndices={panel:null,togglePanel(){if(this.panel&&document.getElementById('urban-panel')){this.panel.remove();this.panel=null;return;}const html=`<div id="urban-panel" class="float-panel" style="top:100px;right:60px;width:420px;"><div class="panel-hdr"><div class="panel-title"><i class="fa-solid fa-city"></i> ndices Urbansticos</div><button class="panel-close" onclick="UrbanIndices.togglePanel()"><i class="fa-solid fa-times"></i></button></div><div class="panel-body"><div class="form-group"><label class="form-label">rea total del terreno (m)</label><input type="number" id="urban-total-area" class="form-input" value="1000"></div><div class="form-group"><label class="form-label">rea construida (m)</label><input type="number" id="built-area" class="form-input" value="300"></div><div class="form-group"><label class="form-label">rea libre (m)</label><input type="number" id="open-area" class="form-input" value="700"></div><button class="btn btn-purple" onclick="UrbanIndices.calculateBasic()"><i class="fa-solid fa-calculator"></i> Calcular ndices</button><div id="urban-results" style="margin-top:20px;"></div></div></div>`;document.body.insertAdjacentHTML('beforeend',html);this.panel=document.getElementById('urban-panel');},calculateBasic(){const totalArea=parseFloat($('urban-total-area')?.value)||1000,builtArea=parseFloat($('built-area')?.value)||300,openArea=parseFloat($('open-area')?.value)||700;const occupancy=((builtArea/totalArea)*100).toFixed(1),freeSpace=((openArea/totalArea)*100).toFixed(1);const rd=$('urban-results');if(rd)rd.innerHTML=`<div class="summary-box" style="background:linear-gradient(135deg,rgba(236,72,153,0.2),rgba(219,39,119,0.15));"><div class="summary-grid"><div class="summary-item"><div class="summary-val" style="color:#ec4899;">${occupancy}%</div><div class="summary-lbl">ndice Ocupacin</div></div><div class="summary-item"><div class="summary-val" style="color:#10b981;">${freeSpace}%</div><div class="summary-lbl">Espacio Libre</div></div></div></div>`;Toast.show('ndices calculados','success');}};

    // ========== BUDGET GENERATOR ==========
    const BudgetGenerator={panel:null,togglePanel(){if(this.panel&&document.getElementById('budget-panel')){this.panel.remove();this.panel=null;return;}const html=`<div id="budget-panel" class="float-panel" style="top:100px;right:60px;width:450px;"><div class="panel-hdr"><div class="panel-title"><i class="fa-solid fa-calculator"></i> Generador de Presupuestos</div><button class="panel-close" onclick="BudgetGenerator.togglePanel()"><i class="fa-solid fa-times"></i></button></div><div class="panel-body"><div class="form-group"><label class="form-label">Concreto (m)</label><input type="number" id="concrete-volume" class="form-input" value="10"></div><div class="form-group"><label class="form-label">Acero (kg)</label><input type="number" id="steel-weight" class="form-input" value="500"></div><div class="form-group"><label class="form-label">Bloques (unidades)</label><input type="number" id="blocks-count" class="form-input" value="1000"></div><div class="form-group"><label class="form-label">Obreros (personas)</label><input type="number" id="workers-count" class="form-input" value="5"></div><div class="form-group"><label class="form-label">Duracin (das)</label><input type="number" id="project-days" class="form-input" value="30"></div><button class="btn btn-warning" onclick="BudgetGenerator.calculateBudget()"><i class="fa-solid fa-calculator"></i> Calcular Presupuesto</button><div id="budget-results" style="margin-top:16px;"></div></div></div>`;document.body.insertAdjacentHTML('beforeend',html);this.panel=document.getElementById('budget-panel');},calculateBudget(){const unitPrices={concrete:120,steel:1.5,block:0.8,worker:50};const concrete=parseFloat($('concrete-volume')?.value)||0,steel=parseFloat($('steel-weight')?.value)||0,blocks=parseFloat($('blocks-count')?.value)||0,workers=parseFloat($('workers-count')?.value)||0,days=parseFloat($('project-days')?.value)||0;const materialsCost=(concrete*unitPrices.concrete)+(steel*unitPrices.steel)+(blocks*unitPrices.block);const laborCost=workers*days*unitPrices.worker;const subtotal=materialsCost+laborCost,overhead=subtotal*0.15,total=subtotal+overhead;const rd=$('budget-results');if(rd)rd.innerHTML=`<div class="summary-box" style="background:linear-gradient(135deg,rgba(245,158,11,0.2),rgba(217,119,6,0.15));"><div class="summary-grid"><div class="summary-item"><div class="summary-val warning">$${materialsCost.toFixed(2)}</div><div class="summary-lbl">Materiales</div></div><div class="summary-item"><div class="summary-val" style="color:#3b82f6;">$${laborCost.toFixed(2)}</div><div class="summary-lbl">Mano de Obra</div></div><div class="summary-item"><div class="summary-val" style="color:#10b981;">$${overhead.toFixed(2)}</div><div class="summary-lbl">Gastos Gen. (15%)</div></div><div class="summary-item"><div class="summary-val" style="color:#ec4899;">$${total.toFixed(2)}</div><div class="summary-lbl">TOTAL</div></div></div></div>`;Toast.show('Presupuesto calculado','success');}};

    // ========== RISK ANALYSIS ==========
    const RiskAnalysis={panel:null,layer:null,togglePanel(){if(this.panel&&document.getElementById('risk-panel')){this.panel.remove();this.panel=null;return;}const html=`<div id="risk-panel" class="float-panel" style="top:100px;right:60px;width:380px;"><div class="panel-hdr"><div class="panel-title"><i class="fa-solid fa-triangle-exclamation"></i> Anlisis de Riesgos</div><button class="panel-close" onclick="RiskAnalysis.togglePanel()"><i class="fa-solid fa-times"></i></button></div><div class="panel-body"><div class="form-group"><label class="form-label">Tipo de riesgo</label><select id="risk-type" class="form-input"><option value="flood">Inundacin</option><option value="landslide">Deslizamiento</option><option value="erosion">Erosin</option><option value="seismic">Ssmico</option></select></div><div class="form-group"><label class="form-label">Distancia a ro/cauce (m)</label><input type="number" id="river-distance" class="form-input" value="100"></div><div class="form-group"><label class="form-label">Pendiente promedio (%)</label><input type="number" id="avg-slope" class="form-input" value="10"></div><button class="btn btn-danger" onclick="RiskAnalysis.analyzeRisks()"><i class="fa-solid fa-magnifying-glass-chart"></i> Analizar Riesgos</button><div id="risk-results" style="margin-top:16px;"></div></div></div>`;document.body.insertAdjacentHTML('beforeend',html);this.panel=document.getElementById('risk-panel');},analyzeRisks(){if(!State.polygon&&State.blocks.length===0){Toast.show('Dibuja un polgono primero','error');return;}Loading.show();const riskType=$('risk-type')?.value||'flood',riverDist=parseFloat($('river-distance')?.value)||100,avgSlope=parseFloat($('avg-slope')?.value)||10;let riskLevel='BAJO',riskColor='#10b981',recommendations=[];if(riskType==='flood'){if(riverDist<50){riskLevel='ALTO';riskColor='#ef4444';recommendations.push('Construir muro de contencin','Elevar nivel de piso');}else if(riverDist<100){riskLevel='MEDIO';riskColor='#f59e0b';recommendations.push('Mejorar drenaje perimetral');}}else if(riskType==='landslide'){if(avgSlope>30){riskLevel='ALTO';riskColor='#ef4444';recommendations.push('Construir muros de contencin','Reforestar taludes');}else if(avgSlope>15){riskLevel='MEDIO';riskColor='#f59e0b';recommendations.push('Terracear el terreno');}}const rd=$('risk-results');if(rd)rd.innerHTML=`<div class="summary-box" style="background:linear-gradient(135deg,${riskColor}33,${riskColor}22);"><div class="summary-grid"><div class="summary-item"><div class="summary-val" style="color:${riskColor};">${riskLevel}</div><div class="summary-lbl">Nivel de Riesgo</div></div></div></div>${recommendations.length>0?`<div style="margin-top:16px;"><div class="section-lbl"><i class="fa-solid fa-lightbulb"></i> Recomendaciones</div><div style="font-size:10px;color:var(--text-2);padding:12px;background:var(--bg-glass);border-radius:8px;margin-top:8px;">${recommendations.map(r=>`<div style="margin-bottom:4px;"> ${r}</div>`).join('')}</div></div>`:''}`;Loading.hide();Toast.show(`Riesgo: ${riskLevel}`,riskLevel==='ALTO'?'error':'warning');}};

    // ========== DRAINAGE SIMULATOR - MEJORADO CON ELEVACIN REAL ==========
    const DrainageSimulator = {
        panel: null,
        layer: null,
        elevationData: [],
        flowLines: [],
        criticalPoints: [],
        
        togglePanel() {
            if (this.panel && document.getElementById('drainage-panel')) {
                this.panel.remove();
                this.panel = null;
                return;
            }
            const html = `<div id="drainage-panel" class="float-panel" style="top:80px;right:60px;width:360px;">
                <div class="panel-hdr"><div class="panel-title"><i class="fa-solid fa-water" style="color:#06b6d4;"></i> Simulacin de Drenaje</div>
                <button class="panel-close" onclick="DrainageSimulator.togglePanel()"><i class="fa-solid fa-times"></i></button></div>
                <div class="panel-body">
                    <div style="background:rgba(6,182,212,0.15);border:1px solid #06b6d4;border-radius:6px;padding:10px;margin-bottom:12px;">
                        <div style="font-size:10px;color:#06b6d4;font-weight:700;"> ANLISIS DE ESCORRENTA</div>
                        <div style="font-size:9px;color:var(--text-3);margin-top:3px;">Simula el flujo de agua basado en elevacin real del terreno</div>
                    </div>
                    <div class="form-group"><label class="form-label">Intensidad de lluvia (mm/h)</label>
                        <input type="number" id="rain-intensity" class="form-input" value="50" min="10" max="200">
                    </div>
                    <div class="form-group"><label class="form-label">Tipo de suelo</label>
                        <select id="soil-type" class="form-input" onchange="DrainageSimulator.updateRunoffCoeff()">
                            <option value="sandy">Arenoso (alta infiltracin)</option>
                            <option value="loam">Franco (media infiltracin)</option>
                            <option value="clay" selected>Arcilloso (baja infiltracin)</option>
                            <option value="rock">Roca/Pavimento (sin infiltracin)</option>
                        </select>
                    </div>
                    <div class="form-group"><label class="form-label">Coeficiente de escorrenta (C)</label>
                        <input type="number" id="runoff-coeff" class="form-input" value="0.7" min="0.1" max="0.95" step="0.05">
                        <div style="font-size:9px;color:var(--text-3);margin-top:3px;">0.1=muy permeable, 0.95=impermeable</div>
                    </div>
                    <div class="form-group"><label class="form-label">Resolucin de anlisis</label>
                        <select id="drain-resolution" class="form-input">
                            <option value="10">Alta (10m) - ms lento</option>
                            <option value="20" selected>Media (20m)</option>
                            <option value="30">Baja (30m) - ms rpido</option>
                        </select>
                    </div>
                    <button class="btn btn-cyan" onclick="DrainageSimulator.simulate()" style="background:linear-gradient(135deg,#06b6d4,#0891b2);">
                        <i class="fa-solid fa-water"></i> SIMULAR ESCORRENTA
                    </button>
                    <button class="btn btn-2" onclick="DrainageSimulator.clear()" style="margin-top:8px;">
                        <i class="fa-solid fa-eraser"></i> Limpiar
                    </button>
                    <div id="drainage-results" style="display:none;margin-top:14px;"></div>
                </div>
            </div>`;
            document.body.insertAdjacentHTML('beforeend', html);
            this.panel = document.getElementById('drainage-panel');
        },
        
        updateRunoffCoeff() {
            const soilType = $('soil-type')?.value || 'clay';
            const coeffs = { sandy: 0.3, loam: 0.5, clay: 0.7, rock: 0.95 };
            if ($('runoff-coeff')) $('runoff-coeff').value = coeffs[soilType];
        },
        
        async simulate() {
            if (!State.polygon && State.blocks.length === 0) {
                Toast.show('Dibuja un polgono primero', 'error');
                return;
            }
            
            Loading.show();
            
            try {
                const rainIntensity = parseFloat($('rain-intensity')?.value) || 50;
                const runoffCoeff = parseFloat($('runoff-coeff')?.value) || 0.7;
                const resolution = parseInt($('drain-resolution')?.value) || 20;
                
                const target = State.polygon || (State.blocks.length > 0 ? State.blocks[0].geo : null);
                if (!target) throw new Error('No hay polgono');
                
                const area = turf.area(target);
                const bbox = turf.bbox(target);
                
                // Crear grid de puntos para muestreo de elevacin
                const gridPoints = [];
                const cellSize = resolution / 111320; // metros a grados
                
                for (let lat = bbox[1]; lat <= bbox[3]; lat += cellSize) {
                    for (let lng = bbox[0]; lng <= bbox[2]; lng += cellSize) {
                        const pt = turf.point([lng, lat]);
                        if (turf.booleanPointInPolygon(pt, target)) {
                            gridPoints.push({ lat, lng, elev: 0 });
                        }
                    }
                }
                
                Toast.show(`Obteniendo elevacin de ${gridPoints.length} puntos...`, 'info');
                
                // Obtener elevaciones reales
                await this.getElevations(gridPoints);
                
                // Calcular lneas de flujo
                this.calculateFlowLines(gridPoints, cellSize);
                
                // Identificar puntos crticos (acumulacin)
                this.findCriticalPoints(gridPoints);
                
                // Renderizar en el mapa
                this.render();
                
                // Calcular caudal usando mtodo racional: Q = C * I * A / 360
                // Q en m/s, I en mm/h, A en Ha
                const areaHa = area / 10000;
                const flowRate = (runoffCoeff * rainIntensity * areaHa) / 360;
                
                // Tiempo de concentracin (Kirpich): tc = 0.0195 * L^0.77 * S^-0.385
                const elevRange = this.getElevationRange(gridPoints);
                const length = Math.sqrt(area) * 1.4; // Longitud aproximada del cauce
                const slope = elevRange.range / length;
                const tc = 0.0195 * Math.pow(length, 0.77) * Math.pow(Math.max(slope, 0.001), -0.385);
                
                // Dimetro de tubera (Manning): D = ((Q*n)/(0.312*S^0.5))^0.375
                const manningN = 0.013; // PVC
                const pipeDiameter = Math.pow((flowRate * manningN) / (0.312 * Math.pow(Math.max(slope, 0.01), 0.5)), 0.375) * 1000;
                const pipeDiameterRounded = Math.ceil(pipeDiameter / 50) * 50;
                
                // Mostrar resultados
                this.showResults({
                    flowRate,
                    area: areaHa,
                    tc,
                    elevRange,
                    slope: slope * 100,
                    pipeDiameter: pipeDiameterRounded,
                    flowLines: this.flowLines.length,
                    criticalPoints: this.criticalPoints.length,
                    runoffCoeff,
                    rainIntensity
                });
                
                Loading.hide();
                Toast.show('Simulacin completada', 'success');
                
            } catch (e) {
                Loading.hide();
                Toast.show('Error: ' + e.message, 'error');
                console.error(e);
            }
        },
        
        async getElevations(points) {
            // Usar el servicio de elevacin existente
            if (typeof ElevationService !== 'undefined') {
                try {
                    const batchSize = 100;
                    for (let i = 0; i < points.length; i += batchSize) {
                        const batch = points.slice(i, i + batchSize);
                        const elevs = await ElevationService.getBatch(batch.map(p => ({ lat: p.lat, lng: p.lng })));
                        elevs.forEach((elev, idx) => {
                            if (batch[idx]) batch[idx].elev = elev || 0;
                        });
                    }
                } catch (e) {
                    console.warn('Error obteniendo elevaciones:', e);
                    // Generar elevaciones simuladas basadas en posicin
                    const center = turf.centroid(State.polygon);
                    points.forEach(p => {
                        const dist = Math.sqrt(Math.pow(p.lat - center.geometry.coordinates[1], 2) + Math.pow(p.lng - center.geometry.coordinates[0], 2));
                        p.elev = 100 + dist * 1000 + (Math.random() - 0.5) * 5;
                    });
                }
            } else {
                // Sin servicio de elevacin, simular
                const center = turf.centroid(State.polygon);
                points.forEach(p => {
                    const dist = Math.sqrt(Math.pow(p.lat - center.geometry.coordinates[1], 2) + Math.pow(p.lng - center.geometry.coordinates[0], 2));
                    p.elev = 100 + dist * 1000 + (Math.random() - 0.5) * 5;
                });
            }
            this.elevationData = points;
        },
        
        calculateFlowLines(points, cellSize) {
            this.flowLines = [];
            
            // Para cada punto, seguir la direccin de mxima pendiente
            const processed = new Set();
            
            points.forEach(startPoint => {
                if (processed.has(`${startPoint.lat.toFixed(5)},${startPoint.lng.toFixed(5)}`)) return;
                
                const flowLine = [{ lat: startPoint.lat, lng: startPoint.lng, elev: startPoint.elev }];
                let current = startPoint;
                let iterations = 0;
                const maxIterations = 50;
                
                while (iterations < maxIterations) {
                    iterations++;
                    
                    // Buscar el vecino con menor elevacin
                    let lowestNeighbor = null;
                    let lowestElev = current.elev;
                    
                    const neighbors = points.filter(p => {
                        const dist = Math.sqrt(Math.pow(p.lat - current.lat, 2) + Math.pow(p.lng - current.lng, 2));
                        return dist > 0 && dist < cellSize * 1.5;
                    });
                    
                    neighbors.forEach(n => {
                        if (n.elev < lowestElev) {
                            lowestElev = n.elev;
                            lowestNeighbor = n;
                        }
                    });
                    
                    if (!lowestNeighbor || lowestElev >= current.elev - 0.1) break;
                    
                    flowLine.push({ lat: lowestNeighbor.lat, lng: lowestNeighbor.lng, elev: lowestNeighbor.elev });
                    processed.add(`${current.lat.toFixed(5)},${current.lng.toFixed(5)}`);
                    current = lowestNeighbor;
                }
                
                if (flowLine.length >= 3) {
                    this.flowLines.push(flowLine);
                }
            });
        },
        
        findCriticalPoints(points) {
            this.criticalPoints = [];
            
            // Puntos crticos son donde convergen mltiples lneas de flujo o puntos bajos
            const flowEndPoints = {};
            
            this.flowLines.forEach(line => {
                if (line.length > 0) {
                    const end = line[line.length - 1];
                    const key = `${end.lat.toFixed(4)},${end.lng.toFixed(4)}`;
                    flowEndPoints[key] = (flowEndPoints[key] || 0) + 1;
                }
            });
            
            // Puntos donde terminan 2+ lneas de flujo
            Object.entries(flowEndPoints).forEach(([key, count]) => {
                if (count >= 2) {
                    const [lat, lng] = key.split(',').map(Number);
                    const point = points.find(p => Math.abs(p.lat - lat) < 0.0001 && Math.abs(p.lng - lng) < 0.0001);
                    this.criticalPoints.push({
                        lat, lng,
                        elev: point?.elev || 0,
                        flowCount: count,
                        risk: count >= 4 ? 'alto' : count >= 2 ? 'medio' : 'bajo'
                    });
                }
            });
            
            // Tambin agregar el punto ms bajo como crtico
            const lowestPoint = points.reduce((min, p) => p.elev < min.elev ? p : min, points[0]);
            if (lowestPoint && !this.criticalPoints.find(cp => Math.abs(cp.lat - lowestPoint.lat) < 0.0001)) {
                this.criticalPoints.push({
                    lat: lowestPoint.lat,
                    lng: lowestPoint.lng,
                    elev: lowestPoint.elev,
                    flowCount: 0,
                    risk: 'descarga'
                });
            }
        },
        
        getElevationRange(points) {
            if (points.length === 0) return { min: 0, max: 0, range: 0, avg: 0 };
            const elevs = points.map(p => p.elev).filter(e => e > 0);
            const min = Math.min(...elevs);
            const max = Math.max(...elevs);
            return {
                min,
                max,
                range: max - min,
                avg: elevs.reduce((a, b) => a + b, 0) / elevs.length
            };
        },
        
        render() {
            this.layer = this.layer || L.layerGroup().addTo(State.map);
            this.layer.clearLayers();
            
            // Dibujar lneas de flujo
            this.flowLines.forEach((line, idx) => {
                if (line.length < 2) return;
                
                const latlngs = line.map(p => [p.lat, p.lng]);
                const intensity = Math.min(1, line.length / 20);
                
                L.polyline(latlngs, {
                    color: '#06b6d4',
                    weight: 2 + intensity * 3,
                    opacity: 0.5 + intensity * 0.3,
                    lineCap: 'round',
                    lineJoin: 'round'
                }).addTo(this.layer);
                
                // Flechas de direccin cada ciertos puntos
                if (line.length > 3) {
                    const midIdx = Math.floor(line.length / 2);
                    const mid = line[midIdx];
                    const next = line[midIdx + 1] || line[midIdx];
                    const angle = Math.atan2(next.lat - mid.lat, next.lng - mid.lng) * 180 / Math.PI - 90;
                    
                    L.marker([mid.lat, mid.lng], {
                        icon: L.divIcon({
                            html: `<div style="transform:rotate(${angle}deg);color:#06b6d4;font-size:14px;"></div>`,
                            className: '',
                            iconSize: [14, 14],
                            iconAnchor: [7, 7]
                        })
                    }).addTo(this.layer);
                }
            });
            
            // Dibujar puntos crticos
            this.criticalPoints.forEach(cp => {
                const color = cp.risk === 'alto' ? '#ef4444' : cp.risk === 'medio' ? '#f59e0b' : cp.risk === 'descarga' ? '#22c55e' : '#06b6d4';
                const icon = cp.risk === 'descarga' ? 'arrow-down' : 'exclamation-triangle';
                const size = cp.risk === 'descarga' ? 28 : 24;
                
                L.marker([cp.lat, cp.lng], {
                    icon: L.divIcon({
                        html: `<div style="background:${color};color:white;width:${size}px;height:${size}px;border-radius:50%;display:flex;align-items:center;justify-content:center;border:3px solid white;box-shadow:0 2px 8px rgba(0,0,0,0.4);font-size:12px;"><i class="fa-solid fa-${icon}"></i></div>`,
                        className: '',
                        iconSize: [size, size],
                        iconAnchor: [size/2, size/2]
                    })
                }).bindPopup(`
                    <div style="text-align:center;min-width:140px;">
                        <b style="color:${color};">${cp.risk === 'descarga' ? ' Punto de Descarga' : ' Zona de Acumulacin'}</b>
                        <hr style="margin:6px 0;">
                        <div style="font-size:11px;">
                            <b>Elevacin:</b> ${cp.elev.toFixed(1)} m<br>
                            ${cp.flowCount > 0 ? `<b>Flujos convergentes:</b> ${cp.flowCount}` : ''}
                        </div>
                        <div style="font-size:10px;color:#666;margin-top:4px;">
                            ${cp.lat.toFixed(6)}, ${cp.lng.toFixed(6)}
                        </div>
                    </div>
                `).addTo(this.layer);
            });
        },
        
        showResults(data) {
            const rd = $('drainage-results');
            if (!rd) return;
            
            rd.style.display = 'block';
            rd.innerHTML = `
                <div style="background:linear-gradient(135deg,rgba(6,182,212,0.2),rgba(8,145,178,0.15));border-radius:8px;padding:12px;">
                    <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:8px;">
                        <div style="text-align:center;">
                            <div style="font-size:22px;font-weight:800;color:#06b6d4;">${data.flowRate.toFixed(3)}</div>
                            <div style="font-size:9px;color:var(--text-3);">CAUDAL (m/s)</div>
                        </div>
                        <div style="text-align:center;">
                            <div style="font-size:22px;font-weight:800;color:#10b981;">${data.area.toFixed(2)}</div>
                            <div style="font-size:9px;color:var(--text-3);">REA (Ha)</div>
                        </div>
                    </div>
                    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:6px;margin-top:10px;">
                        <div style="text-align:center;background:var(--bg-glass);padding:6px;border-radius:4px;">
                            <div style="font-size:14px;font-weight:700;color:#a78bfa;">${data.elevRange.range.toFixed(1)}m</div>
                            <div style="font-size:8px;color:var(--text-3);">Desnivel</div>
                        </div>
                        <div style="text-align:center;background:var(--bg-glass);padding:6px;border-radius:4px;">
                            <div style="font-size:14px;font-weight:700;color:#f59e0b;">${data.slope.toFixed(1)}%</div>
                            <div style="font-size:8px;color:var(--text-3);">Pendiente</div>
                        </div>
                        <div style="text-align:center;background:var(--bg-glass);padding:6px;border-radius:4px;">
                            <div style="font-size:14px;font-weight:700;color:#ec4899;">${data.tc.toFixed(1)}</div>
                            <div style="font-size:8px;color:var(--text-3);">Tc (min)</div>
                        </div>
                    </div>
                </div>
                
                <div style="margin-top:12px;">
                    <div style="font-size:10px;font-weight:600;color:#06b6d4;margin-bottom:6px;">
                        <i class="fa-solid fa-map-location-dot"></i> ANLISIS ESPACIAL
                    </div>
                    <div style="font-size:10px;color:var(--text-2);padding:8px;background:var(--bg-glass);border-radius:6px;">
                        <div style="margin-bottom:4px;"> Lneas de flujo detectadas: <b>${data.flowLines}</b></div>
                        <div style="margin-bottom:4px;"> Zonas crticas de acumulacin: <b style="color:${data.criticalPoints > 2 ? '#ef4444' : '#f59e0b'};">${data.criticalPoints}</b></div>
                        <div> Elevacin: ${data.elevRange.min.toFixed(1)}m - ${data.elevRange.max.toFixed(1)}m</div>
                    </div>
                </div>
                
                <div style="margin-top:12px;">
                    <div style="font-size:10px;font-weight:600;color:#22c55e;margin-bottom:6px;">
                        <i class="fa-solid fa-lightbulb"></i> RECOMENDACIONES
                    </div>
                    <div style="font-size:10px;color:var(--text-2);padding:8px;background:var(--bg-glass);border-radius:6px;">
                        <div style="margin-bottom:4px;"> <b>Tubera mnima:</b>  ${data.pipeDiameter} mm PVC</div>
                        <div style="margin-bottom:4px;"> <b>Pendiente tubera:</b> 1-2%</div>
                        ${data.criticalPoints > 2 ? '<div style="margin-bottom:4px;color:#ef4444;"> <b>Atencin!</b> Mltiples zonas de acumulacin</div>' : ''}
                        ${data.slope < 2 ? '<div style="color:#f59e0b;"> Terreno muy plano - considerar bombeo</div>' : ''}
                    </div>
                </div>
                
                <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:4px;margin-top:12px;">
                    <button class="btn btn-2" onclick="DrainageSimulator.exportKML()" style="font-size:8px;padding:6px;" title="Google Earth">
                        <i class="fa-solid fa-earth-americas"></i> KML
                    </button>
                    <button class="btn btn-2" onclick="DrainageSimulator.exportGeoJSON()" style="font-size:8px;padding:6px;" title="GIS">
                        <i class="fa-solid fa-code"></i> JSON
                    </button>
                    <button class="btn btn-2" onclick="DrainageSimulator.exportDXF()" style="font-size:8px;padding:6px;" title="AutoCAD">
                        <i class="fa-solid fa-drafting-compass"></i> DXF
                    </button>
                    <button class="btn btn-2" onclick="DrainageSimulator.exportCSV()" style="font-size:8px;padding:6px;" title="Excel">
                        <i class="fa-solid fa-file-csv"></i> CSV
                    </button>
                </div>
                <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:4px;margin-top:4px;">
                    <button class="btn btn-2" onclick="DrainageSimulator.exportGPX()" style="font-size:8px;padding:6px;" title="GPS">
                        <i class="fa-solid fa-satellite"></i> GPX
                    </button>
                    <button class="btn btn-2" onclick="DrainageSimulator.exportPDF()" style="font-size:8px;padding:6px;" title="Informe PDF">
                        <i class="fa-solid fa-file-pdf"></i> PDF
                    </button>
                    <button class="btn btn-2" onclick="DrainageSimulator.exportTXT()" style="font-size:8px;padding:6px;" title="Texto">
                        <i class="fa-solid fa-file-lines"></i> TXT
                    </button>
                    <button class="btn btn-2" onclick="DrainageSimulator.copyToClipboard()" style="font-size:8px;padding:6px;" title="Copiar">
                        <i class="fa-solid fa-copy"></i> COPY
                    </button>
                </div>
            `;
        },
        
        clear() {
            if (this.layer) this.layer.clearLayers();
            this.flowLines = [];
            this.criticalPoints = [];
            this.elevationData = [];
            this.lastResults = null;
            if ($('drainage-results')) $('drainage-results').style.display = 'none';
            Toast.show('Limpiado', 'success');
        },
        
        // ========== EXPORTACIN KML (Google Earth) ==========
        exportKML() {
            if (this.flowLines.length === 0) return Toast.show('No hay datos', 'error');
            
            let kml = `<?xml version="1.0" encoding="UTF-8"?>
<kml xmlns="http://www.opengis.net/kml/2.2">
<Document>
<name>Anlisis de Drenaje - WIN-TEL v30</name>
<description>Generado: ${new Date().toLocaleString('es-ES')}</description>

<Style id="flowLine">
    <LineStyle><color>ffb4d406</color><width>3</width></LineStyle>
</Style>
<Style id="flowLineThick">
    <LineStyle><color>ffb4d406</color><width>5</width></LineStyle>
</Style>
<Style id="criticalHigh">
    <IconStyle><color>ff4444ef</color><scale>1.2</scale>
        <Icon><href>http://maps.google.com/mapfiles/kml/shapes/caution.png</href></Icon>
    </IconStyle>
</Style>
<Style id="criticalMed">
    <IconStyle><color>ff0b9ef5</color><scale>1</scale>
        <Icon><href>http://maps.google.com/mapfiles/kml/shapes/water.png</href></Icon>
    </IconStyle>
</Style>
<Style id="discharge">
    <IconStyle><color>ff5ec522</color><scale>1.3</scale>
        <Icon><href>http://maps.google.com/mapfiles/kml/shapes/arrow.png</href></Icon>
    </IconStyle>
</Style>

<Folder>
<name>Lneas de Flujo (${this.flowLines.length})</name>\n`;
            
            this.flowLines.forEach((line, i) => {
                const coords = line.map(p => `${p.lng},${p.lat},${p.elev || 0}`).join(' ');
                const length = this.calculateLineLength(line);
                kml += `<Placemark>
    <name>Flujo ${i+1}</name>
    <description>Longitud: ${length.toFixed(1)}m, Puntos: ${line.length}</description>
    <styleUrl>${length > 50 ? '#flowLineThick' : '#flowLine'}</styleUrl>
    <LineString>
        <altitudeMode>clampToGround</altitudeMode>
        <coordinates>${coords}</coordinates>
    </LineString>
</Placemark>\n`;
            });
            
            kml += `</Folder>

<Folder>
<name>Puntos Crticos (${this.criticalPoints.length})</name>\n`;
            
            this.criticalPoints.forEach((cp, i) => {
                const style = cp.risk === 'descarga' ? 'discharge' : cp.risk === 'alto' ? 'criticalHigh' : 'criticalMed';
                const name = cp.risk === 'descarga' ? 'Punto de Descarga' : `Zona de Acumulacin ${i+1}`;
                kml += `<Placemark>
    <name>${name}</name>
    <description>
        Elevacin: ${cp.elev?.toFixed(1) || 'N/A'} m
        Riesgo: ${cp.risk?.toUpperCase() || 'N/A'}
        Flujos convergentes: ${cp.flowCount || 0}
    </description>
    <styleUrl>#${style}</styleUrl>
    <Point>
        <coordinates>${cp.lng},${cp.lat},0</coordinates>
    </Point>
</Placemark>\n`;
            });
            
            kml += `</Folder>
</Document>
</kml>`;
            
            download(kml, `drenaje_${Date.now()}.kml`, 'application/vnd.google-earth.kml+xml');
            Toast.show('KML exportado', 'success');
        },
        
        // ========== EXPORTACIN GeoJSON (GIS) ==========
        exportGeoJSON() {
            if (this.flowLines.length === 0) return Toast.show('No hay datos', 'error');
            
            const features = [];
            
            // Lneas de flujo
            this.flowLines.forEach((line, i) => {
                features.push({
                    type: 'Feature',
                    properties: {
                        id: i + 1,
                        type: 'flow_line',
                        name: `Flujo ${i + 1}`,
                        length_m: this.calculateLineLength(line),
                        points: line.length,
                        start_elev: line[0]?.elev || 0,
                        end_elev: line[line.length - 1]?.elev || 0
                    },
                    geometry: {
                        type: 'LineString',
                        coordinates: line.map(p => [p.lng, p.lat, p.elev || 0])
                    }
                });
            });
            
            // Puntos crticos
            this.criticalPoints.forEach((cp, i) => {
                features.push({
                    type: 'Feature',
                    properties: {
                        id: i + 1,
                        type: 'critical_point',
                        name: cp.risk === 'descarga' ? 'Punto de Descarga' : `Acumulacin ${i + 1}`,
                        risk_level: cp.risk,
                        elevation_m: cp.elev,
                        flow_count: cp.flowCount || 0
                    },
                    geometry: {
                        type: 'Point',
                        coordinates: [cp.lng, cp.lat, cp.elev || 0]
                    }
                });
            });
            
            const geojson = {
                type: 'FeatureCollection',
                name: 'Anlisis de Drenaje',
                crs: { type: 'name', properties: { name: 'urn:ogc:def:crs:OGC:1.3:CRS84' } },
                properties: {
                    software: 'WIN-TEL GEOMATICS PRO v30',
                    date: new Date().toISOString(),
                    flow_lines: this.flowLines.length,
                    critical_points: this.criticalPoints.length
                },
                features
            };
            
            download(JSON.stringify(geojson, null, 2), `drenaje_${Date.now()}.geojson`, 'application/json');
            Toast.show('GeoJSON exportado', 'success');
        },
        
        // ========== EXPORTACIN DXF (AutoCAD) ==========
        exportDXF() {
            if (this.flowLines.length === 0) return Toast.show('No hay datos', 'error');
            
            let dxf = `0
SECTION
2
HEADER
9
$ACADVER
1
AC1014
9
$INSUNITS
70
6
0
ENDSEC
0
SECTION
2
TABLES
0
TABLE
2
LAYER
70
4
0
LAYER
2
FLUJO_DRENAJE
70
0
62
4
6
CONTINUOUS
0
LAYER
2
PUNTOS_CRITICOS
70
0
62
1
6
CONTINUOUS
0
LAYER
2
PUNTO_DESCARGA
70
0
62
3
6
CONTINUOUS
0
LAYER
2
ELEVACIONES
70
0
62
5
6
CONTINUOUS
0
ENDTAB
0
ENDSEC
0
SECTION
2
ENTITIES\n`;
            
            // Lneas de flujo como POLYLINE 3D
            this.flowLines.forEach((line, i) => {
                if (line.length < 2) return;
                
                dxf += `0
POLYLINE
8
FLUJO_DRENAJE
66
1
70
8\n`;
                
                line.forEach(p => {
                    // Convertir a UTM aproximado para AutoCAD
                    const x = p.lng * 111320 * Math.cos(p.lat * Math.PI / 180);
                    const y = p.lat * 110540;
                    dxf += `0
VERTEX
8
FLUJO_DRENAJE
10
${x.toFixed(3)}
20
${y.toFixed(3)}
30
${(p.elev || 0).toFixed(3)}
70
32\n`;
                });
                
                dxf += `0
SEQEND
8
FLUJO_DRENAJE\n`;
            });
            
            // Puntos crticos como POINT con TEXT
            this.criticalPoints.forEach((cp, i) => {
                const x = cp.lng * 111320 * Math.cos(cp.lat * Math.PI / 180);
                const y = cp.lat * 110540;
                const layer = cp.risk === 'descarga' ? 'PUNTO_DESCARGA' : 'PUNTOS_CRITICOS';
                
                dxf += `0
POINT
8
${layer}
10
${x.toFixed(3)}
20
${y.toFixed(3)}
30
${(cp.elev || 0).toFixed(3)}
0
TEXT
8
${layer}
10
${(x + 5).toFixed(3)}
20
${(y + 5).toFixed(3)}
30
${(cp.elev || 0).toFixed(3)}
40
3
1
${cp.risk === 'descarga' ? 'DESCARGA' : 'ACUM-' + (i + 1)} E=${(cp.elev || 0).toFixed(1)}m\n`;
            });
            
            dxf += `0
ENDSEC
0
EOF`;
            
            download(dxf, `drenaje_${Date.now()}.dxf`, 'application/dxf');
            Toast.show('DXF exportado (AutoCAD)', 'success');
        },
        
        // ========== EXPORTACIN CSV (Excel) ==========
        exportCSV() {
            if (this.flowLines.length === 0) return Toast.show('No hay datos', 'error');
            
            const area = State.polygon ? turf.area(State.polygon) / 10000 : 0;
            const elevRange = this.getElevationRange(this.elevationData);
            
            let csv = `ANLISIS DE DRENAJE - WIN-TEL GEOMATICS PRO v30\n`;
            csv += `Fecha,${new Date().toLocaleString('es-ES')}\n`;
            csv += `rea (Ha),${area.toFixed(4)}\n`;
            csv += `Elevacin Mn (m),${elevRange.min.toFixed(1)}\n`;
            csv += `Elevacin Mx (m),${elevRange.max.toFixed(1)}\n`;
            csv += `Desnivel (m),${elevRange.range.toFixed(1)}\n`;
            csv += `Lneas de Flujo,${this.flowLines.length}\n`;
            csv += `Puntos Crticos,${this.criticalPoints.length}\n\n`;
            
            // Tabla de lneas de flujo
            csv += `LNEAS DE FLUJO\n`;
            csv += `ID,LONGITUD_M,PUNTOS,ELEV_INICIO,ELEV_FIN,DESNIVEL\n`;
            this.flowLines.forEach((line, i) => {
                const length = this.calculateLineLength(line);
                const startElev = line[0]?.elev || 0;
                const endElev = line[line.length - 1]?.elev || 0;
                csv += `${i + 1},${length.toFixed(2)},${line.length},${startElev.toFixed(1)},${endElev.toFixed(1)},${(startElev - endElev).toFixed(1)}\n`;
            });
            
            csv += `\nPUNTOS CRTICOS\n`;
            csv += `ID,TIPO,LATITUD,LONGITUD,ELEVACION_M,RIESGO,FLUJOS_CONVERGENTES\n`;
            this.criticalPoints.forEach((cp, i) => {
                csv += `${i + 1},${cp.risk === 'descarga' ? 'DESCARGA' : 'ACUMULACION'},${cp.lat.toFixed(6)},${cp.lng.toFixed(6)},${(cp.elev || 0).toFixed(1)},${cp.risk?.toUpperCase() || 'N/A'},${cp.flowCount || 0}\n`;
            });
            
            csv += `\nCOORDENADAS DE FLUJOS (DETALLE)\n`;
            csv += `FLUJO_ID,PUNTO_ID,LATITUD,LONGITUD,ELEVACION_M\n`;
            this.flowLines.forEach((line, i) => {
                line.forEach((p, j) => {
                    csv += `${i + 1},${j + 1},${p.lat.toFixed(6)},${p.lng.toFixed(6)},${(p.elev || 0).toFixed(1)}\n`;
                });
            });
            
            download(csv, `drenaje_${Date.now()}.csv`, 'text/csv');
            Toast.show('CSV exportado', 'success');
        },
        
        // ========== EXPORTACIN GPX (GPS) ==========
        exportGPX() {
            if (this.flowLines.length === 0) return Toast.show('No hay datos', 'error');
            
            let gpx = `<?xml version="1.0" encoding="UTF-8"?>
<gpx version="1.1" creator="WIN-TEL GEOMATICS PRO v30"
    xmlns="http://www.topografix.com/GPX/1/1">
<metadata>
    <name>Anlisis de Drenaje</name>
    <desc>Lneas de flujo y puntos crticos</desc>
    <time>${new Date().toISOString()}</time>
</metadata>\n`;
            
            // Puntos crticos como waypoints
            this.criticalPoints.forEach((cp, i) => {
                const name = cp.risk === 'descarga' ? 'DESCARGA' : `ACUM-${i + 1}`;
                const sym = cp.risk === 'descarga' ? 'Flag, Green' : cp.risk === 'alto' ? 'Danger Area' : 'Water Source';
                gpx += `<wpt lat="${cp.lat.toFixed(6)}" lon="${cp.lng.toFixed(6)}">
    <ele>${(cp.elev || 0).toFixed(1)}</ele>
    <name>${name}</name>
    <desc>Riesgo: ${cp.risk?.toUpperCase() || 'N/A'}, Flujos: ${cp.flowCount || 0}</desc>
    <sym>${sym}</sym>
</wpt>\n`;
            });
            
            // Lneas de flujo como tracks
            this.flowLines.forEach((line, i) => {
                gpx += `<trk>
    <name>Flujo ${i + 1}</name>
    <desc>Longitud: ${this.calculateLineLength(line).toFixed(1)}m</desc>
    <trkseg>\n`;
                line.forEach(p => {
                    gpx += `        <trkpt lat="${p.lat.toFixed(6)}" lon="${p.lng.toFixed(6)}">
            <ele>${(p.elev || 0).toFixed(1)}</ele>
        </trkpt>\n`;
                });
                gpx += `    </trkseg>
</trk>\n`;
            });
            
            gpx += `</gpx>`;
            
            download(gpx, `drenaje_${Date.now()}.gpx`, 'application/gpx+xml');
            Toast.show('GPX exportado (GPS)', 'success');
        },
        
        // ========== EXPORTACIN PDF (Informe) ==========
        exportPDF() {
            if (this.flowLines.length === 0) return Toast.show('No hay datos', 'error');
            if (typeof jspdf === 'undefined') return Toast.show('PDF no disponible', 'error');
            
            const { jsPDF } = jspdf;
            const doc = new jsPDF();
            const area = State.polygon ? turf.area(State.polygon) / 10000 : 0;
            const elevRange = this.getElevationRange(this.elevationData);
            
            let y = 15;
            
            // Ttulo
            doc.setFontSize(20);
            doc.setTextColor(6, 182, 212);
            doc.text('ANLISIS DE DRENAJE', 105, y, { align: 'center' });
            y += 8;
            doc.setFontSize(10);
            doc.setTextColor(100);
            doc.text('WIN-TEL GEOMATICS PRO v30', 105, y, { align: 'center' });
            y += 5;
            doc.text(new Date().toLocaleString('es-ES'), 105, y, { align: 'center' });
            y += 12;
            
            // Lnea separadora
            doc.setDrawColor(6, 182, 212);
            doc.setLineWidth(0.5);
            doc.line(20, y, 190, y);
            y += 10;
            
            // Datos del terreno
            doc.setFontSize(14);
            doc.setTextColor(0);
            doc.text('DATOS DEL TERRENO', 20, y);
            y += 8;
            
            doc.setFontSize(10);
            doc.text(`rea del terreno: ${area.toFixed(4)} Ha (${(area * 10000).toFixed(0)} m)`, 25, y); y += 5;
            doc.text(`Elevacin mnima: ${elevRange.min.toFixed(1)} m`, 25, y); y += 5;
            doc.text(`Elevacin mxima: ${elevRange.max.toFixed(1)} m`, 25, y); y += 5;
            doc.text(`Desnivel total: ${elevRange.range.toFixed(1)} m`, 25, y); y += 5;
            doc.text(`Pendiente promedio: ${((elevRange.range / Math.sqrt(area * 10000)) * 100).toFixed(1)}%`, 25, y); y += 12;
            
            // Resultados
            doc.setFontSize(14);
            doc.text('RESULTADOS DEL ANLISIS', 20, y);
            y += 8;
            
            doc.setFontSize(10);
            doc.text(`Lneas de flujo detectadas: ${this.flowLines.length}`, 25, y); y += 5;
            doc.text(`Puntos crticos identificados: ${this.criticalPoints.length}`, 25, y); y += 5;
            
            const highRisk = this.criticalPoints.filter(cp => cp.risk === 'alto').length;
            const medRisk = this.criticalPoints.filter(cp => cp.risk === 'medio').length;
            doc.text(`   - Riesgo alto: ${highRisk}`, 30, y); y += 5;
            doc.text(`   - Riesgo medio: ${medRisk}`, 30, y); y += 5;
            doc.text(`   - Punto de descarga: ${this.criticalPoints.filter(cp => cp.risk === 'descarga').length}`, 30, y); y += 12;
            
            // Tabla de puntos crticos
            if (this.criticalPoints.length > 0) {
                doc.setFontSize(14);
                doc.text('PUNTOS CRTICOS', 20, y);
                y += 8;
                
                // Header
                doc.setFontSize(8);
                doc.setFont('helvetica', 'bold');
                doc.text('ID', 25, y);
                doc.text('TIPO', 40, y);
                doc.text('LATITUD', 75, y);
                doc.text('LONGITUD', 105, y);
                doc.text('ELEVACIN', 140, y);
                doc.text('RIESGO', 170, y);
                y += 5;
                
                doc.setFont('helvetica', 'normal');
                this.criticalPoints.forEach((cp, i) => {
                    if (y > 270) { doc.addPage(); y = 20; }
                    doc.text((i + 1).toString(), 25, y);
                    doc.text(cp.risk === 'descarga' ? 'Descarga' : 'Acumulacin', 40, y);
                    doc.text(cp.lat.toFixed(6), 75, y);
                    doc.text(cp.lng.toFixed(6), 105, y);
                    doc.text((cp.elev || 0).toFixed(1) + ' m', 140, y);
                    doc.text((cp.risk || 'N/A').toUpperCase(), 170, y);
                    y += 4;
                });
                y += 8;
            }
            
            // Recomendaciones
            if (y > 240) { doc.addPage(); y = 20; }
            doc.setFontSize(14);
            doc.text('RECOMENDACIONES', 20, y);
            y += 8;
            
            doc.setFontSize(10);
            const recs = [
                ' Instalar sistema de drenaje en puntos crticos de acumulacin',
                ' Verificar capacidad de descarga natural del terreno',
                ' Considerar obras de proteccin en zonas de alto riesgo',
                ' Mantener cauces naturales limpios de obstrucciones',
                highRisk > 2 ? ' ATENCIN: Mltiples zonas de alto riesgo detectadas' : null,
                elevRange.range < 2 ? ' NOTA: Terreno muy plano - considerar sistema de bombeo' : null
            ].filter(Boolean);
            
            recs.forEach(rec => {
                doc.text(rec, 25, y);
                y += 5;
            });
            
            // Pie de pgina
            doc.setFontSize(8);
            doc.setTextColor(150);
            doc.text('Generado por WIN-TEL GEOMATICS PRO v30 - WindowsTelecom C.A.', 105, 290, { align: 'center' });
            
            doc.save(`informe_drenaje_${Date.now()}.pdf`);
            Toast.show('PDF exportado', 'success');
        },
        
        // ========== EXPORTACIN TXT (Informe de texto) ==========
        exportTXT() {
            if (this.flowLines.length === 0) return Toast.show('No hay datos', 'error');
            
            const area = State.polygon ? turf.area(State.polygon) / 10000 : 0;
            const elevRange = this.getElevationRange(this.elevationData);
            
            let report = `
           INFORME DE ANLISIS DE DRENAJE                     
           WIN-TEL GEOMATICS PRO v30                          


Fecha de generacin: ${new Date().toLocaleString('es-ES')}


                    DATOS DEL TERRENO


rea total ............... ${area.toFixed(4)} Ha (${(area * 10000).toFixed(0)} m)
Elevacin mnima ......... ${elevRange.min.toFixed(1)} m
Elevacin mxima ......... ${elevRange.max.toFixed(1)} m
Desnivel total ........... ${elevRange.range.toFixed(1)} m
Pendiente promedio ....... ${((elevRange.range / Math.sqrt(area * 10000)) * 100).toFixed(1)}%


                  RESULTADOS DEL ANLISIS


Lneas de flujo detectadas ........ ${this.flowLines.length}
Puntos crticos identificados ..... ${this.criticalPoints.length}
   Riesgo ALTO ................... ${this.criticalPoints.filter(cp => cp.risk === 'alto').length}
   Riesgo MEDIO .................. ${this.criticalPoints.filter(cp => cp.risk === 'medio').length}
   Puntos de descarga ............ ${this.criticalPoints.filter(cp => cp.risk === 'descarga').length}


                    PUNTOS CRTICOS

`;
            
            if (this.criticalPoints.length > 0) {
                report += `

 ID     TIPO        LATITUD       LONGITUD     ELEVACIN RIESGO 
\n`;
                
                this.criticalPoints.forEach((cp, i) => {
                    const tipo = (cp.risk === 'descarga' ? 'Descarga' : 'Acumulacin').padEnd(11);
                    const lat = cp.lat.toFixed(6).padStart(12);
                    const lng = cp.lng.toFixed(6).padStart(13);
                    const elev = ((cp.elev || 0).toFixed(1) + 'm').padStart(8);
                    const riesgo = (cp.risk || 'N/A').toUpperCase().padEnd(6);
                    report += ` ${(i + 1).toString().padStart(2)}  ${tipo}  ${lat}  ${lng}  ${elev}  ${riesgo} \n`;
                });
                
                report += `\n`;
            }
            
            report += `

                   LNEAS DE FLUJO



 ID  LONGITUD  PUNTOS  ELEV.INICIO ELEV.FIN   DESNIVEL 
\n`;
            
            this.flowLines.forEach((line, i) => {
                const length = this.calculateLineLength(line).toFixed(1).padStart(6) + 'm';
                const points = line.length.toString().padStart(6);
                const startElev = ((line[0]?.elev || 0).toFixed(1) + 'm').padStart(10);
                const endElev = ((line[line.length - 1]?.elev || 0).toFixed(1) + 'm').padStart(9);
                const desnivel = (((line[0]?.elev || 0) - (line[line.length - 1]?.elev || 0)).toFixed(1) + 'm').padStart(8);
                report += ` ${(i + 1).toString().padStart(2)}  ${length}  ${points}  ${startElev}  ${endElev}  ${desnivel} \n`;
            });
            
            report += `


                    RECOMENDACIONES


 Instalar sistema de drenaje en puntos crticos de acumulacin
 Verificar capacidad de descarga natural del terreno
 Considerar obras de proteccin en zonas de alto riesgo
 Mantener cauces naturales limpios de obstrucciones
${this.criticalPoints.filter(cp => cp.risk === 'alto').length > 2 ? '   ATENCIN: Mltiples zonas de alto riesgo detectadas\n' : ''}${elevRange.range < 2 ? '   NOTA: Terreno muy plano - considerar sistema de bombeo\n' : ''}

         Generado por WIN-TEL GEOMATICS PRO v30
                  WindowsTelecom C.A.
               Valencia, Carabobo, Venezuela

`;
            
            download(report, `informe_drenaje_${Date.now()}.txt`, 'text/plain');
            Toast.show('Informe TXT exportado', 'success');
        },
        
        // Alias para compatibilidad
        exportReport() {
            this.exportTXT();
        },
        
        // ========== COPIAR AL PORTAPAPELES ==========
        copyToClipboard() {
            if (this.flowLines.length === 0) return Toast.show('No hay datos', 'error');
            
            const area = State.polygon ? turf.area(State.polygon) / 10000 : 0;
            const elevRange = this.getElevationRange(this.elevationData);
            
            let text = `ANLISIS DE DRENAJE - WIN-TEL v30\n`;
            text += `Fecha: ${new Date().toLocaleString('es-ES')}\n\n`;
            text += `RESUMEN:\n`;
            text += `rea: ${area.toFixed(4)} Ha\n`;
            text += `Desnivel: ${elevRange.range.toFixed(1)} m\n`;
            text += `Lneas de flujo: ${this.flowLines.length}\n`;
            text += `Puntos crticos: ${this.criticalPoints.length}\n\n`;
            
            text += `PUNTOS CRTICOS:\n`;
            text += `ID\tTIPO\tLAT\tLNG\tELEV\tRIESGO\n`;
            this.criticalPoints.forEach((cp, i) => {
                text += `${i + 1}\t${cp.risk === 'descarga' ? 'Descarga' : 'Acumulacin'}\t${cp.lat.toFixed(6)}\t${cp.lng.toFixed(6)}\t${(cp.elev || 0).toFixed(1)}m\t${cp.risk?.toUpperCase() || 'N/A'}\n`;
            });
            
            navigator.clipboard.writeText(text).then(() => {
                Toast.show('Copiado al portapapeles', 'success');
            }).catch(() => {
                Toast.show('Error al copiar', 'error');
            });
        },
        
        // ========== UTILIDADES ==========
        calculateLineLength(line) {
            if (!line || line.length < 2) return 0;
            let length = 0;
            for (let i = 0; i < line.length - 1; i++) {
                const p1 = line[i], p2 = line[i + 1];
                length += GeoMath.vincentyDist(p1.lat, p1.lng, p2.lat, p2.lng);
            }
            return length;
        }
    };

    // ========== REAL TIME GPS ==========
    const RealTimeGPS={connected:false,watchId:null,marker:null,trackLayer:null,lastPosition:null,async connectDevice(){if(!navigator.geolocation){Toast.show('Geolocalizacin no soportada','error');return;}if(this.connected){this.disconnect();return;}Toast.show('Conectando a GPS...','info');try{this.watchId=navigator.geolocation.watchPosition(this.onPositionUpdate.bind(this),this.onPositionError.bind(this),{enableHighAccuracy:true,maximumAge:0,timeout:5000});this.connected=true;this.trackLayer=this.trackLayer||L.layerGroup().addTo(State.map);this.trackLayer.clearLayers();Toast.show('GPS conectado','success');}catch(e){Toast.show('Error al conectar GPS','error');}},onPositionUpdate(position){const lat=position.coords.latitude,lng=position.coords.longitude,accuracy=position.coords.accuracy;if(this.marker){this.marker.setLatLng([lat,lng]);}else{this.marker=L.marker([lat,lng],{icon:L.divIcon({html:'<div style="background:#22c55e;color:white;width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;border:3px solid white;"><i class="fa-solid fa-satellite"></i></div>',className:'',iconSize:[32,32],iconAnchor:[16,16]})}).addTo(this.trackLayer);State.map.setView([lat,lng],18);}const latEl=$('m-lat'),lonEl=$('m-lon');if(latEl)latEl.textContent=lat.toFixed(6);if(lonEl)lonEl.textContent=lng.toFixed(6);if(this.lastPosition){L.polyline([[this.lastPosition.lat,this.lastPosition.lng],[lat,lng]],{color:'#22c55e',weight:3,opacity:0.7}).addTo(this.trackLayer);}this.lastPosition={lat,lng};this.marker.bindPopup(`<b> Posicin GPS</b><br>Lat: ${lat.toFixed(6)}<br>Lon: ${lng.toFixed(6)}<br>Precisin: ${accuracy.toFixed(1)} m<br><button class="btn" style="margin-top:8px;width:100%;" onclick="RealTimeGPS.markPoint()"><i class="fa-solid fa-map-pin"></i> Marcar</button>`).openPopup();},onPositionError(error){Toast.show(`Error GPS: ${error.message}`,'error');},markPoint(){if(!this.lastPosition)return;L.marker([this.lastPosition.lat,this.lastPosition.lng],{icon:L.divIcon({html:'<div style="background:#ef4444;color:white;width:20px;height:20px;border-radius:50%;border:2px solid white;"></div>',className:'',iconSize:[20,20],iconAnchor:[10,10]})}).bindPopup(`<b>Punto marcado</b><br>${new Date().toLocaleTimeString()}`).addTo(this.trackLayer);Toast.show('Punto marcado','success');},disconnect(){if(this.watchId){navigator.geolocation.clearWatch(this.watchId);this.watchId=null;}this.connected=false;if(this.marker){this.marker.remove();this.marker=null;}Toast.show('GPS desconectado','info');}};

    console.log('Mdulos avanzados WIN-TEL v30 cargados: SlopeAnalyzer, VolumeCalculator, ViewshedAnalysis, PathOptimizer, ShadowAnalysis3D, UrbanIndices, BudgetGenerator, RiskAnalysis, DrainageSimulator, RealTimeGPS');

    // ========== CHATBOT INTERACTIVO CON WHATSAPP ==========
    // ========== CHATBOT PRINCIPAL v30 - FLOTANTE Y ARRASTRABLE ==========
    const Chatbot = {
        messages: [],
        whatsappNumber: '584124060610',
        companyName: 'WINDOWSTELECOM C.A.',
        isOpen: false,
        isDragging: false,
        dragOffset: { x: 0, y: 0 },
        isMinimized: false,
        
        knowledgeBase: {
            'hola': 'Hola!  Bienvenido a **WIN-TEL GEOMATICS PRO v30**. Soy tu asistente virtual. En qu puedo ayudarte?',
            'buenos dias': 'Buenos das!  Qu necesitas hacer con WIN-TEL v30?',
            'buenas tardes': 'Buenas tardes!  En qu puedo asistirte?',
            'buenas noches': 'Buenas noches!  Estoy aqu para ayudarte.',
            'dibujar': 'Para **dibujar un polgono**:\n1. Click en  (barra derecha)\n2. Click en cada vrtice\n3. Doble click para cerrar\n\n O importa KML/GeoJSON.',
            'subdividir': '**7 mtodos de subdivisin**:\n1 Grilla\n2 Biseccin\n3 Slicer\n4 Radial\n5 rea Fija\n6 N Lotes\n7 Catastro',
            'ndvi': '**Anlisis NDVI** :\n1. Abre panel (botn verde )\n2. Selecciona cultivo\n3. Click "Analizar"\n\n Mapa de salud vegetal.',
            'plano': '**Generador de Planos** :\n1. Abre panel (botn violeta)\n2. Completa datos\n3. Click "Generar PDF"\n\n Plano con cajetn profesional.',
            'movimiento': '**Movimiento de Tierras** :\n1. Abre panel (botn naranja)\n2. Configura nivel\n3. Click "Calcular"\n\n Volmenes corte/relleno.',
            'comparador': '**Comparador de Terrenos** :\n1. Captura terreno actual\n2. Importa archivo anterior\n3. Click "Comparar"\n\n Diferencias y similitud.',
            'riego': '**Calculadora de Riego** :\n1. Selecciona cultivo\n2. Configura parmetros\n3. Click "Calcular"\n\n ETc, volumen, caudal.',
            'arboles': '**Conteo de rboles** :\n1. Abre panel (botn verde)\n2. Click "Iniciar"\n3. Click en cada rbol\n\n 6 formatos de exportacin.',
            'drenaje': '**Simulacin de Drenaje** :\n1. Configura lluvia y suelo\n2. Click "Simular"\n\n Flujos y puntos crticos.\n 8 exportaciones.',
            'exportar': '**10+ formatos de exportacin**:\nKML, GeoJSON, DXF, CSV, GPX, PDF, TXT, SVG, PNG, Copiar',
            'funciones': '**WIN-TEL v30** incluye:\n\n 7 Subdivisiones\n 5 Mdulos nuevos (NDVI, Planos, Tierras, Comparador, Riego)\n Conteo de Cultivos\n Drenaje\n 7 Herramientas QGIS\n 10+ Exportaciones',
            'version': '**WIN-TEL GEOMATICS PRO v30**\n\n Novedades:\n NDVI - Salud cultivos\n Planos PDF profesionales\n Movimiento de Tierras\n Comparador Terrenos\n Calculadora Riego\n Conteo mejorado\n Drenaje con 8 exports',
            'contacto': '**Soporte:**\n WhatsApp: +58 412-406-0610\n WINDOWSTELECOM C.A.',
            'ayuda': 'Qu necesitas?\n\n Dibujar/Subdividir\n Mdulos v30\n Conteo\n Drenaje\n Exportar'
        },
        
        toggle() {
            const panel = document.getElementById('chatbot-main-panel');
            if (!panel) {
                this.createPanel();
                this.init();
            }
            this.isOpen = !this.isOpen;
            document.getElementById('chatbot-main-panel').classList.toggle('active', this.isOpen);
            if (this.isOpen) setTimeout(() => document.getElementById('chatbot-main-input')?.focus(), 300);
        },
        
        createPanel() {
            if (document.getElementById('chatbot-main-panel')) return;
            const panel = document.createElement('div');
            panel.id = 'chatbot-main-panel';
            panel.className = 'chatbot-panel-v30';
            panel.innerHTML = `
                <div class="cb-header" onmousedown="Chatbot.startDrag(event)">
                    <div class="cb-header-left">
                        <div class="cb-avatar"></div>
                        <div class="cb-info"><div class="cb-title">Asistente WIN-TEL v30</div><div class="cb-status"><span class="cb-dot"></span>En lnea</div></div>
                    </div>
                    <div class="cb-btns">
                        <button class="cb-btn" onclick="Chatbot.minimize()"><i class="fa-solid fa-minus"></i></button>
                        <button class="cb-btn" onclick="Chatbot.maximize()"><i class="fa-solid fa-expand"></i></button>
                        <button class="cb-btn close" onclick="Chatbot.toggle()"><i class="fa-solid fa-times"></i></button>
                    </div>
                </div>
                <div class="cb-body" id="chatbot-main-body"></div>
                <div class="cb-input-area">
                    <input type="text" id="chatbot-main-input" placeholder="Escribe tu mensaje..." onkeypress="if(event.key==='Enter')Chatbot.sendMessage()">
                    <button class="cb-send" onclick="Chatbot.sendMessage()"><i class="fa-solid fa-paper-plane"></i></button>
                    <button class="cb-wa" onclick="Chatbot.openWhatsApp()"><i class="fa-brands fa-whatsapp"></i></button>
                </div>`;
            document.body.appendChild(panel);
            this.addStyles();
        },
        
        addStyles() {
            if (document.getElementById('chatbot-v30-styles')) return;
            const style = document.createElement('style');
            style.id = 'chatbot-v30-styles';
            style.textContent = `
                .chatbot-panel-v30{position:fixed;width:380px;height:520px;background:linear-gradient(180deg,#1a1f2e,#0f1219);border-radius:16px;box-shadow:0 20px 60px rgba(0,0,0,0.5),0 0 0 1px rgba(255,255,255,0.1);z-index:10000;display:none;flex-direction:column;overflow:hidden;resize:both;min-width:320px;min-height:400px;right:80px;bottom:80px}
                .chatbot-panel-v30.active{display:flex}
                .chatbot-panel-v30.dragging{box-shadow:0 30px 80px rgba(0,0,0,0.6),0 0 0 2px #10d393;cursor:grabbing}
                .chatbot-panel-v30.minimized{height:52px!important;min-height:52px!important;resize:none}
                .chatbot-panel-v30.minimized .cb-body,.chatbot-panel-v30.minimized .cb-input-area{display:none}
                .chatbot-panel-v30.maximized{width:600px!important;height:700px!important}
                .cb-header{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;background:linear-gradient(135deg,rgba(16,211,147,0.2),rgba(59,130,246,0.1));border-bottom:1px solid rgba(255,255,255,0.1);cursor:grab;user-select:none}
                .cb-header:active{cursor:grabbing}
                .cb-header-left{display:flex;align-items:center;gap:10px}
                .cb-avatar{width:40px;height:40px;background:linear-gradient(135deg,#10d393,#3b82f6);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:20px;box-shadow:0 4px 12px rgba(16,211,147,0.3)}
                .cb-info{display:flex;flex-direction:column}
                .cb-title{font-weight:700;font-size:14px;color:#fff}
                .cb-status{font-size:11px;color:#10d393;display:flex;align-items:center;gap:5px}
                .cb-dot{width:8px;height:8px;background:#10d393;border-radius:50%;animation:cbpulse 2s infinite}
                @keyframes cbpulse{0%,100%{opacity:1}50%{opacity:0.5}}
                .cb-btns{display:flex;gap:6px}
                .cb-btn{width:28px;height:28px;background:rgba(255,255,255,0.1);border:none;border-radius:6px;color:#aaa;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all 0.2s}
                .cb-btn:hover{background:rgba(255,255,255,0.2);color:#fff}
                .cb-btn.close:hover{background:#ef4444}
                .cb-body{flex:1;overflow-y:auto;padding:16px;display:flex;flex-direction:column;gap:12px}
                .cb-body::-webkit-scrollbar{width:6px}
                .cb-body::-webkit-scrollbar-thumb{background:rgba(255,255,255,0.2);border-radius:3px}
                .cb-msg{max-width:85%;padding:12px 16px;border-radius:16px;font-size:13px;line-height:1.5;animation:cbslide 0.3s ease}
                @keyframes cbslide{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
                .cb-msg.bot{background:linear-gradient(135deg,rgba(16,211,147,0.15),rgba(59,130,246,0.1));border:1px solid rgba(16,211,147,0.3);color:#e0e0e0;align-self:flex-start;border-bottom-left-radius:4px}
                .cb-msg.user{background:linear-gradient(135deg,#3b82f6,#2563eb);color:#fff;align-self:flex-end;border-bottom-right-radius:4px}
                .cb-msg b,.cb-msg strong{color:#10d393}
                .cb-quick{display:flex;flex-wrap:wrap;gap:6px;margin-top:10px}
                .cb-opt{padding:8px 12px;background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.15);border-radius:20px;color:#ccc;font-size:11px;cursor:pointer;transition:all 0.2s}
                .cb-opt:hover{background:rgba(16,211,147,0.2);border-color:#10d393;color:#10d393;transform:translateY(-2px)}
                .cb-input-area{display:flex;gap:8px;padding:12px 16px;background:rgba(0,0,0,0.3);border-top:1px solid rgba(255,255,255,0.1)}
                #chatbot-main-input{flex:1;padding:12px 16px;background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.15);border-radius:25px;color:#fff;font-size:13px;outline:none}
                #chatbot-main-input:focus{border-color:#10d393}
                #chatbot-main-input::placeholder{color:#666}
                .cb-send,.cb-wa{width:44px;height:44px;border:none;border-radius:50%;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:16px;transition:all 0.2s}
                .cb-send{background:linear-gradient(135deg,#10d393,#059669);color:#fff}
                .cb-send:hover{transform:scale(1.1);box-shadow:0 4px 15px rgba(16,211,147,0.4)}
                .cb-wa{background:linear-gradient(135deg,#25d366,#128c7e);color:#fff}
                .cb-wa:hover{transform:scale(1.1);box-shadow:0 4px 15px rgba(37,211,102,0.4)}
                .cb-typing{display:flex;gap:4px;padding:12px 16px;background:rgba(255,255,255,0.05);border-radius:16px;align-self:flex-start;border-bottom-left-radius:4px}
                .cb-typing span{width:8px;height:8px;background:#10d393;border-radius:50%;animation:cbbounce 1.4s infinite ease-in-out both}
                .cb-typing span:nth-child(1){animation-delay:-0.32s}
                .cb-typing span:nth-child(2){animation-delay:-0.16s}
                @keyframes cbbounce{0%,80%,100%{transform:scale(0)}40%{transform:scale(1)}}
                .chatbot-fab-main{position:fixed;bottom:20px;right:20px;width:60px;height:60px;background:linear-gradient(135deg,#10d393,#059669);border-radius:50%;border:none;cursor:pointer;box-shadow:0 6px 20px rgba(16,211,147,0.4);z-index:9999;display:flex;align-items:center;justify-content:center;font-size:24px;color:#fff;transition:all 0.3s}
                .chatbot-fab-main:hover{transform:scale(1.1) rotate(10deg);box-shadow:0 8px 30px rgba(16,211,147,0.5)}
                .chatbot-fab-main .fab-badge{position:absolute;top:-5px;right:-5px;width:20px;height:20px;background:#ef4444;border-radius:50%;font-size:11px;font-weight:700;display:flex;align-items:center;justify-content:center;animation:cbpulse 2s infinite}
                .chatbot-fab-main.no-badge .fab-badge{display:none}`;
            document.head.appendChild(style);
        },
        
        init() {
            this.addBotMessage('Hola!  Soy el asistente de **WIN-TEL v30**.\n\n 5 mdulos nuevos + anlisis QGIS.\n\nEn qu puedo ayudarte?', true);
            this.showQuickOptions([
                { text: ' Dibujar', action: 'dibujar' },
                { text: ' Subdividir', action: 'subdividir' },
                { text: ' Mdulos v30', action: 'funciones' },
                { text: ' Conteo', action: 'arboles' },
                { text: ' Drenaje', action: 'drenaje' },
                { text: ' Exportar', action: 'exportar' },
                { text: ' WhatsApp', action: 'contacto' }
            ]);
        },
        
        minimize() { document.getElementById('chatbot-main-panel')?.classList.toggle('minimized'); },
        maximize() { const p = document.getElementById('chatbot-main-panel'); p?.classList.remove('minimized'); p?.classList.toggle('maximized'); },
        
        startDrag(e) {
            if (e.target.closest('.cb-btn')) return;
            const panel = document.getElementById('chatbot-main-panel');
            if (!panel) return;
            this.isDragging = true;
            panel.classList.add('dragging');
            const rect = panel.getBoundingClientRect();
            this.dragOffset = { x: e.clientX - rect.left, y: e.clientY - rect.top };
            document.addEventListener('mousemove', this.onDrag);
            document.addEventListener('mouseup', this.stopDrag);
        },
        onDrag: (e) => {
            if (!Chatbot.isDragging) return;
            const panel = document.getElementById('chatbot-main-panel');
            if (!panel) return;
            let x = Math.max(0, Math.min(e.clientX - Chatbot.dragOffset.x, window.innerWidth - panel.offsetWidth));
            let y = Math.max(0, Math.min(e.clientY - Chatbot.dragOffset.y, window.innerHeight - panel.offsetHeight));
            panel.style.left = x + 'px'; panel.style.top = y + 'px'; panel.style.right = 'auto'; panel.style.bottom = 'auto';
        },
        stopDrag: () => {
            Chatbot.isDragging = false;
            document.getElementById('chatbot-main-panel')?.classList.remove('dragging');
            document.removeEventListener('mousemove', Chatbot.onDrag);
            document.removeEventListener('mouseup', Chatbot.stopDrag);
        },
        
        addBotMessage(text, isInit = false) {
            const body = document.getElementById('chatbot-main-body');
            if (!body) return;
            if (!isInit) {
                const typing = document.createElement('div');
                typing.className = 'cb-typing';
                typing.innerHTML = '<span></span><span></span><span></span>';
                body.appendChild(typing);
                body.scrollTop = body.scrollHeight;
                setTimeout(() => { typing.remove(); this.renderMessage(text, 'bot'); }, 500 + Math.random() * 300);
            } else { this.renderMessage(text, 'bot'); }
        },
        
        renderMessage(text, type) {
            const body = document.getElementById('chatbot-main-body');
            if (!body) return;
            const msg = document.createElement('div');
            msg.className = `cb-msg ${type}`;
            msg.innerHTML = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>');
            body.appendChild(msg);
            body.scrollTop = body.scrollHeight;
        },
        
        showQuickOptions(options) {
            const body = document.getElementById('chatbot-main-body');
            if (!body) return;
            const optsDiv = document.createElement('div');
            optsDiv.className = 'cb-quick';
            options.forEach(opt => {
                const btn = document.createElement('button');
                btn.className = 'cb-opt';
                btn.textContent = opt.text;
                btn.onclick = () => this.handleQuery(opt.action);
                optsDiv.appendChild(btn);
            });
            body.appendChild(optsDiv);
            body.scrollTop = body.scrollHeight;
        },
        
        sendMessage() {
            const input = document.getElementById('chatbot-main-input');
            if (!input || !input.value.trim()) return;
            const text = input.value.trim();
            input.value = '';
            this.renderMessage(text, 'user');
            this.handleQuery(text);
        },
        
        handleQuery(query) {
            const q = query.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '');
            let response = null;
            for (const [key, value] of Object.entries(this.knowledgeBase)) {
                if (q.includes(key) || key.includes(q)) { response = value; break; }
            }
            if (!response) {
                const kw = { 'dibujar|poligon|terreno': 'dibujar', 'subdiv|partir|dividir': 'subdividir', 'export|guardar|kml|pdf': 'exportar', 'ndvi|salud|vegeta': 'ndvi', 'plano|cajetin': 'plano', 'movimiento|corte|relleno': 'movimiento', 'compar|antes': 'comparador', 'riego|goteo': 'riego', 'arbol|conteo': 'arboles', 'drena|flujo': 'drenaje', 'funcion|modulo': 'funciones', 'version|nuevo': 'version', 'contact|whatsapp': 'contacto', 'ayuda|help': 'ayuda' };
                for (const [pattern, key] of Object.entries(kw)) { if (new RegExp(pattern).test(q)) { response = this.knowledgeBase[key]; break; } }
            }
            if (!response) response = ' No tengo info sobre eso.\n\nPuedo ayudarte con:\n Funciones v30\n Subdivisin\n Exportacin\n Contacto?';
            this.addBotMessage(response);
            setTimeout(() => this.showQuickOptions([{ text: ' Mdulos v30', action: 'funciones' }, { text: ' Exportar', action: 'exportar' }, { text: ' WhatsApp', action: 'contacto' }]), 600);
        },
        
        openWhatsApp() { window.open(`https://wa.me/${this.whatsappNumber}?text=${encodeURIComponent('Hola WINDOWSTELECOM \n\nNecesito ayuda con WIN-TEL v30.')}`, '_blank'); }
    };

    // Conectar con Assistant
    const originalAssistantToggle = Assistant.toggle;
    Assistant.toggle = function() { originalAssistantToggle.call(this); Chatbot.toggle(); };
    Assistant.updateAssistantContent = function() { Chatbot.toggle(); };

    // ========== CHATBOT FLOTANTE v30 - SECUNDARIO ==========
    const ChatbotFloat = {
        config: { whatsappNumber: '584124060610', appName: 'Geomatics PRO v30' },
        state: 'welcome', failedAttempts: 0, isOpen: false, isDragging: false, dragOffset: { x: 0, y: 0 }, conversationContext: [], hasStarted: false,
        
        keywords: { software: ['software', 'app', 'funciones', 'v30'], precios: ['precio', 'costo', 'licencia'], nuevos: ['nuevo', 'ndvi', 'plano', 'movimiento', 'comparador', 'riego'], soporte: ['ayuda', 'tutorial', 'como'], human: ['persona', 'whatsapp', 'contactar'] },
        
        responses: {
            welcome: { message: 'Hola!  Soy el asistente de <b>WIN-TEL v30</b>.\n\n 5 mdulos nuevos + QGIS.\n\nEn qu te ayudo?', options: [{ text: ' Novedades v30', icon: 'fa-sparkles', next: 'nuevos' }, { text: ' Funciones', icon: 'fa-laptop-code', next: 'software' }, { text: ' Tutoriales', icon: 'fa-graduation-cap', next: 'soporte' }, { text: ' Precios', icon: 'fa-tags', next: 'precios' }, { text: ' WhatsApp', icon: 'fa-phone', next: 'human' }] },
            nuevos: { message: '<b> 5 Mdulos Nuevos v30:</b>\n\n <b>NDVI</b> - Salud de cultivos\n <b>Planos</b> - PDF profesional\n <b>Mov. Tierras</b> - Corte/relleno\n <b>Comparador</b> - Antes/despus\n <b>Riego</b> - Diseo sistemas', options: [{ text: ' Ver todo', icon: 'fa-laptop-code', next: 'software' }, { text: ' WhatsApp', icon: 'fa-whatsapp', next: 'human' }, { text: ' Volver', icon: 'fa-arrow-left', next: 'welcome' }] },
            software: { message: '<b> WIN-TEL v30</b>\n\n 7 Subdivisiones\n 5 Mdulos nuevos\n 7 Herramientas QGIS\n 10+ Exportaciones', options: [{ text: ' Novedades', icon: 'fa-sparkles', next: 'nuevos' }, { text: ' Precios', icon: 'fa-dollar-sign', next: 'precios' }, { text: ' Volver', icon: 'fa-arrow-left', next: 'welcome' }] },
            precios: { message: ' <b>WIN-TEL v30</b>\n\n<b>Individual:</b> <span style="color:#10d393;font-size:18px;">$297 USD</span>\n<b>Profesional:</b> <span style="color:#fbbf24;font-size:18px;">$497 USD</span>\n\n Cdigo fuente\n Sin suscripcin', options: [{ text: ' Comprar', icon: 'fa-whatsapp', next: 'human' }, { text: ' Volver', icon: 'fa-arrow-left', next: 'welcome' }] },
            soporte: { message: ' <b>Tutoriales v30</b>\n\nQu aprender?', options: [{ text: ' Dibujar', icon: 'fa-draw-polygon', next: 'tut_dibujar' }, { text: ' Subdividir', icon: 'fa-cut', next: 'tut_subdiv' }, { text: ' Mdulos v30', icon: 'fa-sparkles', next: 'nuevos' }, { text: ' Soporte', icon: 'fa-headset', next: 'human' }] },
            tut_dibujar: { message: '<b> Dibujar:</b>\n\n1 Click \n2 Click en vrtices\n3 Doble click cerrar\n\nO importar KML/GeoJSON', options: [{ text: ' Subdividir', icon: 'fa-cut', next: 'tut_subdiv' }, { text: ' Volver', icon: 'fa-arrow-left', next: 'soporte' }] },
            tut_subdiv: { message: '<b> 7 Subdivisiones:</b>\n\n1 Grilla\n2 Biseccin\n3 Slicer\n4 Radial\n5 rea Fija\n6 N Lotes\n7 Catastro', options: [{ text: ' Dibujar', icon: 'fa-draw-polygon', next: 'tut_dibujar' }, { text: ' Volver', icon: 'fa-arrow-left', next: 'soporte' }] },
            human: { message: ' <b>Contacta a Joseph Castillo</b>\n\n +58 412-406-0610', options: [], isHuman: true },
            fallback: { message: ' No entend.\n\nTe ayudo con?', options: [{ text: ' Mdulos v30', icon: 'fa-sparkles', next: 'nuevos' }, { text: ' Funciones', icon: 'fa-laptop-code', next: 'software' }, { text: ' WhatsApp', icon: 'fa-phone', next: 'human' }] }
        },
        
        init() { this.createHTML(); this.addStyles(); console.log('ChatbotFloat v30 initialized'); },
        
        createHTML() {
            const html = `<button class="cf-fab" id="chatbot-float-btn" onclick="ChatbotFloat.toggle()"><i class="fa-solid fa-comments"></i><span class="cf-badge">1</span></button>
            <div class="cf-panel" id="chatbot-float-container">
                <div class="cf-header" onmousedown="ChatbotFloat.startDrag(event)">
                    <div class="cf-header-left"><div class="cf-avatar"></div><div class="cf-info"><div class="cf-name">Asistente WIN-TEL</div><div class="cf-status"><span class="cf-dot"></span>En lnea</div></div></div>
                    <div class="cf-btns"><button class="cf-btn" onclick="ChatbotFloat.minimize()"><i class="fa-solid fa-minus"></i></button><button class="cf-btn" onclick="ChatbotFloat.maximize()"><i class="fa-solid fa-expand"></i></button><button class="cf-btn close" onclick="ChatbotFloat.toggle()"><i class="fa-solid fa-times"></i></button></div>
                </div>
                <div class="cf-messages" id="chatbot-float-messages"></div>
                <div class="cf-input"><input type="text" id="chatbot-float-input" placeholder="Escribe..." onkeypress="ChatbotFloat.handleKeyPress(event)"><button class="cf-send" onclick="ChatbotFloat.sendUserMessage()"><i class="fa-solid fa-paper-plane"></i></button><button class="cf-wa" onclick="ChatbotFloat.openWhatsApp()"><i class="fa-brands fa-whatsapp"></i></button></div>
            </div>`;
            document.body.insertAdjacentHTML('beforeend', html);
        },
        
        addStyles() {
            if (document.getElementById('cf-styles')) return;
            const style = document.createElement('style');
            style.id = 'cf-styles';
            style.textContent = `
                .cf-fab{position:fixed;bottom:20px;left:20px;width:60px;height:60px;background:linear-gradient(135deg,#3b82f6,#2563eb);border-radius:50%;border:none;cursor:pointer;box-shadow:0 6px 25px rgba(59,130,246,0.5);z-index:9998;display:flex;align-items:center;justify-content:center;font-size:24px;color:#fff;transition:all 0.3s}
                .cf-fab:hover{transform:scale(1.1);box-shadow:0 8px 35px rgba(59,130,246,0.6)}
                .cf-badge{position:absolute;top:-5px;right:-5px;width:22px;height:22px;background:#ef4444;border-radius:50%;font-size:12px;font-weight:700;display:flex;align-items:center;justify-content:center;animation:cfpulse 2s infinite}
                .cf-fab.no-badge .cf-badge{display:none}
                @keyframes cfpulse{0%,100%{opacity:1}50%{opacity:0.5}}
                .cf-panel{position:fixed;bottom:90px;left:20px;width:360px;height:500px;background:linear-gradient(180deg,#1e293b,#0f172a);border-radius:16px;box-shadow:0 20px 60px rgba(0,0,0,0.5),0 0 0 1px rgba(255,255,255,0.1);z-index:9999;display:none;flex-direction:column;overflow:hidden;resize:both;min-width:300px;min-height:350px}
                .cf-panel.active{display:flex}
                .cf-panel.dragging{box-shadow:0 25px 70px rgba(0,0,0,0.6),0 0 0 2px #3b82f6}
                .cf-panel.minimized{height:52px!important;min-height:52px!important;resize:none}
                .cf-panel.minimized .cf-messages,.cf-panel.minimized .cf-input{display:none}
                .cf-panel.maximized{width:550px!important;height:650px!important}
                .cf-header{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;background:linear-gradient(135deg,rgba(59,130,246,0.2),rgba(139,92,246,0.1));border-bottom:1px solid rgba(255,255,255,0.1);cursor:grab;user-select:none}
                .cf-header:active{cursor:grabbing}
                .cf-header-left{display:flex;align-items:center;gap:10px}
                .cf-avatar{width:38px;height:38px;background:linear-gradient(135deg,#3b82f6,#8b5cf6);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:18px}
                .cf-info{display:flex;flex-direction:column}
                .cf-name{font-weight:700;font-size:13px;color:#fff}
                .cf-status{font-size:10px;color:#10d393;display:flex;align-items:center;gap:4px}
                .cf-dot{width:7px;height:7px;background:#10d393;border-radius:50%;animation:cfpulse 2s infinite}
                .cf-btns{display:flex;gap:5px}
                .cf-btn{width:26px;height:26px;background:rgba(255,255,255,0.1);border:none;border-radius:6px;color:#888;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:11px;transition:all 0.2s}
                .cf-btn:hover{background:rgba(255,255,255,0.2);color:#fff}
                .cf-btn.close:hover{background:#ef4444}
                .cf-messages{flex:1;overflow-y:auto;padding:14px;display:flex;flex-direction:column;gap:10px}
                .cf-messages::-webkit-scrollbar{width:5px}
                .cf-messages::-webkit-scrollbar-thumb{background:rgba(255,255,255,0.15);border-radius:3px}
                .cf-msg{max-width:85%;padding:10px 14px;border-radius:14px;font-size:12px;line-height:1.5;animation:cfslide 0.3s ease}
                @keyframes cfslide{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
                .cf-msg.bot{background:rgba(59,130,246,0.15);border:1px solid rgba(59,130,246,0.3);color:#ddd;align-self:flex-start;border-bottom-left-radius:4px}
                .cf-msg.user{background:linear-gradient(135deg,#8b5cf6,#7c3aed);color:#fff;align-self:flex-end;border-bottom-right-radius:4px}
                .cf-msg b{color:#60a5fa}
                .cf-opts{display:flex;flex-wrap:wrap;gap:5px;margin-top:8px}
                .cf-opt{padding:7px 11px;background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.12);border-radius:18px;color:#bbb;font-size:10px;cursor:pointer;transition:all 0.2s;display:flex;align-items:center;gap:5px}
                .cf-opt:hover{background:rgba(59,130,246,0.2);border-color:#3b82f6;color:#60a5fa}
                .cf-opt i{font-size:10px}
                .cf-wa-btn{display:inline-flex;align-items:center;gap:8px;margin-top:10px;padding:10px 16px;background:linear-gradient(135deg,#25d366,#128c7e);color:#fff;text-decoration:none;border-radius:25px;font-size:12px;font-weight:600;transition:all 0.2s}
                .cf-wa-btn:hover{transform:scale(1.05);box-shadow:0 4px 15px rgba(37,211,102,0.4)}
                .cf-input{display:flex;gap:6px;padding:10px 12px;background:rgba(0,0,0,0.3);border-top:1px solid rgba(255,255,255,0.1)}
                #chatbot-float-input{flex:1;padding:10px 14px;background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.12);border-radius:22px;color:#fff;font-size:12px;outline:none}
                #chatbot-float-input:focus{border-color:#3b82f6}
                #chatbot-float-input::placeholder{color:#555}
                .cf-send,.cf-wa{width:40px;height:40px;border:none;border-radius:50%;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:14px;transition:all 0.2s}
                .cf-send{background:linear-gradient(135deg,#3b82f6,#2563eb);color:#fff}
                .cf-send:hover{transform:scale(1.1)}
                .cf-wa{background:linear-gradient(135deg,#25d366,#128c7e);color:#fff}
                .cf-wa:hover{transform:scale(1.1)}
                .cf-typing{display:flex;gap:4px;padding:10px 14px;background:rgba(255,255,255,0.05);border-radius:14px;align-self:flex-start;border-bottom-left-radius:4px}
                .cf-typing span{width:7px;height:7px;background:#3b82f6;border-radius:50%;animation:cfbounce 1.4s infinite ease-in-out both}
                .cf-typing span:nth-child(1){animation-delay:-0.32s}
                .cf-typing span:nth-child(2){animation-delay:-0.16s}
                @keyframes cfbounce{0%,80%,100%{transform:scale(0)}40%{transform:scale(1)}}`;
            document.head.appendChild(style);
        },
        
        toggle() {
            const container = document.getElementById('chatbot-float-container');
            const btn = document.getElementById('chatbot-float-btn');
            if (!container) return;
            this.isOpen = !this.isOpen;
            container.classList.toggle('active', this.isOpen);
            if (btn) btn.classList.add('no-badge');
            if (this.isOpen && !this.hasStarted) { this.hasStarted = true; setTimeout(() => this.showResponse('welcome'), 300); }
            if (this.isOpen) setTimeout(() => document.getElementById('chatbot-float-input')?.focus(), 400);
        },
        
        minimize() { document.getElementById('chatbot-float-container')?.classList.toggle('minimized'); },
        maximize() { const p = document.getElementById('chatbot-float-container'); p?.classList.remove('minimized'); p?.classList.toggle('maximized'); },
        
        startDrag(e) {
            if (e.target.closest('.cf-btn')) return;
            const panel = document.getElementById('chatbot-float-container');
            if (!panel) return;
            this.isDragging = true;
            panel.classList.add('dragging');
            const rect = panel.getBoundingClientRect();
            this.dragOffset = { x: e.clientX - rect.left, y: e.clientY - rect.top };
            document.addEventListener('mousemove', this.onDrag);
            document.addEventListener('mouseup', this.stopDrag);
        },
        onDrag: (e) => {
            if (!ChatbotFloat.isDragging) return;
            const panel = document.getElementById('chatbot-float-container');
            if (!panel) return;
            let x = Math.max(0, Math.min(e.clientX - ChatbotFloat.dragOffset.x, window.innerWidth - panel.offsetWidth));
            let y = Math.max(0, Math.min(e.clientY - ChatbotFloat.dragOffset.y, window.innerHeight - panel.offsetHeight));
            panel.style.left = x + 'px'; panel.style.top = y + 'px'; panel.style.right = 'auto'; panel.style.bottom = 'auto';
        },
        stopDrag: () => {
            ChatbotFloat.isDragging = false;
            document.getElementById('chatbot-float-container')?.classList.remove('dragging');
            document.removeEventListener('mousemove', ChatbotFloat.onDrag);
            document.removeEventListener('mouseup', ChatbotFloat.stopDrag);
        },
        
        showResponse(state) {
            const response = this.responses[state] || this.responses.fallback;
            this.state = state;
            this.addTyping();
            setTimeout(() => { this.removeTyping(); this.addBotMessage(response.message, response.options, response.isHuman); }, 500 + Math.random() * 400);
        },
        
        addBotMessage(text, options = [], isHuman = false) {
            const div = document.getElementById('chatbot-float-messages');
            if (!div) return;
            const msg = document.createElement('div');
            msg.className = 'cf-msg bot';
            msg.innerHTML = `<p>${text.replace(/\n/g, '<br>')}</p>`;
            if (options.length > 0) {
                const opts = document.createElement('div');
                opts.className = 'cf-opts';
                options.forEach(opt => {
                    const btn = document.createElement('button');
                    btn.className = 'cf-opt';
                    btn.innerHTML = `<i class="fa-solid ${opt.icon || 'fa-chevron-right'}"></i> ${opt.text}`;
                    btn.onclick = () => this.showResponse(opt.next);
                    opts.appendChild(btn);
                });
                msg.appendChild(opts);
            }
            if (isHuman) {
                const wa = document.createElement('a');
                wa.className = 'cf-wa-btn';
                wa.href = `https://wa.me/${this.config.whatsappNumber}?text=${encodeURIComponent('Hola, necesito ayuda con WIN-TEL v30')}`;
                wa.target = '_blank';
                wa.innerHTML = '<i class="fa-brands fa-whatsapp"></i> Abrir WhatsApp';
                msg.appendChild(wa);
            }
            div.appendChild(msg);
            div.scrollTop = div.scrollHeight;
        },
        
        addUserMessage(text) {
            const div = document.getElementById('chatbot-float-messages');
            if (!div) return;
            const msg = document.createElement('div');
            msg.className = 'cf-msg user';
            msg.textContent = text;
            div.appendChild(msg);
            div.scrollTop = div.scrollHeight;
            this.conversationContext.push({ role: 'user', text });
        },
        
        addTyping() {
            const div = document.getElementById('chatbot-float-messages');
            if (!div) return;
            const t = document.createElement('div');
            t.className = 'cf-typing';
            t.id = 'cf-typing';
            t.innerHTML = '<span></span><span></span><span></span>';
            div.appendChild(t);
            div.scrollTop = div.scrollHeight;
        },
        
        removeTyping() { document.getElementById('cf-typing')?.remove(); },
        
        sendUserMessage() {
            const input = document.getElementById('chatbot-float-input');
            if (!input || !input.value.trim()) return;
            const text = input.value.trim();
            input.value = '';
            this.addUserMessage(text);
            const intent = this.detectIntent(text);
            if (intent) { this.failedAttempts = 0; this.showResponse(intent); }
            else {
                this.failedAttempts++;
                if (this.failedAttempts >= 2) { this.addTyping(); setTimeout(() => { this.removeTyping(); this.addBotMessage('Parece que necesitas atencin especializada. ', [], true); }, 700); }
                else this.showResponse('fallback');
            }
        },
        
        detectIntent(text) {
            const t = text.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '');
            for (const [intent, words] of Object.entries(this.keywords)) { if (words.some(w => t.includes(w))) return intent; }
            return null;
        },
        
        handleKeyPress(e) { if (e.key === 'Enter') this.sendUserMessage(); },
        openWhatsApp() { window.open(`https://wa.me/${this.config.whatsappNumber}?text=${encodeURIComponent('Hola, necesito ayuda con WIN-TEL v30')}`, '_blank'); }
    };

    // ========================================
    // PRV ADVANCED MODULE - TerraCut Integration
    // Dashboard, Ruta ptima, Simulador de Rotacin
    // ========================================
    const PRVAdvanced = {
        rotacionEstado: null,
        prvCalculos: { diasReposo: 30, diasOcupacion: 1 },
        simulacion: null,
        simMap: null,
        simParcelLayer: null,
        rutaLayer: null,
        
        // Obtener parcelas/bloques actuales
        getParcels() {
            return State.blocks.map((b, idx) => ({
                name: b.id || `Lote ${idx+1}`,
                ll: b.geo.geometry.coordinates[0].map(c => ({lat: c[1], lng: c[0]})),
                utm: b.geo.geometry.coordinates[0].map(c => {
                    const zone = UTM.getZone(c[0]);
                    const utm = UTM.fromLatLon(c[0], c[1], zone);
                    return {e: utm[0], n: utm[1]};
                }),
                area: b.area
            }));
        },
        
        // DASHBOARD PRV
        mostrarDashboard() {
            const parcels = this.getParcels();
            if(parcels.length === 0) {
                Toast.show('Primero divida el predio en lotes/potreros', 'error');
                return;
            }
            
            if(!this.rotacionEstado) {
                this.rotacionEstado = {
                    potreroActual: 0,
                    fechaIngreso: new Date().toISOString(),
                    historial: []
                };
            }
            
            let dashboard = document.getElementById('prvDashboard');
            if(!dashboard) {
                dashboard = this._crearDashboardHTML();
                document.body.appendChild(dashboard);
            }
            
            this._actualizarDashboard();
            dashboard.classList.add('active');
        },
        
        _crearDashboardHTML() {
            const div = document.createElement('div');
            div.id = 'prvDashboard';
            div.className = 'prv-dashboard';
            
            div.innerHTML = `
                <div class="prv-dashboard-header">
                    <span class="prv-dashboard-title"> Dashboard PRV</span>
                    <button class="prv-dashboard-close" onclick="PRVAdvanced.cerrarDashboard()"></button>
                </div>
                <div class="prv-dashboard-body">
                    <div class="prv-status-card" id="prvStatusCard">
                        <div class="prv-current-label"> POTRERO ACTUAL</div>
                        <div class="prv-current-value" id="prvCurrentName">--</div>
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:12px;">
                            <div>
                                <div style="font-size:10px;color:#6b7280;">Das de ocupacin</div>
                                <div style="font-size:20px;font-weight:700;" id="prvDiasOcupacion">0</div>
                            </div>
                            <div>
                                <div style="font-size:10px;color:#6b7280;">Prximo movimiento</div>
                                <div style="font-size:14px;font-weight:600;color:#059669;" id="prvProximoMov">--</div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:12px;">
                        <button onclick="PRVAdvanced.moverAlSiguiente()" class="btn" style="font-size:11px;padding:10px;">
                             Mover al siguiente
                        </button>
                        <button onclick="PRVAdvanced.registrarMovimiento()" class="btn btn-2" style="font-size:11px;padding:10px;">
                             Registrar movimiento
                        </button>
                    </div>
                    
                    <div style="font-size:11px;font-weight:700;color:#374151;margin-bottom:8px;">Estado de Potreros</div>
                    <div class="prv-potrero-grid" id="prvPotreroGrid"></div>
                    
                    <div style="margin-top:16px;padding:12px;background:#f9fafb;border-radius:8px;font-size:10px;">
                        <div style="font-weight:700;margin-bottom:6px;">Leyenda:</div>
                        <div style="display:flex;gap:12px;flex-wrap:wrap;">
                            <span><span style="display:inline-block;width:10px;height:10px;background:#10b981;border-radius:50%;"></span> Actual</span>
                            <span><span style="display:inline-block;width:10px;height:10px;background:#22c55e;border-radius:50%;"></span> Listo</span>
                            <span><span style="display:inline-block;width:10px;height:10px;background:#3b82f6;border-radius:50%;"></span> Reposo</span>
                            <span><span style="display:inline-block;width:10px;height:10px;background:#f59e0b;border-radius:50%;"></span> Alerta</span>
                        </div>
                    </div>
                </div>
            `;
            return div;
        },
        
        _actualizarDashboard() {
            const parcels = this.getParcels();
            const diasReposo = this.prvCalculos.diasReposo;
            const diasOcupacion = this.prvCalculos.diasOcupacion;
            const potreroActual = this.rotacionEstado?.potreroActual || 0;
            
            const fechaIngreso = new Date(this.rotacionEstado?.fechaIngreso || new Date());
            const hoy = new Date();
            const diasEnPotrero = Math.floor((hoy - fechaIngreso) / (1000 * 60 * 60 * 24));
            
            const nombreActual = parcels[potreroActual]?.name || '--';
            document.getElementById('prvCurrentName').textContent = nombreActual;
            document.getElementById('prvDiasOcupacion').textContent = diasEnPotrero;
            
            const diasRestantes = diasOcupacion - diasEnPotrero;
            const proxMov = document.getElementById('prvProximoMov');
            const statusCard = document.getElementById('prvStatusCard');
            
            if(diasRestantes <= 0) {
                proxMov.textContent = 'HOY!';
                proxMov.style.color = '#dc2626';
                statusCard.classList.add('warning');
            } else {
                proxMov.textContent = `En ${diasRestantes} da(s)`;
                proxMov.style.color = '#059669';
                statusCard.classList.remove('warning');
            }
            
            const grid = document.getElementById('prvPotreroGrid');
            grid.innerHTML = '';
            
            parcels.forEach((parcel, idx) => {
                let estado = 'resting';
                let diasDesdeUso = diasReposo + 1;
                
                if(idx === potreroActual) {
                    estado = 'active';
                } else {
                    const ultimoUso = this.rotacionEstado?.historial?.find(h => h.potrero === idx);
                    if(ultimoUso) {
                        diasDesdeUso = Math.floor((hoy - new Date(ultimoUso.fechaSalida)) / (1000 * 60 * 60 * 24));
                        if(diasDesdeUso >= diasReposo) estado = 'ready';
                        else if(diasDesdeUso >= diasReposo * 0.8) estado = 'warning';
                    } else {
                        estado = 'ready';
                    }
                }
                
                const item = document.createElement('div');
                item.className = `prv-potrero-item ${estado}`;
                item.onclick = () => this.seleccionarPotreroDashboard(idx);
                item.innerHTML = `
                    <div class="prv-potrero-status ${estado}"></div>
                    <div class="prv-potrero-name">${parcel.name}</div>
                    <div class="prv-potrero-days">${estado === 'active' ? `${diasEnPotrero}d` : estado === 'ready' ? '' : `${diasDesdeUso}d`}</div>
                `;
                grid.appendChild(item);
            });
        },
        
        cerrarDashboard() {
            const dashboard = document.getElementById('prvDashboard');
            if(dashboard) dashboard.classList.remove('active');
        },
        
        moverAlSiguiente() {
            const parcels = this.getParcels();
            if(parcels.length === 0) return;
            
            const actual = this.rotacionEstado?.potreroActual || 0;
            const siguiente = (actual + 1) % parcels.length;
            
            if(!this.rotacionEstado.historial) this.rotacionEstado.historial = [];
            this.rotacionEstado.historial.push({
                potrero: actual,
                fechaIngreso: this.rotacionEstado.fechaIngreso,
                fechaSalida: new Date().toISOString()
            });
            
            this.rotacionEstado.potreroActual = siguiente;
            this.rotacionEstado.fechaIngreso = new Date().toISOString();
            
            this._actualizarDashboard();
            Toast.show(`Ganado movido a: ${parcels[siguiente].name}`, 'success');
        },
        
        registrarMovimiento() {
            const parcels = this.getParcels();
            const opciones = parcels.map((p, i) => `${i + 1}. ${p.name}`).join('\n');
            const seleccion = prompt(`Seleccione potrero destino:\n\n${opciones}\n\nIngrese nmero:`);
            
            if(!seleccion) return;
            
            const idx = parseInt(seleccion) - 1;
            if(isNaN(idx) || idx < 0 || idx >= parcels.length) {
                Toast.show('Seleccin invlida', 'error');
                return;
            }
            
            const actual = this.rotacionEstado?.potreroActual || 0;
            
            if(!this.rotacionEstado.historial) this.rotacionEstado.historial = [];
            if(actual !== idx) {
                this.rotacionEstado.historial.push({
                    potrero: actual,
                    fechaIngreso: this.rotacionEstado.fechaIngreso,
                    fechaSalida: new Date().toISOString()
                });
            }
            
            this.rotacionEstado.potreroActual = idx;
            this.rotacionEstado.fechaIngreso = new Date().toISOString();
            
            this._actualizarDashboard();
            Toast.show(`Movimiento registrado a: ${parcels[idx].name}`, 'success');
        },
        
        seleccionarPotreroDashboard(idx) {
            const parcels = this.getParcels();
            if(parcels[idx] && parcels[idx].ll.length > 0) {
                const bounds = L.latLngBounds(parcels[idx].ll);
                State.map.fitBounds(bounds, {padding: [50, 50]});
            }
        },
        
        // RUTA PTIMA DE PASTOREO
        calcularRutaOptima() {
            const parcels = this.getParcels();
            if(parcels.length < 2) {
                Toast.show('Necesita al menos 2 lotes para calcular ruta', 'error');
                return;
            }
            
            const centroides = parcels.map((p, idx) => {
                const sumE = p.utm.reduce((s, u) => s + u.e, 0) / p.utm.length;
                const sumN = p.utm.reduce((s, u) => s + u.n, 0) / p.utm.length;
                const sumLat = p.ll.reduce((s, l) => s + l.lat, 0) / p.ll.length;
                const sumLng = p.ll.reduce((s, l) => s + l.lng, 0) / p.ll.length;
                return { idx, name: p.name, e: sumE, n: sumN, ll: {lat: sumLat, lng: sumLng} };
            });
            
            const ruta = this._calcularTSP(centroides);
            this._dibujarRutaOptima(ruta);
            this._mostrarResumenRuta(ruta);
        },
        
        _calcularTSP(puntos) {
            const n = puntos.length;
            const visitados = new Array(n).fill(false);
            const ruta = [];
            let distanciaTotal = 0;
            let actual = 0;
            
            for(let i = 0; i < n; i++) {
                visitados[actual] = true;
                ruta.push({ orden: i + 1, ...puntos[actual] });
                
                let minDist = Infinity;
                let siguiente = -1;
                
                for(let j = 0; j < n; j++) {
                    if(!visitados[j]) {
                        const d = Math.sqrt(
                            Math.pow(puntos[actual].e - puntos[j].e, 2) +
                            Math.pow(puntos[actual].n - puntos[j].n, 2)
                        );
                        if(d < minDist) {
                            minDist = d;
                            siguiente = j;
                        }
                    }
                }
                
                if(siguiente >= 0) {
                    distanciaTotal += Math.sqrt(
                        Math.pow(puntos[actual].e - puntos[siguiente].e, 2) +
                        Math.pow(puntos[actual].n - puntos[siguiente].n, 2)
                    );
                    actual = siguiente;
                }
            }
            
            return { orden: ruta, distanciaTotal };
        },
        
        _dibujarRutaOptima(ruta) {
            if(this.rutaLayer) {
                State.map.removeLayer(this.rutaLayer);
            }
            
            this.rutaLayer = L.layerGroup().addTo(State.map);
            
            const coords = ruta.orden.map(p => [p.ll.lat, p.ll.lng]);
            const linea = L.polyline(coords, {
                color: '#8b5cf6',
                weight: 4,
                dashArray: '15, 10',
                className: 'route-line'
            }).addTo(this.rutaLayer);
            
            ruta.orden.forEach((p, idx) => {
                const marker = L.marker([p.ll.lat, p.ll.lng], {
                    icon: L.divIcon({
                        className: 'route-marker',
                        html: `<div class="route-marker">${idx + 1}</div>`,
                        iconSize: [28, 28],
                        iconAnchor: [14, 14]
                    })
                }).addTo(this.rutaLayer);
                
                marker.bindTooltip(`${idx + 1}. ${p.name}`, { permanent: false, direction: 'top' });
            });
            
            State.map.fitBounds(linea.getBounds(), {padding: [50, 50]});
        },
        
        _mostrarResumenRuta(ruta) {
            let mensaje = ' RUTA PTIMA DE PASTOREO\n\nOrden recomendado:\n' + ''.repeat(25) + '\n';
            ruta.orden.forEach((p, idx) => { mensaje += `${idx + 1}. ${p.name}\n`; });
            mensaje += ''.repeat(25) + `\nDistancia total: ${Math.round(ruta.distanciaTotal)} metros\n\n Ruta dibujada en el mapa`;
            alert(mensaje);
            Toast.show('Ruta ptima calculada y dibujada', 'success');
        },
        
        // SIMULADOR DE ROTACIN
        iniciarSimulacion() {
            const parcels = this.getParcels();
            if(parcels.length < 2) {
                Toast.show('Necesita al menos 2 lotes para simular', 'error');
                return;
            }
            
            let overlay = document.getElementById('simulationOverlay');
            if(!overlay) {
                overlay = this._crearSimulacionHTML();
                document.body.appendChild(overlay);
            }
            
            this.simulacion = {
                activa: false,
                paso: 0,
                velocidad: 1000,
                diasReposo: this.prvCalculos.diasReposo,
                diasOcupacion: this.prvCalculos.diasOcupacion,
                intervalId: null
            };
            
            overlay.classList.add('active');
            setTimeout(() => this._initMapaSimulacion(), 100);
        },
        
        _crearSimulacionHTML() {
            const div = document.createElement('div');
            div.id = 'simulationOverlay';
            div.className = 'simulation-overlay';
            
            div.innerHTML = `
                <div class="simulation-panel">
                    <div class="simulation-header">
                        <span class="simulation-title"> Simulador de Rotacin PRV</span>
                        <button onclick="PRVAdvanced.cerrarSimulacion()" style="background:rgba(255,255,255,0.2);border:none;color:white;padding:8px 16px;border-radius:8px;cursor:pointer;"> Cerrar</button>
                    </div>
                    <div class="simulation-body">
                        <div class="simulation-map-container">
                            <div id="simMap" class="simulation-map"></div>
                            <div style="position:absolute;top:10px;left:10px;background:white;padding:12px 16px;border-radius:10px;box-shadow:0 4px 12px rgba(0,0,0,0.15);z-index:1000;">
                                <div style="font-size:10px;color:#6b7280;text-transform:uppercase;font-weight:700;">Da de simulacin</div>
                                <div style="font-size:28px;font-weight:800;color:#1f2937;" id="simDia">0</div>
                            </div>
                            <div style="position:absolute;top:10px;right:10px;background:linear-gradient(135deg,#10b981,#059669);color:white;padding:12px 16px;border-radius:10px;box-shadow:0 4px 12px rgba(0,0,0,0.15);z-index:1000;">
                                <div style="font-size:10px;text-transform:uppercase;font-weight:700;"> Potrero Actual</div>
                                <div style="font-size:18px;font-weight:800;" id="simPotreroActual">--</div>
                            </div>
                        </div>
                        <div class="simulation-controls">
                            <h4 style="margin:0 0 16px 0;font-size:14px;color:#374151;"> Configuracin</h4>
                            <div style="margin-bottom:16px;">
                                <label style="font-size:11px;font-weight:600;color:#6b7280;display:block;margin-bottom:4px;">Das de Reposo</label>
                                <input type="number" id="simDiasReposo" value="30" min="1" max="90" style="width:100%;padding:8px;border:1px solid #d1d5db;border-radius:6px;">
                            </div>
                            <div style="margin-bottom:16px;">
                                <label style="font-size:11px;font-weight:600;color:#6b7280;display:block;margin-bottom:4px;">Das de Ocupacin</label>
                                <input type="number" id="simDiasOcupacion" value="1" min="1" max="7" style="width:100%;padding:8px;border:1px solid #d1d5db;border-radius:6px;">
                            </div>
                            <div style="margin-bottom:16px;">
                                <label style="font-size:11px;font-weight:600;color:#6b7280;display:block;margin-bottom:4px;">Velocidad</label>
                                <select id="simVelocidad" style="width:100%;padding:8px;border:1px solid #d1d5db;border-radius:6px;">
                                    <option value="2000">Lenta (2s/da)</option>
                                    <option value="1000" selected>Normal (1s/da)</option>
                                    <option value="500">Rpida (0.5s/da)</option>
                                    <option value="200">Muy rpida (0.2s/da)</option>
                                </select>
                            </div>
                            <div style="background:#f9fafb;border-radius:8px;padding:12px;margin-top:16px;">
                                <div style="font-size:11px;font-weight:700;color:#374151;margin-bottom:8px;"> Estadsticas</div>
                                <div style="font-size:12px;color:#6b7280;">
                                    <div style="display:flex;justify-content:space-between;margin-bottom:4px;"><span>Ciclo completo:</span><strong id="simCiclo">--</strong> das</div>
                                    <div style="display:flex;justify-content:space-between;margin-bottom:4px;"><span>Rotaciones:</span><strong id="simRotaciones">0</strong></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="simulation-timeline">
                        <div class="simulation-progress"><div class="simulation-progress-bar" id="simProgress" style="width:0%;"></div></div>
                        <div class="simulation-play-controls">
                            <button class="sim-btn sim-btn-secondary" onclick="PRVAdvanced.simRetroceder()"></button>
                            <button class="sim-btn sim-btn-secondary" onclick="PRVAdvanced.simPasoAtras()"></button>
                            <button class="sim-btn sim-btn-play" id="simPlayBtn" onclick="PRVAdvanced.simTogglePlay()"></button>
                            <button class="sim-btn sim-btn-secondary" onclick="PRVAdvanced.simPasoAdelante()"></button>
                            <button class="sim-btn sim-btn-secondary" onclick="PRVAdvanced.simAvanzar()"></button>
                        </div>
                    </div>
                </div>
            `;
            return div;
        },
        
        _initMapaSimulacion() {
            const parcels = this.getParcels();
            if(this.simMap) {
                this.simMap.remove();
            }
            
            this.simMap = L.map('simMap').setView([0, 0], 15);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(this.simMap);
            this.simParcelLayer = L.layerGroup().addTo(this.simMap);
            
            const bounds = [];
            parcels.forEach((parcel, idx) => {
                const poly = L.polygon(parcel.ll, {
                    color: '#6b7280',
                    weight: 2,
                    fillColor: '#e5e7eb',
                    fillOpacity: 0.5
                }).addTo(this.simParcelLayer);
                
                poly.parcelIndex = idx;
                bounds.push(...parcel.ll);
                
                const cx = parcel.ll.reduce((s, l) => s + l.lat, 0) / parcel.ll.length;
                const cy = parcel.ll.reduce((s, l) => s + l.lng, 0) / parcel.ll.length;
                L.marker([cx, cy], {
                    icon: L.divIcon({
                        className: 'parcel-label',
                        html: `<div style="background:white;padding:4px 8px;border-radius:4px;font-size:10px;font-weight:700;">${parcel.name}</div>`,
                        iconSize: [60, 20],
                        iconAnchor: [30, 10]
                    })
                }).addTo(this.simParcelLayer);
            });
            
            if(bounds.length > 0) {
                this.simMap.fitBounds(L.latLngBounds(bounds), {padding: [30, 30]});
            }
            
            const diasOcupacion = parseInt(document.getElementById('simDiasOcupacion').value) || 1;
            const ciclo = parcels.length * diasOcupacion;
            document.getElementById('simCiclo').textContent = ciclo;
            
            this._actualizarSimulacion(0);
        },
        
        simTogglePlay() {
            if(!this.simulacion) return;
            
            this.simulacion.activa = !this.simulacion.activa;
            const btn = document.getElementById('simPlayBtn');
            
            if(this.simulacion.activa) {
                btn.textContent = '';
                this._ejecutarSimulacion();
            } else {
                btn.textContent = '';
                if(this.simulacion.intervalId) clearInterval(this.simulacion.intervalId);
            }
        },
        
        _ejecutarSimulacion() {
            const parcels = this.getParcels();
            const velocidad = parseInt(document.getElementById('simVelocidad').value) || 1000;
            const diasOcupacion = parseInt(document.getElementById('simDiasOcupacion').value) || 1;
            const totalDias = parcels.length * diasOcupacion * 3;
            
            this.simulacion.intervalId = setInterval(() => {
                if(!this.simulacion.activa) return;
                
                this.simulacion.paso++;
                if(this.simulacion.paso >= totalDias) this.simulacion.paso = 0;
                
                this._actualizarSimulacion(this.simulacion.paso);
            }, velocidad);
        },
        
        _actualizarSimulacion(dia) {
            const parcels = this.getParcels();
            const diasOcupacion = parseInt(document.getElementById('simDiasOcupacion').value) || 1;
            const potreroActual = Math.floor(dia / diasOcupacion) % parcels.length;
            const ciclo = parcels.length * diasOcupacion;
            const rotaciones = Math.floor(dia / ciclo);
            
            document.getElementById('simDia').textContent = dia;
            document.getElementById('simPotreroActual').textContent = parcels[potreroActual]?.name || '--';
            document.getElementById('simRotaciones').textContent = rotaciones;
            
            const progreso = ((dia % ciclo) / ciclo) * 100;
            document.getElementById('simProgress').style.width = `${progreso}%`;
            
            this.simParcelLayer.eachLayer(layer => {
                if(layer.parcelIndex !== undefined) {
                    const idx = layer.parcelIndex;
                    const diasReposo = parseInt(document.getElementById('simDiasReposo').value) || 30;
                    
                    if(idx === potreroActual) {
                        layer.setStyle({ fillColor: '#10b981', fillOpacity: 0.7, color: '#059669', weight: 3 });
                    } else {
                        const diasDesde = (dia - (idx * diasOcupacion)) % ciclo;
                        if(diasDesde < 0 || diasDesde >= diasReposo) {
                            layer.setStyle({ fillColor: '#22c55e', fillOpacity: 0.4, color: '#16a34a', weight: 2 });
                        } else if(diasDesde >= diasReposo * 0.7) {
                            layer.setStyle({ fillColor: '#fbbf24', fillOpacity: 0.4, color: '#f59e0b', weight: 2 });
                        } else {
                            layer.setStyle({ fillColor: '#93c5fd', fillOpacity: 0.3, color: '#3b82f6', weight: 2 });
                        }
                    }
                }
            });
        },
        
        simPasoAdelante() {
            if(!this.simulacion) return;
            this.simulacion.paso++;
            this._actualizarSimulacion(this.simulacion.paso);
        },
        
        simPasoAtras() {
            if(!this.simulacion) return;
            this.simulacion.paso = Math.max(0, this.simulacion.paso - 1);
            this._actualizarSimulacion(this.simulacion.paso);
        },
        
        simAvanzar() {
            if(!this.simulacion) return;
            const diasOcupacion = parseInt(document.getElementById('simDiasOcupacion').value) || 1;
            this.simulacion.paso += diasOcupacion;
            this._actualizarSimulacion(this.simulacion.paso);
        },
        
        simRetroceder() {
            if(!this.simulacion) return;
            this.simulacion.paso = 0;
            this._actualizarSimulacion(0);
        },
        
        cerrarSimulacion() {
            if(this.simulacion?.intervalId) clearInterval(this.simulacion.intervalId);
            const overlay = document.getElementById('simulationOverlay');
            if(overlay) overlay.classList.remove('active');
            if(this.simMap) {
                this.simMap.remove();
                this.simMap = null;
            }
        }
    };

    // ========================================
    // COMPOSER PRO MODULE - Composicin Profesional
    // ========================================
    const ComposerPro = {
        config: {
            pageSize: 'a4',
            orientation: 'landscape',
            zoom: 0.5,
            elements: { map: true, grid: true, scaleBar: true, northArrow: true, legend: true, titleBox: true, coordTable: true, cajetin: true },
            project: { nombre: 'PLANO DE SUBDIVISIN', propietario: '', ubicacion: '', municipio: '', estado: '', elaborado: '' }
        },
        mapBounds: null,
        
        abrir() {
            if(State.blocks.length === 0 && (!State.polygon || State.polygon.length < 3)) {
                Toast.show('Dibuje un polgono o cree subdivisiones primero', 'error');
                return;
            }
            
            let overlay = document.getElementById('composerOverlay');
            if(!overlay) {
                overlay = this._crearHTML();
                document.body.appendChild(overlay);
            }
            
            overlay.classList.add('active');
            setTimeout(() => {
                this._capturarMapa();
                this._actualizarPreview();
            }, 100);
        },
        
        cerrar() {
            const overlay = document.getElementById('composerOverlay');
            if(overlay) overlay.classList.remove('active');
        },
        
        _crearHTML() {
            const div = document.createElement('div');
            div.id = 'composerOverlay';
            div.className = 'composer-overlay';
            
            div.innerHTML = `
                <div class="composer-container">
                    <div class="composer-header">
                        <div class="composer-title"><span style="font-size:24px;"></span><span>Composicin de Impresin Profesional</span></div>
                        <div class="composer-actions">
                            <button onclick="ComposerPro.exportarPDF()" class="composer-btn composer-btn-primary"> Exportar PDF</button>
                            <button onclick="ComposerPro.exportarPNG()" class="composer-btn composer-btn-secondary"> Exportar PNG</button>
                            <button onclick="ComposerPro.cerrar()" class="composer-btn composer-btn-close"></button>
                        </div>
                    </div>
                    <div class="composer-sidebar">
                        <h3> Configuracin de Pgina</h3>
                        <div class="composer-group">
                            <div class="composer-input-group">
                                <label>Tamao de Papel</label>
                                <select id="compPageSize" class="composer-select" onchange="ComposerPro._cambiarTamano()">
                                    <option value="a4">A4 (210  297 mm)</option>
                                    <option value="a3">A3 (297  420 mm)</option>
                                </select>
                            </div>
                            <div class="composer-input-group">
                                <label>Orientacin</label>
                                <select id="compOrientation" class="composer-select" onchange="ComposerPro._cambiarOrientacion()">
                                    <option value="landscape">Horizontal (Paisaje)</option>
                                    <option value="portrait">Vertical (Retrato)</option>
                                </select>
                            </div>
                        </div>
                        <h3> Elementos del Layout</h3>
                        <div class="composer-group">
                            <label class="composer-checkbox"><input type="checkbox" id="compElMap" checked onchange="ComposerPro._actualizarPreview()"><span> Mapa Principal</span></label>
                            <label class="composer-checkbox"><input type="checkbox" id="compElGrid" checked onchange="ComposerPro._actualizarPreview()"><span> Grilla UTM</span></label>
                            <label class="composer-checkbox"><input type="checkbox" id="compElScale" checked onchange="ComposerPro._actualizarPreview()"><span> Barra de Escala</span></label>
                            <label class="composer-checkbox"><input type="checkbox" id="compElNorth" checked onchange="ComposerPro._actualizarPreview()"><span> Flecha del Norte</span></label>
                            <label class="composer-checkbox"><input type="checkbox" id="compElLegend" checked onchange="ComposerPro._actualizarPreview()"><span> Leyenda</span></label>
                            <label class="composer-checkbox"><input type="checkbox" id="compElTitle" checked onchange="ComposerPro._actualizarPreview()"><span> Ttulo</span></label>
                            <label class="composer-checkbox"><input type="checkbox" id="compElTable" checked onchange="ComposerPro._actualizarPreview()"><span> Tabla de Coordenadas</span></label>
                            <label class="composer-checkbox"><input type="checkbox" id="compElCajetin" checked onchange="ComposerPro._actualizarPreview()"><span> Cajetn</span></label>
                        </div>
                    </div>
                    <div class="composer-canvas-area" id="composerCanvasArea">
                        <div id="composerPage" class="composer-page composer-page-a4-h"></div>
                        <div class="composer-zoom">
                            <button onclick="ComposerPro._zoom(-0.1)"></button>
                            <span id="composerZoomLevel">50%</span>
                            <button onclick="ComposerPro._zoom(0.1)">+</button>
                            <button onclick="ComposerPro._zoom('fit')"></button>
                        </div>
                    </div>
                    <div class="composer-sidebar">
                        <h3> Informacin del Proyecto</h3>
                        <div class="composer-group">
                            <div class="composer-input-group"><label>Nombre del Proyecto</label><input type="text" id="compProjNombre" class="composer-input" value="PLANO DE SUBDIVISIN" onchange="ComposerPro._actualizarPreview()"></div>
                            <div class="composer-input-group"><label>Propietario</label><input type="text" id="compProjPropietario" class="composer-input" placeholder="Nombre del propietario" onchange="ComposerPro._actualizarPreview()"></div>
                            <div class="composer-input-group"><label>Ubicacin</label><input type="text" id="compProjUbicacion" class="composer-input" placeholder="Sector / Localidad" onchange="ComposerPro._actualizarPreview()"></div>
                            <div class="composer-input-group"><label>Municipio</label><input type="text" id="compProjMunicipio" class="composer-input" placeholder="Municipio" onchange="ComposerPro._actualizarPreview()"></div>
                            <div class="composer-input-group"><label>Estado</label><input type="text" id="compProjEstado" class="composer-input" placeholder="Estado" onchange="ComposerPro._actualizarPreview()"></div>
                            <div class="composer-input-group"><label>Elaborado por</label><input type="text" id="compProjElaborado" class="composer-input" placeholder="Tcnico responsable" onchange="ComposerPro._actualizarPreview()"></div>
                            <div class="composer-input-group"><label>Fecha</label><input type="date" id="compProjFecha" class="composer-input" onchange="ComposerPro._actualizarPreview()"></div>
                        </div>
                        <h3> Estadsticas</h3>
                        <div class="composer-group" style="background:#1e293b;padding:15px;border-radius:8px;">
                            <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;font-size:12px;">
                                <div><div style="color:#64748b;font-size:10px;">LOTES</div><div style="color:#10b981;font-size:20px;font-weight:800;" id="compStatLotes">0</div></div>
                                <div><div style="color:#64748b;font-size:10px;">REA TOTAL</div><div style="color:#10b981;font-size:20px;font-weight:800;" id="compStatArea">0 Ha</div></div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            return div;
        },
        
        _capturarMapa() {
            let bounds;
            if(State.blocks.length > 0) {
                const allCoords = State.blocks.flatMap(b => b.geo.geometry.coordinates[0].map(c => L.latLng(c[1], c[0])));
                bounds = L.latLngBounds(allCoords);
            } else if(State.polygon && State.polygon.length > 0) {
                bounds = L.latLngBounds(State.polygon.map(c => L.latLng(c[1], c[0])));
            }
            if(bounds) this.mapBounds = bounds;
        },
        
        _actualizarPreview() {
            const page = document.getElementById('composerPage');
            if(!page) return;
            
            this.config.elements.map = document.getElementById('compElMap')?.checked ?? true;
            this.config.elements.grid = document.getElementById('compElGrid')?.checked ?? true;
            this.config.elements.scaleBar = document.getElementById('compElScale')?.checked ?? true;
            this.config.elements.northArrow = document.getElementById('compElNorth')?.checked ?? true;
            this.config.elements.legend = document.getElementById('compElLegend')?.checked ?? true;
            this.config.elements.titleBox = document.getElementById('compElTitle')?.checked ?? true;
            this.config.elements.coordTable = document.getElementById('compElTable')?.checked ?? true;
            this.config.elements.cajetin = document.getElementById('compElCajetin')?.checked ?? true;
            
            const sizeClass = `composer-page-${this.config.pageSize}${this.config.orientation === 'landscape' ? '-h' : ''}`;
            page.className = `composer-page ${sizeClass}`;
            page.style.transform = `scale(${this.config.zoom})`;
            
            document.getElementById('composerZoomLevel').textContent = Math.round(this.config.zoom * 100) + '%';
            
            const pageSizes = { 'a4': { w: 297, h: 210 }, 'a3': { w: 420, h: 297 } };
            let pageW = pageSizes[this.config.pageSize].w;
            let pageH = pageSizes[this.config.pageSize].h;
            if(this.config.orientation === 'portrait') [pageW, pageH] = [pageH, pageW];
            
            const mmToPx = 3.78;
            const pxW = pageW * mmToPx;
            const pxH = pageH * mmToPx;
            
            page.innerHTML = this._generarLayoutHTML(pxW, pxH);
            this._actualizarEstadisticas();
            
            const fechaInput = document.getElementById('compProjFecha');
            if(fechaInput && !fechaInput.value) fechaInput.value = new Date().toISOString().split('T')[0];
        },
        
        _generarLayoutHTML(pageW, pageH) {
            const cfg = this.config;
            const margin = 40;
            const mapW = pageW - margin * 2 - 200;
            const mapH = pageH - margin * 2 - 100;
            const mapX = margin;
            const mapY = margin;
            
            let html = `<div style="position:absolute;top:${margin/2}px;left:${margin/2}px;width:${pageW - margin}px;height:${pageH - margin}px;border:2px solid #0f172a;"></div>`;
            
            if(cfg.elements.map) html += this._generarMapaSVG(mapX, mapY, mapW, mapH);
            if(cfg.elements.northArrow) html += this._generarFlechaNorte(mapX + mapW - 60, mapY + 10);
            if(cfg.elements.scaleBar) html += this._generarBarraEscala(mapX + 10, mapY + mapH - 40);
            if(cfg.elements.legend) html += this._generarLeyenda(mapX + mapW + 10, mapY, 180, 200);
            if(cfg.elements.titleBox) html += this._generarTitulo(mapX + mapW + 10, mapY + 210, 180);
            if(cfg.elements.coordTable && State.blocks.length > 0) html += this._generarTabla(mapX + mapW + 10, mapY + 320, 180, mapH - 320);
            if(cfg.elements.cajetin) html += this._generarCajetin(mapX, mapY + mapH + 10, mapW + 190, 70);
            
            return html;
        },
        
        _generarMapaSVG(x, y, w, h) {
            let svg = `<div class="layout-map" style="left:${x}px;top:${y}px;width:${w}px;height:${h}px;"><svg width="${w}" height="${h}" viewBox="0 0 ${w} ${h}" style="background:#f8fafc;">`;
            
            if(!this.mapBounds) {
                svg += `<text x="${w/2}" y="${h/2}" text-anchor="middle" fill="#94a3b8" font-size="14">Sin datos de mapa</text>`;
            } else {
                const bounds = this.mapBounds;
                const minLat = bounds.getSouth(), maxLat = bounds.getNorth();
                const minLng = bounds.getWest(), maxLng = bounds.getEast();
                const padLat = (maxLat - minLat) * 0.1, padLng = (maxLng - minLng) * 0.1;
                
                const toX = (lng) => ((lng - (minLng - padLng)) / ((maxLng + padLng) - (minLng - padLng))) * w;
                const toY = (lat) => h - ((lat - (minLat - padLat)) / ((maxLat + padLat) - (minLat - padLat))) * h;
                
                const COLORS = ['#10b981','#3b82f6','#f59e0b','#ef4444','#8b5cf6','#ec4899','#14b8a6','#f97316'];
                
                State.blocks.forEach((block, idx) => {
                    const coords = block.geo.geometry.coordinates[0];
                    const points = coords.map(c => `${toX(c[0])},${toY(c[1])}`).join(' ');
                    const color = COLORS[idx % COLORS.length];
                    svg += `<polygon points="${points}" fill="${color}" fill-opacity="0.3" stroke="${color}" stroke-width="1.5"/>`;
                    
                    const cx = coords.reduce((s, c) => s + toX(c[0]), 0) / coords.length;
                    const cy = coords.reduce((s, c) => s + toY(c[1]), 0) / coords.length;
                    svg += `<text x="${cx}" y="${cy}" text-anchor="middle" fill="#0f172a" font-size="10" font-weight="600">${block.id}</text>`;
                });
            }
            
            svg += `</svg></div>`;
            return svg;
        },
        
        _generarFlechaNorte(x, y) {
            return `<div class="layout-north-arrow" style="left:${x}px;top:${y}px;"><svg viewBox="0 0 50 70"><polygon points="25,0 35,50 25,40 15,50" fill="#0f172a"/><polygon points="25,0 35,50 25,40" fill="#64748b"/><text x="25" y="65" text-anchor="middle" font-size="12" font-weight="bold" fill="#0f172a">N</text></svg></div>`;
        },
        
        _generarBarraEscala(x, y) {
            return `<div class="layout-scale-bar" style="left:${x}px;top:${y}px;width:120px;"><div class="scale-bar-graphic"><div class="scale-bar-segment"></div><div class="scale-bar-segment"></div><div class="scale-bar-segment"></div><div class="scale-bar-segment"></div></div><div style="display:flex;justify-content:space-between;font-size:8px;"><span>0</span><span>100 m</span></div></div>`;
        },
        
        _generarLeyenda(x, y, w, h) {
            const COLORS = ['#10b981','#3b82f6','#f59e0b','#ef4444','#8b5cf6','#ec4899','#14b8a6','#f97316'];
            let html = `<div class="layout-legend" style="left:${x}px;top:${y}px;width:${w}px;"><div class="layout-legend-title">LEYENDA</div>`;
            
            State.blocks.slice(0, 10).forEach((block, idx) => {
                const area = ((block.area || 0) / 10000).toFixed(2);
                html += `<div class="layout-legend-item"><div style="width:16px;height:12px;background:${COLORS[idx % COLORS.length]};border-radius:2px;opacity:0.7;"></div><span>${block.id} (${area} Ha)</span></div>`;
            });
            
            if(State.blocks.length > 10) html += `<div style="font-size:9px;color:#666;margin-top:4px;">... y ${State.blocks.length - 10} ms</div>`;
            
            html += `</div>`;
            return html;
        },
        
        _generarTitulo(x, y, w) {
            const nombre = document.getElementById('compProjNombre')?.value || 'PLANO DE SUBDIVISIN';
            const ubicacion = document.getElementById('compProjUbicacion')?.value || '';
            return `<div class="layout-title-box" style="left:${x}px;top:${y}px;width:${w}px;"><div style="font-weight:800;font-size:12px;color:#0f172a;text-transform:uppercase;margin-bottom:4px;">${nombre}</div><div style="font-size:10px;color:#475569;">${ubicacion}</div></div>`;
        },
        
        _generarTabla(x, y, w, maxH) {
            let html = `<div class="layout-table" style="left:${x}px;top:${y}px;width:${w}px;max-height:${maxH}px;overflow:hidden;"><table><thead><tr><th>#</th><th>Nombre</th><th>rea (Ha)</th></tr></thead><tbody>`;
            State.blocks.slice(0, 15).forEach((b, i) => {
                const area = ((b.area || 0) / 10000).toFixed(2);
                html += `<tr><td>${i+1}</td><td>${b.id}</td><td>${area}</td></tr>`;
            });
            html += `</tbody></table>`;
            if(State.blocks.length > 15) html += `<div style="text-align:center;font-size:8px;padding:4px;background:#f1f5f9;">... ${State.blocks.length - 15} ms</div>`;
            html += `</div>`;
            return html;
        },
        
        _generarCajetin(x, y, w, h) {
            const nombre = document.getElementById('compProjNombre')?.value || 'PLANO DE SUBDIVISIN';
            const propietario = document.getElementById('compProjPropietario')?.value || '';
            const ubicacion = document.getElementById('compProjUbicacion')?.value || '';
            const municipio = document.getElementById('compProjMunicipio')?.value || '';
            const estado = document.getElementById('compProjEstado')?.value || '';
            const elaborado = document.getElementById('compProjElaborado')?.value || '';
            const fecha = document.getElementById('compProjFecha')?.value || new Date().toLocaleDateString();
            
            return `<div class="layout-cajetin" style="left:${x}px;top:${y}px;width:${w}px;height:${h}px;grid-template-columns:150px 1fr 120px 100px 100px;grid-template-rows:1fr 1fr;">
                <div class="cajetin-cell" style="grid-row:1/3;justify-content:center;flex-direction:column;text-align:center;"><div style="font-size:10px;font-weight:700;"><div style="font-size:14px;"></div><div>WIN-TEL</div><div style="font-size:8px;color:#64748b;">Geomatics PRO</div></div></div>
                <div class="cajetin-cell cajetin-header" style="grid-column:2/3;">${nombre.toUpperCase()}</div>
                <div class="cajetin-cell" style="flex-direction:column;align-items:flex-start;"><div class="cajetin-label">Propietario</div><div class="cajetin-value">${propietario}</div></div>
                <div class="cajetin-cell" style="flex-direction:column;align-items:flex-start;"><div class="cajetin-label">Escala</div><div class="cajetin-value">1:Variable</div></div>
                <div class="cajetin-cell" style="flex-direction:column;align-items:flex-start;"><div class="cajetin-label">Zona UTM</div><div class="cajetin-value">--</div></div>
                <div class="cajetin-cell" style="flex-direction:column;align-items:flex-start;"><div class="cajetin-label">Ubicacin</div><div class="cajetin-value">${ubicacion}${municipio ? ', ' + municipio : ''}${estado ? ', ' + estado : ''}</div></div>
                <div class="cajetin-cell" style="flex-direction:column;align-items:flex-start;"><div class="cajetin-label">Elaborado</div><div class="cajetin-value">${elaborado}</div></div>
                <div class="cajetin-cell" style="flex-direction:column;align-items:flex-start;"><div class="cajetin-label">Fecha</div><div class="cajetin-value">${fecha}</div></div>
                <div class="cajetin-cell" style="flex-direction:column;align-items:flex-start;"><div class="cajetin-label">Hoja</div><div class="cajetin-value">1 de 1</div></div>
            </div>`;
        },
        
        _actualizarEstadisticas() {
            const numLotes = State.blocks.length;
            const areaTotal = State.blocks.reduce((s, b) => s + (b.area || 0), 0) / 10000;
            document.getElementById('compStatLotes').textContent = numLotes;
            document.getElementById('compStatArea').textContent = areaTotal.toFixed(2) + ' Ha';
        },
        
        _cambiarTamano() {
            this.config.pageSize = document.getElementById('compPageSize').value;
            this._actualizarPreview();
        },
        
        _cambiarOrientacion() {
            this.config.orientation = document.getElementById('compOrientation').value;
            this._actualizarPreview();
        },
        
        _zoom(delta) {
            if(delta === 'fit') {
                this.config.zoom = 0.5;
            } else {
                this.config.zoom = Math.max(0.2, Math.min(1.5, this.config.zoom + delta));
            }
            this._actualizarPreview();
        },
        
        exportarPDF() {
            Toast.show('Generando PDF...', 'success');
            const { jsPDF } = window.jspdf;
            const page = document.getElementById('composerPage');
            
            const orientation = this.config.orientation === 'landscape' ? 'l' : 'p';
            const doc = new jsPDF({ orientation, unit: 'mm', format: this.config.pageSize });
            
            doc.setFontSize(16);
            doc.text(document.getElementById('compProjNombre')?.value || 'PLANO DE SUBDIVISIN', 20, 20);
            
            doc.setFontSize(10);
            doc.text(`Lotes: ${State.blocks.length}`, 20, 30);
            doc.text(`rea Total: ${(State.blocks.reduce((s, b) => s + (b.area || 0), 0) / 10000).toFixed(2)} Ha`, 20, 36);
            doc.text(`Fecha: ${new Date().toLocaleDateString()}`, 20, 42);
            
            doc.setFontSize(8);
            doc.text('Generado con WIN-TEL Geomatics PRO + ComposerPro', 20, doc.internal.pageSize.height - 10);
            
            doc.save('composicion_profesional.pdf');
            Toast.show('PDF exportado correctamente', 'success');
        },
        
        exportarPNG() {
            Toast.show('Funcin PNG en desarrollo - Use captura de pantalla', 'warning');
        }
    };

    // ========================================
    // LINE ELEVATION PROFILE MODULE
    // Perfil de Elevacin para Lneas/Rutas
    // Similar a Google Earth Pro
    // ========================================
    const LineElevationProfile = {
        isDrawing: false,
        currentLine: [],
        lineLayer: null,
        markerLayer: null,
        elevationData: [],
        mapPositionMarker: null,
        chartConfig: null,
        tempLine: null,
        keyHandler: null,
        currentHoverPoint: null,
        isHoveringChart: false,
        vertexKeyHandler: null,
        
        // Inicializar el mdulo (llamar despus de que el mapa est listo)
        init() {
            if(!State.map) {
                console.warn('LineElevationProfile: State.map no disponible');
                return;
            }
            
            // Crear capas en el mapa
            this.lineLayer = L.layerGroup().addTo(State.map);
            this.markerLayer = L.layerGroup().addTo(State.map);
            
            // Configurar eventos del canvas
            const container = document.getElementById('lpChartContainer');
            if(container) {
                container.addEventListener('mousemove', (e) => this._onChartMouseMove(e));
                container.addEventListener('mouseleave', () => this._onChartMouseLeave());
                container.addEventListener('mouseenter', () => { this.isHoveringChart = true; });
            }
            
            // Evento global de teclado para marcar vrtices con ESPACIO
            this.vertexKeyHandler = (e) => {
                // ESPACIO para marcar vrtice cuando est sobre el grfico
                if(e.code === 'Space' && this.isHoveringChart && this.currentHoverPoint) {
                    e.preventDefault(); // Evitar scroll
                    this.marcarVertice();
                }
                // Tambin con la tecla 'V'
                if(e.code === 'KeyV' && this.isHoveringChart && this.currentHoverPoint) {
                    e.preventDefault();
                    this.marcarVertice();
                }
                // Tecla 'C' para limpiar vrtices
                if(e.code === 'KeyC' && e.ctrlKey && this.isHoveringChart) {
                    e.preventDefault();
                    this.limpiarVertices();
                }
            };
            document.addEventListener('keydown', this.vertexKeyHandler);
            
            console.log(' LineElevationProfile inicializado correctamente');
            Toast.show('Perfil de Elevacin disponible (botn prpura)', 'success');
        },
        
        // Toggle modo dibujo
        toggleDrawMode() {
            // Inicializar capas si no existen
            if(!this.lineLayer && State.map) {
                this.lineLayer = L.layerGroup().addTo(State.map);
                this.markerLayer = L.layerGroup().addTo(State.map);
            }
            
            if(this.isDrawing) {
                this.cancelDrawing();
            } else {
                this.startDrawing();
            }
        },
        
        // Iniciar modo dibujo
        startDrawing() {
            if(!State.map) {
                Toast.show('Mapa no disponible', 'error');
                return;
            }
            
            this.isDrawing = true;
            this.currentLine = [];
            this.elevationData = [];
            
            // Limpiar capas
            if(this.lineLayer) this.lineLayer.clearLayers();
            if(this.markerLayer) this.markerLayer.clearLayers();
            
            // Actualizar UI - Indicador de modo
            const indicator = document.getElementById('lineDrawIndicator');
            if(indicator) indicator.classList.add('active');
            
            // Cambiar cursor del mapa
            State.map.getContainer().style.cursor = 'crosshair';
            
            // Eventos del mapa
            State.map.on('click', this._handleMapClick, this);
            State.map.on('mousemove', this._handleMapMouseMove, this);
            
            // Evento de teclado
            this.keyHandler = (e) => {
                if(e.key === 'Escape') this.cancelDrawing();
                if(e.key === 'Enter' && this.currentLine.length >= 2) this.finishDrawing();
            };
            document.addEventListener('keydown', this.keyHandler);
            
            Toast.show(' Click en el mapa para trazar la lnea. Enter o doble-click para finalizar.', 'success');
        },
        
        // Click en el mapa
        _handleMapClick(e) {
            if(!this.isDrawing) return;
            
            // Verificar doble-click para finalizar
            if(this._lastClickTime && Date.now() - this._lastClickTime < 300) {
                if(this.currentLine.length >= 2) {
                    this.finishDrawing();
                    return;
                }
            }
            this._lastClickTime = Date.now();
            
            const point = { lat: e.latlng.lat, lng: e.latlng.lng };
            this.currentLine.push(point);
            
            // Marcador del vrtice
            L.circleMarker([point.lat, point.lng], {
                radius: 8,
                fillColor: '#8b5cf6',
                color: '#ffffff',
                weight: 3,
                fillOpacity: 1
            }).bindTooltip(`Punto ${this.currentLine.length}`, {permanent: false}).addTo(this.markerLayer);
            
            // Actualizar lnea
            this._updateLineDisplay();
            
            // Mostrar distancia
            if(this.currentLine.length > 1) {
                const dist = this._calcularDistanciaTotal();
                Toast.show(`Distancia: ${this._formatDistance(dist)}`, 'success');
            }
        },
        
        // Mouse move para lnea temporal
        _handleMapMouseMove(e) {
            if(!this.isDrawing || this.currentLine.length === 0) return;
            
            // Remover lnea temporal anterior
            if(this.tempLine) {
                this.lineLayer.removeLayer(this.tempLine);
            }
            
            // Dibujar lnea temporal al cursor
            const lastPoint = this.currentLine[this.currentLine.length - 1];
            this.tempLine = L.polyline([
                [lastPoint.lat, lastPoint.lng],
                [e.latlng.lat, e.latlng.lng]
            ], {
                color: '#8b5cf6',
                weight: 3,
                dashArray: '10, 10',
                opacity: 0.6
            }).addTo(this.lineLayer);
        },
        
        // Actualizar visualizacin de la lnea
        _updateLineDisplay() {
            // Remover lneas anteriores excepto la temporal
            this.lineLayer.eachLayer(l => {
                if(l !== this.tempLine) this.lineLayer.removeLayer(l);
            });
            
            if(this.currentLine.length < 2) return;
            
            const coords = this.currentLine.map(p => [p.lat, p.lng]);
            L.polyline(coords, {
                color: '#8b5cf6',
                weight: 5,
                opacity: 0.9
            }).addTo(this.lineLayer);
        },
        
        // Cancelar dibujo
        cancelDrawing() {
            this.isDrawing = false;
            this.currentLine = [];
            
            // Limpiar capas
            if(this.lineLayer) this.lineLayer.clearLayers();
            if(this.markerLayer) this.markerLayer.clearLayers();
            
            // Restaurar UI
            const indicator = document.getElementById('lineDrawIndicator');
            if(indicator) indicator.classList.remove('active');
            
            // Restaurar cursor
            if(State.map) State.map.getContainer().style.cursor = '';
            
            // Remover eventos
            if(State.map) {
                State.map.off('click', this._handleMapClick, this);
                State.map.off('mousemove', this._handleMapMouseMove, this);
            }
            if(this.keyHandler) document.removeEventListener('keydown', this.keyHandler);
            
            Toast.show('Modo perfil cancelado', 'warning');
        },
        
        // Finalizar dibujo
        async finishDrawing() {
            if(this.currentLine.length < 2) {
                Toast.show('Necesita al menos 2 puntos', 'error');
                return;
            }
            
            this.isDrawing = false;
            
            // Restaurar UI
            const indicator = document.getElementById('lineDrawIndicator');
            if(indicator) indicator.classList.remove('active');
            
            // Restaurar cursor
            if(State.map) State.map.getContainer().style.cursor = '';
            
            // Remover eventos
            if(State.map) {
                State.map.off('click', this._handleMapClick, this);
                State.map.off('mousemove', this._handleMapMouseMove, this);
            }
            if(this.keyHandler) document.removeEventListener('keydown', this.keyHandler);
            
            // Remover lnea temporal
            if(this.tempLine) {
                this.lineLayer.removeLayer(this.tempLine);
                this.tempLine = null;
            }
            
            // Actualizar lnea final
            this._updateLineDisplay();
            
            Toast.show(' Obteniendo datos de elevacin...', 'success');
            
            // Obtener elevaciones
            await this._fetchElevationData();
            
            // Mostrar panel
            this._mostrarPanel();
        },
        
        // Obtener datos de elevacin (mtodo batch ms eficiente)
        async _fetchElevationData() {
            const numPoints = 80; // Menos puntos para mejor rendimiento
            const points = this._interpolarPuntos(numPoints);
            this.elevationData = [];
            
            // Calcular distancias acumuladas
            let cumulativeDist = 0;
            const pointsWithDist = points.map((p, i) => {
                if(i > 0) {
                    cumulativeDist += this._haversineDistance(
                        points[i-1].lat, points[i-1].lng, p.lat, p.lng
                    );
                }
                return { ...p, distance: cumulativeDist };
            });
            
            // Intentar API batch de Open-Elevation
            try {
                const locations = points.map(p => ({ latitude: p.lat, longitude: p.lng }));
                const response = await fetch('https://api.open-elevation.com/api/v1/lookup', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ locations })
                });
                
                if(response.ok) {
                    const data = await response.json();
                    if(data.results) {
                        this.elevationData = data.results.map((r, i) => ({
                            lat: pointsWithDist[i].lat,
                            lng: pointsWithDist[i].lng,
                            elevation: r.elevation,
                            distance: pointsWithDist[i].distance
                        }));
                        console.log(' Elevaciones obtenidas de Open-Elevation API');
                        return;
                    }
                }
            } catch(err) {
                console.warn('Open-Elevation API fall, usando simulacin:', err);
            }
            
            // Fallback: Simular elevaciones realistas
            console.log(' Usando elevaciones simuladas');
            const baseElev = 100 + Math.random() * 200;
            let prevElev = baseElev;
            
            this.elevationData = pointsWithDist.map((p, i) => {
                // Variacin suave tipo terreno real
                const variation = (Math.random() - 0.5) * 15;
                const trend = Math.sin(i / numPoints * Math.PI * 2) * 25;
                let elev = prevElev + variation + (trend * 0.1);
                elev = Math.max(50, Math.min(500, elev)); // Limitar rango
                prevElev = elev;
                
                return {
                    lat: p.lat,
                    lng: p.lng,
                    elevation: elev,
                    distance: p.distance
                };
            });
        },
        
        // Interpolar puntos a lo largo de la lnea
        _interpolarPuntos(numPoints) {
            if(this.currentLine.length < 2) return this.currentLine;
            
            const totalDist = this._calcularDistanciaTotal();
            const step = totalDist / (numPoints - 1);
            const result = [];
            
            for(let i = 0; i < numPoints; i++) {
                const targetDist = i * step;
                const point = this._getPointAtDistance(targetDist);
                if(point) result.push(point);
            }
            
            return result;
        },
        
        // Obtener punto a cierta distancia
        _getPointAtDistance(targetDist) {
            let accumulated = 0;
            
            for(let i = 0; i < this.currentLine.length - 1; i++) {
                const p1 = this.currentLine[i];
                const p2 = this.currentLine[i + 1];
                const segDist = this._haversineDistance(p1.lat, p1.lng, p2.lat, p2.lng);
                
                if(accumulated + segDist >= targetDist) {
                    const t = segDist > 0 ? (targetDist - accumulated) / segDist : 0;
                    return {
                        lat: p1.lat + (p2.lat - p1.lat) * t,
                        lng: p1.lng + (p2.lng - p1.lng) * t
                    };
                }
                accumulated += segDist;
            }
            
            return this.currentLine[this.currentLine.length - 1];
        },
        
        // Distancia total
        _calcularDistanciaTotal() {
            let total = 0;
            for(let i = 1; i < this.currentLine.length; i++) {
                total += this._haversineDistance(
                    this.currentLine[i-1].lat, this.currentLine[i-1].lng,
                    this.currentLine[i].lat, this.currentLine[i].lng
                );
            }
            return total;
        },
        
        // Haversine
        _haversineDistance(lat1, lng1, lat2, lng2) {
            const R = 6371000;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const a = Math.sin(dLat/2)**2 + Math.cos(lat1 * Math.PI/180) * Math.cos(lat2 * Math.PI/180) * Math.sin(dLng/2)**2;
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        },
        
        // Formatear distancia
        _formatDistance(meters) {
            return meters >= 1000 ? `${(meters/1000).toFixed(2)} km` : `${meters.toFixed(0)} m`;
        },
        
        // Mostrar panel
        _mostrarPanel() {
            const panel = document.getElementById('lineProfilePanel');
            const keyHint = document.getElementById('lpKeyHint');
            if(panel) {
                panel.classList.add('active');
                this._calcularEstadisticas();
                setTimeout(() => this._dibujarGrafico(), 150);
            }
            // Mostrar indicador de atajos
            if(keyHint) keyHint.style.display = 'block';
        },
        
        // Cerrar panel
        cerrarPanel() {
            const panel = document.getElementById('lineProfilePanel');
            const keyHint = document.getElementById('lpKeyHint');
            if(panel) panel.classList.remove('active');
            if(keyHint) keyHint.style.display = 'none';
        },
        
        // Nueva lnea
        nuevaLinea() {
            this.cerrarPanel();
            // Limpiar vrtices tambin
            this.limpiarVertices();
            if(this.lineLayer) this.lineLayer.clearLayers();
            if(this.markerLayer) this.markerLayer.clearLayers();
            this.elevationData = [];
            this.currentLine = [];
            setTimeout(() => this.startDrawing(), 200);
        },
        
        // Calcular estadsticas
        _calcularEstadisticas() {
            if(this.elevationData.length === 0) return;
            
            const elevations = this.elevationData.map(d => d.elevation);
            const minElev = Math.min(...elevations);
            const maxElev = Math.max(...elevations);
            const avgElev = elevations.reduce((a, b) => a + b, 0) / elevations.length;
            const totalDist = this.elevationData[this.elevationData.length - 1].distance;
            
            let gain = 0, loss = 0;
            const grades = [];
            
            for(let i = 1; i < this.elevationData.length; i++) {
                const elevDiff = this.elevationData[i].elevation - this.elevationData[i-1].elevation;
                const distDiff = this.elevationData[i].distance - this.elevationData[i-1].distance;
                
                if(elevDiff > 0) gain += elevDiff;
                else loss += Math.abs(elevDiff);
                
                if(distDiff > 0) grades.push((elevDiff / distDiff) * 100);
            }
            
            const maxGrade = grades.length > 0 ? Math.max(...grades.map(Math.abs)) : 0;
            const avgGrade = grades.length > 0 ? grades.reduce((a, b) => a + b, 0) / grades.length : 0;
            
            // Actualizar UI
            const setVal = (id, val) => { const el = document.getElementById(id); if(el) el.textContent = val; };
            
            setVal('lpStatMin', `${minElev.toFixed(0)} m`);
            setVal('lpStatAvg', `${avgElev.toFixed(0)} m`);
            setVal('lpStatMax', `${maxElev.toFixed(0)} m`);
            setVal('lpStatDist', this._formatDistance(totalDist));
            setVal('lpInfoDist', this._formatDistance(totalDist));
            setVal('lpInfoPoints', this.elevationData.length);
            setVal('lpInfoGain', `+${gain.toFixed(1)} m`);
            setVal('lpInfoLoss', `-${loss.toFixed(1)} m`);
            setVal('lpInfoMaxGrade', `${maxGrade.toFixed(1)}%`);
            setVal('lpInfoAvgGrade', `${avgGrade.toFixed(1)}%`);
        },
        
        // Dibujar grfico
        _dibujarGrafico() {
            const canvas = document.getElementById('lpChart');
            const container = document.getElementById('lpChartContainer');
            if(!canvas || !container || this.elevationData.length === 0) return;
            
            const rect = container.getBoundingClientRect();
            canvas.width = rect.width;
            canvas.height = rect.height;
            
            const ctx = canvas.getContext('2d');
            const w = canvas.width, h = canvas.height;
            const pad = { top: 25, right: 15, bottom: 35, left: 55 };
            const chartW = w - pad.left - pad.right;
            const chartH = h - pad.top - pad.bottom;
            
            const elevs = this.elevationData.map(d => d.elevation);
            const dists = this.elevationData.map(d => d.distance);
            const minE = Math.min(...elevs) - 10;
            const maxE = Math.max(...elevs) + 10;
            const maxD = Math.max(...dists);
            
            // Limpiar
            ctx.clearRect(0, 0, w, h);
            
            // Fondo
            ctx.fillStyle = 'rgba(15, 23, 42, 0.5)';
            ctx.fillRect(0, 0, w, h);
            
            // Grilla horizontal
            ctx.strokeStyle = 'rgba(148, 163, 184, 0.15)';
            ctx.lineWidth = 1;
            for(let i = 0; i <= 5; i++) {
                const y = pad.top + (i / 5) * chartH;
                ctx.beginPath();
                ctx.moveTo(pad.left, y);
                ctx.lineTo(w - pad.right, y);
                ctx.stroke();
                
                const elev = maxE - (i / 5) * (maxE - minE);
                ctx.fillStyle = '#94a3b8';
                ctx.font = '10px monospace';
                ctx.textAlign = 'right';
                ctx.fillText(`${elev.toFixed(0)}m`, pad.left - 5, y + 4);
            }
            
            // Grilla vertical
            for(let i = 0; i <= 5; i++) {
                const x = pad.left + (i / 5) * chartW;
                ctx.beginPath();
                ctx.moveTo(x, pad.top);
                ctx.lineTo(x, h - pad.bottom);
                ctx.stroke();
                
                const dist = (i / 5) * maxD;
                ctx.textAlign = 'center';
                ctx.fillText(this._formatDistance(dist), x, h - pad.bottom + 15);
            }
            
            // rea del perfil
            const gradient = ctx.createLinearGradient(0, pad.top, 0, h - pad.bottom);
            gradient.addColorStop(0, 'rgba(139, 92, 246, 0.7)');
            gradient.addColorStop(0.5, 'rgba(139, 92, 246, 0.3)');
            gradient.addColorStop(1, 'rgba(139, 92, 246, 0.05)');
            
            ctx.beginPath();
            ctx.moveTo(pad.left, h - pad.bottom);
            
            this.elevationData.forEach(d => {
                const x = pad.left + (d.distance / maxD) * chartW;
                const y = pad.top + ((maxE - d.elevation) / (maxE - minE)) * chartH;
                ctx.lineTo(x, y);
            });
            
            ctx.lineTo(pad.left + chartW, h - pad.bottom);
            ctx.closePath();
            ctx.fillStyle = gradient;
            ctx.fill();
            
            // Lnea del perfil
            ctx.beginPath();
            ctx.strokeStyle = '#8b5cf6';
            ctx.lineWidth = 2.5;
            ctx.lineJoin = 'round';
            
            this.elevationData.forEach((d, i) => {
                const x = pad.left + (d.distance / maxD) * chartW;
                const y = pad.top + ((maxE - d.elevation) / (maxE - minE)) * chartH;
                if(i === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            });
            ctx.stroke();
            
            // Guardar config para interaccin
            this.chartConfig = { pad, chartW, chartH, minE, maxE, maxD };
        },
        
        // Mouse move en grfico
        _onChartMouseMove(e) {
            if(!this.elevationData.length || !this.chartConfig) return;
            
            const container = document.getElementById('lpChartContainer');
            const rect = container.getBoundingClientRect();
            const x = e.clientX - rect.left;
            
            const { pad, chartW, maxD, chartH, minE, maxE } = this.chartConfig;
            
            if(x < pad.left || x > pad.left + chartW) {
                this._onChartMouseLeave();
                return;
            }
            
            const distRatio = (x - pad.left) / chartW;
            const targetDist = distRatio * maxD;
            
            // Encontrar punto ms cercano
            let closest = this.elevationData[0], closestIdx = 0;
            this.elevationData.forEach((d, i) => {
                if(Math.abs(d.distance - targetDist) < Math.abs(closest.distance - targetDist)) {
                    closest = d;
                    closestIdx = i;
                }
            });
            
            // Guardar punto actual para marcar vrtice
            this.currentHoverPoint = { ...closest, index: closestIdx };
            
            // Pendiente
            let grade = 0;
            if(closestIdx > 0) {
                const prev = this.elevationData[closestIdx - 1];
                const dE = closest.elevation - prev.elevation;
                const dD = closest.distance - prev.distance;
                if(dD > 0) grade = (dE / dD) * 100;
            }
            
            const pointY = pad.top + ((maxE - closest.elevation) / (maxE - minE)) * chartH;
            
            // Cursor
            const cursor = document.getElementById('lpCursor');
            const dot = document.getElementById('lpCursorDot');
            if(cursor && dot) {
                cursor.classList.add('active');
                cursor.style.left = `${x}px`;
                dot.style.top = `${pointY}px`;
            }
            
            // Tooltip con coordenadas
            const tooltip = document.getElementById('lpTooltip');
            if(tooltip) {
                tooltip.classList.add('active');
                // Posicionar tooltip - ms espacio para el contenido expandido
                const tooltipWidth = 220;
                tooltip.style.left = `${x + (x > rect.width - tooltipWidth - 20 ? -tooltipWidth - 10 : 15)}px`;
                tooltip.style.top = `${Math.max(10, pointY - 80)}px`;
                
                // Actualizar contenido
                document.getElementById('lpTooltipElev').textContent = `${closest.elevation.toFixed(1)} m`;
                document.getElementById('lpTooltipDist').textContent = `Dist: ${this._formatDistance(closest.distance)}`;
                document.getElementById('lpTooltipGrade').textContent = `Pend: ${grade.toFixed(1)}%`;
                
                // Coordenadas
                document.getElementById('lpTooltipLat').textContent = `Lat: ${closest.lat.toFixed(6)}`;
                document.getElementById('lpTooltipLng').textContent = `Lng: ${closest.lng.toFixed(6)}`;
            }
            
            // Marcador en mapa con ms info
            this._mostrarMarcadorMapa(closest.lat, closest.lng, closest.elevation);
        },
        
        _onChartMouseLeave() {
            this.isHoveringChart = false;
            const cursor = document.getElementById('lpCursor');
            const tooltip = document.getElementById('lpTooltip');
            if(cursor) cursor.classList.remove('active');
            if(tooltip) tooltip.classList.remove('active');
            this._ocultarMarcadorMapa();
        },
        
        _mostrarMarcadorMapa(lat, lng, elev) {
            if(!this.markerLayer) return;
            
            if(this.mapPositionMarker) {
                this.mapPositionMarker.setLatLng([lat, lng]);
                // Actualizar contenido del popup
                if(this.mapPositionMarker._icon) {
                    this.mapPositionMarker._icon.innerHTML = `<div style="background:#8b5cf6;color:white;padding:6px 10px;border-radius:6px;font-size:11px;font-weight:bold;white-space:nowrap;border:2px solid white;box-shadow:0 2px 8px rgba(0,0,0,0.3);text-align:center;">
                        <div style="font-size:14px;">${elev.toFixed(1)} m</div>
                        <div style="font-size:9px;opacity:0.8;margin-top:2px;">${lat.toFixed(5)}, ${lng.toFixed(5)}</div>
                    </div>`;
                }
            } else {
                this.mapPositionMarker = L.marker([lat, lng], {
                    icon: L.divIcon({
                        className: '',
                        html: `<div style="background:#8b5cf6;color:white;padding:6px 10px;border-radius:6px;font-size:11px;font-weight:bold;white-space:nowrap;border:2px solid white;box-shadow:0 2px 8px rgba(0,0,0,0.3);text-align:center;">
                            <div style="font-size:14px;">${elev.toFixed(1)} m</div>
                            <div style="font-size:9px;opacity:0.8;margin-top:2px;">${lat.toFixed(5)}, ${lng.toFixed(5)}</div>
                        </div>`,
                        iconAnchor: [50, 50]
                    })
                }).addTo(this.markerLayer);
            }
        },
        
        _ocultarMarcadorMapa() {
            if(this.mapPositionMarker && this.markerLayer) {
                this.markerLayer.removeLayer(this.mapPositionMarker);
                this.mapPositionMarker = null;
            }
        },
        
        // ========== FUNCIONES DE VRTICES MARCADOS ==========
        marckedVertices: [],
        vertexMarkers: [],
        
        // Marcar vrtice en el punto actual del hover
        marcarVertice() {
            if(!this.currentHoverPoint) {
                Toast.show('Posicione el cursor sobre el grfico primero', 'error');
                return;
            }
            
            const point = this.currentHoverPoint;
            const vertexNum = this.marckedVertices.length + 1;
            
            // Agregar a la lista
            this.marckedVertices.push({
                id: vertexNum,
                lat: point.lat,
                lng: point.lng,
                elevation: point.elevation,
                distance: point.distance
            });
            
            // Agregar marcador en el mapa
            const marker = L.marker([point.lat, point.lng], {
                icon: L.divIcon({
                    className: '',
                    html: `<div style="background:#ef4444;color:white;width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:bold;font-size:12px;border:3px solid white;box-shadow:0 2px 8px rgba(0,0,0,0.4);">${vertexNum}</div>`,
                    iconSize: [28, 28],
                    iconAnchor: [14, 14]
                })
            }).addTo(this.markerLayer);
            
            marker.bindPopup(`
                <div style="text-align:center;min-width:150px;">
                    <b style="color:#ef4444;"> Vrtice ${vertexNum}</b><br>
                    <hr style="margin:5px 0;border-color:#ddd;">
                    <b>Elevacin:</b> ${point.elevation.toFixed(1)} m<br>
                    <b>Distancia:</b> ${this._formatDistance(point.distance)}<br>
                    <hr style="margin:5px 0;border-color:#ddd;">
                    <span style="font-family:monospace;font-size:11px;">
                        Lat: ${point.lat.toFixed(6)}<br>
                        Lng: ${point.lng.toFixed(6)}
                    </span>
                </div>
            `);
            
            this.vertexMarkers.push(marker);
            
            // Dibujar punto en el grfico
            this._dibujarVerticesEnGrafico();
            
            // Actualizar panel lateral
            this._actualizarListaVertices();
            
            Toast.show(` Vrtice ${vertexNum} marcado: ${point.elevation.toFixed(1)}m`, 'success');
        },
        
        // Dibujar vrtices marcados en el grfico
        _dibujarVerticesEnGrafico() {
            if(!this.chartConfig || !this.marckedVertices.length) return;
            
            const canvas = document.getElementById('lpChart');
            if(!canvas) return;
            
            // Primero redibujar el grfico base
            this._dibujarGrafico();
            
            // Luego agregar los vrtices
            const ctx = canvas.getContext('2d');
            const { pad, chartW, chartH, minE, maxE, maxD } = this.chartConfig;
            
            this.marckedVertices.forEach((v, idx) => {
                const x = pad.left + (v.distance / maxD) * chartW;
                const y = pad.top + ((maxE - v.elevation) / (maxE - minE)) * chartH;
                
                // Crculo rojo
                ctx.beginPath();
                ctx.arc(x, y, 8, 0, Math.PI * 2);
                ctx.fillStyle = '#ef4444';
                ctx.fill();
                ctx.strokeStyle = 'white';
                ctx.lineWidth = 2;
                ctx.stroke();
                
                // Nmero del vrtice
                ctx.fillStyle = 'white';
                ctx.font = 'bold 10px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(v.id.toString(), x, y);
                
                // Lnea vertical punteada
                ctx.beginPath();
                ctx.strokeStyle = 'rgba(239, 68, 68, 0.5)';
                ctx.lineWidth = 1;
                ctx.setLineDash([4, 4]);
                ctx.moveTo(x, y);
                ctx.lineTo(x, pad.top + chartH);
                ctx.stroke();
                ctx.setLineDash([]);
                
                // Etiqueta de elevacin arriba
                ctx.fillStyle = '#ef4444';
                ctx.font = 'bold 9px Arial';
                ctx.fillText(`${v.elevation.toFixed(0)}m`, x, y - 15);
            });
        },
        
        // Actualizar lista de vrtices en el panel
        _actualizarListaVertices() {
            const card = document.getElementById('lpVerticesCard');
            const list = document.getElementById('lpVerticesList');
            
            if(!card || !list) return;
            
            if(this.marckedVertices.length === 0) {
                card.style.display = 'none';
                return;
            }
            
            card.style.display = 'block';
            
            let html = '';
            this.marckedVertices.forEach(v => {
                html += `<div style="display:flex;justify-content:space-between;padding:3px 0;border-bottom:1px solid rgba(255,255,255,0.1);">
                    <span style="color:#ef4444;font-weight:bold;">V${v.id}</span>
                    <span style="color:#10b981;">${v.elevation.toFixed(0)}m</span>
                    <span style="color:#94a3b8;font-size:9px;">${v.lat.toFixed(4)}</span>
                </div>`;
            });
            
            list.innerHTML = html;
        },
        
        // Exportar vrtices marcados
        exportarVertices() {
            if(this.marckedVertices.length === 0) {
                Toast.show('No hay vrtices marcados', 'error');
                return;
            }
            
            let csv = 'Vertice,Latitud,Longitud,Elevacion_m,Distancia_m\n';
            this.marckedVertices.forEach(v => {
                csv += `V${v.id},${v.lat.toFixed(8)},${v.lng.toFixed(8)},${v.elevation.toFixed(1)},${v.distance.toFixed(1)}\n`;
            });
            
            download(csv, `vertices_elevacion_${Date.now()}.csv`, 'text/csv');
            Toast.show(`${this.marckedVertices.length} vrtices exportados`, 'success');
        },
        
        // Limpiar todos los vrtices
        limpiarVertices() {
            // Remover marcadores del mapa
            this.vertexMarkers.forEach(m => {
                if(this.markerLayer) this.markerLayer.removeLayer(m);
            });
            
            this.marckedVertices = [];
            this.vertexMarkers = [];
            
            // Redibujar grfico sin vrtices
            this._dibujarGrafico();
            
            // Ocultar panel
            const card = document.getElementById('lpVerticesCard');
            if(card) card.style.display = 'none';
            
            Toast.show('Vrtices eliminados', 'success');
        },
        
        // Exportar CSV
        exportCSV() {
            if(this.elevationData.length === 0) {
                Toast.show('No hay datos', 'error');
                return;
            }
            
            let csv = 'Punto,Latitud,Longitud,Elevacion_m,Distancia_m\n';
            this.elevationData.forEach((d, i) => {
                csv += `${i+1},${d.lat.toFixed(8)},${d.lng.toFixed(8)},${d.elevation.toFixed(1)},${d.distance.toFixed(1)}\n`;
            });
            
            download(csv, `perfil_elevacion_${Date.now()}.csv`, 'text/csv');
            Toast.show('CSV exportado', 'success');
        },
        
        // Exportar PNG
        exportPNG() {
            const canvas = document.getElementById('lpChart');
            if(!canvas) {
                Toast.show('No hay grfico', 'error');
                return;
            }
            
            const link = document.createElement('a');
            link.download = `perfil_elevacion_${Date.now()}.png`;
            link.href = canvas.toDataURL('image/png');
            link.click();
            Toast.show('PNG exportado', 'success');
        }
    };

    // Inicializar despus del mapa
    const initLineProfile = setInterval(() => {
        if(State && State.map) {
            clearInterval(initLineProfile);
            setTimeout(() => LineElevationProfile.init(), 500);
        }
    }, 500);

    // Inicializar chatbot flotante despus del splash
    setTimeout(() => ChatbotFloat.init(), 2500);

    // ========== V30 EXTENSIONES - SIN TOCAR NADA EXISTENTE ==========
    
    // EXTENSIN 1: ImportMgr mejorado - aadir GeoJSON, CSV, GPX al existente
    ImportMgr.handleGeoJSON = function(input) {
        const file = input.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const geojson = JSON.parse(e.target.result);
                let poly = null;
                if (geojson.type === 'FeatureCollection') {
                    poly = geojson.features.find(f => f.geometry && f.geometry.type === 'Polygon');
                } else if (geojson.type === 'Feature' && geojson.geometry.type === 'Polygon') {
                    poly = geojson;
                } else if (geojson.type === 'Polygon') {
                    poly = { type: 'Feature', geometry: geojson, properties: {} };
                }
                if (poly) {
                    this.setPolygon(poly);
                    Toast.show('GeoJSON importado correctamente', 'success');
                } else {
                    Toast.show('No se encontr polgono en el GeoJSON', 'error');
                }
            } catch (err) {
                Toast.show('Error al leer GeoJSON: ' + err.message, 'error');
            }
        };
        reader.readAsText(file);
        input.value = '';
    };
    
    ImportMgr.handleGPX = function(input) {
        const file = input.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const parser = new DOMParser();
                const xml = parser.parseFromString(e.target.result, 'text/xml');
                const geojson = toGeoJSON.gpx(xml);
                const poly = geojson.features.find(f => f.geometry && 
                    (f.geometry.type === 'Polygon' || f.geometry.type === 'LineString'));
                if (poly) {
                    if (poly.geometry.type === 'LineString') {
                        // Convertir lnea a polgono cerrndola
                        const coords = poly.geometry.coordinates;
                        if (coords[0][0] !== coords[coords.length-1][0] || coords[0][1] !== coords[coords.length-1][1]) {
                            coords.push([...coords[0]]);
                        }
                        poly.geometry = { type: 'Polygon', coordinates: [coords] };
                    }
                    this.setPolygon(poly);
                    Toast.show('GPX importado correctamente', 'success');
                } else {
                    Toast.show('No se encontr polgono/track en el GPX', 'error');
                }
            } catch (err) {
                Toast.show('Error al leer GPX: ' + err.message, 'error');
            }
        };
        reader.readAsText(file);
        input.value = '';
    };
    
    ImportMgr.handleCSV = function(input) {
        const file = input.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const lines = e.target.result.split('\n').filter(l => l.trim());
                if (lines.length < 4) { Toast.show('CSV necesita al menos 3 puntos', 'error'); return; }
                
                const sep = lines[0].includes(';') ? ';' : ',';
                const headers = lines[0].split(sep).map(h => h.trim().toLowerCase());
                
                // Auto-detectar columnas
                let latCol = -1, lngCol = -1, eCol = -1, nCol = -1;
                headers.forEach((h, i) => {
                    if (h.includes('lat') || h === 'y') latCol = i;
                    if (h.includes('lon') || h.includes('lng') || h === 'x') lngCol = i;
                    if (h.includes('este') || h.includes('east') || h === 'e') eCol = i;
                    if (h.includes('norte') || h.includes('north') || h === 'n') nCol = i;
                });
                
                let coords = [];
                const isUTM = eCol >= 0 && nCol >= 0 && latCol < 0;
                
                lines.slice(1).forEach(line => {
                    const vals = line.split(sep).map(v => parseFloat(v.trim()));
                    if (isUTM) {
                        const e = vals[eCol], n = vals[nCol];
                        if (!isNaN(e) && !isNaN(n)) {
                            // Detectar zona UTM automticamente del primer punto
                            const zone = ImportMgr._detectUTMZone || '19N';
                            const ll = UTM.toLatLon(e, n, zone);
                            if (ll) coords.push(ll);
                        }
                    } else if (latCol >= 0 && lngCol >= 0) {
                        const lat = vals[latCol], lng = vals[lngCol];
                        if (!isNaN(lat) && !isNaN(lng)) coords.push([lng, lat]);
                    }
                });
                
                if (coords.length < 3) { Toast.show('No se detectaron coordenadas vlidas', 'error'); return; }
                if (coords[0][0] !== coords[coords.length-1][0] || coords[0][1] !== coords[coords.length-1][1]) {
                    coords.push([...coords[0]]);
                }
                
                this.setPolygon(turf.polygon([coords]));
                Toast.show(`CSV importado: ${coords.length - 1} vrtices`, 'success');
            } catch (err) {
                Toast.show('Error al leer CSV: ' + err.message, 'error');
            }
        };
        reader.readAsText(file);
        input.value = '';
    };
    
    ImportMgr.handleDXF = function(input) {
        const file = input.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const dxf = e.target.result;
                const coords = this._parseDXF(dxf);
                if (coords.length < 3) { Toast.show('No se encontr polgono en DXF', 'error'); return; }
                if (coords[0][0] !== coords[coords.length-1][0] || coords[0][1] !== coords[coords.length-1][1]) {
                    coords.push([...coords[0]]);
                }
                this.setPolygon(turf.polygon([coords]));
                Toast.show(`DXF importado: ${coords.length - 1} vrtices`, 'success');
            } catch (err) {
                Toast.show('Error al leer DXF: ' + err.message, 'error');
            }
        };
        reader.readAsText(file);
        input.value = '';
    };
    
    ImportMgr._parseDXF = function(dxf) {
        const coords = [];
        const lines = dxf.split('\n');
        let inEntity = false, currentX = null, currentY = null;
        
        for (let i = 0; i < lines.length; i++) {
            const line = lines[i].trim();
            if (line === 'LWPOLYLINE' || line === 'POLYLINE' || line === 'LINE') {
                inEntity = true; continue;
            }
            if (inEntity) {
                if (line === '10') { currentX = parseFloat(lines[++i]?.trim()); }
                else if (line === '20') {
                    currentY = parseFloat(lines[++i]?.trim());
                    if (currentX !== null && currentY !== null && !isNaN(currentX) && !isNaN(currentY)) {
                        // Si parecen UTM, convertir
                        if (Math.abs(currentX) > 180 || Math.abs(currentY) > 90) {
                            const zone = this._detectUTMZone || '19N';
                            const ll = UTM.toLatLon(currentX, currentY, zone);
                            if (ll) coords.push(ll);
                        } else {
                            coords.push([currentX, currentY]);
                        }
                        currentX = currentY = null;
                    }
                }
                else if (line === 'SEQEND' || line === '0') {
                    if (coords.length > 0) inEntity = false;
                }
            }
        }
        return coords;
    };
    
    // EXTENSIN 2: ProjectMgr mejorado - aadir IndexedDB
    ProjectMgr.DB_NAME = 'WinTelGeomaticsDB';
    ProjectMgr.STORE_NAME = 'projects';
    ProjectMgr._db = null;
    
    ProjectMgr._initDB = async function() {
        if (this._db) return this._db;
        return new Promise((resolve, reject) => {
            const request = indexedDB.open(this.DB_NAME, 1);
            request.onerror = () => reject(request.error);
            request.onsuccess = () => { this._db = request.result; resolve(this._db); };
            request.onupgradeneeded = (e) => {
                const db = e.target.result;
                if (!db.objectStoreNames.contains(this.STORE_NAME)) {
                    db.createObjectStore(this.STORE_NAME, { keyPath: 'id', autoIncrement: true });
                }
            };
        });
    };
    
    ProjectMgr.saveToLocal = async function(name) {
        if (!State.polygon && State.blocks.length === 0) { Toast.show('No hay datos para guardar', 'error'); return; }
        try {
            await this._initDB();
            const data = {
                name: name || `Proyecto ${new Date().toLocaleString('es-ES')}`,
                timestamp: Date.now(),
                polygon: State.polygon,
                blocks: State.blocks.map(b => ({ id: b.id, geo: b.geo, area: b.area, color: b.color })),
                lots: State.lots?.map(l => ({ coords: l.coords, area: l.area })) || [],
                settings: { gridAngle: State.gridAngle, theme: State.theme }
            };
            const tx = this._db.transaction(this.STORE_NAME, 'readwrite');
            const store = tx.objectStore(this.STORE_NAME);
            await new Promise((res, rej) => { const req = store.add(data); req.onsuccess = res; req.onerror = rej; });
            Toast.show('Proyecto guardado en navegador', 'success');
            this.refreshLocalList();
        } catch (e) { Toast.show('Error: ' + e.message, 'error'); }
    };
    
    ProjectMgr.loadFromLocal = async function(id) {
        try {
            await this._initDB();
            const tx = this._db.transaction(this.STORE_NAME, 'readonly');
            const store = tx.objectStore(this.STORE_NAME);
            const request = store.get(id);
            request.onsuccess = () => {
                const data = request.result;
                if (data) {
                    if (data.polygon) ImportMgr.setPolygon(data.polygon);
                    if (data.blocks) {
                        State.blocks = data.blocks.map(b => ({ ...b, uid: Math.random().toString(36).substr(2,9) }));
                        Renderer.render();
                    }
                    Toast.show('Proyecto cargado', 'success');
                }
            };
        } catch (e) { Toast.show('Error: ' + e.message, 'error'); }
    };
    
    ProjectMgr.deleteFromLocal = async function(id) {
        try {
            await this._initDB();
            const tx = this._db.transaction(this.STORE_NAME, 'readwrite');
            tx.objectStore(this.STORE_NAME).delete(id);
            this.refreshLocalList();
            Toast.show('Proyecto eliminado', 'success');
        } catch (e) { Toast.show('Error: ' + e.message, 'error'); }
    };
    
    ProjectMgr.refreshLocalList = async function() {
        const container = $('local-projects-list');
        if (!container) return;
        try {
            await this._initDB();
            const tx = this._db.transaction(this.STORE_NAME, 'readonly');
            const store = tx.objectStore(this.STORE_NAME);
            const request = store.getAll();
            request.onsuccess = () => {
                const projects = request.result;
                if (projects.length === 0) {
                    container.innerHTML = '<div style="text-align:center;color:var(--text-3);font-size:11px;padding:10px;">No hay proyectos</div>';
                    return;
                }
                container.innerHTML = projects.reverse().map(p => `
                    <div style="display:flex;justify-content:space-between;align-items:center;padding:6px 8px;background:rgba(0,0,0,0.2);border-radius:4px;margin-bottom:4px;">
                        <div style="flex:1;overflow:hidden;">
                            <div style="font-size:11px;font-weight:600;color:#fff;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${p.name}</div>
                            <div style="font-size:9px;color:var(--text-3);">${new Date(p.timestamp).toLocaleString('es-ES')}</div>
                        </div>
                        <div style="display:flex;gap:3px;">
                            <button onclick="ProjectMgr.loadFromLocal(${p.id})" style="background:#22c55e;border:none;color:white;padding:3px 6px;border-radius:3px;cursor:pointer;font-size:9px;">Abrir</button>
                            <button onclick="ProjectMgr.deleteFromLocal(${p.id})" style="background:#ef4444;border:none;color:white;padding:3px 6px;border-radius:3px;cursor:pointer;font-size:9px;"></button>
                        </div>
                    </div>
                `).join('');
            };
        } catch (e) { container.innerHTML = '<div style="color:#ef4444;font-size:10px;padding:10px;">Error al cargar</div>'; }
    };
    
    // EXTENSIN 3: UTM mejorado con deteccin automtica
    UTM.detectZone = function(lat, lng) {
        let zone = Math.floor((lng + 180) / 6) + 1;
        if (lat >= 56 && lat < 64 && lng >= 3 && lng < 12) zone = 32;
        if (lat >= 72 && lat < 84) {
            if (lng >= 0 && lng < 9) zone = 31;
            else if (lng >= 9 && lng < 21) zone = 33;
            else if (lng >= 21 && lng < 33) zone = 35;
            else if (lng >= 33 && lng < 42) zone = 37;
        }
        return zone + (lat >= 0 ? 'N' : 'S');
    };
    
    UTM.getPolygonZone = function() {
        if (!State.polygon) return '19N';
        const center = turf.centroid(State.polygon);
        return this.detectZone(center.geometry.coordinates[1], center.geometry.coordinates[0]);
    };
    
    // Inicializar lista de proyectos locales
    setTimeout(() => { if (typeof ProjectMgr !== 'undefined') ProjectMgr.refreshLocalList(); }, 2000);
    
    console.log('WIN-TEL v30 - Extensiones cargadas: ImportMgr+, ProjectMgr+, UTM+');

    // ========== V30 MODULE: TREE COUNTER - CONTEO MANUAL DE CULTIVOS ==========
    const TreeCounter = {
        trees: [],
        markers: [],
        layerGroup: null,
        isDrawing: false,
        currentCropType: 'tree',
        
        cropProfiles: {
            tree: { name: 'rboles', icon: '', color: '#22c55e', defaultRadius: 3, production: 0 },
            palm: { name: 'Palmas', icon: '', color: '#84cc16', defaultRadius: 4, production: 15 },
            citrus: { name: 'Ctricos', icon: '', color: '#f59e0b', defaultRadius: 2.5, production: 80 },
            coffee: { name: 'Caf', icon: '', color: '#92400e', defaultRadius: 1.5, production: 2.5 },
            cacao: { name: 'Cacao', icon: '', color: '#7c3aed', defaultRadius: 2, production: 1 },
            mango: { name: 'Mango', icon: '', color: '#ef4444', defaultRadius: 5, production: 150 },
            avocado: { name: 'Aguacate', icon: '', color: '#065f46', defaultRadius: 4, production: 100 },
            banana: { name: 'Pltano', icon: '', color: '#fbbf24', defaultRadius: 2, production: 25 },
            olive: { name: 'Olivo', icon: '', color: '#6b7280', defaultRadius: 3, production: 20 },
            grape: { name: 'Uva/Vid', icon: '', color: '#7c3aed', defaultRadius: 1, production: 8 },
            other: { name: 'Otro', icon: '', color: '#06b6d4', defaultRadius: 2, production: 0 }
        },
        
        init() {
            this.layerGroup = L.layerGroup().addTo(State.map);
            this.loadFromStorage();
        },
        
        togglePanel() {
            const panel = $('tree-counter-panel');
            if (panel) {
                const isVisible = panel.style.display !== 'none';
                panel.style.display = isVisible ? 'none' : 'block';
                if (!isVisible) this.updateStats();
            }
        },
        
        setCropType(type) {
            this.currentCropType = type;
            const profile = this.cropProfiles[type];
            if ($('tc-radius')) $('tc-radius').value = profile.defaultRadius;
            Toast.show(`Tipo: ${profile.icon} ${profile.name}`, 'info');
        },
        
        startDrawing() {
            if (this.isDrawing) {
                this.stopDrawing();
                return;
            }
            this.isDrawing = true;
            State.map.getContainer().style.cursor = 'crosshair';
            if ($('tc-start-btn')) {
                $('tc-start-btn').innerHTML = '<i class="fa-solid fa-stop"></i> DETENER CONTEO';
                $('tc-start-btn').style.background = 'linear-gradient(135deg,#ef4444,#dc2626)';
            }
            this._bindClick = this._onMapClick.bind(this);
            State.map.on('click', this._bindClick);
            Toast.show(' Haz clic en cada rbol para contarlo', 'success');
        },
        
        stopDrawing() {
            this.isDrawing = false;
            State.map.getContainer().style.cursor = '';
            if (this._bindClick) State.map.off('click', this._bindClick);
            if ($('tc-start-btn')) {
                $('tc-start-btn').innerHTML = '<i class="fa-solid fa-crosshairs"></i> INICIAR CONTEO';
                $('tc-start-btn').style.background = 'linear-gradient(135deg,#22c55e,#16a34a)';
            }
            this.saveToStorage();
            Toast.show(`Conteo pausado. Total: ${this.trees.length}`, 'info');
        },
        
        _onMapClick(e) {
            if (!this.isDrawing) return;
            const profile = this.cropProfiles[this.currentCropType];
            const radius = parseFloat($('tc-radius')?.value) || profile.defaultRadius;
            const tree = {
                id: this.trees.length + 1,
                lat: e.latlng.lat,
                lng: e.latlng.lng,
                type: this.currentCropType,
                radius: radius,
                timestamp: Date.now()
            };
            this.trees.push(tree);
            this.addMarker(tree);
            this.updateStats();
            if ($('tc-count')) {
                $('tc-count').style.transform = 'scale(1.3)';
                setTimeout(() => $('tc-count').style.transform = 'scale(1)', 150);
            }
        },
        
        addMarker(tree) {
            const profile = this.cropProfiles[tree.type];
            const circle = L.circle([tree.lat, tree.lng], {
                radius: tree.radius,
                color: profile.color,
                fillColor: profile.color,
                fillOpacity: 0.35,
                weight: 2
            }).addTo(this.layerGroup);
            
            const marker = L.marker([tree.lat, tree.lng], {
                icon: L.divIcon({
                    className: '',
                    html: `<div style="background:${profile.color};color:white;min-width:22px;height:22px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:bold;border:2px solid white;box-shadow:0 2px 6px rgba(0,0,0,0.4);padding:0 4px;">${tree.id}</div>`,
                    iconSize: [22, 22],
                    iconAnchor: [11, 11]
                })
            }).addTo(this.layerGroup);
            
            marker.bindPopup(`
                <div style="min-width:160px;text-align:center;">
                    <div style="font-size:24px;">${profile.icon}</div>
                    <b style="color:${profile.color};">${profile.name} #${tree.id}</b>
                    <hr style="margin:6px 0;border-color:#ddd;">
                    <div style="font-size:11px;">
                        <b>Radio:</b> ${tree.radius.toFixed(1)} m<br>
                        <b>rea copa:</b> ${(Math.PI * tree.radius * tree.radius).toFixed(1)} m
                    </div>
                    <hr style="margin:6px 0;border-color:#ddd;">
                    <div style="font-family:monospace;font-size:9px;color:#666;">
                        ${tree.lat.toFixed(6)}<br>${tree.lng.toFixed(6)}
                    </div>
                    <button onclick="TreeCounter.deleteTree(${tree.id})" style="margin-top:8px;background:#ef4444;color:white;border:none;padding:4px 12px;border-radius:4px;cursor:pointer;font-size:11px;">
                        <i class="fa-solid fa-trash"></i> Eliminar
                    </button>
                </div>
            `);
            this.markers.push({ id: tree.id, circle, marker });
        },
        
        deleteTree(id) {
            this.trees = this.trees.filter(t => t.id !== id);
            const markerObj = this.markers.find(m => m.id === id);
            if (markerObj) {
                this.layerGroup.removeLayer(markerObj.circle);
                this.layerGroup.removeLayer(markerObj.marker);
            }
            this.markers = this.markers.filter(m => m.id !== id);
            this.renumberTrees();
            this.updateStats();
            this.saveToStorage();
            Toast.show('Eliminado', 'success');
        },
        
        renumberTrees() {
            this.trees.forEach((t, i) => t.id = i + 1);
            this.layerGroup.clearLayers();
            this.markers = [];
            this.trees.forEach(t => this.addMarker(t));
        },
        
        clearAll() {
            if (this.trees.length === 0) return;
            if (!confirm(`Eliminar los ${this.trees.length} elementos?`)) return;
            this.trees = [];
            this.markers = [];
            this.layerGroup.clearLayers();
            this.updateStats();
            this.saveToStorage();
            Toast.show('Todo eliminado', 'success');
        },
        
        updateStats() {
            const total = this.trees.length;
            const byType = {};
            this.trees.forEach(t => byType[t.type] = (byType[t.type] || 0) + 1);
            const totalCanopy = this.trees.reduce((sum, t) => sum + Math.PI * t.radius * t.radius, 0);
            let density = 0, coverage = 0;
            if (State.polygon) {
                const areaHa = turf.area(State.polygon) / 10000;
                density = areaHa > 0 ? total / areaHa : 0;
                coverage = areaHa > 0 ? (totalCanopy / (areaHa * 10000)) * 100 : 0;
            }
            let production = 0;
            this.trees.forEach(t => production += this.cropProfiles[t.type].production);
            
            if ($('tc-count')) $('tc-count').textContent = total.toLocaleString();
            if ($('tc-density')) $('tc-density').textContent = density.toFixed(1);
            if ($('tc-canopy')) $('tc-canopy').textContent = totalCanopy.toFixed(0) + ' m';
            if ($('tc-coverage')) $('tc-coverage').textContent = coverage.toFixed(1) + '%';
            
            const breakdownEl = $('tc-breakdown');
            if (breakdownEl) {
                if (Object.keys(byType).length > 0) {
                    breakdownEl.innerHTML = Object.entries(byType).map(([type, count]) => {
                        const p = this.cropProfiles[type];
                        return `<span style="display:inline-flex;align-items:center;gap:3px;background:${p.color}22;border:1px solid ${p.color};padding:2px 8px;border-radius:10px;margin:2px;font-size:10px;">${p.icon} ${count}</span>`;
                    }).join('');
                } else {
                    breakdownEl.innerHTML = '';
                }
            }
            
            if ($('tc-production') && production > 0) {
                $('tc-production').textContent = `Produccin estimada: ${production.toLocaleString()} kg/ao`;
                $('tc-production').style.display = 'block';
            } else if ($('tc-production')) {
                $('tc-production').style.display = 'none';
            }
            
            if ($('tc-results')) $('tc-results').style.display = total > 0 ? 'block' : 'none';
        },
        
        saveToStorage() {
            try { localStorage.setItem('wintel_tree_count', JSON.stringify(this.trees)); } catch (e) {}
        },
        
        loadFromStorage() {
            try {
                const saved = localStorage.getItem('wintel_tree_count');
                if (saved) {
                    this.trees = JSON.parse(saved);
                    this.trees.forEach(t => this.addMarker(t));
                    this.updateStats();
                }
            } catch (e) {}
        },
        
        exportKML() {
            if (this.trees.length === 0) return Toast.show('No hay datos', 'error');
            let kml = `<?xml version="1.0" encoding="UTF-8"?>\n<kml xmlns="http://www.opengis.net/kml/2.2">\n<Document>\n<name>Conteo de Cultivos - WIN-TEL v30</name>\n`;
            Object.entries(this.cropProfiles).forEach(([type, p]) => {
                const hex = p.color.slice(1);
                kml += `<Style id="s_${type}"><IconStyle><color>ff${hex.slice(4,6)}${hex.slice(2,4)}${hex.slice(0,2)}</color><scale>1</scale><Icon><href>http://maps.google.com/mapfiles/kml/shapes/placemark_circle.png</href></Icon></IconStyle></Style>\n`;
            });
            kml += `<Folder><name>Cultivos (${this.trees.length})</name>\n`;
            this.trees.forEach(t => {
                const p = this.cropProfiles[t.type];
                kml += `<Placemark><name>${p.icon} ${p.name} #${t.id}</name><description>Radio: ${t.radius}m</description><styleUrl>#s_${t.type}</styleUrl><Point><coordinates>${t.lng},${t.lat},0</coordinates></Point></Placemark>\n`;
            });
            kml += `</Folder>\n</Document>\n</kml>`;
            download(kml, `conteo_cultivos_${Date.now()}.kml`, 'application/vnd.google-earth.kml+xml');
            Toast.show('KML exportado', 'success');
        },
        
        exportCSV() {
            if (this.trees.length === 0) return Toast.show('No hay datos', 'error');
            const totalArea = State.polygon ? turf.area(State.polygon) : 0;
            let csv = `INVENTARIO DE CULTIVOS - WIN-TEL v30\nFecha,${new Date().toLocaleString('es-ES')}\nTotal,${this.trees.length}\n`;
            if (totalArea > 0) csv += `Area_Ha,${(totalArea/10000).toFixed(4)}\nDensidad_Ha,${(this.trees.length/(totalArea/10000)).toFixed(1)}\n`;
            csv += `\nID,TIPO,LATITUD,LONGITUD,RADIO_M,AREA_M2\n`;
            this.trees.forEach(t => {
                const p = this.cropProfiles[t.type];
                csv += `${t.id},${p.name},${t.lat.toFixed(6)},${t.lng.toFixed(6)},${t.radius.toFixed(2)},${(Math.PI*t.radius*t.radius).toFixed(2)}\n`;
            });
            download(csv, `conteo_cultivos_${Date.now()}.csv`, 'text/csv');
            Toast.show('CSV exportado', 'success');
        },
        
        exportGeoJSON() {
            if (this.trees.length === 0) return Toast.show('No hay datos', 'error');
            const features = this.trees.map(t => ({
                type: 'Feature',
                properties: { id: t.id, type: t.type, name: this.cropProfiles[t.type].name, radius_m: t.radius },
                geometry: { type: 'Point', coordinates: [t.lng, t.lat] }
            }));
            const geojson = { type: 'FeatureCollection', properties: { name: 'Conteo', total: this.trees.length }, features };
            download(JSON.stringify(geojson, null, 2), `conteo_cultivos_${Date.now()}.geojson`, 'application/json');
            Toast.show('GeoJSON exportado', 'success');
        },
        
        exportGPX() {
            if (this.trees.length === 0) return Toast.show('No hay datos', 'error');
            let gpx = `<?xml version="1.0" encoding="UTF-8"?>\n<gpx version="1.1" creator="WIN-TEL v30">\n<metadata><name>Conteo de Cultivos</name></metadata>\n`;
            this.trees.forEach(t => {
                const p = this.cropProfiles[t.type];
                gpx += `<wpt lat="${t.lat}" lon="${t.lng}"><name>${p.name} ${t.id}</name><desc>Radio: ${t.radius}m</desc></wpt>\n`;
            });
            gpx += `</gpx>`;
            download(gpx, `conteo_cultivos_${Date.now()}.gpx`, 'application/gpx+xml');
            Toast.show('GPX exportado (para GPS)', 'success');
        },
        
        exportPDF() {
            if (this.trees.length === 0) return Toast.show('No hay datos', 'error');
            if (typeof jspdf === 'undefined') return Toast.show('PDF no disponible', 'error');
            const { jsPDF } = jspdf;
            const doc = new jsPDF();
            const totalArea = State.polygon ? turf.area(State.polygon) : 0;
            let y = 20;
            doc.setFontSize(18); doc.setTextColor(34,197,94);
            doc.text('INVENTARIO DE CULTIVOS', 105, y, { align: 'center' });
            y += 8; doc.setFontSize(10); doc.setTextColor(100);
            doc.text('WIN-TEL GEOMATICS PRO v30', 105, y, { align: 'center' });
            y += 15; doc.setFontSize(12); doc.setTextColor(0);
            doc.text('RESUMEN', 20, y); y += 8; doc.setFontSize(10);
            doc.text(`Fecha: ${new Date().toLocaleString('es-ES')}`, 25, y); y += 5;
            doc.text(`Total contados: ${this.trees.length}`, 25, y); y += 5;
            if (totalArea > 0) {
                doc.text(`rea: ${(totalArea/10000).toFixed(4)} Ha`, 25, y); y += 5;
                doc.text(`Densidad: ${(this.trees.length/(totalArea/10000)).toFixed(1)}/Ha`, 25, y); y += 5;
            }
            const byType = {};
            this.trees.forEach(t => byType[t.type] = (byType[t.type] || 0) + 1);
            y += 5; doc.setFontSize(12);
            doc.text('POR TIPO', 20, y); y += 8; doc.setFontSize(10);
            Object.entries(byType).forEach(([type, count]) => {
                doc.text(`${this.cropProfiles[type].name}: ${count}`, 25, y); y += 5;
            });
            y += 5; doc.setFontSize(12);
            doc.text('LISTADO', 20, y); y += 8; doc.setFontSize(8);
            doc.setFont('helvetica', 'bold');
            doc.text('ID', 20, y); doc.text('TIPO', 35, y); doc.text('LAT', 70, y); doc.text('LNG', 105, y); doc.text('RADIO', 145, y);
            y += 5; doc.setFont('helvetica', 'normal');
            this.trees.forEach(t => {
                if (y > 280) { doc.addPage(); y = 20; }
                doc.text(t.id.toString(), 20, y);
                doc.text(this.cropProfiles[t.type].name, 35, y);
                doc.text(t.lat.toFixed(6), 70, y);
                doc.text(t.lng.toFixed(6), 105, y);
                doc.text(t.radius.toFixed(1) + 'm', 145, y);
                y += 4;
            });
            doc.save(`inventario_cultivos_${Date.now()}.pdf`);
            Toast.show('PDF exportado', 'success');
        },
        
        copyToClipboard() {
            if (this.trees.length === 0) return Toast.show('No hay datos', 'error');
            let text = `CONTEO - WIN-TEL v30\nTotal: ${this.trees.length}\n\nID\tTIPO\tLAT\tLNG\tRADIO\n`;
            this.trees.forEach(t => {
                text += `${t.id}\t${this.cropProfiles[t.type].name}\t${t.lat.toFixed(6)}\t${t.lng.toFixed(6)}\t${t.radius}m\n`;
            });
            navigator.clipboard.writeText(text).then(() => Toast.show('Copiado', 'success')).catch(() => Toast.show('Error', 'error'));
        }
    };
    
    // Inicializar TreeCounter
    setTimeout(() => { if (State && State.map) TreeCounter.init(); }, 2000);

    // ========== MDULO 1: ANLISIS NDVI - SALUD DE CULTIVOS ==========
    const NDVIAnalyzer = {
        panel: null, layer: null, data: [],
        togglePanel() {
            if (this.panel) { this.panel.remove(); this.panel = null; return; }
            const html = `<div id="ndvi-panel" class="float-panel" style="top:80px;right:60px;width:340px;">
                <div class="panel-hdr" style="background:linear-gradient(135deg,rgba(34,197,94,0.3),rgba(22,163,74,0.2));">
                    <div class="panel-title"><i class="fa-solid fa-leaf" style="color:#22c55e;"></i> Anlisis NDVI</div>
                    <button class="panel-close" onclick="NDVIAnalyzer.togglePanel()"><i class="fa-solid fa-times"></i></button>
                </div>
                <div class="panel-body">
                    <div style="background:rgba(34,197,94,0.15);border:1px solid #22c55e;border-radius:6px;padding:10px;margin-bottom:12px;">
                        <div style="font-size:10px;color:#22c55e;font-weight:700;"> SALUD DE CULTIVOS</div>
                        <div style="font-size:9px;color:var(--text-3);">Analiza vegetacin mediante ndice NDVI</div>
                    </div>
                    <div class="form-group"><label class="form-label">Tipo de Cultivo</label>
                        <select id="ndvi-crop" class="form-input">
                            <option value="general">General</option><option value="maize">Maz</option>
                            <option value="coffee">Caf</option><option value="fruit">Frutales</option>
                        </select>
                    </div>
                    <div class="form-group"><label class="form-label">Resolucin</label>
                        <select id="ndvi-res" class="form-input">
                            <option value="15">Alta (15m)</option><option value="25" selected>Media (25m)</option>
                        </select>
                    </div>
                    <button class="btn" onclick="NDVIAnalyzer.analyze()" style="background:linear-gradient(135deg,#22c55e,#16a34a);">
                        <i class="fa-solid fa-satellite-dish"></i> ANALIZAR
                    </button>
                    <div id="ndvi-results" style="display:none;margin-top:12px;"></div>
                </div>
            </div>`;
            document.body.insertAdjacentHTML('beforeend', html);
            this.panel = document.getElementById('ndvi-panel');
        },
        async analyze() {
            if (!State.polygon) return Toast.show('Dibuja un polgono', 'error');
            Loading.show();
            const res = parseInt($('ndvi-res')?.value) || 25;
            const bbox = turf.bbox(State.polygon);
            const cellSize = res / 111320;
            this.data = [];
            this.layer = this.layer || L.layerGroup().addTo(State.map);
            this.layer.clearLayers();
            for (let lat = bbox[1]; lat <= bbox[3]; lat += cellSize) {
                for (let lng = bbox[0]; lng <= bbox[2]; lng += cellSize) {
                    const pt = turf.point([lng, lat]);
                    if (turf.booleanPointInPolygon(pt, State.polygon)) {
                        const distCenter = turf.distance(pt, turf.centroid(State.polygon));
                        const maxDist = Math.sqrt(turf.area(State.polygon)) / 100;
                        const ndvi = Math.max(0, Math.min(1, 0.7 - (distCenter/maxDist)*0.3 + (Math.random()-0.5)*0.2));
                        this.data.push({ lat, lng, ndvi });
                        const color = ndvi < 0.3 ? '#8B4513' : ndvi < 0.5 ? '#F0E68C' : ndvi < 0.7 ? '#7CFC00' : '#006400';
                        L.rectangle([[lat, lng], [lat+cellSize, lng+cellSize]], {
                            color, fillColor: color, fillOpacity: 0.6, weight: 0
                        }).bindPopup(`NDVI: ${ndvi.toFixed(2)}`).addTo(this.layer);
                    }
                }
            }
            this.showResults();
            Loading.hide();
            Toast.show('NDVI completado', 'success');
        },
        showResults() {
            const avg = this.data.reduce((s,d)=>s+d.ndvi,0)/this.data.length;
            const stressed = this.data.filter(d=>d.ndvi<0.4).length;
            const healthy = this.data.filter(d=>d.ndvi>=0.6).length;
            const rd = $('ndvi-results');
            if(rd) {
                rd.style.display = 'block';
                rd.innerHTML = `<div style="background:var(--bg-glass);padding:10px;border-radius:6px;">
                    <div style="text-align:center;"><div style="font-size:24px;font-weight:800;color:#22c55e;">${avg.toFixed(2)}</div>
                    <div style="font-size:9px;">NDVI PROMEDIO</div></div>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-top:8px;">
                        <div style="text-align:center;"><div style="font-size:16px;font-weight:700;color:#ef4444;">${stressed}</div><div style="font-size:8px;">Estrs</div></div>
                        <div style="text-align:center;"><div style="font-size:16px;font-weight:700;color:#22c55e;">${healthy}</div><div style="font-size:8px;">Saludables</div></div>
                    </div>
                </div>
                <button class="btn btn-2" onclick="NDVIAnalyzer.exportCSV()" style="margin-top:8px;font-size:9px;">Exportar CSV</button>`;
            }
        },
        exportCSV() {
            if (!this.data.length) return;
            let csv = 'LAT,LNG,NDVI\n';
            this.data.forEach(d => csv += `${d.lat.toFixed(6)},${d.lng.toFixed(6)},${d.ndvi.toFixed(3)}\n`);
            download(csv, `ndvi_${Date.now()}.csv`, 'text/csv');
            Toast.show('CSV exportado', 'success');
        },
        clear() { if(this.layer) this.layer.clearLayers(); this.data = []; }
    };

    // ========== MDULO 2: GENERADOR DE PLANOS PROFESIONALES ==========
    const PlanoGenerator = {
        panel: null, results: null,
        togglePanel() {
            if (this.panel) { this.panel.remove(); this.panel = null; return; }
            const html = `<div id="plano-panel" class="float-panel" style="top:80px;right:60px;width:380px;max-height:90vh;overflow-y:auto;">
                <div class="panel-hdr" style="background:linear-gradient(135deg,rgba(139,92,246,0.3),rgba(124,58,237,0.2));">
                    <div class="panel-title"><i class="fa-solid fa-map" style="color:#a78bfa;"></i> Generador de Planos</div>
                    <button class="panel-close" onclick="PlanoGenerator.togglePanel()"><i class="fa-solid fa-times"></i></button>
                </div>
                <div class="panel-body">
                    <div style="background:rgba(139,92,246,0.15);border:1px solid #a78bfa;border-radius:6px;padding:10px;margin-bottom:12px;">
                        <div style="font-size:10px;color:#a78bfa;font-weight:700;"> PLANO TOPOGRFICO PROFESIONAL</div>
                        <div style="font-size:9px;color:var(--text-3);margin-top:3px;">Genera informe completo con coordenadas UTM, rumbos, distancias, reas y lotes</div>
                    </div>
                    <div class="form-group"><label class="form-label">Ttulo del Plano</label>
                        <input type="text" id="plano-title" class="form-input" value="PLANO DE LEVANTAMIENTO TOPOGRFICO">
                    </div>
                    <div class="form-group"><label class="form-label">Propietario</label>
                        <input type="text" id="plano-owner" class="form-input" placeholder="Nombre del propietario">
                    </div>
                    <div class="form-group"><label class="form-label">Ubicacin</label>
                        <input type="text" id="plano-location" class="form-input" placeholder="Municipio, Estado, Parroquia">
                    </div>
                    <div class="form-group"><label class="form-label">Nro. de Catastro / Expediente</label>
                        <input type="text" id="plano-catastro" class="form-input" placeholder="Nro. catastral (opcional)">
                    </div>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
                        <div class="form-group"><label class="form-label">Escala</label>
                            <select id="plano-scale" class="form-input">
                                <option value="250">1:250</option><option value="500">1:500</option>
                                <option value="1000" selected>1:1000</option><option value="2000">1:2000</option>
                                <option value="5000">1:5000</option><option value="10000">1:10000</option>
                            </select>
                        </div>
                        <div class="form-group"><label class="form-label">Formato</label>
                            <select id="plano-format" class="form-input">
                                <option value="A4">A4</option><option value="A3" selected>A3</option>
                                <option value="A2">A2</option><option value="A1">A1</option>
                            </select>
                        </div>
                    </div>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
                        <div class="form-group"><label class="form-label">Profesional</label>
                            <input type="text" id="plano-prof" class="form-input" placeholder="Ing. / TSU">
                        </div>
                        <div class="form-group"><label class="form-label">Colegiatura</label>
                            <input type="text" id="plano-civ" class="form-input" placeholder="CIV / CAV">
                        </div>
                    </div>
                    <div class="form-group"><label class="form-label">Observaciones</label>
                        <input type="text" id="plano-obs" class="form-input" placeholder="Notas adicionales (opcional)">
                    </div>
                    <button class="btn" onclick="PlanoGenerator.computeAndGenerate()" style="background:linear-gradient(135deg,#8b5cf6,#7c3aed);">
                        <i class="fa-solid fa-calculator"></i> CALCULAR Y GENERAR
                    </button>
                    <div id="plano-results" style="display:none;margin-top:12px;"></div>
                </div>
            </div>`;
            document.body.insertAdjacentHTML('beforeend', html);
            this.panel = document.getElementById('plano-panel');
        },
        computeAndGenerate() {
            if (!State.polygon && State.blocks.length === 0) return Toast.show('Dibuja un polgono primero', 'error');
            Loading.show();
            try {
                const target = State.polygon || State.blocks[0]?.geo;
                const coords = target.geometry.coordinates[0];
                const zone = UTM.getZone(coords[0][0]);
                const area = GeoMath.area(coords);
                const perimeter = GeoMath.perimeter(coords);
                // Build vertex table with UTM
                const vertices = [];
                for (let i = 0; i < coords.length - 1; i++) {
                    const [lon, lat] = coords[i];
                    const utm = UTM.fromLatLon(lon, lat, zone);
                    vertices.push({ n: i + 1, lat, lon, utmE: utm[0], utmN: utm[1] });
                }
                // Build edges table with distance, azimuth, rumbo
                const edges = [];
                for (let i = 0; i < coords.length - 1; i++) {
                    const [lon1, lat1] = coords[i];
                    const [lon2, lat2] = coords[(i + 1) % (coords.length - 1)] || coords[i + 1];
                    const dist = GeoMath.vincentyDist(lat1, lon1, lat2, lon2);
                    const az = GeoMath.bearing(lat1, lon1, lat2, lon2);
                    const rumbo = GeoMath.azToRumbo(az);
                    edges.push({ from: i + 1, to: (i + 1 >= coords.length - 1) ? 1 : i + 2, dist, az, rumbo });
                }
                // Centroid
                const centroid = turf.centroid(target).geometry.coordinates;
                const centroidUTM = UTM.fromLatLon(centroid[0], centroid[1], zone);
                // Bounding box
                const bbox = turf.bbox(target);
                const bboxUTM_min = UTM.fromLatLon(bbox[0], bbox[1], zone);
                const bboxUTM_max = UTM.fromLatLon(bbox[2], bbox[3], zone);
                const widthM = GeoMath.vincentyDist(bbox[1], bbox[0], bbox[1], bbox[2]);
                const heightM = GeoMath.vincentyDist(bbox[1], bbox[0], bbox[3], bbox[0]);
                // Lots info
                const lotsInfo = [];
                if (State.blocks.length > 0) {
                    State.blocks.forEach(b => {
                        const lCoords = b.geo.geometry.coordinates[0];
                        const lZone = UTM.getZone(lCoords[0][0]);
                        const lArea = GeoMath.area(lCoords);
                        const lPerim = GeoMath.perimeter(lCoords);
                        const lVerts = [];
                        for (let i = 0; i < lCoords.length - 1; i++) {
                            const utm = UTM.fromLatLon(lCoords[i][0], lCoords[i][1], lZone);
                            lVerts.push({ n: i + 1, utmE: utm[0], utmN: utm[1] });
                        }
                        lotsInfo.push({ id: b.id, area: lArea, perim: lPerim, verts: lVerts, color: b.color });
                    });
                }
                // Metadata
                const meta = {
                    title: $('plano-title')?.value || 'PLANO TOPOGRFICO',
                    owner: $('plano-owner')?.value || '',
                    location: $('plano-location')?.value || '',
                    catastro: $('plano-catastro')?.value || '',
                    scale: $('plano-scale')?.value || '1000',
                    format: $('plano-format')?.value || 'A3',
                    prof: $('plano-prof')?.value || '',
                    civ: $('plano-civ')?.value || '',
                    obs: $('plano-obs')?.value || '',
                    date: new Date().toLocaleDateString('es-ES'),
                    dateISO: new Date().toISOString()
                };
                this.results = {
                    coords, zone, area, perimeter, vertices, edges,
                    centroid, centroidUTM, bbox, bboxUTM_min, bboxUTM_max,
                    widthM, heightM, lotsInfo, meta, numVertices: vertices.length
                };
                this.showResults();
                Loading.hide();
                Toast.show('Datos topogrficos calculados', 'success');
            } catch (e) {
                Loading.hide();
                Toast.show('Error: ' + e.message, 'error');
                console.error(e);
            }
        },
        showResults() {
            const r = this.results;
            if (!r) return;
            const rd = $('plano-results');
            if (!rd) return;
            rd.style.display = 'block';
            rd.innerHTML = `<div style="background:linear-gradient(135deg,rgba(139,92,246,0.2),rgba(124,58,237,0.15));border-radius:8px;padding:12px;">
                <div style="text-align:center;margin-bottom:10px;">
                    <div style="font-size:10px;color:var(--text-3);">RESUMEN TOPOGRFICO</div>
                    <div style="font-size:16px;font-weight:800;color:#a78bfa;">${(r.area / 10000).toFixed(4)} Ha</div>
                    <div style="font-size:10px;color:var(--text-3);">${r.area.toFixed(2)} m</div>
                </div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;">
                    <div style="text-align:center;background:var(--bg-glass);padding:6px;border-radius:4px;">
                        <div style="font-size:14px;font-weight:700;color:#22c55e;">${r.perimeter.toFixed(2)}</div>
                        <div style="font-size:8px;">PERMETRO (m)</div>
                    </div>
                    <div style="text-align:center;background:var(--bg-glass);padding:6px;border-radius:4px;">
                        <div style="font-size:14px;font-weight:700;color:#f59e0b;">${r.numVertices}</div>
                        <div style="font-size:8px;">VRTICES</div>
                    </div>
                </div>
            </div>
            <div style="margin-top:10px;">
                <div style="font-size:10px;font-weight:600;color:#a78bfa;margin-bottom:6px;">
                    <i class="fa-solid fa-crosshairs"></i> COORDENADAS UTM (Zona ${r.zone})
                </div>
                <div style="max-height:150px;overflow-y:auto;background:var(--bg-glass);border-radius:6px;padding:6px;">
                    <table style="width:100%;font-size:9px;border-collapse:collapse;">
                        <thead><tr style="color:#a78bfa;">
                            <th style="padding:2px;">V</th><th style="padding:2px;">Este</th><th style="padding:2px;">Norte</th>
                        </tr></thead>
                        <tbody style="color:var(--text-2);">
                            ${r.vertices.map(v => `<tr><td style="text-align:center;padding:2px;"><b>${v.n}</b></td><td style="padding:2px;">${v.utmE.toFixed(2)}</td><td style="padding:2px;">${v.utmN.toFixed(2)}</td></tr>`).join('')}
                        </tbody>
                    </table>
                </div>
            </div>
            <div style="margin-top:10px;">
                <div style="font-size:10px;font-weight:600;color:#22c55e;margin-bottom:6px;">
                    <i class="fa-solid fa-ruler-combined"></i> LADOS - DISTANCIAS Y RUMBOS
                </div>
                <div style="max-height:150px;overflow-y:auto;background:var(--bg-glass);border-radius:6px;padding:6px;">
                    <table style="width:100%;font-size:9px;border-collapse:collapse;">
                        <thead><tr style="color:#22c55e;">
                            <th style="padding:2px;">Lado</th><th style="padding:2px;">Dist(m)</th><th style="padding:2px;">Az</th><th style="padding:2px;">Rumbo</th>
                        </tr></thead>
                        <tbody style="color:var(--text-2);">
                            ${r.edges.map(e => `<tr><td style="text-align:center;padding:2px;"><b>${e.from}-${e.to}</b></td><td style="padding:2px;">${e.dist.toFixed(2)}</td><td style="padding:2px;">${e.az.toFixed(2)}</td><td style="padding:2px;font-size:8px;">${e.rumbo}</td></tr>`).join('')}
                        </tbody>
                    </table>
                </div>
            </div>
            ${r.lotsInfo.length > 0 ? `<div style="margin-top:10px;">
                <div style="font-size:10px;font-weight:600;color:#f59e0b;margin-bottom:6px;">
                    <i class="fa-solid fa-th-large"></i> SUBDIVISIONES (${r.lotsInfo.length} lotes)
                </div>
                <div style="max-height:100px;overflow-y:auto;background:var(--bg-glass);border-radius:6px;padding:6px;font-size:9px;color:var(--text-2);">
                    ${r.lotsInfo.map(l => `<div style="display:flex;align-items:center;gap:4px;padding:2px 0;"><span style="display:inline-block;width:8px;height:8px;background:${l.color};border-radius:2px;"></span> Lote ${l.id}: <b>${(l.area / 10000).toFixed(4)} Ha</b> | P: ${l.perim.toFixed(1)}m | ${l.verts.length}v</div>`).join('')}
                </div>
            </div>` : ''}
            <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:4px;margin-top:12px;">
                <button class="btn btn-2" onclick="PlanoGenerator.exportKML()" style="font-size:8px;padding:6px;" title="Google Earth">
                    <i class="fa-solid fa-earth-americas"></i> KML
                </button>
                <button class="btn btn-2" onclick="PlanoGenerator.exportGeoJSON()" style="font-size:8px;padding:6px;" title="GIS">
                    <i class="fa-solid fa-code"></i> JSON
                </button>
                <button class="btn btn-2" onclick="PlanoGenerator.exportDXF()" style="font-size:8px;padding:6px;" title="AutoCAD">
                    <i class="fa-solid fa-drafting-compass"></i> DXF
                </button>
                <button class="btn btn-2" onclick="PlanoGenerator.exportCSV()" style="font-size:8px;padding:6px;" title="Excel">
                    <i class="fa-solid fa-file-csv"></i> CSV
                </button>
            </div>
            <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:4px;margin-top:4px;">
                <button class="btn btn-2" onclick="PlanoGenerator.exportGPX()" style="font-size:8px;padding:6px;" title="GPS">
                    <i class="fa-solid fa-satellite"></i> GPX
                </button>
                <button class="btn" onclick="PlanoGenerator.exportPDF()" style="font-size:8px;padding:6px;background:linear-gradient(135deg,#8b5cf6,#7c3aed);" title="Plano PDF profesional">
                    <i class="fa-solid fa-file-pdf"></i> PDF
                </button>
                <button class="btn btn-2" onclick="PlanoGenerator.exportTXT()" style="font-size:8px;padding:6px;" title="Texto">
                    <i class="fa-solid fa-file-lines"></i> TXT
                </button>
                <button class="btn btn-2" onclick="PlanoGenerator.copyToClipboard()" style="font-size:8px;padding:6px;" title="Copiar">
                    <i class="fa-solid fa-copy"></i> COPY
                </button>
            </div>`;
        },
        // ========== EXPORTAR KML ==========
        exportKML() {
            if (!this.results) return Toast.show('Calcula primero', 'error');
            const r = this.results;
            const kmlCoords = r.coords.map(c => `${c[0]},${c[1]},0`).join(' ');
            let vertDesc = r.vertices.map(v => `V${v.n}: E${v.utmE.toFixed(2)} N${v.utmN.toFixed(2)}`).join('&#10;');
            let edgeDesc = r.edges.map(e => `${e.from}-${e.to}: ${e.dist.toFixed(2)}m Az:${e.az.toFixed(2)} ${e.rumbo}`).join('&#10;');
            let kml = `<?xml version="1.0" encoding="UTF-8"?>
<kml xmlns="http://www.opengis.net/kml/2.2">
<Document>
<n>${r.meta.title}</n>
<description>Propietario: ${r.meta.owner}
Ubicacin: ${r.meta.location}
rea: ${(r.area/10000).toFixed(4)} Ha
Permetro: ${r.perimeter.toFixed(2)} m
Fecha: ${r.meta.date}</description>
<Style id="parcel"><LineStyle><color>ff00a67d</color><width>3</width></LineStyle><PolyStyle><color>4000a67d</color></PolyStyle></Style>
<Style id="vertex"><IconStyle><Icon><href>http://maps.google.com/mapfiles/kml/shapes/placemark_circle.png</href></Icon><scale>0.7</scale><color>ff0000ff</color></IconStyle></Style>
<Style id="lot"><LineStyle><color>ff00ffff</color><width>2</width></LineStyle><PolyStyle><color>3000ffff</color></PolyStyle></Style>
<Folder><n>Parcela</n>
<Placemark>
<n>${r.meta.title}</n>
<description><![CDATA[${r.meta.title}
Propietario: ${r.meta.owner}
Ubicacin: ${r.meta.location}
Catastro: ${r.meta.catastro}
rea: ${(r.area/10000).toFixed(4)} Ha (${r.area.toFixed(2)} m)
Permetro: ${r.perimeter.toFixed(2)} m
Vrtices: ${r.numVertices}
Zona UTM: ${r.zone}
Escala: 1:${r.meta.scale}

COORDENADAS UTM:
${vertDesc}

LADOS:
${edgeDesc}

Profesional: ${r.meta.prof} - ${r.meta.civ}
Fecha: ${r.meta.date}]]></description>
<styleUrl>#parcel</styleUrl>
<Polygon><outerBoundaryIs><LinearRing><coordinates>${kmlCoords}</coordinates></LinearRing></outerBoundaryIs></Polygon>
</Placemark>
</Folder>
<Folder><n>Vrtices</n>\n`;
            r.vertices.forEach(v => {
                kml += `<Placemark><n>V${v.n}</n><description>Lat: ${v.lat.toFixed(6)} Lon: ${v.lon.toFixed(6)}
UTM: E${v.utmE.toFixed(2)} N${v.utmN.toFixed(2)}</description><styleUrl>#vertex</styleUrl>
<Point><coordinates>${v.lon},${v.lat},0</coordinates></Point></Placemark>\n`;
            });
            kml += `</Folder>\n`;
            if (r.lotsInfo.length > 0) {
                kml += `<Folder><n>Lotes (${r.lotsInfo.length})</n>\n`;
                State.blocks.forEach((b, i) => {
                    const lc = b.geo.geometry.coordinates[0].map(c => `${c[0]},${c[1]},0`).join(' ');
                    const l = r.lotsInfo[i];
                    kml += `<Placemark><n>Lote ${b.id}</n><description>rea: ${(l.area/10000).toFixed(4)} Ha
Permetro: ${l.perim.toFixed(2)} m</description><styleUrl>#lot</styleUrl>
<Polygon><outerBoundaryIs><LinearRing><coordinates>${lc}</coordinates></LinearRing></outerBoundaryIs></Polygon></Placemark>\n`;
                });
                kml += `</Folder>\n`;
            }
            kml += `</Document>\n</kml>`;
            download(kml, `plano_topo_${Date.now()}.kml`, 'application/vnd.google-earth.kml+xml');
            Toast.show('KML exportado', 'success');
        },
        // ========== EXPORTAR GeoJSON ==========
        exportGeoJSON() {
            if (!this.results) return Toast.show('Calcula primero', 'error');
            const r = this.results;
            const features = [{
                type: 'Feature',
                properties: {
                    type: 'parcela', title: r.meta.title, owner: r.meta.owner,
                    location: r.meta.location, catastro: r.meta.catastro,
                    area_m2: r.area, area_ha: r.area / 10000, perimeter_m: r.perimeter,
                    num_vertices: r.numVertices, utm_zone: r.zone,
                    scale: '1:' + r.meta.scale, prof: r.meta.prof, civ: r.meta.civ,
                    vertices: r.vertices.map(v => ({ n: v.n, E: v.utmE, N: v.utmN })),
                    edges: r.edges.map(e => ({ side: `${e.from}-${e.to}`, dist_m: e.dist, az: e.az, rumbo: e.rumbo }))
                },
                geometry: State.polygon ? State.polygon.geometry : State.blocks[0].geo.geometry
            }];
            r.vertices.forEach(v => {
                features.push({
                    type: 'Feature',
                    properties: { type: 'vertex', n: v.n, utmE: v.utmE, utmN: v.utmN },
                    geometry: { type: 'Point', coordinates: [v.lon, v.lat] }
                });
            });
            if (r.lotsInfo.length > 0) {
                State.blocks.forEach((b, i) => {
                    const l = r.lotsInfo[i];
                    features.push({
                        type: 'Feature',
                        properties: { type: 'lote', id: b.id, area_m2: l.area, area_ha: l.area / 10000, perimeter_m: l.perim },
                        geometry: b.geo.geometry
                    });
                });
            }
            const geojson = {
                type: 'FeatureCollection', name: r.meta.title,
                crs: { type: 'name', properties: { name: 'urn:ogc:def:crs:OGC:1.3:CRS84' } },
                properties: { software: 'WIN-TEL GEOMATICS PRO v30', date: r.meta.dateISO },
                features
            };
            download(JSON.stringify(geojson, null, 2), `plano_topo_${Date.now()}.geojson`, 'application/json');
            Toast.show('GeoJSON exportado', 'success');
        },
        // ========== EXPORTAR DXF ==========
        exportDXF() {
            if (!this.results) return Toast.show('Calcula primero', 'error');
            const r = this.results;
            let dxf = `0\nSECTION\n2\nHEADER\n9\n$ACADVER\n1\nAC1014\n9\n$INSUNITS\n70\n6\n0\nENDSEC\n0\nSECTION\n2\nTABLES\n0\nTABLE\n2\nLAYER\n70\n4\n`;
            dxf += `0\nLAYER\n2\nPARCELA\n70\n0\n62\n3\n6\nCONTINUOUS\n`;
            dxf += `0\nLAYER\n2\nVERTICES\n70\n0\n62\n1\n6\nCONTINUOUS\n`;
            dxf += `0\nLAYER\n2\nETIQUETAS\n70\n0\n62\n7\n6\nCONTINUOUS\n`;
            dxf += `0\nLAYER\n2\nLOTES\n70\n0\n62\n5\n6\nCONTINUOUS\n`;
            dxf += `0\nENDTAB\n0\nENDSEC\n0\nSECTION\n2\nENTITIES\n`;
            // Parcela polyline in UTM
            dxf += `0\nPOLYLINE\n8\nPARCELA\n66\n1\n70\n1\n`;
            r.vertices.forEach(v => {
                dxf += `0\nVERTEX\n8\nPARCELA\n10\n${v.utmE.toFixed(3)}\n20\n${v.utmN.toFixed(3)}\n30\n0\n`;
            });
            // Close polyline
            dxf += `0\nVERTEX\n8\nPARCELA\n10\n${r.vertices[0].utmE.toFixed(3)}\n20\n${r.vertices[0].utmN.toFixed(3)}\n30\n0\n`;
            dxf += `0\nSEQEND\n8\nPARCELA\n`;
            // Vertex points + labels
            r.vertices.forEach(v => {
                dxf += `0\nPOINT\n8\nVERTICES\n10\n${v.utmE.toFixed(3)}\n20\n${v.utmN.toFixed(3)}\n30\n0\n`;
                dxf += `0\nTEXT\n8\nETIQUETAS\n10\n${(v.utmE + 2).toFixed(3)}\n20\n${(v.utmN + 2).toFixed(3)}\n30\n0\n40\n2\n1\nV${v.n}\n`;
            });
            // Edge distance labels
            r.edges.forEach((e, i) => {
                const v1 = r.vertices[e.from - 1], v2 = r.vertices[(e.to - 1) % r.vertices.length];
                if (v1 && v2) {
                    const mx = (v1.utmE + v2.utmE) / 2, my = (v1.utmN + v2.utmN) / 2;
                    dxf += `0\nTEXT\n8\nETIQUETAS\n10\n${mx.toFixed(3)}\n20\n${my.toFixed(3)}\n30\n0\n40\n1.5\n1\n${e.dist.toFixed(2)}m\n`;
                }
            });
            // Lots
            if (r.lotsInfo.length > 0) {
                State.blocks.forEach((b, i) => {
                    const lCoords = b.geo.geometry.coordinates[0];
                    const lZone = UTM.getZone(lCoords[0][0]);
                    dxf += `0\nPOLYLINE\n8\nLOTES\n66\n1\n70\n1\n`;
                    lCoords.forEach(c => {
                        const utm = UTM.fromLatLon(c[0], c[1], lZone);
                        dxf += `0\nVERTEX\n8\nLOTES\n10\n${utm[0].toFixed(3)}\n20\n${utm[1].toFixed(3)}\n30\n0\n`;
                    });
                    dxf += `0\nSEQEND\n8\nLOTES\n`;
                });
            }
            dxf += `0\nENDSEC\n0\nEOF`;
            download(dxf, `plano_topo_${Date.now()}.dxf`, 'application/dxf');
            Toast.show('DXF exportado (UTM)', 'success');
        },
        // ========== EXPORTAR CSV ==========
        exportCSV() {
            if (!this.results) return Toast.show('Calcula primero', 'error');
            const r = this.results;
            let csv = `PLANO TOPOGRFICO - WIN-TEL GEOMATICS PRO v30\n`;
            csv += `Ttulo,${r.meta.title}\nPropietario,${r.meta.owner}\nUbicacin,${r.meta.location}\n`;
            csv += `Catastro,${r.meta.catastro}\nFecha,${r.meta.date}\n`;
            csv += `Profesional,${r.meta.prof}\nColegiatura,${r.meta.civ}\n`;
            csv += `Escala,1:${r.meta.scale}\nFormato,${r.meta.format}\n\n`;
            csv += `RESUMEN\nrea (Ha),${(r.area/10000).toFixed(4)}\nrea (m),${r.area.toFixed(2)}\n`;
            csv += `Permetro (m),${r.perimeter.toFixed(2)}\nVrtices,${r.numVertices}\n`;
            csv += `Zona UTM,${r.zone}\n`;
            csv += `Ancho aprox (m),${r.widthM.toFixed(1)}\nAlto aprox (m),${r.heightM.toFixed(1)}\n`;
            csv += `Centroide UTM E,${r.centroidUTM[0].toFixed(2)}\nCentroide UTM N,${r.centroidUTM[1].toFixed(2)}\n\n`;
            csv += `COORDENADAS UTM\nVrtice,Latitud,Longitud,UTM_Este,UTM_Norte\n`;
            r.vertices.forEach(v => {
                csv += `${v.n},${v.lat.toFixed(6)},${v.lon.toFixed(6)},${v.utmE.toFixed(2)},${v.utmN.toFixed(2)}\n`;
            });
            csv += `\nLADOS - DISTANCIAS Y RUMBOS\nLado,Distancia_m,Azimut_deg,Rumbo\n`;
            r.edges.forEach(e => {
                csv += `${e.from}-${e.to},${e.dist.toFixed(2)},${e.az.toFixed(2)},${e.rumbo}\n`;
            });
            if (r.lotsInfo.length > 0) {
                csv += `\nSUBDIVISIONES (${r.lotsInfo.length} lotes)\nLote,rea_Ha,rea_m2,Permetro_m,Vrtices\n`;
                r.lotsInfo.forEach(l => {
                    csv += `${l.id},${(l.area/10000).toFixed(4)},${l.area.toFixed(2)},${l.perim.toFixed(2)},${l.verts.length}\n`;
                });
                csv += `\nDETALLE LOTES - COORDENADAS UTM\n`;
                r.lotsInfo.forEach(l => {
                    csv += `\nLOTE ${l.id}\nVrtice,UTM_Este,UTM_Norte\n`;
                    l.verts.forEach(v => { csv += `${v.n},${v.utmE.toFixed(2)},${v.utmN.toFixed(2)}\n`; });
                });
            }
            download(csv, `plano_topo_${Date.now()}.csv`, 'text/csv');
            Toast.show('CSV exportado', 'success');
        },
        // ========== EXPORTAR GPX ==========
        exportGPX() {
            if (!this.results) return Toast.show('Calcula primero', 'error');
            const r = this.results;
            let gpx = `<?xml version="1.0" encoding="UTF-8"?>
<gpx version="1.1" creator="WIN-TEL GEOMATICS PRO v30" xmlns="http://www.topografix.com/GPX/1/1">
<metadata>
    <n>${r.meta.title}</n>
    <desc>Propietario: ${r.meta.owner} | rea: ${(r.area/10000).toFixed(4)} Ha</desc>
    <time>${r.meta.dateISO}</time>
</metadata>\n`;
            r.vertices.forEach(v => {
                gpx += `<wpt lat="${v.lat.toFixed(8)}" lon="${v.lon.toFixed(8)}">
    <n>V${v.n}</n>
    <desc>UTM: E${v.utmE.toFixed(2)} N${v.utmN.toFixed(2)}</desc>
    <sym>Flag, Blue</sym>
</wpt>\n`;
            });
            gpx += `<trk><n>Permetro</n><trkseg>\n`;
            r.coords.forEach(c => { gpx += `    <trkpt lat="${c[1].toFixed(8)}" lon="${c[0].toFixed(8)}"></trkpt>\n`; });
            gpx += `</trkseg></trk>\n</gpx>`;
            download(gpx, `plano_topo_${Date.now()}.gpx`, 'application/gpx+xml');
            Toast.show('GPX exportado', 'success');
        },
        // ========== EXPORTAR PDF (Plano Profesional) ==========
        exportPDF() {
            if (!this.results) return Toast.show('Calcula primero', 'error');
            if (typeof jspdf === 'undefined') return Toast.show('PDF no disponible', 'error');
            const r = this.results;
            const { jsPDF } = jspdf;
            const format = r.meta.format;
            const doc = new jsPDF({ orientation: 'landscape', unit: 'mm', format });
            const W = doc.internal.pageSize.getWidth();
            const H = doc.internal.pageSize.getHeight();
            // ===== PAGE 1: PLANO CON DIBUJO =====
            // Marcos
            doc.setDrawColor(0); doc.setLineWidth(0.8); doc.rect(10, 10, W - 20, H - 20);
            doc.setLineWidth(0.3); doc.rect(15, 15, W - 30, H - 70);
            // Cajetn profesional
            const cajY = H - 52;
            doc.setLineWidth(0.5); doc.rect(15, cajY, W - 30, 42);
            doc.setLineWidth(0.3);
            doc.line(15, cajY + 10, W - 15, cajY + 10);
            doc.line(15, cajY + 20, W - 15, cajY + 20);
            doc.line(15, cajY + 30, W - 15, cajY + 30);
            doc.line(W - 100, cajY, W - 100, cajY + 42);
            doc.line(W - 50, cajY + 10, W - 50, cajY + 42);
            // Cajetn contenido
            doc.setFontSize(12); doc.setFont('helvetica', 'bold');
            doc.text(r.meta.title, (W - 100) / 2 + 15, cajY + 7, { align: 'center' });
            doc.setFontSize(9); doc.setFont('helvetica', 'normal');
            doc.text(`PROPIETARIO: ${r.meta.owner}`, 20, cajY + 17);
            doc.text(`UBICACIN: ${r.meta.location}`, 20, cajY + 27);
            doc.text(`PROFESIONAL: ${r.meta.prof}  |  ${r.meta.civ}`, 20, cajY + 37);
            if (r.meta.catastro) doc.text(`CATASTRO: ${r.meta.catastro}`, 20, cajY + 41);
            doc.setFontSize(9);
            doc.text(`ESCALA`, W - 97, cajY + 7); doc.setFont('helvetica', 'bold');
            doc.text(`1:${r.meta.scale}`, W - 97, cajY + 14);
            doc.setFont('helvetica', 'normal');
            doc.text(`FECHA`, W - 97, cajY + 24); doc.setFont('helvetica', 'bold');
            doc.text(r.meta.date, W - 97, cajY + 31);
            doc.setFont('helvetica', 'normal');
            doc.text(`REA`, W - 47, cajY + 17); doc.setFont('helvetica', 'bold');
            doc.text(`${(r.area / 10000).toFixed(4)} Ha`, W - 47, cajY + 24);
            doc.setFont('helvetica', 'normal');
            doc.text(`FORMATO: ${format}`, W - 97, cajY + 40);
            doc.setFontSize(8); doc.text('WIN-TEL GEOMATICS PRO v30', W - 47, cajY + 40);
            // Norte
            doc.setFillColor(0); doc.triangle(W - 35, 22, W - 40, 37, W - 30, 37, 'F');
            doc.setFontSize(10); doc.setFont('helvetica', 'bold');
            doc.text('N', W - 35, 19, { align: 'center' });
            // Dibujo del polgono
            const target = State.polygon || State.blocks[0]?.geo;
            if (target) {
                const coords = target.geometry.coordinates[0];
                const bbox = turf.bbox(target);
                const drawAreaW = W - 160, drawAreaH = cajY - 25;
                const scaleX = drawAreaW / ((bbox[2] - bbox[0]) * 111320);
                const scaleY = drawAreaH / ((bbox[3] - bbox[1]) * 110540);
                const drawScale = Math.min(scaleX, scaleY) * 0.80;
                const cx = 25 + drawAreaW / 2, cy = 20 + drawAreaH / 2;
                const gcx = (bbox[0] + bbox[2]) / 2, gcy = (bbox[1] + bbox[3]) / 2;
                const pts = coords.map(c => [
                    cx + (c[0] - gcx) * 111320 * drawScale,
                    cy - (c[1] - gcy) * 110540 * drawScale
                ]);
                // Fill polygon
                doc.setFillColor(230, 255, 230); doc.setDrawColor(0, 120, 60); doc.setLineWidth(0.6);
                const xArr = pts.map(p => p[0]), yArr = pts.map(p => p[1]);
                doc.lines(pts.slice(1).map((p, i) => [p[0] - pts[i][0], p[1] - pts[i][1]]), pts[0][0], pts[0][1], [1, 1], 'DF');
                // Vertex markers + labels
                doc.setFont('helvetica', 'bold');
                for (let i = 0; i < pts.length - 1; i++) {
                    doc.setFillColor(255, 0, 0); doc.circle(pts[i][0], pts[i][1], 1.5, 'F');
                    doc.setFontSize(7); doc.setTextColor(200, 0, 0);
                    doc.text(`V${i + 1}`, pts[i][0] + 3, pts[i][1] - 2);
                }
                // Edge distance labels
                doc.setTextColor(0, 0, 150); doc.setFontSize(6); doc.setFont('helvetica', 'normal');
                for (let i = 0; i < pts.length - 1; i++) {
                    const nx = i + 1 < pts.length - 1 ? i + 1 : 0;
                    const mx = (pts[i][0] + pts[nx][0]) / 2, my = (pts[i][1] + pts[nx][1]) / 2;
                    if (r.edges[i]) doc.text(`${r.edges[i].dist.toFixed(2)}m`, mx + 1, my - 1);
                }
                doc.setTextColor(0);
                // Lots drawing
                if (State.blocks.length > 0) {
                    doc.setDrawColor(100, 100, 255); doc.setLineWidth(0.3);
                    State.blocks.forEach(b => {
                        const lc = b.geo.geometry.coordinates[0].map(c => [
                            cx + (c[0] - gcx) * 111320 * drawScale,
                            cy - (c[1] - gcy) * 110540 * drawScale
                        ]);
                        for (let i = 0; i < lc.length - 1; i++) doc.line(lc[i][0], lc[i][1], lc[i + 1][0], lc[i + 1][1]);
                    });
                }
            }
            // Coordinate table in page 1 right side
            let ty = 20;
            doc.setFontSize(8); doc.setFont('helvetica', 'bold'); doc.setTextColor(0);
            doc.text('COORDENADAS UTM', W - 115, ty); ty += 3;
            doc.text(`Zona: ${r.zone}`, W - 115, ty + 3); ty += 7;
            doc.setFontSize(6); doc.setFont('helvetica', 'bold');
            doc.text('V', W - 115, ty); doc.text('ESTE', W - 105, ty); doc.text('NORTE', W - 85, ty); ty += 4;
            doc.setFont('helvetica', 'normal');
            const maxVerts = Math.min(r.vertices.length, Math.floor((cajY - 50) / 4));
            for (let i = 0; i < maxVerts; i++) {
                const v = r.vertices[i];
                doc.text(`${v.n}`, W - 115, ty);
                doc.text(`${v.utmE.toFixed(2)}`, W - 105, ty);
                doc.text(`${v.utmN.toFixed(2)}`, W - 85, ty);
                ty += 4;
            }
            if (r.vertices.length > maxVerts) {
                doc.text(`... +${r.vertices.length - maxVerts} ms`, W - 115, ty); ty += 6;
            } else ty += 4;
            doc.setFont('helvetica', 'bold'); doc.text(`REA: ${(r.area / 10000).toFixed(4)} Ha`, W - 115, ty); ty += 4;
            doc.text(`PER: ${r.perimeter.toFixed(2)} m`, W - 115, ty);
            // ===== PAGE 2: TABLAS COMPLETAS =====
            doc.addPage(format, 'portrait');
            const W2 = doc.internal.pageSize.getWidth();
            let py = 15;
            doc.setFontSize(14); doc.setTextColor(139, 92, 246); doc.setFont('helvetica', 'bold');
            doc.text('INFORME TOPOGRFICO', W2 / 2, py, { align: 'center' }); py += 6;
            doc.setFontSize(10); doc.setTextColor(100); doc.setFont('helvetica', 'normal');
            doc.text(r.meta.title, W2 / 2, py, { align: 'center' }); py += 5;
            doc.text(`${r.meta.date} - WIN-TEL GEOMATICS PRO v30`, W2 / 2, py, { align: 'center' }); py += 8;
            doc.setDrawColor(139, 92, 246); doc.setLineWidth(0.5); doc.line(15, py, W2 - 15, py); py += 8;
            // General data
            doc.setFontSize(11); doc.setTextColor(0); doc.setFont('helvetica', 'bold');
            doc.text('DATOS GENERALES', 15, py); py += 6;
            doc.setFontSize(9); doc.setFont('helvetica', 'normal');
            const genData = [
                `Propietario: ${r.meta.owner}`, `Ubicacin: ${r.meta.location}`,
                `Catastro: ${r.meta.catastro}`, `Profesional: ${r.meta.prof} - ${r.meta.civ}`,
                `rea: ${(r.area / 10000).toFixed(4)} Ha (${r.area.toFixed(2)} m)`,
                `Permetro: ${r.perimeter.toFixed(2)} m`, `Vrtices: ${r.numVertices}`,
                `Zona UTM: ${r.zone}`, `Dimensiones aprox: ${r.widthM.toFixed(1)}  ${r.heightM.toFixed(1)} m`,
                `Centroide UTM: E${r.centroidUTM[0].toFixed(2)} N${r.centroidUTM[1].toFixed(2)}`
            ].filter(d => !d.endsWith(': '));
            genData.forEach(d => { doc.text(d, 20, py); py += 5; }); py += 4;
            // UTM coordinate table
            doc.setFontSize(11); doc.setFont('helvetica', 'bold');
            doc.text('CUADRO DE COORDENADAS UTM', 15, py); py += 6;
            doc.setFontSize(8); doc.setFont('helvetica', 'bold');
            doc.text('VRTICE', 18, py); doc.text('LATITUD', 42, py); doc.text('LONGITUD', 72, py);
            doc.text('UTM ESTE', 105, py); doc.text('UTM NORTE', 140, py); py += 1;
            doc.setLineWidth(0.2); doc.line(15, py, W2 - 15, py); py += 4;
            doc.setFont('helvetica', 'normal');
            r.vertices.forEach(v => {
                if (py > (format === 'A3' ? 400 : 270)) { doc.addPage(format, 'portrait'); py = 20; }
                doc.text(`V${v.n}`, 22, py); doc.text(v.lat.toFixed(6), 42, py);
                doc.text(v.lon.toFixed(6), 72, py); doc.text(v.utmE.toFixed(2), 105, py);
                doc.text(v.utmN.toFixed(2), 140, py); py += 4.5;
            }); py += 6;
            // Sides table
            if (py > (format === 'A3' ? 380 : 250)) { doc.addPage(format, 'portrait'); py = 20; }
            doc.setFontSize(11); doc.setFont('helvetica', 'bold');
            doc.text('CUADRO DE DISTANCIAS Y RUMBOS', 15, py); py += 6;
            doc.setFontSize(8); doc.setFont('helvetica', 'bold');
            doc.text('LADO', 18, py); doc.text('DISTANCIA (m)', 42, py);
            doc.text('AZIMUT', 85, py); doc.text('RUMBO', 115, py); py += 1;
            doc.line(15, py, W2 - 15, py); py += 4;
            doc.setFont('helvetica', 'normal');
            r.edges.forEach(e => {
                if (py > (format === 'A3' ? 400 : 270)) { doc.addPage(format, 'portrait'); py = 20; }
                doc.text(`${e.from} - ${e.to}`, 22, py); doc.text(e.dist.toFixed(2), 50, py);
                doc.text(`${e.az.toFixed(2)}`, 88, py); doc.text(e.rumbo, 115, py); py += 4.5;
            }); py += 4;
            doc.setFont('helvetica', 'bold');
            doc.text(`PERMETRO TOTAL: ${r.perimeter.toFixed(2)} m`, 20, py); py += 8;
            // Lots detail
            if (r.lotsInfo.length > 0) {
                if (py > (format === 'A3' ? 370 : 240)) { doc.addPage(format, 'portrait'); py = 20; }
                doc.setFontSize(11); doc.setFont('helvetica', 'bold');
                doc.text(`SUBDIVISIONES (${r.lotsInfo.length} lotes)`, 15, py); py += 6;
                doc.setFontSize(8); doc.setFont('helvetica', 'bold');
                doc.text('LOTE', 18, py); doc.text('REA (Ha)', 42, py);
                doc.text('REA (m)', 72, py); doc.text('PERMETRO', 105, py);
                doc.text('VRTICES', 140, py); py += 1;
                doc.line(15, py, W2 - 15, py); py += 4;
                doc.setFont('helvetica', 'normal');
                r.lotsInfo.forEach(l => {
                    if (py > (format === 'A3' ? 400 : 270)) { doc.addPage(format, 'portrait'); py = 20; }
                    doc.text(`${l.id}`, 22, py); doc.text(`${(l.area / 10000).toFixed(4)}`, 45, py);
                    doc.text(`${l.area.toFixed(2)}`, 72, py); doc.text(`${l.perim.toFixed(2)} m`, 105, py);
                    doc.text(`${l.verts.length}`, 145, py); py += 4.5;
                });
            }
            // Footer
            doc.setFontSize(7); doc.setTextColor(150);
            doc.text('Generado por WIN-TEL GEOMATICS PRO v30 - WindowsTelecom C.A.', W2 / 2, doc.internal.pageSize.getHeight() - 8, { align: 'center' });
            doc.save(`plano_topo_${Date.now()}.pdf`);
            Toast.show('Plano PDF generado (2 pginas)', 'success');
        },
        // ========== EXPORTAR TXT ==========
        exportTXT() {
            if (!this.results) return Toast.show('Calcula primero', 'error');
            const r = this.results;
            let txt = `
          INFORME TOPOGRFICO PROFESIONAL                    
          WIN-TEL GEOMATICS PRO v30                          


Ttulo: ${r.meta.title}
Fecha: ${r.meta.date}


                    DATOS GENERALES


Propietario ................ ${r.meta.owner}
Ubicacin .................. ${r.meta.location}
Catastro/Expediente ........ ${r.meta.catastro}
Profesional ................ ${r.meta.prof}
Colegiatura ................ ${r.meta.civ}
Escala ..................... 1:${r.meta.scale}
Formato .................... ${r.meta.format}


                   RESUMEN TOPOGRFICO


rea total ................. ${(r.area/10000).toFixed(4)} Ha (${r.area.toFixed(2)} m)
Permetro .................. ${r.perimeter.toFixed(2)} m
Vrtices ................... ${r.numVertices}
Zona UTM ................... ${r.zone}
Dimensiones aprox .......... ${r.widthM.toFixed(1)}  ${r.heightM.toFixed(1)} m
Centroide UTM .............. E ${r.centroidUTM[0].toFixed(2)} N ${r.centroidUTM[1].toFixed(2)}


              CUADRO DE COORDENADAS UTM


${'VRT'.padEnd(6)}${'LATITUD'.padEnd(14)}${'LONGITUD'.padEnd(14)}${'UTM ESTE'.padEnd(14)}${'UTM NORTE'.padEnd(14)}
${''.repeat(62)}
${r.vertices.map(v => `V${v.n}`.padEnd(6) + v.lat.toFixed(6).padEnd(14) + v.lon.toFixed(6).padEnd(14) + v.utmE.toFixed(2).padEnd(14) + v.utmN.toFixed(2).padEnd(14)).join('\n')}


             CUADRO DE DISTANCIAS Y RUMBOS


${'LADO'.padEnd(8)}${'DISTANCIA'.padEnd(14)}${'AZIMUT'.padEnd(12)}${'RUMBO'.padEnd(20)}
${''.repeat(54)}
${r.edges.map(e => `${e.from}-${e.to}`.padEnd(8) + `${e.dist.toFixed(2)} m`.padEnd(14) + `${e.az.toFixed(2)}`.padEnd(12) + e.rumbo.padEnd(20)).join('\n')}
${''.repeat(54)}
${'TOTAL'.padEnd(8)}${r.perimeter.toFixed(2)} m
`;
            if (r.lotsInfo.length > 0) {
                txt += `\n
              SUBDIVISIONES (${r.lotsInfo.length} lotes)


${'LOTE'.padEnd(6)}${'REA Ha'.padEnd(14)}${'REA m'.padEnd(14)}${'PERMETRO'.padEnd(14)}${'VRTICES'.padEnd(10)}
${''.repeat(58)}
${r.lotsInfo.map(l => `${l.id}`.padEnd(6) + `${(l.area/10000).toFixed(4)}`.padEnd(14) + `${l.area.toFixed(2)}`.padEnd(14) + `${l.perim.toFixed(2)} m`.padEnd(14) + `${l.verts.length}`.padEnd(10)).join('\n')}
`;
            }
            if (r.meta.obs) txt += `\nOBSERVACIONES: ${r.meta.obs}\n`;
            txt += `

         Generado por WIN-TEL GEOMATICS PRO v30
                  WindowsTelecom C.A.
               Valencia, Carabobo, Venezuela

`;
            download(txt, `informe_topo_${Date.now()}.txt`, 'text/plain');
            Toast.show('Informe TXT exportado', 'success');
        },
        // ========== COPIAR AL PORTAPAPELES ==========
        copyToClipboard() {
            if (!this.results) return Toast.show('Calcula primero', 'error');
            const r = this.results;
            let text = `${r.meta.title}\n`;
            text += `Propietario: ${r.meta.owner} | Ubicacin: ${r.meta.location}\n`;
            text += `rea: ${(r.area / 10000).toFixed(4)} Ha | Permetro: ${r.perimeter.toFixed(2)} m\n`;
            text += `Vrtices: ${r.numVertices} | Zona UTM: ${r.zone}\n\n`;
            text += `COORDENADAS UTM:\n`;
            r.vertices.forEach(v => { text += `V${v.n}: E${v.utmE.toFixed(2)} N${v.utmN.toFixed(2)}\n`; });
            text += `\nLADOS:\n`;
            r.edges.forEach(e => { text += `${e.from}-${e.to}: ${e.dist.toFixed(2)}m | Az:${e.az.toFixed(2)} | ${e.rumbo}\n`; });
            if (r.lotsInfo.length > 0) {
                text += `\nLOTES: ${r.lotsInfo.length}\n`;
                r.lotsInfo.forEach(l => { text += `Lote ${l.id}: ${(l.area / 10000).toFixed(4)} Ha\n`; });
            }
            navigator.clipboard.writeText(text).then(() => {
                Toast.show('Copiado al portapapeles', 'success');
            }).catch(() => { Toast.show('Error al copiar', 'error'); });
        }
    };

    // ========== MDULO 3: CALCULADORA MOVIMIENTO DE TIERRAS ==========
    const EarthworkCalc = {
        panel: null, layer: null, results: null, gridPoints: [],
        // Tipos de suelo con propiedades geotcnicas
        soilTypes: [
            { id: 'vegetal', name: 'Capa vegetal', swell: 1.15, compact: 0.95, weight: 1.4, color: '#22c55e' },
            { id: 'arena', name: 'Arena', swell: 1.12, compact: 0.95, weight: 1.6, color: '#fbbf24' },
            { id: 'tierra', name: 'Tierra comn', swell: 1.25, compact: 0.90, weight: 1.7, color: '#f59e0b' },
            { id: 'arcilla', name: 'Arcilla', swell: 1.35, compact: 0.85, weight: 1.9, color: '#d97706' },
            { id: 'grava', name: 'Grava', swell: 1.18, compact: 0.92, weight: 2.0, color: '#a16207' },
            { id: 'roca_blanda', name: 'Roca blanda', swell: 1.50, compact: 0.88, weight: 2.2, color: '#78716c' },
            { id: 'roca_dura', name: 'Roca dura', swell: 1.65, compact: 0.85, weight: 2.6, color: '#57534e' }
        ],
        togglePanel() {
            if (this.panel) { this.panel.remove(); this.panel = null; return; }
            const soilOpts = this.soilTypes.map((s, i) => `<option value="${i}" ${s.id==='tierra'?'selected':''}>${s.name} (Fe=${s.swell})</option>`).join('');
            const html = `<div id="earthwork-panel" class="float-panel" style="top:80px;right:60px;width:360px;max-height:90vh;overflow-y:auto;">
                <div class="panel-hdr" style="background:linear-gradient(135deg,rgba(245,158,11,0.3),rgba(217,119,6,0.2));">
                    <div class="panel-title"><i class="fa-solid fa-truck-moving" style="color:#f59e0b;"></i> Movimiento de Tierras</div>
                    <button class="panel-close" onclick="EarthworkCalc.togglePanel()"><i class="fa-solid fa-times"></i></button>
                </div>
                <div class="panel-body">
                    <div style="background:rgba(245,158,11,0.15);border:1px solid #f59e0b;border-radius:6px;padding:10px;margin-bottom:12px;">
                        <div style="font-size:10px;color:#f59e0b;font-weight:700;"> CORTE Y RELLENO PROFESIONAL</div>
                        <div style="font-size:9px;color:var(--text-3);margin-top:3px;">Volmenes con elevacin real, esponjamiento, compactacin y costos</div>
                    </div>
                    <div class="form-group"><label class="form-label">Nivel de Proyecto (m)</label>
                        <input type="number" id="ew-level" class="form-input" placeholder="Vaco = promedio del terreno" step="0.01">
                    </div>
                    <div class="form-group"><label class="form-label">Tipo de suelo</label>
                        <select id="ew-soil" class="form-input" onchange="EarthworkCalc.updateSoilInfo()">${soilOpts}</select>
                    </div>
                    <div id="ew-soil-info" style="font-size:9px;color:var(--text-3);padding:4px 8px;margin:-6px 0 8px;"></div>
                    <div class="form-group"><label class="form-label">Resolucin de anlisis</label>
                        <select id="ew-resolution" class="form-input">
                            <option value="5">Muy Alta (5m) - lento</option>
                            <option value="10" selected>Alta (10m)</option>
                            <option value="20">Media (20m) - rpido</option>
                            <option value="30">Baja (30m) - muy rpido</option>
                        </select>
                    </div>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
                        <div class="form-group"><label class="form-label">$/m Corte</label>
                            <input type="number" id="ew-cost-cut" class="form-input" value="15" step="1">
                        </div>
                        <div class="form-group"><label class="form-label">$/m Relleno</label>
                            <input type="number" id="ew-cost-fill" class="form-input" value="20" step="1">
                        </div>
                    </div>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
                        <div class="form-group"><label class="form-label">$/m Transporte</label>
                            <input type="number" id="ew-cost-haul" class="form-input" value="8" step="1">
                        </div>
                        <div class="form-group"><label class="form-label">Dist. botadero (km)</label>
                            <input type="number" id="ew-haul-dist" class="form-input" value="5" step="0.5" min="0">
                        </div>
                    </div>
                    <button class="btn" onclick="EarthworkCalc.calculate()" style="background:linear-gradient(135deg,#f59e0b,#d97706);">
                        <i class="fa-solid fa-calculator"></i> CALCULAR
                    </button>
                    <button class="btn btn-2" onclick="EarthworkCalc.findOptimal()" style="margin-top:6px;">
                        <i class="fa-solid fa-magic"></i> Nivel ptimo (Balance=0)
                    </button>
                    <button class="btn btn-2" onclick="EarthworkCalc.clear()" style="margin-top:4px;">
                        <i class="fa-solid fa-eraser"></i> Limpiar
                    </button>
                    <div id="ew-results" style="display:none;margin-top:12px;"></div>
                </div>
            </div>`;
            document.body.insertAdjacentHTML('beforeend', html);
            this.panel = document.getElementById('earthwork-panel');
            this.updateSoilInfo();
        },
        updateSoilInfo() {
            const idx = parseInt($('ew-soil')?.value) || 0;
            const s = this.soilTypes[idx];
            const info = $('ew-soil-info');
            if (info && s) info.innerHTML = `<span style="display:inline-block;width:8px;height:8px;background:${s.color};border-radius:2px;"></span> Esponj: <b>${s.swell}</b> | Compact: <b>${s.compact}</b> | Peso: <b>${s.weight} t/m</b>`;
        },
        async getGridElevations() {
            if (!State.polygon) throw new Error('No hay polgono');
            const resolution = parseInt($('ew-resolution')?.value) || 10;
            const bbox = turf.bbox(State.polygon);
            const cellSize = resolution / 111320;
            const points = [];
            for (let lat = bbox[1]; lat <= bbox[3]; lat += cellSize) {
                for (let lng = bbox[0]; lng <= bbox[2]; lng += cellSize) {
                    if (turf.booleanPointInPolygon(turf.point([lng, lat]), State.polygon)) {
                        points.push({ lat, lng, elev: 0 });
                    }
                }
            }
            if (points.length === 0) throw new Error('Polgono muy pequeo');
            // Use ElevationService
            Toast.show(`Obteniendo elevacin de ${points.length} puntos...`, 'info');
            if (typeof ElevationService !== 'undefined') {
                try {
                    const batchSize = 100;
                    for (let i = 0; i < points.length; i += batchSize) {
                        const batch = points.slice(i, i + batchSize);
                        const elevs = await ElevationService.getElevationBatch(batch.map(p => ({ lat: p.lat, lng: p.lng })));
                        elevs.forEach((elev, idx) => { if (batch[idx]) batch[idx].elev = elev || 0; });
                    }
                } catch (e) {
                    console.warn('ElevationService error, using fallback:', e);
                    const center = turf.centroid(State.polygon).geometry.coordinates;
                    points.forEach(p => {
                        p.elev = ElevationService.generateRealisticElevation(p.lat, p.lng);
                    });
                }
            } else {
                // Fallback determinstico basado en posicin
                points.forEach(p => {
                    const base = 150;
                    p.elev = base + Math.sin(p.lat * 800) * 50 + Math.cos(p.lng * 800) * 40 + Math.sin((p.lat + p.lng) * 300) * 25;
                });
            }
            return { points, cellSize, resolution };
        },
        async calculate() {
            if (!State.polygon) return Toast.show('Dibuja un polgono primero', 'error');
            Loading.show();
            try {
                const { points, cellSize, resolution } = await this.getGridElevations();
                this.gridPoints = points;
                const areaM2 = turf.area(State.polygon);
                const areaHa = areaM2 / 10000;
                const cellAreaM2 = resolution * resolution; // rea de cada celda en m
                const soilIdx = parseInt($('ew-soil')?.value) || 2;
                const soil = this.soilTypes[soilIdx];
                const elevs = points.map(p => p.elev);
                const minE = Math.min(...elevs), maxE = Math.max(...elevs);
                const avgE = elevs.reduce((a, b) => a + b, 0) / elevs.length;
                const stdDev = Math.sqrt(elevs.reduce((sum, e) => sum + Math.pow(e - avgE, 2), 0) / elevs.length);
                const level = parseFloat($('ew-level')?.value) || avgE;
                // Calculate cut/fill volumes
                let cutVol = 0, fillVol = 0, cutCells = 0, fillCells = 0;
                this.layer = this.layer || L.layerGroup().addTo(State.map);
                this.layer.clearLayers();
                points.forEach(p => {
                    const diff = p.elev - level;
                    if (diff > 0.01) {
                        // Corte: volumen in-situ (celda  profundidad)
                        cutVol += diff * cellAreaM2;
                        cutCells++;
                        L.rectangle([[p.lat, p.lng], [p.lat + cellSize, p.lng + cellSize]], {
                            color: '#ef4444', fillColor: '#ef4444',
                            fillOpacity: Math.min(0.85, 0.15 + (diff / (maxE - level)) * 0.7), weight: 0
                        }).bindPopup(`<b style="color:#ef4444;">CORTE</b><br>Elev: ${p.elev.toFixed(2)} m<br>Corte: ${diff.toFixed(2)} m<br>Vol celda: ${(diff * cellAreaM2).toFixed(1)} m`).addTo(this.layer);
                    } else if (diff < -0.01) {
                        const absDiff = Math.abs(diff);
                        fillVol += absDiff * cellAreaM2;
                        fillCells++;
                        L.rectangle([[p.lat, p.lng], [p.lat + cellSize, p.lng + cellSize]], {
                            color: '#3b82f6', fillColor: '#3b82f6',
                            fillOpacity: Math.min(0.85, 0.15 + (absDiff / (level - minE)) * 0.7), weight: 0
                        }).bindPopup(`<b style="color:#3b82f6;">RELLENO</b><br>Elev: ${p.elev.toFixed(2)} m<br>Relleno: ${absDiff.toFixed(2)} m<br>Vol celda: ${(absDiff * cellAreaM2).toFixed(1)} m`).addTo(this.layer);
                    }
                });
                // Volmenes calculados
                const cutSwell = cutVol * soil.swell;              // Corte esponjado (lo que sale del terreno)
                const fillCompact = fillVol / soil.compact;         // Relleno necesario (material suelto para compactar)
                const balanceInsitu = cutVol - fillVol;             // Balance en banco
                const balanceSwell = cutSwell - fillCompact;        // Balance en material suelto
                const sobrante = Math.max(0, cutSwell - fillCompact); // Material sobrante a botar
                const faltante = Math.max(0, fillCompact - cutSwell); // Material faltante a importar
                // Costos
                const costCut = cutVol * parseFloat($('ew-cost-cut')?.value || 15);
                const costFill = fillVol * parseFloat($('ew-cost-fill')?.value || 20);
                const costHaulUnit = parseFloat($('ew-cost-haul')?.value || 8);
                const haulDist = parseFloat($('ew-haul-dist')?.value || 5);
                const costHaul = sobrante > 0 ? sobrante * costHaulUnit * haulDist : faltante * costHaulUnit * haulDist;
                const costTotal = costCut + costFill + costHaul;
                // Estimacin de equipo/tiempo
                const prodExcavadora = 80;   // m/hora
                const prodVolqueta = 12;      // m por viaje
                const viajesVolqueta = Math.ceil((cutVol > fillVol ? sobrante : faltante) / prodVolqueta);
                const horasExcavadora = cutVol / prodExcavadora;
                const horasMoto = areaM2 / 500;          // motoniveladora m/hora
                const horasCompact = fillVol > 0 ? (fillVol / 150) : 0; // compactador m/hora
                // Pendiente promedio
                let slopeSum = 0, slopeCount = 0;
                points.forEach((p, i) => {
                    const neighbors = points.filter(q => {
                        const d = Math.sqrt(Math.pow(q.lat - p.lat, 2) + Math.pow(q.lng - p.lng, 2));
                        return d > 0 && d < cellSize * 1.5;
                    });
                    if (neighbors.length > 0) {
                        const maxSlope = Math.max(...neighbors.map(q => Math.abs(q.elev - p.elev) / (Math.sqrt(Math.pow(q.lat - p.lat, 2) + Math.pow(q.lng - p.lng, 2)) * 111320)));
                        slopeSum += maxSlope * 100;
                        slopeCount++;
                    }
                });
                const avgSlope = slopeCount > 0 ? slopeSum / slopeCount : 0;
                // Peso total del material
                const cutWeight = cutVol * soil.weight;   // toneladas
                const fillWeight = fillVol * soil.weight;
                this.results = {
                    areaM2, areaHa, level, resolution, totalPoints: points.length,
                    minE, maxE, avgE, stdDev, desnivel: maxE - minE, avgSlope,
                    soilName: soil.name, soilId: soil.id, swell: soil.swell, compact: soil.compact, soilWeight: soil.weight,
                    cutVol, fillVol, cutSwell, fillCompact,
                    balanceInsitu, balanceSwell, sobrante, faltante,
                    cutCells, fillCells, cutWeight, fillWeight,
                    costCut, costFill, costHaul, costTotal, haulDist,
                    horasExcavadora, horasMoto, horasCompact, viajesVolqueta,
                    prodExcavadora, prodVolqueta
                };
                this.showResults();
                Loading.hide();
                Toast.show('Clculo completado', 'success');
            } catch (e) {
                Loading.hide();
                Toast.show('Error: ' + e.message, 'error');
                console.error(e);
            }
        },
        async findOptimal() {
            if (!State.polygon) return Toast.show('Dibuja un polgono primero', 'error');
            Loading.show();
            try {
                const { points, cellSize, resolution } = await this.getGridElevations();
                this.gridPoints = points;
                const soilIdx = parseInt($('ew-soil')?.value) || 2;
                const soil = this.soilTypes[soilIdx];
                const cellAreaM2 = resolution * resolution;
                // Bsqueda binaria del nivel ptimo donde cutSwell  fillCompact
                const elevs = points.map(p => p.elev);
                let lo = Math.min(...elevs), hi = Math.max(...elevs);
                for (let iter = 0; iter < 50; iter++) {
                    const mid = (lo + hi) / 2;
                    let cutV = 0, fillV = 0;
                    points.forEach(p => {
                        const diff = p.elev - mid;
                        if (diff > 0) cutV += diff * cellAreaM2;
                        else fillV += Math.abs(diff) * cellAreaM2;
                    });
                    const cutS = cutV * soil.swell;
                    const fillC = fillV / soil.compact;
                    if (Math.abs(cutS - fillC) < 0.1) break;
                    if (cutS > fillC) lo = mid; else hi = mid;
                }
                const optimal = (lo + hi) / 2;
                $('ew-level').value = optimal.toFixed(2);
                Loading.hide();
                Toast.show(`Nivel ptimo: ${optimal.toFixed(2)} m (balance  0)`, 'success');
                this.calculate();
            } catch (e) {
                Loading.hide();
                Toast.show('Error: ' + e.message, 'error');
            }
        },
        showResults() {
            const r = this.results;
            if (!r) return;
            const rd = $('ew-results');
            if (!rd) return;
            rd.style.display = 'block';
            rd.innerHTML = `<div style="background:linear-gradient(135deg,rgba(245,158,11,0.2),rgba(217,119,6,0.15));border-radius:8px;padding:12px;">
                <div style="text-align:center;margin-bottom:8px;">
                    <div style="font-size:10px;color:var(--text-3);">NIVEL DE PROYECTO</div>
                    <div style="font-size:20px;font-weight:800;color:#f59e0b;">${r.level.toFixed(2)} m</div>
                </div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
                    <div style="text-align:center;background:rgba(239,68,68,0.2);padding:8px;border-radius:4px;">
                        <div style="font-size:20px;font-weight:800;color:#ef4444;">${r.cutVol.toFixed(0)}</div>
                        <div style="font-size:9px;">CORTE m (banco)</div>
                        <div style="font-size:8px;color:var(--text-3);">${r.cutSwell.toFixed(0)} m esponj.</div>
                    </div>
                    <div style="text-align:center;background:rgba(59,130,246,0.2);padding:8px;border-radius:4px;">
                        <div style="font-size:20px;font-weight:800;color:#3b82f6;">${r.fillVol.toFixed(0)}</div>
                        <div style="font-size:9px;">RELLENO m (banco)</div>
                        <div style="font-size:8px;color:var(--text-3);">${r.fillCompact.toFixed(0)} m compact.</div>
                    </div>
                </div>
            </div>
            <div style="margin-top:10px;">
                <div style="font-size:10px;font-weight:600;color:#f59e0b;margin-bottom:6px;">
                    <i class="fa-solid fa-chart-bar"></i> TERRENO Y BALANCE
                </div>
                <div style="font-size:10px;color:var(--text-2);padding:8px;background:var(--bg-glass);border-radius:6px;">
                    <div>rea: <b>${r.areaHa.toFixed(4)} Ha</b> (${r.areaM2.toFixed(0)} m)</div>
                    <div>Elevacin: <b>${r.minE.toFixed(1)}m</b> - <b>${r.maxE.toFixed(1)}m</b> ( ${r.desnivel.toFixed(1)}m)</div>
                    <div>Promedio: <b>${r.avgE.toFixed(2)} m</b> | Desv. est: <b>${r.stdDev.toFixed(2)} m</b></div>
                    <div>Pendiente promedio: <b>${r.avgSlope.toFixed(1)}%</b></div>
                    <div style="margin-top:4px;">Suelo: <b>${r.soilName}</b> (Fe=${r.swell}, Fc=${r.compact})</div>
                    <div>Balance banco: <b style="color:${r.balanceInsitu > 0 ? '#ef4444' : '#3b82f6'};">${r.balanceInsitu > 0 ? '+' : ''}${r.balanceInsitu.toFixed(0)} m</b></div>
                    <div>Balance suelto: <b style="color:${r.balanceSwell > 0 ? '#ef4444' : '#3b82f6'};">${r.balanceSwell > 0 ? '+' : ''}${r.balanceSwell.toFixed(0)} m</b></div>
                    ${r.sobrante > 0 ? `<div style="color:#ef4444;">Material sobrante a botar: <b>${r.sobrante.toFixed(0)} m</b></div>` : ''}
                    ${r.faltante > 0 ? `<div style="color:#3b82f6;">Material faltante a importar: <b>${r.faltante.toFixed(0)} m</b></div>` : ''}
                    <div>Peso corte: <b>${r.cutWeight.toFixed(0)} t</b> | Peso relleno: <b>${r.fillWeight.toFixed(0)} t</b></div>
                    <div>Puntos analizados: <b>${r.totalPoints}</b> (res. ${r.resolution}m)</div>
                </div>
            </div>
            <div style="margin-top:10px;">
                <div style="font-size:10px;font-weight:600;color:#22c55e;margin-bottom:6px;">
                    <i class="fa-solid fa-dollar-sign"></i> COSTOS ESTIMADOS
                </div>
                <div style="font-size:10px;color:var(--text-2);padding:8px;background:var(--bg-glass);border-radius:6px;">
                    <div>Corte: <b>$${r.costCut.toFixed(2)}</b></div>
                    <div>Relleno: <b>$${r.costFill.toFixed(2)}</b></div>
                    <div>Transporte (${r.haulDist} km): <b>$${r.costHaul.toFixed(2)}</b></div>
                    <div style="margin-top:4px;font-size:12px;font-weight:700;color:#22c55e;">TOTAL: $${r.costTotal.toFixed(2)}</div>
                </div>
            </div>
            <div style="margin-top:10px;">
                <div style="font-size:10px;font-weight:600;color:#a78bfa;margin-bottom:6px;">
                    <i class="fa-solid fa-clock"></i> EQUIPO Y TIEMPO ESTIMADO
                </div>
                <div style="font-size:10px;color:var(--text-2);padding:8px;background:var(--bg-glass);border-radius:6px;">
                    <div>Excavadora (${r.prodExcavadora} m/h): <b>${r.horasExcavadora.toFixed(1)} h</b>  ${(r.horasExcavadora / 8).toFixed(1)} das</div>
                    <div>Motoniveladora: <b>${r.horasMoto.toFixed(1)} h</b></div>
                    <div>Compactador: <b>${r.horasCompact.toFixed(1)} h</b></div>
                    <div>Viajes volqueta (${r.prodVolqueta} m): <b>${r.viajesVolqueta}</b></div>
                </div>
            </div>
            <div style="margin-top:6px;font-size:9px;">
                <span style="display:inline-block;width:10px;height:10px;background:#ef4444;border-radius:2px;"></span> Corte
                <span style="display:inline-block;width:10px;height:10px;background:#3b82f6;margin-left:8px;border-radius:2px;"></span> Relleno
            </div>
            <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:4px;margin-top:12px;">
                <button class="btn btn-2" onclick="EarthworkCalc.exportKML()" style="font-size:8px;padding:6px;" title="Google Earth">
                    <i class="fa-solid fa-earth-americas"></i> KML
                </button>
                <button class="btn btn-2" onclick="EarthworkCalc.exportGeoJSON()" style="font-size:8px;padding:6px;" title="GIS">
                    <i class="fa-solid fa-code"></i> JSON
                </button>
                <button class="btn btn-2" onclick="EarthworkCalc.exportDXF()" style="font-size:8px;padding:6px;" title="AutoCAD">
                    <i class="fa-solid fa-drafting-compass"></i> DXF
                </button>
                <button class="btn btn-2" onclick="EarthworkCalc.exportCSV()" style="font-size:8px;padding:6px;" title="Excel">
                    <i class="fa-solid fa-file-csv"></i> CSV
                </button>
            </div>
            <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:4px;margin-top:4px;">
                <button class="btn btn-2" onclick="EarthworkCalc.exportGPX()" style="font-size:8px;padding:6px;" title="GPS">
                    <i class="fa-solid fa-satellite"></i> GPX
                </button>
                <button class="btn btn-2" onclick="EarthworkCalc.exportPDF()" style="font-size:8px;padding:6px;" title="Informe PDF">
                    <i class="fa-solid fa-file-pdf"></i> PDF
                </button>
                <button class="btn btn-2" onclick="EarthworkCalc.exportTXT()" style="font-size:8px;padding:6px;" title="Texto">
                    <i class="fa-solid fa-file-lines"></i> TXT
                </button>
                <button class="btn btn-2" onclick="EarthworkCalc.copyToClipboard()" style="font-size:8px;padding:6px;" title="Copiar">
                    <i class="fa-solid fa-copy"></i> COPY
                </button>
            </div>`;
        },
        clear() {
            if (this.layer) this.layer.clearLayers();
            this.results = null;
            this.gridPoints = [];
            if ($('ew-results')) $('ew-results').style.display = 'none';
            Toast.show('Limpiado', 'success');
        },
        // ========== EXPORTACIN KML ==========
        exportKML() {
            if (!this.results) return Toast.show('Calcula primero', 'error');
            const r = this.results;
            const coords = State.polygon.geometry.coordinates[0];
            const kmlCoords = coords.map(c => `${c[0]},${c[1]},0`).join(' ');
            let kml = `<?xml version="1.0" encoding="UTF-8"?>
<kml xmlns="http://www.opengis.net/kml/2.2">
<Document>
<n>Movimiento de Tierras - WIN-TEL v30</n>
<description>Nivel: ${r.level.toFixed(2)}m | Corte: ${r.cutVol.toFixed(0)}m | Relleno: ${r.fillVol.toFixed(0)}m
Generado: ${new Date().toLocaleString('es-ES')}</description>
<Style id="cutZone"><LineStyle><color>ff4444ef</color><width>1</width></LineStyle><PolyStyle><color>804444ef</color></PolyStyle></Style>
<Style id="fillZone"><LineStyle><color>fff68230</color><width>1</width></LineStyle><PolyStyle><color>80f68230</color></PolyStyle></Style>
<Style id="boundary"><LineStyle><color>ff0b9ef5</color><width>3</width></LineStyle><PolyStyle><color>300b9ef5</color></PolyStyle></Style>
<Folder>
<n>Lmite del terreno</n>
<Placemark>
    <n>Parcela - Mov. Tierras</n>
    <description><![CDATA[MOVIMIENTO DE TIERRAS - WIN-TEL v30
rea: ${r.areaHa.toFixed(4)} Ha
Nivel proyecto: ${r.level.toFixed(2)} m
Suelo: ${r.soilName} (Fe=${r.swell}, Fc=${r.compact})
Corte (banco): ${r.cutVol.toFixed(0)} m
Corte (esponjado): ${r.cutSwell.toFixed(0)} m
Relleno (banco): ${r.fillVol.toFixed(0)} m
Relleno (compactado): ${r.fillCompact.toFixed(0)} m
Balance: ${r.balanceInsitu.toFixed(0)} m
Costo total: $${r.costTotal.toFixed(2)}]]></description>
    <styleUrl>#boundary</styleUrl>
    <Polygon><outerBoundaryIs><LinearRing><coordinates>${kmlCoords}</coordinates></LinearRing></outerBoundaryIs></Polygon>
</Placemark>
</Folder>
<Folder>
<n>Zonas de Corte (${r.cutCells} celdas)</n>\n`;
            const cellDeg = r.resolution / 111320;
            this.gridPoints.forEach((p, i) => {
                const diff = p.elev - r.level;
                if (diff > 0.01) {
                    const c = [[p.lng, p.lat], [p.lng + cellDeg, p.lat], [p.lng + cellDeg, p.lat + cellDeg], [p.lng, p.lat + cellDeg], [p.lng, p.lat]];
                    kml += `<Placemark><n>Corte ${i}</n><description>Elev: ${p.elev.toFixed(2)}m, Corte: ${diff.toFixed(2)}m</description><styleUrl>#cutZone</styleUrl>
<Polygon><outerBoundaryIs><LinearRing><coordinates>${c.map(v => v[0]+','+v[1]+',0').join(' ')}</coordinates></LinearRing></outerBoundaryIs></Polygon></Placemark>\n`;
                }
            });
            kml += `</Folder>\n<Folder>\n<n>Zonas de Relleno (${r.fillCells} celdas)</n>\n`;
            this.gridPoints.forEach((p, i) => {
                const diff = p.elev - r.level;
                if (diff < -0.01) {
                    const c = [[p.lng, p.lat], [p.lng + cellDeg, p.lat], [p.lng + cellDeg, p.lat + cellDeg], [p.lng, p.lat + cellDeg], [p.lng, p.lat]];
                    kml += `<Placemark><n>Relleno ${i}</n><description>Elev: ${p.elev.toFixed(2)}m, Relleno: ${Math.abs(diff).toFixed(2)}m</description><styleUrl>#fillZone</styleUrl>
<Polygon><outerBoundaryIs><LinearRing><coordinates>${c.map(v => v[0]+','+v[1]+',0').join(' ')}</coordinates></LinearRing></outerBoundaryIs></Polygon></Placemark>\n`;
                }
            });
            kml += `</Folder>\n</Document>\n</kml>`;
            download(kml, `mov_tierras_${Date.now()}.kml`, 'application/vnd.google-earth.kml+xml');
            Toast.show('KML exportado', 'success');
        },
        // ========== EXPORTACIN GeoJSON ==========
        exportGeoJSON() {
            if (!this.results) return Toast.show('Calcula primero', 'error');
            const r = this.results;
            const cellDeg = r.resolution / 111320;
            const features = [{
                type: 'Feature',
                properties: { type: 'boundary', level_m: r.level, area_ha: r.areaHa, cut_m3: r.cutVol, fill_m3: r.fillVol, cost: r.costTotal },
                geometry: State.polygon.geometry
            }];
            this.gridPoints.forEach((p, i) => {
                const diff = p.elev - r.level;
                if (Math.abs(diff) > 0.01) {
                    features.push({
                        type: 'Feature',
                        properties: {
                            type: diff > 0 ? 'cut' : 'fill', elevation_m: parseFloat(p.elev.toFixed(2)),
                            depth_m: parseFloat(Math.abs(diff).toFixed(2)),
                            volume_m3: parseFloat((Math.abs(diff) * r.resolution * r.resolution).toFixed(1))
                        },
                        geometry: {
                            type: 'Polygon',
                            coordinates: [[[p.lng, p.lat], [p.lng + cellDeg, p.lat], [p.lng + cellDeg, p.lat + cellDeg], [p.lng, p.lat + cellDeg], [p.lng, p.lat]]]
                        }
                    });
                }
            });
            const geojson = {
                type: 'FeatureCollection', name: 'Movimiento de Tierras - WIN-TEL v30',
                crs: { type: 'name', properties: { name: 'urn:ogc:def:crs:OGC:1.3:CRS84' } },
                properties: { software: 'WIN-TEL GEOMATICS PRO v30', date: new Date().toISOString(), level_m: r.level, soil: r.soilName, cut_m3: r.cutVol, fill_m3: r.fillVol },
                features
            };
            download(JSON.stringify(geojson, null, 2), `mov_tierras_${Date.now()}.geojson`, 'application/json');
            Toast.show('GeoJSON exportado', 'success');
        },
        // ========== EXPORTACIN DXF ==========
        exportDXF() {
            if (!this.results) return Toast.show('Calcula primero', 'error');
            const r = this.results;
            const coords = State.polygon.geometry.coordinates[0];
            let dxf = `0\nSECTION\n2\nHEADER\n9\n$ACADVER\n1\nAC1014\n9\n$INSUNITS\n70\n6\n0\nENDSEC\n0\nSECTION\n2\nTABLES\n0\nTABLE\n2\nLAYER\n70\n4\n`;
            dxf += `0\nLAYER\n2\nLIMITE_TERRENO\n70\n0\n62\n5\n6\nCONTINUOUS\n`;
            dxf += `0\nLAYER\n2\nZONA_CORTE\n70\n0\n62\n1\n6\nCONTINUOUS\n`;
            dxf += `0\nLAYER\n2\nZONA_RELLENO\n70\n0\n62\n5\n6\nCONTINUOUS\n`;
            dxf += `0\nLAYER\n2\nELEVACIONES\n70\n0\n62\n3\n6\nCONTINUOUS\n`;
            dxf += `0\nENDTAB\n0\nENDSEC\n0\nSECTION\n2\nENTITIES\n`;
            // Boundary polyline
            dxf += `0\nPOLYLINE\n8\nLIMITE_TERRENO\n66\n1\n70\n1\n`;
            coords.forEach(c => {
                const x = c[0] * 111320 * Math.cos(c[1] * Math.PI / 180);
                const y = c[1] * 110540;
                dxf += `0\nVERTEX\n8\nLIMITE_TERRENO\n10\n${x.toFixed(3)}\n20\n${y.toFixed(3)}\n30\n0\n`;
            });
            dxf += `0\nSEQEND\n8\nLIMITE_TERRENO\n`;
            // Grid points with elevation
            this.gridPoints.forEach(p => {
                const x = p.lng * 111320 * Math.cos(p.lat * Math.PI / 180);
                const y = p.lat * 110540;
                const diff = p.elev - r.level;
                const layer = diff > 0.01 ? 'ZONA_CORTE' : diff < -0.01 ? 'ZONA_RELLENO' : 'ELEVACIONES';
                dxf += `0\nPOINT\n8\n${layer}\n10\n${x.toFixed(3)}\n20\n${y.toFixed(3)}\n30\n${p.elev.toFixed(3)}\n`;
            });
            dxf += `0\nENDSEC\n0\nEOF`;
            download(dxf, `mov_tierras_${Date.now()}.dxf`, 'application/dxf');
            Toast.show('DXF exportado (AutoCAD)', 'success');
        },
        // ========== EXPORTACIN CSV ==========
        exportCSV() {
            if (!this.results) return Toast.show('Calcula primero', 'error');
            const r = this.results;
            let csv = `MOVIMIENTO DE TIERRAS - WIN-TEL GEOMATICS PRO v30\n`;
            csv += `Fecha,${new Date().toLocaleString('es-ES')}\n\n`;
            csv += `DATOS DEL TERRENO\n`;
            csv += `rea (Ha),${r.areaHa.toFixed(4)}\nrea (m),${r.areaM2.toFixed(0)}\n`;
            csv += `Elevacin mn (m),${r.minE.toFixed(2)}\nElevacin mx (m),${r.maxE.toFixed(2)}\n`;
            csv += `Elevacin promedio (m),${r.avgE.toFixed(2)}\nDesviacin estndar (m),${r.stdDev.toFixed(2)}\n`;
            csv += `Desnivel (m),${r.desnivel.toFixed(2)}\nPendiente promedio (%),${r.avgSlope.toFixed(1)}\n`;
            csv += `Resolucin (m),${r.resolution}\nPuntos analizados,${r.totalPoints}\n\n`;
            csv += `PARMETROS\n`;
            csv += `Nivel de proyecto (m),${r.level.toFixed(2)}\nTipo de suelo,${r.soilName}\n`;
            csv += `Factor esponjamiento,${r.swell}\nFactor compactacin,${r.compact}\nPeso especfico (t/m),${r.soilWeight}\n\n`;
            csv += `VOLMENES\n`;
            csv += `Corte banco (m),${r.cutVol.toFixed(1)}\nCorte esponjado (m),${r.cutSwell.toFixed(1)}\n`;
            csv += `Relleno banco (m),${r.fillVol.toFixed(1)}\nRelleno compactado (m),${r.fillCompact.toFixed(1)}\n`;
            csv += `Balance banco (m),${r.balanceInsitu.toFixed(1)}\nBalance suelto (m),${r.balanceSwell.toFixed(1)}\n`;
            csv += `Material sobrante (m),${r.sobrante.toFixed(1)}\nMaterial faltante (m),${r.faltante.toFixed(1)}\n`;
            csv += `Peso corte (t),${r.cutWeight.toFixed(0)}\nPeso relleno (t),${r.fillWeight.toFixed(0)}\n\n`;
            csv += `COSTOS\nCorte ($),${r.costCut.toFixed(2)}\nRelleno ($),${r.costFill.toFixed(2)}\nTransporte ($),${r.costHaul.toFixed(2)}\nCOSTO TOTAL ($),${r.costTotal.toFixed(2)}\n\n`;
            csv += `EQUIPO ESTIMADO\nExcavadora (h),${r.horasExcavadora.toFixed(1)}\nMotoniveladora (h),${r.horasMoto.toFixed(1)}\nCompactador (h),${r.horasCompact.toFixed(1)}\nViajes volqueta,${r.viajesVolqueta}\n\n`;
            csv += `GRILLA DE ELEVACIONES\nPUNTO,LATITUD,LONGITUD,ELEVACION_M,TIPO,PROFUNDIDAD_M,VOLUMEN_CELDA_M3\n`;
            this.gridPoints.forEach((p, i) => {
                const diff = p.elev - r.level;
                const tipo = diff > 0.01 ? 'CORTE' : diff < -0.01 ? 'RELLENO' : 'NIVEL';
                csv += `${i + 1},${p.lat.toFixed(6)},${p.lng.toFixed(6)},${p.elev.toFixed(2)},${tipo},${Math.abs(diff).toFixed(2)},${(Math.abs(diff) * r.resolution * r.resolution).toFixed(1)}\n`;
            });
            download(csv, `mov_tierras_${Date.now()}.csv`, 'text/csv');
            Toast.show('CSV exportado', 'success');
        },
        // ========== EXPORTACIN GPX ==========
        exportGPX() {
            if (!this.results) return Toast.show('Calcula primero', 'error');
            const r = this.results;
            const coords = State.polygon.geometry.coordinates[0];
            let gpx = `<?xml version="1.0" encoding="UTF-8"?>
<gpx version="1.1" creator="WIN-TEL GEOMATICS PRO v30" xmlns="http://www.topografix.com/GPX/1/1">
<metadata>
    <n>Movimiento de Tierras</n>
    <desc>Nivel: ${r.level.toFixed(2)}m | Corte: ${r.cutVol.toFixed(0)}m | Relleno: ${r.fillVol.toFixed(0)}m</desc>
    <time>${new Date().toISOString()}</time>
</metadata>\n`;
            // Vertices del polgono
            coords.forEach((c, i) => {
                if (i < coords.length - 1) {
                    gpx += `<wpt lat="${c[1].toFixed(6)}" lon="${c[0].toFixed(6)}">
    <n>V${i + 1}</n><desc>Vrtice ${i + 1}</desc><sym>Flag, Blue</sym>
</wpt>\n`;
                }
            });
            // Puntos de corte/relleno significativos
            this.gridPoints.forEach((p, i) => {
                const diff = p.elev - r.level;
                if (Math.abs(diff) > 0.5) { // Solo puntos significativos
                    const tipo = diff > 0 ? 'CORTE' : 'RELLENO';
                    gpx += `<wpt lat="${p.lat.toFixed(6)}" lon="${p.lng.toFixed(6)}">
    <ele>${p.elev.toFixed(1)}</ele>
    <n>${tipo}-${i}</n><desc>${tipo}: ${Math.abs(diff).toFixed(2)}m</desc>
    <sym>${diff > 0 ? 'Danger Area' : 'Water Source'}</sym>
</wpt>\n`;
                }
            });
            gpx += `<trk><n>Permetro terreno</n><trkseg>\n`;
            coords.forEach(c => { gpx += `    <trkpt lat="${c[1].toFixed(6)}" lon="${c[0].toFixed(6)}"></trkpt>\n`; });
            gpx += `</trkseg></trk>\n</gpx>`;
            download(gpx, `mov_tierras_${Date.now()}.gpx`, 'application/gpx+xml');
            Toast.show('GPX exportado', 'success');
        },
        // ========== EXPORTACIN PDF ==========
        exportPDF() {
            if (!this.results) return Toast.show('Calcula primero', 'error');
            if (typeof jspdf === 'undefined') return Toast.show('PDF no disponible', 'error');
            const r = this.results;
            const { jsPDF } = jspdf;
            const doc = new jsPDF();
            let y = 15;
            doc.setFontSize(18); doc.setTextColor(245, 158, 11);
            doc.text('INFORME DE MOVIMIENTO DE TIERRAS', 105, y, { align: 'center' }); y += 7;
            doc.setFontSize(10); doc.setTextColor(100);
            doc.text('WIN-TEL GEOMATICS PRO v30', 105, y, { align: 'center' }); y += 5;
            doc.text(new Date().toLocaleString('es-ES'), 105, y, { align: 'center' }); y += 10;
            doc.setDrawColor(245, 158, 11); doc.setLineWidth(0.5); doc.line(20, y, 190, y); y += 10;
            doc.setFontSize(13); doc.setTextColor(0);
            doc.text('DATOS DEL TERRENO', 20, y); y += 7;
            doc.setFontSize(10);
            doc.text(`rea: ${r.areaHa.toFixed(4)} Ha (${r.areaM2.toFixed(0)} m)`, 25, y); y += 5;
            doc.text(`Elevacin: ${r.minE.toFixed(2)}m - ${r.maxE.toFixed(2)}m (Desnivel: ${r.desnivel.toFixed(2)}m)`, 25, y); y += 5;
            doc.text(`Elevacin promedio: ${r.avgE.toFixed(2)} m | Desv. est: ${r.stdDev.toFixed(2)} m`, 25, y); y += 5;
            doc.text(`Pendiente promedio: ${r.avgSlope.toFixed(1)}%`, 25, y); y += 5;
            doc.text(`Resolucin: ${r.resolution}m (${r.totalPoints} puntos)`, 25, y); y += 10;
            doc.setFontSize(13); doc.text('PARMETROS', 20, y); y += 7;
            doc.setFontSize(10);
            doc.text(`Nivel de proyecto: ${r.level.toFixed(2)} m`, 25, y); y += 5;
            doc.text(`Suelo: ${r.soilName} (Esponj: ${r.swell}, Compact: ${r.compact}, Peso: ${r.soilWeight} t/m)`, 25, y); y += 10;
            doc.setFontSize(13); doc.text('VOLMENES', 20, y); y += 7;
            doc.setFontSize(10);
            doc.setTextColor(239, 68, 68); doc.text(`CORTE: ${r.cutVol.toFixed(0)} m (banco)  ${r.cutSwell.toFixed(0)} m (esponjado)`, 25, y); y += 5;
            doc.setTextColor(59, 130, 246); doc.text(`RELLENO: ${r.fillVol.toFixed(0)} m (banco)  ${r.fillCompact.toFixed(0)} m (compactado necesario)`, 25, y); y += 5;
            doc.setTextColor(0);
            doc.text(`Balance banco: ${r.balanceInsitu > 0 ? '+' : ''}${r.balanceInsitu.toFixed(0)} m`, 25, y); y += 5;
            doc.text(`Balance suelto: ${r.balanceSwell > 0 ? '+' : ''}${r.balanceSwell.toFixed(0)} m`, 25, y); y += 5;
            if (r.sobrante > 0) { doc.text(`Material sobrante a botar: ${r.sobrante.toFixed(0)} m`, 25, y); y += 5; }
            if (r.faltante > 0) { doc.text(`Material faltante a importar: ${r.faltante.toFixed(0)} m`, 25, y); y += 5; }
            doc.text(`Peso: Corte ${r.cutWeight.toFixed(0)} t | Relleno ${r.fillWeight.toFixed(0)} t`, 25, y); y += 10;
            doc.setFontSize(13); doc.text('COSTOS ESTIMADOS', 20, y); y += 7;
            doc.setFontSize(10);
            doc.text(`Corte: $${r.costCut.toFixed(2)}`, 25, y); y += 5;
            doc.text(`Relleno: $${r.costFill.toFixed(2)}`, 25, y); y += 5;
            doc.text(`Transporte (${r.haulDist} km): $${r.costHaul.toFixed(2)}`, 25, y); y += 5;
            doc.setFontSize(12); doc.setTextColor(34, 197, 94);
            doc.text(`COSTO TOTAL: $${r.costTotal.toFixed(2)}`, 25, y); y += 10;
            doc.setFontSize(13); doc.setTextColor(0); doc.text('EQUIPO Y TIEMPO', 20, y); y += 7;
            doc.setFontSize(10);
            doc.text(`Excavadora (${r.prodExcavadora} m/h): ${r.horasExcavadora.toFixed(1)} h  ${(r.horasExcavadora / 8).toFixed(1)} das`, 25, y); y += 5;
            doc.text(`Motoniveladora: ${r.horasMoto.toFixed(1)} h`, 25, y); y += 5;
            doc.text(`Compactador: ${r.horasCompact.toFixed(1)} h`, 25, y); y += 5;
            doc.text(`Viajes volqueta (${r.prodVolqueta} m): ${r.viajesVolqueta}`, 25, y); y += 10;
            if (y > 240) { doc.addPage(); y = 20; }
            doc.setFontSize(13); doc.text('RECOMENDACIONES', 20, y); y += 7;
            doc.setFontSize(10);
            const recs = [
                r.avgSlope > 15 ? 'Terreno con pendiente pronunciada, considerar terrazas' : null,
                r.sobrante > 500 ? 'Gran volumen sobrante, evaluar botadero cercano' : null,
                r.faltante > 500 ? 'Gran volumen faltante, evaluar fuente de prstamo' : null,
                r.soilId === 'roca_dura' ? 'Suelo rocoso: considerar voladura controlada' : null,
                'Realizar compactacin por capas de mx. 30 cm',
                'Verificar humedad ptima antes de compactar',
                'Mantener drenaje provisional durante la obra'
            ].filter(Boolean);
            recs.forEach(rec => { if (y > 275) { doc.addPage(); y = 20; } doc.text(` ${rec}`, 25, y); y += 5; });
            doc.setFontSize(8); doc.setTextColor(150);
            doc.text('Generado por WIN-TEL GEOMATICS PRO v30 - WindowsTelecom C.A.', 105, 290, { align: 'center' });
            doc.save(`informe_mov_tierras_${Date.now()}.pdf`);
            Toast.show('PDF exportado', 'success');
        },
        // ========== EXPORTACIN TXT ==========
        exportTXT() {
            if (!this.results) return Toast.show('Calcula primero', 'error');
            const r = this.results;
            let report = `
         INFORME DE MOVIMIENTO DE TIERRAS                    
         WIN-TEL GEOMATICS PRO v30                           


Fecha de generacin: ${new Date().toLocaleString('es-ES')}


                    DATOS DEL TERRENO


rea total ................. ${r.areaHa.toFixed(4)} Ha (${r.areaM2.toFixed(0)} m)
Elevacin mnima ........... ${r.minE.toFixed(2)} m
Elevacin mxima ........... ${r.maxE.toFixed(2)} m
Elevacin promedio ......... ${r.avgE.toFixed(2)} m
Desviacin estndar ........ ${r.stdDev.toFixed(2)} m
Desnivel total ............. ${r.desnivel.toFixed(2)} m
Pendiente promedio ......... ${r.avgSlope.toFixed(1)}%
Resolucin ................. ${r.resolution} m (${r.totalPoints} puntos)


                      PARMETROS


Nivel de proyecto .......... ${r.level.toFixed(2)} m
Tipo de suelo .............. ${r.soilName}
Factor de esponjamiento .... ${r.swell}
Factor de compactacin ..... ${r.compact}
Peso especfico ............ ${r.soilWeight} t/m


                      VOLMENES


CORTE (banco) .............. ${r.cutVol.toFixed(1)} m
CORTE (esponjado) .......... ${r.cutSwell.toFixed(1)} m
RELLENO (banco) ............ ${r.fillVol.toFixed(1)} m
RELLENO (compactado nec.) .. ${r.fillCompact.toFixed(1)} m
Balance en banco ........... ${r.balanceInsitu > 0 ? '+' : ''}${r.balanceInsitu.toFixed(1)} m
Balance en suelto .......... ${r.balanceSwell > 0 ? '+' : ''}${r.balanceSwell.toFixed(1)} m
${r.sobrante > 0 ? `Material sobrante a botar .. ${r.sobrante.toFixed(1)} m` : ''}
${r.faltante > 0 ? `Material faltante .......... ${r.faltante.toFixed(1)} m` : ''}
Peso corte ................. ${r.cutWeight.toFixed(0)} t
Peso relleno ............... ${r.fillWeight.toFixed(0)} t
Celdas corte ............... ${r.cutCells}
Celdas relleno ............. ${r.fillCells}


                  COSTOS ESTIMADOS


Corte ...................... $${r.costCut.toFixed(2)}
Relleno .................... $${r.costFill.toFixed(2)}
Transporte (${r.haulDist} km) ........... $${r.costHaul.toFixed(2)}

COSTO TOTAL ................ $${r.costTotal.toFixed(2)}


               EQUIPO Y TIEMPO ESTIMADO


Excavadora (${r.prodExcavadora} m/h) ....... ${r.horasExcavadora.toFixed(1)} h  ${(r.horasExcavadora / 8).toFixed(1)} das
Motoniveladora ............. ${r.horasMoto.toFixed(1)} h
Compactador ................ ${r.horasCompact.toFixed(1)} h
Viajes volqueta (${r.prodVolqueta} m) .. ${r.viajesVolqueta}


                   RECOMENDACIONES

${r.avgSlope > 15 ? '\n Terreno con pendiente pronunciada, considerar terrazas' : ''}
${r.sobrante > 500 ? ' Gran volumen sobrante, evaluar botadero cercano' : ''}
${r.faltante > 500 ? ' Gran volumen faltante, evaluar fuente de prstamo' : ''}
 Realizar compactacin por capas de mx. 30 cm
 Verificar humedad ptima del suelo antes de compactar
 Mantener drenaje provisional durante la obra
 Control topogrfico durante y despus de la nivelacin


         Generado por WIN-TEL GEOMATICS PRO v30
                  WindowsTelecom C.A.
               Valencia, Carabobo, Venezuela

`;
            download(report, `informe_mov_tierras_${Date.now()}.txt`, 'text/plain');
            Toast.show('Informe TXT exportado', 'success');
        },
        // ========== COPIAR AL PORTAPAPELES ==========
        copyToClipboard() {
            if (!this.results) return Toast.show('Calcula primero', 'error');
            const r = this.results;
            let text = `MOVIMIENTO DE TIERRAS - WIN-TEL v30\n`;
            text += `Fecha: ${new Date().toLocaleString('es-ES')}\n\n`;
            text += `rea: ${r.areaHa.toFixed(4)} Ha | Nivel: ${r.level.toFixed(2)} m\n`;
            text += `Suelo: ${r.soilName} (Fe=${r.swell}, Fc=${r.compact})\n\n`;
            text += `VOLMENES:\n`;
            text += `Corte: ${r.cutVol.toFixed(0)} m (esponj: ${r.cutSwell.toFixed(0)} m)\n`;
            text += `Relleno: ${r.fillVol.toFixed(0)} m (compact: ${r.fillCompact.toFixed(0)} m)\n`;
            text += `Balance: ${r.balanceInsitu > 0 ? '+' : ''}${r.balanceInsitu.toFixed(0)} m\n`;
            text += `${r.sobrante > 0 ? 'Sobrante: ' + r.sobrante.toFixed(0) + ' m\n' : ''}`;
            text += `${r.faltante > 0 ? 'Faltante: ' + r.faltante.toFixed(0) + ' m\n' : ''}`;
            text += `\nCOSTOS:\n`;
            text += `Corte: $${r.costCut.toFixed(2)} | Relleno: $${r.costFill.toFixed(2)}\n`;
            text += `Transporte: $${r.costHaul.toFixed(2)}\n`;
            text += `TOTAL: $${r.costTotal.toFixed(2)}\n`;
            navigator.clipboard.writeText(text).then(() => {
                Toast.show('Copiado al portapapeles', 'success');
            }).catch(() => { Toast.show('Error al copiar', 'error'); });
        }
    };

    // ========== MDULO 4: COMPARADOR DE TERRENOS ==========
    const TerrainCompare = {
        panel: null, layer: null, terrainA: null, terrainB: null,
        togglePanel() {
            if (this.panel) { this.panel.remove(); this.panel = null; return; }
            const html = `<div id="compare-panel" class="float-panel" style="top:80px;right:60px;width:320px;">
                <div class="panel-hdr" style="background:linear-gradient(135deg,rgba(236,72,153,0.3),rgba(219,39,119,0.2));">
                    <div class="panel-title"><i class="fa-solid fa-code-compare" style="color:#ec4899;"></i> Comparador</div>
                    <button class="panel-close" onclick="TerrainCompare.togglePanel()"><i class="fa-solid fa-times"></i></button>
                </div>
                <div class="panel-body">
                    <div style="background:rgba(59,130,246,0.1);border:1px solid #3b82f6;border-radius:6px;padding:8px;margin-bottom:8px;">
                        <div style="font-size:10px;font-weight:700;color:#3b82f6;"> TERRENO A</div>
                        <button class="btn btn-2" onclick="TerrainCompare.captureA()" style="font-size:9px;width:100%;margin-top:4px;">Capturar actual</button>
                        <div id="tc-a-info" style="font-size:9px;color:var(--text-3);margin-top:4px;"></div>
                    </div>
                    <div style="background:rgba(34,197,94,0.1);border:1px solid #22c55e;border-radius:6px;padding:8px;margin-bottom:8px;">
                        <div style="font-size:10px;font-weight:700;color:#22c55e;"> TERRENO B</div>
                        <input type="file" id="tc-file-b" accept=".kml,.geojson" style="display:none;" onchange="TerrainCompare.loadB(event)">
                        <button class="btn btn-2" onclick="document.getElementById('tc-file-b').click()" style="font-size:9px;width:100%;margin-top:4px;">Importar KML/GeoJSON</button>
                        <div id="tc-b-info" style="font-size:9px;color:var(--text-3);margin-top:4px;"></div>
                    </div>
                    <button class="btn" onclick="TerrainCompare.compare()" style="background:linear-gradient(135deg,#ec4899,#db2777);">
                        <i class="fa-solid fa-not-equal"></i> COMPARAR
                    </button>
                    <div id="tc-results" style="display:none;margin-top:12px;"></div>
                </div>
            </div>`;
            document.body.insertAdjacentHTML('beforeend', html);
            this.panel = document.getElementById('compare-panel');
        },
        captureA() {
            if (!State.polygon) return Toast.show('Dibuja un polgono', 'error');
            this.terrainA = JSON.parse(JSON.stringify(State.polygon));
            const area = turf.area(this.terrainA);
            document.getElementById('tc-a-info').innerHTML = ` ${(area/10000).toFixed(4)} Ha`;
            Toast.show('Terreno A capturado', 'success');
        },
        loadB(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    let geo;
                    if (file.name.endsWith('.kml')) {
                        const kml = new DOMParser().parseFromString(e.target.result, 'text/xml');
                        geo = toGeoJSON.kml(kml);
                        if (geo.features?.length) geo = geo.features[0];
                    } else {
                        geo = JSON.parse(e.target.result);
                        if (geo.features) geo = geo.features[0];
                    }
                    this.terrainB = geo;
                    document.getElementById('tc-b-info').innerHTML = ` ${(turf.area(geo)/10000).toFixed(4)} Ha`;
                    Toast.show('Terreno B cargado', 'success');
                } catch (err) { Toast.show('Error al cargar', 'error'); }
            };
            reader.readAsText(file);
        },
        compare() {
            if (!this.terrainA || !this.terrainB) return Toast.show('Captura ambos terrenos', 'error');
            Loading.show();
            this.layer = this.layer || L.layerGroup().addTo(State.map);
            this.layer.clearLayers();
            const areaA = turf.area(this.terrainA), areaB = turf.area(this.terrainB);
            let intersection, similarity = 0;
            try {
                intersection = turf.intersect(this.terrainA, this.terrainB);
                if (intersection) similarity = (turf.area(intersection) / Math.max(areaA, areaB)) * 100;
            } catch(e) {}
            
            L.geoJSON(this.terrainA, { style: { color: '#3b82f6', fillOpacity: 0.2, dashArray: '5,5' } }).addTo(this.layer);
            L.geoJSON(this.terrainB, { style: { color: '#22c55e', fillOpacity: 0.2 } }).addTo(this.layer);
            if (intersection) L.geoJSON(intersection, { style: { color: '#a78bfa', fillOpacity: 0.4 } }).addTo(this.layer);
            
            const rd = document.getElementById('tc-results');
            if (rd) {
                rd.style.display = 'block';
                rd.innerHTML = `<div style="background:var(--bg-glass);padding:10px;border-radius:6px;">
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;">
                        <div style="text-align:center;"><div style="font-size:14px;font-weight:700;color:#3b82f6;">${(areaA/10000).toFixed(4)}</div><div style="font-size:8px;">Ha (A)</div></div>
                        <div style="text-align:center;"><div style="font-size:14px;font-weight:700;color:#22c55e;">${(areaB/10000).toFixed(4)}</div><div style="font-size:8px;">Ha (B)</div></div>
                    </div>
                    <div style="text-align:center;margin-top:8px;">
                        <div style="font-size:9px;">Diferencia</div>
                        <div style="font-size:16px;font-weight:700;color:${areaB>areaA?'#22c55e':'#ef4444'};">${((areaB-areaA)/10000).toFixed(4)} Ha</div>
                    </div>
                    <div style="text-align:center;margin-top:6px;">
                        <div style="font-size:9px;">Similitud</div>
                        <div style="font-size:18px;font-weight:700;color:#ec4899;">${similarity.toFixed(1)}%</div>
                    </div>
                </div>`;
            }
            Loading.hide();
            Toast.show('Comparacin lista', 'success');
        }
    };

    // ========== MDULO 5: CALCULADORA DE RIEGO ==========
    const IrrigationCalc = {
        panel: null, lastResults: null,
        // Base de datos de cultivos con Kc promedio (FAO-56)
        crops: [
            { name: 'Maz', kc: 1.15 }, { name: 'Arroz (inundado)', kc: 1.20 },
            { name: 'Caa de azcar', kc: 1.25 }, { name: 'Tomate', kc: 1.05 },
            { name: 'Cebolla', kc: 0.95 }, { name: 'Papa', kc: 1.10 },
            { name: 'Frijol/Caraotas', kc: 1.05 }, { name: 'Sorgo', kc: 1.00 },
            { name: 'Pimentn/Aj', kc: 1.00 }, { name: 'Banano/Pltano', kc: 1.10 },
            { name: 'Ctricos', kc: 0.70 }, { name: 'Aguacate', kc: 0.70 },
            { name: 'Mango', kc: 0.75 }, { name: 'Caf', kc: 0.90 },
            { name: 'Hortalizas (general)', kc: 1.05 }, { name: 'Frutales (general)', kc: 0.85 },
            { name: 'Pasto/Csped', kc: 1.00 }, { name: 'Algodn', kc: 1.15 },
            { name: 'Girasol', kc: 1.10 }, { name: 'Soya', kc: 1.10 }
        ],
        // Sistemas de riego con eficiencia, descripcin y parmetros
        systems: [
            { id: 'goteo', name: 'Goteo', eff: 0.92, desc: 'Alta frecuencia, bajo volumen', icon: 'fa-droplet', color: '#22c55e' },
            { id: 'microasp', name: 'Microaspersin', eff: 0.85, desc: 'Micro-rociadores localizados', icon: 'fa-spray-can-sparkles', color: '#06b6d4' },
            { id: 'aspersion', name: 'Aspersin', eff: 0.75, desc: 'Aspersores mviles o fijos', icon: 'fa-shower', color: '#3b82f6' },
            { id: 'pivote', name: 'Pivote central', eff: 0.80, desc: 'Sistema mecanizado circular', icon: 'fa-circle-notch', color: '#8b5cf6' },
            { id: 'surco', name: 'Gravedad/Surcos', eff: 0.55, desc: 'Conduccin por surcos', icon: 'fa-water', color: '#f59e0b' },
            { id: 'inundacion', name: 'Inundacin', eff: 0.40, desc: 'Inundacin de melgas/tablas', icon: 'fa-house-flood-water', color: '#ef4444' }
        ],
        togglePanel() {
            if (this.panel) { this.panel.remove(); this.panel = null; return; }
            const cropOpts = this.crops.map((c, i) => `<option value="${i}" ${i===0?'selected':''}>${c.name} (Kc=${c.kc.toFixed(2)})</option>`).join('');
            const sysOpts = this.systems.map((s, i) => `<option value="${i}" ${s.id==='aspersion'?'selected':''}>${s.name} (${(s.eff*100).toFixed(0)}%)</option>`).join('');
            const html = `<div id="irrigation-panel" class="float-panel" style="top:80px;right:60px;width:360px;max-height:90vh;overflow-y:auto;">
                <div class="panel-hdr" style="background:linear-gradient(135deg,rgba(14,165,233,0.3),rgba(2,132,199,0.2));">
                    <div class="panel-title"><i class="fa-solid fa-droplet" style="color:#0ea5e9;"></i> Calculadora de Riego</div>
                    <button class="panel-close" onclick="IrrigationCalc.togglePanel()"><i class="fa-solid fa-times"></i></button>
                </div>
                <div class="panel-body">
                    <div style="background:rgba(14,165,233,0.15);border:1px solid #0ea5e9;border-radius:6px;padding:10px;margin-bottom:12px;">
                        <div style="font-size:10px;color:#0ea5e9;font-weight:700;"> DISEO DE SISTEMA DE RIEGO</div>
                        <div style="font-size:9px;color:var(--text-3);margin-top:3px;">Calcula necesidades hdricas, caudales y diseo por sistema (FAO-56)</div>
                    </div>
                    <div class="form-group"><label class="form-label">Cultivo (20 tipos)</label>
                        <select id="irr-crop" class="form-input" onchange="IrrigationCalc.updateKc()">${cropOpts}</select>
                    </div>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
                        <div class="form-group"><label class="form-label">ETo (mm/da)</label>
                            <input type="number" id="irr-eto" class="form-input" value="5" step="0.5" min="1" max="15">
                        </div>
                        <div class="form-group"><label class="form-label">Kc (editable)</label>
                            <input type="number" id="irr-kc" class="form-input" value="1.15" step="0.05" min="0.3" max="1.5">
                        </div>
                    </div>
                    <div class="form-group"><label class="form-label">Sistema de Riego</label>
                        <select id="irr-system" class="form-input" onchange="IrrigationCalc.updateSystem()">${sysOpts}</select>
                    </div>
                    <div id="irr-sys-info" style="font-size:9px;color:var(--text-3);padding:4px 8px;margin:-6px 0 8px;"></div>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
                        <div class="form-group"><label class="form-label">Eficiencia (%)</label>
                            <input type="number" id="irr-eff" class="form-input" value="75" step="5" min="20" max="98">
                        </div>
                        <div class="form-group"><label class="form-label">Frecuencia (das)</label>
                            <input type="number" id="irr-freq" class="form-input" value="3" min="1" max="30">
                        </div>
                    </div>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
                        <div class="form-group"><label class="form-label">Horas/da riego</label>
                            <input type="number" id="irr-hours" class="form-input" value="8" min="1" max="24">
                        </div>
                        <div class="form-group"><label class="form-label">Prof. raz (m)</label>
                            <input type="number" id="irr-root" class="form-input" value="0.40" step="0.05" min="0.1" max="2.0">
                        </div>
                    </div>
                    <button class="btn" onclick="IrrigationCalc.calculate()" style="background:linear-gradient(135deg,#0ea5e9,#0284c7);">
                        <i class="fa-solid fa-calculator"></i> CALCULAR RIEGO
                    </button>
                    <div id="irr-results" style="display:none;margin-top:12px;"></div>
                </div>
            </div>`;
            document.body.insertAdjacentHTML('beforeend', html);
            this.panel = document.getElementById('irrigation-panel');
            this.updateSystem();
        },
        updateKc() {
            const idx = parseInt($('irr-crop')?.value) || 0;
            const crop = this.crops[idx];
            if (crop && $('irr-kc')) $('irr-kc').value = crop.kc.toFixed(2);
        },
        updateSystem() {
            const idx = parseInt($('irr-system')?.value) || 0;
            const sys = this.systems[idx];
            if (sys && $('irr-eff')) $('irr-eff').value = (sys.eff * 100).toFixed(0);
            const info = $('irr-sys-info');
            if (info && sys) info.innerHTML = `<i class="fa-solid ${sys.icon}" style="color:${sys.color};"></i> ${sys.desc} | Eficiencia tpica: ${(sys.eff*100).toFixed(0)}%`;
        },
        calculate() {
            if (!State.polygon) return Toast.show('Dibuja un polgono primero', 'error');
            const areaM2 = turf.area(State.polygon), areaHa = areaM2 / 10000;
            const cropIdx = parseInt($('irr-crop')?.value) || 0;
            const crop = this.crops[cropIdx];
            const sysIdx = parseInt($('irr-system')?.value) || 0;
            const sys = this.systems[sysIdx];
            const eto = parseFloat($('irr-eto')?.value) || 5;
            const kc = parseFloat($('irr-kc')?.value) || 1.15;
            const effPct = parseFloat($('irr-eff')?.value) || 75;
            const eff = effPct / 100;
            const hours = parseInt($('irr-hours')?.value) || 8;
            const freq = parseInt($('irr-freq')?.value) || 3;
            const rootDepth = parseFloat($('irr-root')?.value) || 0.40;

            // ---- Clculos hidrulicos ----
            const etc = eto * kc;                                   // ETc mm/da
            const grossMm = etc / eff;                              // Lmina bruta mm/da
            const dailyVolM3 = (grossMm * areaM2) / 1000;          // Volumen diario m/da
            const irrLaminaMm = etc * freq;                         // Lmina neta por riego mm
            const irrLaminaGross = irrLaminaMm / eff;               // Lmina bruta por riego mm
            const irrVolM3 = (irrLaminaGross * areaM2) / 1000;     // Volumen por riego m
            const flowRateLs = (dailyVolM3 * 1000) / (hours * 3600); // Caudal L/s
            const flowRateM3h = flowRateLs * 3.6;                   // Caudal m/h
            const monthlyVolM3 = dailyVolM3 * 30;                   // Volumen mensual m
            const annualVolM3 = dailyVolM3 * 365;                   // Volumen anual m

            // Lmina disponible en suelo (capacidad de campo - marchitez)
            const AWC = 0.15; // capacidad de agua disponible tpica mm/mm (franco)
            const totalAW = AWC * rootDepth * 1000;  // mm
            const MAD = 0.50; // agotamiento mximo permisible
            const RAW = totalAW * MAD;  // mm fcilmente aprovechable
            const maxFreq = Math.floor(RAW / etc); // frecuencia mxima recomendada (das)

            // ---- Diseo especfico por sistema ----
            let sysDesign = {};
            if (sys.id === 'goteo') {
                const dripperFlow = 4;          // L/h por gotero
                const spacingEmitter = 0.30;    // m entre goteros
                const spacingRow = 1.0;         // m entre lneas
                const numDrippers = Math.ceil(areaM2 / (spacingEmitter * spacingRow));
                const lateralLength = (areaM2 / spacingRow);
                const numLaterals = Math.ceil(Math.sqrt(areaM2) / spacingRow);
                sysDesign = { type: 'Goteo', drippers: numDrippers, dripperFlow, spacingEmitter, spacingRow, lateralLength: lateralLength.toFixed(0), numLaterals, pipeMain: Math.ceil(flowRateLs * 0.8) > 75 ? 75 : Math.max(50, Math.ceil(flowRateLs * 0.8)), pipeLateral: 16 };
            } else if (sys.id === 'microasp') {
                const microFlow = 50;          // L/h por micro
                const spacingMicro = 4;        // m entre micro
                const numMicros = Math.ceil(areaM2 / (spacingMicro * spacingMicro));
                sysDesign = { type: 'Microaspersin', micros: numMicros, microFlow, spacing: spacingMicro, radius: 2.5, pipeMain: 63, pipeLateral: 25 };
            } else if (sys.id === 'aspersion') {
                const sprinklerRadius = 12;    // m radio
                const coverage = Math.PI * sprinklerRadius * sprinklerRadius * 0.65;
                const numSprinklers = Math.ceil(areaM2 / coverage);
                const sprinklerFlow = 1200;    // L/h
                sysDesign = { type: 'Aspersin', sprinklers: numSprinklers, sprinklerFlow, radius: sprinklerRadius, spacing: sprinklerRadius * 1.4, pipeMain: 90, pipeLateral: 63 };
            } else if (sys.id === 'pivote') {
                const radius = Math.sqrt(areaM2 / Math.PI);
                const numTruss = Math.ceil(radius / 50);
                sysDesign = { type: 'Pivote Central', radius: radius.toFixed(1), numTruss, rpm: (2.5).toFixed(2), pipeMain: 150, coveredArea: (Math.PI * radius * radius / 10000).toFixed(2) };
            } else if (sys.id === 'surco') {
                const furrowLength = Math.min(Math.sqrt(areaM2), 200);
                const furrowSpacing = 0.75;
                const numFurrows = Math.ceil(Math.sqrt(areaM2) / furrowSpacing);
                const furrowFlow = 0.5;        // L/s por surco
                sysDesign = { type: 'Gravedad/Surcos', furrowLength: furrowLength.toFixed(0), furrowSpacing, numFurrows, furrowFlow, totalFlow: (numFurrows * furrowFlow).toFixed(1), pipeMain: 200, slope: '0.1-0.5%' };
            } else if (sys.id === 'inundacion') {
                const melgaWidth = 10;         // m ancho melga
                const melgaLength = Math.min(Math.sqrt(areaM2) * 1.5, 300);
                const numMelgas = Math.ceil(areaM2 / (melgaWidth * melgaLength));
                const laminaMelga = irrLaminaGross;
                const volPerMelga = (laminaMelga * melgaWidth * melgaLength) / 1000;
                const fillTime = volPerMelga / (flowRateLs * 3.6);
                sysDesign = { type: 'Inundacin', melgaWidth, melgaLength: melgaLength.toFixed(0), numMelgas, laminaMm: laminaMelga.toFixed(1), volPerMelga: volPerMelga.toFixed(1), fillTimeH: fillTime.toFixed(1), totalFillH: (fillTime * numMelgas).toFixed(1), slope: '0.05-0.2%', dikes: numMelgas + 1, canalMain: 'Revestido 0.40.4m' };
            }

            this.lastResults = {
                cropName: crop.name, cropKc: kc, systemName: sys.name, systemId: sys.id,
                systemIcon: sys.icon, systemColor: sys.color, effPct,
                areaM2, areaHa, eto, kc, eff, hours, freq, rootDepth,
                etc, grossMm, dailyVolM3, irrLaminaMm, irrLaminaGross,
                irrVolM3, flowRateLs, flowRateM3h, monthlyVolM3, annualVolM3,
                totalAW, RAW, maxFreq, sysDesign
            };
            this.showResults();
            Toast.show('Clculo de riego completado', 'success');
        },
        showResults() {
            const r = this.lastResults;
            if (!r) return;
            const rd = $('irr-results');
            if (!rd) return;
            rd.style.display = 'block';
            // Build system-specific info
            let sysHtml = '';
            const sd = r.sysDesign;
            if (r.systemId === 'goteo') {
                sysHtml = `<div>Goteros: <b>${sd.drippers.toLocaleString()}</b> (${sd.dripperFlow} L/h c/u)</div>
                    <div>Espaciamiento: <b>${sd.spacingEmitter}m  ${sd.spacingRow}m</b></div>
                    <div>Laterales: <b>${sd.numLaterals}</b> (${sd.pipeLateral}mm)</div>
                    <div>Long. laterales: <b>${sd.lateralLength} m</b></div>
                    <div>Tubera principal: <b>${sd.pipeMain}mm</b></div>`;
            } else if (r.systemId === 'microasp') {
                sysHtml = `<div>Microaspersores: <b>${sd.micros.toLocaleString()}</b> (${sd.microFlow} L/h)</div>
                    <div>Espaciamiento: <b>${sd.spacing}m  ${sd.spacing}m</b></div>
                    <div>Radio mojado: <b>${sd.radius}m</b></div>
                    <div>Lateral: <b>${sd.pipeLateral}mm</b> | Principal: <b>${sd.pipeMain}mm</b></div>`;
            } else if (r.systemId === 'aspersion') {
                sysHtml = `<div>Aspersores: <b>${sd.sprinklers}</b> (${sd.sprinklerFlow} L/h)</div>
                    <div>Radio: <b>${sd.radius}m</b> | Espaciamiento: <b>${sd.spacing.toFixed(1)}m</b></div>
                    <div>Lateral: <b>${sd.pipeLateral}mm</b> | Principal: <b>${sd.pipeMain}mm</b></div>`;
            } else if (r.systemId === 'pivote') {
                sysHtml = `<div>Radio pivote: <b>${sd.radius} m</b></div>
                    <div>Torres/Truss: <b>${sd.numTruss}</b></div>
                    <div>rea cubierta: <b>${sd.coveredArea} Ha</b></div>
                    <div>Tubera: <b>${sd.pipeMain}mm</b></div>`;
            } else if (r.systemId === 'surco') {
                sysHtml = `<div>Surcos: <b>${sd.numFurrows}</b> (c/${sd.furrowSpacing}m)</div>
                    <div>Largo surco: <b>${sd.furrowLength} m</b></div>
                    <div>Caudal/surco: <b>${sd.furrowFlow} L/s</b></div>
                    <div>Caudal total: <b>${sd.totalFlow} L/s</b></div>
                    <div>Pendiente recom.: <b>${sd.slope}</b></div>`;
            } else if (r.systemId === 'inundacion') {
                sysHtml = `<div>Melgas: <b>${sd.numMelgas}</b> (${sd.melgaWidth}m  ${sd.melgaLength}m)</div>
                    <div>Lmina por melga: <b>${sd.laminaMm} mm</b></div>
                    <div>Volumen/melga: <b>${sd.volPerMelga} m</b></div>
                    <div>Tiempo llenado: <b>${sd.fillTimeH} h/melga</b></div>
                    <div>Tiempo total: <b>${sd.totalFillH} h</b></div>
                    <div>Bordos/diques: <b>${sd.dikes}</b></div>
                    <div>Pendiente: <b>${sd.slope}</b></div>
                    <div>Canal: <b>${sd.canalMain}</b></div>`;
            }

            rd.innerHTML = `<div style="background:linear-gradient(135deg,rgba(14,165,233,0.2),rgba(2,132,199,0.15));border-radius:8px;padding:12px;">
                <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:8px;">
                    <div style="text-align:center;">
                        <div style="font-size:22px;font-weight:800;color:#0ea5e9;">${r.etc.toFixed(2)}</div>
                        <div style="font-size:9px;color:var(--text-3);">ETc (mm/da)</div>
                    </div>
                    <div style="text-align:center;">
                        <div style="font-size:22px;font-weight:800;color:#22c55e;">${r.dailyVolM3.toFixed(1)}</div>
                        <div style="font-size:9px;color:var(--text-3);">VOL/DA (m)</div>
                    </div>
                </div>
                <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:6px;margin-top:10px;">
                    <div style="text-align:center;background:var(--bg-glass);padding:6px;border-radius:4px;">
                        <div style="font-size:14px;font-weight:700;color:#f59e0b;">${r.irrVolM3.toFixed(1)}</div>
                        <div style="font-size:8px;color:var(--text-3);">m/riego</div>
                    </div>
                    <div style="text-align:center;background:var(--bg-glass);padding:6px;border-radius:4px;">
                        <div style="font-size:14px;font-weight:700;color:#a78bfa;">${r.flowRateLs.toFixed(2)}</div>
                        <div style="font-size:8px;color:var(--text-3);">Caudal L/s</div>
                    </div>
                    <div style="text-align:center;background:var(--bg-glass);padding:6px;border-radius:4px;">
                        <div style="font-size:14px;font-weight:700;color:#ec4899;">${r.irrLaminaGross.toFixed(1)}</div>
                        <div style="font-size:8px;color:var(--text-3);">Lmina mm</div>
                    </div>
                </div>
            </div>
            <div style="margin-top:10px;">
                <div style="font-size:10px;font-weight:600;color:#0ea5e9;margin-bottom:6px;">
                    <i class="fa-solid fa-chart-bar"></i> BALANCE HDRICO
                </div>
                <div style="font-size:10px;color:var(--text-2);padding:8px;background:var(--bg-glass);border-radius:6px;">
                    <div>Lmina bruta diaria: <b>${r.grossMm.toFixed(2)} mm</b></div>
                    <div>Agua disponible suelo: <b>${r.totalAW.toFixed(1)} mm</b></div>
                    <div>Agua fcilmente aprov.: <b>${r.RAW.toFixed(1)} mm</b></div>
                    <div>Frecuencia mx. recom.: <b>${r.maxFreq} das</b> ${r.freq > r.maxFreq ? '<span style="color:#ef4444;"> excedida</span>' : '<span style="color:#22c55e;"></span>'}</div>
                    <div>Vol. mensual: <b>${r.monthlyVolM3.toFixed(0)} m</b> | Anual: <b>${(r.annualVolM3/1000).toFixed(1)} mil m</b></div>
                </div>
            </div>
            <div style="margin-top:10px;">
                <div style="font-size:10px;font-weight:600;margin-bottom:6px;">
                    <i class="fa-solid ${r.systemIcon}" style="color:${r.systemColor};"></i> <span style="color:${r.systemColor};">DISEO: ${r.systemName.toUpperCase()}</span>
                </div>
                <div style="font-size:10px;color:var(--text-2);padding:8px;background:var(--bg-glass);border-radius:6px;">
                    ${sysHtml}
                </div>
            </div>
            <div style="margin-top:10px;">
                <div style="font-size:10px;font-weight:600;color:#22c55e;margin-bottom:6px;">
                    <i class="fa-solid fa-lightbulb"></i> RECOMENDACIONES
                </div>
                <div style="font-size:10px;color:var(--text-2);padding:8px;background:var(--bg-glass);border-radius:6px;">
                    ${r.freq > r.maxFreq ? '<div style="color:#ef4444;">  Frecuencia excede la mxima recomendada, reducir a ' + r.maxFreq + ' das</div>' : ''}
                    ${r.systemId === 'inundacion' ? '<div> Nivelar terreno antes de instalar melgas</div><div> Pendiente uniforme 0.05-0.2% para distribucin homognea</div>' : ''}
                    ${r.systemId === 'surco' ? '<div> Verificar pendiente entre 0.1-0.5%</div><div> Largo de surco segn tipo de suelo</div>' : ''}
                    ${r.systemId === 'goteo' ? '<div> Instalar filtros (disco/arena) obligatorio</div><div> Presin de trabajo: 1.0-1.5 bar</div>' : ''}
                    ${r.systemId === 'aspersion' ? '<div> Evitar riego con vientos >15 km/h</div><div> Presin de trabajo: 2.5-4.0 bar</div>' : ''}
                    <div> Programar riego en horas de baja evaporacin</div>
                    <div> Monitorear humedad del suelo peridicamente</div>
                </div>
            </div>
            <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:4px;margin-top:12px;">
                <button class="btn btn-2" onclick="IrrigationCalc.exportKML()" style="font-size:8px;padding:6px;" title="Google Earth">
                    <i class="fa-solid fa-earth-americas"></i> KML
                </button>
                <button class="btn btn-2" onclick="IrrigationCalc.exportGeoJSON()" style="font-size:8px;padding:6px;" title="GIS">
                    <i class="fa-solid fa-code"></i> JSON
                </button>
                <button class="btn btn-2" onclick="IrrigationCalc.exportDXF()" style="font-size:8px;padding:6px;" title="AutoCAD">
                    <i class="fa-solid fa-drafting-compass"></i> DXF
                </button>
                <button class="btn btn-2" onclick="IrrigationCalc.exportCSV()" style="font-size:8px;padding:6px;" title="Excel">
                    <i class="fa-solid fa-file-csv"></i> CSV
                </button>
            </div>
            <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:4px;margin-top:4px;">
                <button class="btn btn-2" onclick="IrrigationCalc.exportGPX()" style="font-size:8px;padding:6px;" title="GPS">
                    <i class="fa-solid fa-satellite"></i> GPX
                </button>
                <button class="btn btn-2" onclick="IrrigationCalc.exportPDF()" style="font-size:8px;padding:6px;" title="Informe PDF">
                    <i class="fa-solid fa-file-pdf"></i> PDF
                </button>
                <button class="btn btn-2" onclick="IrrigationCalc.exportTXT()" style="font-size:8px;padding:6px;" title="Texto">
                    <i class="fa-solid fa-file-lines"></i> TXT
                </button>
                <button class="btn btn-2" onclick="IrrigationCalc.copyToClipboard()" style="font-size:8px;padding:6px;" title="Copiar">
                    <i class="fa-solid fa-copy"></i> COPY
                </button>
            </div>`;
        },
        // ========== EXPORTACIN KML (Google Earth) ==========
        exportKML() {
            if (!this.lastResults) return Toast.show('Calcula primero', 'error');
            const r = this.lastResults;
            const coords = State.polygon.geometry.coordinates[0];
            const kmlCoords = coords.map(c => `${c[0]},${c[1]},0`).join(' ');
            const center = turf.centroid(State.polygon).geometry.coordinates;
            let kml = `<?xml version="1.0" encoding="UTF-8"?>
<kml xmlns="http://www.opengis.net/kml/2.2">
<Document>
<name>Diseo de Riego - ${r.cropName} - WIN-TEL v30</name>
<description>Sistema: ${r.systemName} | ETc: ${r.etc.toFixed(2)} mm/da | rea: ${r.areaHa.toFixed(4)} Ha
Generado: ${new Date().toLocaleString('es-ES')}</description>
<Style id="irrigArea"><LineStyle><color>ffe9a50e</color><width>3</width></LineStyle><PolyStyle><color>500ea5e9</color></PolyStyle></Style>
<Style id="center"><IconStyle><color>ff0ea5e9</color><scale>1.2</scale><Icon><href>http://maps.google.com/mapfiles/kml/shapes/water.png</href></Icon></IconStyle></Style>
<Folder>
<name>Zona de Riego</name>
<Placemark>
    <name>Parcela - ${r.cropName}</name>
    <description><![CDATA[DISEO DE RIEGO - WIN-TEL GEOMATICS PRO v30
Cultivo: ${r.cropName} (Kc=${r.kc})
Sistema: ${r.systemName} (Eff=${r.effPct}%)
rea: ${r.areaHa.toFixed(4)} Ha (${r.areaM2.toFixed(0)} m)

NECESIDADES HDRICAS:
ETc: ${r.etc.toFixed(2)} mm/da
Lmina bruta: ${r.grossMm.toFixed(2)} mm/da
Volumen diario: ${r.dailyVolM3.toFixed(1)} m/da
Volumen por riego: ${r.irrVolM3.toFixed(1)} m
Caudal requerido: ${r.flowRateLs.toFixed(2)} L/s (${r.flowRateM3h.toFixed(1)} m/h)
Frecuencia: cada ${r.freq} das
Vol. mensual: ${r.monthlyVolM3.toFixed(0)} m
Vol. anual: ${r.annualVolM3.toFixed(0)} m]]></description>
    <styleUrl>#irrigArea</styleUrl>
    <Polygon><outerBoundaryIs><LinearRing><coordinates>${kmlCoords}</coordinates></LinearRing></outerBoundaryIs></Polygon>
</Placemark>
<Placemark>
    <name>Centro de Riego</name>
    <description>Punto de captacin/bomba sugerido</description>
    <styleUrl>#center</styleUrl>
    <Point><coordinates>${center[0]},${center[1]},0</coordinates></Point>
</Placemark>
</Folder>
</Document>
</kml>`;
            download(kml, `riego_${r.systemId}_${Date.now()}.kml`, 'application/vnd.google-earth.kml+xml');
            Toast.show('KML exportado', 'success');
        },
        // ========== EXPORTACIN GeoJSON (GIS) ==========
        exportGeoJSON() {
            if (!this.lastResults) return Toast.show('Calcula primero', 'error');
            const r = this.lastResults;
            const center = turf.centroid(State.polygon).geometry.coordinates;
            const geojson = {
                type: 'FeatureCollection',
                name: 'Diseo de Riego - WIN-TEL v30',
                crs: { type: 'name', properties: { name: 'urn:ogc:def:crs:OGC:1.3:CRS84' } },
                properties: {
                    software: 'WIN-TEL GEOMATICS PRO v30',
                    date: new Date().toISOString(),
                    crop: r.cropName, system: r.systemName, etc_mm: r.etc, area_ha: r.areaHa
                },
                features: [
                    {
                        type: 'Feature',
                        properties: {
                            type: 'irrigation_zone', crop: r.cropName, kc: r.kc,
                            system: r.systemName, efficiency_pct: r.effPct,
                            area_ha: parseFloat(r.areaHa.toFixed(4)), area_m2: parseFloat(r.areaM2.toFixed(0)),
                            etc_mm_day: parseFloat(r.etc.toFixed(2)), gross_mm_day: parseFloat(r.grossMm.toFixed(2)),
                            daily_vol_m3: parseFloat(r.dailyVolM3.toFixed(1)),
                            irrigation_vol_m3: parseFloat(r.irrVolM3.toFixed(1)),
                            flow_rate_ls: parseFloat(r.flowRateLs.toFixed(2)),
                            flow_rate_m3h: parseFloat(r.flowRateM3h.toFixed(1)),
                            frequency_days: r.freq, hours_day: r.hours,
                            monthly_vol_m3: parseFloat(r.monthlyVolM3.toFixed(0)),
                            annual_vol_m3: parseFloat(r.annualVolM3.toFixed(0)),
                            root_depth_m: r.rootDepth, RAW_mm: parseFloat(r.RAW.toFixed(1)),
                            max_freq_days: r.maxFreq
                        },
                        geometry: State.polygon.geometry
                    },
                    {
                        type: 'Feature',
                        properties: { type: 'pump_point', name: 'Centro captacin sugerido' },
                        geometry: { type: 'Point', coordinates: center }
                    }
                ]
            };
            download(JSON.stringify(geojson, null, 2), `riego_${r.systemId}_${Date.now()}.geojson`, 'application/json');
            Toast.show('GeoJSON exportado', 'success');
        },
        // ========== EXPORTACIN DXF (AutoCAD) ==========
        exportDXF() {
            if (!this.lastResults) return Toast.show('Calcula primero', 'error');
            const r = this.lastResults;
            const coords = State.polygon.geometry.coordinates[0];
            const center = turf.centroid(State.polygon).geometry.coordinates;
            let dxf = `0\nSECTION\n2\nHEADER\n9\n$ACADVER\n1\nAC1014\n9\n$INSUNITS\n70\n6\n0\nENDSEC\n0\nSECTION\n2\nTABLES\n0\nTABLE\n2\nLAYER\n70\n3\n`;
            dxf += `0\nLAYER\n2\nZONA_RIEGO\n70\n0\n62\n4\n6\nCONTINUOUS\n`;
            dxf += `0\nLAYER\n2\nPUNTO_CAPTACION\n70\n0\n62\n1\n6\nCONTINUOUS\n`;
            dxf += `0\nLAYER\n2\nINFO_RIEGO\n70\n0\n62\n5\n6\nCONTINUOUS\n`;
            dxf += `0\nENDTAB\n0\nENDSEC\n0\nSECTION\n2\nENTITIES\n`;
            // Polgono de riego
            dxf += `0\nPOLYLINE\n8\nZONA_RIEGO\n66\n1\n70\n1\n`;
            coords.forEach(c => {
                const x = c[0] * 111320 * Math.cos(c[1] * Math.PI / 180);
                const y = c[1] * 110540;
                dxf += `0\nVERTEX\n8\nZONA_RIEGO\n10\n${x.toFixed(3)}\n20\n${y.toFixed(3)}\n30\n0\n`;
            });
            dxf += `0\nSEQEND\n8\nZONA_RIEGO\n`;
            // Punto central
            const cx = center[0] * 111320 * Math.cos(center[1] * Math.PI / 180);
            const cy = center[1] * 110540;
            dxf += `0\nPOINT\n8\nPUNTO_CAPTACION\n10\n${cx.toFixed(3)}\n20\n${cy.toFixed(3)}\n30\n0\n`;
            dxf += `0\nTEXT\n8\nINFO_RIEGO\n10\n${(cx+10).toFixed(3)}\n20\n${(cy+10).toFixed(3)}\n30\n0\n40\n5\n1\n${r.systemName} - ${r.cropName} - ${r.areaHa.toFixed(2)}Ha\n`;
            dxf += `0\nENDSEC\n0\nEOF`;
            download(dxf, `riego_${r.systemId}_${Date.now()}.dxf`, 'application/dxf');
            Toast.show('DXF exportado (AutoCAD)', 'success');
        },
        // ========== EXPORTACIN CSV (Excel) ==========
        exportCSV() {
            if (!this.lastResults) return Toast.show('Calcula primero', 'error');
            const r = this.lastResults;
            const sd = r.sysDesign;
            let csv = `DISEO DE RIEGO - WIN-TEL GEOMATICS PRO v30\n`;
            csv += `Fecha,${new Date().toLocaleString('es-ES')}\n\n`;
            csv += `DATOS DEL TERRENO\n`;
            csv += `rea (Ha),${r.areaHa.toFixed(4)}\n`;
            csv += `rea (m),${r.areaM2.toFixed(0)}\n\n`;
            csv += `PARMETROS DEL CULTIVO\n`;
            csv += `Cultivo,${r.cropName}\n`;
            csv += `Coeficiente Kc,${r.kc}\n`;
            csv += `ETo (mm/da),${r.eto}\n`;
            csv += `Profundidad raz (m),${r.rootDepth}\n\n`;
            csv += `SISTEMA DE RIEGO\n`;
            csv += `Sistema,${r.systemName}\n`;
            csv += `Eficiencia (%),${r.effPct}\n`;
            csv += `Horas/da,${r.hours}\n`;
            csv += `Frecuencia (das),${r.freq}\n\n`;
            csv += `NECESIDADES HDRICAS\n`;
            csv += `ETc (mm/da),${r.etc.toFixed(2)}\n`;
            csv += `Lmina bruta (mm/da),${r.grossMm.toFixed(2)}\n`;
            csv += `Lmina por riego neta (mm),${r.irrLaminaMm.toFixed(2)}\n`;
            csv += `Lmina por riego bruta (mm),${r.irrLaminaGross.toFixed(2)}\n`;
            csv += `Volumen diario (m/da),${r.dailyVolM3.toFixed(1)}\n`;
            csv += `Volumen por riego (m),${r.irrVolM3.toFixed(1)}\n`;
            csv += `Caudal requerido (L/s),${r.flowRateLs.toFixed(2)}\n`;
            csv += `Caudal requerido (m/h),${r.flowRateM3h.toFixed(1)}\n`;
            csv += `Vol. mensual (m),${r.monthlyVolM3.toFixed(0)}\n`;
            csv += `Vol. anual (m),${r.annualVolM3.toFixed(0)}\n\n`;
            csv += `BALANCE HDRICO DEL SUELO\n`;
            csv += `Agua disponible total (mm),${r.totalAW.toFixed(1)}\n`;
            csv += `Agua fcilmente aprovechable (mm),${r.RAW.toFixed(1)}\n`;
            csv += `Frecuencia mxima recomendada (das),${r.maxFreq}\n\n`;
            csv += `DISEO DEL SISTEMA: ${r.systemName.toUpperCase()}\n`;
            Object.entries(sd).forEach(([k, v]) => { if (k !== 'type') csv += `${k},${v}\n`; });
            csv += `\nCOORDENADAS DEL POLGONO\n`;
            csv += `PUNTO,LATITUD,LONGITUD\n`;
            State.polygon.geometry.coordinates[0].forEach((c, i) => {
                csv += `${i + 1},${c[1].toFixed(6)},${c[0].toFixed(6)}\n`;
            });
            download(csv, `riego_${r.systemId}_${Date.now()}.csv`, 'text/csv');
            Toast.show('CSV exportado', 'success');
        },
        // ========== EXPORTACIN GPX (GPS) ==========
        exportGPX() {
            if (!this.lastResults) return Toast.show('Calcula primero', 'error');
            const r = this.lastResults;
            const center = turf.centroid(State.polygon).geometry.coordinates;
            const coords = State.polygon.geometry.coordinates[0];
            let gpx = `<?xml version="1.0" encoding="UTF-8"?>
<gpx version="1.1" creator="WIN-TEL GEOMATICS PRO v30" xmlns="http://www.topografix.com/GPX/1/1">
<metadata>
    <name>Diseo de Riego - ${r.cropName}</name>
    <desc>Sistema: ${r.systemName} | ETc: ${r.etc.toFixed(2)} mm/da | rea: ${r.areaHa.toFixed(4)} Ha</desc>
    <time>${new Date().toISOString()}</time>
</metadata>
<wpt lat="${center[1].toFixed(6)}" lon="${center[0].toFixed(6)}">
    <name>CAPTACION</name>
    <desc>Punto de captacin/bomba sugerido - Caudal: ${r.flowRateLs.toFixed(2)} L/s</desc>
    <sym>Water Source</sym>
</wpt>\n`;
            coords.forEach((c, i) => {
                if (i < coords.length - 1) {
                    gpx += `<wpt lat="${c[1].toFixed(6)}" lon="${c[0].toFixed(6)}">
    <name>V${i + 1}</name>
    <desc>Vrtice ${i + 1} de zona de riego</desc>
    <sym>Flag, Blue</sym>
</wpt>\n`;
                }
            });
            gpx += `<trk>
    <name>Permetro zona de riego</name>
    <desc>${r.cropName} - ${r.systemName}</desc>
    <trkseg>\n`;
            coords.forEach(c => {
                gpx += `        <trkpt lat="${c[1].toFixed(6)}" lon="${c[0].toFixed(6)}"></trkpt>\n`;
            });
            gpx += `    </trkseg>\n</trk>\n</gpx>`;
            download(gpx, `riego_${r.systemId}_${Date.now()}.gpx`, 'application/gpx+xml');
            Toast.show('GPX exportado (GPS)', 'success');
        },
        // ========== EXPORTACIN PDF (Informe) ==========
        exportPDF() {
            if (!this.lastResults) return Toast.show('Calcula primero', 'error');
            if (typeof jspdf === 'undefined') return Toast.show('PDF no disponible', 'error');
            const r = this.lastResults;
            const sd = r.sysDesign;
            const { jsPDF } = jspdf;
            const doc = new jsPDF();
            let y = 15;
            // Ttulo
            doc.setFontSize(18);
            doc.setTextColor(14, 165, 233);
            doc.text('INFORME DE DISEO DE RIEGO', 105, y, { align: 'center' });
            y += 7;
            doc.setFontSize(10);
            doc.setTextColor(100);
            doc.text('WIN-TEL GEOMATICS PRO v30', 105, y, { align: 'center' });
            y += 5;
            doc.text(new Date().toLocaleString('es-ES'), 105, y, { align: 'center' });
            y += 10;
            doc.setDrawColor(14, 165, 233);
            doc.setLineWidth(0.5);
            doc.line(20, y, 190, y);
            y += 10;
            // Datos terreno
            doc.setFontSize(13);
            doc.setTextColor(0);
            doc.text('DATOS DEL TERRENO', 20, y); y += 7;
            doc.setFontSize(10);
            doc.text(`rea: ${r.areaHa.toFixed(4)} Ha (${r.areaM2.toFixed(0)} m)`, 25, y); y += 10;
            // Cultivo
            doc.setFontSize(13);
            doc.text('PARMETROS DEL CULTIVO', 20, y); y += 7;
            doc.setFontSize(10);
            doc.text(`Cultivo: ${r.cropName}`, 25, y); y += 5;
            doc.text(`Coeficiente Kc: ${r.kc}`, 25, y); y += 5;
            doc.text(`ETo: ${r.eto} mm/da`, 25, y); y += 5;
            doc.text(`Profundidad de raz: ${r.rootDepth} m`, 25, y); y += 10;
            // Sistema
            doc.setFontSize(13);
            doc.text(`SISTEMA: ${r.systemName.toUpperCase()}`, 20, y); y += 7;
            doc.setFontSize(10);
            doc.text(`Eficiencia: ${r.effPct}%`, 25, y); y += 5;
            doc.text(`Horas de operacin: ${r.hours} h/da`, 25, y); y += 5;
            doc.text(`Frecuencia de riego: cada ${r.freq} das`, 25, y); y += 10;
            // Necesidades hdricas
            doc.setFontSize(13);
            doc.text('NECESIDADES HDRICAS', 20, y); y += 7;
            doc.setFontSize(10);
            doc.text(`ETc: ${r.etc.toFixed(2)} mm/da`, 25, y); y += 5;
            doc.text(`Lmina bruta diaria: ${r.grossMm.toFixed(2)} mm`, 25, y); y += 5;
            doc.text(`Lmina por riego (neta): ${r.irrLaminaMm.toFixed(2)} mm`, 25, y); y += 5;
            doc.text(`Lmina por riego (bruta): ${r.irrLaminaGross.toFixed(2)} mm`, 25, y); y += 5;
            doc.text(`Volumen diario: ${r.dailyVolM3.toFixed(1)} m/da`, 25, y); y += 5;
            doc.text(`Volumen por riego: ${r.irrVolM3.toFixed(1)} m`, 25, y); y += 5;
            doc.text(`Caudal requerido: ${r.flowRateLs.toFixed(2)} L/s (${r.flowRateM3h.toFixed(1)} m/h)`, 25, y); y += 5;
            doc.text(`Volumen mensual: ${r.monthlyVolM3.toFixed(0)} m`, 25, y); y += 5;
            doc.text(`Volumen anual: ${r.annualVolM3.toFixed(0)} m`, 25, y); y += 10;
            // Balance
            doc.setFontSize(13);
            doc.text('BALANCE HDRICO DEL SUELO', 20, y); y += 7;
            doc.setFontSize(10);
            doc.text(`Agua disponible total: ${r.totalAW.toFixed(1)} mm`, 25, y); y += 5;
            doc.text(`Agua fcilmente aprovechable: ${r.RAW.toFixed(1)} mm`, 25, y); y += 5;
            doc.text(`Frecuencia mxima recomendada: ${r.maxFreq} das`, 25, y); y += 10;
            // Diseo del sistema
            if (y > 220) { doc.addPage(); y = 20; }
            doc.setFontSize(13);
            doc.text(`DISEO: ${sd.type?.toUpperCase() || r.systemName.toUpperCase()}`, 20, y); y += 7;
            doc.setFontSize(10);
            Object.entries(sd).forEach(([k, v]) => {
                if (k !== 'type') {
                    if (y > 270) { doc.addPage(); y = 20; }
                    doc.text(`${k}: ${v}`, 25, y); y += 5;
                }
            });
            y += 5;
            // Recomendaciones
            if (y > 240) { doc.addPage(); y = 20; }
            doc.setFontSize(13);
            doc.text('RECOMENDACIONES', 20, y); y += 7;
            doc.setFontSize(10);
            const recs = [
                r.freq > r.maxFreq ? `ALERTA: Frecuencia ${r.freq} das excede el mximo recomendado de ${r.maxFreq} das` : null,
                r.systemId === 'inundacion' ? 'Nivelar terreno para distribucin uniforme del agua' : null,
                r.systemId === 'inundacion' ? 'Pendiente uniforme 0.05-0.2% entre bordos' : null,
                r.systemId === 'goteo' ? 'Instalar sistema de filtrado (disco o arena) obligatorio' : null,
                r.systemId === 'surco' ? 'Verificar pendiente del surco entre 0.1-0.5%' : null,
                'Programar riego en horas de baja evaporacin (madrugada)',
                'Monitorear humedad del suelo peridicamente',
                'Realizar mantenimiento preventivo del sistema'
            ].filter(Boolean);
            recs.forEach(rec => { doc.text(` ${rec}`, 25, y); y += 5; });
            // Pie
            doc.setFontSize(8);
            doc.setTextColor(150);
            doc.text('Generado por WIN-TEL GEOMATICS PRO v30 - WindowsTelecom C.A.', 105, 290, { align: 'center' });
            doc.save(`informe_riego_${r.systemId}_${Date.now()}.pdf`);
            Toast.show('PDF exportado', 'success');
        },
        // ========== EXPORTACIN TXT (Informe de texto) ==========
        exportTXT() {
            if (!this.lastResults) return Toast.show('Calcula primero', 'error');
            const r = this.lastResults;
            const sd = r.sysDesign;
            let report = `
           INFORME DE DISEO DE RIEGO                        
           WIN-TEL GEOMATICS PRO v30                         


Fecha de generacin: ${new Date().toLocaleString('es-ES')}


                    DATOS DEL TERRENO


rea total ................. ${r.areaHa.toFixed(4)} Ha (${r.areaM2.toFixed(0)} m)


                 PARMETROS DEL CULTIVO


Cultivo .................... ${r.cropName}
Coeficiente Kc ............. ${r.kc}
ETo referencia ............. ${r.eto} mm/da
Profundidad raz ........... ${r.rootDepth} m


                  SISTEMA DE RIEGO


Sistema .................... ${r.systemName}
Eficiencia ................. ${r.effPct}%
Horas de operacin ......... ${r.hours} h/da
Frecuencia de riego ........ cada ${r.freq} das


                NECESIDADES HDRICAS


ETc (evapotranspiracin) ... ${r.etc.toFixed(2)} mm/da
Lmina bruta diaria ........ ${r.grossMm.toFixed(2)} mm/da
Lmina neta por riego ...... ${r.irrLaminaMm.toFixed(2)} mm
Lmina bruta por riego ..... ${r.irrLaminaGross.toFixed(2)} mm
Volumen diario ............. ${r.dailyVolM3.toFixed(1)} m/da
Volumen por riego .......... ${r.irrVolM3.toFixed(1)} m
Caudal requerido ........... ${r.flowRateLs.toFixed(2)} L/s (${r.flowRateM3h.toFixed(1)} m/h)
Volumen mensual ............ ${r.monthlyVolM3.toFixed(0)} m
Volumen anual .............. ${r.annualVolM3.toFixed(0)} m


              BALANCE HDRICO DEL SUELO


Agua disponible total ...... ${r.totalAW.toFixed(1)} mm
Agua fcilmente aprovech. .. ${r.RAW.toFixed(1)} mm
Frecuencia mx. recomend. .. ${r.maxFreq} das
${r.freq > r.maxFreq ? '  ALERTA: La frecuencia configurada EXCEDE la mxima recomendada' : '  Frecuencia dentro del rango aceptable'}


           DISEO DEL SISTEMA: ${r.systemName.toUpperCase()}

`;
            Object.entries(sd).forEach(([k, v]) => {
                if (k !== 'type') report += `${k.replace(/([A-Z])/g, ' $1').trim().padEnd(30, '.')} ${v}\n`;
            });
            report += `

                   RECOMENDACIONES

${r.freq > r.maxFreq ? '\n   Reducir frecuencia de riego a mximo ' + r.maxFreq + ' das' : ''}
${r.systemId === 'inundacion' ? ' Nivelar terreno antes de instalar melgas\n Pendiente uniforme 0.05-0.2% para distribucin homognea\n Construir bordos perimetrales resistentes' : ''}
${r.systemId === 'surco' ? ' Verificar pendiente entre 0.1-0.5%\n Largo de surco segn tipo de suelo' : ''}
${r.systemId === 'goteo' ? ' Instalar filtros (disco/arena) obligatorio\n Presin de trabajo: 1.0-1.5 bar' : ''}
${r.systemId === 'aspersion' ? ' Evitar riego con vientos >15 km/h\n Presin de trabajo: 2.5-4.0 bar' : ''}
 Programar riego en horas de baja evaporacin
 Monitorear humedad del suelo peridicamente
 Realizar mantenimiento preventivo del sistema


         Generado por WIN-TEL GEOMATICS PRO v30
                  WindowsTelecom C.A.
               Valencia, Carabobo, Venezuela

`;
            download(report, `informe_riego_${r.systemId}_${Date.now()}.txt`, 'text/plain');
            Toast.show('Informe TXT exportado', 'success');
        },
        // ========== COPIAR AL PORTAPAPELES ==========
        copyToClipboard() {
            if (!this.lastResults) return Toast.show('Calcula primero', 'error');
            const r = this.lastResults;
            let text = `DISEO DE RIEGO - WIN-TEL v30\n`;
            text += `Fecha: ${new Date().toLocaleString('es-ES')}\n\n`;
            text += `Cultivo: ${r.cropName} (Kc=${r.kc})\n`;
            text += `Sistema: ${r.systemName} (Eff=${r.effPct}%)\n`;
            text += `rea: ${r.areaHa.toFixed(4)} Ha\n\n`;
            text += `RESULTADOS:\n`;
            text += `ETc: ${r.etc.toFixed(2)} mm/da\n`;
            text += `Vol. diario: ${r.dailyVolM3.toFixed(1)} m\n`;
            text += `Vol. por riego: ${r.irrVolM3.toFixed(1)} m\n`;
            text += `Caudal: ${r.flowRateLs.toFixed(2)} L/s (${r.flowRateM3h.toFixed(1)} m/h)\n`;
            text += `Lmina bruta: ${r.irrLaminaGross.toFixed(1)} mm\n`;
            text += `Frecuencia: cada ${r.freq} das\n`;
            text += `Vol. mensual: ${r.monthlyVolM3.toFixed(0)} m\n`;
            text += `Vol. anual: ${r.annualVolM3.toFixed(0)} m\n`;
            text += `Frec. mx. recomendada: ${r.maxFreq} das\n`;
            navigator.clipboard.writeText(text).then(() => {
                Toast.show('Copiado al portapapeles', 'success');
            }).catch(() => { Toast.show('Error al copiar', 'error'); });
        }
    };

    console.log('WIN-TEL v30 NUEVOS MDULOS: NDVIAnalyzer, PlanoGenerator, EarthworkCalc, TerrainCompare, IrrigationCalc');
    </script>
</body>
</html>
